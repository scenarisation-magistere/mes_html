<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activit√© SCORM Interactive - Titrages Acido-Basiques</title>
    <style>
        /* Variables et styles de base */
        :root {
            /* Palette de couleurs */
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --primary-light: #7895ff;
            --success-color: #2ec4b6;
            --success-dark: #20a799;
            --warning-color: #ff9f1c;
            --danger-color: #e71d36;
            --text-color: #2b2d42;
            --text-light: #6c757d;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --light-gray: #e9ecef;
            --border-color: #dee2e6;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            
            /* Couleurs des solutions */
            --acid-color: rgb(247, 164, 176);
            --base-color: rgb(142, 202, 230);
            --solution-color: rgb(221, 236, 246);
            
            /* Couleurs des indicateurs */
            --phenolphthalein-acid: rgba(240, 240, 240, 0);
            --phenolphthalein-base: rgb(255, 82, 168);
            --bromothymol-acid: rgb(255, 215, 0);
            --bromothymol-neutral: rgb(63, 191, 104);
            --bromothymol-base: rgb(26, 132, 233);
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        
        .formula {
            text-align: center;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
            color: #444;
        }
        
        /* Badge System */
        .badge-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0 25px;
            flex-wrap: wrap;
        }
        
        .badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #aaa;
            position: relative;
            transition: all 0.5s ease;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        .badge.unlocked {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
            transform: scale(1.05);
        }
        
        .badge::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .badge:hover::after {
            opacity: 1;
        }
        
        /* Titration Panel */
        .titration-panel {
            background: linear-gradient(145deg, #ffffff, #f5f7fa);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            position: relative;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .titration-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .control-group {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            border: 1px solid var(--border-color);
            min-width: 220px;
        }
        
        .control-group h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .titration-setup {
            position: relative;
            height: 400px;
            width: 300px;
        }
        
        .burette {
            position: absolute;
            top: -240px;
            left: 50%;
            transform: translateX(-40%);
            z-index: 10;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }
        
        .erlenmeyer {
            position: absolute;
            bottom: 230px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
        }
        
        .magnetic-stirrer {
            position: absolute;
            top: 145px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 45px;
            background: linear-gradient(to bottom, #3a3a3a, #222222);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        }
        
        .stirrer-button {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(145deg, #333, #222);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #444;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .stirrer-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: radial-gradient(circle, #666, #444);
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .stirrer-indicator.active {
            background: radial-gradient(circle, #ff3a3a, #cc1414);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .stir-bar {
            position: absolute;
            width: 24px;
            height: 6px;
            background-color: #333;
            border-radius: 4px;
            left: 50%;
            top: 125px;
            transform: translateX(-50%);
            z-index: 6;
            display: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .stir-bar.active {
            display: block;
            animation: rotating 1.5s linear infinite;
        }
        
        .drop {
            position: absolute;
            width: 8px;
            height: 12px;
            background-color: var(--base-color);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            left: 50%;
            top: 50px;
            transform: translateX(-50%);
            display: none;
            z-index: 8;
            animation: falling 1s linear infinite;
        }
        
        .solution-layer {
            display: none;
        }
        
        .equivalence-notice {
            display: none;
            margin-top: -180px;
            background: linear-gradient(145deg, rgba(46, 196, 182, 0.1), rgba(46, 196, 182, 0.05));
            border: 1px solid rgba(46, 196, 182, 0.3);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(46, 196, 182, 0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .equivalence-notice h3 {
            color: var(--success-dark);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .equivalence-notice p {
            color: #3c6a56;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .validation-message {
            display: none;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .start-titration-btn {
            position: relative;
            top: -210px;
            padding: 10px 20px;
            background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            transition: var(--transition);
            box-shadow: 0 3px 8px rgba(67, 97, 238, 0.25);
        }
        
        .start-titration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.35);
        }
        
        .start-titration-btn:disabled {
            background: #a0aef8;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        .validate-setup-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: linear-gradient(145deg, var(--warning-color), #e88c19);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 3px 8px rgba(255, 159, 28, 0.25);
        }
        
        .validate-setup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 159, 28, 0.35);
        }
        
        .validate-setup-btn:disabled {
            background: #ffc580;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        /* Animation et transitions */
        .color-transition {
            transition: all 3s ease-in-out;
        }
        
        .level-transition {
            transition: height 3s ease-in-out, y 3s ease-in-out;
        }
        
        @keyframes rotating {
            from {
                transform: translateX(-50%) rotate(0deg);
            }
            to {
                transform: translateX(-50%) rotate(360deg);
            }
        }
        
        @keyframes falling {
            0% {
                top: 50px;
                opacity: 1;
            }
            100% {
                top: 100px;
                opacity: 0;
            }
        }
        
        /* Exercices */
        .exercises {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .exercise-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .exercise-card.selected {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.25);
            background-color: #f0f4ff;
        }
        
        .material-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            justify-content: space-between;
        }
        
        .exercise-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            background-color: var(--primary-light);
            color: white;
        }
        
        .question-text {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #333;
        }
        
        .data-table {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #666;
        }
        
        .data-value {
            font-weight: bold;
            color: #333;
        }
        
        .input-group {
            margin-top: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .check-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .check-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .check-btn:disabled {
            background: #a0aef8;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        .prepare-titration-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
            background: linear-gradient(145deg, var(--warning-color), #e88c19);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 3px 8px rgba(255, 159, 28, 0.25);
        }
        
        .prepare-titration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 159, 28, 0.35);
        }
        
        .prepare-titration-btn:disabled {
            background: #ffc580;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .result.show {
            opacity: 1;
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hint {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            z-index: 100;
        }
        
        .score {
            color: #667eea;
            font-size: 1.2em;
        }
        
        /* Finish Button */
        .finish-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto 0;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .finish-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .finish-btn:disabled {
            background: #8fcb99;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: slideIn 0.4s ease-out;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .score-result {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .score-text {
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        
        .exercise-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .exercise-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .exercise-item:last-child {
            border-bottom: none;
        }
        
        .exercise-status {
            font-weight: bold;
        }
        
        .status-completed {
            color: #28a745;
        }
        
        .status-incomplete {
            color: #dc3545;
        }
        
        .modal-footer {
            margin-top: 20px;
        }
        
        .close-modal-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-modal-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .modal-badge {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--success-color);
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 4px solid white;
        }
        
        .modal-badge.failed {
            background: var(--danger-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Fullscreen button */
        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .fullscreen-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        
        .fullscreen-icon {
            font-size: 1.5em;
            color: #667eea;
        }
        
        .fullscreen-container {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .titration-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .modal-header h2 {
                font-size: 1.5em;
            }
            
            .score-result {
                font-size: 2.5em;
            }
            
            .modal-badge {
                width: 60px;
                height: 60px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">6</span>
    </div>
    
    <div class="container">
        <h1>Titrages Acido-Basiques</h1>
        
        <!-- Badge System -->
        <div class="badge-container">
            <div class="badge" id="badge1" data-tooltip="D√©butant: Compl√©tez 1 exercice">1</div>
            <div class="badge" id="badge2" data-tooltip="Interm√©diaire: Compl√©tez 2 exercices">2</div>
            <div class="badge" id="badge3" data-tooltip="Avanc√©: Compl√©tez 4 exercices">4</div>
            <div class="badge" id="badge4" data-tooltip="Expert: Compl√©tez tous les exercices">6</div>
        </div>
        
        <!-- Titration Simulation Panel -->
        <div class="titration-panel">
            <div class="titration-controls">
                <div class="control-group">
                    <h3>Configuration du Titrage</h3>
                    <div class="input-group">
                        <label for="burette-content">Produit dans la burette:</label>
                        <select id="burette-content">
                            <option value="acid">Acide</option>
                            <option value="base" selected>Base</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="erlenmeyer-content">Produit dans l'erlenmeyer:</label>
                        <select id="erlenmeyer-content">
                            <option value="acid" selected>Acide</option>
                            <option value="base">Base</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="indicator-type">Indicateur color√©:</label>
                        <select id="indicator-type">
                            <option value="bromothymol" selected>Bleu de bromothymol</option>
                            <option value="phenolphthalein">Ph√©nolphtal√©ine</option>
                        </select>
                    </div>
                    <button id="validate-setup" class="validate-setup-btn">Valider la pr√©paration</button>
                </div>
                
                <div class="control-group">
                    <h3>Informations</h3>
                    <div id="titration-info">
                        <p id="indicator-info">Indicateur: Bleu de bromothymol</p>
                        <p id="volume-info">Volume dans l'erlenmeyer: 20.0 mL</p>
                        <p id="concentration-info">Concentration du titrant: 0.1 mol/L</p>
                        <p id="equivalence-info" style="display: none;">Volume √©quivalent: ? mL</p>
                    </div>
                </div>
            </div>
            
            <div class="titration-setup">
                <!-- Burette -->
                <div class="burette">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 137 1187.4" width="50" height="300">
                        <defs>
                            <linearGradient id="buretteFill" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color: #d2e1eb; stop-opacity: 1" />
                                <stop offset="100%" style="stop-color: #c5d5e0; stop-opacity: 1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Burette body -->
                        <path
                            style="fill: none; stroke: #216778; stroke-width: 1"
                            d="m11.32 11.698h63.98c2.95 0 5.33 5.96 5.33 13.36v915.97c-0.21 19.51-13.94 27.84-24.05 31.61l-1.25 193.56c-0.25 11.19-5.12 20.02-12.78 20.19-8.04 0.18-12.76-8.05-13.54-19.52l0.96-194.61c-2.93-0.43-21.43-8.58-24.91-29.98l0.92-917.23c0-7.4 2.38-13.36 5.33-13.36z"
                        />
                        
                        <!-- Markings -->
                        <path style="fill: #216778" d="M22.48 33.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 53.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 73.9v1h28.7v-1z" />
                        <path style="fill: #216778" d="M22.48 93.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 113.9v1h28.7v-1z" />
                        <path style="fill: #216778" d="M22.48 133.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 153.9v1h28.7v-1z" />
                        <path style="fill: #216778" d="M22.48 173.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 193.9v1h28.7v-1z" />
                        <path style="fill: #216778" d="M22.48 213.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 233.9v1h28.7v-1z" />
                        <path style="fill: #216778" d="M22.48 253.9v1h19.8v-1z" />
                        <path style="fill: #216778" d="M22.48 273.9v1h28.7v-1z" />
                        
                        <!-- Numbers for graduations -->
                        <text x="55" y="76.9" style="fill: #216778; font-size: 8px;">0</text>
                        <text x="55" y="156.9" style="fill: #216778; font-size: 8px;">10</text>
                        <text x="55" y="236.9" style="fill: #216778; font-size: 8px;">20</text>
                        <text x="55" y="276.9" style="fill: #216778; font-size: 8px;">25</text>
                        
                        <!-- Solution inside burette -->
                        <rect
                            id="burette-fill"
                            x="11.32"
                            y="11.698"
                            width="63.98"
                            height="0"
                            style="fill: url(#buretteFill); opacity: 0.8"
                        />
                        
                        <!-- Valve -->
                        <path
                            style="fill: #216778"
                            d="M102.01 1061.2h-99.04v-25.67h99.04c-1.78 8.7-1.65 17.24 0 25.67z"
                        />
                        <rect
                            style="fill: #216778"
                            x="17.23"
                            y="1021.3"
                            width="50.64"
                            height="54.07"
                        />
                        <path
                            style="fill: #2c89a0"
                            d="m117.84 1014.9 1.19 1.16 1.15-1.16-1.15 0.44-1.19-0.44z"
                        />
                    </svg>
                </div>
                
                <!-- Animated drop -->
                <div id="drop" class="drop"></div>
                
                <!-- Erlenmeyer flask -->
                <div class="erlenmeyer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 276" width="60" height="120">
                        <defs>
                            <linearGradient id="erlenFill" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color: #d2e1eb; stop-opacity: 0.9" />
                                <stop offset="100%" style="stop-color: #c5d5e0; stop-opacity: 0.6" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Flask outline -->
                        <path
                            style="fill: none; stroke: #9fabb9; stroke-width: 1"
                            d="m67.236 1.7446l10.625 10.625v67.312c-7.086 10.63-48.434 89.778-70.875 134.66-7.0863 14.17-7.0671 31.89 3.563 46.06 7.086 10.63 19.461 14.19 31.875 14.19h127.57c12.41 0 24.78-3.56 31.87-14.19 10.63-14.17 10.65-31.89 3.56-46.06-20.07-44.88-43.7-89.78-63.78-134.66v-67.31l10.28-10.282 0.35-0.3434h-85.034z"
                        />
                        
                        <!-- Glass effect -->
                        <path
                            style="fill: #d7e9fc; opacity: 0.5"
                            d="m67.236 1.7446l10.625 10.625v67.312c-7.086 10.63-48.434 89.778-70.875 134.66-7.0863 14.17-7.0671 31.89 3.563 46.06 7.086 10.63 19.461 14.19 31.875 14.19h127.57c12.41 0 24.78-3.56 31.87-14.19 10.63-14.17 10.65-31.89 3.56-46.06-20.07-44.88-43.7-89.78-63.78-134.66v-67.31l10.28-10.282 0.35-0.3434h-85.034z"
                        />
                        
                        <!-- Solution in flask -->
                        <path
                            id="erlen-fill"
                            class="solution-layer"
                            style="fill: url(#erlenFill)"
                            d="m68.309 110c-14.788 26.37-39.847 73.05-55.375 103.07-6.6406 12.83-6.617 28.85 3.343 41.68 6.64 9.63 18.244 12.85 29.875 12.85h119.5c11.63 0 23.24-3.22 29.88-12.85 9.96-12.83 9.98-28.85 3.34-41.68-15.9-34.35-34.05-68.72-50.69-103.07h-79.871z"
                        />
                    </svg>
                </div>
                
                <!-- Stir bar -->
                <div id="stir-bar" class="stir-bar"></div>
                
                <!-- Magnetic stirrer plate -->
                <div class="magnetic-stirrer">
                    <div class="stirrer-button">
                        <div id="stirrer-indicator" class="stirrer-indicator"></div>
                    </div>
                </div>
            </div>
            
            <button id="start-titration" class="start-titration-btn" disabled>D√©marrer le Titrage</button>
            
            <!-- Notification de validation -->
            <div id="validation-message" class="validation-message" style="display: none;">
                Pr√©paration valid√©e ! La burette et l'erlenmeyer sont maintenant remplis. Vous pouvez d√©marrer le titrage.
            </div>
            
            <!-- Equivalence Point Notice -->
            <div id="equivalence-notice" class="equivalence-notice">
                <h3>Point d'√©quivalence atteint !</h3>
                <p id="equivalence-message">La solution a chang√© de couleur, indiquant le point d'√©quivalence.</p>
            </div>
        </div>
        
        <div class="formula">
            Formule: Ca √ó Va = Cb √ó Vb
            <br>
            <small style="font-weight: normal; color: #666;">
                O√π Ca et Cb sont les concentrations molaires, Va et Vb sont les volumes en mL
            </small>
        </div>
        
        <div class="exercises">
            <!-- Exercice 1 -->
            <div class="exercise-card" data-exercise="1">
                <div class="material-header">
                    <span>Exercice 1</span>
                    <span class="exercise-badge" id="badge-ex1">Acide/Base</span>
                </div>
                
                <div class="question-text">
                    Calculez la concentration inconnue en utilisant la formule Ca √ó Va = Cb √ó Vb
                    <button class="prepare-titration-btn" onclick="prepareExerciseTitration(1)">Pr√©parer le titrage</button>
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label" id="label1-1">Produit titr√©:</span>
                        <span class="data-value" id="value1-1">Acide</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label1-2">Volume titr√© (Va):</span>
                        <span class="data-value" id="value1-2">20 mL</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label1-3">Titrant:</span>
                        <span class="data-value" id="value1-3">Base</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label1-4">Concentration du titrant (Cb):</span>
                        <span class="data-value" id="value1-4">0.1 mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label1-5">Volume √©quivalent (Vb):</span>
                        <span class="data-value" id="value1-5">? mL</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="answer-label1">Concentration inconnue (Ca) en mol/L (3 d√©cimales):</label>
                    <input type="number" id="answer1" placeholder="Entrez votre r√©ponse" step="0.001">
                    <button class="check-btn" onclick="checkAnswer(1)">V√©rifier</button>
                    <div class="result" id="result1"></div>
                    <div class="hint" id="hint1">üí° Utilisez la formule Ca √ó Va = Cb √ó Vb et isolez Ca</div>
                </div>
            </div>
            
            <!-- Exercice 2 -->
            <div class="exercise-card" data-exercise="2">
                <div class="material-header">
                    <span>Exercice 2</span>
                    <span class="exercise-badge" id="badge-ex2">Base/Acide</span>
                </div>
                
                <div class="question-text">
                    Calculez la concentration inconnue en utilisant la formule Ca √ó Va = Cb √ó Vb
                    <button class="prepare-titration-btn" onclick="prepareExerciseTitration(2)">Pr√©parer le titrage</button>
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label" id="label2-1">Produit titr√©:</span>
                        <span class="data-value" id="value2-1">Base</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label2-2">Volume titr√© (Vb):</span>
                        <span class="data-value" id="value2-2">15 mL</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label2-3">Titrant:</span>
                        <span class="data-value" id="value2-3">Acide</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label2-4">Concentration du titrant (Ca):</span>
                        <span class="data-value" id="value2-4">0.2 mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label2-5">Volume √©quivalent (Va):</span>
                        <span class="data-value" id="value2-5">? mL</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="answer-label2">Concentration inconnue (Cb) en mol/L (3 d√©cimales):</label>
                    <input type="number" id="answer2" placeholder="Entrez votre r√©ponse" step="0.001">
                    <button class="check-btn" onclick="checkAnswer(2)">V√©rifier</button>
                    <div class="result" id="result2"></div>
                    <div class="hint" id="hint2">üí° Utilisez la formule Ca √ó Va = Cb √ó Vb et isolez Cb</div>
                </div>
            </div>
            
            <!-- Exercice 3 -->
            <div class="exercise-card" data-exercise="3">
                <div class="material-header">
                    <span>Exercice 3</span>
                    <span class="exercise-badge" id="badge-ex3">Acide/Base</span>
                </div>
                
                <div class="question-text">
                    Calculez la concentration inconnue en utilisant la formule Ca √ó Va = Cb √ó Vb
                    <button class="prepare-titration-btn" onclick="prepareExerciseTitration(3)">Pr√©parer le titrage</button>
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label" id="label3-1">Produit titr√©:</span>
                        <span class="data-value" id="value3-1">Acide</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label3-2">Volume titr√© (Va):</span>
                        <span class="data-value" id="value3-2">25 mL</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label3-3">Titrant:</span>
                        <span class="data-value" id="value3-3">Base</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label3-4">Concentration du titrant (Cb):</span>
                        <span class="data-value" id="value3-4">0.05 mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label3-5">Volume √©quivalent (Vb):</span>
                        <span class="data-value" id="value3-5">? mL</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="answer-label3">Concentration inconnue (Ca) en mol/L (4 d√©cimales):</label>
                    <input type="number" id="answer3" placeholder="Entrez votre r√©ponse" step="0.0001">
                    <button class="check-btn" onclick="checkAnswer(3)">V√©rifier</button>
                    <div class="result" id="result3"></div>
                    <div class="hint" id="hint3">üí° Utilisez la formule Ca √ó Va = Cb √ó Vb et isolez Ca</div>
                </div>
            </div>
            
            <!-- Exercice 4 -->
            <div class="exercise-card" data-exercise="4">
                <div class="material-header">
                    <span>Exercice 4</span>
                    <span class="exercise-badge" id="badge-ex4">Base/Acide</span>
                </div>
                
                <div class="question-text">
                    Calculez la concentration inconnue en utilisant la formule Ca √ó Va = Cb √ó Vb
                    <button class="prepare-titration-btn" onclick="prepareExerciseTitration(4)">Pr√©parer le titrage</button>
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label" id="label4-1">Produit titr√©:</span>
                        <span class="data-value" id="value4-1">Base</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label4-2">Volume titr√© (Vb):</span>
                        <span class="data-value" id="value4-2">10 mL</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label4-3">Titrant:</span>
                        <span class="data-value" id="value4-3">Acide</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label4-4">Concentration du titrant (Ca):</span>
                        <span class="data-value" id="value4-4">0.1 mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label4-5">Volume √©quivalent (Va):</span>
                        <span class="data-value" id="value4-5">? mL</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="answer-label4">Concentration inconnue (Cb) en mol/L (3 d√©cimales):</label>
                    <input type="number" id="answer4" placeholder="Entrez votre r√©ponse" step="0.001">
                    <button class="check-btn" onclick="checkAnswer(4)">V√©rifier</button>
                    <div class="result" id="result4"></div>
                    <div class="hint" id="hint4">üí° Utilisez la formule Ca √ó Va = Cb √ó Vb et isolez Cb</div>
                </div>
            </div>
            
            <!-- Exercice 5 -->
            <div class="exercise-card" data-exercise="5">
                <div class="material-header">
                    <span>Exercice 5</span>
                    <span class="exercise-badge" id="badge-ex5">Acide/Base</span>
                </div>
                
                <div class="question-text">
                    Calculez la concentration inconnue en utilisant la formule Ca √ó Va = Cb √ó Vb
                    <button class="prepare-titration-btn" onclick="prepareExerciseTitration(5)">Pr√©parer le titrage</button>
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label" id="label5-1">Produit titr√©:</span>
                        <span class="data-value" id="value5-1">Acide</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label5-2">Volume titr√© (Va):</span>
                        <span class="data-value" id="value5-2">20 mL</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label5-3">Titrant:</span>
                        <span class="data-value" id="value5-3">Base</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label5-4">Concentration du titrant (Cb):</span>
                        <span class="data-value" id="value5-4">0.01 mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label5-5">Volume √©quivalent (Vb):</span>
                        <span class="data-value" id="value5-5">? mL</span>
                    </div>
                    <div class="data-row indicator-row">
                        <span class="data-label">Indicateur recommand√©:</span>
                        <span class="data-value" id="indicator-value-5">Ph√©nolphtal√©ine</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="answer-label5">Concentration inconnue (Ca) en mol/L (4 d√©cimales):</label>
                    <input type="number" id="answer5" placeholder="Entrez votre r√©ponse" step="0.0001">
                    <button class="check-btn" onclick="checkAnswer(5)">V√©rifier</button>
                    <div class="result" id="result5"></div>
                    <div class="hint" id="hint5">üí° Utilisez la formule Ca √ó Va = Cb √ó Vb et isolez Ca</div>
                </div>
            </div>
            
            <!-- Exercice 6 -->
            <div class="exercise-card" data-exercise="6">
                <div class="material-header">
                    <span>Exercice 6</span>
                    <span class="exercise-badge" id="badge-ex6">Base/Acide</span>
                </div>
                
                <div class="question-text">
                    Calculez la concentration inconnue en utilisant la formule Ca √ó Va = Cb √ó Vb
                    <button class="prepare-titration-btn" onclick="prepareExerciseTitration(6)">Pr√©parer le titrage</button>
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label" id="label6-1">Produit titr√©:</span>
                        <span class="data-value" id="value6-1">Base</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label6-2">Volume titr√© (Vb):</span>
                        <span class="data-value" id="value6-2">25 mL</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label6-3">Titrant:</span>
                        <span class="data-value" id="value6-3">Acide</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label6-4">Concentration du titrant (Ca):</span>
                        <span class="data-value" id="value6-4">0.05 mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label" id="label6-5">Volume √©quivalent (Va):</span>
                        <span class="data-value" id="value6-5">? mL</span>
                    </div>
                    <div class="data-row indicator-row">
                        <span class="data-label">Indicateur recommand√©:</span>
                        <span class="data-value" id="indicator-value-6">Bleu de bromothymol</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label id="answer-label6">Concentration inconnue (Cb) en mol/L (4 d√©cimales):</label>
                    <input type="number" id="answer6" placeholder="Entrez votre r√©ponse" step="0.0001">
                    <button class="check-btn" onclick="checkAnswer(6)">V√©rifier</button>
                    <div class="result" id="result6"></div>
                    <div class="hint" id="hint6">üí° Utilisez la formule Ca √ó Va = Cb √ó Vb et isolez Cb</div>
                </div>
            </div>
        </div>
        
        <button id="finishBtn" class="finish-btn" disabled>Terminer l'activit√©</button>
        
        <!-- Modal de fin d'activit√© -->
        <div id="completion-modal" class="modal-overlay">
            <div class="modal-content">
                <div id="modal-badge" class="modal-badge">70%</div>
                <div class="modal-header">
                    <h2>Activit√© termin√©e !</h2>
                    <p>Vous avez compl√©t√© les exercices de titrage acido-basique.</p>
                </div>
                <div class="modal-body">
                    <div class="score-result">
                        <span id="modal-score">0</span>/<span id="modal-total">6</span>
                    </div>
                    <p class="score-text" id="modal-score-text">Vous avez r√©ussi l'activit√©.</p>
                    
                    <div class="exercise-summary" id="exercise-summary">
                        <!-- Les √©l√©ments seront g√©n√©r√©s dynamiquement -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="close-modal-btn" class="close-modal-btn">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen button -->
    <div class="fullscreen-btn" id="fullscreenBtn">
        <span class="fullscreen-icon">‚õ∂</span>
    </div>
    
    <script>
        // Donn√©es des exercices
        const exerciseData = [
            // Exercice 1
            {
                titrationType: 'acid-base', // acide titr√© par base
                productTitrated: 'Acide',
                volumeTitrated: 20,
                titrant: 'Base',
                titrantConcentration: 0.1,
                equivalenceVolume: 10,
                correctAnswer: 0.05, // Ca = (Cb √ó Vb) / Va = (0.1 √ó 10) / 20 = 0.05
                recommendedIndicator: 'bromothymol',
                decimalPlaces: 3
            },
            // Exercice 2
            {
                titrationType: 'base-acid', // base titr√©e par acide
                productTitrated: 'Base',
                volumeTitrated: 15,
                titrant: 'Acide',
                titrantConcentration: 0.2,
                equivalenceVolume: 7.5,
                correctAnswer: 0.1, // Cb = (Ca √ó Va) / Vb = (0.2 √ó 7.5) / 15 = 0.1
                recommendedIndicator: 'bromothymol',
                decimalPlaces: 3
            },
            // Exercice 3
            {
                titrationType: 'acid-base',
                productTitrated: 'Acide',
                volumeTitrated: 25,
                titrant: 'Base',
                titrantConcentration: 0.05,
                equivalenceVolume: 12.5,
                correctAnswer: 0.025, // Ca = (Cb √ó Vb) / Va = (0.05 √ó 12.5) / 25 = 0.025
                recommendedIndicator: 'bromothymol',
                decimalPlaces: 4
            },
            // Exercice 4
            {
                titrationType: 'base-acid',
                productTitrated: 'Base',
                volumeTitrated: 10,
                titrant: 'Acide',
                titrantConcentration: 0.1,
                equivalenceVolume: 6,
                correctAnswer: 0.06, // Cb = (Ca √ó Va) / Vb = (0.1 √ó 6) / 10 = 0.06
                recommendedIndicator: 'phenolphthalein',
                decimalPlaces: 3
            },
            // Exercice 5
            {
                titrationType: 'acid-base',
                productTitrated: 'Acide',
                volumeTitrated: 20,
                titrant: 'Base',
                titrantConcentration: 0.01,
                equivalenceVolume: 15,
                correctAnswer: 0.0075, // Ca = (Cb √ó Vb) / Va = (0.01 √ó 15) / 20 = 0.0075
                recommendedIndicator: 'phenolphthalein',
                decimalPlaces: 4
            },
            // Exercice 6
            {
                titrationType: 'base-acid',
                productTitrated: 'Base',
                volumeTitrated: 25,
                titrant: 'Acide',
                titrantConcentration: 0.05,
                equivalenceVolume: 12,
                correctAnswer: 0.024, // Cb = (Ca √ó Va) / Vb = (0.05 √ó 12) / 25 = 0.024
                recommendedIndicator: 'bromothymol',
                decimalPlaces: 4
            }
        ];

        // Variables globales pour le quiz
        let score = 0;
        let answered = new Set();
        const totalExercises = 6;
        let currentExercise = 1;
        let selectedExerciseNum = null;
        let testCompleted = false;
        
        // Variables pour la simulation de titrage
        let buretteFillLevel = 0;
        let erlenFillLevel = 0;
        let dropsAdded = 0;
        let isStirring = false;
        let equivalenceReached = false;
        let dropInterval;
        let titrantUsed = 0;
        let userChangedSetup = false;
        let setupValidated = false;
        
        // Variables globales pour SCORM
        let API = null;
        let API_1484_11 = null;
        const scormVersion = "2004";
        let initialized = false;
        let terminated = false;
        let lastError = "";
        let suspendData = "";
        let entryStatus = "ab-initio";
        let sessionStartTime = Date.now();
        let totalTime = 0;
        let lastTimeUpdate = sessionStartTime;
        let timeInterval = null;
        
        // Stockage des r√©ponses de l'utilisateur
        let userAnswers = Array(totalExercises).fill(null);
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser SCORM
            initSCORM();
            startTimeTracking();
            
            // Mise √† jour du bouton Terminer
            updateFinishButton();
            
            // Permettre la validation avec Enter
            document.querySelectorAll('input[type="number"]').forEach((input) => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const exerciseNum = parseInt(this.id.replace('answer', ''));
                        checkAnswer(exerciseNum);
                    }
                });
            });
            
            // Lier les s√©lecteurs de produits
            document.getElementById('burette-content').addEventListener('change', function() {
                userChangedSetup = true;
                const buretteContent = this.value;
                document.getElementById('erlenmeyer-content').value = buretteContent === 'acid' ? 'base' : 'acid';
                updateTitrationSetup();
            });
            
            document.getElementById('erlenmeyer-content').addEventListener('change', function() {
                userChangedSetup = true;
                const erlenmeyerContent = this.value;
                document.getElementById('burette-content').value = erlenmeyerContent === 'acid' ? 'base' : 'acid';
                updateTitrationSetup();
            });
            
            // D√©sactiver le bouton de d√©marrage du titrage par d√©faut
            document.getElementById('start-titration').disabled = true;
            
            // Bouton de d√©marrage du titrage
            document.getElementById('start-titration').addEventListener('click', startTitrationSimulation);
            
            // Bouton de validation de la pr√©paration
            document.getElementById('validate-setup').addEventListener('click', validateSetup);
            
            // Gestion du choix de l'indicateur
            document.getElementById('indicator-type').addEventListener('change', updateIndicatorInfo);
            
            // Bouton de fin d'activit√©
            document.getElementById('finishBtn').addEventListener('click', finishActivity);
            
            // Bouton plein √©cran
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // Si des donn√©es sont suspendues, restaurer l'√©tat
            if (suspendData) {
                try {
                    restoreState(suspendData);
                } catch (e) {
                    console.error("Erreur lors de la restauration des donn√©es:", e);
                }
            }
        });
        
        // Pr√©parer le titrage pour un exercice sp√©cifique
        function prepareExerciseTitration(exerciseNum) {
            // Mettre √† jour l'exercice s√©lectionn√©
            selectedExerciseNum = exerciseNum;
            currentExercise = exerciseNum;
            
            // Mettre √† jour l'apparence des cartes d'exercice
            document.querySelectorAll('.exercise-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.exercise-card[data-exercise="${exerciseNum}"]`).classList.add('selected');
            
            // R√©initialiser la simulation
            resetTitrationSimulation();
            
            // R√©cup√©rer les donn√©es de l'exercice
            const data = exerciseData[exerciseNum - 1];
            
            // Informer l'utilisateur qu'il doit configurer manuellement la simulation
            const resultDiv = document.getElementById(`result${exerciseNum}`);
            resultDiv.textContent = "Veuillez configurer la simulation selon les param√®tres de cette question puis valider la pr√©paration.";
            resultDiv.className = "result show";
            resultDiv.style.backgroundColor = "#fff3cd";
            resultDiv.style.color = "#856404";
            resultDiv.style.border = "1px solid #ffeeba";
            
            // Faire d√©filer vers la simulation
            document.querySelector('.titration-panel').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Validation de la pr√©paration
        function validateSetup() {
            // V√©rifier si un exercice est s√©lectionn√©
            if (selectedExerciseNum === null) {
                // Afficher un message d'erreur
                const validationMessage = document.getElementById('validation-message');
                validationMessage.style.display = 'block';
                validationMessage.style.backgroundColor = '#f8d7da';
                validationMessage.style.border = '1px solid #f5c6cb';
                validationMessage.style.color = '#721c24';
                validationMessage.textContent = "Veuillez d'abord s√©lectionner un exercice avant de valider la pr√©paration.";
                
                // Masquer le message apr√®s 5 secondes
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 5000);
                return;
            }
            
            // R√©cup√©rer les donn√©es de l'exercice s√©lectionn√©
            const data = exerciseData[selectedExerciseNum - 1];
            
            // R√©cup√©rer les valeurs actuelles de la simulation
            const buretteContent = document.getElementById('burette-content').value;
            const indicatorType = document.getElementById('indicator-type').value;
            
            // V√©rifier que le produit dans la burette est correct selon le type de titrage
            let isCorrectBurette = false;
            let expectedBuretteContent = "";
            
            if (data.titrationType === 'acid-base') {
                // Pour un titrage acide/base, le produit dans la burette doit √™tre une base
                isCorrectBurette = (buretteContent === 'base');
                expectedBuretteContent = "Base";
            } else {
                // Pour un titrage base/acide, le produit dans la burette doit √™tre un acide
                isCorrectBurette = (buretteContent === 'acid');
                expectedBuretteContent = "Acide";
            }
            
            // V√©rifier si l'indicateur color√© correspond √† celui recommand√©
            const isCorrectIndicator = (indicatorType === data.recommendedIndicator);
            const expectedIndicator = data.recommendedIndicator === 'bromothymol' ? 'Bleu de bromothymol' : 'Ph√©nolphtal√©ine';
            
            // Si la configuration n'est pas correcte, informer l'utilisateur
            if (!isCorrectBurette || !isCorrectIndicator) {
                // Construire le message d'erreur
                let errorMessages = [];
                
                if (!isCorrectBurette) {
                    errorMessages.push(`Le produit dans la burette devrait √™tre: ${expectedBuretteContent}`);
                }
                
                if (!isCorrectIndicator) {
                    errorMessages.push(`L'indicateur color√© recommand√© est: ${expectedIndicator}`);
                }
                
                // Afficher un message d'erreur
                const validationMessage = document.getElementById('validation-message');
                validationMessage.style.display = 'block';
                validationMessage.style.backgroundColor = '#f8d7da';
                validationMessage.style.border = '1px solid #f5c6cb';
                validationMessage.style.color = '#721c24';
                validationMessage.textContent = `Configuration incorrecte:\n${errorMessages.join('\n')}`;
                
                // Masquer le message apr√®s 5 secondes
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 5000);
                return;
            }
            
            // Marquer la pr√©paration comme valid√©e
            setupValidated = true;
            document.getElementById('validate-setup').disabled = true;
            
            // D√©sactiver les s√©lecteurs apr√®s validation
            document.getElementById('burette-content').disabled = true;
            document.getElementById('erlenmeyer-content').disabled = true;
            document.getElementById('indicator-type').disabled = true;
            
            // Remplir la burette
            const buretteFill = document.getElementById('burette-fill');
            const totalHeight = 915.97;
            const fillPercentage = 80; // 80% rempli
            const fillHeight = fillPercentage / 100 * totalHeight;
            
            // Position de d√©part de la burette dans le SVG
            const buretteTopY = 11.698;
            
            // Positionner le liquide en bas de la burette
            const bottomY = buretteTopY + totalHeight - fillHeight;
            
            // D√©sactiver la transition pour le remplissage initial
            buretteFill.classList.remove('level-transition');
            
            // Positionner le liquide
            buretteFill.setAttribute('y', bottomY);
            buretteFill.setAttribute('height', fillHeight);
            buretteFillLevel = fillPercentage;
            
            // Remplir l'erlenmeyer avec la couleur initiale
            const erlenFill = document.getElementById('erlen-fill');
            erlenFill.style.display = 'block';
            
            // D√©finir les couleurs en fonction du contenu et de l'indicateur
            const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
            
            let initialColor;
            if (indicatorType === 'bromothymol') {
                initialColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-acid)' : 'var(--bromothymol-base)';
            } else { // ph√©nolphtal√©ine
                initialColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-acid)' : 'var(--phenolphthalein-base)';
            }
            
            // Appliquer les couleurs imm√©diatement
            const stops = document.querySelectorAll('#erlenFill stop');
            stops.forEach(stop => {
                stop.style.stopColor = initialColor;
            });
            
            // Ajouter la classe de transition uniquement pour l'erlenmeyer
            erlenFill.classList.add('color-transition');
            
            // R√©activer la transition pour l'animation de vidage
            setTimeout(() => {
                buretteFill.classList.add('level-transition');
            }, 100);
            
            // Mettre √† jour les informations de titrage avec les donn√©es de l'exercice
            document.getElementById('volume-info').textContent = `Volume dans l'erlenmeyer: ${data.volumeTitrated.toFixed(1)} mL`;
            document.getElementById('concentration-info').textContent = `Concentration du titrant: ${data.titrantConcentration.toFixed(3)} mol/L`;
            
            // Activer le bouton de d√©marrage du titrage
            document.getElementById('start-titration').disabled = false;
            
            // Afficher le message de validation
            const validationMessage = document.getElementById('validation-message');
            validationMessage.style.display = 'block';
            validationMessage.style.backgroundColor = 'rgba(46, 196, 182, 0.1)';
            validationMessage.style.border = '1px solid rgba(46, 196, 182, 0.3)';
            validationMessage.style.color = '#3c6a56';
            validationMessage.textContent = "Pr√©paration valid√©e ! La burette et l'erlenmeyer sont maintenant remplis. Vous pouvez d√©marrer le titrage.";
            
            // Masquer le message apr√®s 5 secondes
            setTimeout(() => {
                validationMessage.style.display = 'none';
            }, 5000);
        }
        
        // Mise √† jour des informations sur l'indicateur
        function updateIndicatorInfo() {
            const indicatorType = document.getElementById('indicator-type').value;
            let indicatorName = indicatorType === 'bromothymol' ? 'Bleu de bromothymol' : 'Ph√©nolphtal√©ine';
            document.getElementById('indicator-info').textContent = `Indicateur: ${indicatorName}`;
        }
        
        // Mise √† jour de la configuration du titrage
        function updateTitrationSetup() {
            // R√©initialiser la simulation sans toucher aux s√©lecteurs
            resetTitrationSimulation();
            
            // Mise √† jour des informations
            updateIndicatorInfo();
        }
        
        // R√©initialiser la simulation de titrage
        function resetTitrationSimulation() {
            // Arr√™ter l'animation de gouttes en cours
            if (dropInterval) {
                clearInterval(dropInterval);
                dropInterval = null;
            }
            
            // Masquer le message de validation
            document.getElementById('validation-message').style.display = 'none';
            
            // R√©initialiser les variables de simulation
            buretteFillLevel = 0;
            erlenFillLevel = 0;
            dropsAdded = 0;
            isStirring = false;
            equivalenceReached = false;
            titrantUsed = 0;
            setupValidated = false;
            
            // R√©initialiser l'UI
            document.getElementById('equivalence-notice').style.display = 'none';
            document.getElementById('start-titration').textContent = 'D√©marrer le Titrage';
            
            // Gestion des boutons et s√©lecteurs
            document.getElementById('start-titration').disabled = true;
            document.getElementById('validate-setup').disabled = false;
            document.getElementById('burette-content').disabled = false;
            document.getElementById('erlenmeyer-content').disabled = false;
            document.getElementById('indicator-type').disabled = false;
            
            // Supprimer toutes les classes de transition avant de r√©initialiser
            const buretteFill = document.getElementById('burette-fill');
            buretteFill.classList.remove('level-transition');
            
            const erlenFill = document.getElementById('erlen-fill');
            erlenFill.classList.remove('color-transition');
            
            // Forcer un reflow pour que les changements prennent effet imm√©diatement
            void buretteFill.offsetWidth;
            void erlenFill.offsetWidth;
            
            // Masquer le remplissage de la burette sans animation
            buretteFill.setAttribute('y', 11.698);
            buretteFill.setAttribute('height', '0');
            
            // Masquer le remplissage de l'erlenmeyer
            erlenFill.style.display = 'none';
            
            // Masquer la goutte
            document.getElementById('drop').style.display = 'none';
            
            // Arr√™ter l'agitation
            const stirBar = document.getElementById('stir-bar');
            stirBar.style.display = 'none';
            stirBar.classList.remove('active');
            document.getElementById('stirrer-indicator').classList.remove('active');
        }
        
        // D√©marrer la simulation de titrage
        function startTitrationSimulation() {
            // Si le bouton affiche "Recommencer le Titrage", r√©initialiser compl√®tement
            if (document.getElementById('start-titration').textContent === 'Recommencer le Titrage') {
                resetTitrationSimulation();
                // R√©initialiser userChangedSetup pour le prochain titrage
                userChangedSetup = false;
                return;
            }
            
            // V√©rifier si la pr√©paration a √©t√© valid√©e
            if (!setupValidated) {
                // Afficher un message d'erreur
                const validationMessage = document.getElementById('validation-message');
                validationMessage.style.display = 'block';
                validationMessage.style.backgroundColor = '#f8d7da';
                validationMessage.style.border = '1px solid #f5c6cb';
                validationMessage.style.color = '#721c24';
                validationMessage.textContent = "Veuillez d'abord valider la pr√©paration avant de d√©marrer le titrage.";
                
                // Masquer le message apr√®s 5 secondes
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 5000);
                return;
            }
            
            // D√©sactiver le bouton
            document.getElementById('start-titration').disabled = true;
            document.getElementById('start-titration').textContent = 'Titrage en cours...';
            
            // Afficher le barreau magn√©tique
            const stirBar = document.getElementById('stir-bar');
            stirBar.style.display = 'block';
            stirBar.classList.add('active');
            isStirring = true;
            document.getElementById('stirrer-indicator').classList.add('active');
            
            // D√©marrer l'animation du niveau de la burette qui descend
            lowerBuretteLevel();
        }
        
        // Animation du niveau de la burette qui baisse avec transition de couleur progressive
        function lowerBuretteLevel() {
            const buretteFill = document.getElementById('burette-fill');
            const erlenFill = document.getElementById('erlen-fill');
            const data = exerciseData[selectedExerciseNum - 1];
            
            // D√©terminer les couleurs de d√©but et de fin en fonction du contenu et de l'indicateur
            const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
            const indicatorType = document.getElementById('indicator-type').value;
            
            let initialColor, finalColor;
            
            if (indicatorType === 'bromothymol') {
                initialColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-acid)' : 'var(--bromothymol-base)';
                finalColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-base)' : 'var(--bromothymol-acid)';
            } else { // ph√©nolphtal√©ine
                initialColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-acid)' : 'var(--phenolphthalein-base)';
                finalColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-base)' : 'var(--phenolphthalein-acid)';
            }
            
            // Dur√©e totale de l'animation en ms
            const animationDuration = 3000;
            
            // D√©finir les couleurs interm√©diaires pour la transition progressive
            const stops = document.querySelectorAll('#erlenFill stop');
            
            // S'assurer que la couleur initiale est correcte
            stops.forEach(stop => {
                stop.style.stopColor = initialColor;
            });
            
            // Baisser le niveau √† 10% dans la burette
            buretteFill.setAttribute('y', 11.698 + ((100 - 10) / 100) * 915.97);
            buretteFill.setAttribute('height', 10 / 100 * 915.97);
            
            // Cr√©er une animation de couleur progressive
            let startTime = null;
            
            // Fonction d'animation pour la transition de couleur
            function animateColor(timestamp) {
                if (!startTime) startTime = timestamp;
                
                // Calculer la progression (0 √† 1)
                const progress = Math.min((timestamp - startTime) / animationDuration, 1);
                
                // D√©finir la couleur interm√©diaire en fonction de la progression
                if (progress < 1) {
                    // Simuler un changement de couleur qui s'acc√©l√®re vers la fin
                    let colorProgress;
                    
                    if (progress < 0.7) {
                        // Changement lent au d√©but (70% du temps)
                        colorProgress = progress * 0.2; // Seulement 20% du changement de couleur
                    } else {
                        // Changement rapide √† la fin (30% du temps restant)
                        colorProgress = 0.2 + (progress - 0.7) * (0.8 / 0.3); // Les 80% restants
                    }
                    
                    // Appliquer la couleur interm√©diaire
                    const currentColor = progress > 0.85 ? finalColor : initialColor;
                    stops.forEach(stop => {
                        stop.style.stopColor = currentColor;
                    });
                    
                    requestAnimationFrame(animateColor);
                } else {
                    // Animation termin√©e, d√©finir la couleur finale
                    stops.forEach(stop => {
                        stop.style.stopColor = finalColor;
                    });
                    
                    // Afficher le point d'√©quivalence
                    setTimeout(finishTitration, 100);
                }
            }
            
            // D√©marrer l'animation
            requestAnimationFrame(animateColor);
        }
        
        // Terminer directement le titrage
        function finishTitration() {
            // V√©rifier si un exercice est s√©lectionn√©
            if (selectedExerciseNum === null) {
                alert("Aucun exercice n'est s√©lectionn√©. Veuillez d'abord s√©lectionner un exercice.");
                return;
            }
            
            const data = exerciseData[selectedExerciseNum - 1];
            
            // D√©terminer le message d'√©quivalence en fonction du contenu et de l'indicateur
            const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
            const indicatorType = document.getElementById('indicator-type').value;
            
            let equivalenceMessage;
            
            if (indicatorType === 'bromothymol') {
                if (erlenmeyerContent === 'acid') {
                    equivalenceMessage = "La solution est pass√©e du jaune au bleu, indiquant que tout l'acide a √©t√© neutralis√©.";
                } else {
                    equivalenceMessage = "La solution est pass√©e du bleu au jaune, indiquant que toute la base a √©t√© neutralis√©e.";
                }
            } else { // ph√©nolphtal√©ine
                if (erlenmeyerContent === 'acid') {
                    equivalenceMessage = "La solution est pass√©e d'incolore √† rose, indiquant que tout l'acide a √©t√© neutralis√©.";
                } else {
                    equivalenceMessage = "La solution est pass√©e de rose √† incolore, indiquant que toute la base a √©t√© neutralis√©e.";
                }
            }
            
            // Afficher les notifications d'√©quivalence atteinte
            document.getElementById('equivalence-notice').style.display = 'block';
            document.getElementById('equivalence-info').style.display = 'block';
            document.getElementById('equivalence-info').textContent = `Volume √©quivalent: ${data.equivalenceVolume.toFixed(1)} mL`;
            
            // Mettre √† jour le message d'√©quivalence
            document.getElementById('equivalence-message').textContent = equivalenceMessage;
            
            // Mettre √† jour le bouton pour permettre de recommencer
            document.getElementById('start-titration').disabled = false;
            document.getElementById('start-titration').textContent = 'Recommencer le Titrage';
            
            // Mettre √† jour le volume √©quivalent dans l'exercice s√©lectionn√©
            const volumeValueElement = document.getElementById(`value${selectedExerciseNum}-5`);
            if (volumeValueElement) {
                volumeValueElement.textContent = `${data.equivalenceVolume.toFixed(1)} mL`;
                
                // Mettre en √©vidence le changement
                volumeValueElement.style.backgroundColor = "#d4edda";
                volumeValueElement.style.padding = "2px 5px";
                volumeValueElement.style.borderRadius = "4px";
                
                // Revenir √† la normale apr√®s quelques secondes
                setTimeout(() => {
                    volumeValueElement.style.backgroundColor = "";
                    volumeValueElement.style.padding = "";
                }, 3000);
            }
            
            // Informer l'utilisateur que les donn√©es sont pr√™tes pour le calcul
            const resultDiv = document.getElementById(`result${selectedExerciseNum}`);
            resultDiv.textContent = "Le volume √©quivalent a √©t√© d√©termin√©. Vous pouvez maintenant calculer la concentration inconnue.";
            resultDiv.className = "result show";
            resultDiv.style.backgroundColor = "#d1ecf1";
            resultDiv.style.color = "#0c5460";
            resultDiv.style.border = "1px solid #bee5eb";
        }
        
        // V√©rifier la r√©ponse de l'utilisateur
        function checkAnswer(exerciseNum) {
            const userAnswer = parseFloat(document.getElementById(`answer${exerciseNum}`).value);
            const resultDiv = document.getElementById(`result${exerciseNum}`);
            const hintDiv = document.getElementById(`hint${exerciseNum}`);
            const data = exerciseData[exerciseNum - 1];
            
            // V√©rifier si l'exercice actuel a √©t√© s√©lectionn√©
            if (selectedExerciseNum !== exerciseNum) {
                resultDiv.textContent = "‚ö†Ô∏è Veuillez d'abord pr√©parer et effectuer le titrage pour cet exercice";
                resultDiv.className = "result incorrect show";
                return;
            }
            
            // V√©rifier si le volume √©quivalent a √©t√© d√©termin√©
            const volumeValueElement = document.getElementById(`value${exerciseNum}-5`);
            if (volumeValueElement.textContent === "? mL") {
                resultDiv.textContent = "‚ö†Ô∏è Le volume √©quivalent n'a pas encore √©t√© d√©termin√©. Effectuez d'abord le titrage.";
                resultDiv.className = "result incorrect show";
                return;
            }
            
            if (isNaN(userAnswer)) {
                resultDiv.textContent = "‚ö†Ô∏è Veuillez entrer un nombre";
                resultDiv.className = "result incorrect show";
                return;
            }
            
            // R√©cup√©rer le nombre de d√©cimales attendues
            const decimalPlaces = data.decimalPlaces || 3; // Par d√©faut 3 d√©cimales si non sp√©cifi√©
            
            // Arrondir la r√©ponse de l'utilisateur au nombre de d√©cimales attendues
            const roundedUserAnswer = parseFloat(userAnswer.toFixed(decimalPlaces));
            
            // Tol√©rance adapt√©e au nombre de d√©cimales
            const tolerance = Math.max(Math.abs(data.correctAnswer) * 0.01, Math.pow(10, -decimalPlaces) * 5);
            
            const isCorrect = Math.abs(roundedUserAnswer - data.correctAnswer) <= tolerance;
            
            if (isCorrect) {
                resultDiv.textContent = `‚úÖ Correct ! Bien jou√© ! (${decimalPlaces} d√©cimales attendues)`;
                resultDiv.className = "result correct show";
                hintDiv.style.display = "none";
                
                if (!answered.has(exerciseNum)) {
                    answered.add(exerciseNum);
                    score++;
                    document.getElementById('score').textContent = score;
                    
                    // Sauvegarder la r√©ponse
                    userAnswers[exerciseNum - 1] = userAnswer;
                    
                    // Mise √† jour des badges
                    updateBadges();
                    
                    // SCORM: Enregistrer l'interaction
                    recordInteraction(exerciseNum - 1, isCorrect);
                    
                    // SCORM: Sauvegarder le score
                    saveScore();
                    
                    // SCORM: Sauvegarder l'√©tat
                    saveState();
                    
                    // Mettre √† jour le bouton de fin
                    updateFinishButton();
                }
                
                // D√©sactiver l'input et le bouton
                document.getElementById(`answer${exerciseNum}`).disabled = true;
                document.querySelector(`.exercise-card[data-exercise="${exerciseNum}"] .check-btn`).disabled = true;
                document.querySelector(`.exercise-card[data-exercise="${exerciseNum}"] .prepare-titration-btn`).disabled = true;
            } else {
                resultDiv.textContent = `‚ùå Incorrect. R√©essayez ou v√©rifiez votre calcul. (${decimalPlaces} d√©cimales attendues)`;
                resultDiv.className = "result incorrect show";
                hintDiv.style.display = "block";
            }
        }
        
        // Mise √† jour des badges
        function updateBadges() {
            // D√©finir les seuils pour les badges
            const thresholds = [1, 2, 4, 6];
            
            // Mettre √† jour chaque badge en fonction du nombre d'exercices r√©solus
            for (let i = 0; i < thresholds.length; i++) {
                const badge = document.getElementById(`badge${i+1}`);
                if (score >= thresholds[i]) {
                    badge.classList.add('unlocked');
                }
            }
        }
        
        // Mettre √† jour le bouton de fin
        function updateFinishButton() {
            const finishBtn = document.getElementById('finishBtn');
            if (answered.size >= 1) {
                finishBtn.disabled = false;
            } else {
                finishBtn.disabled = true;
            }
        }
        
        // Terminer l'activit√©
        function finishActivity() {
            // V√©rifier si au moins une question est r√©pondue
            if (answered.size === 0) {
                // Afficher un message d'erreur
                const validationMessage = document.getElementById('validation-message');
                validationMessage.style.display = 'block';
                validationMessage.style.backgroundColor = '#f8d7da';
                validationMessage.style.border = '1px solid #f5c6cb';
                validationMessage.style.color = '#721c24';
                validationMessage.textContent = "Vous devez r√©pondre √† au moins une question avant de terminer l'activit√©.";
                
                // Masquer le message apr√®s 5 secondes
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 5000);
                return;
            }
            
            // Marquer le test comme termin√©
            testCompleted = true;
            
            // SCORM: Marquer comme termin√©
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
            setValue("cmi.exit", "normal");
            
            // SCORM: Mettre √† jour le temps de session
            updateSessionTime();
            
            // SCORM: Sauvegarder l'√©tat final
            saveState();
            
            // SCORM: Effectuer un commit final
            commitSCORM();
            
            // D√©sactiver tous les inputs et boutons
            document.querySelectorAll('input, .check-btn, .finish-btn, .start-titration-btn, .prepare-titration-btn, select').forEach(el => {
                el.disabled = true;
            });
            
            // Afficher le modal de fin d'activit√©
            showCompletionModal();
        }
        
        // Afficher le modal de fin d'activit√©
        function showCompletionModal() {
            // Mettre √† jour les donn√©es du modal
            document.getElementById('modal-score').textContent = score;
            document.getElementById('modal-total').textContent = totalExercises;
            
            // Calculer le pourcentage
            const percentage = Math.round((score / totalExercises) * 100);
            document.getElementById('modal-badge').textContent = percentage + '%';
            
            // D√©finir si l'√©tudiant a r√©ussi ou √©chou√© (seuil √† 70%)
            const isPassed = percentage >= 70;
            if (!isPassed) {
                document.getElementById('modal-badge').classList.add('failed');
            }
            
            // Mettre √† jour le texte du score
            const scoreText = document.getElementById('modal-score-text');
            if (isPassed) {
                scoreText.textContent = "F√©licitations ! Vous avez r√©ussi l'activit√©.";
            } else {
                scoreText.textContent = "Vous n'avez pas atteint le score minimum requis de 70%.";
            }
            
            // G√©n√©rer le r√©sum√© des exercices
            const summaryContainer = document.getElementById('exercise-summary');
            summaryContainer.innerHTML = '';
            
            for (let i = 0; i < totalExercises; i++) {
                const exerciseNum = i + 1;
                const isCompleted = answered.has(exerciseNum);
                
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                
                exerciseItem.innerHTML = `
                    <span>Exercice ${exerciseNum}</span>
                    <span class="exercise-status ${isCompleted ? 'status-completed' : 'status-incomplete'}">
                        ${isCompleted ? 'Compl√©t√© ‚úì' : 'Non compl√©t√© ‚úó'}
                    </span>
                `;
                
                summaryContainer.appendChild(exerciseItem);
            }
            
            // Afficher le modal
            const modal = document.getElementById('completion-modal');
            modal.style.display = 'flex';
            
            // Ajouter l'√©v√©nement de fermeture au bouton
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Fermer le modal en cliquant en dehors
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Plein √©cran
        function toggleFullscreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                // Passer en mode plein √©cran
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
                updateFullscreenButton(true);
                document.body.classList.add('fullscreen-container');
            } else {
                // Quitter le mode plein √©cran
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                updateFullscreenButton(false);
                document.body.classList.remove('fullscreen-container');
            }
        }
        
        function updateFullscreenButton(isFullscreen) {
            const iconElement = document.querySelector('.fullscreen-icon');
            if (isFullscreen) {
                iconElement.textContent = '‚õù'; // Ic√¥ne pour quitter le plein √©cran
            } else {
                iconElement.textContent = '‚õ∂'; // Ic√¥ne pour entrer en plein √©cran
            }
        }
        
        // D√©tection des changements de plein √©cran
        document.addEventListener('fullscreenchange', () => {
            updateFullscreenButton(!!document.fullscreenElement);
        });
        document.addEventListener('webkitfullscreenchange', () => {
            updateFullscreenButton(!!document.webkitFullscreenElement);
        });
        document.addEventListener('mozfullscreenchange', () => {
            updateFullscreenButton(!!document.mozFullScreenElement);
        });
        document.addEventListener('MSFullscreenChange', () => {
            updateFullscreenButton(!!document.msFullscreenElement);
        });
        
        // ========== FONCTIONS SCORM ==========
        
        // D√©tection de l'API SCORM
        function findAPI(win) {
            // Recherche SCORM 2004 API
            if (win.API_1484_11) return win.API_1484_11;
            
            // Recherche dans les frames
            let findAPITries = 0;
            while (win.parent && win.parent != win && findAPITries < 10) {
                findAPITries++;
                win = win.parent;
                if (win.API_1484_11) return win.API_1484_11;
            }
            
            // Si on n'a pas trouv√©, essayer avec les frames
            let frames = win.frames;
            for (let i = 0; i < frames.length; i++) {
                let api = findAPI(frames[i]);
                if (api) return api;
            }
            
            return null;
        }
        
        // Gestion des erreurs
        function getLastError() {
            if (API_1484_11) {
                let errorCode = API_1484_11.GetLastError();
                let errorString = API_1484_11.GetErrorString(errorCode);
                let errorDescription = API_1484_11.GetDiagnostic(errorCode);
                
                let errorInfo = "Code: " + errorCode + "\nDescription: " + errorString + "\nDiagnostic: " + errorDescription;
                console.error("SCORM Error: " + errorInfo);
                
                lastError = errorInfo;
                return errorCode;
            }
            return 0;
        }
        
        // Initialisation SCORM
        function initSCORM() {
            if (initialized) return true;
            
            // Trouver l'API SCORM 2004
            API_1484_11 = findAPI(window);
            
            if (!API_1484_11) {
                console.error("SCORM API non trouv√©e");
                return false;
            }
            
            // Initialiser la communication
            let result = API_1484_11.Initialize("");
            
            if (result === "true" || result === true) {
                console.log("SCORM API initialis√©e avec succ√®s");
                initialized = true;
                
                // R√©cup√©rer l'√©tat pr√©c√©dent si disponible
                entryStatus = getValue("cmi.entry");
                suspendData = getValue("cmi.suspend_data");
                
                // R√©cup√©rer les donn√©es sauvegard√©es si elles existent
                if (suspendData) {
                    try {
                        restoreState(suspendData);
                    } catch (e) {
                        console.error("Erreur lors de la restauration des donn√©es:", e);
                    }
                }
                
                return true;
            } else {
                console.error("√âchec de l'initialisation SCORM");
                getLastError();
                return false;
            }
        }
        
        // D√©finir une valeur SCORM
        function setValue(element, value) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.SetValue(element, value);
            
            if (result === "false" || result === false) {
                console.error(`Erreur lors de la d√©finition de ${element} = ${value}`);
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Obtenir une valeur SCORM
        function getValue(element) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return "";
            }
            
            let value = API_1484_11.GetValue(element);
            
            if (API_1484_11.GetLastError() !== "0") {
                console.error(`Erreur lors de la r√©cup√©ration de ${element}`);
                getLastError();
                return "";
            }
            
            return value;
        }
        
        // Sauvegarder les changements SCORM
        function commitSCORM() {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.Commit("");
            
            if (result === "false" || result === false) {
                console.error("Erreur lors du commit SCORM");
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Terminer la session SCORM
        function terminateSCORM() {
            if (!initialized || !API_1484_11 || terminated) {
                return false;
            }
            
            // Arr√™ter le suivi du temps
            stopTimeTracking();
            
            // Mettre √† jour le temps de session final
            updateSessionTime();
            
            // Commit final avant de terminer
            commitSCORM();
            
            // Terminer la session
            let result = API_1484_11.Terminate("");
            
            if (result === "true" || result === true) {
                console.log("Session SCORM termin√©e avec succ√®s");
                terminated = true;
                return true;
            } else {
                console.error("Erreur lors de la terminaison de la session SCORM");
                getLastError();
                return false;
            }
        }
        
        // Sauvegarde de l'√©tat
        function saveState() {
            // Cr√©er un objet avec toutes les donn√©es √† sauvegarder
            const stateData = {
                userAnswers: userAnswers,
                score: score,
                answered: Array.from(answered),
                testCompleted: testCompleted,
                selectedExerciseNum: selectedExerciseNum,
                setupValidated: setupValidated
            };
            
            // Convertir en JSON
            suspendData = JSON.stringify(stateData);
            
            // Sauvegarder dans SCORM
            setValue("cmi.suspend_data", suspendData);
            
            // Sauvegarder le score actuel
            saveScore();
            
            // Sauvegarder l'√©tat de progression
            saveProgress();
            
            // Commit imm√©diat pour assurer la persistance des donn√©es
            commitSCORM();
            
            console.log("√âtat sauvegard√© avec succ√®s");
        }
        
        // Restauration de l'√©tat
        function restoreState(jsonString) {
            if (!jsonString) return;
            
            try {
                const data = JSON.parse(jsonString);
                
                // Restaurer les donn√©es
                userAnswers = data.userAnswers || Array(totalExercises).fill(null);
                score = data.score || 0;
                answered = new Set(data.answered || []);
                testCompleted = data.testCompleted || false;
                selectedExerciseNum = data.selectedExerciseNum || null;
                setupValidated = data.setupValidated || false;
                
                // Mettre √† jour l'interface
                document.getElementById('score').textContent = score;
                
                // Mise √† jour des badges
                updateBadges();
                
                // Mettre √† jour chaque exercice
                for (let i = 0; i < userAnswers.length; i++) {
                    if (userAnswers[i] !== null) {
                        const exerciseNum = i + 1;
                        const inputElement = document.getElementById(`answer${exerciseNum}`);
                        const buttonElement = inputElement.parentElement.querySelector('.check-btn');
                        const resultDiv = document.getElementById(`result${exerciseNum}`);
                        const volumeValueElement = document.getElementById(`value${exerciseNum}-5`);
                        
                        // Afficher la r√©ponse
                        inputElement.value = userAnswers[i];
                        inputElement.disabled = true;
                        buttonElement.disabled = true;
                        
                        // Afficher le volume √©quivalent s'il a √©t√© d√©termin√©
                        if (exerciseData[i] && exerciseData[i].equivalenceVolume) {
                            volumeValueElement.textContent = `${exerciseData[i].equivalenceVolume.toFixed(1)} mL`;
                        }
                        
                        // Afficher le r√©sultat
                        resultDiv.textContent = "‚úÖ D√©j√† r√©pondu";
                        resultDiv.className = "result correct show";
                        
                        // D√©sactiver le bouton de pr√©paration
                        const prepareBtn = document.querySelector(`.exercise-card[data-exercise="${exerciseNum}"] .prepare-titration-btn`);
                        if (prepareBtn) prepareBtn.disabled = true;
                    }
                }
                
                // Si un exercice √©tait s√©lectionn√©, mettre √† jour l'interface
                if (selectedExerciseNum !== null) {
                    // Mettre en √©vidence l'exercice s√©lectionn√©
                    document.querySelectorAll('.exercise-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    const selectedCard = document.querySelector(`.exercise-card[data-exercise="${selectedExerciseNum}"]`);
                    if (selectedCard) selectedCard.classList.add('selected');
                    
                    // Si la pr√©paration √©tait valid√©e, mettre √† jour l'interface
                    if (setupValidated) {
                        document.getElementById('validate-setup').disabled = true;
                        document.getElementById('burette-content').disabled = true;
                        document.getElementById('erlenmeyer-content').disabled = true;
                        document.getElementById('indicator-type').disabled = true;
                        document.getElementById('start-titration').disabled = false;
                    }
                }
                
                // Mettre √† jour le bouton de fin
                updateFinishButton();
                
                // Si le test est d√©j√† termin√©, d√©sactiver tous les contr√¥les
                if (testCompleted) {
                    document.querySelectorAll('input, .check-btn, .finish-btn, .prepare-titration-btn, select, .start-titration-btn, .validate-setup-btn').forEach(el => {
                        el.disabled = true;
                    });
                    
                    // Afficher un message indiquant que l'activit√© est termin√©e
                    const validationMessage = document.getElementById('validation-message');
                    validationMessage.style.display = 'block';
                    validationMessage.style.backgroundColor = '#d4edda';
                    validationMessage.style.border = '1px solid #c3e6cb';
                    validationMessage.style.color = '#155724';
                    validationMessage.textContent = `Cette activit√© a d√©j√† √©t√© compl√©t√©e. Votre score est de ${score}/${totalExercises}.`;
                }
                
                console.log("√âtat restaur√© avec succ√®s");
            } catch (e) {
                console.error("Erreur lors de la restauration de l'√©tat:", e);
            }
        }
        
        // Sauvegarde du score
        function saveScore() {
            // Normaliser le score sur 100
            const normalizedScore = Math.min(Math.max((score / totalExercises) * 100, 0), 100);
            
            // Sauvegarder dans SCORM 2004
            setValue("cmi.score.raw", normalizedScore);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", normalizedScore / 100);
            
            // D√©terminer si le test est r√©ussi (seuil de r√©ussite √† 70%)
            if (testCompleted) {
                const passed = normalizedScore >= 70;
                setValue("cmi.success_status", passed ? "passed" : "failed");
            }
            
            console.log(`Score sauvegard√©: ${normalizedScore}/100 (${score}/${totalExercises})`);
            
            // Commit imm√©diat pour assurer la persistance du score
            commitSCORM();
        }
        
        // Suivi de la progression
        function saveProgress() {
            // Calculer le pourcentage de compl√©tion
            const progress = answered.size / totalExercises;
            
            // D√©terminer l'√©tat de compl√©tion
            let completionStatus = "incomplete";
            
            if (testCompleted) {
                completionStatus = "completed";
            } else if (progress > 0) {
                completionStatus = "incomplete";
            } else {
                completionStatus = "not attempted";
            }
            
            // Sauvegarder dans SCORM
            setValue("cmi.completion_status", completionStatus);
            setValue("cmi.progress_measure", progress.toFixed(2));
            
            console.log(`Progression sauvegard√©e: ${(progress * 100).toFixed(0)}%, √©tat: ${completionStatus}`);
        }
        
        // Enregistrement des interactions
        function recordInteraction(exerciseIndex, isCorrect) {
            if (!initialized) return;
            
            // G√©n√©rer un ID unique pour l'interaction
            const interactionId = `ex${exerciseIndex}`;
            
            // Type d'interaction (choix num√©rique)
            const interactionType = "numeric";
            
            // Description de l'exercice
            const description = `Exercice ${exerciseIndex + 1}`;
            
            // R√©ponse de l'utilisateur
            const learnerAnswer = userAnswers[exerciseIndex].toString();
            
            // R√©sultat
            const result = isCorrect ? "correct" : "incorrect";
            
            // Horodatage
            const timestamp = new Date().toISOString();
            
            // Poids de l'exercice (1 point par exercice)
            const weighting = "1";
            
            // Dur√©e (non impl√©ment√©e ici)
            const latency = "PT0H0M0S";
            
            // Nombre total d'interactions jusqu'√† pr√©sent
            const n = parseInt(getValue("cmi.interactions._count"), 10) || 0;
            
            // Enregistrer l'interaction
            setValue(`cmi.interactions.${n}.id`, interactionId);
            setValue(`cmi.interactions.${n}.type`, interactionType);
            setValue(`cmi.interactions.${n}.description`, description);
            setValue(`cmi.interactions.${n}.learner_response`, learnerAnswer);
            setValue(`cmi.interactions.${n}.result`, result);
            setValue(`cmi.interactions.${n}.timestamp`, timestamp);
            setValue(`cmi.interactions.${n}.weighting`, weighting);
            setValue(`cmi.interactions.${n}.latency`, latency);
            
            console.log(`Interaction enregistr√©e: Exercice ${exerciseIndex + 1}, R√©sultat: ${result}`);
            
            // Commit pour sauvegarder cette interaction
            commitSCORM();
        }
        
        // Gestion du temps de session
        function startTimeTracking() {
            sessionStartTime = Date.now();
            lastTimeUpdate = sessionStartTime;
            
            // Mettre √† jour le temps toutes les 30 secondes
            timeInterval = setInterval(() => {
                updateSessionTime();
            }, 30000); // 30 secondes
        }
        
        function updateSessionTime() {
            const currentTime = Date.now();
            const elapsedTime = currentTime - lastTimeUpdate;
            
            totalTime += elapsedTime;
            lastTimeUpdate = currentTime;
            
            // Formater le temps selon SCORM 2004
            const formattedTime = formatScormTime(totalTime);
            
            // Sauvegarder dans SCORM
            setValue("cmi.session_time", formattedTime);
            
            // Commit pour sauvegarder le temps
            commitSCORM();
        }
        
        function formatScormTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Format SCORM 2004: PTxHyMzS
            return `PT${hours}H${minutes}M${seconds}S`;
        }
        
        function stopTimeTracking() {
            if (timeInterval) {
                clearInterval(timeInterval);
                updateSessionTime(); // Enregistrer le temps final
            }
        }

        // Gestion de la fermeture de la page
        window.addEventListener('beforeunload', function() {
            // Sauvegarder l'√©tat final et terminer la session SCORM
            if (initialized && !terminated) {
                updateSessionTime();
                saveState();
                terminateSCORM();
            }
        });
    </script>
</body>
</html>
