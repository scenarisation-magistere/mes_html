<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul de masses molaires - Tableau Périodique</title>
    <style>
        /* Styles généraux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary-color: #d32f2f;
            --primary-dark: #b71c1c;
            --primary-light: #ef5350;
            --accent-color: #ff5722;
            --text-color: #333;
            --background-color: #f8f9fa;
            --card-color: #fff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--primary-color);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--card-color);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        /* Styles du header */
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        
        .typescorm {
            position: fixed;
            top: 60px;
            left: 60px;
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }        
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: var(--text-color);
            z-index: 100;
        }
        
        .score {
            color: var(--primary-color);
            font-size: 1.2em;
        }
        
        .formula-box {
            text-align: center;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            color: #444;
        }
        
        .formula {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .formula-explanation {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Badges de gamification */
        .badges-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 24px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .badge.unlocked {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .badge-tooltip {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .badge:hover .badge-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Styles du tableau périodique */
        .periodic-container {
            margin: 20px 0;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .periodic-table {
            display: grid;
            grid-template-columns: repeat(18, 1fr);
            gap: 2px;
            background-color: #eeeeee;
            padding: 10px;
        }
        
        .element {
            position: relative;
            padding: 5px;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 0.8em;
            text-align: center;
            transition: all 0.2s ease;
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .element:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .element.active {
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--primary-color);
        }
        
        .atomic-number {
            position: absolute;
            top: 3px;
            left: 3px;
            font-size: 0.7em;
        }
        
        .symbol {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .name {
            font-size: 0.6em;
            margin-top: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Types d'éléments */
        .alkali { background-color: #ff6b6b; }
        .alkaline-earth { background-color: #ffa06b; }
        .transition { background-color: #ffd36b; }
        .post-transition { background-color: #c3ff6b; }
        .metalloid { background-color: #6bff9c; }
        .nonmetal { background-color: #6bfff7; }
        .noble-gas { background-color: #6b9cff; }
        
        .empty {
            background: transparent;
        }
        
        /* Infos de l'élément sélectionné */
        .element-info {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .element-info h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .element-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .element-detail {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* Grille d'exercices */
        .exercises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .exercise-card {
            background-color: var(--card-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid #eee;
        }
        
        .exercise-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transform: translateY(-5px);
        }
        
        .question-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .question-text {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .input-group {
            margin-top: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        .answer-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .check-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .check-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hint {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        /* Animation pour les exercices résolus */
        .exercise-card.solved {
            border-color: #28a745;
            background-color: #f0fff4;
        }
        
        /* Style pour les exercices incorrects */
        .exercise-card.incorrect {
            background-color: #ffebee;
            border: 2px solid #ffcdd2;
            box-shadow: 0 4px 10px rgba(244, 67, 54, 0.1);
        }
        
        /* Bouton terminer l'activité */
        .finish-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto 0;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .finish-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .finish-btn:disabled {
            background: #8fcb99;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        /* Message de validation */
        #validation-message {
            display: none;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            max-width: 600px;
        }
        
        /* Styles pour le modal de fin d'activité */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: slideIn 0.4s ease-out;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .score-result {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .score-text {
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        
        .exercise-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .exercise-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .exercise-item:last-child {
            border-bottom: none;
        }
        
        .exercise-status {
            font-weight: bold;
        }
        
        .status-completed {
            color: #28a745;
        }
        
        .status-incomplete {
            color: #dc3545;
        }
        
        .modal-footer {
            margin-top: 20px;
        }
        
        .close-modal-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-modal-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        .modal-badge {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--success-color);
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 4px solid white;
        }
        
        .modal-badge.failed {
            background: var(--danger-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* CSS pour le bouton "Plein écran" */
        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .fullscreen-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        
        .fullscreen-icon {
            font-size: 1.5em;
            color: var(--primary-color);
        }
        
        /* Style supplémentaire pour le mode plein écran */
        .fullscreen-container {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            background: var(--primary-color);
            padding: 20px;
        }
        
        /* Media queries pour la responsivité */
        @media (max-width: 768px) {
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .exercises-grid {
                grid-template-columns: 1fr;
            }
            
            .element-details {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .modal-header h2 {
                font-size: 1.5em;
            }
            
            .score-result {
                font-size: 2.5em;
            }
            
            .modal-badge {
                width: 60px;
                height: 60px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <!-- Tableau de score -->
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">8</span>
    </div>
    
    <!-- Conteneur principal -->
    <div class="container">
        <h1>🧪 Calcul de masses molaires 🧪</h1>
        
        <div class="typescorm">SCORM App</div>
        
        <div class="formula-box">
            <div class="formula">
                Calcul de masses molaires moléculaires
            </div>
            <div class="formula-explanation">
                Utilisez le tableau périodique interactif pour identifier les masses atomiques des éléments et calculer les masses molaires des molécules.
            </div>
        </div>
        
        <!-- Badges de gamification -->
        <div class="badges-container">
            <div class="badge" id="badge1">
                🧪
                <div class="badge-tooltip">Débutant: 2 exercices résolus</div>
            </div>
            <div class="badge" id="badge2">
                🔬
                <div class="badge-tooltip">Intermédiaire: 4 exercices résolus</div>
            </div>
            <div class="badge" id="badge3">
                🧫
                <div class="badge-tooltip">Avancé: 6 exercices résolus</div>
            </div>
            <div class="badge" id="badge4">
                🧠
                <div class="badge-tooltip">Expert: 8 exercices résolus</div>
            </div>
        </div>
        
        <!-- Tableau périodique -->
        <div class="periodic-container">
            <div class="periodic-table" id="periodicTable">
                <!-- Les éléments du tableau périodique seront générés dynamiquement par JS -->
            </div>
        </div>
        
        <!-- Information sur l'élément sélectionné -->
        <div class="element-info">
            <h3>
                <span>Élément sélectionné:</span>
                <span id="elementName">Hydrogène</span>
            </h3>
            <div class="element-details" id="elementDetails">
                <!-- Les détails de l'élément sélectionné seront affichés ici -->
            </div>
        </div>
        
        <!-- Message de validation -->
        <div id="validation-message"></div>
        
        <!-- Grille d'exercices -->
        <div class="exercises-grid">
            <!-- Exercice 1 -->
            <div class="exercise-card" data-exercise="1" data-type="periodic" data-exercise-type="molecule" data-formula="NO2">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 1: Masse molaire du dioxyde d'azote</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire du dioxyde d'azote (NO₂) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer1" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('1', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result1"></div>
                <div class="hint" id="hint1">💡 Pour NO₂, calculez 1 × masse(N) + 2 × masse(O).</div>
            </div>
            
            <!-- Exercice 2 -->
            <div class="exercise-card" data-exercise="2" data-type="periodic" data-exercise-type="molecule" data-formula="SO2">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 2: Masse molaire du dioxyde de soufre</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire du dioxyde de soufre (SO₂) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer2" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('2', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result2"></div>
                <div class="hint" id="hint2">💡 Pour SO₂, calculez 1 × masse(S) + 2 × masse(O).</div>
            </div>
            
            <!-- Exercice 3 -->
            <div class="exercise-card" data-exercise="3" data-type="periodic" data-exercise-type="molecule" data-formula="C2H6">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 3: Masse molaire de l'éthane</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire de l'éthane (C₂H₆) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer3" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('3', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result3"></div>
                <div class="hint" id="hint3">💡 Pour C₂H₆, calculez 2 × masse(C) + 6 × masse(H).</div>
            </div>
            
            <!-- Exercice 4 -->
            <div class="exercise-card" data-exercise="4" data-type="periodic" data-exercise-type="molecule" data-formula="HNO3">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 4: Masse molaire de l'acide nitrique</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire de l'acide nitrique (HNO₃) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer4" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('4', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result4"></div>
                <div class="hint" id="hint4">💡 Pour HNO₃, calculez 1 × masse(H) + 1 × masse(N) + 3 × masse(O).</div>
            </div>
            
            <!-- Exercice 5 -->
            <div class="exercise-card" data-exercise="5" data-type="periodic" data-exercise-type="molecule" data-formula="C3H8O">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 5: Masse molaire du propanol</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire du propanol (C₃H₈O) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer5" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('5', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result5"></div>
                <div class="hint" id="hint5">💡 Pour C₃H₈O, calculez 3 × masse(C) + 8 × masse(H) + 1 × masse(O).</div>
            </div>
            
            <!-- Exercice 6 -->
            <div class="exercise-card" data-exercise="6" data-type="periodic" data-exercise-type="molecule" data-formula="MgCl2">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 6: Masse molaire du chlorure de magnésium</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire du chlorure de magnésium (MgCl₂) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer6" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('6', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result6"></div>
                <div class="hint" id="hint6">💡 Pour MgCl₂, calculez 1 × masse(Mg) + 2 × masse(Cl).</div>
            </div>
            
            <!-- Exercice 7 -->
            <div class="exercise-card" data-exercise="7" data-type="periodic" data-exercise-type="molecule" data-formula="K2CO3">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 7: Masse molaire du carbonate de potassium</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire du carbonate de potassium (K₂CO₃) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer7" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('7', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result7"></div>
                <div class="hint" id="hint7">💡 Pour K₂CO₃, calculez 2 × masse(K) + 1 × masse(C) + 3 × masse(O).</div>
            </div>
            
            <!-- Exercice 8 -->
            <div class="exercise-card" data-exercise="8" data-type="periodic" data-exercise-type="molecule" data-formula="C8H10N4O2">
                <div class="question-header">
                    <span class="question-icon">⚛️</span>
                    <span>Exercice 8: Masse molaire de la caféine</span>
                </div>
                
                <div class="question-text">
                    Calculez la masse molaire de la caféine (C₈H₁₀N₄O₂) en g/mol.
                </div>
                
                <div class="input-group">
                    <label>Votre réponse (g/mol):</label>
                    <input type="number" class="answer-input" id="answer8" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkPeriodicAnswer('8', 'molecule')">Vérifier</button>
                </div>
                
                <div class="result" id="result8"></div>
                <div class="hint" id="hint8">💡 Pour C₈H₁₀N₄O₂, calculez 8 × masse(C) + 10 × masse(H) + 4 × masse(N) + 2 × masse(O).</div>
            </div>
        </div>
        
        <!-- Bouton de fin d'activité -->
        <button id="finishBtn" class="finish-btn" disabled>Terminer l'activité</button>
    </div>
    
    <!-- Bouton plein écran -->
    <div class="fullscreen-btn" id="fullscreenBtn">
        <span class="fullscreen-icon">⛶</span>
    </div>
    
    <!-- Modal de fin d'activité -->
    <div id="completion-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-badge" class="modal-badge">0%</div>
            <div class="modal-header">
                <h2>Activité terminée !</h2>
                <p>Vous avez complété les exercices de calcul de masses molaires.</p>
            </div>
            <div class="modal-body">
                <div class="score-result">
                    <span id="modal-score">0</span>/<span id="modal-total">8</span>
                </div>
                <p class="score-text" id="modal-score-text">Vous avez réussi l'activité.</p>
                
                <div class="exercise-summary" id="exercise-summary">
                    <!-- Les éléments seront générés dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-modal-btn" class="close-modal-btn">Fermer</button>
            </div>
        </div>
    </div>
    
    <script>
        // Variables globales SCORM
        let API = null;
        let API_1484_11 = null;
        const scormVersion = "2004";
        let initialized = false;
        let terminated = false;
        let lastError = "";
        let suspendData = "";
        let entryStatus = "ab-initio";
        let sessionStartTime = Date.now();
        let totalTime = 0;
        let lastTimeUpdate = sessionStartTime;
        let timeInterval = null;
        
        // Variables globales de l'application
        let score = 0;
        const totalExercises = 8;
        let solved = new Set();
        let answered = new Set();
        let testCompleted = false;
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser le SCORM
            initSCORM();
            
            // Initialiser le tableau périodique
            initPeriodicTable();
            
            // Initialiser les exercices
            initPeriodicExercises();
            
            // Initialiser le bouton de fin d'activité
            document.getElementById('finishBtn').addEventListener('click', finishActivity);
            
            // Initialiser le bouton plein écran
            initFullscreenButton();
            
            // Démarrer le suivi du temps
            startTimeTracking();
        });
        
        // Initialisation SCORM
        function initSCORM() {
            if (initialized) return true;
            
            // Trouver l'API SCORM 2004
            API_1484_11 = findAPI(window);
            
            if (!API_1484_11) {
                console.log("SCORM API non trouvée - Mode autonome activé");
                return false;
            }
            
            // Initialiser la communication
            let result = API_1484_11.Initialize("");
            
            if (result === "true" || result === true) {
                console.log("SCORM API initialisée avec succès");
                initialized = true;
                
                // Récupérer l'état précédent si disponible
                entryStatus = getValue("cmi.entry");
                suspendData = getValue("cmi.suspend_data");
                
                // Récupérer les données sauvegardées si elles existent
                if (suspendData) {
                    try {
                        restoreState(suspendData);
                    } catch (e) {
                        console.error("Erreur lors de la restauration des données:", e);
                    }
                }
                
                return true;
            } else {
                console.error("Échec de l'initialisation SCORM");
                getLastError();
                return false;
            }
        }
        
        // Trouver l'API SCORM
        function findAPI(win) {
            if (win.API_1484_11) return win.API_1484_11;
            
            let findAPITries = 0;
            while (win.parent && win.parent != win && findAPITries < 10) {
                findAPITries++;
                win = win.parent;
                if (win.API_1484_11) return win.API_1484_11;
            }
            
            let frames = win.frames;
            for (let i = 0; i < frames.length; i++) {
                let api = findAPI(frames[i]);
                if (api) return api;
            }
            
            return null;
        }
        
        // Obtenir une valeur SCORM
        function getValue(parameter) {
            if (!initialized || !API_1484_11) return "";
            
            let value = API_1484_11.GetValue(parameter);
            if (value === "") getLastError();
            
            return value;
        }
        
        // Définir une valeur SCORM
        function setValue(parameter, value) {
            if (!initialized || !API_1484_11) return false;
            
            let result = API_1484_11.SetValue(parameter, value);
            if (result === "false" || result === false) {
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Faire un commit SCORM
        function commitSCORM() {
            if (!initialized || !API_1484_11) return false;
            
            let result = API_1484_11.Commit("");
            if (result === "false" || result === false) {
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Terminer la session SCORM
        function terminateSCORM() {
            if (terminated || !initialized || !API_1484_11) return false;
            
            // Mettre à jour le temps total
            updateSessionTime();
            
            let result = API_1484_11.Terminate("");
            if (result === "false" || result === false) {
                getLastError();
                return false;
            }
            
            terminated = true;
            return true;
        }
        
        // Récupérer la dernière erreur SCORM
        function getLastError() {
            if (!API_1484_11) return "";
            
            let errorCode = API_1484_11.GetLastError();
            let errorString = API_1484_11.GetErrorString(errorCode);
            let errorDiagnostic = API_1484_11.GetDiagnostic(errorCode);
            
            lastError = `Code: ${errorCode} - ${errorString} - ${errorDiagnostic}`;
            console.error("Erreur SCORM:", lastError);
            
            return lastError;
        }
        
        // Sauvegarder l'état de l'application
        function saveState() {
            if (!initialized) return;
            
            // Créer un objet avec toutes les données à sauvegarder
            const stateData = {
                score: score,
                solved: Array.from(solved),
                answered: Array.from(answered),
                testCompleted: testCompleted
            };
            
            // Convertir en JSON
            suspendData = JSON.stringify(stateData);
            
            // Sauvegarder dans SCORM
            setValue("cmi.suspend_data", suspendData);
            
            // Sauvegarder le score actuel
            saveScore();
            
            // Sauvegarder l'état de progression
            saveProgress();
            
            // Commit immédiat pour assurer la persistance des données
            commitSCORM();
            
            console.log("État sauvegardé avec succès");
        }
        
        // Restaurer l'état sauvegardé
        function restoreState(stateJson) {
            try {
                const stateData = JSON.parse(stateJson);
                
                // Restaurer le score
                score = stateData.score || 0;
                document.getElementById('score').textContent = score;
                
                // Restaurer les exercices résolus
                solved = new Set(stateData.solved || []);
                
                // Restaurer les exercices répondus
                answered = new Set(stateData.answered || []);
                
                // Restaurer l'état de complétion du test
                testCompleted = stateData.testCompleted || false;
                
                // Mettre à jour l'interface utilisateur
                updateUI();
                
                console.log("État restauré avec succès");
            } catch (e) {
                console.error("Erreur lors de la restauration de l'état:", e);
            }
        }
        
        // Sauvegarder le score
        function saveScore() {
            if (!initialized) return;
            
            // Calculer le score sur 100
            const scorePercent = (score / totalExercises) * 100;
            
            // Sauvegarder le score
            setValue("cmi.score.raw", scorePercent);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", (scorePercent / 100).toString());
        }
        
        // Sauvegarder l'état de progression
        function saveProgress() {
            if (!initialized) return;
            
            // Définir l'état de progression
            if (testCompleted) {
                setValue("cmi.completion_status", "completed");
                setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
            } else {
                setValue("cmi.completion_status", "incomplete");
                setValue("cmi.success_status", "unknown");
            }
        }
        
        // Suivre le temps de session
        function startTimeTracking() {
            sessionStartTime = Date.now();
            lastTimeUpdate = sessionStartTime;
            
            // Mise à jour toutes les 60 secondes
            timeInterval = setInterval(updateSessionTime, 60000);
            
            // S'assurer que le temps est mis à jour avant de quitter la page
            window.addEventListener('beforeunload', function() {
                updateSessionTime();
                saveState();
                terminateSCORM();
            });
        }
        
        // Mettre à jour le temps de session
        function updateSessionTime() {
            if (!initialized) return;
            
            const now = Date.now();
            const sessionDuration = now - lastTimeUpdate;
            lastTimeUpdate = now;
            
            // Ajouter au temps total
            totalTime += sessionDuration;
            
            // Convertir en format SCORM (PT0H0M0S)
            const totalSeconds = Math.floor(totalTime / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const timeStr = `PT${hours}H${minutes}M${seconds}S`;
            
            // Sauvegarder dans SCORM
            setValue("cmi.session_time", timeStr);
        }
        
        // Définition des éléments chimiques (périodes 1-5)
        const periodicElements = [
            // Période 1
            { symbol: "H", name: "Hydrogène", Z: 1, A: 1, type: "nonmetal", group: 1, period: 1 },
            { symbol: "He", name: "Hélium", Z: 2, A: 4, type: "noble-gas", group: 18, period: 1 },
            
            // Période 2
            { symbol: "Li", name: "Lithium", Z: 3, A: 7, type: "alkali", group: 1, period: 2 },
            { symbol: "Be", name: "Béryllium", Z: 4, A: 9, type: "alkaline-earth", group: 2, period: 2 },
            { symbol: "B", name: "Bore", Z: 5, A: 11, type: "metalloid", group: 13, period: 2 },
            { symbol: "C", name: "Carbone", Z: 6, A: 12, type: "nonmetal", group: 14, period: 2 },
            { symbol: "N", name: "Azote", Z: 7, A: 14, type: "nonmetal", group: 15, period: 2 },
            { symbol: "O", name: "Oxygène", Z: 8, A: 16, type: "nonmetal", group: 16, period: 2 },
            { symbol: "F", name: "Fluor", Z: 9, A: 19, type: "nonmetal", group: 17, period: 2 },
            { symbol: "Ne", name: "Néon", Z: 10, A: 20, type: "noble-gas", group: 18, period: 2 },
            
            // Période 3
            { symbol: "Na", name: "Sodium", Z: 11, A: 23, type: "alkali", group: 1, period: 3 },
            { symbol: "Mg", name: "Magnésium", Z: 12, A: 24, type: "alkaline-earth", group: 2, period: 3 },
            { symbol: "Al", name: "Aluminium", Z: 13, A: 27, type: "post-transition", group: 13, period: 3 },
            { symbol: "Si", name: "Silicium", Z: 14, A: 28, type: "metalloid", group: 14, period: 3 },
            { symbol: "P", name: "Phosphore", Z: 15, A: 31, type: "nonmetal", group: 15, period: 3 },
            { symbol: "S", name: "Soufre", Z: 16, A: 32, type: "nonmetal", group: 16, period: 3 },
            { symbol: "Cl", name: "Chlore", Z: 17, A: 35, type: "nonmetal", group: 17, period: 3 },
            { symbol: "Ar", name: "Argon", Z: 18, A: 40, type: "noble-gas", group: 18, period: 3 },
            
            // Période 4
            { symbol: "K", name: "Potassium", Z: 19, A: 39, type: "alkali", group: 1, period: 4 },
            { symbol: "Ca", name: "Calcium", Z: 20, A: 40, type: "alkaline-earth", group: 2, period: 4 },
            { symbol: "Sc", name: "Scandium", Z: 21, A: 45, type: "transition", group: 3, period: 4 },
            { symbol: "Ti", name: "Titane", Z: 22, A: 48, type: "transition", group: 4, period: 4 },
            { symbol: "V", name: "Vanadium", Z: 23, A: 51, type: "transition", group: 5, period: 4 },
            { symbol: "Cr", name: "Chrome", Z: 24, A: 52, type: "transition", group: 6, period: 4 },
            { symbol: "Mn", name: "Manganèse", Z: 25, A: 55, type: "transition", group: 7, period: 4 },
            { symbol: "Fe", name: "Fer", Z: 26, A: 56, type: "transition", group: 8, period: 4 },
            { symbol: "Co", name: "Cobalt", Z: 27, A: 59, type: "transition", group: 9, period: 4 },
            { symbol: "Ni", name: "Nickel", Z: 28, A: 59, type: "transition", group: 10, period: 4 },
            { symbol: "Cu", name: "Cuivre", Z: 29, A: 64, type: "transition", group: 11, period: 4 },
            { symbol: "Zn", name: "Zinc", Z: 30, A: 65, type: "transition", group: 12, period: 4 },
            { symbol: "Ga", name: "Gallium", Z: 31, A: 70, type: "post-transition", group: 13, period: 4 },
            { symbol: "Ge", name: "Germanium", Z: 32, A: 73, type: "metalloid", group: 14, period: 4 },
            { symbol: "As", name: "Arsenic", Z: 33, A: 75, type: "metalloid", group: 15, period: 4 },
            { symbol: "Se", name: "Sélénium", Z: 34, A: 79, type: "nonmetal", group: 16, period: 4 },
            { symbol: "Br", name: "Brome", Z: 35, A: 80, type: "nonmetal", group: 17, period: 4 },
            { symbol: "Kr", name: "Krypton", Z: 36, A: 84, type: "noble-gas", group: 18, period: 4 },
            
            // Période 5
            { symbol: "Rb", name: "Rubidium", Z: 37, A: 85, type: "alkali", group: 1, period: 5 },
            { symbol: "Sr", name: "Strontium", Z: 38, A: 88, type: "alkaline-earth", group: 2, period: 5 },
            { symbol: "Y", name: "Yttrium", Z: 39, A: 89, type: "transition", group: 3, period: 5 },
            { symbol: "Zr", name: "Zirconium", Z: 40, A: 91, type: "transition", group: 4, period: 5 },
            { symbol: "Nb", name: "Niobium", Z: 41, A: 93, type: "transition", group: 5, period: 5 },
            { symbol: "Mo", name: "Molybdène", Z: 42, A: 96, type: "transition", group: 6, period: 5 },
            { symbol: "Tc", name: "Technétium", Z: 43, A: 98, type: "transition", group: 7, period: 5 },
            { symbol: "Ru", name: "Ruthénium", Z: 44, A: 101, type: "transition", group: 8, period: 5 },
            { symbol: "Rh", name: "Rhodium", Z: 45, A: 103, type: "transition", group: 9, period: 5 },
            { symbol: "Pd", name: "Palladium", Z: 46, A: 106, type: "transition", group: 10, period: 5 },
            { symbol: "Ag", name: "Argent", Z: 47, A: 108, type: "transition", group: 11, period: 5 },
            { symbol: "Cd", name: "Cadmium", Z: 48, A: 112, type: "transition", group: 12, period: 5 },
            { symbol: "In", name: "Indium", Z: 49, A: 115, type: "post-transition", group: 13, period: 5 },
            { symbol: "Sn", name: "Étain", Z: 50, A: 119, type: "post-transition", group: 14, period: 5 },
            { symbol: "Sb", name: "Antimoine", Z: 51, A: 122, type: "metalloid", group: 15, period: 5 },
            { symbol: "Te", name: "Tellure", Z: 52, A: 128, type: "metalloid", group: 16, period: 5 },
            { symbol: "I", name: "Iode", Z: 53, A: 127, type: "nonmetal", group: 17, period: 5 },
            { symbol: "Xe", name: "Xénon", Z: 54, A: 131, type: "noble-gas", group: 18, period: 5 }
        ];
        
        // Référence à l'élément sélectionné
        let selectedElementData = null;
        
        // Initialiser le tableau périodique
        function initPeriodicTable() {
            const periodicTable = document.getElementById('periodicTable');
            
            // Vérifier si le tableau existe
            if (!periodicTable) return;
            
            // Effacer le tableau
            periodicTable.innerHTML = '';
            
            // Ajouter les éléments au tableau principal
            for (let period = 1; period <= 5; period++) {
                for (let group = 1; group <= 18; group++) {
                    // Trouver l'élément correspondant
                    const element = periodicElements.find(e => e.group === group && e.period === period);
                    
                    if (element) {
                        const elementDiv = document.createElement('div');
                        elementDiv.className = `element ${element.type}`;
                        elementDiv.id = `element-${element.symbol}`;
                        elementDiv.innerHTML = `
                            <div class="atomic-number">${element.Z}</div>
                            <div class="symbol">${element.symbol}</div>
                            <div class="name">${element.name}</div>
                        `;
                        
                        elementDiv.addEventListener('click', () => {
                            updateSelectedElement(element);
                            
                            // Mettre à jour l'apparence active
                            document.querySelectorAll('.element.active').forEach(el => {
                                el.classList.remove('active');
                            });
                            elementDiv.classList.add('active');
                        });
                        
                        periodicTable.appendChild(elementDiv);
                    } else {
                        // Créer un div vide pour maintenir la structure de la grille
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'empty';
                        periodicTable.appendChild(emptyDiv);
                    }
                }
            }
            
            // Sélectionner l'hydrogène par défaut
            const hydrogenElement = document.getElementById('element-H');
            if (hydrogenElement) {
                hydrogenElement.classList.add('active');
                selectedElementData = periodicElements[0];
                updateSelectedElement(periodicElements[0]);
            }
        }
        
        // Mettre à jour les informations de l'élément sélectionné
        function updateSelectedElement(element) {
            // Mettre à jour les informations de l'élément
            const elementName = document.getElementById('elementName');
            const elementDetails = document.getElementById('elementDetails');
            
            if (elementName && elementDetails) {
                elementName.textContent = element.name;
                
                elementDetails.innerHTML = `
                    <div class="element-detail">Symbole: ${element.symbol}</div>
                    <div class="element-detail">Numéro atomique (Z): ${element.Z}</div>
                    <div class="element-detail">Masse atomique (A): ${element.A}</div>
                    <div class="element-detail">Électrons: ${element.Z}</div>
                    <div class="element-detail">Protons: ${element.Z}</div>
                    <div class="element-detail">Neutrons: ${element.A - element.Z}</div>
                    <div class="element-detail">Type: ${getTypeName(element.type)}</div>
                `;
                
                selectedElementData = element;
            }
        }
        
        // Fonction pour obtenir le nom du type en français
        function getTypeName(type) {
            const typeMap = {
                'alkali': 'Métal alcalin',
                'alkaline-earth': 'Métal alcalino-terreux',
                'transition': 'Métal de transition',
                'post-transition': 'Métal pauvre',
                'metalloid': 'Métalloïde',
                'nonmetal': 'Non-métal',
                'noble-gas': 'Gaz noble'
            };
            
            return typeMap[type] || type;
        }
        
        // Initialiser les exercices
        function initPeriodicExercises() {
            // Initialiser tous les exercices liés au tableau périodique
            document.querySelectorAll('.exercise-card[data-type="periodic"]').forEach(exercise => {
                const exerciseId = exercise.getAttribute('data-exercise');
                const exerciseType = exercise.getAttribute('data-exercise-type');
                
                // Configurer les boutons de vérification
                const checkBtn = exercise.querySelector('.check-btn');
                if (checkBtn) {
                    checkBtn.addEventListener('click', () => {
                        checkPeriodicAnswer(exerciseId, exerciseType);
                    });
                }
                
                // Configurer les champs de réponse pour validation à l'appui sur Entrée
                const answerInput = exercise.querySelector('.answer-input');
                if (answerInput) {
                    answerInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            checkPeriodicAnswer(exerciseId, exerciseType);
                        }
                    });
                }
                
                // Restaurer l'état des exercices résolus
                if (solved.has(parseInt(exerciseId))) {
                    exercise.classList.add('solved');
                    const resultDiv = exercise.querySelector('.result');
                    if (resultDiv) {
                        // Trouver la formule pour afficher l'explication
                        const formula = exercise.getAttribute('data-formula');
                        const correctMolMass = calculateMolecularMass(formula);
                        
                        resultDiv.innerHTML = `<span class="success-icon">✓</span> Correct! La masse molaire de ${formula} est ${correctMolMass.toFixed(2)} g/mol.`;
                        resultDiv.className = 'result correct';
                        resultDiv.style.display = 'block';
                    }
                    
                    // Désactiver l'input et le bouton
                    const input = exercise.querySelector('.answer-input');
                    const button = exercise.querySelector('.check-btn');
                    if (input) input.disabled = true;
                    if (button) button.disabled = true;
                }
            });
            
            // Mettre à jour les badges
            updateBadges();
            
            // Mettre à jour le bouton de fin
            updateFinishButton();
        }
        
        // Fonction pour vérifier les réponses aux exercices
        function checkPeriodicAnswer(exerciseId, exerciseType) {
            const exercise = document.querySelector(`.exercise-card[data-exercise="${exerciseId}"]`);
            const resultDiv = document.getElementById(`result${exerciseId}`);
            const hintDiv = document.getElementById(`hint${exerciseId}`);
            
            if (!exercise || !resultDiv) return;
            
            // Marquer comme répondu
            answered.add(parseInt(exerciseId));
            
            // Mettre à jour le bouton de fin
            updateFinishButton();
            
            let isCorrect = false;
            let explanation = '';
            
            // Vérification des masses molaires moléculaires
            if (exerciseType === 'molecule') {
                const moleculeFormula = exercise.getAttribute('data-formula');
                const molMassInput = exercise.querySelector('.answer-input');
                const userMolMass = parseFloat(molMassInput.value.replace(',', '.'));
                
                // Calculer la masse molaire correcte
                const correctMolMass = calculateMolecularMass(moleculeFormula);
                
                // Tolérance de 2% pour les arrondis
                const tolerance = Math.abs(correctMolMass) * 0.02;
                isCorrect = Math.abs(userMolMass - correctMolMass) <= tolerance;
                
                explanation = `La masse molaire de ${moleculeFormula} est ${correctMolMass.toFixed(2)} g/mol.`;
            }
            
            if (isCorrect) {
                resultDiv.innerHTML = `<span class="success-icon">✓</span> Correct! ${explanation}`;
                resultDiv.className = 'result correct';
                resultDiv.style.display = 'block';
                
                if (hintDiv) hintDiv.style.display = 'none';
                
                // Mettre à jour le score et marquer comme résolu
                if (!solved.has(parseInt(exerciseId))) {
                    incrementScore();
                    markAsSolved(parseInt(exerciseId));
                }
                
                // Désactiver l'input et le bouton
                const input = exercise.querySelector('.answer-input');
                const button = exercise.querySelector('.check-btn');
                if (input) input.disabled = true;
                if (button) button.disabled = true;
            } else {
                resultDiv.innerHTML = `<span class="error-icon">✗</span> Incorrect. ${explanation}`;
                resultDiv.className = 'result incorrect';
                resultDiv.style.display = 'block';
                
                if (hintDiv) hintDiv.style.display = 'block';
            }
            
            // Sauvegarder l'état
            saveState();
        }
        
        // Fonction pour calculer la masse molaire d'une molécule
        function calculateMolecularMass(formula) {
            // Analyser la formule chimique
            const elementCounts = parseChemicalFormula(formula);
            
            // Calculer la masse molaire
            let totalMass = 0;
            
            for (const symbol in elementCounts) {
                const element = periodicElements.find(e => e.symbol === symbol);
                if (element) {
                    totalMass += element.A * elementCounts[symbol];
                }
            }
            
            return totalMass;
        }
        
        // Fonction pour analyser une formule chimique et retourner un objet avec les comptes d'éléments
        function parseChemicalFormula(formula) {
            const elementCounts = {};
            
            // Regex pour identifier les éléments et leurs nombres
            const regex = /([A-Z][a-z]*)([0-9]*)/g;
            let match;
            
            while ((match = regex.exec(formula)) !== null) {
                const symbol = match[1];
                const count = match[2] ? parseInt(match[2]) : 1;
                
                if (elementCounts[symbol]) {
                    elementCounts[symbol] += count;
                } else {
                    elementCounts[symbol] = count;
                }
            }
            
            return elementCounts;
        }
        
        // Incrémenter le score
        function incrementScore() {
            score++;
            document.getElementById('score').textContent = score;
            updateBadges();
        }
        
        // Marquer un exercice comme résolu
        function markAsSolved(exerciseId) {
            solved.add(exerciseId);
            const exercise = document.querySelector(`.exercise-card[data-exercise="${exerciseId}"]`);
            if (exercise) {
                exercise.classList.add('solved');
            }
        }
        
        // Mettre à jour les badges en fonction du score
        function updateBadges() {
            // Badge 1: 2 exercices résolus
            if (score >= 2) {
                document.getElementById('badge1').classList.add('unlocked');
            } else {
                document.getElementById('badge1').classList.remove('unlocked');
            }
            
            // Badge 2: 4 exercices résolus
            if (score >= 4) {
                document.getElementById('badge2').classList.add('unlocked');
            } else {
                document.getElementById('badge2').classList.remove('unlocked');
            }
            
            // Badge 3: 6 exercices résolus
            if (score >= 6) {
                document.getElementById('badge3').classList.add('unlocked');
            } else {
                document.getElementById('badge3').classList.remove('unlocked');
            }
            
            // Badge 4: 8 exercices résolus (tous)
            if (score >= 8) {
                document.getElementById('badge4').classList.add('unlocked');
            } else {
                document.getElementById('badge4').classList.remove('unlocked');
            }
        }
        
        // Mettre à jour l'interface utilisateur
        function updateUI() {
            // Mettre à jour le score affiché
            document.getElementById('score').textContent = score;
            
            // Mettre à jour les badges
            updateBadges();
            
            // Mettre à jour le bouton de fin
            updateFinishButton();
            
            // Si le test est déjà complété, désactiver tous les inputs et boutons
            if (testCompleted) {
                document.querySelectorAll('input, .check-btn, .finish-btn').forEach(el => {
                    el.disabled = true;
                });
            }
        }
        
        // Mettre à jour l'état du bouton de fin
        function updateFinishButton() {
            const finishBtn = document.getElementById('finishBtn');
            if (answered.size >= 1) {
                finishBtn.disabled = false;
            } else {
                finishBtn.disabled = true;
            }
        }
        
        // Terminer l'activité
        function finishActivity() {
            // Vérifier si au moins une question est répondue
            if (answered.size === 0) {
                // Afficher un message d'erreur intégré à l'interface
                const validationMessage = document.getElementById('validation-message');
                validationMessage.style.display = 'block';
                validationMessage.style.backgroundColor = '#f8d7da';
                validationMessage.style.border = '1px solid #f5c6cb';
                validationMessage.style.color = '#721c24';
                validationMessage.textContent = "Vous devez répondre à au moins une question avant de terminer l'activité.";
                
                // Masquer le message après 5 secondes
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                }, 5000);
                return;
            }
            
            // Marquer le test comme terminé
            testCompleted = true;
            
            // SCORM: Marquer comme terminé
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
            setValue("cmi.exit", "normal");
            
            // SCORM: Mettre à jour le temps de session
            updateSessionTime();
            
            // SCORM: Sauvegarder l'état final
            saveState();
            
            // SCORM: Effectuer un commit final
            commitSCORM();
            
            // Désactiver tous les inputs et boutons
            document.querySelectorAll('input, .check-btn, .finish-btn').forEach(el => {
                el.disabled = true;
            });
            
            // Afficher le modal de fin d'activité
            showCompletionModal();
        }
        
        // Afficher le modal de fin d'activité
        function showCompletionModal() {
            // Mettre à jour les données du modal
            document.getElementById('modal-score').textContent = score;
            document.getElementById('modal-total').textContent = totalExercises;
            
            // Calculer le pourcentage
            const percentage = Math.round((score / totalExercises) * 100);
            document.getElementById('modal-badge').textContent = percentage + '%';
            
            // Définir si l'étudiant a réussi ou échoué (seuil à 70%)
            const isPassed = percentage >= 70;
            if (!isPassed) {
                document.getElementById('modal-badge').classList.add('failed');
            }
            
            // Mettre à jour le texte du score
            const scoreText = document.getElementById('modal-score-text');
            if (isPassed) {
                scoreText.textContent = "Félicitations ! Vous avez réussi l'activité.";
            } else {
                scoreText.textContent = "Vous n'avez pas atteint le score minimum requis de 70%.";
            }
            
            // Générer le résumé des exercices
            const summaryContainer = document.getElementById('exercise-summary');
            summaryContainer.innerHTML = '';
            
            for (let i = 0; i < totalExercises; i++) {
                const exerciseNum = i + 1;
                const isCompleted = solved.has(exerciseNum);
                
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                
                // Trouver le titre de l'exercice
                const exerciseTitle = document.querySelector(`.exercise-card[data-exercise="${exerciseNum}"] .question-header span:last-child`).textContent;
                
                exerciseItem.innerHTML = `
                    <div>${exerciseTitle}</div>
                    <div class="exercise-status ${isCompleted ? 'status-completed' : 'status-incomplete'}">
                        ${isCompleted ? 'Réussi' : 'Non réussi'}
                    </div>
                `;
                
                summaryContainer.appendChild(exerciseItem);
            }
            
            // Afficher le modal
            const modal = document.getElementById('completion-modal');
            modal.style.display = 'flex';
            
            // Ajouter l'événement de fermeture au bouton
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Fermer le modal en cliquant en dehors
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Initialiser le bouton plein écran
        function initFullscreenButton() {
            // Initialisation du bouton plein écran
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            function toggleFullscreen() {
                if (!document.fullscreenElement && 
                    !document.mozFullScreenElement && 
                    !document.webkitFullscreenElement && 
                    !document.msFullscreenElement) {
                    // Passer en mode plein écran
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    } else if (document.documentElement.mozRequestFullScreen) {
                        document.documentElement.mozRequestFullScreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                    updateFullscreenButton(true);
                    document.body.classList.add('fullscreen-container');
                } else {
                    // Quitter le mode plein écran
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                    updateFullscreenButton(false);
                    document.body.classList.remove('fullscreen-container');
                }
            }
            
            function updateFullscreenButton(isFullscreen) {
                const iconElement = document.querySelector('.fullscreen-icon');
                if (isFullscreen) {
                    iconElement.textContent = '⛝'; // Icône pour quitter le plein écran
                } else {
                    iconElement.textContent = '⛶'; // Icône pour entrer en plein écran
                }
            }
            
            // Détection des changements de plein écran
            document.addEventListener('fullscreenchange', () => {
                updateFullscreenButton(!!document.fullscreenElement);
            });
            document.addEventListener('webkitfullscreenchange', () => {
                updateFullscreenButton(!!document.webkitFullscreenElement);
            });
            document.addEventListener('mozfullscreenchange', () => {
                updateFullscreenButton(!!document.mozFullScreenElement);
            });
            document.addEventListener('MSFullscreenChange', () => {
                updateFullscreenButton(!!document.msFullscreenElement);
            });
        }
    </script>
</body>
</html>