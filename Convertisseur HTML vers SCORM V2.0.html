<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur HTML vers SCORM pour Moodle - V2.0</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .warning-box h3 {
            margin-bottom: 10px;
        }
        
        .settings-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .setting-group {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .setting-group h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .radio-option:hover {
            background-color: #f8f9fa;
        }
        
        .radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
        }
        
        .radio-option label {
            cursor: pointer;
            flex: 1;
        }
        
        .drop-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .drop-area.highlight {
            background-color: #e3f2fd;
            border-color: #1565c0;
            transform: scale(1.02);
        }
        
        .drop-area h3 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .drop-area p {
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        #file-selector {
            display: none;
        }
        
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .button:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .button.success {
            background-color: #27ae60;
        }
        
        .button.success:hover:not(:disabled) {
            background-color: #229954;
        }
        
        .button.danger {
            background-color: #e74c3c;
        }
        
        .button.danger:hover:not(:disabled) {
            background-color: #c0392b;
        }
        
        .file-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #3498db;
            margin-bottom: 20px;
        }
        
        .file-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .file-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .file-detail span:first-child {
            font-weight: 500;
            color: #495057;
        }
        
        .progress-container {
            width: 100%;
            height: 25px;
            border-radius: 12px;
            background-color: #e9ecef;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }
        
        .validation-results {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .validation-item:last-child {
            border-bottom: none;
        }
        
        .validation-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .validation-icon.success {
            background-color: #27ae60;
        }
        
        .validation-icon.warning {
            background-color: #f39c12;
        }
        
        .validation-icon.error {
            background-color: #e74c3c;
        }
        
        #log-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        #log {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }
        
        .log-entry {
            padding: 3px 0;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .log-time {
            color: #6c757d;
            font-size: 11px;
            flex-shrink: 0;
        }
        
        .log-message {
            flex: 1;
        }
        
        .log-info {
            color: #0056b3;
        }
        
        .log-success {
            color: #155724;
            font-weight: 500;
        }
        
        .log-warning {
            color: #856404;
        }
        
        .log-error {
            color: #721c24;
            font-weight: 500;
        }
        
        .hidden {
            display: none !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .checkbox-group {
            margin-top: 10px;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            margin-bottom: 8px;
        }
        
        .checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .checkbox-option label {
            cursor: pointer;
        }
        
        .input-group {
            margin-top: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Convertisseur HTML vers SCORM - Version 2.0</h1>
        
        <div class="warning-box">
            <h3>‚ö†Ô∏è Important pour Moodle 4.1</h3>
            <ul>
                <li>Ce convertisseur cr√©e des packages SCORM compatibles avec Moodle 4.1+</li>
                <li>Assurez-vous que votre contenu HTML est autonome (CSS et JS int√©gr√©s)</li>
                <li>Les fichiers externes (images, vid√©os) doivent √™tre r√©f√©renc√©s avec des URLs absolues</li>
                <li>Le tracking automatique fonctionne mieux avec des √©l√©ments HTML standards</li>
            </ul>
        </div>
        
        <div class="settings-panel">
            <h3>‚öôÔ∏è Param√®tres de conversion</h3>
            <div class="settings-grid">
                <div class="setting-group">
                    <h4>Version SCORM</h4>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="scorm12" name="scorm-version" value="1.2">
                            <label for="scorm12">SCORM 1.2 (ancienne version)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="scorm2004" name="scorm-version" value="2004" checked>
                            <label for="scorm2004">SCORM 2004 4e √©dition (Recommand√©)</label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h4>Options de tracking</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" id="track-time" checked>
                            <label for="track-time">Suivre le temps pass√©</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="track-interactions" checked>
                            <label for="track-interactions">Suivre les interactions</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="auto-complete">
                            <label for="auto-complete">Compl√©tion automatique au chargement</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="debug-mode">
                            <label for="debug-mode">Mode debug (console logs)</label>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h4>M√©tadonn√©es du cours</h4>
                    <div class="input-group">
                        <label for="course-title">Titre du cours</label>
                        <input type="text" id="course-title" placeholder="Titre de votre cours SCORM">
                    </div>
                    <div class="input-group">
                        <label for="mastery-score">Score de r√©ussite (%)</label>
                        <input type="number" id="mastery-score" value="80" min="0" max="100">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="drop-area" class="drop-area">
            <h3>üìÅ Zone de d√©p√¥t</h3>
            <p>Glissez et d√©posez votre fichier HTML ici</p>
            <button class="button" id="file-select-button">Ou cliquez pour s√©lectionner</button>
            <input type="file" id="file-selector" accept=".html,.htm">
        </div>
        
        <div id="file-info" class="file-info hidden">
            <h3>üìÑ Fichier s√©lectionn√©</h3>
            <div class="file-details">
                <div class="file-detail">
                    <span>Nom:</span>
                    <span id="file-name"></span>
                </div>
                <div class="file-detail">
                    <span>Taille:</span>
                    <span id="file-size"></span>
                </div>
                <div class="file-detail">
                    <span>Type:</span>
                    <span id="file-type"></span>
                </div>
                <div class="file-detail">
                    <span>Derni√®re modification:</span>
                    <span id="file-modified"></span>
                </div>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
        </div>
        
        <div id="validation-results" class="validation-results hidden">
            <h3>‚úÖ Validation du contenu</h3>
            <div id="validation-list"></div>
        </div>
        
        <div id="log-container" class="hidden">
            <h3>üìã Journal d'activit√©</h3>
            <div id="log"></div>
        </div>
        
        <div id="action-buttons" class="action-buttons hidden">
            <button id="convert-button" class="button success" disabled>
                üîÑ Convertir en SCORM
            </button>
            <button id="download-button" class="button" disabled>
                üíæ T√©l√©charger le package
            </button>
            <button id="reset-button" class="button danger">
                üîÑ R√©initialiser
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Configuration et constantes
        const CONFIG = {
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50 MB
            ALLOWED_EXTENSIONS: ['.html', '.htm'],
            DEFAULT_MASTERY_SCORE: 80,
            DEBUG: false
        };
        
        // √âtat de l'application
        const state = {
            file: null,
            content: '',
            package: null,
            version: '2004',
            options: {
                trackTime: true,
                trackInteractions: true,
                autoComplete: false,
                debugMode: false
            },
            metadata: {
                title: '',
                masteryScore: 80
            },
            validationResults: []
        };
        
        // √âl√©ments du DOM
        const elements = {
            dropArea: document.getElementById('drop-area'),
            fileSelector: document.getElementById('file-selector'),
            fileSelectButton: document.getElementById('file-select-button'),
            fileInfo: document.getElementById('file-info'),
            fileName: document.getElementById('file-name'),
            fileSize: document.getElementById('file-size'),
            fileType: document.getElementById('file-type'),
            fileModified: document.getElementById('file-modified'),
            progressBar: document.getElementById('progress-bar'),
            validationResults: document.getElementById('validation-results'),
            validationList: document.getElementById('validation-list'),
            logContainer: document.getElementById('log-container'),
            log: document.getElementById('log'),
            actionButtons: document.getElementById('action-buttons'),
            convertButton: document.getElementById('convert-button'),
            downloadButton: document.getElementById('download-button'),
            resetButton: document.getElementById('reset-button'),
            courseTitle: document.getElementById('course-title'),
            masteryScore: document.getElementById('mastery-score'),
            trackTime: document.getElementById('track-time'),
            trackInteractions: document.getElementById('track-interactions'),
            autoComplete: document.getElementById('auto-complete'),
            debugMode: document.getElementById('debug-mode')
        };
        
        // Initialisation
        function init() {
            setupEventListeners();
            loadSettings();
            addLog('Convertisseur SCORM V2.0 initialis√©', 'info');
        }
        
        // Configuration des √©couteurs d'√©v√©nements
        function setupEventListeners() {
            // Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                elements.dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                elements.dropArea.addEventListener(eventName, () => {
                    elements.dropArea.classList.add('highlight');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                elements.dropArea.addEventListener(eventName, () => {
                    elements.dropArea.classList.remove('highlight');
                }, false);
            });
            
            elements.dropArea.addEventListener('drop', handleDrop);
            
            // S√©lection de fichier
            elements.fileSelectButton.addEventListener('click', () => {
                elements.fileSelector.click();
            });
            
            elements.fileSelector.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFiles(e.target.files);
                }
            });
            
            // Version SCORM
            document.querySelectorAll('input[name="scorm-version"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    state.version = this.value;
                    addLog(`Version SCORM chang√©e : ${state.version}`, 'info');
                    saveSettings();
                });
            });
            
            // Options
            elements.trackTime.addEventListener('change', function() {
                state.options.trackTime = this.checked;
                saveSettings();
            });
            
            elements.trackInteractions.addEventListener('change', function() {
                state.options.trackInteractions = this.checked;
                saveSettings();
            });
            
            elements.autoComplete.addEventListener('change', function() {
                state.options.autoComplete = this.checked;
                saveSettings();
            });
            
            elements.debugMode.addEventListener('change', function() {
                state.options.debugMode = this.checked;
                CONFIG.DEBUG = this.checked;
                saveSettings();
            });
            
            // M√©tadonn√©es
            elements.courseTitle.addEventListener('input', function() {
                state.metadata.title = this.value;
                saveSettings();
            });
            
            elements.masteryScore.addEventListener('input', function() {
                state.metadata.masteryScore = parseInt(this.value) || 80;
                saveSettings();
            });
            
            // Boutons d'action
            elements.convertButton.addEventListener('click', convertToSCORM);
            elements.downloadButton.addEventListener('click', downloadSCORM);
            elements.resetButton.addEventListener('click', reset);
        }
        
        // Emp√™cher les comportements par d√©faut
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Gestion du drop
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        // Traitement des fichiers
        function handleFiles(files) {
            const file = files[0];
            
            // Validation
            if (!validateFile(file)) {
                return;
            }
            
            state.file = file;
            
            // Mise √† jour de l'interface
            displayFileInfo(file);
            showElements(['file-info', 'log-container', 'action-buttons']);
            
            // Lecture du fichier
            readFile(file);
        }
        
        // Validation du fichier
        function validateFile(file) {
            const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!CONFIG.ALLOWED_EXTENSIONS.includes(extension)) {
                addLog(`Erreur : Le fichier doit √™tre au format HTML (${CONFIG.ALLOWED_EXTENSIONS.join(', ')})`, 'error');
                return false;
            }
            
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                addLog(`Erreur : Le fichier est trop volumineux (max ${formatFileSize(CONFIG.MAX_FILE_SIZE)})`, 'error');
                return false;
            }
            
            return true;
        }
        
        // Affichage des informations du fichier
        function displayFileInfo(file) {
            elements.fileName.textContent = file.name;
            elements.fileSize.textContent = formatFileSize(file.size);
            elements.fileType.textContent = file.type || 'text/html';
            elements.fileModified.textContent = new Date(file.lastModified).toLocaleString('fr-FR');
            
            // Mettre √† jour le titre du cours si vide
            if (!elements.courseTitle.value) {
                const title = file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
                elements.courseTitle.value = title;
                state.metadata.title = title;
            }
        }
        
        // Lecture du fichier
        function readFile(file) {
            const reader = new FileReader();
            
            reader.onprogress = (event) => {
                if (event.lengthComputable) {
                    updateProgress((event.loaded / event.total) * 100);
                }
            };
            
            reader.onload = (event) => {
                state.content = event.target.result;
                updateProgress(100);
                addLog(`Fichier "${file.name}" charg√© avec succ√®s`, 'success');
                
                // Valider le contenu HTML
                validateHTMLContent(state.content);
                
                // Activer le bouton de conversion
                elements.convertButton.disabled = false;
            };
            
            reader.onerror = () => {
                addLog('Erreur lors de la lecture du fichier', 'error');
                updateProgress(0);
            };
            
            reader.readAsText(file);
        }
        
        // Validation du contenu HTML
        function validateHTMLContent(html) {
            const results = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // V√©rifier la structure de base
            results.push({
                type: doc.documentElement ? 'success' : 'error',
                message: 'Structure HTML valide'
            });
            
            // V√©rifier le titre
            const title = doc.querySelector('title');
            results.push({
                type: title && title.textContent ? 'success' : 'warning',
                message: title ? 'Titre de page pr√©sent' : 'Titre de page manquant'
            });
            
            // V√©rifier l'encodage
            const charset = doc.querySelector('meta[charset]');
            results.push({
                type: charset ? 'success' : 'warning',
                message: charset ? 'Encodage UTF-8 d√©fini' : 'Encodage non sp√©cifi√©'
            });
            
            // V√©rifier les scripts externes
            const externalScripts = doc.querySelectorAll('script[src]');
            const hasExternalScripts = externalScripts.length > 0;
            results.push({
                type: hasExternalScripts ? 'warning' : 'success',
                message: hasExternalScripts ? 
                    `${externalScripts.length} script(s) externe(s) d√©tect√©(s)` : 
                    'Aucun script externe (recommand√©)'
            });
            
            // V√©rifier les liens externes
            const externalLinks = doc.querySelectorAll('link[href^="http"], link[href^="//"]');
            const hasExternalLinks = externalLinks.length > 0;
            results.push({
                type: hasExternalLinks ? 'warning' : 'success',
                message: hasExternalLinks ? 
                    `${externalLinks.length} lien(s) externe(s) d√©tect√©(s)` : 
                    'Aucun lien externe'
            });
            
            // V√©rifier les √©l√©ments interactifs
            const interactiveElements = doc.querySelectorAll('input, select, textarea, button, a[href], [onclick]');
            results.push({
                type: interactiveElements.length > 0 ? 'success' : 'info',
                message: `${interactiveElements.length} √©l√©ment(s) interactif(s) trouv√©(s)`
            });
            
            // Afficher les r√©sultats
            displayValidationResults(results);
            state.validationResults = results;
        }
        
        // Affichage des r√©sultats de validation
        function displayValidationResults(results) {
            elements.validationList.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'validation-item';
                
                const icon = document.createElement('div');
                icon.className = `validation-icon ${result.type}`;
                icon.textContent = result.type === 'success' ? '‚úì' : 
                                  result.type === 'warning' ? '!' : 
                                  result.type === 'error' ? '‚úó' : 'i';
                
                const message = document.createElement('span');
                message.textContent = result.message;
                
                item.appendChild(icon);
                item.appendChild(message);
                elements.validationList.appendChild(item);
            });
            
            elements.validationResults.classList.remove('hidden');
        }
        
        // Conversion en SCORM
        async function convertToSCORM() {
            try {
                addLog('D√©but de la conversion SCORM...', 'info');
                elements.convertButton.disabled = true;
                
                const zip = new JSZip();
                
                // 1. Cr√©er le manifest
                addLog('Cr√©ation du manifest SCORM...', 'info');
                const manifest = createManifest();
                zip.file('imsmanifest.xml', manifest);
                
                // 2. Ajouter les sch√©mas XSD (simplifi√©s)
                addLog('Ajout des sch√©mas XSD...', 'info');
                addSchemas(zip);
                
                // 3. Modifier et ajouter le HTML principal
                addLog('Modification du contenu HTML...', 'info');
                const modifiedHTML = modifyHTML(state.content);
                zip.file('index.html', modifiedHTML);
                
                // 4. Cr√©er l'API SCORM
                addLog('Cr√©ation de l\'API SCORM...', 'info');
                const scormAPI = createSCORMAPI();
                zip.file('scormAPI.js', scormAPI);
                
                // 5. Cr√©er le wrapper SCORM
                addLog('Cr√©ation du wrapper SCORM...', 'info');
                const wrapper = createSCORMWrapper();
                zip.file('scormWrapper.js', wrapper);
                
                // 6. G√©n√©rer le package
                addLog('G√©n√©ration du package ZIP...', 'info');
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                state.package = content;
                addLog('Package SCORM cr√©√© avec succ√®s !', 'success');
                
                elements.downloadButton.disabled = false;
                elements.convertButton.disabled = false;
                
            } catch (error) {
                addLog(`Erreur lors de la conversion : ${error.message}`, 'error');
                console.error(error);
                elements.convertButton.disabled = false;
            }
        }
        
        // Cr√©er le manifest SCORM
        function createManifest() {
            const title = state.metadata.title || 'Contenu SCORM';
            const identifier = `SCORM_${Date.now()}`;
            
            if (state.version === '1.2') {
                return `<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="${identifier}" version="1.0"
          xmlns="http://www.imsproject.org/xsd/imscp_rootv1p1p2"
          xmlns:adlcp="http://www.adlnet.org/xsd/adlcp_rootv1p2"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.imsproject.org/xsd/imscp_rootv1p1p2 imscp_rootv1p1p2.xsd
                              http://www.adlnet.org/xsd/adlcp_rootv1p2 adlcp_rootv1p2.xsd">
    <metadata>
        <schema>ADL SCORM</schema>
        <schemaversion>1.2</schemaversion>
    </metadata>
    <organizations default="ORG1">
        <organization identifier="ORG1">
            <title>${escapeXML(title)}</title>
            <item identifier="ITEM1" identifierref="RES1">
                <title>${escapeXML(title)}</title>
                <adlcp:masteryscore>${state.metadata.masteryScore}</adlcp:masteryscore>
            </item>
        </organization>
    </organizations>
    <resources>
        <resource identifier="RES1" type="webcontent" adlcp:scormtype="sco" href="index.html">
            <file href="index.html"/>
            <file href="scormAPI.js"/>
            <file href="scormWrapper.js"/>
        </resource>
    </resources>
</manifest>`;
            } else {
                return `<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="${identifier}" version="1.3"
          xmlns="http://www.imsglobal.org/xsd/imscp_v1p1"
          xmlns:adlcp="http://www.adlnet.org/xsd/adlcp_v1p3"
          xmlns:adlseq="http://www.adlnet.org/xsd/adlseq_v1p3"
          xmlns:adlnav="http://www.adlnet.org/xsd/adlnav_v1p3"
          xmlns:imsss="http://www.imsglobal.org/xsd/imsss"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.imsglobal.org/xsd/imscp_v1p1 imscp_v1p1.xsd
                              http://www.adlnet.org/xsd/adlcp_v1p3 adlcp_v1p3.xsd
                              http://www.adlnet.org/xsd/adlseq_v1p3 adlseq_v1p3.xsd
                              http://www.adlnet.org/xsd/adlnav_v1p3 adlnav_v1p3.xsd
                              http://www.imsglobal.org/xsd/imsss imsss_v1p0.xsd">
    <metadata>
        <schema>ADL SCORM</schema>
        <schemaversion>2004 4th Edition</schemaversion>
    </metadata>
    <organizations default="ORG1">
        <organization identifier="ORG1">
            <title>${escapeXML(title)}</title>
            <item identifier="ITEM1" identifierref="RES1">
                <title>${escapeXML(title)}</title>
                <imsss:sequencing>
                    <imsss:objectives>
                        <imsss:primaryObjective objectiveID="OBJ1" satisfiedByMeasure="true">
                            <imsss:minNormalizedMeasure>${state.metadata.masteryScore / 100}</imsss:minNormalizedMeasure>
                        </imsss:primaryObjective>
                    </imsss:objectives>
                    <imsss:deliveryControls completionSetByContent="true" objectiveSetByContent="true"/>
                </imsss:sequencing>
            </item>
        </organization>
    </organizations>
    <resources>
        <resource identifier="RES1" type="webcontent" adlcp:scormType="sco" href="index.html">
            <file href="index.html"/>
            <file href="scormAPI.js"/>
            <file href="scormWrapper.js"/>
        </resource>
    </resources>
</manifest>`;
            }
        }
        
        // Ajouter les sch√©mas XSD
        function addSchemas(zip) {
            // Sch√©mas simplifi√©s pour √©viter les erreurs de validation
            const schemas = {
                'imscp_rootv1p1p2.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>',
                'adlcp_rootv1p2.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>',
                'imscp_v1p1.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>',
                'adlcp_v1p3.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>',
                'adlseq_v1p3.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>',
                'adlnav_v1p3.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>',
                'imsss_v1p0.xsd': '<?xml version="1.0"?><xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"/>'
            };
            
            Object.entries(schemas).forEach(([filename, content]) => {
                zip.file(filename, content);
            });
        }
        
        // Modifier le HTML
        function modifyHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Ajouter les scripts SCORM
            const scormAPIScript = doc.createElement('script');
            scormAPIScript.src = 'scormAPI.js';
            doc.head.appendChild(scormAPIScript);
            
            const scormWrapperScript = doc.createElement('script');
            scormWrapperScript.src = 'scormWrapper.js';
            doc.head.appendChild(scormWrapperScript);
            
            // Ajouter l'initialisation SCORM
            const initScript = doc.createElement('script');
            initScript.textContent = `
                window.addEventListener('load', function() {
                    if (typeof initializeSCORM === 'function') {
                        initializeSCORM();
                    }
                });
                
                window.addEventListener('beforeunload', function() {
                    if (typeof terminateSCORM === 'function') {
                        terminateSCORM();
                    }
                });
            `;
            doc.body.appendChild(initScript);
            
            // Retourner le HTML modifi√©
            return '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        }
        
        // Cr√©er l'API SCORM
        function createSCORMAPI() {
            return `/**
 * API SCORM universelle compatible Moodle 4.1
 * Version: 2.0
 * Support: SCORM 1.2 et SCORM 2004
 */

(function(window) {
    'use strict';
    
    // Configuration
    const CONFIG = {
        debug: ${state.options.debugMode},
        version: '${state.version}',
        findAPIAttempts: 20,
        findAPIDelay: 200,
        exitPageWarning: false
    };
    
    // √âtat de l'API
    const STATE = {
        initialized: false,
        terminated: false,
        lastError: '0',
        startTime: null,
        api: null
    };
    
    // Logging
    function log(message, level = 'info') {
        if (!CONFIG.debug) return;
        const timestamp = new Date().toISOString();
        const prefix = '[SCORM API]';
        switch(level) {
            case 'error':
                console.error(\`\${prefix} \${timestamp} - \${message}\`);
                break;
            case 'warn':
                console.warn(\`\${prefix} \${timestamp} - \${message}\`);
                break;
            default:
                console.log(\`\${prefix} \${timestamp} - \${message}\`);
        }
    }
    
    // Recherche de l'API SCORM
    function findAPI(win) {
        if (!win) return null;
        
        const apiNames = CONFIG.version === '1.2' ? ['API'] : ['API_1484_11'];
        let api = null;
        let attempts = 0;
        
        while (!api && win && attempts < CONFIG.findAPIAttempts) {
            for (let apiName of apiNames) {
                if (win[apiName]) {
                    api = win[apiName];
                    log(\`API trouv√©e: \${apiName}\`);
                    break;
                }
            }
            
            if (!api && win.parent && win.parent !== win) {
                win = win.parent;
            } else if (!api && win.opener) {
                win = win.opener;
            } else {
                break;
            }
            
            attempts++;
        }
        
        return api;
    }
    
    // Wrapper pour les appels API
    function apiCall(method, ...args) {
        if (!STATE.api) {
            log('API non disponible', 'error');
            return CONFIG.version === '1.2' ? 'false' : false;
        }
        
        try {
            const result = STATE.api[method](...args);
            const error = getLastError();
            
            if (error !== '0' && error !== 0) {
                log(\`Erreur API \${method}: \${error} - \${getErrorString(error)}\`, 'error');
            } else {
                log(\`\${method}(\${args.join(', ')}) = \${result}\`);
            }
            
            return result;
        } catch (e) {
            log(\`Exception API \${method}: \${e.message}\`, 'error');
            return CONFIG.version === '1.2' ? 'false' : false;
        }
    }
    
    // Obtenir la derni√®re erreur
    function getLastError() {
        if (!STATE.api) return '301';
        
        const method = CONFIG.version === '1.2' ? 'LMSGetLastError' : 'GetLastError';
        try {
            return STATE.api[method]();
        } catch (e) {
            return '301';
        }
    }
    
    // Obtenir la description de l'erreur
    function getErrorString(errorCode) {
        if (!STATE.api) return 'API non disponible';
        
        const method = CONFIG.version === '1.2' ? 'LMSGetErrorString' : 'GetErrorString';
        try {
            return STATE.api[method](errorCode);
        } catch (e) {
            return 'Erreur inconnue';
        }
    }
    
    // Obtenir le diagnostic de l'erreur
    function getErrorDiagnostic(errorCode) {
        if (!STATE.api) return '';
        
        const method = CONFIG.version === '1.2' ? 'LMSGetDiagnostic' : 'GetDiagnostic';
        try {
            return STATE.api[method](errorCode);
        } catch (e) {
            return '';
        }
    }
    
    // Initialisation
    function initialize() {
        if (STATE.initialized) {
            log('D√©j√† initialis√©', 'warn');
            return CONFIG.version === '1.2' ? 'true' : true;
        }
        
        // Rechercher l'API
        STATE.api = findAPI(window);
        
        if (!STATE.api) {
            log('API SCORM introuvable', 'error');
            return CONFIG.version === '1.2' ? 'false' : false;
        }
        
        // Appeler Initialize
        const method = CONFIG.version === '1.2' ? 'LMSInitialize' : 'Initialize';
        const result = apiCall(method, '');
        
        if (result === 'true' || result === true) {
            STATE.initialized = true;
            STATE.startTime = new Date();
            log('Initialisation r√©ussie');
            
            // D√©finir le statut initial si n√©cessaire
            const status = getValue(CONFIG.version === '1.2' ? 'cmi.core.lesson_status' : 'cmi.completion_status');
            if (!status || status === 'not attempted') {
                setValue(CONFIG.version === '1.2' ? 'cmi.core.lesson_status' : 'cmi.completion_status', 
                        CONFIG.version === '1.2' ? 'incomplete' : 'incomplete');
            }
            
            return CONFIG.version === '1.2' ? 'true' : true;
        }
        
        return CONFIG.version === '1.2' ? 'false' : false;
    }
    
    // Terminer
    function terminate() {
        if (!STATE.initialized || STATE.terminated) {
            log('Pas initialis√© ou d√©j√† termin√©', 'warn');
            return CONFIG.version === '1.2' ? 'false' : false;
        }
        
        // Sauvegarder le temps de session si demand√©
        if (${state.options.trackTime} && STATE.startTime) {
            const sessionTime = calculateSessionTime();
            setValue(CONFIG.version === '1.2' ? 'cmi.core.session_time' : 'cmi.session_time', sessionTime);
        }
        
        // Commit final
        commit();
        
        // Appeler Terminate/Finish
        const method = CONFIG.version === '1.2' ? 'LMSFinish' : 'Terminate';
        const result = apiCall(method, '');
        
        if (result === 'true' || result === true) {
            STATE.terminated = true;
            STATE.initialized = false;
            log('Terminaison r√©ussie');
        }
        
        return result;
    }
    
    // Obtenir une valeur
    function getValue(element) {
        if (!STATE.initialized) {
            log('Non initialis√©', 'error');
            return '';
        }
        
        const method = CONFIG.version === '1.2' ? 'LMSGetValue' : 'GetValue';
        return apiCall(method, element);
    }
    
    // D√©finir une valeur
    function setValue(element, value) {
        if (!STATE.initialized) {
            log('Non initialis√©', 'error');
            return CONFIG.version === '1.2' ? 'false' : false;
        }
        
        const method = CONFIG.version === '1.2' ? 'LMSSetValue' : 'SetValue';
        return apiCall(method, element, String(value));
    }
    
    // Commit
    function commit() {
        if (!STATE.initialized) {
            log('Non initialis√©', 'error');
            return CONFIG.version === '1.2' ? 'false' : false;
        }
        
        const method = CONFIG.version === '1.2' ? 'LMSCommit' : 'Commit';
        return apiCall(method, '');
    }
    
    // Calculer le temps de session
    function calculateSessionTime() {
        if (!STATE.startTime) return '00:00:00';
        
        const now = new Date();
        const diff = now - STATE.startTime;
        
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        if (CONFIG.version === '1.2') {
            // Format SCORM 1.2: HHHH:MM:SS.SS
            return \`\${hours.toString().padStart(4, '0')}:\${minutes.toString().padStart(2, '0')}:\${seconds.toString().padStart(2, '0')}.00\`;
        } else {
            // Format SCORM 2004: PT#H#M#S
            return \`PT\${hours}H\${minutes}M\${seconds}S\`;
        }
    }
    
    // API publique
    window.SCORM = {
        // M√©thodes principales
        initialize: initialize,
        terminate: terminate,
        getValue: getValue,
        setValue: setValue,
        commit: commit,
        
        // M√©thodes d'erreur
        getLastError: getLastError,
        getErrorString: getErrorString,
        getErrorDiagnostic: getErrorDiagnostic,
        
        // √âtat
        isInitialized: () => STATE.initialized,
        isTerminated: () => STATE.terminated,
        
        // Configuration
        setDebug: (debug) => { CONFIG.debug = debug; },
        getVersion: () => CONFIG.version,
        
        // Utilitaires
        log: log
    };
    
    // Alias pour compatibilit√©
    window.doInitialize = initialize;
    window.doTerminate = terminate;
    window.doGetValue = getValue;
    window.doSetValue = setValue;
    window.doCommit = commit;
    
})(window);`;
        }
        
        // Cr√©er le wrapper SCORM
        function createSCORMWrapper() {
            return `/**
 * Wrapper SCORM pour l'int√©gration du contenu
 * Compatible avec Moodle 4.1
 */

(function(window) {
    'use strict';
    
    // Configuration
    const CONFIG = {
        autoComplete: ${state.options.autoComplete},
        trackInteractions: ${state.options.trackInteractions},
        masteryScore: ${state.metadata.masteryScore},
        commitInterval: 60000, // 1 minute
        maxRetries: 3
    };
    
    // √âtat du wrapper
    const STATE = {
        score: 0,
        interactions: [],
        objectives: [],
        initialized: false,
        completed: false,
        commitTimer: null
    };
    
    // Initialisation
    function initializeSCORM() {
        if (STATE.initialized) return;
        
        console.log('Initialisation du wrapper SCORM...');
        
        // Initialiser l'API
        const result = window.SCORM.initialize();
        
        if (result === 'true' || result === true) {
            STATE.initialized = true;
            console.log('Wrapper SCORM initialis√© avec succ√®s');
            
            // Configurer les commits automatiques
            if (CONFIG.commitInterval > 0) {
                STATE.commitTimer = setInterval(autoCommit, CONFIG.commitInterval);
            }
            
            // Compl√©tion automatique si configur√©e
            if (CONFIG.autoComplete) {
                setTimeout(() => {
                    setCompletionStatus('completed');
                }, 1000);
            }
            
            // Ajouter les √©couteurs d'√©v√©nements si le tracking est activ√©
            if (CONFIG.trackInteractions) {
                setupInteractionTracking();
            }
            
        } else {
            console.error('√âchec de l\'initialisation du wrapper SCORM');
        }
    }
    
    // Terminer SCORM
    function terminateSCORM() {
        if (!STATE.initialized || STATE.terminated) return;
        
        console.log('Terminaison du wrapper SCORM...');
        
        // Arr√™ter le timer de commit
        if (STATE.commitTimer) {
            clearInterval(STATE.commitTimer);
        }
        
        // Commit final
        window.SCORM.commit();
        
        // Terminer l'API
        window.SCORM.terminate();
        
        STATE.terminated = true;
        console.log('Wrapper SCORM termin√©');
    }
    
    // Commit automatique
    function autoCommit() {
        if (STATE.initialized && !STATE.terminated) {
            console.log('Commit automatique...');
            window.SCORM.commit();
        }
    }
    
    // D√©finir le statut de compl√©tion
    function setCompletionStatus(status) {
        if (!STATE.initialized) return;
        
        const element = window.SCORM.getVersion() === '1.2' ? 
            'cmi.core.lesson_status' : 'cmi.completion_status';
        
        window.SCORM.setValue(element, status);
        STATE.completed = (status === 'completed' || status === 'passed');
        
        console.log(\`Statut de compl√©tion d√©fini: \${status}\`);
    }
    
    // D√©finir le score
    function setScore(score, maxScore = 100) {
        if (!STATE.initialized) return;
        
        const scaledScore = Math.min(100, Math.max(0, (score / maxScore) * 100));
        STATE.score = scaledScore;
        
        if (window.SCORM.getVersion() === '1.2') {
            window.SCORM.setValue('cmi.core.score.raw', scaledScore);
            window.SCORM.setValue('cmi.core.score.max', '100');
            window.SCORM.setValue('cmi.core.score.min', '0');
            
            // D√©finir le statut en fonction du score de ma√Ætrise
            if (scaledScore >= CONFIG.masteryScore) {
                window.SCORM.setValue('cmi.core.lesson_status', 'passed');
            } else if (STATE.completed) {
                window.SCORM.setValue('cmi.core.lesson_status', 'failed');
            }
        } else {
            const normalized = scaledScore / 100;
            window.SCORM.setValue('cmi.score.scaled', normalized);
            window.SCORM.setValue('cmi.score.raw', scaledScore);
            window.SCORM.setValue('cmi.score.max', '100');
            window.SCORM.setValue('cmi.score.min', '0');
            
            // D√©finir le statut de r√©ussite
            if (scaledScore >= CONFIG.masteryScore) {
                window.SCORM.setValue('cmi.success_status', 'passed');
            } else if (STATE.completed) {
                window.SCORM.setValue('cmi.success_status', 'failed');
            }
        }
        
        console.log(\`Score d√©fini: \${scaledScore}%\`);
    }
    
    // Suivre une interaction
    function trackInteraction(id, type, response, correct, latency, description) {
        if (!STATE.initialized || !CONFIG.trackInteractions) return;
        
        const index = STATE.interactions.length;
        
        if (window.SCORM.getVersion() === '1.2') {
            // SCORM 1.2 a un support limit√© des interactions
            window.SCORM.setValue(\`cmi.interactions.\${index}.id\`, id);
            window.SCORM.setValue(\`cmi.interactions.\${index}.type\`, type);
            window.SCORM.setValue(\`cmi.interactions.\${index}.student_response\`, response);
            window.SCORM.setValue(\`cmi.interactions.\${index}.result\`, correct ? 'correct' : 'incorrect');
            
            if (latency) {
                window.SCORM.setValue(\`cmi.interactions.\${index}.latency\`, formatTime(latency));
            }
        } else {
            // SCORM 2004
            window.SCORM.setValue(\`cmi.interactions.\${index}.id\`, id);
            window.SCORM.setValue(\`cmi.interactions.\${index}.type\`, type);
            window.SCORM.setValue(\`cmi.interactions.\${index}.learner_response\`, response);
            window.SCORM.setValue(\`cmi.interactions.\${index}.result\`, correct ? 'correct' : 'incorrect');
            
            if (description) {
                window.SCORM.setValue(\`cmi.interactions.\${index}.description\`, description);
            }
            
            if (latency) {
                window.SCORM.setValue(\`cmi.interactions.\${index}.latency\`, formatTime2004(latency));
            }
            
            const timestamp = new Date().toISOString();
            window.SCORM.setValue(\`cmi.interactions.\${index}.timestamp\`, timestamp);
        }
        
        STATE.interactions.push({ id, type, response, correct, latency, description });
        console.log(\`Interaction suivie: \${id}\`);
    }
    
    // Configuration du tracking des interactions
    function setupInteractionTracking() {
        // Suivre les clics sur les liens
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.href) {
                trackInteraction(
                    \`link_\${Date.now()}\`,
                    'other',
                    e.target.href,
                    true,
                    0,
                    e.target.textContent || 'Lien cliqu√©'
                );
            }
        });
        
        // Suivre les soumissions de formulaires
        document.addEventListener('submit', function(e) {
            if (e.target.tagName === 'FORM') {
                trackInteraction(
                    \`form_\${Date.now()}\`,
                    'other',
                    'submitted',
                    true,
                    0,
                    'Formulaire soumis'
                );
            }
        });
        
        // Suivre les changements dans les inputs
        document.addEventListener('change', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                const id = e.target.id || e.target.name || \`input_\${Date.now()}\`;
                trackInteraction(
                    id,
                    'fill-in',
                    e.target.value,
                    true,
                    0,
                    \`Champ modifi√©: \${id}\`
                );
            }
        });
    }
    
    // Formater le temps pour SCORM 1.2
    function formatTime(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        return \`\${hours.toString().padStart(4, '0')}:\${(minutes % 60).toString().padStart(2, '0')}:\${(seconds % 60).toString().padStart(2, '0')}.00\`;
    }
    
    // Formater le temps pour SCORM 2004
    function formatTime2004(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        return \`PT\${hours}H\${minutes % 60}M\${seconds % 60}S\`;
    }
    
    // API publique
    window.SCORMWrapper = {
        initialize: initializeSCORM,
        terminate: terminateSCORM,
        setScore: setScore,
        setCompletionStatus: setCompletionStatus,
        trackInteraction: trackInteraction,
        commit: () => window.SCORM.commit(),
        getScore: () => STATE.score,
        isCompleted: () => STATE.completed,
        isInitialized: () => STATE.initialized
    };
    
    // Alias globaux pour faciliter l'utilisation
    window.initializeSCORM = initializeSCORM;
    window.terminateSCORM = terminateSCORM;
    window.setSCORMScore = setScore;
    window.setSCORMCompletion = setCompletionStatus;
    
})(window);`;
        }
        
        // T√©l√©charger le package
        function downloadSCORM() {
            if (!state.package) {
                addLog('Aucun package √† t√©l√©charger', 'error');
                return;
            }
            
            const filename = `${state.metadata.title || 'scorm'}_${state.version}_${new Date().getTime()}.zip`;
            saveAs(state.package, filename);
            addLog(`Package t√©l√©charg√© : ${filename}`, 'success');
        }
        
        // R√©initialiser
        function reset() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser ? Toutes les donn√©es seront perdues.')) {
                location.reload();
            }
        }
        
        // Utilitaires
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Octets';
            const k = 1024;
            const sizes = ['Octets', 'Ko', 'Mo', 'Go'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function updateProgress(percent) {
            elements.progressBar.style.width = `${percent}%`;
            elements.progressBar.textContent = `${Math.round(percent)}%`;
        }
        
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = document.createElement('span');
            time.className = 'log-time';
            time.textContent = new Date().toLocaleTimeString('fr-FR');
            
            const msg = document.createElement('span');
            msg.className = `log-message log-${type}`;
            msg.textContent = message;
            
            entry.appendChild(time);
            entry.appendChild(msg);
            elements.log.appendChild(entry);
            
            // Scroll automatique
            elements.log.scrollTop = elements.log.scrollHeight;
        }
        
        function showElements(ids) {
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('hidden');
                }
            });
        }
        
        function escapeXML(str) {
            return str.replace(/[<>&'"]/g, function(c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case "'": return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }
        
        // Sauvegarde et chargement des param√®tres
        function saveSettings() {
            const settings = {
                version: state.version,
                options: state.options,
                metadata: state.metadata
            };
            localStorage.setItem('scormConverterSettings', JSON.stringify(settings));
        }
        
        function loadSettings() {
            try {
                const saved = localStorage.getItem('scormConverterSettings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    
                    // Restaurer la version
                    if (settings.version) {
                        state.version = settings.version;
                        document.querySelector(`input[name="scorm-version"][value="${settings.version}"]`).checked = true;
                    }
                    
                    // Restaurer les options
                    if (settings.options) {
                        Object.assign(state.options, settings.options);
                        elements.trackTime.checked = state.options.trackTime;
                        elements.trackInteractions.checked = state.options.trackInteractions;
                        elements.autoComplete.checked = state.options.autoComplete;
                        elements.debugMode.checked = state.options.debugMode;
                        CONFIG.DEBUG = state.options.debugMode;
                    }
                    
                    // Restaurer les m√©tadonn√©es
                    if (settings.metadata) {
                        Object.assign(state.metadata, settings.metadata);
                        elements.masteryScore.value = state.metadata.masteryScore;
                    }
                    
                    addLog('Param√®tres charg√©s depuis la sauvegarde locale', 'info');
                }
            } catch (e) {
                console.error('Erreur lors du chargement des param√®tres:', e);
            }
        }
        
        // D√©marrer l'application
        init();
    </script>
</body>
</html>