<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Prompts pour Applications QCM et Certification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Variables et styles de base */
        :root {
            /* Couleurs principales du gradient */
            --gradient-start: #f08b65;
            --gradient-end: #cf4520;
            
            /* Couleur d'accent et ombres */
            --accent-color: #d14b2c;
            --shadow-dark: rgba(110, 20, 0, 0.3);
            --shadow-light: rgba(255, 255, 255, 0.3);
            
            /* Couleurs des onglets */
            --tab1-color: #d14b2c;
            --tab2-color: #dc5e42;
            --tab3-color: #e57158;
            --tab4-color: #ee846e;
            --tab5-color: #f79785;
            --tab6-color: #ffaa9c;
            
            /* Couleurs des boutons */
            --btn-primary: #d14b2c;
            --btn-secondary: #9e9e9e;
            --btn-special: #cf4520;
            --btn-danger: #f44336;
            
            /* Autres variables */
            --text-color: #333333;
            --base-color: #f5f5f5;
            --transition: all 0.3s ease;
        }

        /* Styles globaux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 20px;
            background-color: white;
            box-shadow: 8px 8px 16px var(--shadow-dark);
        }

        h1 {
            text-align: center;
            color: var(--accent-color);
            margin: 0;
            padding: 0 60px;
        }

        .version-bubble {
            background-color: var(--tab6-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .signature {
            background-color: var(--tab1-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .description {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: inset 3px 3px 7px rgba(0,0,0,0.2), inset -3px -3px 7px rgba(255,255,255,0.1);
        }

        /* Structure des onglets */
        .tabs-container {
            display: flex;
            margin-bottom: 20px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 8px 8px 16px var(--shadow-dark);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            box-shadow: inset 0 0 0 rgba(0,0,0,0.1), inset 0 0 0 rgba(255,255,255,0.1);
            color: white;
        }

        .tab.active {
            box-shadow: inset 3px 3px 5px rgba(0,0,0,0.2), inset -1px -1px 3px rgba(255,255,255,0.1);
            background-color: white;
            color: var(--accent-color);
        }

        .tab-1 { background-color: var(--tab1-color); }
        .tab-2 { background-color: var(--tab2-color); }
        .tab-3 { background-color: var(--tab3-color); }
        .tab-4 { background-color: var(--tab4-color); }
        .tab-5 { background-color: var(--tab5-color); }
        .tab-6 { background-color: var(--tab6-color); }

        .tab-content {
            padding: 20px;
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--shadow-dark);
            margin-bottom: 20px;
            display: none;
            background-color: white;
        }

        .tab-content.active {
            display: block;
        }

        /* Boutons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 10px;
            margin-bottom: 10px;
            background-color: var(--base-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -2px -2px 5px var(--shadow-light);
            color: var(--text-color);
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 12px var(--shadow-dark), -2px -2px 5px var(--shadow-light);
        }

        .btn:active {
            box-shadow: inset 3px 3px 5px rgba(0,0,0,0.2), inset -1px -1px 3px rgba(255,255,255,0.1);
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--btn-primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--btn-secondary);
            color: white;
        }

        .btn-special {
            background-color: var(--btn-special);
            color: white;
        }

        .btn-danger {
            background-color: var(--btn-danger);
            color: white;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            margin: 15px 0;
            gap: 10px;
        }

        /* Étapes et paramètres */
        .step-title {
            font-size: 1.5rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
            min-height: 100px;
            resize: vertical;
        }

        /* Grid pour les niveaux scolaires */
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .level-column {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 20px;
        }

        .level-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .level-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Niveaux sélectionnés */
        .selected-levels {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
        }

        /* API Config */
        .api-config-section {
            background-color: var(--base-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .api-input-group {
            margin-bottom: 10px;
        }

        .api-input-wrapper {
            display: flex;
            align-items: center;
        }

        .api-input-wrapper input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
        }

        .toggle-visibility-btn {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: -30px;
            z-index: 10;
            color: #888;
        }

        .api-format-info {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .api-model-select {
            margin-bottom: 15px;
        }

        .api-model-select label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .api-model-select select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
        }

        /* Preview du prompt */
        .preview-container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 20px;
            margin-top: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-content {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        /* Paramètres des QCM */
        .qcm-params {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .param-card {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.1);
        }

        .param-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        /* Preview des QCM */
        .qcm-preview {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 20px;
        }

        .qcm-question {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .qcm-question h4 {
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .qcm-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .qcm-option {
            padding: 8px 12px;
            background-color: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            padding-left: 30px;
        }

        .qcm-option:before {
            content: "";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
        }

        .qcm-option.correct:before {
            background-color: #4caf50;
        }

        .qcm-option:hover {
            background-color: #e0e0e0;
        }

        .qcm-feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background-color: #f8f8f8;
            border-left: 3px solid var(--accent-color);
        }

        /* Catégories */
        .category-container {
            margin-top: 20px;
        }

        .category-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .category-row .remove-btn {
            background-color: var(--btn-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Certificat preview */
        .certificate-preview {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border: 10px solid var(--accent-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
            border-radius: 20px;
        }

        .certificate-preview h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .certificate-preview p {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .certificate-preview .score {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-color);
            margin: 20px 0;
        }

        .certificate-preview .date {
            font-style: italic;
            margin-bottom: 30px;
        }

        .certificate-preview .signatures {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }

        .certificate-preview .signature-box {
            text-align: center;
            width: 40%;
        }

        .certificate-preview .signature-line {
            width: 100%;
            height: 2px;
            background-color: #333;
            margin-bottom: 10px;
        }

        /* Info container */
        .info-container {
            background-color: #f0f8ff;
            padding: 20px;
            border-radius: 20px;
            border-left: 5px solid var(--accent-color);
        }

        .info-container h3 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .info-container ol {
            margin-left: 20px;
        }

        .info-container li {
            margin-bottom: 8px;
        }

        /* Styles pour la section de corrigé */
        .correction-options {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .correction-options h4 {
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .correction-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .correction-checkbox input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .style-presets-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .style-preset {
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .style-preset:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .preset-preview {
            height: 80px;
            border-radius: 10px 10px 0 0;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preset-options {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 90%;
        }
        
        .preset-option {
            height: 8px;
            border-radius: 4px;
        }
        
        .preset-option.selected {
            height: 10px;
        }
        
        .preset-title {
            background-color: white;
            padding: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Notification style */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 16px;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .notification.show {
            display: block;
            opacity: 1;
        }

        /* Range sliders */
        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-slider {
            flex-grow: 1;
            height: 8px;
            appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
            transition: var(--transition);
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .range-value {
            min-width: 40px;
            padding: 5px;
            text-align: center;
            background-color: var(--accent-color);
            color: white;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 20px;
            width: 80%;
            max-width: 1000px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent-color);
        }
        
        /* Styles pour l'interface d'intégration IA */
        .tools-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .resources-column, .activities-column {
            flex: 1;
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
        }

        .column-title {
            border-bottom: 2px solid var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
        }

        .api-test-panel {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .api-test-form {
            margin-top: 15px;
        }

        .api-test-result {
            margin-top: 20px;
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .result-content {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
        }

        .placeholder-text {
            color: #aaa;
            font-style: italic;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            display: none;
        }

        .api-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
            display: block;
        }

        .api-status.error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
            display: block;
        }

        .api-test-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
            padding: 8px;
            border-radius: 5px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-spinner {
            text-align: center;
        }

        .section-buttons {
            margin-top: 20px;
            text-align: right;
        }
        
        /* Question Generation UI */
        .question-generation-container {
            background-color: #f8f8f8;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .generation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        .generation-header h3 {
            color: var(--accent-color);
            margin: 0;
        }
        
        .generation-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .generation-option {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .generation-option h4 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .variables-container {
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* CORRECTION DU BUG: Amélioration de la disposition des variables */
        .variable-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .variable-row input[type="text"] {
            min-width: 80px;
            max-width: 120px;
            flex-grow: 0;
        }
        
        .variable-row select {
            min-width: 100px;
            max-width: 150px;
        }
        
        .variable-values-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 200px;
        }
        
        .variable-values-container input {
            max-width: 80px;
        }
        
        .variable-remove-btn {
            flex-shrink: 0;
        }
        /* FIN DE LA CORRECTION */
        
        .variable-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .feedback-templates {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 10px;
        }
        
        .preview-question {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .generation-results {
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 15px;
        }
        
        .question-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .question-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .question-card-body {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .question-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        #generation-indicator, #generation-success {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin-top: 15px;
            background-color: #f0f8ff;
            border-radius: 10px;
            text-align: center;
        }
        
        #generation-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .xml-preview {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .ai-button {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #6b46c1;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ai-button:hover {
            background-color: #553c9a;
        }
        
        .hidden {
            display: none;
        }
        
        /* Styles pour l'intégration SCORM */
        .scorm-container {
            background-color: #f0f8ff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #2196F3;
        }
        
        .scorm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 10px;
        }
        
        .scorm-header h3 {
            color: #2196F3;
            margin: 0;
        }
        
        .scorm-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .scorm-details {
            background-color: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .scorm-details h4 {
            color: #2196F3;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #bbdefb;
            padding-bottom: 5px;
        }
        
        .scorm-details ul {
            margin-left: 20px;
            padding-left: 0;
        }
        
        .scorm-details li {
            margin-bottom: 8px;
        }
        
        /* Styles responsifs */
        @media (max-width: 768px) {
            .levels-grid, .qcm-params, .tools-container, .generation-options, .scorm-options {
                grid-template-columns: 1fr;
            }

            .tabs-container {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }

            .header-container {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            h1 {
                padding: 0;
                margin: 10px 0;
            }

            .version-bubble, .signature {
                position: static;
                transform: none;
                margin: 5px 0;
            }
            
            .style-presets-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .tools-container {
                flex-direction: column;
            }
            
            /* Amélioration responsive pour les variables */
            .variable-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .variable-row input[type="text"],
            .variable-row select {
                width: 100%;
                max-width: 100%;
            }
            
            .variable-values-container {
                width: 100%;
                margin-top: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .style-presets-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header-container">
            <div class="version-bubble">V4.3</div>
            <h1>Générateur de Prompts pour QCM et Certification</h1>
            <div class="signature">QCMCert</div>
        </div>

        <div class="description">
            <p>Créez facilement des prompts optimisés pour générer des applications de questionnaires à choix multiples (QCM) avec certification. Personnalisez le domaine, le niveau, les questions, les fonctionnalités et le certificat, puis utilisez le prompt généré avec votre IA préférée.</p>
            <p style="margin-top: 10px;">
                <button id="open-ia-api-btn" class="btn btn-special">
                    <i class="fas fa-robot"></i> Configurer l'IA & API
                </button>
            </p>
        </div>

        <div class="tabs-container">
            <div class="tab tab-1 active" data-tab="1">
                Configuration
            </div>
            <div class="tab tab-2" data-tab="2">
                Questions & IA
            </div>
            <div class="tab tab-3" data-tab="3">
                Apparence
            </div>
            <div class="tab tab-4" data-tab="4">
                Certificat
            </div>
            <div class="tab tab-5" data-tab="5">
                SCORM
            </div>
            <div class="tab tab-6" data-tab="6">
                Prompt
            </div>
        </div>

        <!-- Tab 1: Configuration -->
        <div id="tab-content-1" class="tab-content active">
            <h2 class="step-title">Étape 1: Configurer l'application</h2>
            
            <div class="form-group">
                <label class="form-label" for="app-title">Titre de l'application:</label>
                <input 
                    type="text" 
                    id="app-title" 
                    class="form-input" 
                    placeholder="Ex: QCMaster - Système d'évaluation" 
                    value="QCMaster - Système d'évaluation et Certification"
                >
            </div>


            <div class="form-group">
                <label class="form-label" for="app-subtitle">Sous-titre (optionnel):</label>
                <input 
                    type="text" 
                    id="app-subtitle" 
                    class="form-input" 
                    placeholder="Ex: Questionnaires à choix multiples interactifs"
                    value="Questionnaires à choix multiples et certification des compétences"
                >
            </div>

            <div class="form-group">
                <label class="form-label" for="app-author">Signature / Auteur:</label>
                <input 
                    type="text" 
                    id="app-author" 
                    class="form-input" 
                    placeholder="Ex: @votre_nom" 
                    value="@qcmcert"
                >
            </div>
            
            <div class="form-group">
                <label class="form-label" for="domain-select">Domaine de l'application:</label>
                <select 
                    id="domain-select" 
                    class="form-select"
                >
                    <option value="mathematiques" selected>Mathématiques</option>
                    <option value="physique">Sciences Physiques</option>
                    <option value="chimie">Chimie</option>
                    <option value="biologie">Biologie</option>
                    <option value="histoire">Histoire</option>
                    <option value="geographie">Géographie</option>
                    <option value="francais">Français</option>
                    <option value="langues">Langues étrangères</option>
                    <option value="informatique">Informatique</option>
                    <option value="economie">Économie</option>
                    <option value="philosophie">Philosophie</option>
                    <option value="custom">Personnalisé</option>
                </select>
            </div>
            
            <div class="form-group" id="custom-domain-container" style="display: none;">
                <label class="form-label" for="custom-domain">Domaine personnalisé:</label>
                <input 
                    type="text" 
                    id="custom-domain" 
                    class="form-input" 
                    placeholder="Entrez votre domaine personnalisé"
                >
            </div>

            <div class="form-group">
                <label class="form-label">Niveaux scolaires ciblés (sélection multiple):</label>
                
                <div class="levels-grid">
                    <div class="level-column">
                        <div class="level-title">Collège</div>
                        <div class="level-options">
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-6" 
                                    value="6ème"
                                >
                                <label for="level-6">6ème</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-5" 
                                    value="5ème"
                                >
                                <label for="level-5">5ème</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-4" 
                                    value="4ème"
                                >
                                <label for="level-4">4ème</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-3" 
                                    value="3ème"
                                    checked
                                >
                                <label for="level-3">3ème</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="level-column">
                        <div class="level-title">Lycée Général</div>
                        <div class="level-options">
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-2" 
                                    value="2nde"
                                >
                                <label for="level-2">2nde</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-1" 
                                    value="1ère"
                                >
                                <label for="level-1">1ère</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-t" 
                                    value="Terminale"
                                >
                                <label for="level-t">Terminale</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="level-column">
                        <div class="level-title">Lycée Pro / Supérieur</div>
                        <div class="level-options">
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-cap" 
                                    value="CAP"
                                >
                                <label for="level-cap">CAP</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-bac" 
                                    value="Bac Pro"
                                >
                                <label for="level-bac">Bac Pro</label>
                            </div>
                            <div class="checkbox-container">
                                <input 
                                    type="checkbox" 
                                    id="level-sup" 
                                    value="Supérieur"
                                >
                                <label for="level-sup">Supérieur</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="selected-levels" id="selected-levels-display">
                    Niveaux sélectionnés: 3ème
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="reset-button"
                >
                    <i class="fas fa-sync-alt"></i> Réinitialiser
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-1"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 2: Questions & IA -->
        <div id="tab-content-2" class="tab-content">
            <h2 class="step-title">Étape 2: Configuration des questions et génération IA</h2>
            
            <div class="form-group">
                <label class="form-label" for="questions-total">Nombre total de questions à générer:</label>
                <div class="range-container">
                    <input 
                        type="range" 
                        id="questions-total" 
                        class="range-slider" 
                        min="5" 
                        max="50" 
                        value="20" 
                        step="1"
                    >
                    <span class="range-value" id="questions-total-value">20</span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="questions-per-test">Nombre de questions par test:</label>
                <div class="range-container">
                    <input 
                        type="range" 
                        id="questions-per-test" 
                        class="range-slider" 
                        min="5" 
                        max="30" 
                        value="10" 
                        step="1"
                    >
                    <span class="range-value" id="questions-per-test-value">10</span>
                </div>
                <div class="alert alert-info" style="margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> 
                    L'application sélectionnera aléatoirement 10 questions parmi les 20 générées à chaque tentative.
                </div>
            </div>
            
            
            <div class="form-group" id="qcm-count-container" style="display: none;">
                <label class="form-label" for="qcm-count">Nombre de QCM distincts possibles:</label>
                <div id="qcm-count-display" class="alert alert-info">
                    <i class="fas fa-calculator"></i> 
                    Avec ces paramètres, environ <span id="qcm-count-value">2</span> QCM distincts peuvent être générés.
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="show-qcm-count" checked>
                    <label for="show-qcm-count">Afficher ce nombre en page d'accueil (recommandé pour les grands ensembles de questions)</label>
                </div>
            </div>            
            
            
            <div class="form-group">
                <label class="form-label" for="options-per-question">Nombre d'options de réponse par question:</label>
                <div class="range-container">
                    <input 
                        type="range" 
                        id="options-per-question" 
                        class="range-slider" 
                        min="2" 
                        max="6" 
                        value="4" 
                        step="1"
                    >
                    <span class="range-value" id="options-per-question-value">4</span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="correct-answers-allowed">Nombre de réponses correctes possibles par question:</label>
                <select 
                    id="correct-answers-allowed" 
                    class="form-select"
                >
                    <option value="single" selected>Une seule réponse correcte (QCM standard)</option>
                    <option value="multiple">Plusieurs réponses correctes possibles (QCM à réponses multiples)</option>
                    <option value="variable">Variable selon la question</option>
                </select>
            </div>
            
			<div class="form-group">
				<label class="form-label" for="disable-other-options">Comportement des réponses:</label>
				<div class="checkbox-container">
					<input type="checkbox" id="disable-other-options" checked>
					<label for="disable-other-options">Désactiver et griser les autres options après sélection d'une réponse</label>
				</div>
				<div class="alert alert-info" style="margin-top: 8px;">
					<i class="fas fa-info-circle"></i> 
					Pour les QCM à réponse unique, cette option permet de verrouiller la sélection et d'améliorer l'expérience utilisateur.
				</div>
			</div>
            
            <div class="form-group">
                <label class="form-label" for="categories-enabled">Utiliser des catégories de questions:</label>
                <select 
                    id="categories-enabled" 
                    class="form-select"
                >
                    <option value="yes">Oui</option>
                    <option value="no" selected>Non</option>
                </select>
            </div>
            
            <div class="category-container" id="categories-container" style="display: none;">
                <label class="form-label">Définir les catégories:</label>
                <div id="categories-list">
                    <div class="category-row">
                        <input 
                            type="text" 
                            class="form-input category-input" 
                            placeholder="Nom de la catégorie"
                        >
                        <button class="remove-btn category-remove-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button 
                    class="btn btn-secondary" 
                    id="add-category-btn"
                    style="margin-top: 10px"
                >
                    <i class="fas fa-plus"></i> Ajouter une catégorie
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="max-attempts">Nombre maximum de tentatives:</label>
                <div class="range-container">
                    <input 
                        type="range" 
                        id="max-attempts" 
                        class="range-slider" 
                        min="1" 
                        max="10" 
                        value="3" 
                        step="1"
                    >
                    <span class="range-value" id="max-attempts-value">3</span>
                </div>
                <div class="alert alert-info" style="margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> 
                    Les questions seront mélangées à chaque nouvelle tentative.
                </div>
            </div>
            
                       
            
            
            
            <div class="form-group">
                <h3 style="margin-bottom: 15px; color: var(--accent-color);">Système de notation</h3>
                <div class="qcm-params">
                    <div class="param-card">
                        <div class="param-title">Points pour les bonnes réponses</div>
                        <div class="form-group">
                            <label for="points-correct">Points par réponse correcte:</label>
                            <select 
                                id="points-correct" 
                                class="form-select"
                            >
                                <option value="1" selected>1 point</option>
                                <option value="0.5">0.5 point</option>
                                <option value="2">2 points</option>
                                <option value="5">5 points</option>
                                <option value="10">10 points</option>
                            </select>
                        </div>
                    </div>
                    <div class="param-card">
                        <div class="param-title">Pénalités pour erreurs</div>
                        <div class="form-group">
                            <label for="points-penalty">Pénalité par réponse incorrecte:</label>
                            <select 
                                id="points-penalty" 
                                class="form-select"
                            >
                                <option value="0" selected>Aucune</option>
                                <option value="0.25">-0.25 point</option>
                                <option value="0.5">-0.5 point</option>
                                <option value="1">-1 point</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="success-threshold">Seuil de réussite (%):</label>
                <div class="range-container">
                    <input 
                        type="range" 
                        id="success-threshold" 
                        class="range-slider" 
                        min="0" 
                        max="100" 
                        value="70" 
                        step="5"
                    >
                    <span class="range-value" id="success-threshold-value">70%</span>
                </div>
                <div class="alert alert-info" style="margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> 
                    Ce seuil sera utilisé pour déterminer si l'utilisateur peut obtenir le certificat.
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="feedback-type">Type de feedback après réponse:</label>
                <select 
                    id="feedback-type" 
                    class="form-select"
                >
                    <option value="immediate" selected>Immédiat (après chaque question)</option>
                    <option value="end">À la fin du test uniquement</option>
                    <option value="both">Les deux (après chaque question et à la fin)</option>
                </select>
            </div>
            
            
			<div class="form-group">
				<label class="form-label" for="enable-mathjax">Support des expressions mathématiques:</label>
				<select 
					id="enable-mathjax" 
					class="form-select"
				>
					<option value="yes" selected>Activé (MathJax)</option>
					<option value="no">Désactivé</option>
				</select>
				<div class="alert alert-info" style="margin-top: 8px;">
					<i class="fas fa-info-circle"></i> 
					Permet l'affichage correct des formules mathématiques comme \( f(x) = x^2 \) ou \( \sqrt{a^2+b^2} \)
				</div>
			</div>
            
            
			<!-- BOUTON DE PRÉVISUALISATION -->
			<div class="form-group">
				<button class="btn btn-secondary" id="preview-math-btn">
					<i class="fas fa-eye"></i> Prévisualiser les expressions mathématiques
				</button>
				<div id="math-preview" style="display: none; margin-top: 10px; padding: 15px; background-color: #f5f5f5; border-radius: 10px;">
					<p>Aperçu des expressions mathématiques:</p>
					<ul>
						<li>Expressions simples: \( x^2 + 2x + 1 \)</li>
						<li>Fractions: \( \frac{a}{b} \)</li>
						<li>Racines: \( \sqrt{2} \)</li>
						<li>Indices et exposants: \( a_n^m \)</li>
						<li>Intégrales: \( \int_a^b f(x) dx \)</li>
					</ul>
				</div>
			</div>
            
            
            <div class="form-group">
                <label class="form-label" for="correction-enabled">Inclure un corrigé détaillé:</label>
                <select 
                    id="correction-enabled" 
                    class="form-select"
                >
                    <option value="yes" selected>Oui</option>
                    <option value="no">Non</option>
                </select>
                
                <div id="correction-options" class="correction-options">
                    <h4>Options du corrigé</h4>
                    <div class="correction-checkbox">
                        <input type="checkbox" id="correction-print" checked>
                        <label for="correction-print">Impression</label>
                    </div>
                    <div class="correction-checkbox">
                        <input type="checkbox" id="correction-pdf" checked>
                        <label for="correction-pdf">Export PDF</label>
                    </div>
                    <div class="correction-checkbox">
                        <input type="checkbox" id="correction-jpg">
                        <label for="correction-jpg">Export JPEG</label>
                    </div>
                    
                    <div class="correction-checkbox">
                        <input type="checkbox" id="correction-after-completion" checked>
                        <label for="correction-after-completion">Ne fournir le corrigé qu'après toutes les tentatives ou réussite</label>
                    </div>                    
                </div>
            </div>
            
            <!-- Question Generation UI Section -->
            <div class="question-generation-container">
                <div class="generation-header">
                    <h3>Générateur de questions par IA</h3>
                    <button class="btn btn-special" id="generate-questions-ai">
                        <i class="fas fa-robot"></i> Générer des exemples
                    </button>
                </div>
                
                
                <div id="generation-success">
                    <i class="fas fa-check-circle" style="color: #2e7d32; font-size: 24px; margin-right: 10px;"></i>
                    <p>Questions générées avec succès!</p>
                </div>                
                
                <div id="generation-indicator">
                    <div class="spinner"></div>
                    <p>Génération des questions en cours...</p>
                </div>

                
                
                <div class="form-group">
                    <label class="form-label" for="content-theme">Thème spécifique ou consignes pour les questions:</label>
                    <textarea 
                        id="content-theme" 
                        class="form-textarea" 
                        placeholder="Ex: Concentrez-vous sur les théorèmes de géométrie dans l'espace, avec une attention particulière sur les calculs de volumes et surfaces"
                    ></textarea>
                </div>
                
                <div id="generation-success">
                    <i class="fas fa-check-circle" style="color: #2e7d32; font-size: 24px; margin-right: 10px;"></i>
                    <p>Questions générées avec succès!</p>
                </div>                
                
                <div id="generation-indicator">
                    <div class="spinner"></div>
                    <p>Génération des questions en cours...</p>
                </div>
                
                <div class="generation-options">
                    <div class="generation-option">
                        <h4>Variations</h4>
                        <div class="form-group">
                            <label for="variations-count">Nombre de variations à générer:</label>
                            <div class="range-container">
                                <input 
                                    type="range" 
                                    id="variations-count" 
                                    class="range-slider" 
                                    min="1" 
                                    max="10" 
                                    value="5" 
                                    step="1"
                                >
                                <span class="range-value" id="variations-count-value">5</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="numbering-format">Format de numérotation:</label>
                            <select id="numbering-format" class="form-select">
                                <option value="simple" selected>Simple (1, 2, 3...)</option>
                                <option value="zero">Avec zéro (01, 02, 03...)</option>
                                <option value="three">Trois chiffres (001, 002...)</option>
                                <option value="letter">Lettres (A, B, C...)</option>
                                <option value="q">Format "Q" (Q1, Q2, Q3...)</option>
                                <option value="custom">Personnalisé</option>
                            </select>
                        </div>
                        
                        <div id="custom-numbering-format" class="form-group" style="display: none;">
                            <label for="custom-format">Format personnalisé:</label>
                            <input type="text" id="custom-format" class="form-input" placeholder="Utilisez {n} comme placeholder" value="Question-{n}">
                            <small>Exemple: "Q-{n}" donnera "Q-1", "Q-2", etc.</small>
                        </div>
                    </div>
                    
                    <div class="generation-option">
                        <h4>Contextes alternatifs</h4>
                        <p>Définissez différents contextes pour vos variations:</p>
                        
                        <div id="contexts-container">
                            <div class="form-group">
                                <textarea class="form-textarea context-input" placeholder="Ex: Dans un contexte de construction d'une maison..."></textarea>
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary" id="add-context-btn">
                            <i class="fas fa-plus"></i> Ajouter un contexte
                        </button>
                    </div>
                    
                    <div class="generation-option">
                        <h4>Variables</h4>
                        <p>Définissez des variables à varier dans les questions:</p>
                        
                        <div id="variables-container" class="variables-container">
                            <!-- Variables will be added here -->
                            <p class="placeholder-text">Aucune variable définie. Cliquez sur "Ajouter une variable" ci-dessous.</p>
                        </div>
                        
                        <div class="variable-controls">
                            <button class="btn btn-secondary" id="add-variable-btn">
                                <i class="fas fa-plus"></i> Ajouter une variable
                            </button>
                            <button class="ai-button" id="suggest-variables-btn">
                                <i class="fas fa-lightbulb"></i> Suggérer des variables
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group feedback-templates">
                    <h4>Templates de feedback</h4>
                    <p>Personnalisez les feedbacks générés pour les questions:</p>
                    
                    <div class="form-group">
                        <label for="correct-feedback-template">Template pour réponses correctes:</label>
                        <textarea id="correct-feedback-template" class="form-textarea" placeholder="Excellent! Cette réponse est correcte car [explication]. Ce concept est important pour [application].">Excellent! Cette réponse est correcte car [explication]. Ce concept est important pour [application].</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="incorrect-feedback-template">Template pour réponses incorrectes:</label>
                        <textarea id="incorrect-feedback-template" class="form-textarea" placeholder="Cette réponse n'est pas correcte. Rappelez-vous que [principe correct]. L'erreur commune ici est de [malentendu fréquent].">Cette réponse n'est pas correcte. Rappelez-vous que [principe correct]. L'erreur commune ici est de [malentendu fréquent].</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="general-feedback-template">Template pour feedback général:</label>
                        <textarea id="general-feedback-template" class="form-textarea" placeholder="Cette question porte sur un concept important du chapitre [chapitre/thème]. Assurez-vous de bien comprendre les principes fondamentaux avant de continuer.">Cette question porte sur un concept important du chapitre [chapitre/thème]. Assurez-vous de bien comprendre les principes fondamentaux avant de continuer.</textarea>
                    </div>
                    
                    <button class="ai-button" id="generate-feedback-ai">
                        <i class="fas fa-magic"></i> Générer des templates avec l'IA
                    </button>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="edit-prompt" />
                        <label for="edit-prompt"><strong>Éditer les consignes</strong> du prompt de génération relatives aux questions et aux options</label>
                    </div>
                    
                    <div id="edit-prompt-container" class="hidden">
                        <textarea id="generation-prompt" class="form-textarea" style="height: 200px;" data-original-value=""></textarea>
                        <div id="prompt-change-indicator" class="alert alert-info hidden" style="margin-top: 10px;">
                            <i class="fas fa-exclamation-circle"></i> Vous avez modifié le prompt. N'oubliez pas d'enregistrer vos changements.
                        </div>
                        <button class="btn btn-primary" id="save-prompt-changes" disabled>
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </div>
                </div>
                
               
                
                <div class="generation-results" id="generation-results-container" style="display: none;">
                    <h4>Questions générées</h4>
                    <div id="generated-questions-list">
                        <!-- Generated questions will appear here -->
                    </div>
                </div>
            </div>
            
            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-2"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-2"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 3: Apparence -->
        <div id="tab-content-3" class="tab-content">
            <h2 class="step-title">Étape 3: Apparence et style</h2>
            
            <div class="form-group">
                <label class="form-label">Styles prédéfinis:</label>
                <div class="style-presets-container">
                    <div class="style-preset" data-style="modern" data-color="blue" data-animation="slide" data-interface="tabs">
                        <div class="preset-preview" style="background: linear-gradient(135deg, #2255cc22, #2255cc11); border-color: #2255cc;">
                            <div class="preset-options">
                                <span class="preset-option" style="background-color: #f5f5f5; border-left: 3px solid #2255cc;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option selected" style="background-color: #e6f0ff; border-left: 3px solid #2255cc;"></span>
                            </div>
                        </div>
                        <div class="preset-title">Professionnel <span class="color-dot" style="background-color: #2255cc;"></span></div>
                    </div>
                    
                    <div class="style-preset" data-style="playful" data-color="orange" data-animation="zoom" data-interface="cards">
                        <div class="preset-preview" style="background: #fff9e6; border: 3px dashed #d14b2c;">
                            <div class="preset-options">
                                <span class="preset-option" style="background-color: #f5f5f5; border-radius: 15px;"></span>
                                <span class="preset-option selected" style="background-color: #ffebdc; border-radius: 15px; border: 2px solid #d14b2c;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border-radius: 15px;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border-radius: 15px;"></span>
                            </div>
                        </div>
                        <div class="preset-title">Ludique <span class="color-dot" style="background-color: #d14b2c;"></span></div>
                    </div>
                    
                    <div class="style-preset" data-style="minimal" data-color="green" data-animation="fade" data-interface="single-page">
                        <div class="preset-preview" style="background-color: #fafafa; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div class="preset-options">
                                <span class="preset-option" style="background-color: #f5f5f5; border: 1px solid #eee;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border: 1px solid #eee;"></span>
                                <span class="preset-option selected" style="background-color: #e8f5e9; border: 1px solid #22cc55;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border: 1px solid #eee;"></span>
                            </div>
                        </div>
                        <div class="preset-title">Minimaliste <span class="color-dot" style="background-color: #22cc55;"></span></div>
                    </div>
                    
                    <div class="style-preset" data-style="classic" data-color="red" data-animation="none" data-interface="wizard">
                        <div class="preset-preview" style="background-color: #f9f9f9; border: 1px solid #ddd;">
                            <div class="preset-options">
                                <span class="preset-option selected" style="background-color: #ffebee; border: 1px solid #cc2222;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border: 1px solid #ddd;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border: 1px solid #ddd;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5; border: 1px solid #ddd;"></span>
                            </div>
                        </div>
                        <div class="preset-title">Classique <span class="color-dot" style="background-color: #cc2222;"></span></div>
                    </div>
                    
                    <div class="style-preset" data-style="gradient" data-color="purple" data-animation="slide" data-interface="tabs">
                        <div class="preset-preview" style="background: linear-gradient(135deg, #6222cc22, #6222cc11);">
                            <div class="preset-options">
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option selected" style="background-color: #f0e6ff; border-left: 3px solid #6222cc;"></span>
                            </div>
                        </div>
                        <div class="preset-title">Sophistiqué <span class="color-dot" style="background-color: #6222cc;"></span></div>
                    </div>
                    
                    <div class="style-preset" data-style="modern" data-color="teal" data-animation="zoom" data-interface="cards">
                        <div class="preset-preview" style="background-color: #ffffff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">
                            <div class="preset-options">
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option selected" style="background-color: #e0f2f1; border-left: 3px solid #009688;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                                <span class="preset-option" style="background-color: #f5f5f5;"></span>
                            </div>
                        </div>
                        <div class="preset-title">Moderne <span class="color-dot" style="background-color: #009688;"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="buttons" style="margin-bottom: 20px">
                <button 
                    class="btn btn-primary" 
                    id="recommend-style-btn"
                >
                    <i class="fas fa-magic"></i> Recommandation IA de style
                </button>
                <button 
                    class="btn btn-special" 
                    id="generate-palette-btn"
                >
                    <i class="fas fa-palette"></i> Générer palette de couleurs
                </button>
            </div>
            
            <div class="qcm-params">
                <div class="param-card">
                    <div class="param-title">Style visuel</div>
                    <div class="form-group">
                        <label class="form-label" for="qcm-style">Thème visuel:</label>
                        <div style="display: flex; gap: 10px; align-items: center">
                            <select 
                                id="qcm-style" 
                                class="form-select" 
                                style="flex-grow: 1"
                            >
                                <option value="classic">Classique</option>
                                <option value="modern" selected>Moderne</option>
                                <option value="playful">Ludique</option>
                                <option value="minimal">Minimaliste</option>
                                <option value="gradient">Dégradé</option>
                            </select>
                            <button 
                                class="btn btn-special" 
                                id="suggest-style-btn"
                                style="padding: 5px; min-width: 36px"
                            >
                                <i class="fas fa-robot"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="param-card">
                    <div class="param-title">Animations</div>
                    <div class="form-group">
                        <label class="form-label" for="transition-animation">Type d'animation:</label>
                        <div style="display: flex; gap: 10px; align-items: center">
                            <select 
                                id="transition-animation" 
                                class="form-select" 
                                style="flex-grow: 1"
                            >
                                <option value="slide" selected>Glissement</option>
                                <option value="fade">Fondu</option>
                                <option value="zoom">Zoom</option>
                                <option value="none">Aucune</option>
                            </select>
                            <button 
                                class="btn btn-special" 
                                id="suggest-animation-btn"
                                style="padding: 5px; min-width: 36px"
                            >
                                <i class="fas fa-robot"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="param-card">
                    <div class="param-title">Couleur principale</div>
                    <div class="form-group">
                        <label class="form-label" for="primary-color">Couleur:</label>
                        <div style="display: flex; gap: 10px; align-items: center">
                            <select 
                                id="primary-color" 
                                class="form-select" 
                                style="flex-grow: 1"
                            >
                                <option value="orange" selected>Orange</option>
                                <option value="blue">Bleu</option>
                                <option value="red">Rouge</option>
                                <option value="green">Vert</option>
                                <option value="purple">Violet</option>
                                <option value="teal">Turquoise</option>
                            </select>
                            <button 
                                class="btn btn-special" 
                                id="suggest-color-btn"
                                style="padding: 5px; min-width: 36px"
                            >
                                <i class="fas fa-robot"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="param-card">
                    <div class="param-title">Interface</div>
                    <div class="form-group">
                        <label class="form-label" for="interface-style">Style d'interface:</label>
                        <div style="display: flex; gap: 10px; align-items: center">
                            <select 
                                id="interface-style" 
                                class="form-select" 
                                style="flex-grow: 1"
                            >
                                <option value="tabs" selected>Onglets</option>
                                <option value="cards">Cartes</option>
                                <option value="wizard">Assistant étape par étape</option>
                                <option value="single-page">Page unique</option>
                            </select>
                            <button 
                                class="btn btn-special" 
                                id="suggest-interface-btn"
                                style="padding: 5px; min-width: 36px"
                            >
                                <i class="fas fa-robot"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="progress-display">Affichage de la progression:</label>
                <select 
                    id="progress-display" 
                    class="form-select"
                >
                    <option value="bar" selected>Barre de progression</option>
                    <option value="numbers">Compteur (Question X/Y)</option>
                    <option value="both">Les deux</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="custom-styles">Styles personnalisés (CSS - optionnel):</label>
                <textarea 
                    id="custom-styles" 
                    class="form-textarea" 
                    placeholder="/* Ajoutez vos styles CSS personnalisés ici */"
                ></textarea>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-3"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-3"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 4: Certificat -->
        <div id="tab-content-4" class="tab-content">
            <h2 class="step-title">Étape 4: Configuration du certificat</h2>
            
            <div class="buttons" style="margin-bottom: 20px">
                <button 
                    class="btn btn-primary" 
                    id="generate-certificate-template"
                >
                    <i class="fas fa-certificate"></i> Générer un template de certificat
                </button>
                <button 
                    class="btn btn-special" 
                    id="generate-certificate-text"
                >
                    <i class="fas fa-file-alt"></i> Générer le texte du certificat
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="certificate-enabled">Activer le certificat de réussite:</label>
                <select 
                    id="certificate-enabled" 
                    class="form-select"
                >
                    <option value="yes" selected>Oui</option>
                    <option value="no">Non</option>
                </select>
            </div>
            
            <div id="certificate-options">
                <div class="form-group">
                    <label class="form-label" for="certificate-title">Titre du certificat:</label>
                    <div style="display: flex; gap: 10px; align-items: center">
                        <input 
                            type="text" 
                            id="certificate-title" 
                            class="form-input" 
                            placeholder="Ex: Certificat de Réussite" 
                            value="Certificat de Réussite"
                            style="flex-grow: 1"
                        >
                        <button 
                            class="btn btn-special" 
                            id="suggest-certificate-title"
                            style="padding: 5px; min-width: 36px"
                        >
                            <i class="fas fa-robot"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="certificate-style">Style du certificat:</label>
                    <div style="display: flex; gap: 10px; align-items: center">
                        <select 
                            id="certificate-style" 
                            class="form-select" 
                            style="flex-grow: 1"
                        >
                            <option value="classic">Classique</option>
                            <option value="modern" selected>Moderne</option>
                            <option value="elegant">Élégant</option>
                            <option value="playful">Ludique</option>
                        </select>
                        <button 
                            class="btn btn-special" 
                            id="suggest-certificate-style"
                            style="padding: 5px; min-width: 36px"
                        >
                            <i class="fas fa-robot"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="certificate-info">Informations requises pour le certificat:</label>
                    <select 
                        id="certificate-info" 
                        class="form-select"
                    >
                        <option value="name-only">Nom seulement</option>
                        <option value="name-class" selected>Nom et classe</option>
                        <option value="full">Informations complètes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="certificate-export">Options d'exportation:</label>
                    <select 
                        id="certificate-export" 
                        class="form-select"
                    >
                        <option value="print">Impression seulement</option>
                        <option value="print-pdf" selected>Impression et PDF</option>
                        <option value="print-pdf-image">Impression, PDF et Image</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="auto-date-certificate" checked>
                        <label for="auto-date-certificate">Ajouter automatiquement la date du jour au certificat</label>
                    </div>
                </div>                
                
                <div class="form-group">
                    <label class="form-label" for="show-detailed-scores">Afficher les scores détaillés par catégorie:</label>
                    <select 
                        id="show-detailed-scores" 
                        class="form-select"
                    >
                        <option value="yes" selected>Oui</option>
                        <option value="no">Non</option>
                    </select>
                </div>
                
                <div class="certificate-preview" id="certificate-preview">
                    <h2>Certificat de Réussite</h2>
                    <p>Ce certificat atteste que</p>
                    <p><strong>Nom de l'étudiant</strong></p>
                    <p><strong>Classe: 3ème</strong></p>
                    <p>a complété avec succès l'évaluation en</p>
                    <p><strong>Mathématiques - QCMaster - Système d'évaluation et Certification</strong></p>
                    
                    <div class="score">
                        Score: 80%
                    </div>
                    
                    <div class="detailed-scores">
                        <h3>Détail des compétences</h3>
                        <table class="scores-table">
                            <tr>
                                <td>Calcul numérique:</td>
                                <td>4/5</td>
                            </tr>
                            <tr>
                                <td>Géométrie:</td>
                                <td>3/3</td>
                            </tr>
                            <tr>
                                <td>Algèbre:</td>
                                <td>1/2</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="date">Date: <span id="certificate-date">19/05/2025</span></div>
                    
                    <div class="signatures">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <p>Professeur</p>
                            <p>@qcmcert</p>
                        </div>
                        
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <p>Étudiant</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-4"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-4"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 5: SCORM Integration -->
        <div id="tab-content-5" class="tab-content">
            <h2 class="step-title">Étape 5: Intégration SCORM pour Moodle</h2>
            
            <div class="scorm-container">
                <div class="scorm-header">
                    <h3>Configuration de l'intégration SCORM</h3>
                    <button class="btn btn-special" id="test-scorm-integration">
                        <i class="fas fa-plug"></i> Vérifier la compatibilité
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="scorm-enabled">Activer l'intégration SCORM:</label>
                    <select 
                        id="scorm-enabled" 
                        class="form-select"
                    >
                        <option value="yes" selected>Oui</option>
                        <option value="no">Non</option>
                    </select>
                    <div class="alert alert-info" style="margin-top: 8px;">
                        <i class="fas fa-info-circle"></i> 
                        L'intégration SCORM permet à l'application de communiquer avec votre LMS Moodle 4.1 pour transmettre les scores et l'achèvement du QCM.
                    </div>
                </div>
                
                <div id="scorm-options" class="scorm-options">
                    <div class="param-card">
                        <div class="param-title">Version SCORM</div>
                        <div class="form-group">
                            <label for="scorm-version">Version à utiliser:</label>
                            <select 
                                id="scorm-version" 
                                class="form-select"
                            >
                                <option value="2004" selected>SCORM 2004 (3ème édition)</option>
                                <option value="1.2">SCORM 1.2</option>
                            </select>
                            <div class="alert alert-info" style="margin-top: 8px; font-size: 0.9em;">
                                <i class="fas fa-info-circle"></i> 
                                SCORM 2004 offre des fonctionnalités plus avancées pour le suivi des activités, mais SCORM 1.2 a une meilleure compatibilité avec certaines versions de LMS.
                            </div>
                        </div>
                    </div>
                    
                    <div class="param-card">
                        <div class="param-title">Données à transmettre</div>
                        <div class="form-group">
                            <div class="checkbox-container">
                                <input type="checkbox" id="transmit-score" checked>
                                <label for="transmit-score">Score</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="transmit-completion" checked>
                                <label for="transmit-completion">État d'achèvement</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="transmit-success" checked>
                                <label for="transmit-success">Statut de réussite</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="transmit-time" checked>
                                <label for="transmit-time">Temps de session</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="transmit-interactions">
                                <label for="transmit-interactions">Interactions (réponses aux questions)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="param-card">
                        <div class="param-title">Options avancées</div>
                        <div class="form-group">
                            <div class="checkbox-container">
                                <input type="checkbox" id="auto-save" checked>
                                <label for="auto-save">Auto-enregistrement (recommandé)</label>
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label for="auto-save-frequency">Fréquence d'auto-enregistrement:</label>
                                <select 
                                    id="auto-save-frequency" 
                                    class="form-select"
                                >
                                    <option value="question">À chaque question</option>
                                    <option value="score" selected>À chaque changement de score</option>
                                    <option value="minutes">Toutes les 5 minutes</option>
                                </select>
                            </div>
                            <div class="checkbox-container" style="margin-top: 10px;">
                                <input type="checkbox" id="debug-mode">
                                <label for="debug-mode">Mode débogage (console)</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="scorm-details">
                    <h4>Détails des données transmises</h4>
                    <div id="scorm-details-content">
                        <p><strong>Pour SCORM 2004:</strong></p>
                        <ul>
                            <li><code>cmi.score.raw</code> : Score numérique brut</li>
                            <li><code>cmi.score.min</code> : Score minimum possible (0)</li>
                            <li><code>cmi.score.max</code> : Score maximum possible (100)</li>
                            <li><code>cmi.score.scaled</code> : Score normalisé entre 0 et 1</li>
                            <li><code>cmi.completion_status</code> : État d'achèvement ("completed", "incomplete", "not attempted")</li>
                            <li><code>cmi.success_status</code> : Résultat pédagogique ("passed", "failed", "unknown")</li>
                            <li><code>cmi.session_time</code> : Durée de la session (format PTxHxMxS)</li>
                        </ul>
                        
                        <p><strong>Remarque:</strong> Le seuil de réussite défini sera utilisé pour déterminer le statut "passed"/"failed".</p>
                    </div>
                </div>
                
                <div class="scorm-details" style="margin-top: 20px;">
                    <h4>Fonctionnement avec Moodle 4.1</h4>
                    <p>L'intégration SCORM avec Moodle 4.1 permet de:</p>
                    <ul>
                        <li>Afficher le score dans le carnet de notes Moodle</li>
                        <li>Marquer l'activité comme complète automatiquement</li>
                        <li>Suivre le temps passé par l'étudiant sur l'activité</li>
                        <li>Obtenir des rapports détaillés sur les performances</li>
                    </ul>
                    
                    <p><strong>Pour déployer:</strong></p>
                    <ul>
                        <li>L'application générée créera un fichier ZIP conforme aux spécifications SCORM</li>
                        <li>Importez ce fichier ZIP comme activité SCORM dans votre cours Moodle</li>
                        <li>Configurez les options de suivi dans les paramètres de l'activité Moodle</li>
                    </ul>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-5"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-5"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 6: Prompt (renamed from Tab 5) -->
        <div id="tab-content-6" class="tab-content">
            <h2 class="step-title">Étape 6: Génération et utilisation du prompt</h2>
            
            <div class="buttons" style="margin-bottom: 20px">
                <button 
                    class="btn btn-primary" 
                    id="generate-prompt-btn"
                >
                    <i class="fas fa-wand-magic-sparkles"></i> Générer le prompt
                </button>
                <button 
                    class="btn btn-special" 
                    id="copy-prompt-btn"
                >
                    <i class="fas fa-copy"></i> Copier le prompt
                </button>
                <button 
                    class="btn btn-secondary" 
                    id="download-prompt-btn"
                >
                    <i class="fas fa-download"></i> Télécharger le prompt
                </button>
                <button 
                    class="btn btn-special" 
                    id="enrich-prompt-btn"
                >
                    <i class="fas fa-wand-magic-sparkles"></i> Enrichir le prompt avec l'IA
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="prompt-template">Optimiser le prompt pour:</label>
                <select 
                    id="prompt-template" 
                    class="form-select"
                >
                    <option value="accuracy" selected>Précision (priorité au contenu éducatif)</option>
                    <option value="design">Design (priorité à l'apparence)</option>
                    <option value="features">Fonctionnalités (priorité aux fonctions avancées)</option>
                    <option value="balanced">Équilibré</option>
                    <option value="technical">Détails techniques (code HTML/CSS/JS)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="include-code">Inclure le code technique:</label>
                <select 
                    id="include-code" 
                    class="form-select"
                >
                    <option value="yes" selected>Oui, inclure le code HTML/CSS/JS</option>
                    <option value="no">Non, seulement les instructions générales</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="additional-instructions">Instructions supplémentaires (optionnel):</label>
                <textarea 
                    id="additional-instructions" 
                    class="form-textarea" 
                    placeholder="Ex: Ajouter une fonctionnalité de recherche de questions par mot-clé"
                ></textarea>
            </div>
            
            <div class="form-group">
                <div class="preview-container">
                    <div class="preview-header">
                        <h3>Prompt généré</h3>
                        <div>
                            <button 
                                class="btn btn-special" 
                                id="toggle-technical-btn" 
                                title="Afficher/masquer les sections techniques"
                            >
                                <i class="fas fa-code"></i> Afficher sections techniques
                            </button>
                        </div>
                    </div>
                    <div class="preview-content" id="prompt-preview">
                        Le prompt sera généré ici...
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <div class="info-container">
                    <h3>Comment utiliser ce prompt?</h3>
                    <ol>
                        <li>Copiez le prompt généré en utilisant le bouton "Copier le prompt"</li>
                        <li>Rendez-vous sur l'interface de votre IA préférée (Claude, ChatGPT, etc.)</li>
                        <li>Collez le prompt dans la zone de texte</li>
                        <li>Envoyez le message et attendez que l'IA génère votre application de QCM</li>
                        <li>Copiez le code généré dans un fichier HTML et ouvrez-le dans votre navigateur</li>
                        <li>Pour une utilisation avec Moodle, créez un package SCORM avec les fichiers générés</li>
                    </ol>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-6"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="open-claude-btn"
                >
                    <i class="fas fa-robot"></i> Ouvrir Claude
                </button>
                <button 
                    class="btn btn-secondary" 
                    id="open-chatgpt-btn"
                >
                    <i class="fas fa-comment-dots"></i> Ouvrir ChatGPT
                </button>
                <button 
                    class="btn btn-special" 
                    id="open-mistral-btn"
                >
                    <i class="fas fa-cloud"></i> Ouvrir MistralAI
                </button>
                <button 
                    class="btn btn-secondary" 
                    id="open-gemini-btn"
                >
                    <i class="fas fa-globe"></i> Ouvrir Gemini
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour IA & API -->
    <div id="ia-api-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-ia-api-modal">&times;</span>
            <h2>Intégration intelligence artificielle</h2>
            <p>Configurez vos clés API pour profiter des fonctionnalités d'IA dans la création de vos scénarios pédagogiques.</p>

            <div class="tools-container">
                <!-- Colonne des services d'IA -->
                <div class="resources-column">
                    <div class="column-title">
                        <h3>Services d'IA disponibles</h3>
                    </div>
                    
                    <!-- Anthropic Claude -->
                    <div class="api-config-section">
                        <div class="api-header">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Anthropic_logo.svg/1200px-Anthropic_logo.svg.png" alt="Anthropic Logo" width="30" height="30" style="margin-right: 10px;">
                            <h4>Anthropic Claude</h4>
                        </div>
                        <div class="api-input-group">
                            <label for="claude-api-key">Clé API:</label>
                            <div class="api-input-wrapper">
                                <input type="password" id="claude-api-key" placeholder="Collez votre clé API Claude ici..." />
                                <button class="toggle-visibility-btn" data-target="claude-api-key"><i class="fas fa-eye"></i></button>
                            </div>
                            <span class="api-format-info">Format: sk-ant-apiXXX-XXX...</span>
                        </div>
                        <div class="api-model-select">
                            <label for="claude-model">Modèle:</label>
                            <select id="claude-model">
                                <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (dernière version)</option>
                                <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                            </select>
                        </div>
                        <button class="btn test-api-btn" data-service="claude">Tester la connexion</button>
                        <div class="api-status" id="claude-api-status"></div>
                    </div>
                    
                    <!-- OpenAI -->
                    <div class="api-config-section">
                        <div class="api-header">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/OpenAI_Logo.svg/1024px-OpenAI_Logo.svg.png" alt="OpenAI Logo" width="30" height="30" style="margin-right: 10px;">
                            <h4>OpenAI</h4>
                        </div>
                        <div class="api-input-group">
                            <label for="openai-api-key">Clé API:</label>
                            <div class="api-input-wrapper">
                                <input type="password" id="openai-api-key" placeholder="Collez votre clé API OpenAI ici..." />
                                <button class="toggle-visibility-btn" data-target="openai-api-key"><i class="fas fa-eye"></i></button>
                            </div>
                            <span class="api-format-info">Format: sk-xxxxxxxxxxxxx...</span>
                        </div>
                        <div class="api-model-select">
                            <label for="openai-model">Modèle:</label>
                            <select id="openai-model">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        <button class="btn test-api-btn" data-service="openai">Tester la connexion</button>
                        <div class="api-status" id="openai-api-status"></div>
                    </div>
                    
                    <!-- Mistral AI -->
                    <div class="api-config-section">
                        <div class="api-header">
                            <img src="https://avatars.githubusercontent.com/u/139895814" alt="Mistral AI Logo" width="30" height="30" style="margin-right: 10px;">
                            <h4>Mistral AI</h4>
                        </div>
                        <div class="api-input-group">
                            <label for="mistral-api-key">Clé API:</label>
                            <div class="api-input-wrapper">
                                <input type="password" id="mistral-api-key" placeholder="Collez votre clé API Mistral ici..." />
                                <button class="toggle-visibility-btn" data-target="mistral-api-key"><i class="fas fa-eye"></i></button>
                            </div>
                            <span class="api-format-info">Format: ag:xxxxx:date:name:hash</span>
                        </div>
                        <div class="api-model-select">
                            <label for="mistral-model">Modèle:</label>
                            <select id="mistral-model">
                                <option value="mistral-large-latest">Mistral Large</option>
                                <option value="mistral-medium-latest">Mistral Medium</option>
                                <option value="mistral-small-latest">Mistral Small</option>
                            </select>
                        </div>
                        <button class="btn test-api-btn" data-service="mistral">Tester la connexion</button>
                        <div class="api-status" id="mistral-api-status"></div>
                    </div>
                </div>
                
                <!-- Colonne de test API -->
                <div class="activities-column">
                    <div class="column-title">
                        <h3>Test des API</h3>
                    </div>
                    
                    <div class="api-test-panel">
                        <p>Vérifiez le fonctionnement de vos connexions API en testant une requête simple.</p>
                        
                        <div class="api-test-form">
                            <div class="form-group">
                                <label for="test-service">Service à tester:</label>
                                <select id="test-service">
                                    <option value="claude">Anthropic Claude</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="mistral">Mistral AI</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="test-prompt">Prompt de test:</label>
                                <textarea id="test-prompt" rows="4" placeholder="Entrez un prompt de test ici...">Génère 3 idées de scénarios pédagogiques pour un cours de mathématiques niveau collège.</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="test-temperature">Température:</label>
                                <input type="range" id="test-temperature" min="0" max="1" step="0.1" value="0.7" />
                                <span id="temperature-value">0.7</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="test-tokens">Longueur maximale (tokens):</label>
                                <input type="number" id="test-tokens" min="100" max="4000" value="1000" />
                            </div>
                            
                            <button class="btn" id="run-test-btn">Exécuter le test</button>
                        </div>
                        
                        <div class="api-test-result">
                            <div class="result-header">
                                <h4>Résultat</h4>
                                <div class="result-controls" style="display: none;">
                                    <button id="copy-result-btn" title="Copier"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div id="loading-spinner" style="display: none;">
                                <div class="spinner"></div>
                                <p>Requête en cours...</p>
                            </div>
                            <div id="test-result" class="result-content">
                                <p class="placeholder-text">Le résultat de votre test apparaîtra ici...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-buttons">
                <button class="btn" id="save-api-settings">Enregistrer les configurations</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">Opération réussie!</div>

    <script>
        // Variables d'état globales
        let appState = {
            activeTab: 1,
            appTitle: "QCMaster - Système d'évaluation et Certification",
            appSubtitle: "Questionnaires à choix multiples et certification des compétences",
            appAuthor: "@qcmcert",
            domain: "mathematiques",
            enableMathJax: "yes",
            customDomain: "",
            selectedLevels: ["3ème"],
            questionsTotal: 20,
            questionsPerTest: 10,
            optionsPerQuestion: 4,
            correctAnswersAllowed: "single",
            categoriesEnabled: "no",
            categories: [""],
            maxAttempts: 3,
            pointsCorrect: "1",
            pointsPenalty: "0",
            disableOtherOptions: true,
            successThreshold: "70",
            feedbackType: "immediate",
            correctionEnabled: "yes",
            correctionPrint: true,
            correctionPdf: true,
            correctionJpg: false,
            correctionAfterCompletion: true,
            contentTheme: "",
            exampleQuestions: "",
            responseOptions: "",
            feedbackFormat: "standard",
            qcmStyle: "modern",
            transitionAnimation: "slide",
            primaryColor: "orange",
            interfaceStyle: "tabs",
            progressDisplay: "bar",
            customStyles: "",
            certificateEnabled: "yes",
            certificateTitle: "Certificat de Réussite",
            certificateStyle: "modern",
            certificateInfo: "name-class",
            certificateExport: "print-pdf",
            autoDateCertificate: true,
            showDetailedScores: "yes",
            aiProvider: "anthropic",
            apiIntegration: "prompt-only",
            apiKey: "",
            apiModel: "claude-3-7-sonnet-20250219",
            promptTemplate: "accuracy",
            includeCode: "yes",
            additionalInstructions: "",
            showTechnicalSections: true,
            promptResult: "",
            showQcmCount: true,
            
            // SCORM Integration Settings
            scormEnabled: "yes",
            scormVersion: "2004",
            transmitScore: true,
            transmitCompletion: true,
            transmitSuccess: true,
            transmitTime: true,
            transmitInteractions: false,
            autoSave: true,
            autoSaveFrequency: "score",
            debugMode: false,
            
            // Question Generation State
            variationsCount: 5,
            numberingFormat: "simple",
            customNumberingFormat: "Question-{n}",
            contexts: [],
            variables: [],
            feedbackTemplates: {
                correct: 'Excellent! Cette réponse est correcte car [explication]. Ce concept est important pour [application].',
                incorrect: 'Cette réponse n\'est pas correcte. Rappelez-vous que [principe correct]. L\'erreur commune ici est de [malentendu fréquent].',
                general: 'Cette question porte sur un concept important du chapitre [chapitre/thème]. Assurez-vous de bien comprendre les principes fondamentaux avant de continuer.'
            },
            generationPrompt: "",
            generatedQuestions: [],
            activeQuestionIndex: -1,
            maxTokens: 4000,
            questionId: "QCM-001"
        };

        // API state
        const apiState = {
            apiConfig: {
                claude: {
                    key: '',
                    model: 'claude-3-7-sonnet-20250219'
                },
                openai: {
                    key: '',
                    model: 'gpt-4o'
                },
                mistral: {
                    key: '',
                    model: 'mistral-large-latest'
                }
            },
            defaultAIService: 'claude'
        };

        // Vérifier si au moins une API est configurée
        function isAnyAPIConfigured() {
            return apiState.apiConfig.claude.key || 
                  apiState.apiConfig.openai.key || 
                  apiState.apiConfig.mistral.key;
        }

        // Fonction pour afficher une notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Fonction pour changer d'onglet
        function changeTab(tabNumber) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Désactiver tous les boutons d'onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.getElementById(`tab-content-${tabNumber}`).classList.add('active');
            document.querySelector(`.tab-${tabNumber}`).classList.add('active');
            
            appState.activeTab = tabNumber;
        }


		// Fonction pour échapper les expressions LaTeX dans le contenu
		function escapeLaTeXDelimiters(content) {
			if (!content) return content;
			
			// Remplacer \( par \\( et \) par \\)
			return content.replace(/\\\(/g, '\\\\(')
						  .replace(/\\\)/g, '\\\\)')
						  .replace(/\\\[/g, '\\\\[')
						  .replace(/\\\]/g, '\\\\]');
		}
		
		// Fonction pour ajouter la section MathJax au prompt
		function addMathJaxSection() {
			return `\
		## SUPPORT DES EXPRESSIONS MATHÉMATIQUES ##
		
		IMPORTANT: L'application doit prendre en charge l'affichage correct des expressions mathématiques en notation LaTeX.
		
		### Implémentation requise:
		1. Ajouter MathJax à l'application via CDN:
		\`\`\`html
		<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
		<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
		\`\`\`
		
		2. Les expressions mathématiques dans les questions et réponses seront délimitées par les balises \\\\( ... \\\\) pour les expressions en ligne ou \\\\[ ... \\\\] pour les équations centrées.
		
		3. ATTENTION AUX BALISES: Dans ce prompt, toutes les expressions LaTeX ont été désactivées en ajoutant un caractère d'échappement \\\\ avant les délimiteurs pour éviter les conflits d'interprétation. Par exemple, "\\\\\\\\( f(x) = x^2 \\\\\\\\)" doit être traité comme "\\\\( f(x) = x^2 \\\\)" dans l'application générée.
		
		4. Assurer que MathJax est correctement initialisé et qu'il traite dynamiquement les expressions mathématiques lors des changements de questions ou d'options.
		
		### Test de validation:
		L'application doit être en mesure d'afficher correctement les formules suivantes:
		- Expressions simples: \\\\\\\\( x^2 + 2x + 1 \\\\\\\\)
		- Fractions: \\\\\\\\( \\\\frac{a}{b} \\\\\\\\)
		- Racines: \\\\\\\\( \\\\sqrt{2} \\\\\\\\)
		- Indices et exposants: \\\\\\\\( a_n^m \\\\\\\\)
		- Intégrales: \\\\\\\\( \\\\int_a^b f(x) dx \\\\\\\\)`;
		}

        // Fonction pour ajouter la section SCORM au prompt
        function addSCORMSection() {
            const scormVersion = appState.scormVersion;
            let scormSection = '';
            
            if (appState.scormEnabled === 'yes') {
                scormSection = `
## INTÉGRATION SCORM POUR MOODLE 4.1 ##
PRIORITE MAXIMALE : INTEGRATION SCORM
IMPORTANT : le score doit être régulièrement enregistré dans l'application afin d' être mis à jour pour la dernière validation avant transmission par scorm 
### Configuration SCORM
- Version SCORM: ${scormVersion === '2004' ? 'SCORM 2004 (3ème édition)' : 'SCORM 1.2'}
- Données à transmettre: ${[
    appState.transmitScore ? 'Score' : '',
    appState.transmitCompletion ? 'État d\'achèvement' : '',
    appState.transmitSuccess ? 'Statut de réussite' : '',
    appState.transmitTime ? 'Temps de session' : '',
    appState.transmitInteractions ? 'Interactions (réponses aux questions)' : ''
].filter(item => item !== '').join(', ')}
- Auto-enregistrement: ${appState.autoSave ? `Activé (${getAutoSaveFrequencyDisplay(appState.autoSaveFrequency)})` : 'Désactivé'}
- Mode débogage: ${appState.debugMode ? 'Activé' : 'Désactivé'}


## GESTION DES MEILLEURES NOTES (PRIORITÉ MAXIMALE) ##

IMPORTANT: L'application DOIT conserver et transmettre uniquement la meilleure note obtenue parmi toutes les tentatives.

Implémentation technique requise:
1. Ajouter un système de stockage des scores précédents:
javascript
// Stocker le meilleur score dans le SCORM
let bestScore = 0;

// Fonction pour initialiser le meilleur score au démarrage
function initBestScore() {
    if (scormVersion === "1.2" && API) {
        const storedScore = getValue("cmi.core.score.raw");
        bestScore = storedScore ? parseFloat(storedScore) : 0;
    } else if (scormVersion === "2004" && API_1484_11) {
        const storedScore = getValue("cmi.score.raw");
        bestScore = storedScore ? parseFloat(storedScore) : 0;
    }
    return bestScore;
}

// Modifier la fonction sendScore pour ne transmettre que la meilleure note
function sendScore(score) {
    // Récupérer d'abord le meilleur score précédent
    if (bestScore === 0) {
        initBestScore();
    }
    
    // Normaliser le score entre 0 et 100
    const normalizedScore = Math.min(Math.max(score, 0), 100);
    
    // Ne mettre à jour que si le nouveau score est meilleur
    if (normalizedScore > bestScore) {
        bestScore = normalizedScore;
        
        // Enregistrer le nouveau meilleur score
        if (scormVersion === "1.2") {
            // SCORM 1.2
            setValue("cmi.core.score.raw", bestScore);
            
            // Statut de réussite basé sur le seuil
            const passed = bestScore >= ${appState.successThreshold};
            setValue("cmi.core.lesson_status", passed ? "passed" : "failed");
        } else {
            // SCORM 2004
            setValue("cmi.score.raw", bestScore);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", bestScore / 100);
            
            // Statut d'achèvement et de réussite
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", bestScore >= ${appState.successThreshold} ? "passed" : "failed");
        }
        
        // Commit des changements
        commitSCORM();
    }
    
    return bestScore;
}



### IMPLEMENTATION TECHNIQUE REQUISE POUR LE SCORM
1. Initialisation de l'API SCORM:
\`\`\`javascript
// Initialisation SCORM
let API = null;
let API_1484_11 = null;

function findAPI(win) {
    // Recherche de l'API SCORM dans la fenêtre parente
    if (win.API && win.API !== null && (scormVersion === "1.2")) return win.API;
    if (win.API_1484_11 && win.API_1484_11 !== null && (scormVersion === "2004")) return win.API_1484_11;
    
    // Si l'API n'est pas trouvée et que nous n'avons pas atteint la fenêtre principale, 
    // continuons la recherche dans la fenêtre parente
    if (win.parent && win.parent !== win) {
        return findAPI(win.parent);
    }
    return null;
}

function initSCORM() {
    // Récupérer la référence à l'API SCORM du LMS
    if (scormVersion === "1.2") {
        API = findAPI(window);
        if (API) {
            API.LMSInitialize("");
            ${appState.debugMode ? 'console.log("SCORM 1.2 API initialisée");' : ''}
        } else {
            ${appState.debugMode ? 'console.warn("API SCORM 1.2 non trouvée");' : ''}
        }
    } else { // SCORM 2004
        API_1484_11 = findAPI(window);
        if (API_1484_11) {
            API_1484_11.Initialize("");
            ${appState.debugMode ? 'console.log("SCORM 2004 API initialisée");' : ''}
        } else {
            ${appState.debugMode ? 'console.warn("API SCORM 2004 non trouvée");' : ''}
        }
    }
}

function setValue(element, value) {
    if (scormVersion === "1.2" && API) {
        return API.LMSSetValue(element, value);
    } else if (scormVersion === "2004" && API_1484_11) {
        return API_1484_11.SetValue(element, value);
    }
    return false;
}

function getValue(element) {
    if (scormVersion === "1.2" && API) {
        return API.LMSGetValue(element);
    } else if (scormVersion === "2004" && API_1484_11) {
        return API_1484_11.GetValue(element);
    }
    return "";
}

function commitSCORM() {
    if (scormVersion === "1.2" && API) {
        return API.LMSCommit("");
    } else if (scormVersion === "2004" && API_1484_11) {
        return API_1484_11.Commit("");
    }
    return false;
}

function terminateSCORM() {
    if (scormVersion === "1.2" && API) {
        API.LMSCommit("");
        API.LMSFinish("");
        ${appState.debugMode ? 'console.log("Session SCORM 1.2 terminée");' : ''}
    } else if (scormVersion === "2004" && API_1484_11) {
        API_1484_11.Commit("");
        API_1484_11.Terminate("");
        ${appState.debugMode ? 'console.log("Session SCORM 2004 terminée");' : ''}
    }
}

// Appeler initSCORM() au chargement
window.addEventListener('load', initSCORM);
// Ajouter un gestionnaire pour terminateSCORM() avant déchargement
window.addEventListener('beforeunload', terminateSCORM);
\`\`\`

2. Envoi du score et de l'état d'achèvement:
\`\`\`javascript
function sendScore(score) {
    // Normaliser le score entre 0 et 100
    const normalizedScore = Math.min(Math.max(score, 0), 100);
    
    ${appState.debugMode ? 'console.log("Envoi du score:", normalizedScore);' : ''}
    
    if (scormVersion === "1.2") {
        // SCORM 1.2
        setValue("cmi.core.score.raw", normalizedScore);
        
        // Statut de réussite basé sur le seuil
        const passed = normalizedScore >= ${appState.successThreshold};
        setValue("cmi.core.lesson_status", passed ? "passed" : "failed");
    } else {
        // SCORM 2004
        setValue("cmi.score.raw", normalizedScore);
        setValue("cmi.score.min", "0");
        setValue("cmi.score.max", "100");
        setValue("cmi.score.scaled", normalizedScore / 100);
        
        // Statut d'achèvement et de réussite
        setValue("cmi.completion_status", "completed");
        setValue("cmi.success_status", normalizedScore >= ${appState.successThreshold} ? "passed" : "failed");
    }
    
    // Commit des changements
    commitSCORM();
}

function formatScormTime(ms) {
    // Convertir ms en heures, minutes, secondes
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    if (scormVersion === "1.2") {
        // Format SCORM 1.2: HH:MM:SS
        return \`\${hours.toString().padStart(2, '0')}:\${minutes.toString().padStart(2, '0')}:\${seconds.toString().padStart(2, '0')}\`;
    } else {
        // Format SCORM 2004: PTxHxMxS
        return \`PT\${hours}H\${minutes}M\${seconds}S\`;
    }
}

function sendSessionTime(startTime) {
    const sessionTime = Date.now() - startTime;
    const formattedTime = formatScormTime(sessionTime);
    
    ${appState.debugMode ? 'console.log("Envoi du temps de session:", formattedTime);' : ''}
    
    if (scormVersion === "1.2") {
        setValue("cmi.core.session_time", formattedTime);
    } else {
        setValue("cmi.session_time", formattedTime);
    }
    
    commitSCORM();
}

${appState.transmitInteractions ? `
function sendInteraction(id, type, studentResponse, result, description) {
    const interactionIndex = getNextInteractionIndex();
    
    ${appState.debugMode ? 'console.log("Envoi de l\'interaction:", id, type, studentResponse, result);' : ''}
    
    if (scormVersion === "1.2") {
        setValue(\`cmi.interactions.\${interactionIndex}.id\`, id);
        setValue(\`cmi.interactions.\${interactionIndex}.type\`, type);
        setValue(\`cmi.interactions.\${interactionIndex}.student_response\`, studentResponse);
        setValue(\`cmi.interactions.\${interactionIndex}.result\`, result);
        setValue(\`cmi.interactions.\${interactionIndex}.description\`, description);
    } else {
        setValue(\`cmi.interactions.\${interactionIndex}.id\`, id);
        setValue(\`cmi.interactions.\${interactionIndex}.type\`, type);
        setValue(\`cmi.interactions.\${interactionIndex}.learner_response\`, studentResponse);
        setValue(\`cmi.interactions.\${interactionIndex}.result\`, result);
        setValue(\`cmi.interactions.\${interactionIndex}.description\`, description);
    }
    
    commitSCORM();
}

function getNextInteractionIndex() {
    const countStr = scormVersion === "1.2" 
        ? getValue("cmi.interactions._count") 
        : getValue("cmi.interactions._count");
    
    return parseInt(countStr || "0");
}` : ''}
\`\`\`

3. Exemples d'utilisation dans l'application QCM:
\`\`\`javascript
// Variables pour suivre l'état du QCM
const startTime = Date.now();
let currentScore = 0;
let testCompleted = false;

// À la fin du test
function finishTest(finalScore, isPassed) {
    if (testCompleted) return; // Éviter les appels multiples
    
    testCompleted = true;
    currentScore = finalScore;
    
    // Envoyer le score final
    sendScore(finalScore);
    
    // Envoyer le temps de session
    sendSessionTime(startTime);
    
    // Fournir un feedback à l'utilisateur
    displayResults(finalScore, isPassed);
}

// Configuration de l'auto-enregistrement
${appState.autoSave ? `
${appState.autoSaveFrequency === 'question' ? `
// Auto-enregistrement à chaque question répondue
function onQuestionAnswered(score) {
    currentScore = score;
    sendScore(score);
}` : ''}

${appState.autoSaveFrequency === 'score' ? `
// Auto-enregistrement à chaque changement de score
function updateScore(newScore) {
    if (newScore !== currentScore) {
        currentScore = newScore;
        sendScore(newScore);
    }
}` : ''}

${appState.autoSaveFrequency === 'minutes' ? `
// Auto-enregistrement toutes les 5 minutes
setInterval(() => {
    sendScore(currentScore);
    sendSessionTime(startTime);
    ${appState.debugMode ? 'console.log("Auto-enregistrement SCORM effectué");' : ''}
}, 5 * 60 * 1000);` : ''}` : ''}
\`\`\`

### Création du package SCORM
L'application générée doit inclure tous les fichiers nécessaires pour créer un package SCORM conforme:

1. Structure du package SCORM ${scormVersion === '2004' ? '2004' : '1.2'}:
   - Un fichier imsmanifest.xml à la racine
   - Tous les fichiers HTML, CSS et JavaScript de l'application
   - Les fichiers de schéma XSD/DTD dans un dossier approprié

2. Le fichier manifest doit déclarer:
   - Métadonnées (titre, description)
   - Ressources (fichiers de l'application)
   - Organisations (structure du contenu)
   - ${scormVersion === '2004' ? 'Séquencement (règles de progression)' : ''}

3. L'application doit être à usage unique dans Moodle:
   - Le SCO doit charger l'interface complète
   - Toute la logique de navigation doit être gérée dans l'application

ATTENTION: CETTE FONCTIONNALITÉ EST DE PRIORITÉ ABSOLUE. L'application DOIT être conforme et fonctionnelle dans un environnement Moodle 4.1 en tant que package SCORM.`;
            }
            
            return scormSection;
        }




        // Fonction pour générer le prompt
        function generatePrompt() {
            const levelText = appState.selectedLevels.join(", ");
            const domainText = appState.domain === 'custom' ? appState.customDomain : getDomainDisplay(appState.domain);
            
            // Texte pour le nombre de QCM possibles
            let qcmCountText = "";
            if ((parseInt(appState.questionsTotal) > 20 || parseInt(appState.questionsTotal)/parseInt(appState.questionsPerTest) > 1.5)) {
                const count = Math.floor(parseInt(appState.questionsTotal)/parseInt(appState.questionsPerTest));
                qcmCountText = `- Nombre approximatif de QCM distincts possibles: ${count}\n`;
                
                if (appState.showQcmCount) {
                    qcmCountText += `- Afficher ce nombre en page d'accueil: Oui\n`;
                } else {
                    qcmCountText += `- Afficher ce nombre en page d'accueil: Non\n`;
                }
            }
            
            
			// ATexte pour le comportement de désactivation des options
			let optionBehaviorText = "";
			if (appState.disableOtherOptions && (appState.correctAnswersAllowed === 'single')) {
				optionBehaviorText = `
		- Comportement d'interaction: Lorsqu'une option est sélectionnée, les autres options sont automatiquement désactivées et grisées
		- Implémentation technique: Ajouter un gestionnaire d'événements qui désactive visuellement et fonctionnellement les autres options`;
			}
            
            
            
            // Texte pour la date automatique
            let dateAutoText = "";
            if (appState.autoDateCertificate) {
                dateAutoText = "- Ajout automatique de la date du jour\n";
            }
            
            // Texte pour l'accès au corrigé
            let correctionAccessText = "";
            if (appState.correctionAfterCompletion) {
                correctionAccessText = "- PRIORITE HAUTE : Ne fournir le corrigé qu'après toutes les tentatives ou réussite\n";
            }
            
            // Texte pour les catégories
            let categoriesText = "";
            if (appState.categoriesEnabled === 'yes' && appState.categories.filter(c => c.trim()).length > 0) {
                categoriesText = `${appState.categories.filter(c => c.trim()).join(", ")}`;
            }
            
            // Texte pour le thème spécifique
            let contentThemeText = "";
            if (appState.contentTheme) {
                contentThemeText = `${appState.contentTheme}`;
            }
            
            // Texte pour les exemples de questions
            let examplesText = "";
            if (appState.exampleQuestions) {
                examplesText = `\n\n${appState.exampleQuestions}`;
            }
            
            // Texte pour les styles CSS personnalisés
            let customStylesText = "";
            if (appState.customStyles) {
                customStylesText = `- Styles CSS personnalisés inclus\n`;
            }
            
            // Section pour le corrigé
            let correctionText = "";
            if (appState.correctionEnabled === 'yes') {
                const optionsText = [];
                if (appState.correctionPrint) optionsText.push("impression");
                if (appState.correctionPdf) optionsText.push("PDF");
                if (appState.correctionJpg) optionsText.push("JPEG");
                
                correctionText = `
## 6. SYSTÈME DE CORRIGÉ ##
### 6.1 Contenu du corrigé
- Détails: Pour chaque question, inclure l'énoncé, toutes les options, la réponse correcte et l'explication détaillée
- Format: Présentation claire et structurée avec mise en évidence des éléments importants
- Ressources: Inclure des références ou ressources complémentaires quand pertinent
- IMPORTANT ! Ne pas donner le corrigé avant d'avoir fini toutes les tentatives

### 6.2 Options d'exportation
${optionsText.map(opt => `- ${opt.charAt(0).toUpperCase() + opt.slice(1)}: Format optimisé pour ${opt}\n`).join('')}
- Présentation: Mise en page soignée avec en-tête, pied de page et numérotation
${appState.correctionAfterCompletion ? '- Accès: Le corrigé ne sera accessible qu\'après utilisation de toutes les tentatives ou atteinte du seuil de réussite\n' : '- Accès: Le corrigé est accessible à tout moment'}`;
            }
            
            // Section pour le certificat
            let certificateText = "";
            if (appState.certificateEnabled === 'yes') {
                certificateText = `
## 7. SYSTÈME DE CERTIFICATION (PRIORITE MAXIMALE) ##
### 7.1 Conception du certificat
- Titre: "${appState.certificateTitle}"
- Style: ${getCertificateStyleDisplay(appState.certificateStyle)} avec cohérence visuelle par rapport à l'application
- Présentation: Design professionnel avec éléments décoratifs appropriés
- Couleurs: Harmonie avec le thème principal de l'application mais aspect officiel

### 7.2 Contenu du certificat
- Informations personnelles: ${getCertificateInfoDisplay(appState.certificateInfo)}
- Domaine: Mention claire de "${domainText}" et du niveau "${levelText}"
- Résultat: Affichage du score final en pourcentage et en points
${appState.showDetailedScores === 'yes' ? '- Détails: Tableau des scores par catégorie ou compétence\n' : ''}${appState.autoDateCertificate ? '- Date: Insertion automatique de la date du jour\n' : ''}
- Signatures: Zones pour signature électronique de l'évaluateur et de l'élève

### 7.3 Options d'exportation
- Formats disponibles: ${getCertificateExportDisplay(appState.certificateExport)}
- Protection: Certificat avec éléments de sécurité (QR code ou identifiant unique)
- Partage: Options pour partager directement le certificat par e-mail ou réseaux sociaux`;
            }
            
            // Section dédiée au feedback
            const feedbackSection = `
## 4. SYSTÈME DE FEED-BACK ##
### 4.1 Configuration du feed-back
- Moment d'affichage: ${getFeedbackTypeDisplay(appState.feedbackType)}
- Format du feed-back: ${getFeedbackFormatDisplay(appState.feedbackFormat)}
- Objectif pédagogique: Le feed-back doit être instructif et encourager l'apprentissage

### 4.2 Templates de feed-back (À IMPLÉMENTER EXACTEMENT COMME SPÉCIFIÉ)
- Pour réponses correctes:
\`\`\`
${appState.feedbackTemplates.correct}
\`\`\`
- Pour réponses incorrectes:
\`\`\`
${appState.feedbackTemplates.incorrect}
\`\`\`
- Feed-back général:
\`\`\`
${appState.feedbackTemplates.general}
\`\`\`

### 4.3 Implémentation des templates
- Personnalisation: Remplacer les placeholders [explication], [principe correct], etc. par du contenu pertinent pour chaque question
- Adaptation: Le feed-back doit toujours être adapté au niveau scolaire et à la difficulté de la question
- Ton: Utiliser un ton encourageant même pour les réponses incorrectes`;
            
            // Section pour la génération de questions
            let questionGenerationText = "";
            if (appState.variationsCount > 0 || appState.contexts.length > 0 || appState.variables.length > 0) {
                questionGenerationText = `
## 8. GÉNÉRATION DE QUESTIONS ##
### 8.1 Paramètres de génération
- Variations: ${appState.variationsCount} variations distinctes pour chaque concept
- Numérotation: Format ${getNumberingFormatDisplay(appState.numberingFormat)}${appState.numberingFormat === 'custom' ? ` avec pattern "${appState.customNumberingFormat}"` : ''}`;
                
                if (appState.contexts.length > 0) {
                    questionGenerationText += `\n\n### 8.2 Contextes alternatifs
Les questions doivent être adaptées aux contextes suivants:
${appState.contexts.filter(c => c.trim()).map((ctx, i) => `${i+1}. ${ctx}`).join('\n')}`;
                }
                
                if (appState.variables.length > 0) {
                    questionGenerationText += `\n\n### 8.3 Variables dynamiques
Utiliser ces variables pour créer des variations dans les questions:
${appState.variables.map((v, i) => {
    if (v.type === 'liste') {
        return `- ${v.name}: Sélectionner parmi [${v.list}]`;
    } else {
        return `- ${v.name}: ${v.type} variant entre ${v.min} et ${v.max}`;
    }
}).join('\n')}`;
                }
            }
            
            // Instructions supplémentaires
            let additionalText = "";
            if (appState.additionalInstructions) {
                additionalText = `\n\n## 10. INSTRUCTIONS SUPPLÉMENTAIRES ##\n${appState.additionalInstructions}`;
            }
            
            // Construction du prompt de base avec structure améliorée
            let basePrompt = `# APPLICATION QCM ET CERTIFICATION ÉDUCATIVE

Crée une application web complète de QCM (questionnaire à choix multiples) avec système de certification pour le niveau ${levelText} en ${domainText}.


## 0 EXEMPLE D INTERFACE (PRIORITE HAUTE)

1. En-tête avec fond coloré contenant :
   - Titre H1 : "QCMaster - Système d'évaluation et Certification"
   - Sous-titre : "Questionnaires à choix multiples et certification des compétences"
   - Tag "@auteur" 

2. Barre de navigation avec 4 onglets horizontaux :
   - Accueil (état actif/sélectionné)
   - QCM
   - Résultats
   - Certificat

3. Section principale avec :
   - Titre H2 : "Bienvenue dans QCMaster"
   - Paragraphe : "Cette application vous permet de tester vos connaissances en Sciences Physiques à travers des questionnaires à choix multiples."

4. Tableau à 3 colonnes :
   - Colonne 1 : "Public cible" → "Élèves de niveau ....."
   - Colonne 2 : "Domaine" → "discipline visées"
   - Colonne 3 : "QCM disponibles" → dépend des paramètres choisis

5. Section "Thèmes disponibles" :
   - Thème 1: ....
   - Thème 2: ....

6. Section "Instructions" avec :
   - "Le test comprend 10 questions sélectionnées aléatoirement parmi une banque de 20 questions."
   - "Pour réussir le test et obtenir votre certification, vous devez atteindre un score minimum de 7/10."
   - "Vous disposez de ..... tentatives maximum."

IMPORTANT !!! Style défini selon les paramètres choisis par l'utilisateur


## 1. CONFIGURATION GÉNÉRALE ##
- Titre principal: "${appState.appTitle}"${appState.appSubtitle ? '\n- Sous-titre: "' + appState.appSubtitle + '"' : ''}
- Signature/Auteur: "${appState.appAuthor}"
- Public cible: Élèves de niveau ${levelText}
- Domaine d'enseignement: ${domainText}
${qcmCountText}

## 2. SYSTÈME DE QUESTIONS ##
### 2.1 Paramètres généraux
- Base de données: Générer précisément ${appState.questionsTotal} questions uniques et diversifiées
- Test individuel: Présenter exactement ${appState.questionsPerTest} questions par test (sélection aléatoire à chaque tentative)
- Présentation: Afficher une question à la fois avec navigation intuitive entre questions
- Ordre: Randomiser l'ordre des questions à chaque tentative pour maximiser l'apprentissage

### 2.2 Format des questions
- Format: Questions claires et concises adaptées au niveau ${levelText}
- Options: Exactement ${appState.optionsPerQuestion} options de réponse par question (pas plus, pas moins)
- Réponses: Système à ${getCorrectAnswersDisplay(appState.correctAnswersAllowed)}${optionBehaviorText}
- Qualité: Les options incorrectes doivent être plausibles mais clairement incorrectes

### 2.3 Tentatives et progression
- Limite: Maximum de ${appState.maxAttempts} tentatives par utilisateur
- Suivi: Conserver l'historique des tentatives avec scores et réponses
- Progression: Afficher clairement le nombre de tentatives restantes à l'utilisateur
${appState.categoriesEnabled === 'yes' && categoriesText ? `
### 2.4 Catégories de questions
- Catégories définies: ${categoriesText}
- Répartition: Assurer une distribution équilibrée des questions par catégorie
- Affichage: Indiquer clairement la catégorie de chaque question pendant le test
- Statistiques: Fournir des résultats détaillés par catégorie à la fin` : ''}
${contentThemeText ? `
### 2.5 Thématique spécifique
- Thème précis: ${contentThemeText}
- Consignes: Toutes les questions doivent strictement respecter cette thématique
- Contexte: Adapter le niveau de difficulté au thème spécifié` : ''}

## 3. SYSTÈME DE NOTATION ##
### 3.1 Barème détaillé
- Points positifs: ${appState.pointsCorrect} point(s) par réponse correcte
- Points négatifs: ${appState.pointsPenalty === '0' ? 'Aucune pénalité pour les réponses incorrectes' : 'Pénalité de ' + appState.pointsPenalty + ' point(s) par réponse incorrecte'}
- Système de calcul: Score = (Nombre de bonnes réponses × ${appState.pointsCorrect}) ${appState.pointsPenalty !== '0' ? '- (Nombre de mauvaises réponses × ' + appState.pointsPenalty + ')' : ''}
- Score minimum: 0 point (pas de score négatif possible)
- Score maximum: ${appState.questionsPerTest * parseFloat(appState.pointsCorrect)} points

### 3.2 Seuil et validation
- Seuil de réussite: ${appState.successThreshold}% du score maximum
- Validation: Score minimum requis de ${Math.ceil((appState.questionsPerTest * parseFloat(appState.pointsCorrect) * parseInt(appState.successThreshold)) / 100)} points pour obtenir la certification
- Affichage: Présenter clairement le score requis au début du test
${feedbackSection}

## 5. APPARENCE ET INTERFACE ##
### 5.1 Conception visuelle
- Style global: ${getStyleDisplay(appState.qcmStyle)} 
- Palette: Couleur principale ${getColorDisplay(appState.primaryColor)} avec variations harmonieuses
- Transitions: Animation de type "${getAnimationDisplay(appState.transitionAnimation)}" entre les questions et sections
- Responsive: L'interface doit s'adapter parfaitement à tous les écrans (mobile, tablette, ordinateur)

### 5.2 Structure d'interface
- Organisation: Interface à ${getInterfaceDisplay(appState.interfaceStyle)}
- Navigation: Boutons clairement identifiables pour passer aux questions suivantes/précédentes
- Progression: ${getProgressDisplayDisplay(appState.progressDisplay)} visible en permanence
- Accessibilité: Interface accessible respectant les standards WCAG 2.1
${appState.customStyles ? `
### 5.3 Styles personnalisés
${customStylesText}
- Intégration: Appliquer ces styles tout en conservant la cohérence visuelle globale` : ''}
${correctionText}${certificateText}${questionGenerationText}

${appState.exampleQuestions ? `
## 9. EXEMPLES DE QUESTIONS PRIORITAIRES ##
Les exemples ci-dessous DOIVENT servir de modèles pour toutes les questions générées:
${examplesText}

IMPORTANT: Respecter STRICTEMENT ce format et ce niveau de qualité pour toutes les questions.
` : ''}
${addSCORMSection()}${additionalText}

## CONSIGNES D'IMPLÉMENTATION ##
1. L'application doit être entièrement fonctionnelle dès son chargement
2. Toutes les questions doivent être générées selon les paramètres spécifiés
3. Le système de feed-back doit être implémenté EXACTEMENT comme décrit
4. Les informations de progression doivent être clairement visibles à tout moment
5. L'interface doit être intuitive et fluide pour une expérience utilisateur optimale
6. L'application doit fonctionner en autonomie complète sans dépendances externes
7. Le design doit être cohérent et professionnel de bout en bout
8. Toute question générée doit être pédagogiquement pertinente et adaptée au niveau
9. L'intégration SCORM doit être pleinement fonctionnelle avec Moodle 4.1


## EXPORT DU CERTIFICAT ##

1. Export en PDF si choisi par utilisateur 
2. Export en JPEG si choisi par utilisateur 

## MODE PLEIN ÉCRAN PRIORITAIRE ##

INSTRUCTION CRITIQUE À PRIORITÉ ABSOLUE: L'application DOIT disposer d'un mode plein écran. 
Ajouter une icône simple et élégante en position absolue dans le coin supérieur droit de l'interface permettant de basculer entre le mode plein écran et normal. Cette fonctionnalité est OBLIGATOIRE et doit être implémentée sans option ni réglage supplémentaire. Utiliser l'API Fullscreen pour une compatibilité maximale.

`;

            // Ajout des sections techniques si demandé
            if (appState.includeCode === 'yes' && appState.showTechnicalSections) {
                basePrompt += `

## SPÉCIFICATIONS TECHNIQUES ##

L'application doit être entièrement fonctionnelle et interactive, avec une expérience utilisateur optimale.
Créer une application web complète et autonome avec:
1. Interface utilisateur intuitive et responsive
2. Système de navigation fluide entre les questions
3. Gestion des réponses et du score en temps réel
4. Système de feedback personnalisé
5. Certification et suivi de progression
6. Génération et personnalisation des questions selon les paramètres spécifiés
7. Possibilité d'ajouter, modifier et supprimer des questions manuellement
8. priorite absolue !! Intégration SCORM complète pour Moodle 4.1


PRIORITE HAUTE : Intégrer le nombre maximum de tentatives (MaxAttempts) dans l'implémentation SCORM.
Dans l'implémentation SCORM, veuillez ajouter le code suivant pour gérer le nombre maximum de tentatives:

1. Stocker le nombre de tentatives restantes dans une variable SCORM:
javascript
// Initialiser le nombre de tentatives
function initAttempts() {
    // Récupérer le nombre de tentatives déjà utilisées
    let usedAttempts = 0;
    if (scormVersion === "1.2" && API) {
        usedAttempts = parseInt(getValue("cmi.core.lesson_status") === "not attempted" ? 0 : getValue("cmi.suspend_data") || "0");
    } else if (scormVersion === "2004" && API_1484_11) {
        usedAttempts = parseInt(getValue("cmi.suspend_data") || "0");
    }
    
    // Calculer le nombre de tentatives restantes
    const remainingAttempts = 3 - usedAttempts;
    return { used: usedAttempts, remaining: remainingAttempts };
}

// Incrémenter le compteur de tentatives
function incrementAttempts() {
    let attempts = initAttempts();
    attempts.used++;
    
    // Sauvegarder le nombre de tentatives
    if (scormVersion === "1.2" && API) {
        setValue("cmi.suspend_data", attempts.used.toString());
    } else if (scormVersion === "2004" && API_1484_11) {
        setValue("cmi.suspend_data", attempts.used.toString());
    }
    
    commitSCORM();
    return attempts;
}

2.  Utiliser ces fonctions pour gérer les tentatives dans l'application:

// Au démarrage du test
function startTest() {
    const attempts = initAttempts();
    if (attempts.remaining <= 0) {
        // Afficher un message indiquant que le nombre maximum de tentatives a été atteint
        showMaxAttemptsReached();
        return false;
    }
    
    // Incrémenter le compteur de tentatives
    incrementAttempts();
    
    // Afficher le nombre de tentatives restantes
    showRemainingAttempts(attempts.remaining - 1);
    
    // Démarrer le test
    return true;
}


`;

			// Ajout des sections techniques si demandé
			if (appState.includeCode === 'yes' && appState.showTechnicalSections) {
				// Préparer le code pour la désactivation des options
				let disableOptionsCode = "";
				if (appState.disableOtherOptions && (appState.correctAnswersAllowed === 'single')) {
					disableOptionsCode = `
			
			## CODE DE DÉSACTIVATION DES OPTIONS ##
			
			Implémentation JavaScript pour désactiver les autres options après sélection:
			\`\`\`javascript
			// Fonction pour gérer la sélection exclusive des options
			function setupExclusiveOptionSelection() {
				// Sélectionner toutes les options de réponse
				const optionElements = document.querySelectorAll('.qcm-option');
			
				// Ajouter un gestionnaire d'événements à chaque option
				optionElements.forEach(option => {
					option.addEventListener('click', function() {
						if (this.classList.contains('selected')) return;
						
						// Désélectionner toutes les options et réactiver
						optionElements.forEach(opt => {
							opt.classList.remove('selected');
							opt.classList.remove('disabled');
							opt.removeAttribute('disabled');
							opt.style.opacity = '1';
						});
						
						// Sélectionner l'option courante
						this.classList.add('selected');
						
						// Désactiver les autres options
						optionElements.forEach(opt => {
							if (opt !== this) {
								opt.classList.add('disabled');
								opt.setAttribute('disabled', 'disabled');
								opt.style.opacity = '0.5';
							}
						});
					});
				});
			}
			
			// Appeler la fonction une fois que les options sont chargées
			document.addEventListener('DOMContentLoaded', setupExclusiveOptionSelection);
			// Appeler également après chaque chargement de nouvelle question
			function loadQuestion(questionData) {
				// Code existant pour charger la question
				
				// Une fois les options ajoutées au DOM
				setupExclusiveOptionSelection();
			}
			\`\`\`
			
			Ajoutez également ces styles CSS:
			\`\`\`css
			.qcm-option.disabled {
				cursor: not-allowed;
				opacity: 0.5;
				pointer-events: none;
				transition: opacity 0.3s ease;
			}
			
			.qcm-option.selected {
				font-weight: bold;
				border-color: var(--accent-color);
				background-color: rgba(var(--accent-color-rgb), 0.1);
			}
			\`\`\``;
				}
				
				basePrompt += `
			
			## SPÉCIFICATIONS TECHNIQUES ##
			
			Créer une application web complète et autonome avec:
			1. Interface utilisateur intuitive et responsive
			2. Système de navigation fluide entre les questions
			3. Gestion des réponses et du score en temps réel
			4. Système de feedback personnalisé
			5. Certification et suivi de progression
			6. Génération et personnalisation des questions selon les paramètres spécifiés
			7. Possibilité d'ajouter, modifier et supprimer des questions manuellement
			8. Intégration SCORM complète avec capacité de suivi des scores dans Moodle 4.1
			${appState.disableOtherOptions && (appState.correctAnswersAllowed === 'single') ? '9. Désactivation des autres options après sélection d\'une réponse pour les QCM à réponse unique' : ''}
			
			L'application doit être entièrement fonctionnelle et interactive, avec une expérience utilisateur optimale.${disableOptionsCode}`;
			}
			


            }
            
            
			// Échapper les expressions LaTeX dans les exemples de questions
			if (appState.exampleQuestions) {
				examplesText = escapeLaTeXDelimiters(examplesText);
			}
			
			if (appState.contentTheme) {
				contentThemeText = escapeLaTeXDelimiters(contentThemeText);
			}
			
			// Ajouter la section MathJax avant les consignes d'implémentation
			if (appState.enableMathJax === "yes") {
				basePrompt += addMathJaxSection();
			}
            
            
            
            appState.promptResult = basePrompt;
            document.getElementById('prompt-preview').textContent = basePrompt;
            
            return basePrompt;
        }

        // Helper functions to get display values
        function getDomainDisplay(domain) {
            const domainMap = {
                'mathematiques': 'Mathématiques',
                'physique': 'Sciences Physiques',
                'chimie': 'Chimie',
                'biologie': 'Biologie',
                'histoire': 'Histoire',
                'geographie': 'Géographie',
                'francais': 'Français',
                'langues': 'Langues étrangères',
                'informatique': 'Informatique',
                'economie': 'Économie',
                'philosophie': 'Philosophie',
                'custom': 'Personnalisé'
            };
            return domainMap[domain] || domain;
        }
        
        function getStyleDisplay(style) {
            const styleMap = {
                'classic': 'Classique',
                'modern': 'Moderne',
                'playful': 'Ludique',
                'minimal': 'Minimaliste',
                'gradient': 'Dégradé'
            };
            return styleMap[style] || style;
        }
        
        function getAnimationDisplay(animation) {
            const animationMap = {
                'slide': 'glissement',
                'fade': 'fondu',
                'zoom': 'zoom',
                'none': 'aucune'
            };
            return animationMap[animation] || animation;
        }
        
        function getColorDisplay(color) {
            const colorMap = {
                'orange': 'Orange',
                'blue': 'Bleu',
                'red': 'Rouge',
                'green': 'Vert',
                'purple': 'Violet',
                'teal': 'Turquoise'
            };
            return colorMap[color] || color;
        }
        
        function getInterfaceDisplay(interface) {
            const interfaceMap = {
                'tabs': 'onglets',
                'cards': 'cartes',
                'wizard': 'assistant étape par étape',
                'single-page': 'page unique'
            };
            return interfaceMap[interface] || interface;
        }
        
        function getCertificateStyleDisplay(style) {
            const styleMap = {
                'classic': 'Classique',
                'modern': 'Moderne',
                'elegant': 'Élégant',
                'playful': 'Ludique'
            };
            return styleMap[style] || style;
        }
        
        function getCertificateInfoDisplay(info) {
            const infoMap = {
                'name-only': 'Nom seulement',
                'name-class': 'Nom et classe',
                'full': 'Informations complètes'
            };
            return infoMap[info] || info;
        }
        
        function getCertificateExportDisplay(export_type) {
            const exportMap = {
                'print': 'Impression seulement',
                'print-pdf': 'Impression et PDF',
                'print-pdf-image': 'Impression, PDF et Image'
            };
            return exportMap[export_type] || export_type;
        }
        
        function getCorrectAnswersDisplay(type) {
            const typeMap = {
                'single': 'une seule réponse correcte',
                'multiple': 'plusieurs réponses correctes possibles',
                'variable': 'variable selon la question'
            };
            return typeMap[type] || type;
        }
        
        function getProgressDisplayDisplay(display) {
            const displayMap = {
                'bar': 'barre de progression',
                'numbers': 'compteur numérique',
                'both': 'barre et compteur'
            };
            return displayMap[display] || display;
        }
        
        function getFeedbackTypeDisplay(type) {
            const typeMap = {
                'immediate': 'immédiat après chaque question',
                'end': 'à la fin du test uniquement',
                'both': 'après chaque question et à la fin'
            };
            return typeMap[type] || type;
        }
        
        function getFeedbackFormatDisplay(format) {
            const formatMap = {
                'standard': 'standard (texte explicatif)',
                'detailed': 'détaillé (avec explications et références)',
                'adaptive': 'adaptatif (personnalisé selon la réponse)'
            };
            return formatMap[format] || format;
        }
        
        function getNumberingFormatDisplay(format) {
            const formatMap = {
                'simple': 'Simple (1, 2, 3...)',
                'zero': 'Avec zéro (01, 02, 03...)',
                'three': 'Trois chiffres (001, 002...)',
                'letter': 'Lettres (A, B, C...)',
                'q': 'Format "Q" (Q1, Q2, Q3...)',
                'custom': 'Personnalisé'
            };
            return formatMap[format] || format;
        }
        
        function getAutoSaveFrequencyDisplay(frequency) {
            const frequencyMap = {
                'question': 'à chaque question',
                'score': 'à chaque changement de score',
                'minutes': 'toutes les 5 minutes'
            };
            return frequencyMap[frequency] || frequency;
        }

        // Mettre à jour l'affichage des niveaux sélectionnés
        function updateSelectedLevelsDisplay() {
            const display = document.getElementById('selected-levels-display');
            display.textContent = appState.selectedLevels.length > 0 
                ? 'Niveaux sélectionnés: ' + appState.selectedLevels.join(', ') 
                : 'Aucun niveau sélectionné';
        }

        // Fonction pour gérer les changements de niveaux scolaires
        function handleLevelChange(value, checked) {
            if (checked) {
                if (!appState.selectedLevels.includes(value)) {
                    appState.selectedLevels.push(value);
                }
            } else {
                appState.selectedLevels = appState.selectedLevels.filter(level => level !== value);
            }
            
            updateSelectedLevelsDisplay();
            
            // Mettre à jour le certificat preview
            updateCertificatePreview();
        }

        // Fonction pour mettre à jour l'aperçu du certificat
        function updateCertificatePreview() {
            const preview = document.getElementById('certificate-preview');
            const titleElem = preview.querySelector('h2');
            
            // Mettre à jour le titre
            titleElem.textContent = appState.certificateTitle;
            
            // Mettre à jour le contenu en fonction du domaine
            const domainText = appState.domain === 'custom' ? appState.customDomain : getDomainDisplay(appState.domain);
            preview.querySelectorAll('p')[4].innerHTML = `<strong>${domainText} - ${appState.appTitle}</strong>`;
            
            // Mettre à jour les informations en fonction de l'option sélectionnée
            const classInfo = preview.querySelectorAll('p')[3];
            if (appState.certificateInfo === 'name-only') {
                classInfo.style.display = 'none';
            } else {
                classInfo.style.display = 'block';
            }
            
            // Mettre à jour la signature
            const signatureBox = preview.querySelectorAll('.signature-box')[0];
            signatureBox.querySelectorAll('p')[1].textContent = appState.appAuthor;
            
            // Afficher ou masquer les scores détaillés
            const detailedScores = preview.querySelector('.detailed-scores');
            if (detailedScores) {
                detailedScores.style.display = appState.showDetailedScores === 'yes' ? 'block' : 'none';
            }
        }

        // Fonction pour mettre à jour les détails SCORM
        function updateSCORMDetails() {
            const detailsContainer = document.getElementById('scorm-details-content');
            if (appState.scormVersion === '2004') {
                detailsContainer.innerHTML = `
                <p><strong>Pour SCORM 2004:</strong></p>
                <ul>
                    <li><code>cmi.score.raw</code> : Score numérique brut</li>
                    <li><code>cmi.score.min</code> : Score minimum possible (0)</li>
                    <li><code>cmi.score.max</code> : Score maximum possible (100)</li>
                    <li><code>cmi.score.scaled</code> : Score normalisé entre 0 et 1</li>
                    <li><code>cmi.completion_status</code> : État d'achèvement ("completed", "incomplete", "not attempted")</li>
                    <li><code>cmi.success_status</code> : Résultat pédagogique ("passed", "failed", "unknown")</li>
                    <li><code>cmi.session_time</code> : Durée de la session (format PTxHxMxS)</li>
                    ${appState.transmitInteractions ? '<li><code>cmi.interactions</code> : Interactions avec détails des réponses</li>' : ''}
                </ul>
                
                <p><strong>Remarque:</strong> Le seuil de réussite défini (${appState.successThreshold}%) sera utilisé pour déterminer le statut "passed"/"failed".</p>
                `;
            } else {
                detailsContainer.innerHTML = `
                <p><strong>Pour SCORM 1.2:</strong></p>
                <ul>
                    <li><code>cmi.core.score.raw</code> : Score numérique brut (0-100)</li>
                    <li><code>cmi.core.lesson_status</code> : Statut de complétion ("passed", "failed", "completed", "incomplete")</li>
                    <li><code>cmi.core.session_time</code> : Temps de session au format HH:MM:SS</li>
                    ${appState.transmitInteractions ? '<li><code>cmi.interactions</code> : Interactions avec détails des réponses</li>' : ''}
                </ul>
                
                <p><strong>Remarque:</strong> Le seuil de réussite défini (${appState.successThreshold}%) sera utilisé pour déterminer le statut "passed" ou "failed".</p>
                `;
            }
        }

        // Fonction pour ajouter un contexte
        function addContext() {
            appState.contexts.push('');
            renderContexts();
        }

        // Fonction pour mettre à jour un contexte
        function updateContext(index, value) {
            appState.contexts[index] = value;
        }

        // Fonction pour supprimer un contexte
        function removeContext(index) {
            appState.contexts.splice(index, 1);
            renderContexts();
        }

        // Fonction pour rendre les contextes
        function renderContexts() {
            const container = document.getElementById('contexts-container');
            container.innerHTML = '';
            
            if (appState.contexts.length === 0) {
                // Ajouter un contexte vide par défaut
                appState.contexts.push('');
            }
            
            appState.contexts.forEach((context, index) => {
                const contextGroup = document.createElement('div');
                contextGroup.className = 'form-group';
                
                const contextRow = document.createElement('div');
                contextRow.className = 'category-row';
                
                const textarea = document.createElement('textarea');
                textarea.className = 'form-textarea context-input';
                textarea.placeholder = 'Ex: Dans un contexte de construction d\'une maison...';
                textarea.value = context;
                textarea.dataset.index = index;
                textarea.addEventListener('input', function() {
                    updateContext(index, this.value);
                });
                
                contextRow.appendChild(textarea);
                
                if (index > 0) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', function() {
                        removeContext(index);
                    });
                    
                    contextRow.appendChild(removeBtn);
                }
                
                contextGroup.appendChild(contextRow);
                container.appendChild(contextGroup);
            });
        }

        // Fonction pour ajouter une variable
        function addVariable() {
            appState.variables.push({
                name: '',
                type: 'nombre',
                min: '1',
                max: '100',
                list: ''
            });
            renderVariables();
        }

        // Fonction pour mettre à jour une variable
        function updateVariable(index, field, value) {
            appState.variables[index][field] = value;
        }

        // Fonction pour supprimer une variable
        function removeVariable(index) {
            appState.variables.splice(index, 1);
            renderVariables();
        }

        // Fonction pour rendre les variables
        function renderVariables() {
            const container = document.getElementById('variables-container');
            
            // Effacer le contenu actuel
            container.innerHTML = '';
            
            if (appState.variables.length === 0) {
                container.innerHTML = '<p class="placeholder-text">Aucune variable définie. Cliquez sur "Ajouter une variable" ci-dessous.</p>';
                return;
            }
            
            appState.variables.forEach((variable, index) => {
                const variableRow = document.createElement('div');
                variableRow.className = 'variable-row';
                variableRow.dataset.index = index;
                
                // Nom de la variable
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'form-input';
                nameInput.placeholder = 'Nom';
                nameInput.value = variable.name;
                nameInput.addEventListener('input', function() {
                    updateVariable(index, 'name', this.value);
                });
                
                // Type de variable
                const typeSelect = document.createElement('select');
                typeSelect.className = 'form-select';
                
                const typeOptions = [
                    { value: 'nombre', text: 'Nombre' },
                    { value: 'décimal', text: 'Décimal' },
                    { value: 'liste', text: 'Liste' }
                ];
                
                typeOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    if (option.value === variable.type) {
                        optionElement.selected = true;
                    }
                    typeSelect.appendChild(optionElement);
                });
                
                typeSelect.addEventListener('change', function() {
                    updateVariable(index, 'type', this.value);
                    renderVariables(); // Re-render to show/hide appropriate fields
                });
                
                // Créer un conteneur pour les valeurs (min/max ou liste)
                const valuesContainer = document.createElement('div');
                valuesContainer.className = 'variable-values-container';
                
                if (variable.type === 'liste') {
                    // Champ pour la liste de valeurs
                    const listInput = document.createElement('input');
                    listInput.type = 'text';
                    listInput.className = 'form-input';
                    listInput.placeholder = 'Valeurs séparées par des virgules';
                    listInput.value = variable.list;
                    listInput.style.flex = '1';
                    listInput.addEventListener('input', function() {
                        updateVariable(index, 'list', this.value);
                    });
                    
                    valuesContainer.appendChild(listInput);
                } else {
                    // Texte "de"
                    const deText = document.createElement('span');
                    deText.textContent = 'de';
                    
                    // Champ min
                    const minInput = document.createElement('input');
                    minInput.type = 'text';
                    minInput.className = 'form-input';
                    minInput.placeholder = 'Min';
                    minInput.value = variable.min;
                    minInput.addEventListener('input', function() {
                        updateVariable(index, 'min', this.value);
                    });
                    
                    // Texte "à"
                    const aText = document.createElement('span');
                    aText.textContent = 'à';
                    
                    // Champ max
                    const maxInput = document.createElement('input');
                    maxInput.type = 'text';
                    maxInput.className = 'form-input';
                    maxInput.placeholder = 'Max';
                    maxInput.value = variable.max;
                    maxInput.addEventListener('input', function() {
                        updateVariable(index, 'max', this.value);
                    });
                    
                    valuesContainer.appendChild(deText);
                    valuesContainer.appendChild(minInput);
                    valuesContainer.appendChild(aText);
                    valuesContainer.appendChild(maxInput);
                }
                
                // Bouton pour supprimer la variable
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger variable-remove-btn';
                removeBtn.style.padding = '5px';
                removeBtn.style.minWidth = '30px';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    removeVariable(index);
                });
                
                variableRow.appendChild(nameInput);
                variableRow.appendChild(typeSelect);
                variableRow.appendChild(valuesContainer);
                variableRow.appendChild(removeBtn);
                
                container.appendChild(variableRow);
            });
        }

        // Fonction pour mettre à jour l'affichage du nombre de QCM possibles
        function updateQcmCountDisplay() {
            const qTotal = parseInt(appState.questionsTotal);
            const qPerTest = parseInt(appState.questionsPerTest);
            
            if (qTotal > 0 && qPerTest > 0) {
                // Calculer approximativement le nombre de combinaisons possibles
                // Formule: C(n, k) = n! / (k! * (n-k)!)
                // Pour de grandes valeurs, on peut utiliser une approximation
                let count = 1;
                if (qTotal >= qPerTest && qPerTest > 0) {
                    // Utiliser une approximation pour éviter les débordements
                    if (qTotal > 100 || qPerTest > 50) {
                        count = Math.floor(Math.pow(qTotal / qPerTest, qPerTest));
                    } else {
                        for (let i = 0; i < qPerTest; i++) {
                            count = count * (qTotal - i) / (i + 1);
                        }
                        count = Math.floor(count);
                    }
                }
                
                // Formater le nombre avec des séparateurs de milliers
                const formattedCount = count.toLocaleString();
                
                // Mettre à jour l'affichage
                document.getElementById('qcm-count-value').textContent = formattedCount;
                
                // Afficher le conteneur si nécessaire
                if (count > 1) {
                    document.getElementById('qcm-count-container').style.display = 'block';
                } else {
                    document.getElementById('qcm-count-container').style.display = 'none';
                }
            }
        }

        // Fonction pour générer des questions avec l'IA
        function generateQuestionsWithAI() {
            if (!isAnyAPIConfigured()) {
                alert('Veuillez d\'abord configurer une API d\'IA dans la fenêtre IA & API.');
                document.getElementById('ia-api-modal').style.display = 'block';
                return;
            }
            
            // Construire le prompt pour la génération de questions
            const prompt = `Génère ${appState.variationsCount} questions de QCM en ${getDomainDisplay(appState.domain)} pour un niveau ${appState.selectedLevels.join(', ')}. 
            
            Thème spécifique: ${appState.contentTheme || 'Programme scolaire standard'}
            
            Format demandé pour chaque question:
            
            Question ${appState.questionId}: [ÉNONCÉ DE LA QUESTION]
            A) [OPTION 1]
            B) [OPTION 2]
            C) [OPTION 3]
            D) [OPTION 4]
            Réponse correcte: [LETTRE]
            Feedback: [FEEDBACK DÉTAILLÉ EXPLIQUANT LA BONNE RÉPONSE]
            
            Les questions doivent être de qualité pédagogique, adaptées au niveau, et avec des options de réponse crédibles. Le feedback doit être éducatif et complet.`;
            
            // Afficher l'indicateur de chargement
            document.getElementById('generation-indicator').style.display = 'flex';
            document.getElementById('generation-success').style.display = 'none';
            document.getElementById('generate-questions-ai').disabled = true;
            
            
			// Écouteur pour la case à cocher d'édition du prompt
			document.getElementById('edit-prompt').addEventListener('change', function() {
				const container = document.getElementById('edit-prompt-container');
				
				// Forcer l'affichage/masquage avec style.display au lieu des classes
				if (this.checked) {
					container.style.display = 'block';
					console.log("Affichage du conteneur d'édition");
					
					// Initialiser le textarea
					const promptTextarea = document.getElementById('generation-prompt');
					if (!promptTextarea.value) {
						// Définir une valeur par défaut pour le prompt de génération
						const defaultPrompt = `Génère ${appState.variationsCount} questions à choix multiples de haute qualité sur le sujet "${appState.contentTheme || getDomainDisplay(appState.domain)}" pour un niveau ${appState.selectedLevels.join(', ')}.
			
			Chaque question doit:
			1. Être adaptée au niveau scolaire indiqué
			2. Avoir exactement ${appState.optionsPerQuestion} options de réponse
			3. Inclure une option correcte clairement identifiée
			4. Fournir un feedback détaillé expliquant pourquoi la réponse est correcte
			
			Format demandé:
			- Question [NUMÉRO]: [ÉNONCÉ]
			- A) [OPTION A]
			- B) [OPTION B]
			- C) [OPTION C]
			- D) [OPTION D]
			- Réponse correcte: [LETTRE]
			- Feedback: [EXPLICATION DÉTAILLÉE]`;
						
						promptTextarea.value = appState.generationPrompt || defaultPrompt;
						promptTextarea.dataset.originalValue = promptTextarea.value;
					}
				} else {
					container.style.display = 'none';
					console.log("Masquage du conteneur d'édition");
				}
			});
			
			// Initialiser correctement l'état au chargement
			document.addEventListener('DOMContentLoaded', function() {
				const editPromptCheckbox = document.getElementById('edit-prompt');
				const container = document.getElementById('edit-prompt-container');
				
				// S'assurer que le conteneur est caché initialement
				container.style.display = editPromptCheckbox.checked ? 'block' : 'none';
			});            
						
            
            
            // Appeler l'API IA
            callAIAPI(prompt, 0.7, 2000)
                .then(response => {
                    // Traiter la réponse et extraire les questions
                    const questions = parseQuestions(response);
                    
                    // Mettre à jour l'état avec les questions extraites
                    appState.exampleQuestions = questions.join("\n\n");
                    
                    // Afficher un échantillon dans le champ de thème
                    document.getElementById('content-theme').value = appState.contentTheme + 
                        (appState.contentTheme ? "\n\n" : "") + 
                        "Exemples générés par IA:\n\n" + 
                        questions.slice(0, 2).join("\n\n");
                    
                    // Cacher l'indicateur de chargement et afficher le succès
                    document.getElementById('generation-indicator').style.display = 'none';
                    document.getElementById('generation-success').style.display = 'flex';
                    document.getElementById('generate-questions-ai').disabled = false;
                    
                    showNotification("Questions générées avec succès!");
                })
                .catch(error => {
                    console.error("Erreur lors de la génération des questions:", error);
                    document.getElementById('generation-indicator').style.display = 'none';
                    document.getElementById('generate-questions-ai').disabled = false;
                    alert("Erreur lors de la génération des questions: " + error.message);
                });
        }

		// Fonction pour extraire les questions du texte généré
		function parseQuestions(text) {
			const questions = [];
			const regex = /Question[^:]*:[\s\S]+?(?=Question|$)/g;
			
			let match;
			while ((match = regex.exec(text)) !== null) {
				const question = match[0].trim();
				if (question) {
					// Échapper les expressions LaTeX avant de stocker la question
					questions.push(escapeLaTeXDelimiters(question));
				}
			}
			
			return questions;
		}

        // Fonction pour générer de nouvelles idées de templates de feedback
        function generateFeedbackTemplates() {
            if (!isAnyAPIConfigured()) {
                alert('Veuillez d\'abord configurer une API d\'IA dans la fenêtre IA & API.');
                document.getElementById('ia-api-modal').style.display = 'block';
                return;
            }
            
            const prompt = `Génère des templates de feedback pédagogiques pour un QCM en ${getDomainDisplay(appState.domain)} niveau ${appState.selectedLevels.join(', ')}.
            
            Je souhaite 3 templates:
            1. Un template pour les réponses correctes
            2. Un template pour les réponses incorrectes
            3. Un template de feedback général
            
            Chaque template doit inclure des placeholders entre crochets comme [explication], [concept], etc.
            Format JSON:
            {
                "correct": "template pour réponse correcte",
                "incorrect": "template pour réponse incorrecte",
                "general": "template pour feedback général"
            }`;
            
            const generateButton = document.getElementById('generate-feedback-ai');
            const originalText = generateButton.innerHTML;
            generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            generateButton.disabled = true;
            
            callAIAPI(prompt, 0.7, 1000)
                .then(response => {
                    try {
                        // Extraire le JSON
                        const jsonMatch = response.match(/\{[\s\S]*\}/);
                        if (!jsonMatch) throw new Error("Pas de JSON trouvé dans la réponse");
                        
                        const feedbackData = JSON.parse(jsonMatch[0]);
                        
                        // Mettre à jour les champs et l'état
                        if (feedbackData.correct) {
                            document.getElementById('correct-feedback-template').value = feedbackData.correct;
                            appState.feedbackTemplates.correct = feedbackData.correct;
                        }
                        
                        if (feedbackData.incorrect) {
                            document.getElementById('incorrect-feedback-template').value = feedbackData.incorrect;
                            appState.feedbackTemplates.incorrect = feedbackData.incorrect;
                        }
                        
                        if (feedbackData.general) {
                            document.getElementById('general-feedback-template').value = feedbackData.general;
                            appState.feedbackTemplates.general = feedbackData.general;
                        }
                        
                        showNotification("Templates de feedback générés avec succès!");
                    } catch (error) {
                        console.error("Erreur lors du traitement des templates:", error);
                        alert("Erreur: " + error.message);
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la génération des templates:", error);
                    alert("Erreur: " + error.message);
                })
                .finally(() => {
                    generateButton.innerHTML = originalText;
                    generateButton.disabled = false;
                });
        }

        // Fonction pour suggérer des variables avec l'IA
        function suggestVariables() {
            if (!isAnyAPIConfigured()) {
                alert('Veuillez d\'abord configurer une API d\'IA dans la fenêtre IA & API.');
                document.getElementById('ia-api-modal').style.display = 'block';
                return;
            }
            
            const prompt = `Suggère des variables pertinentes pour générer des variations de questions de QCM en ${getDomainDisplay(appState.domain)} pour un niveau ${appState.selectedLevels.join(', ')}.
            
            Thème spécifique: ${appState.contentTheme || 'Programme scolaire standard'}
            
            Donne-moi 4-5 variables en format JSON avec pour chacune:
            - name: nom de la variable (courte et descriptive)
            - type: "nombre", "décimal" ou "liste"
            - min et max: bornes pour les variables numériques
            - list: valeurs possibles pour les variables de type liste (séparées par des virgules)
            
            Format attendu:
            {
                "variables": [
                    {"name": "nom1", "type": "nombre", "min": "1", "max": "100"},
                    {"name": "nom2", "type": "liste", "list": "val1, val2, val3"},
                    ...
                ]
            }`;
            
            const suggestButton = document.getElementById('suggest-variables-btn');
            const originalText = suggestButton.innerHTML;
            suggestButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            suggestButton.disabled = true;
            
            callAIAPI(prompt, 0.7, 1500)
                .then(response => {
                    try {
                        // Extraire le JSON
                        const jsonMatch = response.match(/\{[\s\S]*\}/);
                        if (!jsonMatch) throw new Error("Pas de JSON trouvé dans la réponse");
                        
                        const data = JSON.parse(jsonMatch[0]);
                        
                        if (data.variables && Array.isArray(data.variables)) {
                            // Remplacer les variables existantes par les suggestions
                            appState.variables = data.variables;
                            renderVariables();
                            
                            showNotification("Variables suggérées ajoutées avec succès!");
                        } else {
                            throw new Error("Format de réponse invalide");
                        }
                    } catch (error) {
                        console.error("Erreur lors du traitement des variables:", error);
                        alert("Erreur: " + error.message);
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la suggestion des variables:", error);
                    alert("Erreur: " + error.message);
                })
                .finally(() => {
                    suggestButton.innerHTML = originalText;
                    suggestButton.disabled = false;
                });
        }

        // Fonction pour vérifier la compatibilité SCORM
        function testSCORMIntegration() {
            if (!isAnyAPIConfigured()) {
                alert('Veuillez d\'abord configurer une API d\'IA dans la fenêtre IA & API.');
                document.getElementById('ia-api-modal').style.display = 'block';
                return;
            }
            
            const scormVersion = appState.scormVersion;
            const prompt = `Vérifiez la compatibilité du code d'intégration SCORM ${scormVersion} suivant avec Moodle 4.1:

\`\`\`javascript
// Initialisation SCORM
let API = null;
let API_1484_11 = null;

function findAPI(win) {
    // Recherche de l'API SCORM dans la fenêtre parente
    if (win.API && win.API !== null && ("${scormVersion}" === "1.2")) return win.API;
    if (win.API_1484_11 && win.API_1484_11 !== null && ("${scormVersion}" === "2004")) return win.API_1484_11;
    
    // Si l'API n'est pas trouvée et que nous n'avons pas atteint la fenêtre principale, 
    // continuons la recherche dans la fenêtre parente
    if (win.parent && win.parent !== win) {
        return findAPI(win.parent);
    }
    return null;
}

function initSCORM() {
    // Récupérer la référence à l'API SCORM du LMS
    if ("${scormVersion}" === "1.2") {
        API = findAPI(window);
        if (API) {
            API.LMSInitialize("");
            console.log("SCORM 1.2 API initialisée");
        } else {
            console.warn("API SCORM 1.2 non trouvée");
        }
    } else { // SCORM 2004
        API_1484_11 = findAPI(window);
        if (API_1484_11) {
            API_1484_11.Initialize("");
            console.log("SCORM 2004 API initialisée");
        } else {
            console.warn("API SCORM 2004 non trouvée");
        }
    }
}

function setValue(element, value) {
    if ("${scormVersion}" === "1.2" && API) {
        return API.LMSSetValue(element, value);
    } else if ("${scormVersion}" === "2004" && API_1484_11) {
        return API_1484_11.SetValue(element, value);
    }
    return false;
}

function getValue(element) {
    if ("${scormVersion}" === "1.2" && API) {
        return API.LMSGetValue(element);
    } else if ("${scormVersion}" === "2004" && API_1484_11) {
        return API_1484_11.GetValue(element);
    }
    return "";
}

function sendScore(score) {
    // Normaliser le score entre 0 et 100
    const normalizedScore = Math.min(Math.max(score, 0), 100);
    
    if ("${scormVersion}" === "1.2") {
        // SCORM 1.2
        setValue("cmi.core.score.raw", normalizedScore);
        
        // Statut de réussite basé sur le seuil
        const passed = normalizedScore >= ${appState.successThreshold};
        setValue("cmi.core.lesson_status", passed ? "passed" : "failed");
    } else {
        // SCORM 2004
        setValue("cmi.score.raw", normalizedScore);
        setValue("cmi.score.min", "0");
        setValue("cmi.score.max", "100");
        setValue("cmi.score.scaled", normalizedScore / 100);
        
        // Statut d'achèvement et de réussite
        setValue("cmi.completion_status", "completed");
        setValue("cmi.success_status", normalizedScore >= ${appState.successThreshold} ? "passed" : "failed");
    }
}
\`\`\`

Donnez-moi une évaluation de la compatibilité et la qualité de ce code. Identifiez les points forts et les points à améliorer. Ce code fonctionnera-t-il correctement avec Moodle 4.1?
Limiter votre réponse aux aspects techniques et vérifiez que tous les éléments nécessaires pour une intégration réussie sont présents.`;
            
            const testButton = document.getElementById('test-scorm-integration');
            const originalText = testButton.innerHTML;
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
            testButton.disabled = true;
            
            callAIAPI(prompt, 0.7, 2000)
                .then(response => {
                    // Afficher les résultats dans une fenêtre modale ou une alerte
                    alert("Résultat de la vérification SCORM:\n\n" + response);
                })
                .catch(error => {
                    console.error("Erreur lors de la vérification:", error);
                    alert("Erreur: " + error.message);
                })
                .finally(() => {
                    testButton.innerHTML = originalText;
                    testButton.disabled = false;
                });
        }

        // Fonction pour appeler une API IA
        async function callAIAPI(prompt, temperature = 0.7, maxTokens = 2000) {
            // Déterminer quel service utiliser
            let service = apiState.defaultAIService;
            let apiConfig = apiState.apiConfig[service];
            
            // Si le service par défaut n'est pas configuré, chercher un service configuré
            if (!apiConfig || !apiConfig.key) {
                if (apiState.apiConfig.claude.key) {
                    service = 'claude';
                    apiConfig = apiState.apiConfig.claude;
                } else if (apiState.apiConfig.openai.key) {
                    service = 'openai';
                    apiConfig = apiState.apiConfig.openai;
                } else if (apiState.apiConfig.mistral.key) {
                    service = 'mistral';
                    apiConfig = apiState.apiConfig.mistral;
                } else {
                    throw new Error("Aucune API n'est configurée");
                }
            }
            
            // Préparer les paramètres spécifiques au service
            let endpoint, headers, body;
            
            switch(service) {
                case 'claude':
                    endpoint = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': apiConfig.key,
                        'anthropic-version': '2023-06-01'
                    };
                    body = {
                        model: apiConfig.model,
                        max_tokens: maxTokens,
                        temperature: temperature,
                        messages: [{ role: "user", content: prompt }]
                    };
                    break;
                    
                case 'openai':
                    endpoint = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    };
                    body = {
                        model: apiConfig.model,
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: maxTokens,
                        temperature: temperature
                    };
                    break;
                    
                case 'mistral':
                    endpoint = 'https://api.mistral.ai/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    };
                    body = {
                        model: apiConfig.model,
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: maxTokens,
                        temperature: temperature
                    };
                    break;
                    
                default:
                    throw new Error(`Service IA non pris en charge: ${service}`);
            }
            
            // Faire la requête
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Erreur API (${response.status})`);
                }
                
                const data = await response.json();
                
                // Extraire le texte selon le service
                if (service === 'claude') {
                    return data.content?.[0]?.text || "";
                } else if (service === 'openai') {
                    return data.choices?.[0]?.message?.content || "";
                } else if (service === 'mistral') {
                    return data.choices?.[0]?.message?.content || "";
                }
                
                return "";
            } catch (error) {
                console.error(`Erreur lors de l'appel API ${service}:`, error);
                throw error;
            }
        }

        // Fonction de test de l'API
        async function testAPI() {
            const service = document.getElementById('test-service').value;
            const apiConfig = apiState.apiConfig[service];
            
            if (!apiConfig || !apiConfig.key) {
                alert(`Veuillez d'abord configurer une clé API pour ${service}.`);
                return;
            }
            
            const prompt = document.getElementById('test-prompt').value;
            const temperature = parseFloat(document.getElementById('test-temperature').value);
            const maxTokens = parseInt(document.getElementById('test-tokens').value);
            
            // Afficher le spinner
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('test-result').style.display = 'none';
            document.getElementById('run-test-btn').disabled = true;
            
            try {
                const result = await callAIAPI(prompt, temperature, maxTokens);
                
                // Afficher le résultat
                document.getElementById('test-result').innerHTML = `<pre>${result}</pre>`;
                document.getElementById('test-result').style.display = 'block';
                document.querySelector('.result-controls').style.display = 'flex';
            } catch (error) {
                document.getElementById('test-result').innerHTML = `<div style="color: red;">Erreur: ${error.message}</div>`;
                document.getElementById('test-result').style.display = 'block';
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('run-test-btn').disabled = false;
            }
        }

        // Fonction pour copier le résultat du test
        function copyTestResult() {
            const resultElement = document.getElementById('test-result').querySelector('pre');
            if (resultElement) {
                navigator.clipboard.writeText(resultElement.textContent)
                    .then(() => {
                        showNotification("Résultat copié dans le presse-papiers!");
                    })
                    .catch(err => {
                        console.error("Erreur lors de la copie:", err);
                    });
            }
        }

        // Fonction pour sauvegarder les configurations API
        function saveAPISettings() {
            apiState.apiConfig.claude.key = document.getElementById('claude-api-key').value;
            apiState.apiConfig.claude.model = document.getElementById('claude-model').value;
            
            apiState.apiConfig.openai.key = document.getElementById('openai-api-key').value;
            apiState.apiConfig.openai.model = document.getElementById('openai-model').value;
            
            apiState.apiConfig.mistral.key = document.getElementById('mistral-api-key').value;
            apiState.apiConfig.mistral.model = document.getElementById('mistral-model').value;
            
            // Sauvegarder dans localStorage
            localStorage.setItem('qcm_api_config', JSON.stringify(apiState.apiConfig));
            
            showNotification("Configurations API sauvegardées!");
            
            // Fermer le modal
            document.getElementById('ia-api-modal').style.display = 'none';
        }

        // Fonction pour tester une connexion API
        async function testAPIConnection(service) {
            const apiConfig = apiState.apiConfig[service];
            const statusElement = document.getElementById(`${service}-api-status`);
            
            if (!apiConfig || !apiConfig.key) {
                statusElement.textContent = "Erreur : Veuillez entrer une clé API.";
                statusElement.className = "api-status error";
                return;
            }
            
            statusElement.textContent = "Test en cours...";
            statusElement.className = "api-status";
            statusElement.style.display = 'block';
            
            try {
                const result = await callAIAPI("Réponds simplement 'Test réussi!'", 0.7, 20);
                
                statusElement.textContent = "Connexion réussie !";
                statusElement.className = "api-status success";
            } catch (error) {
                statusElement.textContent = "Erreur : " + error.message;
                statusElement.className = "api-status error";
            }
        }

        // Fonction de toggle pour la visibilité des clés API
        function toggleAPIKeyVisibility(targetId) {
            const input = document.getElementById(targetId);
            const button = document.querySelector(`[data-target="${targetId}"]`);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                input.type = 'password';
                button.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        // Fonction pour charger les configurations API depuis localStorage
        function loadAPIConfig() {
            const savedConfig = localStorage.getItem('qcm_api_config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    apiState.apiConfig = {...apiState.apiConfig, ...config};
                    
                    // Mettre à jour les champs de l'interface
                    if (config.claude) {
                        document.getElementById('claude-api-key').value = config.claude.key || '';
                        if (config.claude.model) {
                            document.getElementById('claude-model').value = config.claude.model;
                        }
                    }
                    
                    if (config.openai) {
                        document.getElementById('openai-api-key').value = config.openai.key || '';
                        if (config.openai.model) {
                            document.getElementById('openai-model').value = config.openai.model;
                        }
                    }
                    
                    if (config.mistral) {
                        document.getElementById('mistral-api-key').value = config.mistral.key || '';
                        if (config.mistral.model) {
                            document.getElementById('mistral-model').value = config.mistral.model;
                        }
                    }
                } catch (error) {
                    console.error("Erreur lors du chargement des configurations API:", error);
                }
            }
        }

        // Fonction pour télécharger le prompt
        function downloadPrompt() {
            const promptText = generatePrompt();
            const element = document.createElement("a");
            const file = new Blob([promptText], {type: 'text/plain'});
            element.href = URL.createObjectURL(file);
            element.download = "qcm-certification-prompt.txt";
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Fonction pour copier le prompt dans le presse-papiers
        function copyPrompt() {
            const promptText = generatePrompt();
            navigator.clipboard.writeText(promptText)
                .then(() => {
                    showNotification('Le prompt a été copié dans le presse-papiers !');
                })
                .catch(err => {
                    console.error('Erreur lors de la copie :', err);
                    alert('Erreur lors de la copie du prompt. Veuillez essayer de le sélectionner manuellement.');
                });
        }

        // Fonction pour ouvrir un site web et coller le prompt
        function openAiProvider(url) {
            // Générer et copier le prompt dans le presse-papiers
            const promptText = generatePrompt();
            navigator.clipboard.writeText(promptText)
                .then(() => {
                    showNotification('Le prompt a été copié ! Ouverture de ' + url);
                    
                    // Ouvrir le site dans un nouvel onglet
                    window.open(url, '_blank');
                })
                .catch(err => {
                    console.error('Erreur lors de la copie :', err);
                    alert('Erreur lors de la copie du prompt, mais le site sera ouvert quand même.');
                    window.open(url, '_blank');
                });
        }

        // Initialisation de l'application 
        function initApp() {
            // Gestionnaire pour les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabNumber = this.getAttribute('data-tab');
                    changeTab(parseInt(tabNumber));
                });
            });
            
            // Initialiser les écouteurs pour les boutons de navigation entre onglets
            document.getElementById('next-tab-1').addEventListener('click', () => changeTab(2));
            document.getElementById('prev-tab-2').addEventListener('click', () => changeTab(1));
            document.getElementById('next-tab-2').addEventListener('click', () => changeTab(3));
            document.getElementById('prev-tab-3').addEventListener('click', () => changeTab(2));
            document.getElementById('next-tab-3').addEventListener('click', () => changeTab(4));
            document.getElementById('prev-tab-4').addEventListener('click', () => changeTab(3));
            document.getElementById('next-tab-4').addEventListener('click', () => changeTab(5));
            document.getElementById('prev-tab-5').addEventListener('click', () => changeTab(4));
            document.getElementById('next-tab-5').addEventListener('click', () => changeTab(6));
            document.getElementById('prev-tab-6').addEventListener('click', () => changeTab(5));
            
            // Écouteurs pour les champs de l'onglet 1 (Configuration)
            document.getElementById('app-title').addEventListener('input', (e) => {
                appState.appTitle = e.target.value;
                // Mettre à jour le certificat preview
                updateCertificatePreview();
            });
            
            document.getElementById('app-subtitle').addEventListener('input', (e) => {
                appState.appSubtitle = e.target.value;
            });
            
            document.getElementById('app-author').addEventListener('input', (e) => {
                appState.appAuthor = e.target.value;
                // Mettre à jour le certificat preview
                updateCertificatePreview();
            });
            
            document.getElementById('domain-select').addEventListener('change', (e) => {
                appState.domain = e.target.value;
                
                // Afficher ou masquer le champ de domaine personnalisé
                const customDomainContainer = document.getElementById('custom-domain-container');
                if (e.target.value === 'custom') {
                    customDomainContainer.style.display = 'block';
                } else {
                    customDomainContainer.style.display = 'none';
                }
                
                // Mettre à jour le certificat preview
                updateCertificatePreview();
            });
            
            document.getElementById('custom-domain').addEventListener('input', (e) => {
                appState.customDomain = e.target.value;
                
                // Mettre à jour le certificat preview si nécessaire
                if (appState.domain === 'custom') {
                    updateCertificatePreview();
                }
            });
            
            // Écouteurs pour les cases à cocher des niveaux
            document.querySelectorAll('input[type="checkbox"][id^="level-"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    handleLevelChange(e.target.value, e.target.checked);
                });
            });
            
            // Écouteur pour le bouton de réinitialisation
            document.getElementById('reset-button').addEventListener('click', () => {
                if (window.confirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres ?')) {
                    window.location.reload();
                }
            });
            
            // Écouteurs pour les champs de l'onglet 2 (Questions & IA)
            document.getElementById('questions-total').addEventListener('input', (e) => {
                appState.questionsTotal = e.target.value;
                document.getElementById('questions-total-value').textContent = e.target.value;
                
                // Mettre à jour la valeur maximum du nombre de questions par test
                const questionsPerTest = document.getElementById('questions-per-test');
                const currentValue = parseInt(questionsPerTest.value);
                const maxValue = parseInt(e.target.value);
                
                questionsPerTest.max = maxValue;
                
                // Ajuster la valeur si nécessaire
                if (currentValue > maxValue) {
                    questionsPerTest.value = maxValue;
                    document.getElementById('questions-per-test-value').textContent = maxValue;
                    appState.questionsPerTest = maxValue;
                }
                
                // Mettre à jour l'affichage du nombre de QCM
                updateQcmCountDisplay();
            });
            
            document.getElementById('questions-per-test').addEventListener('input', (e) => {
                appState.questionsPerTest = e.target.value;
                document.getElementById('questions-per-test-value').textContent = e.target.value;
                
                // Mettre à jour l'affichage du nombre de QCM
                updateQcmCountDisplay();
            });
            
            document.getElementById('options-per-question').addEventListener('input', (e) => {
                appState.optionsPerQuestion = e.target.value;
                document.getElementById('options-per-question-value').textContent = e.target.value;
            });
            
            document.getElementById('correct-answers-allowed').addEventListener('change', (e) => {
                appState.correctAnswersAllowed = e.target.value;
            });
            
            document.getElementById('categories-enabled').addEventListener('change', (e) => {
                appState.categoriesEnabled = e.target.value;
                
                // Afficher ou masquer le conteneur des catégories
                const categoriesContainer = document.getElementById('categories-container');
                if (e.target.value === 'yes') {
                    categoriesContainer.style.display = 'block';
                } else {
                    categoriesContainer.style.display = 'none';
                }
            });
            
            document.getElementById('max-attempts').addEventListener('input', (e) => {
                appState.maxAttempts = e.target.value;
                document.getElementById('max-attempts-value').textContent = e.target.value;
            });
            
            document.getElementById('points-correct').addEventListener('change', (e) => {
                appState.pointsCorrect = e.target.value;
            });
            
            document.getElementById('points-penalty').addEventListener('change', (e) => {
                appState.pointsPenalty = e.target.value;
            });
            
            document.getElementById('success-threshold').addEventListener('input', (e) => {
                appState.successThreshold = e.target.value;
                document.getElementById('success-threshold-value').textContent = e.target.value + '%';
            });
            
            document.getElementById('feedback-type').addEventListener('change', (e) => {
                appState.feedbackType = e.target.value;
            });
            
            document.getElementById('correction-enabled').addEventListener('change', (e) => {
                appState.correctionEnabled = e.target.value;
                
                // Afficher ou masquer les options du corrigé
                const correctionOptions = document.getElementById('correction-options');
                if (e.target.value === 'yes') {
                    correctionOptions.style.display = 'block';
                } else {
                    correctionOptions.style.display = 'none';
                }
            });
            
            document.getElementById('correction-print').addEventListener('change', (e) => {
                appState.correctionPrint = e.target.checked;
            });
            
            document.getElementById('correction-pdf').addEventListener('change', (e) => {
                appState.correctionPdf = e.target.checked;
            });
            
            document.getElementById('correction-jpg').addEventListener('change', (e) => {
                appState.correctionJpg = e.target.checked;
            });
            
            document.getElementById('correction-after-completion').addEventListener('change', (e) => {
                appState.correctionAfterCompletion = e.target.checked;
            });
            
			document.getElementById('disable-other-options').addEventListener('change', (e) => {
				appState.disableOtherOptions = e.target.checked;
			});            
            
            document.getElementById('content-theme').addEventListener('input', (e) => {
                appState.contentTheme = e.target.value;
            });
            
			document.getElementById('preview-math-btn').addEventListener('click', function() {
				const preview = document.getElementById('math-preview');
				if (preview.style.display === 'none') {
					preview.style.display = 'block';
					// Charger MathJax pour la prévisualisation
					if (!window.MathJax) {
						const script1 = document.createElement('script');
						script1.src = "https://polyfill.io/v3/polyfill.min.js?features=es6";
						document.head.appendChild(script1);
						
						const script2 = document.createElement('script');
						script2.id = "MathJax-script";
						script2.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
						script2.async = true;
						document.head.appendChild(script2);
					} else {
						// Si MathJax est déjà chargé, retraiter le contenu
						window.MathJax.typeset();
					}
					this.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer la prévisualisation';
				} else {
					preview.style.display = 'none';
					this.innerHTML = '<i class="fas fa-eye"></i> Prévisualiser les expressions mathématiques';
				}
			});
            
            
            // Écouteurs pour les variations et génération de questions
            document.getElementById('variations-count').addEventListener('input', (e) => {
                appState.variationsCount = parseInt(e.target.value);
                document.getElementById('variations-count-value').textContent = e.target.value;
            });
            
            document.getElementById('numbering-format').addEventListener('change', (e) => {
                appState.numberingFormat = e.target.value;
                
                // Afficher ou masquer le format personnalisé
                const customFormat = document.getElementById('custom-numbering-format');
                if (e.target.value === 'custom') {
                    customFormat.style.display = 'block';
                } else {
                    customFormat.style.display = 'none';
                }
            });
            
            document.getElementById('custom-format').addEventListener('input', (e) => {
                appState.customNumberingFormat = e.target.value;
            });
            
            document.getElementById('add-context-btn').addEventListener('click', addContext);
            document.getElementById('add-variable-btn').addEventListener('click', addVariable);
            document.getElementById('suggest-variables-btn').addEventListener('click', suggestVariables);
            
            document.getElementById('correct-feedback-template').addEventListener('input', (e) => {
                appState.feedbackTemplates.correct = e.target.value;
            });
            
            document.getElementById('incorrect-feedback-template').addEventListener('input', (e) => {
                appState.feedbackTemplates.incorrect = e.target.value;
            });
            
            document.getElementById('general-feedback-template').addEventListener('input', (e) => {
                appState.feedbackTemplates.general = e.target.value;
            });
            
            document.getElementById('generate-feedback-ai').addEventListener('click', generateFeedbackTemplates);
            document.getElementById('generate-questions-ai').addEventListener('click', generateQuestionsWithAI);
            
            // Écouteur pour le prompt de génération
            document.getElementById('generation-prompt').addEventListener('input', function() {
                const hasChanges = this.value !== this.dataset.originalValue;
                document.getElementById('prompt-change-indicator').classList.toggle('hidden', !hasChanges);
                document.getElementById('save-prompt-changes').disabled = !hasChanges;
                
                if (hasChanges) {
                    appState.generationPrompt = this.value;
                }
            });
            
            document.getElementById('save-prompt-changes').addEventListener('click', function() {
                const promptTextarea = document.getElementById('generation-prompt');
                promptTextarea.dataset.originalValue = promptTextarea.value;
                document.getElementById('prompt-change-indicator').classList.add('hidden');
                this.disabled = true;
                showNotification('Modifications du prompt enregistrées!');
            });
            
            // Écouteurs pour les champs de l'onglet 3 (Apparence)
            document.getElementById('qcm-style').addEventListener('change', (e) => {
                appState.qcmStyle = e.target.value;
            });
            
            document.getElementById('transition-animation').addEventListener('change', (e) => {
                appState.transitionAnimation = e.target.value;
            });
            
            document.getElementById('primary-color').addEventListener('change', (e) => {
                appState.primaryColor = e.target.value;
            });
            
            document.getElementById('interface-style').addEventListener('change', (e) => {
                appState.interfaceStyle = e.target.value;
            });
            
            document.getElementById('progress-display').addEventListener('change', (e) => {
                appState.progressDisplay = e.target.value;
            });
            
            document.getElementById('custom-styles').addEventListener('input', (e) => {
                appState.customStyles = e.target.value;
            });
            
            // Écouteurs pour les champs de l'onglet 4 (Certificat)
            document.getElementById('certificate-enabled').addEventListener('change', (e) => {
                appState.certificateEnabled = e.target.value;
                
                // Afficher ou masquer les options du certificat
                const certificateOptions = document.getElementById('certificate-options');
                if (e.target.value === 'yes') {
                    certificateOptions.style.display = 'block';
                } else {
                    certificateOptions.style.display = 'none';
                }
            });
            
            document.getElementById('certificate-title').addEventListener('input', (e) => {
                appState.certificateTitle = e.target.value;
                updateCertificatePreview();
            });
            
            document.getElementById('certificate-style').addEventListener('change', (e) => {
                appState.certificateStyle = e.target.value;
            });
            
            document.getElementById('certificate-info').addEventListener('change', (e) => {
                appState.certificateInfo = e.target.value;
                updateCertificatePreview();
            });
            
            document.getElementById('certificate-export').addEventListener('change', (e) => {
                appState.certificateExport = e.target.value;
            });
            
            document.getElementById('show-detailed-scores').addEventListener('change', (e) => {
                appState.showDetailedScores = e.target.value;
                updateCertificatePreview();
            });
            
            document.getElementById('auto-date-certificate').addEventListener('change', (e) => {
                appState.autoDateCertificate = e.target.checked;
            });
            
            // Écouteurs pour SCORM Tab
            document.getElementById('scorm-enabled').addEventListener('change', (e) => {
                appState.scormEnabled = e.target.value;
                
                // Afficher ou masquer les options SCORM
                const scormOptions = document.getElementById('scorm-options');
                if (e.target.value === 'yes') {
                    scormOptions.style.display = 'block';
                } else {
                    scormOptions.style.display = 'none';
                }
            });
            
            document.getElementById('scorm-version').addEventListener('change', (e) => {
                appState.scormVersion = e.target.value;
                updateSCORMDetails();
            });
            
            document.getElementById('transmit-score').addEventListener('change', (e) => {
                appState.transmitScore = e.target.checked;
                updateSCORMDetails();
            });
            
            document.getElementById('transmit-completion').addEventListener('change', (e) => {
                appState.transmitCompletion = e.target.checked;
                updateSCORMDetails();
            });
            
            document.getElementById('transmit-success').addEventListener('change', (e) => {
                appState.transmitSuccess = e.target.checked;
                updateSCORMDetails();
            });
            
            document.getElementById('transmit-time').addEventListener('change', (e) => {
                appState.transmitTime = e.target.checked;
                updateSCORMDetails();
            });
            
            document.getElementById('transmit-interactions').addEventListener('change', (e) => {
                appState.transmitInteractions = e.target.checked;
                updateSCORMDetails();
            });
            
            document.getElementById('auto-save').addEventListener('change', (e) => {
                appState.autoSave = e.target.checked;
            });
            
            document.getElementById('auto-save-frequency').addEventListener('change', (e) => {
                appState.autoSaveFrequency = e.target.value;
            });
            
            document.getElementById('debug-mode').addEventListener('change', (e) => {
                appState.debugMode = e.target.checked;
            });
            
            document.getElementById('test-scorm-integration').addEventListener('click', testSCORMIntegration);
            
            // Écouteurs pour le modal IA & API
            document.getElementById('open-ia-api-btn').addEventListener('click', function() {
                document.getElementById('ia-api-modal').style.display = 'block';
            });
            
            document.getElementById('close-ia-api-modal').addEventListener('click', function() {
                document.getElementById('ia-api-modal').style.display = 'none';
            });
            
            // Fermer le modal en cliquant en dehors
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('ia-api-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
			document.getElementById('enable-mathjax').addEventListener('change', (e) => {
				appState.enableMathJax = e.target.value;
			});
            
            
            // Écouteurs pour l'onglet 6 (Prompt)
            document.getElementById('generate-prompt-btn').addEventListener('click', generatePrompt);
            document.getElementById('copy-prompt-btn').addEventListener('click', copyPrompt);
            document.getElementById('download-prompt-btn').addEventListener('click', downloadPrompt);
            document.getElementById('enrich-prompt-btn').addEventListener('click', function() {
                // Fonction pour enrichir le prompt avec l'IA
                if (!isAnyAPIConfigured()) {
                    alert('Veuillez d\'abord configurer une API d\'IA dans la fenêtre IA & API.');
                    document.getElementById('ia-api-modal').style.display = 'block';
                    return;
                }
                
                const prompt = `Analyse ce prompt pour une application de QCM et certification, et suggère des améliorations concrètes pour le rendre plus complet et efficace, en particulier pour l'intégration SCORM avec Moodle 4.1:
                
                "${generatePrompt()}"
                
                Propose 3-5 suggestions spécifiques pour enrichir ce prompt. Concentre-toi sur:
                1. L'amélioration des fonctionnalités éducatives
                2. L'ergonomie de l'interface utilisateur
                3. Des aspects de personnalisation supplémentaires
                4. L'intégration SCORM avec Moodle 4.1
                
                Donne tes suggestions sous forme de liste que je pourrai facilement ajouter à mon prompt.`;
                
                const button = document.getElementById('enrich-prompt-btn');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enrichissement...';
                button.disabled = true;
                
                callAIAPI(prompt, 0.7, 2000)
                    .then(response => {
                        // Extraire les suggestions
                        const additionalInstructions = document.getElementById('additional-instructions');
                        additionalInstructions.value = (additionalInstructions.value ? additionalInstructions.value + "\n\n" : "") + 
                            "Suggestions d'enrichissement par IA:\n\n" + response;
                        
                        appState.additionalInstructions = additionalInstructions.value;
                        
                        // Mettre à jour le prompt
                        generatePrompt();
                        
                        showNotification("Prompt enrichi avec succès!");
                    })
                    .catch(error => {
                        console.error("Erreur lors de l'enrichissement:", error);
                        alert("Erreur: " + error.message);
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            });
            
            document.getElementById('prompt-template').addEventListener('change', (e) => {
                appState.promptTemplate = e.target.value;
            });
            
            document.getElementById('include-code').addEventListener('change', (e) => {
                appState.includeCode = e.target.value;
            });
            
            document.getElementById('additional-instructions').addEventListener('input', (e) => {
                appState.additionalInstructions = e.target.value;
            });
            
            document.getElementById('toggle-technical-btn').addEventListener('click', () => {
                appState.showTechnicalSections = !appState.showTechnicalSections;
                
                const toggleBtn = document.getElementById('toggle-technical-btn');
                toggleBtn.innerHTML = appState.showTechnicalSections 
                    ? '<i class="fas fa-code"></i> Masquer sections techniques'
                    : '<i class="fas fa-code"></i> Afficher sections techniques';
                
                // Régénérer le prompt pour refléter le changement
                generatePrompt();
            });
            
            // API & Test
            document.querySelectorAll('.toggle-visibility-btn').forEach(button => {
                button.addEventListener('click', function() {
                    toggleAPIKeyVisibility(this.getAttribute('data-target'));
                });
            });
            
            document.querySelectorAll('.test-api-btn').forEach(button => {
                button.addEventListener('click', function() {
                    testAPIConnection(this.getAttribute('data-service'));
                });
            });
            
            document.getElementById('save-api-settings').addEventListener('click', saveAPISettings);
            document.getElementById('run-test-btn').addEventListener('click', testAPI);
            document.getElementById('copy-result-btn').addEventListener('click', copyTestResult);
            
            document.getElementById('test-temperature').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
            });
            
            // Boutons pour ouvrir les services IA
            document.getElementById('open-claude-btn').addEventListener('click', () => {
                openAiProvider('https://claude.ai');
            });
            
            document.getElementById('open-chatgpt-btn').addEventListener('click', () => {
                openAiProvider('https://chat.openai.com');
            });
            
            document.getElementById('open-mistral-btn').addEventListener('click', () => {
                openAiProvider('https://console.mistral.ai/chat/');
            });
            
            document.getElementById('open-gemini-btn').addEventListener('click', () => {
                openAiProvider('https://gemini.google.com/app');
            });
            
            // Style presets
            document.querySelectorAll('.style-preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    const style = this.getAttribute('data-style');
                    const color = this.getAttribute('data-color');
                    const animation = this.getAttribute('data-animation');
                    const interface = this.getAttribute('data-interface');
                    
                    document.getElementById('qcm-style').value = style;
                    document.getElementById('primary-color').value = color;
                    document.getElementById('transition-animation').value = animation;
                    document.getElementById('interface-style').value = interface;
                    
                    appState.qcmStyle = style;
                    appState.primaryColor = color;
                    appState.transitionAnimation = animation;
                    appState.interfaceStyle = interface;
                    
                    showNotification(`Style "${this.querySelector('.preset-title').textContent.trim().split(' ')[0]}" appliqué!`);
                });
            });
            
            // Certificate generation buttons
            document.getElementById('generate-certificate-template').addEventListener('click', function() {
                // Adapter selon le domaine
                let certTitle, certStyle;
                
                switch(appState.domain) {
                    case 'mathematiques':
                    case 'physique':
                    case 'informatique':
                        certTitle = "Certificat d'Excellence Scientifique";
                        certStyle = "modern";
                        break;
                    case 'histoire':
                    case 'geographie':
                        certTitle = "Attestation de Maîtrise Historique";
                        certStyle = "classic";
                        break;
                    case 'langues':
                        certTitle = "Certification Linguistique";
                        certStyle = "elegant";
                        break;
                    default:
                        certTitle = "Diplôme de Réussite";
                        certStyle = "playful";
                }
                
                document.getElementById('certificate-title').value = certTitle;
                document.getElementById('certificate-style').value = certStyle;
                
                appState.certificateTitle = certTitle;
                appState.certificateStyle = certStyle;
                
                updateCertificatePreview();
                showNotification("Template de certificat généré!");
            });
            
            document.getElementById('generate-certificate-text').addEventListener('click', function() {
                if (!isAnyAPIConfigured()) {
                    alert('Veuillez d\'abord configurer une API d\'IA dans la fenêtre IA & API.');
                    document.getElementById('ia-api-modal').style.display = 'block';
                    return;
                }
                
                const prompt = `Génère un texte formel et professionnel pour un certificat de réussite en ${getDomainDisplay(appState.domain)} pour un niveau ${appState.selectedLevels.join(', ')}. Le texte doit être concis (2-3 phrases maximum) et inclure des termes comme "atteste", "compétences", "réussite", etc. Sois créatif mais formel.`;
                
                callAIAPI(prompt, 0.7, 500)
                    .then(response => {
                        const certPreview = document.getElementById('certificate-preview');
                        certPreview.querySelectorAll('p')[1].textContent = response.trim();
                        showNotification("Texte du certificat généré!");
                    })
                    .catch(error => {
                        console.error("Erreur lors de la génération du texte:", error);
                        showNotification("Erreur: " + error.message, "error");
                    });
            });
            
            document.getElementById('suggest-certificate-title').addEventListener('click', function() {
                const titles = [
                    "Certificat d'Excellence",
                    "Attestation de Réussite",
                    "Diplôme de Compétence",
                    "Certificat de Maîtrise"
                ];
                const randomTitle = titles[Math.floor(Math.random() * titles.length)];
                document.getElementById('certificate-title').value = randomTitle;
                appState.certificateTitle = randomTitle;
                updateCertificatePreview();
                showNotification("Titre de certificat suggéré!");
            });
            
            document.getElementById('suggest-certificate-style').addEventListener('click', function() {
                const styles = ['classic', 'modern', 'elegant', 'playful'];
                const randomStyle = styles[Math.floor(Math.random() * styles.length)];
                document.getElementById('certificate-style').value = randomStyle;
                appState.certificateStyle = randomStyle;
                showNotification(`Style de certificat suggéré: ${getCertificateStyleDisplay(randomStyle)}!`);
            });
            
            // Initialisation pour les onglets et les données
            updateSelectedLevelsDisplay();
            updateCertificatePreview();
            updateSCORMDetails();
            renderContexts();
            renderVariables();
            loadAPIConfig();
            generatePrompt();
            
            // Mettre la date actuelle dans le certificat
            const now = new Date();
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            document.getElementById('certificate-date').textContent = now.toLocaleDateString('fr-FR', options);
        }

        // Initialiser l'application au chargement
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
