<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de Prompts pour Applications Pédagogiques V12.6</title>
    <style>
		:root {
			/* Couleurs principales du gradient */
			--primary: #b71c1c;
			--primary-light: #ffebee;
			--primary-dark: #7f0000;
			--badge-col: #ef9a9a;
			--signature-col: #ef9a9a;
			--success: #66bb6a;
			--success-light: #e8f5e9;
			--warning: #ffa726;
			--warning-light: #fff3e0;
			--info: #ef5350;
			--info-light: #ffebee;
			--dark: #212121;
			--gray: #9e9e9e;
			--light-gray: #e0e0e0;
			--white: #ffffff;
			
			/* Couleurs des onglets */
			--tab1-color: #d90000;
			--tab2-color: #c80000;
			--tab3-color: #b70000;
			--tab4-color: #a60000;
			--tab5-color: #950000;
			--tab6-color: #840000;
			--tab7-color: #c00000;
			
			/* Transitions et effets */
			--standard-transition: all 0.3s ease;
			--standard-shadow: 0 2px 4px rgba(110, 0, 0, 0.2);
			--hover-shadow: 0 4px 8px rgba(110, 0, 0, 0.3);
			--card-radius: 0.75rem;
			--element-radius: 0.5rem;
		}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

		.header {
			background: linear-gradient(to right, #d90000, #800000);
			color: var(--white);
			padding: 1.5rem;
			display: flex;
			align-items: center;
			position: relative;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
		}
		
        .version-badge {
			background-color: var(--badge-col);
			color: var(--white);
			font-size: 0.9rem;
			font-weight: bold;
			padding: 0.45rem 0.7rem;
			border-radius: 50%;
			margin-right: 1.5rem;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
		}
		
        .title {
            font-size: 1.7rem;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }

        .signature {
	        background-color: var(--primary-light);
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: bold;
            padding: 0.45rem 0.7rem;
            border-radius: 50%;
            margin-left: 1rem;
        }

        .logo-container {
            display: flex; 
            align-items: center; 
            margin-right: 10px; 
            height: 40px; 
            width: 40px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            flex-grow: 1;
        }

        /* Nouvelle barre supérieure */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background-color: #f5f5f5;
            border-radius: var(--element-radius);
        }

        .autosave-indicator {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--success);
        }

        .autosave-indicator.saving {
            color: var(--warning);
        }

        .autosave-icon {
            margin-right: 0.5rem;
        }

        .actions-menu {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background-color: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: var(--element-radius);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--standard-transition);
        }

        .action-btn:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
        }

        .dropdown-container {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: var(--element-radius);
            padding: 0.5rem;
            min-width: 150px;
            box-shadow: var(--hover-shadow);
            z-index: 100;
        }

        .dropdown-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: var(--element-radius);
            transition: var(--standard-transition);
        }

        .dropdown-item:hover {
            background-color: var(--primary-light);
        }

        /* Panneau de prévisualisation */
        .preview-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 40%;
            height: 100vh;
            background-color: var(--white);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding: 1rem;
            overflow-y: auto;
        }

        .preview-panel.active {
            transform: translateX(0);
        }

        .preview-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .preview-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .preview-content {
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: var(--element-radius);
            min-height: 300px;
        }

        /* Progress bar styles */
        .progress-container {
            margin-bottom: 2rem;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

		.step {
			width: 2.5rem;
			height: 2.5rem;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: var(--light-gray);
			color: var(--dark);
			font-weight: bold;
			box-shadow: var(--standard-shadow);
			transition: var(--standard-transition);
		}

		.step.active {
			background: linear-gradient(to bottom right, #d90000, #b71c1c);
			color: var(--white);
			transform: scale(1.1);
			box-shadow: 0 3px 6px rgba(110, 0, 0, 0.3);
		}

		.step.completed {
			background: linear-gradient(to bottom right, #b71c1c, #7f0000);
			color: var(--white);
		}

		.progress-bar {
			width: 100%;
			height: 0.5rem;
			background-color: var(--light-gray);
			border-radius: 1rem;
			overflow: hidden;
			box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
		}

		.progress {
			height: 100%;
			background: linear-gradient(to right, #d90000, #800000);
			border-radius: 1rem;
			transition: width 0.3s ease;
		}

        /* Card and form styles */
		.card {
			background-color: var(--white);
			border-radius: var(--card-radius);
			box-shadow: 0 2px 5px rgba(110, 0, 0, 0.1);
			padding: 2rem;
			margin-bottom: 1.5rem;
			border-left: 3px solid var(--primary);
		}

		.card-title {
			font-size: 1.5rem;
			font-weight: bold;
			margin-bottom: 1.5rem;
			color: var(--primary-dark);
			border-bottom: 2px solid var(--primary-light);
			padding-bottom: 0.75rem;
		}

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--dark);
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--element-radius);
            font-size: 1rem;
            transition: var(--standard-transition);
        }

		.form-control:focus {
			border-color: var(--primary);
			box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.2);
			outline: none;
		}

        .form-control-inline {
            width: auto;
            display: inline-block;
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* Select styles */
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23333' viewBox='0 0 12 12'%3E%3Cpolyline points='3,5 6,8 9,5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Textarea styles */
        textarea.form-control {
            min-height: 150px;
            resize: vertical;
            line-height: 1.5;
        }

        /* Checkbox styles */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 0.75rem;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Tab card styles */
		.tab-card {
			border: 1px solid var(--light-gray);
			border-radius: var(--element-radius);
			padding: 1.5rem;
			margin-bottom: 1.5rem;
			transition: var(--standard-transition);
			border-left: 3px solid var(--primary-light);
		}
		
		.tab-card:hover {
			border-left: 3px solid var(--primary);
			box-shadow: var(--hover-shadow);
		}

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .tab-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-dark);
        }

        .tab-color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            display: inline-block;
            margin-left: 0.75rem;
            box-shadow: var(--standard-shadow);
        }

        /* Nested container styles */
        .nested-container {
            margin-left: 2rem;
            padding: 1rem;
            border-left: 3px solid var(--light-gray);
            margin-top: 0.5rem;
        }

        /* Color picker styles */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            display: inline-block;
            box-shadow: var(--standard-shadow);
        }

        /* Prompt output styles */
        .prompt-output {
            background-color: #f9f9f9;
            border-radius: var(--element-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.6;
            font-size: 0.95rem;
            border: 1px solid var(--light-gray);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Tips container styles */
        .tips-container {
            background-color: var(--warning-light);
            border-radius: var(--element-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            border-left: 4px solid var(--warning);
        }

        .tips-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .tips-list {
            margin-left: 1.5rem;
            line-height: 1.6;
        }

        /* Button styles */
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--element-radius);
            font-weight: bold;
            cursor: pointer;
            transition: var(--standard-transition);
            font-size: 1rem;
            box-shadow: var(--standard-shadow);
        }

		.btn-primary:hover {
			background: linear-gradient(to bottom, #b71c1c, #7f0000);
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(110, 0, 0, 0.3);
		}

		.btn-primary {
			background: linear-gradient(to bottom, #d90000, #b71c1c);
			color: var(--white);
			border: none;
			transition: all 0.3s ease;
		}


        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--gray);
            color: var(--white);
        }

        .btn-secondary:hover {
            background-color: #7d7d7d;
        }

        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background-color: #388e3c;
        }

        /* Footer styles */
		.footer {
			background: linear-gradient(to right, #7f0000, #b71c1c);
			color: var(--white);
			text-align: center;
			padding: 1.5rem;
			margin-top: auto;
			box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
		}
		
        /* Utility classes */
        .hidden {
            display: none;
        }

        /* Options section */
        .options-section {
            border-top: 1px solid var(--light-gray);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .options-section-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-dark);
            font-size: 1.2rem;
        }

        /* Feature section */
        .feature-section {
            margin-top: 1.5rem; 
            padding: 1.25rem;
            background-color: var(--primary-light);
            border-radius: var(--card-radius);
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .feature-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
        }

        .feature-description {
            font-size: 0.95rem;
            color: var(--dark);
            margin-bottom: 1rem;
        }

        /* Template styles */
		.template-card {
			border: 1px solid var(--light-gray);
			border-radius: var(--card-radius);
			padding: 1.5rem;
			margin-bottom: 1.25rem;
			cursor: pointer;
			transition: var(--standard-transition);
			border-left: 3px solid transparent;
		}
		
		.template-card:hover {
			border-left: 3px solid var(--primary);
			box-shadow: var(--hover-shadow);
			transform: translateY(-3px);
		}

		.template-card.selected {
			border-color: var(--primary);
			background-color: var(--primary-light);
			box-shadow: var(--hover-shadow);
			border-left: 5px solid var(--primary);
		}

        .template-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .template-description {
            font-size: 0.95rem;
            color: var(--dark);
            line-height: 1.5;
        }

        .template-flow {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            color: var(--primary);
            font-size: 0.9rem;
            align-items: center;
        }

        .template-flow-item {
            padding: 0.4rem 0.75rem;
            background-color: var(--primary-light);
            border-radius: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .flow-arrow {
            color: var(--gray);
            display: flex;
            align-items: center;
            font-weight: bold;
        }

        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.75rem;
        }

        .badge-info {
            background-color: var(--info-light);
            color: var(--info);
        }

        /* Domain options */
        .domain-options {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: var(--card-radius);
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Radio styles */
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin: 0.75rem 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
        }

        .radio-option input {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
        }

        /* Level selector */
        .level-selector {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .level-category {
            flex: 1;
            border: 1px solid var(--light-gray);
            border-radius: var(--card-radius);
            padding: 1.25rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: var(--standard-transition);
        }

        .level-category:hover {
            box-shadow: var(--hover-shadow);
        }

        .level-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 0.75rem;
        }

        .level-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Icon styles */
        .tab-icon-display {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            font-size: 28px;
            border-radius: 12px;
            background-color: #f5f5f5;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: var(--standard-transition);
        }

        .tab-icon-display:hover {
            background-color: #e3f2fd;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .icon-picker {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: var(--hover-shadow);
            z-index: 100;
            background-color: white;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
        }

        .icon-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--standard-transition);
        }

        .icon-option:hover {
            background-color: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: var(--standard-shadow);
        }

        .icon-option.selected {
            border-color: var(--primary);
            background-color: #e3f2fd;
        }

        .icon-display {
            font-size: 28px;
            margin-bottom: 8px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(to bottom right, #f5f5f5, #e0e0e0);
        }

        .icon-name {
            font-size: 0.85rem;
            text-align: center;
            color: #555;
            font-weight: 500;
        }

        .picker-guide {
            font-size: 13px;
            color: #777;
            text-align: center;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        /* SVG container */
        .svg-container {
            border: 1px solid var(--light-gray);
            border-radius: var(--element-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .svg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .svg-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-dark);
        }

        .svg-actions {
            display: flex;
            gap: 0.75rem;
        }

        .svg-actions button {
            padding: 0.35rem 0.75rem;
            font-size: 0.9rem;
        }

        /* Fullscreen controls */
        .fullscreen-controls {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--element-radius);
            background-color: #f9f9f9;
        }

        /* Selected levels display */
        .selected-levels {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: var(--primary-light);
            border-radius: var(--element-radius);
            font-size: 0.95rem;
            color: var(--primary-dark);
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Style previews */
        .style-preview {
            border: 1px solid var(--light-gray);
            border-radius: var(--card-radius);
            margin-top: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .style-preview-header {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--element-radius);
            margin-bottom: 0.75rem;
        }

        .style-preview-tab {
            padding: 0.35rem 0.75rem;
            border-radius: var(--element-radius);
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }

        /* Style sober */
        .style-preview.sober .style-preview-header {
            background-color: #455a64;
            color: white;
        }

        .style-preview.sober .style-preview-tab {
            background-color: #eceff1;
            color: #333;
        }

        .style-preview.sober .style-preview-tab.active {
            background-color: #546e7a;
            color: white;
        }

        /* Style color */
        .style-preview.color .style-preview-header {
            background-color: #2196F3;
            color: white;
        }

        .style-preview.color .style-preview-tab {
            background-color: #ffeb3b;
            color: #333;
        }

        .style-preview.color .style-preview-tab.active {
            background-color: #4CAF50;
            color: white;
        }

        .style-preview.color .style-preview-tab:nth-child(3) {
            background-color: #F44336;
            color: white;
        }

        /* Style gradient */
        .style-preview.gradient .style-preview-header {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: white;
        }

        .style-preview.gradient .style-preview-tab {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-light));
            color: white;
        }

        .style-preview.gradient .style-preview-tab.active {
            background: linear-gradient(to right, var(--gradient-end), var(--gradient-dark));
            color: white;
        }

        /* Style neumorphic */
        .style-preview.neumorphic {
            background-color: #e0e0e0;
            border-radius: 16px;
            box-shadow: 10px 10px 20px #bebebe, -10px -10px 20px #ffffff;
        }

        .style-preview.neumorphic .style-preview-header {
            background-color: #e0e0e0;
            color: #333;
            box-shadow: inset 2px 2px 5px #bebebe, inset -2px -2px 5px #ffffff;
        }

        .style-preview.neumorphic .style-preview-tab {
            background-color: #e0e0e0;
            color: #333;
            margin-right: 12px;
        }

        .style-preview.neumorphic .style-preview-tab.active {
            box-shadow: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;
        }

        .style-preview.neumorphic .style-preview-tab:not(.active) {
            box-shadow: inset 2px 2px 5px #bebebe, inset -2px -2px 5px #ffffff;
        }

        /* Style néo (NOUVEAU) */
        .style-preview.neo {
            background-color: #f8f9fa;
            border-radius: 16px;
            border: 2px solid var(--neo-color, #00b5d9);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .style-preview.neo .style-preview-header {
            background-color: var(--neo-color, #00b5d9);
            color: white;
            border-radius: 12px;
        }

        .style-preview.neo .style-preview-tab {
            background-color: white;
            color: #333;
            margin-right: 12px;
            border: 2px solid var(--neo-color, #00b5d9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .style-preview.neo .style-preview-tab.active {
            background-color: var(--neo-color, #00b5d9);
            color: white;
        }


		/* Style pour les pastilles du style sobre */
		.sober-color-options {
			display: flex;
			gap: 0.75rem;
			margin-top: 1rem;
		}
		
		.sober-color-option {
			width: 30px;
			height: 30px;
			border-radius: 50%;
			border: 2px solid white;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
			cursor: pointer;
			transition: var(--standard-transition);
		}
		
		.sober-color-option:hover, .sober-color-option.selected {
			transform: scale(1.2);
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
		}
		
		.sober-color-option.default {
			background-color: #455a64;
		}
		
		.sober-color-option.red {
			background-color: #ad4b4b;
		}
		
		.sober-color-option.yellow {
			background-color: #e3c878;
		}
		
		.sober-color-option.blue {
			background-color: #4f81b3;
		}
		
		.sober-color-option.purple {
			background-color: #7e57c2;
		}



        /* Neo style color selector */
        .neo-color-options {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .neo-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: var(--standard-transition);
        }

        .neo-color-option:hover, .neo-color-option.selected {
            transform: scale(1.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .neo-color-option.blue {
            background-color: #00b5d9;
        }

        .neo-color-option.red {
            background-color: #f08b65;
        }

        .neo-color-option.green {
            background-color: #0bd67e;
        }

        .neo-color-option.gold {
            background-color: #d6a00b;
        }

		.neo-color-option.lavender {
			background-color: #9D8EC7;
		}
		
		.neo-color-option.mint {
			background-color: #8FD5B3;
		}
		
		.neo-color-option.salmon {
			background-color: #F5B5C8;
		}

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        /* Style tabs info */
        #style-tabs-info {
            margin: 15px 0;
            padding: 10px;
            font-size: 0.9rem;
            background-color: #FFF8E1;
            border-left: 4px solid #FFC107;
            border-radius: 4px;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #607d8b;
                --primary-light: #263238;
                --primary-dark: #90a4ae;
                --dark: #f5f5f5;
                --light-gray: #424242;
                --white: #121212;
            }

            body {
                color: #e0e0e0;
            }

            .form-control {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }

            .preview-content, 
            .prompt-output {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }

            .icon-display {
                background: linear-gradient(to bottom right, #333, #1e1e1e);
            }

            .style-preview.sober .style-preview-tab {
                background-color: #37474f;
                color: #e0e0e0;
            }
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
            }

            .preview-panel {
                width: 50%;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .title {
                font-size: 1.3rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .step {
                width: 2rem;
                height: 2rem;
                font-size: 0.85rem;
            }

            .form-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .template-flow {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
                margin: 0.35rem 0;
            }

            .level-selector {
                flex-direction: column;
            }
            
            .icon-picker {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .card {
                padding: 1.25rem;
            }

            .preview-panel {
                width: 100%;
            }
        }

        /* Styles pour mettre en évidence l'option du certificat */
        .certificate-highlight {
            background-color: #fffde7;
            border: 2px solid #ffd54f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .certificate-badge {
            position: absolute;
            top: -12px;
            right: 15px;
            background-color: #ffd54f;
            color: #5d4037;
            padding: 3px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .certificate-preview-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            background-color: #fff;
        }
        
        .certificate-info {
            font-size: 0.95rem;
            color: #5d4037;
            margin-top: 10px;
            padding: 8px;
            background-color: #fff8e1;
            border-radius: 4px;
        }
        
		/* Styles pour les alertes de l'importation de fichiers */
		.alert {
			padding: 10px 15px;
			border-radius: 4px;
			font-weight: 500;
			margin-bottom: 10px;
		}
		.alert-info {
			background-color: #ffebee;
			color: #c62828;
			border: 1px solid #ef9a9a;
		}
		
		.alert-success {
			background-color: #e8f5e9;
			color: #2e7d32;
			border: 1px solid #a5d6a7;
		}
		
		.alert-warning {
			background-color: #fff3e0;
			color: #e65100;
			border: 1px solid #ffe0b2;
		}
		
		.alert-danger {
			background-color: #ffebee;
			color: #b71c1c;
			border: 1px solid #ef9a9a;
		} 
		       
		/* Styles pour la section API */
		.api-config-section {
			background-color: var(--light);
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
		}
		
		.api-header {
			display: flex;
			align-items: center;
			margin-bottom: 15px;
		}
		
		.api-input-group {
			margin-bottom: 10px;
		}
		
		.api-input-wrapper {
			display: flex;
			align-items: center;
		}
		
		.api-input-wrapper input {
			flex: 1;
		}
		
		.toggle-visibility-btn {
			background: none;
			border: none;
			cursor: pointer;
			margin-left: -30px;
			z-index: 10;
			color: #888;
		}
		
		.api-format-info {
			display: block;
			font-size: 0.8rem;
			color: #666;
			margin-top: 5px;
		}
		
		.api-model-select {
			margin-bottom: 15px;
		}
		
		.api-status {
			margin-top: 10px;
			padding: 8px;
			border-radius: 4px;
			display: none;
		}
		
		.api-status.success {
			background-color: #d4edda;
			color: #155724;
			display: block;
		}
		
		.api-status.error {
			background-color: #f8d7da;
			color: #721c24;
			display: block;
		}
		
		.api-test-panel {
			background-color: var(--light);
			padding: 20px;
			border-radius: 8px;
		}
		
		.api-test-form {
			margin-bottom: 20px;
		}
		
		.api-test-result {
			background-color: white;
			border: 1px solid #ddd;
			border-radius: 6px;
			overflow: hidden;
		}
		
		.result-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			background-color: #f5f5f5;
			padding: 10px 15px;
			border-bottom: 1px solid #ddd;
		}
		
		.result-header h4 {
			margin: 0;
		}
		
		.result-content {
			padding: 15px;
			min-height: 200px;
			max-height: 400px;
			overflow-y: auto;
			white-space: pre-wrap;
		}
		
		.placeholder-text {
			color: #999;
			font-style: italic;
		}
		
		.spinner {
			width: 40px;
			height: 40px;
			margin: 20px auto;
			border: 4px solid rgba(0, 0, 0, 0.1);
			border-left-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin {
			to { transform: rotate(360deg); }
		}
		
		#loading-spinner {
			text-align: center;
			padding: 20px;
		}
		
		/* Modal général */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
		}
		
		.modal-content {
			position: relative;
			background-color: white;
			margin: 50px auto;
			padding: 20px;
			border-radius: 8px;
			width: 90%;
			max-width: 1200px;
			max-height: 80vh;
			overflow-y: auto;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
		}
		
		.close {
			position: absolute;
			top: 15px;
			right: 20px;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}
		
		.tools-container {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}
		
		.resources-column, .activities-column {
			background-color: var(--light);
			border-radius: 8px;
			padding: 20px;
		}
		
		.column-title {
			color: var(--primary-dark);
			margin-bottom: 15px;
			border-bottom: 2px solid var(--primary-dark);
			padding-bottom: 10px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		
		.section-buttons {
			margin-top: 20px;
			text-align: right;
		}
		
		/* Style pour le bouton IA dans la barre de navigation */
		.ia-api-nav-item {
			background-color: var(--primary);
			color: white;
			padding: 0.5rem 1rem;
			border-radius: 4px;
			margin-left: 10px;
			text-decoration: none;
			font-weight: bold;
			display: inline-flex;
			align-items: center;
			transition: all 0.3s ease;
		}
		
		.ia-api-nav-item:hover {
			background-color: var(--primary-dark);
			transform: translateY(-2px);
		}
		
		.ia-api-nav-item i {
			margin-right: 5px;
		}
		
		/* Styles pour la recherche de ressources multimédias */
		.multimedia-search-section {
			background-color: var(--primary-light);
			padding: 15px;
			border-radius: var(--card-radius);
			margin-top: 20px;
			border-left: 4px solid var(--primary);
		}
		
		.multimedia-search-form {
			margin-bottom: 15px;
		}
		
		.search-results-container {
			border: 1px solid var(--light-gray);
			border-radius: var(--element-radius);
			background-color: white;
			padding: 15px;
			margin-top: 15px;
			max-height: 300px;
			overflow-y: auto;
		}
		
		.result-card {
			border: 1px solid #e0e0e0;
			border-radius: 6px;
			padding: 10px;
			margin-bottom: 10px;
			display: flex;
			align-items: center;
			background-color: #f9f9f9;
			transition: all 0.2s ease;
		}
		
		.result-card:hover {
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			transform: translateY(-2px);
		}
		
		.result-thumbnail {
			width: 80px;
			height: 60px;
			background-color: #e0e0e0;
			margin-right: 15px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
		}
		
		.result-thumbnail img {
			max-width: 100%;
			max-height: 100%;
		}
		
		.result-info {
			flex: 1;
		}
		
		.result-title {
			font-weight: bold;
			margin-bottom: 5px;
			font-size: 1rem;
		}
		
		.result-description {
			color: #666;
			font-size: 0.9rem;
			margin-bottom: 5px;
		}
		
		.result-url {
			color: #1a73e8;
			font-size: 0.8rem;
			word-break: break-all;
		}
		
		.result-actions {
			display: flex;
			justify-content: flex-end;
			gap: 5px;
		}
		
		.result-actions button {
			background-color: var(--primary);
			color: white;
			border: none;
			border-radius: 4px;
			padding: 5px 10px;
			font-size: 0.8rem;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		
		.result-actions button:hover {
			background-color: var(--primary-dark);
		}
		
		.search-status {
			text-align: center;
			padding: 10px;
			color: #666;
		}

		.certification-tab-card {
			border-left: 3px solid #ffd700 !important; /* Bordure dorée */
			background-color: #fffaf0 !important; /* Fond légèrement doré */
			box-shadow: 0 3px 8px rgba(255, 215, 0, 0.2) !important;
		}
		
		.certification-tab-card .tab-title {
			color: #b8860b !important; /* Texte du titre en doré foncé */
		}
		
		.certification-tab-card .checkbox-container label {
			font-weight: bold;
			color: #b8860b; /* Couleur dorée pour le texte de la checkbox */
		}

		.tabs-preview-container {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin: 15px 0;
			padding: 15px;
			background-color: #f5f5f5;
			border-radius: var(--element-radius);
			border: 1px solid #e0e0e0;
		}
		
		.tab-preview {
			padding: 8px 15px;
			background-color: #fff;
			border-radius: 5px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.1);
			font-size: 0.9rem;
			max-width: 150px;
			text-overflow: ellipsis;
			overflow: hidden;
			white-space: nowrap;
		}
		
		.tab-preview:hover {
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
		}

    </style>
    
    <!-- FontAwesome pour les icônes -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <header class="header">
	        <div class="logo-container" style="display: flex; align-items: center; margin-right: 10px; height: 50px; width: 40px;">
        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="100%" viewBox="0 0 608 560" enable-background="new 0 0 608 560" xml:space="preserve">
<path fill="#f5aaa9" opacity="1.000000" stroke="none" 
	d="
M138.449982,561.000000 
	C134.266647,551.287659 135.365463,540.611084 131.995209,530.834900 
	C130.661865,526.967163 131.100021,522.909790 130.450867,518.977417 
	C127.135948,498.896393 127.103577,478.651245 127.616806,458.402527 
	C128.040283,441.695343 129.571350,424.980408 131.391052,408.445923 
	C132.424850,399.052612 133.395340,389.110840 137.002640,379.771454 
	C139.254303,373.941803 140.644089,367.509186 141.848434,361.224487 
	C142.766006,356.436218 145.052963,352.114380 146.909943,347.824463 
	C150.815628,338.801697 154.798843,329.672607 160.564758,321.566772 
	C163.918106,316.852570 167.213638,312.064148 170.966019,307.677643 
	C173.844589,304.312592 174.622025,300.925232 172.618942,297.152832 
	C167.588745,287.679443 161.920578,278.600128 155.693588,269.845947 
	C144.411621,253.985275 129.587784,241.221603 117.620056,225.994232 
	C109.454407,215.604538 101.662537,204.955154 95.221062,193.296707 
	C90.441261,184.645706 85.668350,176.000610 81.676559,166.986221 
	C78.147179,159.016083 75.606171,150.612534 72.200424,142.581985 
	C69.545677,136.322235 67.877029,129.733444 65.870758,123.322273 
	C62.629879,112.965836 60.983616,102.129616 60.771076,91.146706 
	C60.616028,83.134628 60.293682,75.003349 61.930763,67.247322 
	C63.739174,58.679585 67.857010,50.816429 73.856781,44.151058 
	C80.562157,36.701801 88.193268,30.415354 97.058395,25.713034 
	C111.127815,18.250210 126.059013,15.052276 142.022812,16.283873 
	C163.228134,17.919853 178.328110,29.876282 191.547455,45.052452 
	C197.862152,52.301876 203.494583,60.069801 208.206940,68.505035 
	C211.835587,75.000412 214.652863,81.904198 218.257126,88.372246 
	C222.539337,96.056931 224.560181,104.596413 228.285095,112.488548 
	C230.197067,116.539505 231.438782,121.257706 232.290329,125.564751 
	C233.701874,132.704010 236.119553,139.602951 237.804276,146.608429 
	C239.754471,154.717789 240.371262,163.181778 243.349899,171.076035 
	C244.151825,173.201340 243.924484,175.691238 244.449341,177.948715 
	C248.103943,193.667542 248.465225,209.864014 251.430038,225.690536 
	C252.373413,230.726349 252.619949,235.963165 252.553238,241.099808 
	C252.470734,247.454147 255.550018,252.936111 256.739075,258.922363 
	C257.237000,261.429230 259.485748,262.428040 261.837433,261.233185 
	C266.499268,258.864532 271.491669,258.867004 276.462311,258.836609 
	C290.793335,258.748962 305.125275,258.789917 319.456757,258.811859 
	C321.117401,258.814392 322.897919,258.666565 324.415527,259.189789 
	C328.855194,260.720520 331.907440,258.702942 333.270660,255.019485 
	C334.797455,250.894012 336.530029,246.792114 338.116852,242.724731 
	C340.974976,235.398544 341.669250,227.600479 344.350525,220.283524 
	C347.068451,212.866470 346.282288,204.814651 347.818939,197.134415 
	C349.121124,190.626053 350.134644,184.034973 349.893280,177.306824 
	C349.811981,175.040009 350.379150,172.635757 351.150482,170.472809 
	C354.106140,162.185074 354.228119,153.245651 357.198334,144.970779 
	C359.415466,138.793976 361.495575,132.568115 363.695190,126.384911 
	C366.180878,119.397484 368.929718,112.538971 372.029663,105.772652 
	C376.038300,97.022911 380.827240,88.720055 385.414520,80.311249 
	C391.587738,68.995369 398.981079,58.425610 406.861877,48.221859 
	C417.550629,34.382401 430.905640,23.770842 447.208893,17.553555 
	C453.631226,15.104392 461.069305,15.770885 467.988525,16.285204 
	C493.088501,18.150942 513.514832,29.689657 527.912598,49.832462 
	C539.908325,66.614830 543.151489,85.942070 538.375305,106.656433 
	C536.646057,114.156250 534.688904,121.655334 533.041687,129.196716 
	C532.083130,133.585312 529.946655,137.822281 528.217773,142.057053 
	C525.051697,149.812027 521.510559,157.442947 517.641357,164.873337 
	C513.986694,171.891769 510.057312,178.821533 505.625580,185.368439 
	C498.689575,195.614777 491.334351,205.584061 483.968567,215.531387 
	C467.218994,238.151337 448.370056,258.942261 428.506256,278.845398 
	C424.410492,282.949249 421.269470,287.825134 418.090027,292.662811 
	C416.343109,295.320862 416.474274,297.474731 418.670471,299.719971 
	C424.709076,305.893524 430.491943,312.298248 435.168121,319.593994 
	C438.905182,325.424652 442.064056,331.607910 445.524872,337.580017 
	C449.788696,344.937927 452.317719,352.952972 455.010132,360.734161 
	C457.670746,368.423431 459.409088,376.629608 461.003967,384.786194 
	C464.700562,403.691925 467.416565,422.684479 467.846375,441.899719 
	C468.311218,462.682343 469.915924,483.678802 466.980377,504.202545 
	C465.286652,516.044312 465.697449,528.257874 461.808838,539.931335 
	C459.695068,546.276917 459.878571,553.387756 459.012939,560.576660 
	C456.299988,561.000000 453.599976,561.000000 450.363342,560.547485 
	C448.834015,554.300049 452.047943,549.159546 452.558960,543.774902 
	C454.046906,528.096375 457.861267,512.698975 457.599457,496.790558 
	C457.388855,483.993683 458.515594,471.176025 456.977844,458.393829 
	C456.779144,456.741943 456.838989,454.899536 454.754211,454.384888 
	C452.746643,453.889404 452.454987,455.770416 451.536652,456.863434 
	C447.542725,461.617279 448.883301,467.103027 448.985352,472.554810 
	C449.290649,488.864105 447.918976,505.014069 445.990875,521.267456 
	C444.407928,534.611755 441.792114,547.730408 440.000000,561.000000 
	C437.299988,561.000000 434.599976,561.000000 431.379547,560.579224 
	C431.003113,553.159912 435.006317,546.850891 434.416840,539.695984 
	C433.804077,532.258240 438.124664,525.613403 437.909271,518.136719 
	C437.718353,511.510498 438.357056,504.863068 438.545380,498.222626 
	C438.792999,489.491058 438.913269,480.754669 440.828247,471.377838 
	C439.129639,472.106110 438.329987,472.315826 437.678802,472.748779 
	C431.226593,477.038422 425.158356,482.194031 416.616791,481.543488 
	C415.888947,481.488068 415.130676,482.256439 414.342651,482.500458 
	C407.917969,484.490265 401.527069,486.611572 395.034149,488.350311 
	C391.177643,489.383057 390.270294,490.879303 392.421906,494.270355 
	C397.226196,501.842194 400.356079,509.799744 399.300293,519.056213 
	C398.817780,523.286743 394.720032,529.791443 390.738068,530.914307 
	C385.561127,532.374146 380.701080,534.884399 375.077637,534.928162 
	C370.092926,534.966858 365.870667,538.541504 360.605377,538.314209 
	C353.456360,538.005615 346.271362,538.122192 339.118500,538.436523 
	C332.981812,538.706299 329.398590,535.316833 326.079712,530.854797 
	C320.820923,523.784485 322.737152,515.805603 323.337677,508.206665 
	C323.678619,503.891785 322.755798,502.911285 318.766907,503.056793 
	C306.968933,503.487213 295.172638,504.061249 283.351776,503.453369 
	C277.581421,503.156647 271.783142,503.402039 265.654236,503.402039 
	C267.482208,509.378204 268.407959,515.446106 267.732086,521.547363 
	C266.536591,532.339355 260.393341,538.040955 249.874237,539.204041 
	C240.521881,540.238098 231.271271,538.325073 222.014374,538.571350 
	C214.197601,538.779358 207.485031,535.340454 200.279877,533.687988 
	C196.939056,532.921753 193.318939,530.083191 192.050720,526.201965 
	C189.037079,516.979431 190.692444,507.905029 194.423813,499.351776 
	C197.388443,492.556091 196.855560,490.538696 189.800980,488.647003 
	C180.174606,486.065704 171.490707,481.354034 162.903992,476.461090 
	C161.518066,475.671356 160.533813,473.664795 158.642105,474.494629 
	C156.468979,475.447876 157.241776,477.700714 157.258270,479.398865 
	C157.424500,496.501678 156.258774,513.556030 159.518417,530.669861 
	C161.415909,540.632080 160.371201,551.175354 164.000000,561.000000 
	C160.969406,561.000000 157.938812,561.000000 154.412582,560.548645 
	C153.578537,555.972534 154.135681,551.713562 152.452713,547.783203 
	C150.507034,543.239380 150.175888,538.388000 149.998260,533.625000 
	C149.224365,512.875183 147.869385,492.116608 149.866455,471.356140 
	C150.090637,469.025696 150.015976,466.752380 148.487869,464.695312 
	C146.319687,461.776642 144.301407,458.745270 142.262543,455.732635 
	C141.619583,454.782593 141.251846,453.465454 139.780701,453.676575 
	C138.205429,453.902618 137.681442,455.211029 137.474991,456.560333 
	C137.274597,457.869843 137.261002,459.210846 137.209656,460.539764 
	C136.226883,485.974030 137.906342,511.264191 141.385803,536.451721 
	C141.587906,537.914673 142.010040,539.405029 142.633011,540.741272 
	C144.504776,544.755981 145.143677,548.987427 145.130508,553.348633 
	C145.122299,556.068542 145.619812,558.634277 147.000000,561.000000 
	C144.299988,561.000000 141.599976,561.000000 138.449982,561.000000 
M399.964478,387.194458 
	C407.973511,384.557373 415.399506,386.174133 423.182983,389.051788 
	C434.236816,393.138428 442.709045,399.975708 449.202637,409.498505 
	C455.252197,418.370117 457.085052,428.323059 456.213562,438.921722 
	C456.045807,440.961578 455.499451,443.410767 457.677917,445.053345 
	C458.928925,443.964142 458.684082,442.906921 458.672302,441.951660 
	C458.375183,417.828613 453.509338,394.292908 449.474335,370.650726 
	C449.419403,370.328705 449.329895,369.962860 449.130066,369.722717 
	C444.931274,364.675842 445.067047,357.967316 442.551056,352.193085 
	C438.596741,343.118042 434.540924,334.144684 429.252533,325.843201 
	C416.407623,305.679749 398.540985,291.190094 376.778595,281.606812 
	C373.225677,280.042206 369.671417,278.162506 365.766602,277.298157 
	C358.530365,275.696320 351.591064,273.022858 344.110901,272.155518 
	C340.491486,271.735840 337.166016,269.691345 333.119690,269.746796 
	C326.658905,269.835480 320.162628,269.129974 313.720703,268.408569 
	C301.953400,267.090851 290.274109,266.453583 278.492645,268.701843 
	C270.986023,270.134369 263.212830,268.625885 255.586319,269.990173 
	C252.365051,270.566437 250.152252,273.306274 246.786057,273.215027 
	C238.923508,273.001892 232.274811,277.254547 225.014221,279.264435 
	C217.605911,281.315155 211.141098,285.480133 204.655914,289.362335 
	C195.271194,294.980347 186.358322,301.555054 179.502213,310.090607 
	C171.557068,319.981964 164.337265,330.406372 158.932220,342.121429 
	C155.127594,350.367737 151.963928,358.889618 149.099716,367.359192 
	C146.909271,373.836365 143.996674,380.675568 144.760773,388.046753 
	C144.942337,389.797974 144.109879,391.572510 143.214310,393.242218 
	C139.885895,399.447784 142.056213,406.240906 140.880829,412.691345 
	C153.306366,386.057861 184.245850,378.823120 206.770538,390.163940 
	C220.773972,397.214478 229.437439,409.811951 232.555313,425.099854 
	C235.771240,440.868591 229.524857,454.394531 218.573975,466.645966 
	C230.905685,466.099670 241.710251,470.659393 253.359299,470.218536 
	C278.390533,469.271149 303.308960,475.350250 328.451721,471.863556 
	C340.333740,470.215820 352.352325,470.590179 364.287781,469.723877 
	C367.124908,469.517975 370.198273,469.438080 372.625977,467.069458 
	C372.187195,466.296936 371.909637,465.715637 371.550629,465.189972 
	C365.743805,456.687744 359.828674,448.235260 361.545197,437.045166 
	C361.719940,435.906097 361.668549,434.704926 361.544525,433.551666 
	C360.143463,420.519623 366.305054,410.544281 374.585297,401.487396 
	C381.258881,394.187836 389.771271,390.014801 399.964478,387.194458 
M124.869576,221.664093 
	C130.737549,229.084396 137.066528,236.087677 143.659363,242.874039 
	C156.494522,256.086060 167.457565,270.696838 176.681076,286.679443 
	C178.479507,289.795807 178.801208,293.434479 181.149490,297.163605 
	C200.539520,278.495300 223.987167,268.703522 249.475861,262.912231 
	C244.875870,254.744110 243.765457,246.113342 242.652786,238.024017 
	C240.880173,225.136810 240.525650,212.026169 239.126236,199.010117 
	C237.986023,188.404816 235.497787,178.079178 233.383972,167.831818 
	C231.681747,159.579895 229.990005,151.031296 227.586075,142.755554 
	C224.911133,133.546814 222.236893,124.282730 219.602432,115.022774 
	C216.436646,103.895210 211.535904,93.481651 206.468491,83.287231 
	C199.501999,69.272285 191.432755,55.757240 180.019867,44.594490 
	C166.715057,31.581270 151.424286,23.744246 132.333801,24.009754 
	C127.444946,24.077747 123.380623,26.326986 118.852211,27.014095 
	C109.689224,28.404421 101.708626,32.622223 94.080566,37.372364 
	C82.132698,44.812542 74.854141,55.533115 70.675919,69.249992 
	C65.540771,86.108459 70.383476,101.942497 73.835205,117.802559 
	C75.072792,123.488991 76.538986,129.570496 78.832077,135.278503 
	C80.220818,138.735413 82.429054,142.087494 83.030533,145.718369 
	C84.468872,154.400940 89.168266,161.755356 92.492638,169.582779 
	C96.446938,178.893402 101.327789,187.919525 106.973251,196.459442 
	C112.531555,204.867508 117.939056,213.365234 124.869576,221.664093 
M520.207764,53.338787 
	C519.385864,52.291489 518.618958,51.195042 517.733398,50.204597 
	C509.901428,41.444881 500.628479,35.075562 489.623566,30.505392 
	C482.480225,27.538872 475.261597,25.257282 467.843475,24.399204 
	C451.206665,22.474773 437.663208,30.041931 425.499786,40.427921 
	C416.601013,48.026287 410.063782,57.725800 403.451721,67.196747 
	C397.593475,75.588013 392.585571,84.607025 387.636505,93.588181 
	C383.684784,100.759521 380.169250,108.195045 376.860809,115.690178 
	C373.739014,122.762451 370.026489,129.856522 368.624298,137.325928 
	C367.218903,144.812210 364.816742,152.065460 362.787659,159.223145 
	C360.004578,169.040634 359.710938,179.124481 357.289246,188.944336 
	C354.747650,199.250458 356.210052,210.294968 353.129059,220.845474 
	C350.695465,229.179047 349.067413,237.703796 346.163879,245.986603 
	C344.343750,251.178711 341.220886,256.035614 340.487152,261.440979 
	C341.048737,261.952209 341.275299,262.344757 341.533295,262.366577 
	C352.861603,263.325409 363.462799,267.291809 373.910095,271.187988 
	C385.168823,275.386749 395.905090,281.040497 405.409943,288.625275 
	C408.120758,290.788452 409.684296,290.796326 411.528595,287.424408 
	C414.798096,281.446869 418.978577,275.899536 423.906097,271.293182 
	C441.049774,255.267044 456.074432,237.400345 470.713257,219.149612 
	C480.880280,206.474030 490.561157,193.389114 499.114929,179.639175 
	C507.152832,166.718430 514.012756,153.069168 519.802246,138.840622 
	C523.942383,128.665619 527.712280,118.266541 529.513794,107.723473 
	C532.691528,89.126595 532.533691,70.348312 520.207764,53.338787 
M381.788300,475.177551 
	C376.051880,476.603333 370.192871,477.189453 364.331970,477.809570 
	C357.882751,478.491943 351.746674,481.232819 345.176483,481.039185 
	C311.294861,480.040894 277.262115,484.069458 243.534912,478.194611 
	C233.443298,476.436768 222.814438,478.382324 213.135757,473.671082 
	C212.129684,473.181366 210.295639,473.443451 209.285980,474.068146 
	C203.750595,477.493103 197.480865,478.930695 190.214798,481.100891 
	C258.513611,498.289734 325.581604,499.487152 393.003510,481.302307 
	C389.895325,478.023834 385.839081,477.339325 381.788300,475.177551 
M199.478485,511.381958 
	C197.022308,523.173401 201.468231,526.976440 212.862442,527.948547 
	C214.681442,528.103760 216.674805,527.955750 218.274185,528.659790 
	C228.145874,533.005188 238.551941,531.592102 248.801361,531.690247 
	C254.218689,531.742065 257.521698,528.526184 257.699402,523.089417 
	C257.884003,517.443115 257.812531,511.779724 257.608124,506.132660 
	C257.483185,502.681793 255.433853,500.305847 251.934418,500.394043 
	C240.922806,500.671448 230.111374,499.858307 219.558304,496.388123 
	C217.093872,495.577759 214.264984,496.470642 211.710342,495.346588 
	C206.656158,493.122772 204.311584,494.202972 203.326416,499.734283 
	C202.643509,503.568451 201.248947,507.072266 199.478485,511.381958 
M342.560394,530.489502 
	C356.343872,527.752686 370.663147,528.679810 384.219147,524.123108 
	C388.342560,522.737000 392.412811,518.957458 391.440247,515.015015 
	C389.693054,507.932770 386.265991,501.454742 383.346497,494.808563 
	C382.576385,493.055450 380.270569,492.494507 379.014771,493.305359 
	C373.940643,496.581818 367.888306,495.098389 362.733002,496.952057 
	C354.848969,499.786926 346.901642,500.611206 338.705017,500.234314 
	C335.622162,500.092590 333.834686,501.527191 333.532593,504.388916 
	C332.958649,509.825897 332.152313,515.217590 332.569214,520.777649 
	C333.024200,526.845520 336.137604,529.716125 342.560394,530.489502 
M401.042664,404.216644 
	C393.755829,405.846436 388.034241,409.944122 383.746490,415.877747 
	C376.316772,426.159332 375.194031,437.347717 380.319641,448.893341 
	C384.128113,457.472046 395.954865,465.988068 406.116852,466.702545 
	C413.027710,467.188446 418.773285,464.780518 424.768829,462.499115 
	C428.776245,460.974213 436.625427,451.492645 437.313904,447.626709 
	C423.570312,462.939056 409.899323,459.527679 401.606537,450.680695 
	C391.794983,440.213348 394.006897,426.766083 402.446869,418.136047 
	C410.836639,409.557373 426.504272,407.998230 438.107147,423.792480 
	C437.899261,416.002167 422.342743,404.398651 415.431824,404.225067 
	C410.935455,404.112152 406.434235,404.191864 401.042664,404.216644 
M153.086700,428.026489 
	C151.773956,437.481812 154.818497,445.786926 160.437836,453.085999 
	C165.004578,459.017792 171.193405,462.122620 178.834045,463.559052 
	C189.665329,465.595367 204.554321,460.747589 210.287506,451.444336 
	C212.857605,447.273834 216.673340,443.274139 215.355530,437.192047 
	C210.062256,449.495758 198.890610,458.631165 191.453217,456.977539 
	C179.383591,454.293854 170.018417,444.265839 169.571274,434.266144 
	C169.062515,422.888306 178.848282,412.117065 189.478333,409.328888 
	C195.795593,407.671906 200.976120,410.762329 205.606949,414.230072 
	C210.310760,417.752441 214.356842,422.142456 215.289505,428.562805 
	C215.708252,425.427826 215.471298,422.579987 213.856705,419.903656 
	C209.048492,411.933594 202.991470,406.349152 193.732056,402.731049 
	C183.262161,398.640015 175.283127,402.439941 167.112244,406.736359 
	C159.168396,410.913391 156.202896,419.229645 153.086700,428.026489 
M417.504456,419.273865 
	C407.825897,422.341034 398.548035,432.650818 406.620575,443.259399 
	C409.806793,447.446625 414.202423,449.861420 418.761810,449.797058 
	C423.743835,449.726715 428.277679,446.795959 430.973328,441.229675 
	C421.730316,445.914429 415.221313,445.165039 411.699280,439.146118 
	C410.276917,436.715363 409.384979,433.894775 409.993011,431.018951 
	C411.232086,425.158234 416.152405,422.591156 421.806305,419.517944 
	C419.805328,419.368500 418.997742,419.308197 417.504456,419.273865 
M199.524429,419.693665 
	C194.768692,418.160736 189.848358,417.908264 185.470474,420.240295 
	C179.794907,423.263519 176.725723,434.082581 180.198044,439.646881 
	C184.079651,445.866974 189.140427,450.363708 198.305389,446.770325 
	C187.348755,445.117889 182.931305,441.574402 182.854416,434.376190 
	C182.798355,429.128906 188.069595,423.411255 193.651321,423.078705 
	C197.637436,422.841217 200.908844,424.360138 203.716858,427.514343 
	C206.373657,430.498688 206.664124,433.994141 207.097992,437.597687 
	C209.636658,429.773529 205.898117,424.516602 199.524429,419.693665 
z"/>
<path fill="#f5aaa9" opacity="1.000000" stroke="none " 
	d="
M151.801880,41.036591 
	C168.853058,50.286411 180.412262,64.576225 190.078522,80.305359 
	C195.206161,88.649132 199.541763,97.593956 203.539566,106.663666 
	C207.100006,114.741165 209.016388,123.417892 213.250229,131.229477 
	C215.125610,134.689621 215.115021,138.893524 216.144165,142.709763 
	C218.153610,150.161148 221.103302,157.304123 222.603622,164.994476 
	C224.082520,172.574966 225.115799,180.325104 227.280563,187.762726 
	C228.412582,191.652130 229.275406,195.471069 229.288239,199.502960 
	C229.323166,210.474548 230.221420,221.440430 229.366669,232.418747 
	C228.398621,244.852173 222.895920,254.858551 211.799332,260.419434 
	C205.384872,263.633911 197.506134,263.194153 190.860123,260.221985 
	C163.422638,247.951660 145.187286,225.322159 127.251884,202.483307 
	C120.403503,193.762650 114.205566,184.536911 109.048599,174.738831 
	C104.298561,165.713913 99.569862,156.660690 95.129929,147.455109 
	C91.176399,139.258026 88.244614,130.724274 85.279892,122.297600 
	C81.847252,112.540955 80.660706,102.158676 80.478394,91.512772 
	C80.093407,69.032173 90.922562,54.086895 109.244591,43.037937 
	C117.409744,38.114006 125.827019,35.211132 135.566528,35.748531 
	C141.484192,36.075054 146.162643,39.245483 151.801880,41.036591 
M175.955032,73.644257 
	C173.404694,70.803978 170.771484,68.033226 168.319901,65.110130 
	C161.507538,56.987568 153.598877,49.423275 143.477997,46.903694 
	C130.137939,43.582706 116.846161,45.222355 105.671761,55.067295 
	C99.305214,60.676380 93.550926,67.182930 91.679352,75.074753 
	C89.588730,83.890190 87.243004,93.279411 90.609367,102.621803 
	C91.263123,104.436127 91.259369,106.587135 91.147835,108.559601 
	C90.739838,115.775452 94.829811,121.794746 96.603363,128.399368 
	C98.750618,136.395676 102.856697,143.889755 106.546753,151.443359 
	C111.694077,161.979965 116.930786,172.487335 123.222305,182.323608 
	C132.139160,196.264374 142.111420,209.536407 153.680298,221.433380 
	C166.156311,234.263229 178.453140,247.385803 196.486877,252.825043 
	C203.021393,254.795959 211.053238,253.244415 214.803818,247.348984 
	C221.779251,236.384445 222.814346,224.033218 221.438995,211.484695 
	C220.952515,207.046143 219.683746,202.667908 219.729401,198.149002 
	C219.840012,187.200577 216.048828,176.921204 213.944778,166.393112 
	C212.246048,157.893204 209.990662,149.299301 206.969315,141.173492 
	C204.921173,135.665085 203.992172,129.830109 201.306824,124.468025 
	C197.856537,117.578491 195.790909,110.068810 192.244858,103.113060 
	C190.275803,99.250671 188.712906,95.046333 186.544601,91.222557 
	C183.289764,85.482674 179.762863,79.897064 175.955032,73.644257 
z"/>
<path fill="#f5aaa9" opacity="1.000000" stroke="none" 
	d="
M381.942200,261.172699 
	C373.426971,254.021805 370.319275,245.054184 368.093842,234.504669 
	C365.514954,222.279617 365.159027,210.401260 366.924591,198.433517 
	C367.996796,191.165344 367.669861,183.700089 369.260834,176.720337 
	C371.112396,168.597290 372.963837,160.386581 374.859283,152.268448 
	C376.480957,145.322922 379.391663,138.846222 380.807617,131.892853 
	C381.665710,127.678719 383.761475,123.804527 385.322876,119.844368 
	C389.298340,109.761398 393.826111,99.894783 398.883026,90.237328 
	C405.945312,76.750137 414.480164,64.563004 425.460571,54.034527 
	C439.510315,40.563011 456.322968,35.721298 474.941223,40.228973 
	C490.501068,43.996193 503.241058,53.129128 509.301910,68.470726 
	C514.270813,81.048302 516.591187,94.340050 511.725281,107.917786 
	C509.507812,114.105476 509.117462,120.780228 507.070709,127.147743 
	C504.497772,135.152313 501.358276,142.908676 498.150177,150.607086 
	C494.810883,158.620331 490.641754,166.334930 486.294678,173.868027 
	C481.764435,181.718521 476.730591,189.292191 471.660736,196.814209 
	C464.538635,207.380981 457.390869,217.960556 449.063721,227.629517 
	C440.396301,237.693665 431.604706,247.800720 420.755066,255.524048 
	C413.172729,260.921509 405.118652,265.981232 395.024170,266.035706 
	C389.978271,266.062897 386.048248,264.175201 381.942200,261.172699 
M404.911774,254.753983 
	C408.007477,253.214828 411.421509,252.102036 414.147064,250.067123 
	C431.399384,237.186600 444.883087,220.722412 457.094177,203.248978 
	C463.225647,194.475159 469.259125,185.598495 474.572693,176.223724 
	C481.083008,164.737457 487.584686,153.317993 492.584747,141.052002 
	C494.205505,137.076096 494.819855,132.565216 496.937347,129.113815 
	C500.649628,123.062988 500.708130,116.160362 502.493073,109.791481 
	C504.790955,101.592384 504.201385,92.630562 503.754425,83.961662 
	C503.179535,72.812469 498.995148,63.560936 489.871918,56.681934 
	C484.595276,52.703285 478.524750,51.268696 472.387390,49.255028 
	C458.388214,44.661892 446.660004,48.930069 435.561462,56.511223 
	C422.446014,65.470070 414.490204,78.955696 407.091949,92.404099 
	C400.941254,103.584724 396.343781,115.653305 391.548462,127.526520 
	C390.025360,131.297714 388.081696,135.231384 387.576447,139.133331 
	C386.657928,146.227448 384.013245,152.876633 382.341309,159.666855 
	C379.473694,171.313110 377.007050,183.142487 376.045990,194.838364 
	C374.715118,211.033813 372.978485,227.590942 379.420441,243.660690 
	C383.046661,252.706406 387.458618,256.798889 397.143219,255.756348 
	C399.461273,255.506821 401.768463,255.156464 404.911774,254.753983 
z"/>
</svg>        </div>

        <div class="version-badge">V12.6</div>
        <h1 class="title">APP-Prompt</h1>
        <h3 class="title">Créateur de Prompts pour Applications Pédagogiques</h3>
        <span class="signature">@yoblin</span>
      
        
		<div class="ia-api-nav-container" style="display: inline-block; margin-left: 15px;">
			<a href="#" class="ia-api-nav-item" id="ia-api-btn">
				<i class="fas fa-robot"></i> IA & API
			</a>
		</div>
		
    </header>


    <div class="container">
        <!-- Nouvelle barre supérieure pour les actions -->
        <div class="top-bar">
            <div class="autosave-indicator">
                <span class="autosave-icon">✓</span>
                <span>Sauvegarde automatique activée</span>
            </div>
            <div class="actions-menu">
                <button class="action-btn" id="importBtn">Importer</button>
                <button class="action-btn" id="exportBtn">Exporter</button>
                <button class="action-btn" id="previewBtn">Aperçu</button>
                <div class="dropdown-container">
                    <button class="action-btn" id="settingsBtn">⚙️</button>
                    <div class="dropdown-menu hidden" id="settingsMenu">
                        <div class="dropdown-item" id="clearData">Réinitialiser</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="steps">
                <div class="step active" id="step-indicator-1">1</div>
                <div class="step" id="step-indicator-2">2</div>
                <div class="step" id="step-indicator-3">3</div>
                <div class="step" id="step-indicator-4">4</div>
                <div class="step" id="step-indicator-5">5</div>
                <div class="step" id="step-indicator-6">6</div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progress-bar" style="width: 16.67%"></div>
            </div>
        </div>

        <!-- Step 1: Subject and Level -->
        <div class="step-content animate-fade" id="step-1">
            <div class="card">
                <h2 class="card-title">Étape 1: Choisir le domaine et le niveau</h2>
                <div class="form-group">
                    <label class="form-label">Domaine de l'application:</label>
                    <select class="form-control" id="subject">
                        <option value="mathématiques">Mathématiques</option>
                        <option value="sciences physiques">Sciences Physiques</option>
                        <option value="chimie">Chimie</option>
                        <option value="programmation python">Programmation Python</option>
                        <option value="français">Français</option>
                        <option value="histoire-géographie">Histoire-Géographie</option>
                        <option value="langues">Langues</option>
                        <option value="technologie">Technologie</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="custom-subject-container">
                    <label class="form-label">Précisez le domaine:</label>
                    <input type="text" class="form-control" id="custom-subject" placeholder="Ex: Philosophie, Arts plastiques, etc.">
                </div>

                <div class="options-section">
                    <h3 class="options-section-title">Niveaux scolaires ciblés (sélection multiple)</h3>
                    
                    <div class="level-selector">
                        <div class="level-category">
                            <div class="level-title">Collège</div>
                            <div class="level-options">
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-6eme" value="Collège - 6ème">
                                    <label for="level-6eme">6ème</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-5eme" value="Collège - 5ème">
                                    <label for="level-5eme">5ème</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-4eme" value="Collège - 4ème">
                                    <label for="level-4eme">4ème</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-3eme" value="Collège - 3ème" checked>
                                    <label for="level-3eme">3ème</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="level-category">
                            <div class="level-title">Lycée Général</div>
                            <div class="level-options">
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-2nde" value="Lycée - 2nde">
                                    <label for="level-2nde">2nde</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-1ere" value="Lycée - 1ère">
                                    <label for="level-1ere">1ère</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-term" value="Lycée - Terminale">
                                    <label for="level-term">Terminale</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="level-category">
                            <div class="level-title">Lycée Pro</div>
                            <div class="level-options">
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-cap" value="Lycée Pro - CAP">
                                    <label for="level-cap">CAP</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-2nde-pro" value="Lycée Pro - 2nde">
                                    <label for="level-2nde-pro">2nde Pro</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-1ere-pro" value="Lycée Pro - 1ère">
                                    <label for="level-1ere-pro">1ère Pro</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="radio" name="level" id="level-term-pro" value="Lycée Pro - Terminale">
                                    <label for="level-term-pro">Terminale Pro</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
					<div class="additional-levels" style="display: flex; gap: 2rem; margin-top: 1rem; padding: 0.75rem; background-color: var(--primary-light); border-radius: var(--element-radius);">
						<div class="checkbox-container">
							<input type="radio" name="level" id="level-sup" value="Enseignement supérieur">
							<label for="level-sup">Enseignement supérieur</label>
						</div>
						<div class="checkbox-container">
							<input type="radio" name="level" id="level-formation" value="Formation">
							<label for="level-formation">Formation</label>
						</div>
					</div>

                    <div class="selected-levels" id="selected-levels-display">
                        Niveaux sélectionnés: Collège - 3ème
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Objectives and Templates -->
        <div class="step-content hidden" id="step-2">
            <div class="card">
                <h2 class="card-title">Étape 2: Définir les objectifs et la structure</h2>
                <div class="form-group">
                    <label class="form-label">Structure et objectifs de votre application :</label>
                    <p> <strong>Trois méthodes sont possibles :</strong> saisie manuelle, insertion de texte (format.txt) ou saisie et formatage IA.<p>
                    <textarea class="form-control" id="objectives" placeholder="Décrivez les objectifs pédagogiques de votre application..."></textarea>
                </div>

				<!-- Ajouter après la textarea des objectifs et avant la section d'importation -->
				<div class="ai-analysis-container" style="margin-top: 15px; margin-bottom: 20px;">
					<button id="analyze-with-ai-btn" class="btn" style="width: 100%; padding: 12px; background: linear-gradient(to right, #3182ce, #805ad5); color: white; border: none; border-radius: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
						<i class="fas fa-robot"></i> Analyser avec IA et générer les balises
					</button>
					<div id="ai-analysis-status" style="margin-top: 10px; display: none;" class="alert">
						<!-- Le statut de l'analyse sera affiché ici -->
					</div>
				</div>

				<div class="file-import-container" style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
					<label class="form-label"><strong>Importer la structure</strong> de votre application depuis un fichier texte avec <strong>des balises</strong></label>
					<div class="file-input-wrapper">
						<input type="file" id="objectives-file" accept=".txt" class="form-control" style="margin-bottom: 10px;">
						<div class="file-input-buttons" style="display: flex; gap: 10px;">
							<button id="replace-objectives" class="btn btn-secondary" style="flex: 1;">Remplacer le contenu</button>
							<button id="append-objectives" class="btn btn-secondary" style="flex: 1;">Ajouter à la suite</button>
						</div>
					</div>
					
					<!-- Boutons centrés et séparés, côte à côte -->
					<div style="text-align: center; margin: 20px 0; display: flex; justify-content: center; gap: 15px;">
						<button id="toggle-tags-info-btn" class="btn" style="font-size: 1rem; padding: 8px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease;">
							<i class="fas fa-eye"></i> Afficher le format des balises
						</button>
						
						<button id="download-tags-info-btn" class="btn" style="font-size: 1rem; padding: 8px 20px; background-color: #2196F3; color: white; border: none; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease;">
							<i class="fas fa-download"></i> Télécharger le guide
						</button>
					</div>			
							
					
					<div id="file-import-status" style="margin-top: 10px; font-size: 0.9rem; display: none;" class="alert alert-info">
						Veuillez sélectionner un fichier texte (.txt)
					</div>
				</div>
											
						
				<div id="tags-info-bubble" class="tags-info-bubble" style="margin-top: 10px; padding: 15px; background-color: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px; display: none;">
					<p style="margin: 0; font-size: 0.9rem;">
						<strong>Format des balises:</strong>
					</p>
					<ul style="margin-top: 5px; margin-bottom: 0; font-size: 0.9rem;">						
						<li><code>#P Titre de la présentation</code> - Pour définir une description générale (tout le texte jusqu'à la prochaine balise)</li>
						<li><code>#1 Titre de l'onglet 1</code> - Pour définir le titre du premier onglet</li>
						<li><code>#2 Titre de l'onglet 2</code> - Pour définir le titre du deuxième onglet</li>
						<li><code>#B</code> Titre personnalisé</code> - Pour créer un onglet de bibliographie</li>
						<li><code>#S</code> Titre personnalisé</code> - Pour créer un onglet de sitographie</li>
						<li><code>#G</code> Titre personnalisé</code> - Pour créer un onglet de glossaire</li>
						<li><code>##D Titre définition</code> - Pour définir une définition à inclure dans un cadre spécial</li>
						<li><code>##E Titre exercice</code> - Pour définir un exercice ou exemple à inclure dans un cadre spécial</li>
						<li><code>##M Titre méthode</code> - Pour définir une méthode à inclure dans un cadre spécial</li>
						<li><code>##T</code> - Pour créer un tableau avec la syntaxe: /colonne1/colonne2/colonne3/... avec // pour ligne de titre</li>
						<li><code>##IB</code> - Pour créer des info-bulles pour le texte ou des mots séparés par des ";"</li>
						<li><code>##PP</code> - Pour créer des popups modaux pour le texte ou des mots séparés par des ";"</li>
						<li><code>##IFM</code> - Pour intégrer le gestionnaire d'iframes personnalisé</li>
						<li><code>##VI</code> - Pour créer une video interactive avec N QCM</li>
						<li><code>##AIJ Nombre</code> - Pour inserer une activité interactive jointe au prompt</li>
						<li><code>##APP</code> - Pour créer inventer une application interactive à partir de la description</li>
						<li><code>##FC Nombre</code> - Pour activer un nombre défini de flascards</li>
					</ul>
					<div style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-left: 4px solid #9D8EC7; border-radius: 4px;">
						<p style="margin: 0; font-size: 0.9rem;">
							<strong>Syntaxe du tableau (##T):</strong>
						</p>
						<pre style="background-color: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 0.85rem; margin: 5px 0;">
					// Ligne de titres (optionnelle, utiliser "//" au début)
					//Titre colonne 1/Titre colonne 2/Titre colonne 3/
					
					// Lignes normales (utiliser "/" au début)
					/Cellule 1-1/Cellule 1-2/Cellule 1-3/
					/Cellule 2-1/Cellule 2-2/Cellule 2-3/
						</pre>
					</div>
					
					
					<p style="margin-top: 5px; font-size: 0.9rem;">
						Tout le texte entre deux balises sera automatiquement ajouté comme contenu de l'onglet ou de l'élément correspondant.
					</p>
				</div>
				
				
				<script>
				document.addEventListener('DOMContentLoaded', function() {
					// Référence au bouton et à la div d'information sur les balises
					const toggleBtn = document.getElementById('toggle-tags-info-btn');
					const tagsInfoBubble = document.getElementById('tags-info-bubble');
					const downloadBtn = document.getElementById('download-tags-info-btn');
					
					// Fonction pour afficher/masquer le guide des balises
					toggleBtn.addEventListener('click', function() {
						if (tagsInfoBubble.style.display === 'none') {
							tagsInfoBubble.style.display = 'block';
							toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer le format des balises';
							toggleBtn.style.backgroundColor = '#F44336'; // Rouge quand affiché
						} else {
							tagsInfoBubble.style.display = 'none';
							toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Afficher le format des balises';
							toggleBtn.style.backgroundColor = '#4CAF50'; // Vert quand masqué
						}
					});
					
					// Fonction pour télécharger le guide des balises
					downloadBtn.addEventListener('click', function() {
						// Extraire le texte du guide
						let guideText = "GUIDE DES BALISES POUR LE MPC PROMPT GENERATOR\n";
						guideText += "=============================================\n\n";
						
						// Récupérer les lignes du guide
						const formatTitle = tagsInfoBubble.querySelector('p strong').textContent;
						guideText += formatTitle + "\n\n";
						
						// Récupérer toutes les balises
						const tagsList = tagsInfoBubble.querySelectorAll('ul li');
						tagsList.forEach(function(item) {
							guideText += item.textContent.replace(/\s+/g, ' ').trim() + "\n";
						});
						
						// Ajouter la syntaxe du tableau
						const syntaxTitle = tagsInfoBubble.querySelector('div strong')?.textContent;
						if (syntaxTitle) {
							guideText += "\n" + syntaxTitle + "\n\n";
							
							// Récupérer le code de syntaxe
							const syntaxCode = tagsInfoBubble.querySelector('pre')?.textContent;
							if (syntaxCode) {
								guideText += syntaxCode;
							}
						}
						
						// Ajouter la ligne finale
						guideText += "\n\nTout le texte entre deux balises sera automatiquement ajouté comme contenu de l'onglet ou de l'élément correspondant.";
						
						// Créer un élément <a> pour le téléchargement
						const downloadLink = document.createElement('a');
						downloadLink.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(guideText));
						downloadLink.setAttribute('download', 'guide_balises_mpc.txt');
						
						// Ajouter à la page, cliquer et supprimer
						document.body.appendChild(downloadLink);
						downloadLink.click();
						document.body.removeChild(downloadLink);
						
						// Animation de feedback
						downloadBtn.style.backgroundColor = '#4CAF50';
						downloadBtn.innerHTML = '<i class="fas fa-check"></i> Guide téléchargé';
						
						setTimeout(function() {
							downloadBtn.style.backgroundColor = '#2196F3';
							downloadBtn.innerHTML = '<i class="fas fa-download"></i> Télécharger le guide';
						}, 2000);
					});
				});
				</script>				
				
				
				
                <div class="options-section">
                    <h3 class="options-section-title">Modèles pédagogiques préconçus</h3>
                    <p>Sélectionnez un modèle pédagogique pour structurer votre application:</p>
                    
                    <div class="template-container">
						<div class="template-card" id="template-none">
							<div class="template-title">Structure personnalisée</div>
							<div class="template-description">Créez votre propre organisation des onglets selon vos besoins spécifiques.</div>
							<div class="template-tab-selector" style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 8px;">
								<label for="template-tab-count" style="display: block; margin-bottom: 5px; font-weight: bold;">Nombre d'onglets:</label>
								<div style="display: flex; align-items: center; gap: 10px;">
									<input type="range" id="template-tab-count" min="1" max="10" value="2" class="form-control" style="flex-grow: 1;">
									<span id="template-tab-count-display" style="font-size: 18px; font-weight: bold; min-width: 30px; text-align: center;">2</span>
								</div>
							</div>
						</div>        
						                
                        <div class="template-card" id="template-progressive">
                            <div class="template-title">Cours structuré </div>
                            <div class="template-description">Guide les apprenants à travers une séquence d'apprentissage structurée.</div>
                            <div class="template-flow">
                                <span class="template-flow-item">Introduction</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Concept 1</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Concept 2</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Application</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Révisions</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Évaluation et certification</span>
                            </div>
                        </div>
                        
                        <div class="template-card" id="template-problem">
                            <div class="template-title">Apprentissage par problème</div>
                            <div class="template-description">Favorise la résolution active de problèmes et l'exploration des solutions.</div>
                            <div class="template-flow">
                                <span class="template-flow-item">Problème</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Outils</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Exploration</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Solution</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Réflexion</span>
                            </div>
                        </div>
                        
                        <div class="template-card" id="template-revision">
                            <div class="template-title">Révision efficace</div>
                            <div class="template-description">Optimisé pour la mémorisation et la consolidation des connaissances.</div>
                            <div class="template-flow">
                                <span class="template-flow-item">Rappel</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Exercice</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Auto-évaluation</span>
                                <span class="flow-arrow">→</span>
                                <span class="template-flow-item">Renforcement</span>
                            </div>
                        </div>
                        
						<div class="template-card" id="template-flipped">
							<div class="template-title">Classe inversée</div>
							<div class="template-description">Structure pédagogique où les élèves découvrent le contenu à la maison et travaillent en classe sur des activités pratiques.</div>
							<div class="template-flow">
								<span class="template-flow-item">À la maison</span>
								<span class="flow-arrow">→</span>
								<span class="template-flow-item">Organisation en classe</span>
								<span class="flow-arrow">→</span>
								<span class="template-flow-item">Révision</span>
								<span class="flow-arrow">→</span>
								<span class="template-flow-item">Certification</span>
							</div>
							
							<div class="form-group" style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 8px;">
								<label for="home-tabs-count" class="form-label">Nombre d'onglets "À la maison":</label>
								<div style="display: flex; align-items: center; gap: 10px;">
									<input type="range" id="home-tabs-count" class="form-control" min="1" max="4" value="2" style="flex-grow: 1;">
									<span id="home-tabs-value" style="font-weight: bold; font-size: 18px;">2</span>
								</div>
								<div id="home-tabs-preview" style="margin-top: 10px; display: flex; gap: 5px;">
									<span class="template-flow-item" style="font-size: 0.8rem;">À la maison 1</span>
									<span class="template-flow-item" style="font-size: 0.8rem;">À la maison 2</span>
								</div>
							</div>
						</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Options -->
        <div class="step-content hidden" id="step-3">
            <div class="card">
                <h2 class="card-title">Étape 3: Options</h2>
                
                <!-- Options principales -->
                <div class="form-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="latex">
                        <label for="latex">Utiliser des expressions mathématiques au format LaTeX</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="comma" checked>
                        <label for="comma">Utiliser la virgule pour les nombres décimaux</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="show-decimal">
                        <label for="show-decimal">Afficher le choix du nombre de décimales</label>
                    </div>
                    
                    <div class="nested-container hidden" id="decimal-options">
                        <label for="decimal-places" class="form-label">Nombre de décimales par défaut:</label>
                        <input type="number" id="decimal-places" class="form-control" style="width: 120px" min="0" max="10" value="3">
                    </div>
                </div>


                <div class="options-section">
                    <h3 class="options-section-title">Outils pédagogiques interactifs</h3>
                    
                    <!-- Flashcards Option -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-flashcards" checked>
                        <label for="use-flashcards">Fonctionnalités avancées des Flashcards <strong>(IMPORTANT)</strong></label>
                    </div>
                    
                    <!-- Flashcards Details -->
                    <div class="nested-container hidden" id="flashcards-options">
                        <div class="feature-section">
                            <h4 class="feature-title">Interface des cartes</h4>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flashcards-animation" checked>
                                <label for="flashcards-animation">Animation de retournement des cartes</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flashcards-grid" checked>
                                <label for="flashcards-grid">Disposition en grille responsive</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flashcards-structured" checked>
                                <label for="flashcards-structured">Support pour données structurées (texte, tableaux, listes)</label>
                            </div>
                        </div>
                        
                        <div class="feature-section">
                            <h4 class="feature-title">Système d'évaluation</h4>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flashcards-evaluation" checked>
                                <label for="flashcards-evaluation">Auto-évaluation avec boutons Correct/Incorrect</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flashcards-score" checked>
                                <label for="flashcards-score">Suivi du score et barre de progression</label>
                            </div>
                        </div>
                        
                        <div class="feature-section">
                            <h4 class="feature-title">Organisation des contenus</h4>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flashcards-categories" checked>
                                <label for="flashcards-categories">Catégories thématiques avec menu de sélection</label>
                            </div>
                            <div class="form-group">
                                <label for="flashcards-count" class="form-label">Nombre de flashcards (approximatif):</label>
                                <input type="number" id="flashcards-count" class="form-control" style="width: 120px" min="5" max="100" value="20">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gamification Option -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-gamification">
                        <label for="use-gamification">Intégrer des éléments de gamification</label>
                    </div>
                    
                    <!-- Gamification Details -->
                    <div class="nested-container hidden" id="gamification-options">
                        <div class="checkbox-container">
                            <input type="checkbox" id="gamification-points" checked>
                            <label for="gamification-points">Système de points</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="gamification-badges" checked>
                            <label for="gamification-badges">Badges de réussite</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="gamification-progress" checked>
                            <label for="gamification-progress">Barre de progression</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="gamification-rewards">
                            <label for="gamification-rewards">Récompenses débloquables</label>
                        </div>
                        
                        <!-- Nouvelle option: Tableau des scores -->
                        <div class="checkbox-container">
                            <input type="checkbox" id="gamification-leaderboard">
                            <label for="gamification-leaderboard">Tableau des scores (simulation)</label>
                        </div>
                    </div>
                    
                    <!-- Nouvelle option: Évaluation adaptative -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-adaptive-assessment">
                        <label for="use-adaptive-assessment">Évaluation adaptative</label>
                    </div>
                    
                    <div class="nested-container hidden" id="adaptive-assessment-options">
                        <div class="feature-section">
                            <h4 class="feature-title">Fonctionnalités adaptatives</h4>
                            <div class="checkbox-container">
                                <input type="checkbox" id="adaptive-difficulty" checked>
                                <label for="adaptive-difficulty">Ajustement automatique de la difficulté</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="adaptive-feedback" checked>
                                <label for="adaptive-feedback">Feedback personnalisé selon les réponses</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="adaptive-path">
                                <label for="adaptive-path">Parcours d'apprentissage personnalisé</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Options du certificat (NOUVEAU BLOC) -->
                <div class="options-section">
                    <h3 class="options-section-title">Options du certificat de réussite</h3>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="certificate-last-tab"> 
                        <label for="certificate-last-tab">Créer un dernier onglet certification</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-certificate" checked>
                        <label for="use-certificate">Inclure un certificat personnalisé à imprimer à la fin du quiz</label>
                    </div>
                    
                    <div class="nested-container certificate-highlight" id="certificate-options-step3">
                        <span class="certificate-badge">Activé</span>
                    
                        <div class="feature-section">
                            <h4 class="feature-title">Options du certificat</h4>
                            
                            <div class="form-group">
                                <label for="certificate-title-step3" class="form-label">Titre du certificat:</label>
                                <input type="text" id="certificate-title-step3" class="form-control" value="Certificat de Réussite">
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-student-form-step3" checked>
                                <label for="certificate-student-form-step3">Formulaire d'informations étudiant</label>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-detailed-scores-step3" checked>
                                <label for="certificate-detailed-scores-step3">Afficher les scores détaillés par thématique</label>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-signatures-step3" checked>
                                <label for="certificate-signatures-step3">Section des signatures (professeur/étudiant)</label>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-date-step3" checked>
                                <label for="certificate-date-step3">Afficher la date d'obtention</label>
                            </div>
                        </div>
                        
                        <div class="feature-section">
                            <h4 class="feature-title">Options d'exportation</h4>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-print-step3" checked>
                                <label for="certificate-print-step3">Bouton d'impression</label>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-pdf-step3" checked>
                                <label for="certificate-pdf-step3">Bouton d'exportation PDF</label>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-image-step3" checked>
                                <label for="certificate-image-step3">Bouton d'exportation JPEG</label>
                            </div>
                        </div>
                        
                        <div class="feature-section">
                            <h4 class="feature-title">Personnalisation visuelle</h4>
                            
                            <div class="form-group">
                                <label for="certificate-border-color-step3" class="form-label">Couleur de la bordure:</label>
                                <div class="color-picker-container">
                                    <input type="color" id="certificate-border-color-step3" class="form-control-inline" value="#81c784">
                                    <div class="color-preview" id="certificate-border-color-preview-step3" style="background-color: #81c784;"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="certificate-score-color-step3" class="form-label">Couleur du score:</label>
                                <div class="color-picker-container">
                                    <input type="color" id="certificate-score-color-step3" class="form-control-inline" value="#455a64">
                                    <div class="color-preview" id="certificate-score-color-preview-step3" style="background-color: #455a64;"></div>
                                </div>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="certificate-logo-step3">
                                <label for="certificate-logo-step3">Ajouter un logo (simulé)</label>
                            </div>
                        </div>
                        
						<div class="feature-section">
							<h4 class="feature-title">Protection par mot de passe</h4>
							
							<div class="checkbox-container">
								<input type="checkbox" id="certificate-password-step3">
								<label for="certificate-password-step3">Protéger l'accès au certificat par un mot de passe</label>
							</div>
							
							<div class="nested-container" id="password-options-step3" style="display: none;">
								<label for="certificate-password-value-step3" class="form-label">Mot de passe (4 chiffres):</label>
								<input type="number" id="certificate-password-value-step3" class="form-control" style="width: 120px" min="0" max="9999" placeholder="0000" pattern="[0-9]{4}" maxlength="4">
								<span class="api-format-info">Exemple: 5614</span>
								
								<div class="info-message" style="margin-top: 10px; padding: 10px; background-color: #fff8e1; border-left: 4px solid #ffc107; border-radius: 4px;">
									<p style="margin: 0; font-size: 0.9rem;">
										<strong>Important :</strong> Ce mot de passe sera requis pour que l'utilisateur final puisse accéder au quiz de certification et au certificat.
									</p>
								</div>
							</div>
						</div>
                        
                        <!-- Aperçu amélioré du certificat -->
                        <div class="certificate-preview-container">
                            <h4 style="text-align: center; margin-bottom: 10px; color: #455a64;">Aperçu du certificat</h4>
                            <div style="border: 5px solid #81c784; padding: 20px; background-color: white;">
                                <h2 style="color: #333; font-size: 18px; margin-bottom: 10px; text-align: center;">Certificat de Réussite</h2>
                                <p style="text-align: center;">Atteste que <strong>Prénom Nom</strong> a complété avec succès le cours</p>
                                <div style="margin: 15px 0; font-weight: bold; color: #455a64; text-align: center;">Score: 35/40</div>
                                <div style="display: flex; justify-content: space-between; font-size: 12px; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                                    <div>
                                        <div style="width: 80px; height: 1px; background-color: black; margin-bottom: 5px;"></div>
                                        Professeur
                                    </div>
                                    <div>
                                        <div style="width: 80px; height: 1px; background-color: black; margin-bottom: 5px;"></div>
                                        Étudiant
                                    </div>
                                </div>
                                <div style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                                    <button style="background-color: #455a64; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 11px;">Imprimer</button>
                                    <button style="background-color: #455a64; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 11px;">PDF</button>
                                    <button style="background-color: #455a64; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 11px;">JPEG</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="certificate-info">
                            <span style="display: block; font-weight: bold; margin-bottom: 4px;">⚠️ Rappel important:</span>
                            Le certificat sera intégré dans le dernier onglet "Certification" qui sera automatiquement créé.
                        </div>
                    </div>
                </div>



				<!-- Options SCORM -->
				<div class="options-section">
					<h3 class="options-section-title">Options SCORM pour LMS (Moodle)</h3>
					
					<div class="checkbox-container">
						<input type="checkbox" id="use-scorm" >
						<label for="use-scorm">Activer la compatibilité SCORM pour LMS</label>
					</div>
					
					<div class="nested-container hidden" id="scorm-options">
						<div class="feature-section">
							<h4 class="feature-title">Version SCORM</h4>
							<div class="radio-group">
								<label class="radio-option">
									<input type="radio" name="scorm-version" id="scorm-1-2" value="1.2" checked>
									SCORM 1.2 (compatible avec la plupart des LMS)
								</label>
								<label class="radio-option">
									<input type="radio" name="scorm-version" id="scorm-2004" value="2004">
									SCORM 2004 (fonctionnalités avancées, compatibilité limitée)
								</label>
							</div>
						</div>
						
						<div class="feature-section">
							<h4 class="feature-title">Données à transmettre</h4>
							<div class="checkbox-container">
								<input type="checkbox" id="scorm-score" checked>
								<label for="scorm-score">Score total des activités</label>
							</div>
							<div class="checkbox-container">
								<input type="checkbox" id="scorm-completion" checked>
								<label for="scorm-completion">Statut de complétion</label>
							</div>
							<div class="checkbox-container">
								<input type="checkbox" id="scorm-time" checked>
								<label for="scorm-time">Temps de session</label>
							</div>
							<div class="checkbox-container">
								<input type="checkbox" id="scorm-detailed-scores">
								<label for="scorm-detailed-scores">Scores détaillés par activité</label>
							</div>
						</div>
						
						<div class="feature-section">
							<h4 class="feature-title">Critères de réussite</h4>
							<div class="form-group">
								<label for="scorm-passing-score" class="form-label">Score minimum pour réussir (%):</label>
								<input type="number" id="scorm-passing-score" class="form-control" style="width: 120px" min="0" max="100" value="70">
							</div>
							<div class="form-group">
								<label for="scorm-completion-criteria" class="form-label">Critère de complétion:</label>
								<select id="scorm-completion-criteria" class="form-control">
									<option value="all-activities">Toutes les activités terminées</option>
									<option value="passing-score">Score minimum atteint</option>
									<option value="both" selected>Les deux conditions</option>
								</select>
							</div>
							<div class="form-group">
								<label for="scorm-max-attempts" class="form-label">Nombre maximum de tentatives (0 = illimité):</label>
								<input type="number" id="scorm-max-attempts" class="form-control" style="width: 120px" min="0" max="10" value="0">
							</div>
						</div>
						
						<div class="feature-section">
							<h4 class="feature-title">Options avancées</h4>
							<div class="checkbox-container">
								<input type="checkbox" id="scorm-auto-save" checked>
								<label for="scorm-auto-save">Enregistrement automatique des progrès</label>
							</div>
							<div class="checkbox-container">
								<input type="checkbox" id="scorm-suspend-data" checked>
								<label for="scorm-suspend-data">Enregistrer l'état des activités entre sessions</label>
							</div>
						</div>
						
						<div class="info-message" style="margin-top: 15px; padding: 10px; background-color: #fff8e1; border-left: 4px solid #ffc107; border-radius: 4px;">
							<p style="margin: 0; font-size: 0.9rem;">
								<strong>Important :</strong> L'activation de SCORM permettra à l'application générée de communiquer avec une plateforme LMS comme Moodle, pour enregistrer les progrès et les scores des apprenants.
							</p>
						</div>
					</div>
				</div>



                <!-- Options d'affichage et de mise en page -->
                <div class="options-section">
                    <h3 class="options-section-title">Mise en page et affichage</h3>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="fullscreen" checked>
                        <label for="fullscreen">Bouton plein écran</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="adaptive-layout" checked>
                        <label for="adaptive-layout">Mise en page adaptative (responsive design)</label>
                    </div>
                    
					<div class="checkbox-container">
						<input type="checkbox" id="use-logo">
						<label for="use-logo">Intégrer un logo SVG dans la zone de titre</label>
					</div>
					
					<div class="nested-container hidden" id="logo-options">
						<div class="form-group">
							<textarea class="form-control" id="logo-svg-code" rows="5" placeholder="Collez ici le code SVG de votre logo..."></textarea>
							<p class="api-format-info">Exemple: &lt;svg width="50" height="50" viewBox="0 0 100 100"&gt;...&lt;/svg&gt;</p>
						</div>
						<div class="form-group">
							<label class="form-label">Taille du logo:</label>
							<div style="display: flex; align-items: center; gap: 10px;">
								<input type="number" id="logo-width" class="form-control" style="width: 80px;" value="50" min="20" max="200">
								<span>×</span>
								<input type="number" id="logo-height" class="form-control" style="width: 80px;" value="50" min="20" max="200">
								<span>pixels</span>
							</div>
						</div>
						<div class="form-group">
							<label class="form-label">Position du logo:</label>
							<select class="form-control" id="logo-position">
								<option value="left">À gauche du titre</option>
								<option value="right">À droite du titre</option>
							</select>
						</div>
					</div>
                    
                    <div class="form-group">
                        <label for="title-area-color" class="form-label">Couleur de la zone de titre:</label>
                        <div class="color-picker-container">
                            <input type="color" id="title-area-color" class="form-control-inline" value="#455a64">
                            <div class="color-preview" id="title-area-color-preview" style="background-color: #455a64;"></div>
                        </div>
                    </div>
                    
                    <!-- Nouvelle option: Préférences d'accessibilité -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="accessibility-features">
                        <label for="accessibility-features">Fonctionnalités d'accessibilité avancées</label>
                    </div>
                    
                    <div class="nested-container hidden" id="accessibility-options">
                        <div class="checkbox-container">
                            <input type="checkbox" id="high-contrast" checked>
                            <label for="high-contrast">Mode contraste élevé</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="large-text">
                            <label for="large-text">Option texte agrandi</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="screen-reader">
                            <label for="screen-reader">Compatibilité lecteur d'écran</label>
                        </div>
                    </div>
                </div>

                <!-- Options spécifiques par domaine -->
                <div class="options-section">
                    <h3 class="options-section-title">Options spécifiques au domaine</h3>
                    
                    <!-- Options pour les mathématiques -->
                    <div class="domain-options" id="math-options">
                        <span class="badge badge-info">Mathématiques</span>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="math-latex-zones">
                            <label for="math-latex-zones">Zones spéciales pour formules LaTeX</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="math-calculator">
                            <label for="math-calculator">Calculatrice intégrée (fonction pop-up)</label>
                        </div>
                        
                        <!-- Nouvelle option: Graphiques interactifs -->
                        <div class="checkbox-container">
                            <input type="checkbox" id="math-interactive-graphs">
                            <label for="math-interactive-graphs">Graphiques interactifs</label>
                        </div>
                    </div>
                    
                    <!-- Options pour les sciences et la chimie -->
                    <div class="domain-options hidden" id="science-options">
                        <span class="badge badge-info">Sciences & Chimie</span>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="molecular-visualization">
                            <label for="molecular-visualization">Visualisation moléculaire</label>
                        </div>
                        
                        <div class="nested-container hidden" id="molecular-options">
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="molecular-type" value="link" checked>
                                    Lien externe
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="molecular-type" value="integrated">
                                    Format intégré
                                </label>
                            </div>
                            <input type="text" class="form-control" id="molecular-link" placeholder="Lien vers visualisation moléculaire (optionnel)">
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="periodic-table">
                            <label for="periodic-table">Tableau périodique</label>
                        </div>
                        
                        <div class="nested-container hidden" id="periodic-options">
                            <input type="text" class="form-control" id="periodic-link" placeholder="Lien vers tableau périodique (optionnel)">
                        </div>
                        
                        <!-- Nouvelle option: Laboratoire virtuel -->
                        <div class="checkbox-container">
                            <input type="checkbox" id="simulation-lab">
                            <label for="simulation-lab">Laboratoire virtuel</label>
                        </div>
                    </div>
                    
                    <!-- Options pour la programmation -->
                    <div class="domain-options hidden" id="programming-options">
                        <span class="badge badge-info">Programmation</span>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="code-editor" checked>
                            <label for="code-editor">Éditeur de code intégré</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="syntax-highlighting" checked>
                            <label for="syntax-highlighting">Coloration syntaxique</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="code-execution">
                            <label for="code-execution">Exécution de code (simulation)</label>
                        </div>
                    </div>
                    
                    <!-- Options pour les langues -->
                    <div class="domain-options hidden" id="language-options">
                        <span class="badge badge-info">Langues</span>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="pronunciation" checked>
                            <label for="pronunciation">Guides de prononciation</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="vocabulary-lists">
                            <label for="vocabulary-lists">Listes de vocabulaire interactives</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="conversation-sim">
                            <label for="conversation-sim">Simulation de conversation</label>
                        </div>
                    </div>
                </div>
                
                <!-- Options de personnalisation -->
                <div class="options-section">
                    <h3 class="options-section-title">Personnalisation de l'interface</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Style de l'interface:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="interface-style" id="style-sober" value="sober" checked>
                                Style sobre
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="interface-style" id="style-color" value="color">
                                Style coloré
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="interface-style" id="style-gradient" value="gradient">
                                Style dégradé
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="interface-style" id="style-neumorphic" value="neumorphic">
                                Style neumorphique
                            </label>
                            <!-- Nouveau style néo -->
                            <label class="radio-option">
                                <input type="radio" name="interface-style" id="style-neo" value="neo">
                                Style néo
                            </label>
                        </div>
                        
                        <!-- Options spécifiques au style dégradé -->
                        <div class="nested-container hidden" id="gradient-options">
                            <label for="gradient-color" class="form-label">Couleur initiale du dégradé:</label>
                            <div class="color-picker-container">
                                <input type="color" id="gradient-color" class="form-control-inline" value="#3f51b5">
                                <div class="color-preview" id="gradient-color-preview" style="background-color: #3f51b5;"></div>
                            </div>
                        </div>
                        
                        <!-- Options spécifiques au style néo (NOUVEAU) -->
                        <div class="nested-container hidden" id="neo-options">
                            <label class="form-label">Sélection de couleur:</label>
                            <div class="neo-color-options">
                                <div class="neo-color-option blue selected" data-color="#00b5d9" data-value="blue"></div>
                                <div class="neo-color-option red" data-color="#f08b65" data-value="red"></div>
                                <div class="neo-color-option green" data-color="#0bd67e" data-value="green"></div>
                                <div class="neo-color-option gold" data-color="#d6a00b" data-value="gold"></div>
                                <div class="neo-color-option lavender" data-color="#9D8EC7" data-value="lavender"></div>
								<div class="neo-color-option mint" data-color="#8FD5B3" data-value="mint"></div>
								<div class="neo-color-option salmon" data-color="#F5B5C8" data-value="salmon"></div>
                            </div>
                        </div>
                        
                        
						<!-- Options spécifiques au style sobre (NOUVEAU) -->
						<div class="nested-container hidden" id="sober-options">
							<label class="form-label">Sélection de couleur:</label>
							<div class="sober-color-options">
								<div class="sober-color-option default selected" data-color="#455a64" data-secondary="#eceff1" data-value="default"></div>
								<div class="sober-color-option red" data-color="#ad4b4b" data-secondary="#bab3b3" data-value="red"></div>
								<div class="sober-color-option yellow" data-color="#e3c878" data-secondary="#d1cec7" data-value="yellow"></div>
								<div class="sober-color-option blue" data-color="#4f81b3" data-secondary="#a8b1ba" data-value="blue"></div>
								<div class="sober-color-option purple" data-color="#7e57c2" data-secondary="#ada7b8" data-value="purple"></div>
							</div>
						</div>
                        
                        
                        
                        <!-- Message d'information sur la synchronisation des couleurs -->
                        <div id="style-tabs-info">
                            Les couleurs des onglets sont synchronisées avec ce style.
                        </div>
                        
                        <!-- Prévisualisations des styles -->
                        <div class="style-preview sober" id="preview-sober">
                            <div class="style-preview-header">Aperçu du style sobre</div>
                            <div style="display: flex; gap: 5px;">
                                <div class="style-preview-tab active">Onglet 1</div>
                                <div class="style-preview-tab">Onglet 2</div>
                                <div class="style-preview-tab">Onglet 3</div>
                            </div>
                        </div>
                        
                        <div class="style-preview color hidden" id="preview-color">
                            <div class="style-preview-header">Aperçu du style coloré</div>
                            <div style="display: flex; gap: 5px;">
                                <div class="style-preview-tab active">Onglet 1</div>
                                <div class="style-preview-tab">Onglet 2</div>
                                <div class="style-preview-tab">Onglet 3</div>
                            </div>
                        </div>
                        
                        <div class="style-preview gradient hidden" id="preview-gradient" style="--gradient-start: #3f51b5; --gradient-end: #1a237e; --gradient-light: #7986cb; --gradient-dark: #303f9f;">
                            <div class="style-preview-header">Aperçu du style dégradé</div>
                            <div style="display: flex; gap: 5px;">
                                <div class="style-preview-tab active">Onglet 1</div>
                                <div class="style-preview-tab">Onglet 2</div>
                                <div class="style-preview-tab">Onglet 3</div>
                            </div>
                        </div>
                        
                        <!-- Style neumorphique -->
                        <div class="style-preview neumorphic hidden" id="preview-neumorphic">
                            <div class="style-preview-header">Aperçu du style neumorphique</div>
                            <div style="display: flex; gap: 12px; padding: 10px;">
                                <div class="style-preview-tab active">Onglet 1</div>
                                <div class="style-preview-tab">Onglet 2</div>
                                <div class="style-preview-tab">Onglet 3</div>
                            </div>
                        </div>
                        
                        <!-- Nouveau style néo -->
                        <div class="style-preview neo hidden" id="preview-neo" style="--neo-color: #00b5d9;">
                            <div class="style-preview-header">Aperçu du style néo</div>
                            <div style="display: flex; gap: 12px; padding: 10px;">
                                <div class="style-preview-tab active">Onglet 1</div>
                                <div class="style-preview-tab">Onglet 2</div>
                                <div class="style-preview-tab">Onglet 3</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signature" class="form-label">Signature personnalisée:</label>
                        <input type="text" id="signature" class="form-control" value="@skynet" placeholder="Votre signature (ex: @yoblin)">
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-container">
                            <input type="checkbox" id="use-version" checked>
                            <label for="use-version">Afficher le numéro de version</label>
                        </div>
                        
                        <div class="nested-container" id="version-options">
                            <label for="version-number" class="form-label">Numéro de version:</label>
                            <input type="text" id="version-number" class="form-control" style="width: 120px" value="V1.0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-container">
                            <input type="checkbox" id="use-colored-bubbles" checked>
                            <label for="use-colored-bubbles">Présenter la signature et version dans des bulles colorées</label>
                        </div>
                        
                        <div class="nested-container" id="bubble-options">
                            <div class="form-row">
                                <label for="version-color" class="form-label">Couleur de la bulle de version:</label>
                                <div class="color-picker-container">
                                    <input type="color" id="version-color" class="form-control-inline" value="#546e7a">
                                    <div class="color-preview" id="version-color-preview" style="background-color: #546e7a;"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <label for="signature-color" class="form-label">Couleur de la bulle de signature:</label>
                                <div class="color-picker-container">
                                    <input type="color" id="signature-color" class="form-control-inline" value="#eceff1">
                                    <div class="color-preview" id="signature-color-preview" style="background-color: #eceff1;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Tabs -->
        <div class="step-content hidden" id="step-4">
            <div class="card">
                <h2 class="card-title">Étape 4: Onglets</h2>
                
                <div class="form-group" style="margin-bottom: 30px;">
                    <button id="generate-tabs-button" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-bottom: 15px;">
                        <span style="font-weight: bold;">GÉNÉRER ONGLETS</span> - Mise à jour complète selon les options précédentes
                    </button>
                    <div id="tabs-update-info" style="background-color: #e8f5e9; border-left: 4px solid #66bb6a; padding: 10px; border-radius: 4px; display: none;">
                        <p style="margin: 0; font-weight: 500;">Les onglets ont été générés avec succès selon vos options !</p>
                    </div>
                </div>
                
				<div class="form-group">
					<label class="form-label">Nombre d'onglets:</label>
					<div id="tabs-count-display" style="font-size: 24px; font-weight: bold; color: #b71c1c; margin: 10px 0;">2</div>
					<p style="font-size: 0.9rem; color: #666;">Le nombre d'onglets est défini à l'étape 2 lors du choix de la structure.</p>
				</div>
				
				<div class="form-group">
					<label class="form-label">Aperçu des onglets:</label>
					<div id="tabs-preview-display" class="tabs-preview-container">
						<!-- Les aperçus des onglets seront générés ici dynamiquement -->
					</div>
				</div>
                
                <div class="options-section">
                    <h3 class="options-section-title">Personnalisation des onglets</h3>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-tab-colors" checked>
                        <label for="use-tab-colors">Utiliser des couleurs personnalisées pour les onglets</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-tab-icons" checked>
                        <label for="use-tab-icons">Utiliser des icônes pour les onglets</label>
                    </div>
                    
                    <div class="nested-container" id="icon-set-options">
                        <label for="icon-set" class="form-label">Jeu d'icônes:</label>
                        <select class="form-control" id="icon-set">
                            <option value="material">Material Design</option>
                            <option value="fontawesome">Font Awesome</option>
                            <option value="emoji">Emoji</option>
                        </select>
                    </div>
                    
                    <!-- Nouvelle option: Navigation avancée -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="advanced-navigation">
                        <label for="advanced-navigation">Navigation avancée</label>
                    </div>
                    
                    <div class="nested-container hidden" id="navigation-options">
                        <div class="checkbox-container">
                            <input type="checkbox" id="sticky-tabs" checked>
                            <label for="sticky-tabs">Onglets fixes (restent visibles au défilement)</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="tab-transitions" checked>
                            <label for="tab-transitions">Transitions animées entre les onglets</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="tab-breadcrumbs">
                            <label for="tab-breadcrumbs">Afficher le fil d'Ariane</label>
                        </div>
                    </div>
                </div>
                
                <div id="tabs-container" class="form-group" style="margin-top: 1.5rem">
                    <!-- Tabs will be generated here by JavaScript -->
                </div>
                
                <div class="tab-card">
                    <div class="checkbox-container">
                        <input type="checkbox" id="include-quiz">
                        <label for="include-quiz" style="font-weight: bold">Inclure un onglet Quiz général</label>
                    </div>
                    
                    <div class="nested-container hidden" id="quiz-options">
                        <div class="form-group">
                            <label for="quiz-questions" class="form-label">Nombre de questions:</label>
                            <input type="number" id="quiz-questions" class="form-control" style="width: 120px" min="1" max="50" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Niveaux inclus:</label>
                            <div style="display: flex; gap: 1.5rem">
                                <div class="checkbox-container">
                                    <input type="checkbox" id="easy-level" checked>
                                    <label for="easy-level">Facile</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="checkbox" id="medium-level" checked>
                                    <label for="medium-level">Moyen</label>
                                </div>
                                <div class="checkbox-container">
                                    <input type="checkbox" id="hard-level">
                                    <label for="hard-level">Difficile</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Certificat - Section améliorée -->
                        <div class="checkbox-container" style="margin-top: 15px; font-weight: bold;">
                            <input type="checkbox" id="certificate-last-tab-step4"> 
                            <label for="certificate-last-tab-step4">Créer un dernier onglet certification</label>
                        </div>
                            
                        <div class="checkbox-container" style="margin-top: 15px; font-weight: bold;">
                            <input type="checkbox" id="certificate">
                            <label for="certificate">Certificat à imprimer dans le dernier onglet (PRIORITÉ ÉLEVÉE)</label>
                        </div>

                        <!-- NOUVELLES OPTIONS POUR LE CERTIFICAT -->
                        <div class="nested-container certificate-highlight hidden" id="certificate-options">
                            <span class="certificate-badge">Activé</span>
                        
                            <div class="feature-section">
                                <h4 class="feature-title">Options du certificat</h4>
                                
                                <div class="form-group">
                                    <label for="certificate-title" class="form-label">Titre du certificat:</label>
                                    <input type="text" id="certificate-title" class="form-control" value="Certificat de Réussite">
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-student-form" checked>
                                    <label for="certificate-student-form">Formulaire d'informations étudiant</label>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-detailed-scores" checked>
                                    <label for="certificate-detailed-scores">Afficher les scores détaillés par thématique</label>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-signatures" checked>
                                    <label for="certificate-signatures">Section des signatures (professeur/étudiant)</label>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-date" checked>
                                    <label for="certificate-date">Afficher la date d'obtention</label>
                                </div>
                            </div>
                            
                            <div class="feature-section">
                                <h4 class="feature-title">Options d'exportation</h4>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-print" checked>
                                    <label for="certificate-print">Bouton d'impression</label>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-pdf" checked>
                                    <label for="certificate-pdf">Bouton d'exportation PDF</label>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-image">
                                    <label for="certificate-image">Bouton d'exportation JPEG</label>
                                </div>
                            </div>
                            
                            <div class="feature-section">
                                <h4 class="feature-title">Personnalisation visuelle</h4>
                                
                                <div class="form-group">
                                    <label for="certificate-border-color" class="form-label">Couleur de la bordure:</label>
                                    <div class="color-picker-container">
                                        <input type="color" id="certificate-border-color" class="form-control-inline" value="#81c784">
                                        <div class="color-preview" id="certificate-border-color-preview" style="background-color: #81c784;"></div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="certificate-score-color" class="form-label">Couleur du score:</label>
                                    <div class="color-picker-container">
                                        <input type="color" id="certificate-score-color" class="form-control-inline" value="#455a64">
                                        <div class="color-preview" id="certificate-score-color-preview" style="background-color: #455a64;"></div>
                                    </div>
                                </div>
                                
                                <div class="checkbox-container">
                                    <input type="checkbox" id="certificate-logo">
                                    <label for="certificate-logo">Ajouter un logo (simulé)</label>
                                </div>
                                
								<div class="feature-section">
									<h4 class="feature-title">Protection par mot de passe</h4>
									
									<div class="checkbox-container">
										<input type="checkbox" id="certificate-password">
										<label for="certificate-password">Protéger l'accès au certificat par un mot de passe</label>
									</div>
									
									<div class="nested-container" id="password-options" style="display: none;">
										<label for="certificate-password-value" class="form-label">Mot de passe (4 chiffres):</label>
										<input type="number" id="certificate-password-value" class="form-control" style="width: 120px" min="0" max="9999" placeholder="0000" pattern="[0-9]{4}" maxlength="4">
										<span class="api-format-info">Exemple: 5614</span>
										
										<div class="info-message" style="margin-top: 10px; padding: 10px; background-color: #fff8e1; border-left: 4px solid #ffc107; border-radius: 4px;">
											<p style="margin: 0; font-size: 0.9rem;">
												<strong>Important :</strong> Ce mot de passe sera requis pour que l'utilisateur final puisse accéder au quiz de certification et au certificat.
											</p>
										</div>
									</div>
								</div>                                
                            </div>
                            
                            
                            <!-- Aperçu amélioré du certificat -->
                            <div class="certificate-preview-container">
                                <h4 style="text-align: center; margin-bottom: 10px; color: #455a64;">Aperçu du certificat</h4>
                                <div style="border: 5px solid #81c784; padding: 20px; background-color: white;">
                                    <h2 style="color: #333; font-size: 18px; margin-bottom: 10px; text-align: center;">Certificat de Réussite</h2>
                                    <p style="text-align: center;">Atteste que <strong>Prénom Nom</strong> a complété avec succès le cours</p>
                                    <div style="margin: 15px 0; font-weight: bold; color: #455a64; text-align: center;">Score: 35/40</div>
                                    <div style="display: flex; justify-content: space-between; font-size: 12px; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px;">
                                        <div>
                                            <div style="width: 80px; height: 1px; background-color: black; margin-bottom: 5px;"></div>
                                            Professeur
                                        </div>
                                        <div>
                                            <div style="width: 80px; height: 1px; background-color: black; margin-bottom: 5px;"></div>
                                            Étudiant
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                                        <button style="background-color: #455a64; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 11px;">Imprimer</button>
                                        <button style="background-color: #455a64; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 11px;">PDF</button>
                                        <button style="background-color: #455a64; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 11px;">JPEG</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="certificate-info">
                                <span style="display: block; font-weight: bold; margin-bottom: 4px;">⚠️ Rappel important:</span>
                                Le certificat sera intégré dans le dernier onglet "Certification" qui sera automatiquement créé.
                            </div>
                        </div>
                        
                        <!-- Options de quiz supplémentaires -->
                        <div class="checkbox-container">
                            <input type="checkbox" id="quiz-timer">
                            <label for="quiz-timer">Minuteur par question</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="quiz-shuffle">
                            <label for="quiz-shuffle">Mélanger les questions</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="quiz-hints">
                            <label for="quiz-hints">Système d'indices</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: SVG and Additional Notes -->
        <div class="step-content hidden" id="step-5">
            <div class="card">
                <h2 class="card-title">Étape 5: Illustrations et remarques supplémentaires</h2>
                
                <div class="form-group">
                    <label for="svg-count" class="form-label">Nombre d'illustrations SVG:</label>
                    <select class="form-control" id="svg-count" style="width: 120px">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
                
                <div id="svg-container" class="form-group">
                    <!-- SVG elements will be generated here -->
                </div>
                
                <!-- Formatage du contenu -->
                <div class="options-section">
                    <h3 class="options-section-title">Formatage du contenu</h3>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="use-enhanced-content" checked>
                        <label for="use-enhanced-content">Formatage amélioré du contenu</label>
                    </div>
                    
                    <div class="nested-container" id="enhanced-content-options">
                        <div class="checkbox-container">
                            <input type="checkbox" id="definition-box" checked>
                            <label for="definition-box">Encadrer les définitions dans des cadres spéciaux</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="calculation-examples" checked>
                            <label for="calculation-examples">Inclure des exemples de calcul</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="method-section" checked>
                            <label for="method-section">Ajouter une section méthode</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="definition-box-color" class="form-label">Couleur du cadre de définition:</label>
                            <div class="color-picker-container">
                                <input type="color" id="definition-box-color" class="form-control-inline" value="#e0e0e0">
                                <div class="color-preview" id="definition-box-color-preview" style="background-color: #e0e0e0;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="exercise-box-color" class="form-label">Couleur du cadre d'exercice:</label>
                            <div class="color-picker-container">
                                <input type="color" id="exercise-box-color" class="form-control-inline" value="#e3f2fd">
                                <div class="color-preview" id="exercise-box-color-preview" style="background-color: #e3f2fd;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="method-box-color" class="form-label">Couleur du cadre de méthode:</label>
                            <div class="color-picker-container">
                                <input type="color" id="method-box-color" class="form-control-inline" value="#fff3e0">
                                <div class="color-preview" id="method-box-color-preview" style="background-color: #fff3e0;"></div>
                            </div>
                        </div>
                        
                        <!-- Nouvelles options de formatage -->
                        <div class="checkbox-container">
                            <input type="checkbox" id="tooltips">
                            <label for="tooltips">Utiliser des infobulles pour les termes techniques</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="collapsible-sections">
                            <label for="collapsible-sections">Sections dépliables/repliables</label>
                        </div>
                    </div>
                </div>
                
                <!-- Nouvelle section pour les médias -->
                <div class="options-section">
                    <h3 class="options-section-title">Ressources multimédias</h3>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="include-multimedia">
                        <label for="include-multimedia">Intégrer des ressources multimédias</label>
                    </div>
                    
                    <div class="nested-container hidden" id="multimedia-options">
                        <div class="checkbox-container">
                            <input type="checkbox" id="audio-clips" checked>
                            <label for="audio-clips">Clips audio pour explications</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="image-gallery">
                            <label for="image-gallery">Galerie d'images</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="iframe-embeds">
                            <label for="iframe-embeds">Intégration de widgets externes</label>
                        </div>
                    </div>
                </div>
                
				<!-- Section de recherche de ressources multimédias par IA -->
				<div class="multimedia-search-section" id="ai-multimedia-search">
					<h3 class="options-section-title">Recherche IA de ressources multimédias</h3>
					<p>Utilisez l'intelligence artificielle pour trouver des ressources multimédias adaptées à votre scénario pédagogique.</p>
					
					<div class="multimedia-search-form">
						<div class="form-group">
							<label for="multimedia-search-service">Service d'IA:</label>
							<select class="form-control" id="multimedia-search-service">
								<option value="claude">Anthropic Claude</option>
								<option value="openai">OpenAI</option>
								<option value="mistral">Mistral AI</option>
								<option value="gemini">Google Gemini</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="multimedia-search-type">Type de ressource:</label>
							<select class="form-control" id="multimedia-search-type">
								<option value="videos">Vidéos éducatives</option>
								<option value="images">Images et illustrations</option>
								<option value="audio">Ressources audio</option>
								<option value="interactive">Ressources interactives</option>
								<option value="all">Tous types</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="multimedia-search-query">Mots-clés:</label>
							<input type="text" class="form-control" id="multimedia-search-query" placeholder="Ex: système solaire, structure cellulaire, théorème de Pythagore...">
						</div>
						
						<div class="form-group">
							<label for="multimedia-search-level">Niveau éducatif:</label>
							<select class="form-control" id="multimedia-search-level">
								<option value="primary">Primaire</option>
								<option value="college" selected>Collège</option>
								<option value="lycee">Lycée</option>
								<option value="superior">Supérieur</option>
							</select>
						</div>
						
						<button class="btn" id="multimedia-search-btn">
							<i class="fas fa-search"></i> Rechercher des ressources
						</button>
					</div>
					
					<div class="search-results-container" id="multimedia-search-results" style="display: none;">
						<div class="search-status">Les résultats de recherche apparaîtront ici.</div>
					</div>
				</div>
                
                
                <div class="form-group">
                    <label for="additional-notes" class="form-label">Remarques et précisions supplémentaires:</label>
                    <textarea class="form-control" id="additional-notes" placeholder="Ajoutez ici toute information ou précision supplémentaire qui n'a pas été couverte dans les menus précédents..."></textarea>
                </div>
            </div>
        </div>

        <!-- Step 6: Generated Prompt -->
        <div class="step-content hidden" id="step-6">
            <div class="card">
                <h2 class="card-title">Votre Prompt est Prêt !</h2>
				<div class="prompt-stats" id="prompt-stats" style="background-color: #f1f1f1; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
					<div>
						<span id="token-count">0</span> tokens (estimation)
					</div>
					<div>
						<span id="line-count">0</span> lignes
					</div>
					<div>
						<span id="char-count">0</span> caractères
					</div>
				</div>
                <div class="prompt-output" id="generated-prompt"></div>
                
                <div class="button-container" style="justify-content: flex-start; gap: 1rem;">
                    <button id="copy-button" class="btn btn-primary">Copier le prompt</button>
                    <button id="download-button" class="btn btn-secondary">Télécharger</button>
                    <button id="share-button" class="btn btn-secondary">Partager</button>
                </div>
                
                <div class="tips-container">
                    <h3 class="tips-title">Comment utiliser ce prompt :</h3>
                    <ol class="tips-list">
                        <li>Copiez le prompt généré ci-dessus</li>
                        <li>Collez-le dans votre IA préférée (Claude, ChatGPT, etc.)</li>
                        <li>L'IA générera l'application pédagogique HTML selon vos spécifications</li>
                        <li>Vous pourrez ensuite télécharger ou copier le code HTML généré pour l'utiliser</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Navigation buttons -->
        <div class="button-container">
            <button class="btn btn-secondary hidden" id="prev-button">Précédent</button>
            <div style="flex-grow: 1"></div>
            <button class="btn btn-primary" id="next-button">Suivant</button>
        </div>
        
        <!-- Panneau de prévisualisation -->
        <div class="preview-panel" id="preview-panel">
            <button class="preview-close" id="preview-close">&times;</button>
            <h3 class="preview-title">Aperçu de l'application</h3>
            <div class="preview-content" id="preview-content">
                <!-- Le contenu de prévisualisation sera généré dynamiquement -->
            </div>
        </div>
    </div>

    <footer class="footer">
        Créateur de Prompts pour Applications Scientifiques © 2025
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Constants
            const STORAGE_KEY = 'prompt-generator-state';
            const AUTO_SAVE_DELAY = 2000; // 2 secondes
            
            // State management
            const state = {
                activeStep: 1, // S'assurer que l'on commence à l'étape 1
                subject: 'mathématiques',
                customSubject: '',
                levels: ['Collège - 3ème'], // Tableau de niveaux sélectionnés
                objectives: '',
                extractedTabTitles: [], // Titres d'onglets extraits du fichier texte
                extractedTabContents: [], // Contenus des onglets extraits du fichier texte
                extractedPresentation: null, // Description extraite avec la balise #P
                
				// Nouveau: contenu structuré extrait du fichier texte
				structuredContent: {
					definitions: [], // Définitions extraites avec ##D
					exercises: [],   // Exercices extraits avec ##E
					tables: [],      // Tableaux extraits avec ##T
					tooltips: [],    // Info-bulles extraites avec ##IB
					popups: [],      // Popups extraits avec ##PP
					methods: [],      // Méthodes extraites avec ##M
					iframes: [],      // Iframes extraits avec ##IFM
				},                


				// SCORM options
				useScorm: false,
				scormVersion: '1.2',
				scormOptions: {
					transmitScore: true,
					transmitCompletion: true,
					transmitTime: true,
					transmitDetailedScores: false,
					passingScore: 70,
					completionCriteria: 'both',
					maxAttempts: 0,
					autoSave: true,
					suspendData: true
				},



                useCertificate: false,
                certificateInLastTab: false, // Nouvelle option pour intégrer le certificat dans le dernier onglet
                useLatex: false,
                useCommaDecimal: true,
                showDecimalOptions: false,
                decimalPlaces: 3,
                signature: '@yoblin',
                useVersion: true,
                signature: '@skynet', // Utiliser la même valeur que dans l'interface
                versionNumber: 'V1.0',
                useColoredBubbles: true,
                versionColor: '#546e7a',
                signatureColor: '#eceff1',
                // Interface options
                useFullscreen: true,
                useAdaptiveLayout: true,
                titleAreaColor: '#455a64',
				useLogo: false,
				logoSvgCode: '',
				logoWidth: 50,
				logoHeight: 50,
				logoPosition: 'left',
                
                // Style options
                interfaceStyle: 'sober',
                gradientColor: '#3f51b5',
                // Néo style options (NOUVEAU)
                neoColor: '#00b5d9',
                neoColorOption: 'blue',
				soberColor: '#455a64',
				soberSecondaryColor: '#eceff1',
				soberColorOption: 'default',
                // Tab customization
                useTabColors: true,
                useTabIcons: true,
                iconSet: 'material',
                tabColorsCustomized: false, // Pour savoir si l'utilisateur a personnalisé les couleurs des onglets
                // Advanced navigation
                advancedNavigation: false,
                navigationOptions: {
                    stickyTabs: true,
                    tabTransitions: true,
                    tabBreadcrumbs: false
                },
                // Domain-specific options
                mathOptions: {
                    useLatexZones: false,
                    useCalculator: false,
                    useInteractiveGraphs: false
                },
                scienceOptions: {
                    useMolecularViz: false,
                    molecularType: 'link',
                    molecularLink: '',
                    usePeriodicTable: false,
                    periodicLink: '',
                    useSimulationLab: false
                },
                programmingOptions: {
                    useCodeEditor: true,
                    useSyntaxHighlighting: true,
                    useCodeExecution: false
                },
                languageOptions: {
                    usePronunciation: true,
                    useVocabularyLists: false,
                    useConversationSim: false
                },
                // Accessibility options
                accessibilityFeatures: false,
                accessibilityOptions: {
                    highContrast: true,
                    largeText: false,
                    screenReader: false
                },
                // Template options
                selectedTemplate: 'none',
                flippedClassroomTabs: 2, // Default number of home tabs for flipped classroom
                // Flashcards options
                useFlashcards: true,
                flashcardsOptions: {
                    animation: true,
                    grid: true,
                    structured: true,
                    evaluation: true,
                    score: true,
                    categories: true,
                    count: 20
                },
                // Gamification options
                useGamification: false,
                gamificationOptions: {
                    usePoints: true,
                    useBadges: true,
                    useProgress: true,
                    useRewards: true,
                    useLeaderboard: true
                },
                // Adaptive assessment options
                useAdaptiveAssessment: false,
                adaptiveAssessmentOptions: {
                    adaptiveDifficulty: true,
                    adaptiveFeedback: true,
                    adaptivePath: false
                },
                // Tab options
                tabCount: 2,
                tabs: [],
                includeQuiz: false,
                quizQuestionCount: 5,
                quizLevels: {
                    easy: true,
                    medium: true,
                    hard: false
                },
                quizCertificate: false,
                quizOptions: {
                    useTimer: false,
                    useShuffle: false,
                    useHints: false
                },
                // Certificate options
                certificateOptions: {
                    title: 'Certificat de Réussite',
                    useStudentForm: true,
                    useDetailedScores: true,
                    useSignatures: true,
                    useDate: true,
                    usePrint: true,
                    usePdf: true,
                    useImage: false,
                    borderColor: '#81c784',
                    scoreColor: '#455a64',
                    usePassword: false,
					passwordValue: '',
                    useLogo: false
                },
                // SVG and additional notes
                svgCount: 0,
                svgIllustrations: [],
                additionalNotes: '',
                // Enhanced content formatting
                enhancedContent: {
                    useEnhanced: true,
                    useDefinitionBox: true,
                    useCalculationExamples: true,
                    useMethodSection: true,
                    useTooltips: false,
                    useCollapsibleSections: false,
                    definitionBoxColor: '#e0e0e0',
                    exerciseBoxColor: '#e3f2fd',
                    methodBoxColor: '#fff3e0'
                },
                // Multimedia options
                includeMultimedia: false,
                multimediaOptions: {
                    useAudioClips: true,
                    useImageGallery: false,
                    useIframeEmbeds: false
                },
                // Final prompt
                generatedPrompt: ''
            };

            // Auto-save functionality
            let autoSaveTimeout = null;
            
            function scheduleAutoSave() {
                if (autoSaveTimeout) {
                    clearTimeout(autoSaveTimeout);
                }
                
                // Mise à jour de l'indicateur
                const indicator = document.querySelector('.autosave-indicator');
                indicator.classList.add('saving');
                indicator.innerHTML = '<span class="autosave-icon pulse">⟳</span> Enregistrement...';
                
                autoSaveTimeout = setTimeout(() => {
                    saveState();
                    
                    // Rétablir l'indicateur
                    indicator.classList.remove('saving');
                    indicator.innerHTML = '<span class="autosave-icon">✓</span> Sauvegarde automatique activée';
                }, AUTO_SAVE_DELAY);
            }
            
            // Save state to localStorage
            function saveState() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error('Erreur lors de la sauvegarde:', e);
                }
            }
            
            // Load state from localStorage
            function loadState() {
                try {
                    const savedState = localStorage.getItem(STORAGE_KEY);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        // Merge avec l'état actuel pour préserver les propriétés par défaut
                        Object.assign(state, parsedState);
                        
                        // Mettre à jour l'interface utilisateur
                        updateUIFromState();
                    }
                } catch (e) {
                    console.error('Erreur lors du chargement:', e);
                }
            }
            
			// Update UI based on loaded state
			function updateUIFromState() {
				// Mise à jour des champs de base
				document.getElementById('subject').value = state.subject;
				document.getElementById('objectives').value = state.objectives;
				document.getElementById('signature').value = state.signature;
				
				// Mise à jour pour les niveaux sélectionnés
				document.querySelectorAll('input[name="level"]').forEach(checkbox => {
					checkbox.checked = state.levels.includes(checkbox.value);
				});
				updateSelectedLevelsDisplay();
				
				// Mise à jour du slider de nombre d'onglets
				const templateTabCount = document.getElementById('template-tab-count');
				const templateTabCountDisplay = document.getElementById('template-tab-count-display');
				if (templateTabCount && templateTabCountDisplay) {
					templateTabCount.value = state.tabCount;
					templateTabCountDisplay.textContent = state.tabCount;
					templateTabCount.disabled = state.selectedTemplate !== 'none';
				}
				
				// Mise à jour de l'affichage du nombre d'onglets à l'étape 4
				const tabsCountDisplay = document.getElementById('tabs-count-display');
				if (tabsCountDisplay) {
					tabsCountDisplay.textContent = state.tabs.length;
				}
				
				// Mise à jour des options SCORM
				document.getElementById('use-scorm').checked = state.useScorm;
				document.getElementById('scorm-options').classList.toggle('hidden', !state.useScorm);
				
				// Version SCORM
				const scormVersion = state.scormVersion || '1.2';
				document.querySelector(`input[name="scorm-version"][value="${scormVersion}"]`).checked = true;
				
				// Options SCORM
				document.getElementById('scorm-score').checked = state.scormOptions?.transmitScore ?? true;
				document.getElementById('scorm-completion').checked = state.scormOptions?.transmitCompletion ?? true;
				document.getElementById('scorm-time').checked = state.scormOptions?.transmitTime ?? true;
				document.getElementById('scorm-detailed-scores').checked = state.scormOptions?.transmitDetailedScores ?? false;
				document.getElementById('scorm-passing-score').value = state.scormOptions?.passingScore || 70;
				document.getElementById('scorm-completion-criteria').value = state.scormOptions?.completionCriteria || 'both';
				document.getElementById('scorm-max-attempts').value = state.scormOptions?.maxAttempts || 0;
				document.getElementById('scorm-auto-save').checked = state.scormOptions?.autoSave ?? true;
				document.getElementById('scorm-suspend-data').checked = state.scormOptions?.suspendData ?? true;	
								
				
				// Mise à jour des options du logo
				document.getElementById('use-logo').checked = state.useLogo;
				document.getElementById('logo-options').classList.toggle('hidden', !state.useLogo);
				document.getElementById('logo-svg-code').value = state.logoSvgCode;
				document.getElementById('logo-width').value = state.logoWidth;
				document.getElementById('logo-height').value = state.logoHeight;
				document.getElementById('logo-position').value = state.logoPosition;
				
				// Afficher l'étape actuelle
				goToStep(state.activeStep);
			}


            // Synchroniser les couleurs entre le style et les onglets
            function syncTabColorsWithStyle() {
                // Obtenir les couleurs en fonction du style sélectionné
                let colorPalette = [];
                
                switch(state.interfaceStyle) {
					case 'sober':
						if (state.soberColorOption === 'default') {
							colorPalette = ['#455a64', '#546e7a', '#607d8b', '#78909c', '#90a4ae'];
						} else if (state.soberColorOption === 'red') {
							colorPalette = ['#ad4b4b', '#b25e5e', '#b77171', '#bc8585', '#c29898'];
						} else if (state.soberColorOption === 'yellow') {
							colorPalette = ['#e3c878', '#e5cd87', '#e8d397', '#ead8a6', '#edddb6'];
						} else if (state.soberColorOption === 'blue') {
							colorPalette = ['#4f81b3', '#6290bc', '#759fc4', '#88aecd', '#9bbed5'];
						} else if (state.soberColorOption === 'purple') {
							colorPalette = ['#7e57c2', '#8d6aca', '#9c7dd1', '#ab90d9', '#baa4e0'];
						}
						break;

                    case 'color':
                        colorPalette = ['#4CAF50', '#FFEB3B', '#F44336', '#2196F3', '#9C27B0'];
                        break;
                    case 'gradient':
                        // Utiliser la couleur de base du gradient et des variations
                        const baseColor = state.gradientColor || '#3f51b5';
                        
                        // Créer des variations de couleur pour le dégradé
                        function shiftColor(color, percent) {
                            const num = parseInt(color.slice(1), 16);
                            const r = (num >> 16) & 255;
                            const g = (num >> 8) & 255;
                            const b = num & 255;
                            
                            // Ajuster les couleurs selon le pourcentage
                            const factor = 1 + percent/100;
                            let R = Math.round(r * factor);
                            let G = Math.round(g * factor);
                            let B = Math.round(b * factor);
                            
                            // S'assurer que les valeurs sont dans la plage 0-255
                            R = Math.min(255, Math.max(0, R));
                            G = Math.min(255, Math.max(0, G));
                            B = Math.min(255, Math.max(0, B));
                            
                            return '#' + 
                                R.toString(16).padStart(2, '0') +
                                G.toString(16).padStart(2, '0') +
                                B.toString(16).padStart(2, '0');
                        }
                        
                        colorPalette = [
                            baseColor,
                            shiftColor(baseColor, -20),
                            shiftColor(baseColor, -10),
                            shiftColor(baseColor, 10),
                            shiftColor(baseColor, 20)
                        ];
                        break;
                    case 'neumorphic':
                        colorPalette = ['#e0e0e0', '#d0d0d0', '#e8e8e8', '#d8d8d8', '#e5e5e5'];
                        break;
                    case 'neo':
                        // Récupérer la couleur de base néo et créer des variations
                        const neoColor = state.neoColor || '#00b5d9';
                        
                        // Créer des variations de couleur pour néo
                        function shiftNeoColor(color, percent) {
                            const num = parseInt(color.slice(1), 16);
                            const r = (num >> 16) & 255;
                            const g = (num >> 8) & 255;
                            const b = num & 255;
                            
                            // Ajuster les couleurs selon le pourcentage
                            const factor = 1 + percent/100;
                            let R = Math.round(r * factor);
                            let G = Math.round(g * factor);
                            let B = Math.round(b * factor);
                            
                            // S'assurer que les valeurs sont dans la plage 0-255
                            R = Math.min(255, Math.max(0, R));
                            G = Math.min(255, Math.max(0, G));
                            B = Math.min(255, Math.max(0, B));
                            
                            return '#' + 
                                R.toString(16).padStart(2, '0') +
                                G.toString(16).padStart(2, '0') +
                                B.toString(16).padStart(2, '0');
                        }
                        
                        colorPalette = [
                            neoColor,
                            shiftNeoColor(neoColor, -15),
                            shiftNeoColor(neoColor, -5),
                            shiftNeoColor(neoColor, 5),
                            shiftNeoColor(neoColor, 15)
                        ];
                        break;
                }
                
                // Appliquer les couleurs aux onglets
                state.tabs.forEach((tab, index) => {
                    tab.color = colorPalette[index % colorPalette.length];
                });
                
                // Mettre à jour l'affichage des onglets
                renderTabs();
            }

            // Icon sets
            const iconSets = {
                material: [
                    { name: 'Accueil', icon: '🏠' },
                    { name: 'Info', icon: 'ℹ️' },
                    { name: 'Cours', icon: '📚' },
                    { name: 'Exercice', icon: '✏️' },
                    { name: 'Quiz', icon: '❓' },
                    { name: 'Vidéo', icon: '🎬' },
                    { name: 'Document', icon: '📄' },
                    { name: 'Graphique', icon: '📊' },
                    { name: 'Formule', icon: '🔢' },
                    { name: 'Lab', icon: '🧪' },
                    { name: 'Jeu', icon: '🎮' },
                    { name: 'Groupe', icon: '👥' },
                    { name: 'Liste', icon: '📋' },
                    { name: 'Télécharger', icon: '💾' },
                    { name: 'Aide', icon: '❔' }
                ],
                fontawesome: [
                    { name: 'Home', icon: '🏠' },
                    { name: 'Info', icon: 'ℹ️' },
                    { name: 'Book', icon: '📚' },
                    { name: 'Edit', icon: '✏️' },
                    { name: 'Question', icon: '❓' },
                    { name: 'Video', icon: '🎬' },
                    { name: 'File', icon: '📄' },
                    { name: 'Chart', icon: '📊' },
                    { name: 'Calculator', icon: '🧮' },
                    { name: 'Flask', icon: '🧪' },
                    { name: 'Gamepad', icon: '🎮' },
                    { name: 'Users', icon: '👥' },
                    { name: 'Check', icon: '✅' },
                    { name: 'Download', icon: '⬇️' },
                    { name: 'Lightbulb', icon: '💡' }
                ],
                emoji: [
                    { name: 'Sourire', icon: '😊' },
                    { name: 'Réflexion', icon: '🤔' },
                    { name: 'Idée', icon: '💡' },
                    { name: 'Victoire', icon: '🏆' },
                    { name: 'Cerveau', icon: '🧠' },
                    { name: 'Étoile', icon: '⭐' },
                    { name: 'Cœur', icon: '❤️' },
                    { name: 'Main', icon: '👋' },
                    { name: 'Horloge', icon: '⏰' },
                    { name: 'Globe', icon: '🌍' },
                    { name: 'Loupe', icon: '🔍' },
                    { name: 'Fusée', icon: '🚀' },
                    { name: 'Cible', icon: '🎯' },
                    { name: 'Clé', icon: '🔑' },
                    { name: 'Ampoule', icon: '💡' }
                ]
            };

            // Templates pédagogiques prédéfinis
            const templates = {
                none: {
                    name: 'Structure personnalisée',
                    tabCount: 2,
                    tabs: [
                        { title: 'Onglet 1', content: '' },
                        { title: 'Onglet 2', content: '' }
                    ]
                },
                progressive: {
                    name: 'Cours structuré',
                    tabCount: 5,
                    tabs: [
                        { title: 'Introduction', content: 'Présentation du concept et des objectifs d\'apprentissage.' },
                        { title: 'Concept 1', content: 'Explication détaillée du concept principal.' },
                        { title: 'Concept 2', content: 'Exemples concrets illustrant le concept n°2.' },
                        { title: 'Application', content: 'Exercices pratiques pour appliquer le concept.' },
                        { title: 'Révisions', content: 'Flashcards pour auto-evaluation' },
                        { title: 'Évaluation et certification', content: 'Tests pour évaluer la compréhension du conceptn, certificat personnalisé à imprimer.' }
                    ]
                },
                problem: {
                    name: 'Apprentissage par problème',
                    tabCount: 5,
                    tabs: [
                        { title: 'Problème', content: 'Présentation du problème à résoudre.' },
                        { title: 'Outils', content: 'Ressources et méthodes pour aborder le problème.' },
                        { title: 'Exploration', content: 'Analyse et exploration des différentes approches.' },
                        { title: 'Solution', content: 'Présentation de la solution au problème.' },
                        { title: 'Réflexion', content: 'Réflexion sur le processus et les apprentissages.' }
                    ]
                },
                revision: {
                    name: 'Révision efficace',
                    tabCount: 4,
                    tabs: [
                        { title: 'Rappel', content: 'Rappel des notions essentielles à réviser.' },
                        { title: 'Exercice', content: 'Exercices pratiques de révision.' },
                        { title: 'Auto-évaluation', content: 'Tests pour évaluer sa maîtrise du sujet.' },
                        { title: 'Renforcement', content: 'Exercices supplémentaires pour renforcer les points faibles.' }
                    ]
				},
				flipped: {
					name: 'Classe inversée',
					tabCount: 5, // Valeur par défaut (3 onglets de base + 2 onglets "À la maison")
					tabs: [
						{ title: "À la maison 1", content: "Contenu à étudier à la maison - partie 1." },
						{ title: "À la maison 2", content: "Contenu à étudier à la maison - partie 2." },
						{ 
							title: "Organisation en classe", 
							content: "Activités pratiques à réaliser en classe, incluant une activité d'appariement."
						},
						{ 
							title: "Révision", 
							content: "Exercices de révision pour consolider les connaissances." 
						},
						{ 
							title: "Certification", 
							content: "Évaluation finale et certification des acquis." 
						}
					]
				}
            };


			// Fonction pour mettre à jour la prévisualisation des onglets
			function updateTabsPreview() {
				const previewContainer = document.getElementById('tabs-preview-display');
				if (!previewContainer) return;
				
				// Vider le conteneur
				previewContainer.innerHTML = '';
				
				// Créer un aperçu pour chaque onglet
				state.tabs.forEach(tab => {
					const tabPreview = document.createElement('div');
					tabPreview.className = 'tab-preview';
					tabPreview.textContent = tab.title;
					tabPreview.title = tab.title; // Pour afficher le titre complet au survol
					
					previewContainer.appendChild(tabPreview);
				});
				
				// Afficher un message si aucun onglet n'est défini
				if (state.tabs.length === 0) {
					previewContainer.innerHTML = '<div style="color: #666; font-style: italic;">Aucun onglet défini</div>';
				}
			}


			// Initialize tabs
			function initializeTabs() {
				// Default colors - palette harmonieuse
				const defaultColors = ['#607d8b', '#78909c', '#90a4ae', '#b0bec5', '#cfd8dc', '#455a64', '#546e7a', '#37474f'];
				const defaultIcons = ['🏠', 'ℹ️', '📚', '✏️', '❓', '🎬', '📄', '📊', '🔢', '🧪'];
				
				// Get template if selected
				const selectedTemplate = templates[state.selectedTemplate];
				
				if (selectedTemplate && state.selectedTemplate !== 'none') {
					// Use template settings only for non-custom templates
					state.tabCount = selectedTemplate.tabCount;
					
					// Spécial pour la classe inversée: ajuster le nombre d'onglets "À la maison"
					if (state.selectedTemplate === 'flipped') {
						// On ajuste la structure de l'onglet pour la classe inversée
						let flippedTabs = [];
						
						// Générer les onglets "À la maison" selon le nombre demandé
						for (let i = 1; i <= state.flippedClassroomTabs; i++) {
							flippedTabs.push({
								title: `À la maison ${i}`,
								content: `Contenu à étudier à la maison - partie ${i}.`
							});
						}
						
						// Ajouter les autres onglets standards du template
						flippedTabs = flippedTabs.concat([
							{ 
								title: "Organisation en classe", 
								content: "Activités pratiques à réaliser en classe, incluant une activité d'appariement."
							},
							{ 
								title: "Révision", 
								content: "Exercices de révision pour consolider les connaissances." 
							},
							{ 
								title: "Certification", 
								content: "Évaluation finale et certification des acquis." 
							}
						]);
						
						// Mise à jour du tabCount
						state.tabCount = flippedTabs.length;
						
						// Création des onglets
						state.tabs = flippedTabs.map((templateTab, index) => ({
							id: index + 1,
							title: templateTab.title,
							content: templateTab.content,
							color: defaultColors[index % defaultColors.length],
							icon: defaultIcons[index % defaultIcons.length],
							links: '',
							videos: '',
							videoStart: 0,
							videoEnd: 0,
							hasSecondVideo: false,
							secondVideoUrl: '',
							secondVideoStart: 0,
							secondVideoEnd: 0,
							hasQuiz: index === flippedTabs.length - 1, // Quiz on last tab by default
							quizQuestions: 3,
							hasFlashcards: false,
							flashcardsCount: 5,
							useCustomIframe: false,
							customIframeCode: '',
							useIframeActivation: false,
							iframeButtonText: 'Afficher le contenu',
							iframeButtonColor: '#9D8EC7',
							hasInteractiveGraphics: false,
							hasGrapheur: false,
							grapheurFunctions: '',
							grapheurEditable: true,
							maxActivities: 4,
							hasTableau: false,
							tableauData: '',
							tableauRegression: true,
							geogebraLink: '',
							disableScroll: true
						}));
					} else {
						// Pour les autres templates, on conserve le comportement original
						// Create tabs based on template
						state.tabs = selectedTemplate.tabs.map((templateTab, index) => ({
							id: index + 1,
							title: templateTab.title,
							content: templateTab.content,
							color: defaultColors[index % defaultColors.length],
							icon: defaultIcons[index % defaultIcons.length],
							links: '',
							videos: '',
							videoStart: 0,
							videoEnd: 0,
							useCustomIframe: false,
							customIframeCode: '',
							useIframeActivation: false,
							iframeButtonText: 'Afficher le contenu',
							iframeButtonColor: '#9D8EC7',
							hasSecondVideo: false,
							secondVideoUrl: '',
							secondVideoStart: 0,
							secondVideoEnd: 0,
							hasQuiz: index === selectedTemplate.tabCount - 1, // Quiz on last tab by default
							quizQuestions: 3,
							hasFlashcards: state.selectedTemplate === 'revision' && index === 2, // Flashcards on Auto-évaluation tab
							flashcardsCount: 5,
							hasInteractiveGraphics: false,
							hasGrapheur: false,
							grapheurFunctions: '',
							grapheurEditable: true,
							maxActivities: 4,
							hasTableau: false,
							tableauData: '',
							tableauRegression: true,
							geogebraLink: '',
							disableScroll: true
						}));
					}
					
					// CORRECTION: Supprimer l'onglet "Évaluation et certification" si on est dans le modèle progressif
					// et que l'option certificateInLastTab est activée
					if (state.selectedTemplate === 'progressive' && state.certificateInLastTab) {
						// Filtrer pour supprimer l'onglet "Évaluation et certification" existant
						state.tabs = state.tabs.filter(tab => tab.title !== "Évaluation et certification");
					}
				} else {
					// Comportement pour le mode structure personnalisée
			
					// CORRECTION DU BUG: Priorité au nombre d'onglets défini par l'utilisateur
					// si c'est un changement explicite du nombre d'onglets
					
					// Si le changement vient de l'utilisateur via le champ tab-count,
					// on utilise la valeur de tabCount, sinon on peut utiliser les onglets extraits
					if (state.extractedTabTitles.length > 0 && !state._isTabCountUserModified) {
						// Utiliser les titres et contenus extraits
						state.tabCount = state.extractedTabTitles.length;
						
						state.tabs = state.extractedTabTitles.map((title, index) => {
							// Utiliser le contenu extrait s'il existe, sinon laisser vide
							const content = state.extractedTabContents && state.extractedTabContents[index] 
								? state.extractedTabContents[index] 
								: '';
							
							return {
								id: index + 1,
								title: title,
								content: content,
								color: defaultColors[index % defaultColors.length],
								icon: defaultIcons[index % defaultIcons.length],
								links: '',
								videos: '',
								videoStart: 0,
								videoEnd: 0,
								useCustomIframe: false,
								customIframeCode: '',
								useIframeActivation: false,
								iframeButtonText: 'Afficher le contenu',
								iframeButtonColor: '#9D8EC7',
								hasSecondVideo: false,
								secondVideoUrl: '',
								secondVideoStart: 0,
								secondVideoEnd: 0,
								hasQuiz: false,
								quizQuestions: 3,
								hasFlashcards: false,
								flashcardsCount: 5,
								hasInteractiveGraphics: false,
								geogebraLink: '',
								disableScroll: true
							};
						});
					} else {
						// CORRECTION: Utiliser le nombre d'onglets défini par l'utilisateur
						state.tabs = Array(state.tabCount).fill().map((_, index) => ({
							id: index + 1,
							title: `Onglet ${index + 1}`,
							content: '',
							color: defaultColors[index % defaultColors.length],
							icon: defaultIcons[index % defaultIcons.length],
							links: '',
							videos: '',
							videoStart: 0,
							videoEnd: 0,
							useCustomIframe: false,
							customIframeCode: '',
							useIframeActivation: false,
							iframeButtonText: 'Afficher le contenu',
							iframeButtonColor: '#9D8EC7',
							hasSecondVideo: false,
							secondVideoUrl: '',
							secondVideoStart: 0,
							secondVideoEnd: 0,
							hasQuiz: false,
							quizQuestions: 3,
							hasFlashcards: false,
							flashcardsCount: 5,
							hasInteractiveGraphics: false,
							maxActivities: 4,
							geogebraLink: '',
							hasMatchingActivity: false,
							matchingItems: 4,
							disableScroll: true
						}));
						
						// Réinitialiser le flag après utilisation
						state._isTabCountUserModified = false;
					}
				}
			
				// Vérifier si l'on a des onglets spéciaux (bibliographie ou glossaire)
				if (state.tabs.some(tab => tab.specialType === 'B' || tab.specialType === 'G')) {
					// Parcourir les onglets pour identifier les onglets spéciaux
					state.tabs.forEach(tab => {
						if (tab.specialType === 'B') {
							// Onglet de bibliographie - définir une icône appropriée
							tab.icon = '📚';
						} else if (tab.specialType === 'G') {
							// Onglet de glossaire - définir une icône appropriée
							tab.icon = '📖';
						}
					});
				}
			
				// Forcer l'onglet Certification pour certains templates, indépendamment de l'option cochée
				const forceLastTabCertification = state.selectedTemplate === 'progressive' || 
												 state.selectedTemplate === 'flipped';            
							
			
				// Vérifier si nous devons ajouter un onglet Certification (si l'option est activée)
				if (state.certificateInLastTab || forceLastTabCertification) {
					// Vérifier si le dernier onglet n'est pas déjà nommé "Certification"
					const lastTab = state.tabs[state.tabs.length - 1];
					
					if (lastTab.title !== "Certification") {
						// Créer un nouvel onglet Certification
						const certificationTab = {
							id: state.tabs.length + 1,
							title: "Certification",
							content: "Évaluation finale et certificat de réussite. En options, impression, export du certificat en pdf et en JPEG",
							color: defaultColors[state.tabs.length % defaultColors.length],
							icon: '🏆', // Icône trophée pour l'onglet certification
							links: '',
							videos: '',
							videoStart: 0,
							videoEnd: 0,
							useCustomIframe: false,
							customIframeCode: '',
							useIframeActivation: false,
							iframeButtonText: 'Afficher le contenu',
							iframeButtonColor: '#9D8EC7',
							hasSecondVideo: false,
							secondVideoUrl: '',
							secondVideoStart: 0,
							secondVideoEnd: 0,
							// Quiz dans l'onglet certification sauf si l'option "onglet quiz" est activée 
							// ou si le modèle "cours structuré" est choisi
							hasQuiz: !(state.includeQuiz || state.selectedTemplate === 'progressive'),
							quizQuestions: 5,
							hasFlashcards: false,
							flashcardsCount: 0,
							hasInteractiveGraphics: false,
							geogebraLink: '',
							disableScroll: true
						};
						
						// Ajouter le nouvel onglet certification à la liste des onglets
						state.tabs.push(certificationTab);
						
						// Mettre à jour le nombre d'onglets
						state.tabCount = state.tabs.length;
					} else {
						// Si le dernier onglet est déjà nommé "Certification", s'assurer qu'il a les bonnes propriétés
						lastTab.icon = '🏆';
						lastTab.hasQuiz = !(state.includeQuiz || state.selectedTemplate === 'progressive');
					}
				} else {
					// Si l'option est désactivée mais que le dernier onglet est nommé "Certification",
					// renommer ce dernier onglet pour éviter toute confusion
					const lastTab = state.tabs[state.tabs.length - 1];
					if (lastTab.title === "Certification") {
						lastTab.title = `Onglet ${lastTab.id}`;
					}
				}
				
				// Synchroniser les couleurs si elles ne sont pas personnalisées
				if (!state.useTabColors || !state.tabColorsCustomized) {
					syncTabColorsWithStyle();
				}
				
				// Add matching activity to "Organisation en classe" tab if flipped classroom template is selected
				if (state.selectedTemplate === 'flipped') {
					const classOrgTab = state.tabs.find(tab => tab.title === "Organisation en classe");
					if (classOrgTab) {
						classOrgTab.hasMatchingActivity = true;
						classOrgTab.matchingItems = 4; // Default to 4 items to match
					}
				}
				
				// Mise à jour des affichages du nombre d'onglets
				// Étape 2 - Slider
				const templateTabCount = document.getElementById('template-tab-count');
				const templateTabCountDisplay = document.getElementById('template-tab-count-display');
				if (templateTabCount && templateTabCountDisplay) {
					templateTabCount.value = state.tabs.length;
					templateTabCountDisplay.textContent = state.tabs.length;
					templateTabCount.disabled = state.selectedTemplate !== 'none';
				}
				
				// Étape 4 - Affichage
				const tabsCountDisplay = document.getElementById('tabs-count-display');
				if (tabsCountDisplay) {
					tabsCountDisplay.textContent = state.tabs.length;
				}
				
				// Update UI
				renderTabs();
				updateTabsPreview();
			}



            // Initialize SVG illustrations
            function initializeSvgIllustrations() {
                const svgContainer = document.getElementById('svg-container');
                svgContainer.innerHTML = '';
                
                state.svgIllustrations = Array(state.svgCount).fill().map((_, index) => ({
                    id: index + 1,
                    title: `Illustration ${index + 1}`,
                    code: ''
                }));
                
                state.svgIllustrations.forEach((svg, index) => {
                    const svgElement = document.createElement('div');
                    svgElement.className = 'svg-container';
                    
                    svgElement.innerHTML = `
                        <div class="svg-header">
                            <div class="svg-title">Illustration SVG ${index + 1}</div>
                            <div class="svg-actions">
                                <button class="btn btn-secondary svg-preview-btn" data-index="${index}">Aperçu</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Titre de l'illustration:</label>
                            <input type="text" class="form-control svg-title-input" data-index="${index}" value="${svg.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Code SVG:</label>
                            <textarea class="form-control svg-code-input" data-index="${index}" rows="5" placeholder="Collez ici le code SVG...">${svg.code}</textarea>
                        </div>
                    `;
                    
                    svgContainer.appendChild(svgElement);
                });
                
                // Add event listeners for SVG inputs
                document.querySelectorAll('.svg-title-input').forEach(input => {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        state.svgIllustrations[index].title = this.value;
                        scheduleAutoSave();
                    });
                });
                
                document.querySelectorAll('.svg-code-input').forEach(input => {
                    input.addEventListener('input', function() {
                        const index = parseInt(this.dataset.index);
                        state.svgIllustrations[index].code = this.value;
                        scheduleAutoSave();
                    });
                });
                
                // Add event listeners for SVG preview buttons
                document.querySelectorAll('.svg-preview-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const svgCode = state.svgIllustrations[index].code;
                        if (svgCode.trim()) {
                            showPreview(`<div style="text-align: center; padding: 20px;">${svgCode}</div>`);
                        } else {
                            alert('Veuillez d\'abord entrer du code SVG.');
                        }
                    });
                });
            }

            // Render icon picker for a tab
            function renderIconPicker(tabIndex, selectedIcon) {
                const icons = iconSets[state.iconSet];
                const pickerContainer = document.createElement('div');
                pickerContainer.className = 'icon-picker hidden';
                pickerContainer.dataset.tabIndex = tabIndex;
                
                let iconOptionsHTML = '';
                icons.forEach(icon => {
                    const selectedClass = icon.icon === selectedIcon ? 'selected' : '';
                    iconOptionsHTML += `
                        <div class="icon-option ${selectedClass}" data-icon="${icon.icon}" data-name="${icon.name}">
                            <div class="icon-display">${icon.icon}</div>
                            <div class="icon-name">${icon.name}</div>
                        </div>
                    `;
                });
                
                pickerContainer.innerHTML = iconOptionsHTML;
                
                // Add click events to icon options
                pickerContainer.querySelectorAll('.icon-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // Remove selected class from all siblings
                        pickerContainer.querySelectorAll('.icon-option').forEach(el => {
                            el.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked icon
                        this.classList.add('selected');
                        
                        // Update state
                        const icon = this.dataset.icon;
                        state.tabs[tabIndex].icon = icon;
                        
                        // Update the visible icon display in the UI
                        const iconDisplay = document.querySelector(`.tab-icon-display[data-index="${tabIndex}"]`);
                        if (iconDisplay) {
                            iconDisplay.innerHTML = icon;
                        }
                        
                        // Hide the picker after selection
                        pickerContainer.classList.add('hidden');
                        
                        scheduleAutoSave();
                    });
                });
                
                return pickerContainer;
            }

            // Add an indicator to show the icon is clickable
            function updateIconSelectorBehavior() {
                document.querySelectorAll('.tab-icon-display').forEach(iconDisplay => {
                    // Add tooltip
                    iconDisplay.setAttribute('title', 'Cliquez pour changer l\'icône');
                    
                    // Add visual indicator
                    const index = iconDisplay.dataset.index;
                    const iconPickerContainer = document.querySelector(`.icon-picker-container-${index}`);
                    
                    if (iconPickerContainer) {
                        // Remove existing guide if any
                        const existingGuide = iconPickerContainer.parentNode.querySelector('.picker-guide');
                        if (existingGuide) {
                            existingGuide.remove();
                        }
                        
                        const pickerGuide = document.createElement('div');
                        pickerGuide.className = 'picker-guide';
                        pickerGuide.innerHTML = '↓ Cliquez sur l\'icône pour changer ↓';
                        
                        // Insert before the icon picker container
                        iconPickerContainer.parentNode.insertBefore(pickerGuide, iconPickerContainer);
                    }
                });
            }
            
            
						
			// Render tabs based on current state
			function renderTabs() {
				const tabsContainer = document.getElementById('tabs-container');
				tabsContainer.innerHTML = '';
			
				state.tabs.forEach((tab, index) => {
					const tabElement = document.createElement('div');
					
					// Ajouter une classe spéciale si c'est l'onglet certification
					if (tab.title === "Certification" || tab.title.includes("Certification")) {
						tabElement.className = 'tab-card certification-tab-card';
					} else {
						tabElement.className = 'tab-card';
					}
					
					// Définir le HTML de l'en-tête avec un badge spécial pour l'onglet certification
					let tabHeaderHTML;
					
					if (tab.title === "Certification" || tab.title.includes("Certification")) {
						tabHeaderHTML = `
							<div class="tab-header">
								<h3 class="tab-title">
									<span style="display: inline-block; background-color: #ffd700; color: #8B4513; padding: 2px 8px; border-radius: 12px; margin-right: 8px; font-size: 0.8rem;">CERTIFICATION</span>
									Onglet ${index + 1}
								</h3>
								${state.useTabColors ? `<div class="tab-color-preview" style="background-color: ${tab.color};"></div>` : ''}
							</div>
						`;
					} else {
						tabHeaderHTML = `
							<div class="tab-header">
								<h3 class="tab-title">Onglet ${index + 1}</h3>
								${state.useTabColors ? `<div class="tab-color-preview" style="background-color: ${tab.color};"></div>` : ''}
							</div>
						`;
					}
					
					// Déterminer si c'est un onglet certification
					const isCertificationTab = tab.title === "Certification" || tab.title.includes("Certification");
					
					const tabContentHTML = `
						<div class="form-group">
							<label class="form-label">Titre:</label>
							<input type="text" class="form-control tab-title-input" data-index="${index}" value="${tab.title}">
						</div>
						
						<div class="form-group" style="display: ${state.useTabColors ? 'block' : 'none'}">
							<label class="form-label">Couleur de l'onglet:</label>
							<div class="color-picker-container">
								<input type="color" class="form-control-inline tab-color-input" data-index="${index}" value="${tab.color}">
								<div class="color-preview tab-color-preview-${index}" style="background-color: ${tab.color};"></div>
							</div>
						</div>
						
						${(state.useTabIcons && !isCertificationTab) ? `
						<div class="form-group">
							<label class="form-label">Icône:</label>
							<div class="form-control tab-icon-display" data-index="${index}">${tab.icon}</div>
							<div class="icon-picker-container-${index}"></div>
						</div>
						` : (state.useTabIcons && isCertificationTab) ? `
						<div class="form-group">
							<label class="form-label">Icône (fixe pour certification):</label>
							<div class="form-control" style="cursor: default; background-color: #f8f8f8;">${tab.icon}</div>
						</div>
						` : ''}
						
						<div class="form-group">
							<label class="form-label">Liens éventuels:</label>
							<input type="text" class="form-control tab-links-input" data-index="${index}" value="${tab.links}" placeholder="Ex: https://exemple.com, https://autre-exemple.com">
						</div>
						
						<div class="form-group">
							<label class="form-label">Vidéo principale (URL):</label>
							<input type="text" class="form-control tab-videos-input" data-index="${index}" value="${tab.videos}" placeholder="Ex: https://youtube.com/embed/xyz">
							
							<!-- Nouveaux contrôles pour le temps de la vidéo -->
							<div class="nested-container video-time-controls">
								<div class="form-row">
									<label class="form-label">Temps de début (secondes):</label>
									<input type="number" class="form-control tab-video-start-input" data-index="${index}" value="${tab.videoStart || 0}" min="0" style="width: 120px">
									
									<label class="form-label" style="margin-left: 1rem;">Temps de fin (secondes):</label>
									<input type="number" class="form-control tab-video-end-input" data-index="${index}" value="${tab.videoEnd || 0}" min="0" style="width: 120px">
								</div>
								<div class="form-row" style="font-size: 0.85rem; color: var(--gray);">
									<p>Laissez à 0 pour ne pas définir de temps. Pour YouTube, utilisez seulement le temps en secondes (ex: 125 pour 2min05).</p>
								</div>
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" id="use-custom-iframe" class="tab-custom-iframe-checkbox" data-index="${index}">
								<label for="use-custom-iframe">Utiliser un code iframe personnalisé</label>
							</div>
							
							<div class="nested-container" id="custom-iframe-options" style="display: none;">
								<label class="form-label">Code iframe personnalisé:</label>
								<textarea class="form-control tab-custom-iframe-code" data-index="${index}" rows="4" placeholder="Collez ici le code iframe complet (ex: <iframe src=...></iframe>)"></textarea>
								<p class="api-format-info">Cette option remplacera l'intégration vidéo standard et utilisera votre code personnalisé.</p>
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-iframe-activation-checkbox" data-index="${index}" id="tab-iframe-activation-${index}">
								<label for="tab-iframe-activation-${index}">Activer un bouton pour afficher la vidéo</label>
							</div>
							
							<div class="nested-container hidden" id="iframe-activation-options-${index}">
								<label class="form-label">Texte du bouton:</label>
								<input type="text" class="form-control tab-iframe-button-text" data-index="${index}" placeholder="Afficher le contenu" value="Afficher le contenu">
								
								<div class="form-group" style="margin-top: 10px;">
									<label class="form-label">Couleur du bouton:</label>
									<div class="color-picker-container">
										<input type="color" class="form-control-inline tab-iframe-button-color" data-index="${index}" value="#9D8EC7">
										<div class="color-preview tab-iframe-button-color-preview-${index}" style="background-color: #9D8EC7;"></div>
									</div>
								</div>
							</div>
							
							
							
						</div>
						
						<div class="form-group">
							<div class="checkbox-container">
								<input type="checkbox" class="tab-second-video-checkbox" data-index="${index}" id="tab-second-video-${index}" ${tab.hasSecondVideo ? 'checked' : ''}>
								<label for="tab-second-video-${index}">Ajouter une deuxième vidéo</label>
							</div>
							
							<div class="nested-container ${tab.hasSecondVideo ? '' : 'hidden'}" id="second-video-options-${index}">
								<label class="form-label">URL de la deuxième vidéo:</label>
								<input type="text" class="form-control tab-second-video-input" data-index="${index}" value="${tab.secondVideoUrl || ''}" placeholder="Ex: https://youtube.com/embed/xyz">
								
								<!-- Nouveaux contrôles pour le temps de la seconde vidéo -->
								<div class="nested-container video-time-controls">
									<div class="form-row">
										<label class="form-label">Temps de début (secondes):</label>
										<input type="number" class="form-control tab-second-video-start-input" data-index="${index}" value="${tab.secondVideoStart || 0}" min="0" style="width: 120px">
										
										<label class="form-label" style="margin-left: 1rem;">Temps de fin (secondes):</label>
										<input type="number" class="form-control tab-second-video-end-input" data-index="${index}" value="${tab.secondVideoEnd || 0}" min="0" style="width: 120px">
									</div>
									<div class="form-row" style="font-size: 0.85rem; color: var(--gray);">
										<p>Laissez à 0 pour ne pas définir de temps. Pour YouTube, utilisez seulement le temps en secondes (ex: 125 pour 2min05).</p>
									</div>
								</div>
							</div>
						</div>
						
						<div class="form-group">
							<label class="form-label">Contenu:</label>
							<textarea class="form-control tab-content-input" data-index="${index}" placeholder="Description du contenu en quelques lignes...">${tab.content}</textarea>
						</div>
						
						<div class="options-section">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<h3 class="options-section-title">Outils interactifs pour cet onglet</h3>
								<div class="activities-counter" style="background-color: #f1f1f1; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;">
									Activités: <span id="activities-counter-${index}">0/${tab.maxActivities}</span>
								</div>
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-graphics-checkbox" data-index="${index}" id="tab-graphics-${index}" ${tab.hasInteractiveGraphics ? 'checked' : ''}>
								<label for="tab-graphics-${index}">Intégrer des graphiques interactifs dans cet onglet</label>
							</div>
							
							<div class="nested-container ${tab.hasInteractiveGraphics ? '' : 'hidden'}" id="graphics-options-${index}">
								<div class="form-group">
									<label class="form-label">Lien GeoGebra (optionnel):</label>
									<input type="text" class="form-control tab-geogebra-link" data-index="${index}" value="${tab.geogebraLink || ''}" placeholder="URL GeoGebra pour intégration">
								</div>
								<div class="checkbox-container">
									<input type="checkbox" class="tab-disable-scroll" data-index="${index}" id="tab-disable-scroll-${index}" ${tab.disableScroll ? 'checked' : ''}>
									<label for="tab-disable-scroll-${index}">Désactiver la fonction scroll</label>
								</div>
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-quiz-checkbox" data-index="${index}" id="tab-quiz-${index}" ${tab.hasQuiz ? 'checked' : ''}>
								<label for="tab-quiz-${index}">Intégrer un quiz dans cet onglet</label>
							</div>
							
							<div class="nested-container ${tab.hasQuiz ? '' : 'hidden'}" id="quiz-options-${index}">
								<label class="form-label">Nombre de questions:</label>
								<input type="number" class="form-control tab-quiz-questions" data-index="${index}" value="${tab.quizQuestions}" style="width: 120px" min="1" max="20">
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-flashcards-checkbox" data-index="${index}" id="tab-flashcards-${index}" ${tab.hasFlashcards ? 'checked' : ''}>
								<label for="tab-flashcards-${index}">Intégrer des flashcards dans cet onglet</label>
							</div>
							
							<div class="nested-container ${tab.hasFlashcards ? '' : 'hidden'}" id="flashcards-options-${index}">
								<label class="form-label">Nombre de cartes:</label>
								<input type="number" class="form-control tab-flashcards-count" data-index="${index}" value="${tab.flashcardsCount}" style="width: 120px" min="1" max="50">
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-matching-checkbox" data-index="${index}" id="tab-matching-${index}" ${tab.hasMatchingActivity ? 'checked' : ''}>
								<label for="tab-matching-${index}">Intégrer une activité d'appariement dans cet onglet</label>
							</div>
							
							<div class="nested-container ${tab.hasMatchingActivity ? '' : 'hidden'}" id="matching-options-${index}">
								<label class="form-label">Nombre d'éléments à faire correspondre:</label>
								<select class="form-control tab-matching-items" data-index="${index}" style="width: 120px">
									<option value="3" ${tab.matchingItems === 3 ? 'selected' : ''}>3 paires</option>
									<option value="4" ${tab.matchingItems === 4 ? 'selected' : ''}>4 paires</option>
									<option value="5" ${tab.matchingItems === 5 ? 'selected' : ''}>5 paires</option>
								</select>
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-grapheur-checkbox" data-index="${index}" id="tab-grapheur-${index}" ${tab.hasGrapheur ? 'checked' : ''}>
								<label for="tab-grapheur-${index}">Intégrer un grapheur mathématique dans cet onglet</label>
							</div>
							
							<div class="nested-container ${tab.hasGrapheur ? '' : 'hidden'}" id="grapheur-options-${index}">
								<div class="form-group">
									<label class="form-label">Fonctions prédéfinies (une par ligne):</label>
									<textarea class="form-control tab-grapheur-functions" data-index="${index}" rows="3" placeholder="Ex: x^2, sin(x), 2*x+1">${tab.grapheurFunctions || ''}</textarea>
								</div>
								<div class="checkbox-container">
									<input type="checkbox" class="tab-grapheur-editable" data-index="${index}" id="tab-grapheur-editable-${index}" ${tab.grapheurEditable ? 'checked' : ''}>
									<label for="tab-grapheur-editable-${index}">Permettre à l'utilisateur de modifier les fonctions</label>
								</div>
							</div>
							
							<div class="checkbox-container">
								<input type="checkbox" class="tab-tableau-checkbox" data-index="${index}" id="tab-tableau-${index}" ${tab.hasTableau ? 'checked' : ''}>
								<label for="tab-tableau-${index}">Intégrer un tableau de données dans cet onglet</label>
							</div>
							
							<div class="nested-container ${tab.hasTableau ? '' : 'hidden'}" id="tableau-options-${index}">
								<div class="form-group">
									<label class="form-label">Données prédéfinies (CSV, avec virgules):</label>
									<textarea class="form-control tab-tableau-data" data-index="${index}" rows="4" placeholder="X,Y1,Y2&#10;0,0,0&#10;1,1,2&#10;2,4,4">${tab.tableauData || ''}</textarea>
								</div>
								<div class="checkbox-container">
									<input type="checkbox" class="tab-tableau-regression" data-index="${index}" id="tab-tableau-regression-${index}" ${tab.tableauRegression ? 'checked' : ''}>
									<label for="tab-tableau-regression-${index}">Inclure les outils de régression</label>
								</div>
							</div>
							
							<div class="form-group">
								<label class="form-label">Nombre maximum d'activités pour cet onglet:</label>
								<select class="form-control tab-max-activities" data-index="${index}" style="width: 120px">
									${Array.from({length: 10}, (_, i) => i + 1).map(num => 
										`<option value="${num}" ${tab.maxActivities === num ? 'selected' : ''}>${num} activité${num > 1 ? 's' : ''}</option>`
									).join('')}
								</select>
								<div class="form-text" style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">
									Limite le nombre total d'activités générées pour cet onglet. Les QCM et Flashcards comptent chacun comme une activité, quelle que soit leur taille.
								</div>
							</div>
							
							<div class="form-text" style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">
								Limite le nombre total d'éléments par onglet incluant : activités interactives (grapheur, tableau, quiz), 
								éléments de contenu (définitions, exemples, exercices encadrés) et éléments multimédias (vidéos).
							</div>	
							
						</div>
					`;
					
					tabElement.innerHTML = tabHeaderHTML + tabContentHTML;
					tabsContainer.appendChild(tabElement);
					
					// Add icon picker only if we're not in a certification tab and icons are enabled
					if (state.useTabIcons && !isCertificationTab) {
						const iconPickerContainer = tabElement.querySelector(`.icon-picker-container-${index}`);
						if (iconPickerContainer) {
							const iconPicker = renderIconPicker(index, tab.icon);
							iconPickerContainer.appendChild(iconPicker);
							
							// Add click event to show/hide icon picker
							const iconDisplay = tabElement.querySelector(`.tab-icon-display[data-index="${index}"]`);
							if (iconDisplay) {
								iconDisplay.addEventListener('click', function() {
									iconPicker.classList.toggle('hidden');
								});
							}
						}
					}
				});
			
				// Add event listeners for tab inputs
				document.querySelectorAll('.tab-title-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].title = this.value;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-color-input').forEach(input => {
					input.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].color = this.value;
						state.tabColorsCustomized = true; // Marquer les couleurs comme personnalisées
						document.querySelector(`.tab-color-preview-${index}`).style.backgroundColor = this.value;
						updateStyleTabsInfo();
						scheduleAutoSave();
					});
				});
			
				// Écouteur pour l'option iframe personnalisé
				document.querySelectorAll('.tab-custom-iframe-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].useCustomIframe = this.checked;
						document.getElementById('custom-iframe-options').style.display = this.checked ? 'block' : 'none';
						
						// Si l'option est activée, il faut aussi mettre à jour le compteur d'activités
						updateActivitiesCounter(index);
						scheduleAutoSave();
					});
				});
				
				
				// Écouteurs pour l'option d'activation d'iframe
				document.querySelectorAll('.tab-iframe-activation-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].useIframeActivation = this.checked;
						document.getElementById(`iframe-activation-options-${index}`).classList.toggle('hidden', !this.checked);
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-iframe-button-text').forEach(input => {
					input.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].iframeButtonText = this.value;
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-iframe-button-color').forEach(input => {
					input.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].iframeButtonColor = this.value;
						updateColorPreview('tab-iframe-button-color-' + index, 'tab-iframe-button-color-preview-' + index);
						scheduleAutoSave();
					});
				});
				
				
				
				
				document.querySelectorAll('.tab-custom-iframe-code').forEach(textarea => {
					textarea.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].customIframeCode = this.value;
						scheduleAutoSave();
					});
				});
			
			
				document.querySelectorAll('.tab-links-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].links = this.value;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-videos-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].videos = this.value;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-content-input').forEach(input => {
					input.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].content = this.value;
						scheduleAutoSave();
					});
				});
				
				// Nouveaux écouteurs pour les contrôles de temps vidéo
				document.querySelectorAll('.tab-video-start-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].videoStart = parseInt(this.value) || 0;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-video-end-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].videoEnd = parseInt(this.value) || 0;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-second-video-start-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].secondVideoStart = parseInt(this.value) || 0;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-second-video-end-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].secondVideoEnd = parseInt(this.value) || 0;
						scheduleAutoSave();
					});
				});
				
				// Event listeners for second video options
				document.querySelectorAll('.tab-second-video-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasSecondVideo = this.checked;
						document.getElementById(`second-video-options-${index}`).classList.toggle('hidden', !this.checked);
						// Ajouter cette ligne pour mettre à jour le compteur
						updateActivitiesCounter(index);
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-second-video-input').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].secondVideoUrl = this.value;
						scheduleAutoSave();
					});
				});
				
				// Event listeners for interactive graphics options
				document.querySelectorAll('.tab-graphics-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasInteractiveGraphics = this.checked;
						document.getElementById(`graphics-options-${index}`).classList.toggle('hidden', !this.checked);
						// Vérifier si on dépasse la limite après activation
						if (this.checked) {
							const activeCount = countActiveActivities(index);
							if (activeCount > state.tabs[index].maxActivities) {
								alert(`Attention : vous avez dépassé la limite de ${state.tabs[index].maxActivities} activité(s) pour cet onglet.\n\nLe prompt généré mentionnera cette limite, mais il est recommandé de désactiver certaines activités pour une meilleure expérience utilisateur.`);
							}
						}
						// Ajouter cette ligne pour mettre à jour le compteur
						updateActivitiesCounter(index);
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-geogebra-link').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].geogebraLink = this.value;
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-disable-scroll').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].disableScroll = this.checked;
						scheduleAutoSave();
					});
				});
				
				// Event listeners for tab quiz options
				document.querySelectorAll('.tab-quiz-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasQuiz = this.checked;
						document.getElementById(`quiz-options-${index}`).classList.toggle('hidden', !this.checked);
						// Vérifier si on dépasse la limite après activation
						if (this.checked) {
							const activeCount = countActiveActivities(index);
							if (activeCount > state.tabs[index].maxActivities) {
								alert(`Attention : vous avez dépassé la limite de ${state.tabs[index].maxActivities} activité(s) pour cet onglet.\n\nLe prompt généré mentionnera cette limite, mais il est recommandé de désactiver certaines activités pour une meilleure expérience utilisateur.`);
							}
						}
						// Ajouter cette ligne pour mettre à jour le compteur
						updateActivitiesCounter(index);
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-quiz-questions').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].quizQuestions = parseInt(this.value);
						scheduleAutoSave();
					});
				});
			
				// Event listeners for tab flashcards options
				document.querySelectorAll('.tab-flashcards-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasFlashcards = this.checked;
						document.getElementById(`flashcards-options-${index}`).classList.toggle('hidden', !this.checked);
						// Ajouter cette ligne pour mettre à jour le compteur
						updateActivitiesCounter(index);
						scheduleAutoSave();
					});
				});
			
				document.querySelectorAll('.tab-flashcards-count').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].flashcardsCount = parseInt(this.value);
						scheduleAutoSave();
					});
				});
			
			
				// Écouteurs pour les options du grapheur
				document.querySelectorAll('.tab-grapheur-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasGrapheur = this.checked;
						document.getElementById(`grapheur-options-${index}`).classList.toggle('hidden', !this.checked);
						// Vérifier si on dépasse la limite après activation
						if (this.checked) {
							const activeCount = countActiveActivities(index);
							if (activeCount > state.tabs[index].maxActivities) {
								alert(`Attention : vous avez dépassé la limite de ${state.tabs[index].maxActivities} activité(s) pour cet onglet.\n\nLe prompt généré mentionnera cette limite, mais il est recommandé de désactiver certaines activités pour une meilleure expérience utilisateur.`);
							}
						}
						// Ajouter cette ligne pour mettre à jour le compteur
						updateActivitiesCounter(index);						
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-grapheur-functions').forEach(textarea => {
					textarea.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].grapheurFunctions = this.value;
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-grapheur-editable').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].grapheurEditable = this.checked;
						scheduleAutoSave();
					});
				});
				
				// Écouteurs pour les options du tableau
				document.querySelectorAll('.tab-tableau-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasTableau = this.checked;
						document.getElementById(`tableau-options-${index}`).classList.toggle('hidden', !this.checked);
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-tableau-data').forEach(textarea => {
					textarea.addEventListener('input', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].tableauData = this.value;
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-tableau-regression').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].tableauRegression = this.checked;
						scheduleAutoSave();
					});
				});
			
			
				// Event listeners for tab matching activity options
				document.querySelectorAll('.tab-matching-checkbox').forEach(checkbox => {
					checkbox.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].hasMatchingActivity = this.checked;
						document.getElementById(`matching-options-${index}`).classList.toggle('hidden', !this.checked);
						// Ajouter cette ligne pour mettre à jour le compteur
						// Vérifier si on dépasse la limite après activation
						if (this.checked) {
							const activeCount = countActiveActivities(index);
							if (activeCount > state.tabs[index].maxActivities) {
								alert(`Attention : vous avez dépassé la limite de ${state.tabs[index].maxActivities} activité(s) pour cet onglet.\n\nLe prompt généré mentionnera cette limite, mais il est recommandé de désactiver certaines activités pour une meilleure expérience utilisateur.`);
							}
						}
						updateActivitiesCounter(index);
						scheduleAutoSave();
					});
				});
				
				document.querySelectorAll('.tab-matching-items').forEach(input => {
					input.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].matchingItems = parseInt(this.value);
						scheduleAutoSave();
					});
				});
				
				// Écouteur pour le nombre maximum d'activités
				document.querySelectorAll('.tab-max-activities').forEach(select => {
					select.addEventListener('change', function() {
						const index = parseInt(this.dataset.index);
						state.tabs[index].maxActivities = parseInt(this.value);
						scheduleAutoSave();
					});
				});
				
				// Add visual indicators for icon selection
				updateIconSelectorBehavior();
				
				
				// Initialisation des compteurs d'activités pour chaque onglet
					state.tabs.forEach((tab, index) => {
						updateActivitiesCounter(index);
					});
					updateTabsPreview();
					
			}
			





			// Fonction pour mettre à jour le compteur d'activités
			function updateActivitiesCounter(tabIndex) {
				const tab = state.tabs[tabIndex];
				const counterElement = document.getElementById(`activities-counter-${tabIndex}`);
				
				if (!counterElement) return;
				
				// Compter les activités activées
				let activeCount = 0;
				if (tab.hasQuiz) activeCount++;
				if (tab.hasFlashcards) activeCount++;
				if (tab.hasGrapheur) activeCount++;
				if (tab.hasTableau) activeCount++;
				if (tab.hasInteractiveGraphics) activeCount++;
				if (tab.hasMatchingActivity) activeCount++;
				if (tab.videos && tab.videos.trim() !== '') activeCount++; // Vidéo principale
				if (tab.hasSecondVideo && tab.secondVideoUrl && tab.secondVideoUrl.trim() !== '') activeCount++; // Seconde vidéo
				
				// Mettre à jour l'affichage
				counterElement.textContent = `${activeCount}/${tab.maxActivities}`;
				
				// Changer la couleur si la limite est dépassée
				if (activeCount > tab.maxActivities) {
					counterElement.style.color = '#f44336'; // Rouge
					counterElement.style.fontWeight = 'bold';
				} else {
					counterElement.style.color = '#4caf50'; // Vert
					counterElement.style.fontWeight = 'normal';
				}
			}

            // Update gradient style preview
            function updateGradientPreview() {
                const baseColor = state.gradientColor;
                
                // Calculer des variations de couleur pour le dégradé
                function hexToRgb(hex) {
                    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                    hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : null;
                }
                
                function rgbToHex(r, g, b) {
                    return "#" + ((1 << 24) + (Math.round(r) << 16) + (Math.round(g) << 8) + Math.round(b)).toString(16).slice(1);
                }
                
                const rgb = hexToRgb(baseColor);
                if (!rgb) return; // Protection contre les valeurs invalides
                
                // Darken: reduce each component by 30%
                const darkerRgb = {
                    r: Math.max(0, Math.floor(rgb.r * 0.7)),
                    g: Math.max(0, Math.floor(rgb.g * 0.7)),
                    b: Math.max(0, Math.floor(rgb.b * 0.7))
                };
                
                // Darker still: reduce each component by 50%
                const darkestRgb = {
                    r: Math.max(0, Math.floor(rgb.r * 0.5)),
                    g: Math.max(0, Math.floor(rgb.g * 0.5)),
                    b: Math.max(0, Math.floor(rgb.b * 0.5))
                };
                
                // Lighten: increase each component by 15% with max 255
                const lighterRgb = {
                    r: Math.min(255, Math.floor(rgb.r * 1.15)),
                    g: Math.min(255, Math.floor(rgb.g * 1.15)),
                    b: Math.min(255, Math.floor(rgb.b * 1.15))
                };
                
                const darkerHex = rgbToHex(darkerRgb.r, darkerRgb.g, darkerRgb.b);
                const darkestHex = rgbToHex(darkestRgb.r, darkestRgb.g, darkestRgb.b);
                const lighterHex = rgbToHex(lighterRgb.r, lighterRgb.g, lighterRgb.b);
                
                // Mettre à jour le preview de la couleur du gradient
                const preview = document.getElementById('gradient-color-preview');
                if (preview) {
                    preview.style.backgroundColor = baseColor;
                }
                
                // Appliquer à l'aperçu du gradient
                const gradientPreview = document.getElementById('preview-gradient');
                if (gradientPreview) {
                    gradientPreview.style.setProperty('--gradient-start', baseColor);
                    gradientPreview.style.setProperty('--gradient-end', darkerHex);
                    gradientPreview.style.setProperty('--gradient-dark', darkestHex);
                    gradientPreview.style.setProperty('--gradient-light', lighterHex);
                }
            }
            
            // Mettre à jour l'aperçu du style néo
            function updateNeoPreview() {
                const neoColor = state.neoColor;
                
                // Mettre à jour l'aperçu du style néo
                const neoPreview = document.getElementById('preview-neo');
                if (neoPreview) {
                    neoPreview.style.setProperty('--neo-color', neoColor);
                }
                
                // Actualiser l'option de couleur sélectionnée
                document.querySelectorAll('.neo-color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                const selectedOption = document.querySelector(`.neo-color-option.${state.neoColorOption}`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }


			// Mettre à jour l'aperçu du style sobre
			function updateSoberPreview() {
				const soberPreview = document.getElementById('preview-sober');
				if (soberPreview) {
					// Mettre à jour les couleurs dans le style inline
					soberPreview.querySelector('.style-preview-header').style.backgroundColor = state.soberColor;
					soberPreview.querySelector('.style-preview-tab.active').style.backgroundColor = state.soberColor;
					soberPreview.querySelector('.style-preview-tab.active').style.color = 'white';
					
					// Mettre à jour les autres onglets
					const inactiveTabs = soberPreview.querySelectorAll('.style-preview-tab:not(.active)');
					inactiveTabs.forEach(tab => {
						tab.style.backgroundColor = state.soberSecondaryColor;
						tab.style.color = '#333';
					});
				}
			}

            // Mise à jour du message d'information sur les onglets
            function updateStyleTabsInfo() {
                const infoMessage = document.getElementById('style-tabs-info');
                
                if (infoMessage) {
                    if (state.useTabColors && state.tabColorsCustomized) {
                        infoMessage.textContent = 'Les couleurs des onglets sont personnalisées individuellement.';
                        infoMessage.style.color = '#F57C00'; // Orange pour indiquer la personnalisation
                    } else {
                        infoMessage.textContent = 'Les couleurs des onglets sont synchronisées avec ce style.';
                        infoMessage.style.color = '#43A047'; // Vert pour indiquer la synchronisation
                    }
                }
            }
			
			// Fonction pour compter les activités actives d'un onglet
			function countActiveActivities(tabIndex) {
				const tab = state.tabs[tabIndex];
				let count = 0;
				
				// Compter chaque type d'activité
				if (tab.hasQuiz) count++;
				if (tab.hasFlashcards) count++;
				if (tab.hasGrapheur) count++;
				if (tab.hasTableau) count++;
				if (tab.hasInteractiveGraphics) count++;
				if (tab.hasMatchingActivity) count++;
				if (tab.videos && tab.videos.trim()) count++; // Vidéo principale
				if (tab.hasSecondVideo && tab.secondVideoUrl && tab.secondVideoUrl.trim()) count++; // Seconde vidéo
				
				return count;
			}
			
			// Fonction pour mettre à jour le compteur d'activités
			function updateActivitiesCounter(tabIndex) {
				const tab = state.tabs[tabIndex];
				const counterElement = document.getElementById(`activities-counter-${tabIndex}`);
				
				if (!counterElement) return;
				
				// Compter les activités activées
				const activeCount = countActiveActivities(tabIndex);
				
				// Mettre à jour l'affichage
				counterElement.textContent = `${activeCount}/${tab.maxActivities}`;
				
				// Changer la couleur si la limite est dépassée
				if (activeCount > tab.maxActivities) {
					counterElement.style.color = '#f44336'; // Rouge
					counterElement.style.fontWeight = 'bold';
				} else {
					counterElement.style.color = '#4caf50'; // Vert
					counterElement.style.fontWeight = 'normal';
				}
			}
			

            // Mise à jour de la fonction pour actualiser les previews de couleurs
            function updateColorPreview(inputId, previewId) {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                
                if (input && preview) {
                    preview.style.backgroundColor = input.value;
                }
            }

            // Fonction pour mettre à jour l'affichage des niveaux sélectionnés
			function updateSelectedLevelsDisplay() {
				const displayElement = document.getElementById('selected-levels-display');
				if (state.levels.length === 0) {
					displayElement.textContent = "Aucun niveau sélectionné";
					displayElement.style.color = "#f44336"; // Rouge pour indiquer un problème
				} else {
					// Il n'y aura qu'un seul niveau dans le tableau
					displayElement.textContent = "Niveau sélectionné: " + state.levels[0];
					displayElement.style.color = "var(--primary-dark)";
				}
			}

            // Update domain-specific options visibility
            function updateDomainOptions() {
                const mathOptions = document.getElementById('math-options');
                const scienceOptions = document.getElementById('science-options');
                const programmingOptions = document.getElementById('programming-options');
                const languageOptions = document.getElementById('language-options');
                
                // Reset all to hidden
                mathOptions.classList.add('hidden');
                scienceOptions.classList.add('hidden');
                programmingOptions.classList.add('hidden');
                languageOptions.classList.add('hidden');
                
                // Show the appropriate options based on subject
                if (state.subject === 'mathématiques') {
                    mathOptions.classList.remove('hidden');
                } else if (['sciences physiques', 'chimie'].includes(state.subject)) {
                    scienceOptions.classList.remove('hidden');
                } else if (state.subject === 'programmation python') {
                    programmingOptions.classList.remove('hidden');
                } else if (state.subject === 'langues') {
                    languageOptions.classList.remove('hidden');
                }
            }

            // Show/hide custom subject field
            function updateCustomSubjectField() {
                const container = document.getElementById('custom-subject-container');
                container.classList.toggle('hidden', state.subject !== 'autre');
            }

            // Function to update style previews visibility
			function updateStylePreviews() {
				document.getElementById('preview-sober').classList.add('hidden');
				document.getElementById('preview-color').classList.add('hidden');
				document.getElementById('preview-gradient').classList.add('hidden');
				document.getElementById('preview-neumorphic').classList.add('hidden');
				document.getElementById('preview-neo').classList.add('hidden');
				
				// Show selected style preview
				document.getElementById('preview-' + state.interfaceStyle).classList.remove('hidden');
				
				// Show/hide gradient options
				document.getElementById('gradient-options').classList.toggle('hidden', state.interfaceStyle !== 'gradient');
				
				// Show/hide neo options (NOUVEAU)
				document.getElementById('neo-options').classList.toggle('hidden', state.interfaceStyle !== 'neo');
				
				// Show/hide sober options (NOUVEAU)
				document.getElementById('sober-options').classList.toggle('hidden', state.interfaceStyle !== 'sober');

				// Mettre à jour le message sur la synchronisation des onglets
				updateStyleTabsInfo();
			}


			// Function to select a template
			function selectTemplate(templateId) {
				// Remove selected class from all templates
				document.querySelectorAll('.template-card').forEach(card => {
					card.classList.remove('selected');
				});
				
				// Add selected class to clicked template
				document.getElementById(templateId).classList.add('selected');
				
				// Update state
				state.selectedTemplate = templateId.replace('template-', '');
				
				// Si on ne choisit pas "none", réinitialiser les titres extraits
				if (state.selectedTemplate !== 'none') {
					state.extractedTabTitles = [];
				}
				
				// Regenerate tabs based on template
				initializeTabs();
				
				// For "revision" template, automatically enable flashcards in the "Auto-évaluation" tab
				if (state.selectedTemplate !== 'none') {
					// Activer automatiquement l'option Flashcards globale
					document.getElementById('use-flashcards').checked = true;
					state.useFlashcards = true;
					document.getElementById('flashcards-options').classList.remove('hidden');
				}
				// For "flipped" template, set the number of home tabs
				if (state.selectedTemplate === 'flipped') {
					state.flippedClassroomTabs = parseInt(document.getElementById('home-tabs-count').value);
				}    
				
				// Mise à jour du slider pour le nombre d'onglets
				if (state.selectedTemplate === 'none') {
					// Pour structure personnalisée, activer le slider
					const templateTabCount = document.getElementById('template-tab-count');
					const templateTabCountDisplay = document.getElementById('template-tab-count-display');
					if (templateTabCount && templateTabCountDisplay) {
						templateTabCount.value = state.tabCount;
						templateTabCountDisplay.textContent = state.tabCount;
						templateTabCount.disabled = false;
					}
				} else {
					// Pour les autres templates, désactiver le slider et mettre à jour sa valeur
					const templateTabCount = document.getElementById('template-tab-count');
					const templateTabCountDisplay = document.getElementById('template-tab-count-display');
					if (templateTabCount && templateTabCountDisplay) {
						templateTabCount.value = state.tabs.length;
						templateTabCountDisplay.textContent = state.tabs.length;
						templateTabCount.disabled = true;
					}
				}
				
				// Mise à jour de l'affichage à l'étape 4
				const tabsCountDisplay = document.getElementById('tabs-count-display');
				if (tabsCountDisplay) {
					tabsCountDisplay.textContent = state.tabs.length;
				}
				
				scheduleAutoSave();
			}			
						
			
			
            // Show preview panel
            function showPreview(content) {
                const previewPanel = document.getElementById('preview-panel');
                const previewContent = document.getElementById('preview-content');
                
                previewContent.innerHTML = content;
                previewPanel.classList.add('active');
            }

            // Hide preview panel
            function hidePreview() {
                const previewPanel = document.getElementById('preview-panel');
                previewPanel.classList.remove('active');
            }

            // Generate application preview
            function generatePreview() {
                // Générer la prévisualisation en fonction du style sélectionné
                const selectedStyle = state.interfaceStyle;
                let cssClass = '';
                let headerStyle = '';
                
                switch(selectedStyle) {
                    case 'sober':
                        cssClass = 'sober-theme';
                        headerStyle = `background-color: ${state.titleAreaColor};`;
                        break;
                    case 'color':
                        cssClass = 'color-theme';
                        headerStyle = 'background-color: #2196F3;';
                        break;
                    case 'gradient':
                        // Fonction pour obtenir une couleur plus sombre
                        function adjustColor(hex, factor) {
                            const r = parseInt(hex.slice(1, 3), 16);
                            const g = parseInt(hex.slice(3, 5), 16);
                            const b = parseInt(hex.slice(5, 7), 16);
                            
                            return '#' + 
                                Math.max(0, Math.min(255, Math.floor(r * factor))).toString(16).padStart(2, '0') +
                                Math.max(0, Math.min(255, Math.floor(g * factor))).toString(16).padStart(2, '0') +
                                Math.max(0, Math.min(255, Math.floor(b * factor))).toString(16).padStart(2, '0');
                        }
                        
                        cssClass = 'gradient-theme';
                        headerStyle = `background: linear-gradient(to right, ${state.gradientColor}, ${adjustColor(state.gradientColor, 0.7)});`;
                        break;
                    case 'neumorphic':
                        cssClass = 'neumorphic-theme';
                        headerStyle = 'background-color: #e0e0e0; box-shadow: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;';
                        break;
                    case 'neo':
                        cssClass = 'neo-theme';
                        headerStyle = `background-color: ${state.neoColor};`;
                        break;
                }
                
                // Générer les onglets
                let tabsHTML = '';
                state.tabs.forEach((tab, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const tabStyle = state.useTabColors ? `background-color: ${tab.color};` : '';
                    const icon = state.useTabIcons ? tab.icon : '';
                    
                    tabsHTML += `
                        <div class="app-tab ${isActive}" style="${tabStyle}">
                            ${icon} ${tab.title}
                        </div>
                    `;
                });
                
                // Créer le contenu de prévisualisation
                const previewHTML = `
                    <div class="app-preview ${cssClass}">
                        <div class="app-header" style="${headerStyle}">
                            ${state.useVersion ? `<div class="app-version" style="background-color: ${state.versionColor};">${state.versionNumber}</div>` : ''}
                            <div class="app-title">${state.subject === 'autre' ? state.customSubject : state.subject} - ${state.levels.join(', ')}</div>
                            ${state.useColoredBubbles ? `<div class="app-signature" style="background-color: ${state.signatureColor};">${state.signature}</div>` : ''}
                        </div>
                        
                        <div class="app-tabs-container">
                            ${tabsHTML}
                        </div>
                        
                        <div class="app-content">
                            <p><b>Aperçu</b> - Contenu de l'application basé sur vos options:</p>
                            <ul>
                                <li>Style: ${templates[state.selectedTemplate]?.name || 'Personnalisé'}</li>
                                <li>Onglets: ${state.tabs.length}</li>
                                ${state.useFlashcards ? '<li>Flashcards activées</li>' : ''}
                                ${state.useGamification ? '<li>Gamification activée</li>' : ''}
                                ${state.useAdaptiveAssessment ? '<li>Évaluation adaptative activée</li>' : ''}
                                ${state.includeQuiz ? '<li>Quiz général inclus</li>' : ''}
                                ${state.useCertificate ? '<li>Certificat inclus</li>' : ''}
                                ${state.certificateInLastTab ? '<li>Certificat intégré dans le dernier onglet</li>' : ''}
                                ${state.includeMultimedia ? '<li>Ressources multimédias intégrées</li>' : ''}
                            </ul>
                        </div>
                    </div>
                    
                    <style>
                        .app-preview {
                            font-family: 'Segoe UI', sans-serif;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                        }
                        
                        .app-header {
                            display: flex;
                            align-items: center;
                            padding: 12px 16px;
                            color: white;
                        }
                        
                        .app-version {
                            padding: 5px 10px;
                            border-radius: 50%;
                            font-size: 12px;
                            font-weight: bold;
                            margin-right: 10px;
                        }
                        
                        .app-title {
                            flex-grow: 1;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        
                        .app-signature {
                            padding: 5px 10px;
                            border-radius: 16px;
                            font-size: 12px;
                        }
                        
                        .app-tabs-container {
                            display: flex;
                            gap: 5px;
                            padding: 10px;
                            background-color: #f5f5f5;
                            overflow-x: auto;
                        }
                        
                        .app-tab {
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            white-space: nowrap;
                        }
                        
                        .app-tab.active {
                            font-weight: bold;
                        }
                        
                        .app-content {
                            padding: 16px;
                            background-color: white;
                            min-height: 200px;
                        }
                        
                        /* Neumorphic theme specific styles */
                        .neumorphic-theme .app-header {
                            color: #333;
                        }
                        
                        .neumorphic-theme .app-tab {
                            background-color: #e0e0e0;
                            box-shadow: 3px 3px 6px #bebebe, -3px -3px 6px #ffffff;
                            color: #333;
                        }
                        
                        .neumorphic-theme .app-tab.active {
                            box-shadow: inset 2px 2px 5px #bebebe, inset -2px -2px 5px #ffffff;
                        }
                        
                        .neumorphic-theme .app-content {
                            background-color: #e0e0e0;
                            box-shadow: inset 1px 1px 3px #bebebe, inset -1px -1px 3px #ffffff;
                            color: #333;
                        }
                        
                        /* Neo theme specific styles */
                        .neo-theme .app-tab {
                            background-color: white;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                            color: #333;
                            border: 2px solid ${state.neoColor};
                        }
                        
                        .neo-theme .app-tab.active {
                            background-color: ${state.neoColor};
                            color: white;
                        }
                    </style>
                `;
                
                showPreview(previewHTML);
            }

			
			// Fonction pour obtenir le code du grapheur avec balises neutralisées
			function getGrapheurCode() {
				// Le code du grapheur extrait de grapheur-simple.html avec les balises neutralisées
				return `## DÉBUT DU CODE GRAPHEUR ##
									
			
				##DOCTYPE html##
				##html lang="fr"##
				##head##
					##meta charset="UTF-8"##
					##meta name="viewport" content="width=device-width, initial-scale=1.0"##
					##title##Grapheur Mathématique Simplifié##/title##
					##script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"####/script##
					##script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"####/script##
					##style##
						* {
							box-sizing: border-box;
							margin: 0;
							padding: 0;
							font-family: Arial, sans-serif;
						}
						
						body {
							background-color: #f5f7fa;
							height: 100vh;
							display: flex;
							flex-direction: column;
						}
						
						.header {
							background-color: #3182ce;
							color: white;
							padding: 10px;
							text-align: center;
						}
						
						.main-container {
							display: flex;
							flex: 1;
							overflow: hidden;
						}
						
						.control-panel {
							width: 280px;
							background-color: white;
							padding: 10px;
							overflow-y: auto;
							box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
						}
						
						.section {
							margin-bottom: 15px;
						}
						
						.section-title {
							font-weight: bold;
							color: #4a5568;
							margin-bottom: 5px;
						}
						
						input[type="text"],
						input[type="number"],
						input[type="color"] {
							width: 100%;
							padding: 6px;
							border: 1px solid #cbd5e0;
							border-radius: 4px;
							margin-bottom: 5px;
						}
						
						label {
							font-size: 0.875rem;
							color: #4a5568;
						}
						
						.grid-2 {
							display: grid;
							grid-template-columns: 1fr 1fr;
							gap: 8px;
						}
						
						.function-item {
							margin-bottom: 10px;
							padding: 10px;
							background-color: #f8f9fa;
							border: 1px solid #e2e8f0;
							border-radius: 4px;
						}
						
						.function-row {
							display: flex;
							align-items: center;
							margin-bottom: 5px;
						}
						
						.function-color {
							width: 16px;
							height: 16px;
							border-radius: 50%;
							margin-right: 8px;
						}
						
						.function-name {
							font-weight: medium;
							margin-right: 8px;
						}
						
						.function-expr {
							flex: 1;
						}
						
						.graph-container {
							flex: 1;
							padding: 10px;
							display: flex;
							flex-direction: column;
							overflow: hidden;
						}
						
						.graph-title {
							font-size: 1.25rem;
							text-align: center;
							margin-bottom: 10px;
						}
						
						.chart-wrapper {
							flex: 1;
							background-color: white;
							border-radius: 8px;
							box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
							padding: 10px;
							position: relative;
							min-height: 300px;
						}
						
						canvas#graphCanvas {
							width: 100%;
							height: 100%;
						}
						
						/* Styles pour les points d'intersection */
						.intersections-container {
							margin-top: 10px;
							background-color: white;
							border-radius: 8px;
							box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
							padding: 10px;
						}
						
						.intersections-title {
							font-weight: bold;
							color: #4a5568;
							margin-bottom: 5px;
						}
						
						.intersections-list {
							list-style-type: none;
							padding-left: 0;
						}
						
						.intersections-list li {
							padding: 4px 0;
							border-bottom: 1px solid #edf2f7;
						}
						
						.intersections-list li:last-child {
							border-bottom: none;
						}
						
						.function-checkbox {
							margin-right: 5px;
						}
						
						.toggle-section {
							display: flex;
							justify-content: space-between;
							align-items: center;
							margin-top: 10px;
						}
						
						.precision-control {
							display: flex;
							align-items: center;
							margin-top: 5px;
						}
						
						.precision-control label {
							margin-right: 5px;
							flex-shrink: 0;
						}
						
						.precision-control input {
							width: 60px;
						}
					##/style##
				##/head##
				##body##
					##div class="header"##
						##h1##Grapheur Mathématique Simplifié##/h1##
					##/div##
					
					##div class="main-container"##
						<!-- Panneau de contrôle -->
						##div class="control-panel"##
							##div class="section"##
								##h3 class="section-title"##Personnalisation##/h3##
								##input type="text" id="graphTitle" placeholder="Titre du graphique" value="Graphique de Fonctions"##
								##div class="grid-2"##
									##input type="text" id="xAxisName" placeholder="Nom axe X" value="x"##
									##input type="text" id="yAxisName" placeholder="Nom axe Y" value="y"##
								##/div##
							##/div##
							
							##div class="section"##
								##h3 class="section-title"##Limites des axes##/h3##
								##div class="grid-2"##
									##div##
										##label##Xmin##/label##
										##input type="number" id="xMin" value="-10" step="1"##
									##/div##
									##div##
										##label##Xmax##/label##
										##input type="number" id="xMax" value="10" step="1"##
									##/div##
									##div##
										##label##Ymin##/label##
										##input type="number" id="yMin" value="-10" step="1"##
									##/div##
									##div##
										##label##Ymax##/label##
										##input type="number" id="yMax" value="10" step="1"##
									##/div##
								##/div##
							##/div##
							
							##div class="section"##
								##h3 class="section-title"##Fonctions##/h3##
								
								<!-- Fonction 1 -->
								##div class="function-item"##
									##div class="function-row"##
										##div class="function-color" id="color1" style="background-color: #FF5733;"####/div##
										##span class="function-name"##f(x) =##/span##
									##/div##
									##input type="text" id="function1" class="function-expr" value="x^2" placeholder="Saisir une expression"##
									##input type="color" id="color1Picker" value="#FF5733" style="width: 100%; margin-top: 5px;"##
									##div style="margin-top: 5px;"##
										##label##
											##input type="checkbox" id="active1" checked class="function-checkbox"##
											Activer cette fonction
										##/label##
									##/div##
								##/div##
								
								<!-- Fonction 2 -->
								##div class="function-item"##
									##div class="function-row"##
										##div class="function-color" id="color2" style="background-color: #33A8FF;"####/div##
										##span class="function-name"##g(x) =##/span##
									##/div##
									##input type="text" id="function2" class="function-expr" value="x" placeholder="Saisir une expression"##
									##input type="color" id="color2Picker" value="#33A8FF" style="width: 100%; margin-top: 5px;"##
									##div style="margin-top: 5px;"##
										##label##
											##input type="checkbox" id="active2" checked class="function-checkbox"##
											Activer cette fonction
										##/label##
									##/div##
								##/div##
							##/div##
							
							##div class="section"##
								##h3 class="section-title"##Points d'intersection##/h3##
								##div##
									##label##
										##input type="checkbox" id="showIntersections" checked##
										Afficher les intersections
									##/label##
								##/div##
								##div class="precision-control"##
									##label##Précision :##/label##
									##input type="number" id="precision" value="1000" min="100" max="10000" step="100"##
								##/div##
							##/div##
							
							##div class="section"##
								##button id="updateBtn" style="width: 100%; padding: 8px; background-color: #3182ce; color: white; border: none; border-radius: 4px; cursor: pointer;"##Mettre à jour le graphique##/button##
							##/div##
						##/div##
						
						<!-- Zone du graphique -->
						##div class="graph-container"##
							##h2 class="graph-title" id="chartTitle"##Graphique de Fonctions##/h2##
							##div class="chart-wrapper"##
								##canvas id="graphCanvas"####/canvas##
							##/div##
							
							<!-- Nouvelle section pour afficher les points d'intersection -->
							##div class="intersections-container" id="intersectionsContainer"##
								##h3 class="intersections-title"##Points d'intersection :##/h3##
								##ul class="intersections-list" id="intersectionsList"##
									<!-- Les points d'intersection seront ajoutés ici dynamiquement -->
								##/ul##
							##/div##
						##/div##
					##/div##
					
					##script##
						// Configuration initiale et variables globales
						let chart = null;
						let intersectionPoints = [];
						
						// Initialisation
						document.addEventListener('DOMContentLoaded', function() {
							// Listener pour le bouton d'update
							document.getElementById('updateBtn').addEventListener('click', updateGraph);
							
							// Listener pour les changements de couleur
							document.getElementById('color1Picker').addEventListener('input', function(e) {
								document.getElementById('color1').style.backgroundColor = e.target.value;
							});
							
							document.getElementById('color2Picker').addEventListener('input', function(e) {
								document.getElementById('color2').style.backgroundColor = e.target.value;
							});
							
							// Créer le graphique initial
							createChart();
						});
						
						// Création du graphique
						function createChart() {
							const ctx = document.getElementById('graphCanvas').getContext('2d');
							
							// Paramètres initiaux
							const xMin = parseFloat(document.getElementById('xMin').value);
							const xMax = parseFloat(document.getElementById('xMax').value);
							const yMin = parseFloat(document.getElementById('yMin').value);
							const yMax = parseFloat(document.getElementById('yMax').value);
							
							// Plugin personnalisé pour dessiner les axes avec graduations
							const customAxesPlugin = {
								id: 'customAxes',
								beforeDraw: (chart, args, options) => {
									const { ctx, chartArea, scales } = chart;
									const { top, bottom, left, right, width, height } = chartArea;
									const xScale = scales.x;
									const yScale = scales.y;
									
									// Configuration
									const axisColor = '#000000';
									const axisWidth = 2;
									const gridColor = '#aaaaaa';
									const textColor = '#4a5568';
									const textFont = '12px Arial';
									const xUnit = 1;
									const yUnit = 1;
									
									ctx.save();
									
									// Dessiner le quadrillage principal
									ctx.beginPath();
									ctx.lineWidth = 1;
									ctx.strokeStyle = gridColor;
									
									// Quadrillage vertical principal (lignes x)
									for (let x = Math.ceil(xScale.min / xUnit) * xUnit; x <= xScale.max; x += xUnit) {
										const xPos = xScale.getPixelForValue(x);
										ctx.moveTo(xPos, top);
										ctx.lineTo(xPos, bottom);
									}
									
									// Quadrillage horizontal principal (lignes y)
									for (let y = Math.ceil(yScale.min / yUnit) * yUnit; y <= yScale.max; y += yUnit) {
										const yPos = yScale.getPixelForValue(y);
										ctx.moveTo(left, yPos);
										ctx.lineTo(right, yPos);
									}
									
									ctx.stroke();
									
									// Calcul de la position des axes (où x=0 et y=0)
									const xZeroPixel = xScale.getPixelForValue(0);
									const yZeroPixel = yScale.getPixelForValue(0);
									
									// Position des axes dans la zone visible
									const xAxisY = Math.min(Math.max(yZeroPixel, top), bottom);
									const yAxisX = Math.min(Math.max(xZeroPixel, left), right);
									
									// Dessiner l'axe X
									ctx.beginPath();
									ctx.lineWidth = axisWidth;
									ctx.strokeStyle = axisColor;
									ctx.moveTo(left, xAxisY);
									ctx.lineTo(right, xAxisY);
									ctx.stroke();
									
									// Dessiner l'axe Y
									ctx.beginPath();
									ctx.moveTo(yAxisX, top);
									ctx.lineTo(yAxisX, bottom);
									ctx.stroke();
									
									// Obtenir les ticks d'unités principales
									const xTicks = [];
									for (let i = Math.ceil(xScale.min / xUnit) * xUnit; i <= xScale.max; i += xUnit) {
										xTicks.push(i);
									}
									
									const yTicks = [];
									for (let i = Math.ceil(yScale.min / yUnit) * yUnit; i <= yScale.max; i += yUnit) {
										yTicks.push(i);
									}
									
									// Dessiner les graduations pour l'axe X
									ctx.textAlign = 'center';
									ctx.textBaseline = 'top';
									ctx.font = textFont;
									ctx.fillStyle = textColor;
									
									for (const tick of xTicks) {
										const x = xScale.getPixelForValue(tick);
										
										// Ne pas dessiner l'étiquette à x=0 (origine)
										if (Math.abs(tick) < 1e-10) continue;
										
										// Tracer les traits de graduation
										ctx.beginPath();
										ctx.lineWidth = 1;
										ctx.moveTo(x, xAxisY - 5);
										ctx.lineTo(x, xAxisY + 5);
										ctx.stroke();
										
										// Placer le texte des graduations
										let labelY = xAxisY + 8;
										
										// Ajuster pour que les étiquettes restent visibles
										labelY = Math.min(Math.max(labelY, top + 4), bottom - 4);
										
										// Dessiner l'étiquette
										ctx.fillText(tick, x, labelY);
									}
									
									// Dessiner les graduations pour l'axe Y
									ctx.textAlign = 'right';
									ctx.textBaseline = 'middle';
									
									for (const tick of yTicks) {
										const y = yScale.getPixelForValue(tick);
										
										// Ne pas dessiner l'étiquette à y=0 (origine)
										if (Math.abs(tick) < 1e-10) continue;
										
										// Tracer les traits de graduation
										ctx.beginPath();
										ctx.lineWidth = 1;
										ctx.moveTo(yAxisX - 5, y);
										ctx.lineTo(yAxisX + 5, y);
										ctx.stroke();
										
										// Placer le texte des graduations
										let labelX = yAxisX - 8;
										
										// Ajuster pour que les étiquettes restent visibles
										labelX = Math.min(Math.max(labelX, left + 4), right - 4);
										
										// Dessiner l'étiquette
										ctx.fillText(tick, labelX, y);
									}
									
									ctx.restore();
								}
							};
							
							// Configuration du graphique
							chart = new Chart(ctx, {
								type: 'scatter',
								data: {
									datasets: []
								},
								options: {
									responsive: true,
									maintainAspectRatio: false,
									scales: {
										x: {
											type: 'linear',
											position: 'center',
											min: xMin,
											max: xMax,
											title: {
												display: false
											},
											grid: {
												display: false,
												drawOnChartArea: true
											},
											ticks: {
												display: false
											},
											border: {
												display: false
											}
										},
										y: {
											type: 'linear',
											position: 'center',
											min: yMin,
											max: yMax,
											title: {
												display: false
											},
											grid: {
												display: false,
												drawOnChartArea: true
											},
											ticks: {
												display: false
											},
											border: {
												display: false
											}
										}
									},
									plugins: {
										tooltip: {
											callbacks: {
												label: function(context) {
													return \`(\${context.parsed.x.toFixed(4)}, \${context.parsed.y.toFixed(4)})\`;
												}
											}
										},
										legend: {
											position: 'bottom'
										},
										customAxes: {
											enabled: true
										}
									}
								},
								plugins: [customAxesPlugin]
							});
							
							updateGraph();
						}
						
						// Mise à jour du graphique
						function updateGraph() {
							if (!chart) return;
							
							// Réinitialiser les points d'intersection
							intersectionPoints = [];
							
							// Récupérer les paramètres
							const xMin = parseFloat(document.getElementById('xMin').value);
							const xMax = parseFloat(document.getElementById('xMax').value);
							const yMin = parseFloat(document.getElementById('yMin').value);
							const yMax = parseFloat(document.getElementById('yMax').value);
							const title = document.getElementById('graphTitle').value;
							const func1 = document.getElementById('function1').value;
							const func2 = document.getElementById('function2').value;
							const color1 = document.getElementById('color1Picker').value;
							const color2 = document.getElementById('color2Picker').value;
							const active1 = document.getElementById('active1').checked;
							const active2 = document.getElementById('active2').checked;
							const showIntersections = document.getElementById('showIntersections').checked;
							const precision = parseInt(document.getElementById('precision').value) || 1000;
							
							// Mettre à jour le titre
							document.getElementById('chartTitle').textContent = title;
							
							// Mettre à jour les axes
							chart.options.scales.x.min = xMin;
							chart.options.scales.x.max = xMax;
							chart.options.scales.y.min = yMin;
							chart.options.scales.y.max = yMax;
							
							// Vider les datasets existants
							chart.data.datasets = [];
							
							let data1 = [];
							let data2 = [];
							
							// Générer les données pour la fonction 1
							if (func1 && active1) {
								try {
									data1 = generateFunctionData(func1, xMin, xMax, precision);
									chart.data.datasets.push({
										label: \`f(x) = \${func1}\`,
										data: data1,
										borderColor: color1,
										backgroundColor: color1,
										pointRadius: 0,
										borderWidth: 2,
										showLine: true,
										tension: 0
									});
								} catch (error) {
									console.error("Erreur avec la fonction 1:", error);
								}
							}
							
							// Générer les données pour la fonction 2
							if (func2 && active2) {
								try {
									data2 = generateFunctionData(func2, xMin, xMax, precision);
									chart.data.datasets.push({
										label: \`g(x) = \${func2}\`,
										data: data2,
										borderColor: color2,
										backgroundColor: color2,
										pointRadius: 0,
										borderWidth: 2,
										showLine: true,
										tension: 0
									});
								} catch (error) {
									console.error("Erreur avec la fonction 2:", error);
								}
							}
							
							// Calculer les points d'intersection si les deux fonctions sont actives
							if (active1 && active2 && func1 && func2 && showIntersections) {
								calculateIntersections(data1, data2, func1, func2);
								
								// Ajouter les points d'intersection au graphique
								if (intersectionPoints.length > 0) {
									chart.data.datasets.push({
										label: 'Intersections',
										data: intersectionPoints.map(point => ({ x: point.x, y: point.y })),
										borderColor: '#000000',
										backgroundColor: '#000000',
										pointRadius: 5,
										pointHoverRadius: 7,
										showLine: false
									});
								}
							}
							
							// Mettre à jour le graphique
							chart.update();
							
							// Mettre à jour la liste des points d'intersection
							updateIntersectionsList();
						}
						
						// Générer les données pour une fonction
						function generateFunctionData(expression, xMin, xMax, precision) {
							const data = [];
							const points = precision; // Nombre de points pour le tracé
							const step = (xMax - xMin) / points;
							
							for (let x = xMin; x <= xMax; x += step) {
								try {
									// Évaluer la fonction avec mathjs
									const scope = { x };
									const y = math.evaluate(expression, scope);
									
									if (!isNaN(y) && isFinite(y)) {
										data.push({ x, y });
									}
								} catch (e) {
									// Ignorer les erreurs d'évaluation
								}
							}
							
							return data;
						}
						
						// Calculer les points d'intersection entre deux courbes
						function calculateIntersections(data1, data2, func1Expr, func2Expr) {
							// Vider les points d'intersection précédents
							intersectionPoints = [];
							
							// Vérifier si les deux ensembles de données sont valides
							if (!Array.isArray(data1) || !Array.isArray(data2) || data1.length < 2 || data2.length < 2) {
								return;
							}
							
							// Trouver les intersections en vérifiant les changements de signe de la différence
							// entre les valeurs y des deux fonctions
							for (let i = 0; i < data1.length - 1; i++) {
								const x1 = data1[i].x;
								const y1 = data1[i].y;
								const x2 = data1[i + 1].x;
								const y2 = data1[i + 1].y;
								
								// Trouver les points correspondants dans data2
								// Chercher les points de data2 qui sont dans l'intervalle [x1, x2]
								for (let j = 0; j < data2.length - 1; j++) {
									const x3 = data2[j].x;
									const y3 = data2[j].y;
									const x4 = data2[j + 1].x;
									const y4 = data2[j + 1].y;
									
									// Vérifier si les segments [x1,x2] et [x3,x4] se chevauchent
									if (Math.max(x1, x3) <= Math.min(x2, x4)) {
										// Calculer les valeurs y des fonctions aux extrémités de l'intervalle commun
										const xStart = Math.max(x1, x3);
										const xEnd = Math.min(x2, x4);
										
										// Interpolation linéaire pour trouver y à xStart et xEnd pour les deux fonctions
										const y1Start = interpolate(x1, y1, x2, y2, xStart);
										const y1End = interpolate(x1, y1, x2, y2, xEnd);
										const y2Start = interpolate(x3, y3, x4, y4, xStart);
										const y2End = interpolate(x3, y3, x4, y4, xEnd);
										
										// Vérifier si les fonctions se croisent dans cet intervalle
										const diff1 = y1Start - y2Start;
										const diff2 = y1End - y2End;
										
										if (diff1 * diff2 <= 0 && diff1 !== diff2) {
											// Il y a une intersection dans l'intervalle [xStart, xEnd]
											// Utiliser la méthode de la racine binaire pour trouver le point exact
											const intersection = findIntersectionBinary(
												func1Expr, func2Expr, xStart, xEnd, 0.00001
											);
											
											if (intersection && isFinite(intersection.x) && isFinite(intersection.y)) {
												// Éviter les doublons en vérifiant si ce point est déjà enregistré
												const isDuplicate = intersectionPoints.some(point => 
													Math.abs(point.x - intersection.x) < 0.001
												);
												
												if (!isDuplicate) {
													intersectionPoints.push(intersection);
												}
											}
										}
									}
								}
							}
						}
						
						// Interpolation linéaire
						function interpolate(x1, y1, x2, y2, x) {
							if (x2 === x1) return y1; // Éviter la division par zéro
							const ratio = (x - x1) / (x2 - x1);
							return y1 + ratio * (y2 - y1);
						}
						
						// Méthode de la racine binaire pour trouver précisément le point d'intersection
						function findIntersectionBinary(expr1, expr2, xMin, xMax, tolerance) {
							let a = xMin;
							let b = xMax;
							
							// Fonction qui évalue la différence entre les deux expressions à un point x
							function evaluateDiff(x) {
								try {
									const y1 = math.evaluate(expr1, { x });
									const y2 = math.evaluate(expr2, { x });
									return y1 - y2;
								} catch (e) {
									return NaN;
								}
							}
							
							// Vérifier si les valeurs aux extrémités ont des signes opposés
							const diffA = evaluateDiff(a);
							const diffB = evaluateDiff(b);
							
							if (isNaN(diffA) || isNaN(diffB)) return null;
							if (diffA * diffB > 0) return null; // Pas d'intersection garantie dans l'intervalle
							
							// Recherche binaire
							let c;
							let diffC;
							
							for (let i = 0; i < 50; i++) { // Maximum 50 itérations
								c = (a + b) / 2;
								diffC = evaluateDiff(c);
								
								if (Math.abs(diffC) < tolerance || Math.abs(b - a) < tolerance) {
									// Intersection trouvée
									const y = math.evaluate(expr1, { x: c });
									return { x: c, y: y };
								}
								
								if (diffA * diffC < 0) {
									b = c;
								} else {
									a = c;
									diffA = diffC;
								}
							}
							
							// Si on arrive ici, on prend la meilleure approximation
							const y = math.evaluate(expr1, { x: c });
							return { x: c, y: y };
						}
						
						// Mettre à jour la liste des points d'intersection
						function updateIntersectionsList() {
							const intersectionsList = document.getElementById('intersectionsList');
							intersectionsList.innerHTML = '';
							
							if (intersectionPoints.length === 0) {
								const li = document.createElement('li');
								li.textContent = 'Aucune intersection trouvée.';
								intersectionsList.appendChild(li);
							} else {
								intersectionPoints.forEach((point, index) => {
									const li = document.createElement('li');
									li.textContent = \`Point \${index + 1}: (\${point.x.toFixed(4)}, \${point.y.toFixed(4)})\`;
									intersectionsList.appendChild(li);
								});
							}
						}
					##/script##
				##/body##
				##/html##
				## FIN DU CODE GRAPHEUR ##`;
			}
			
			// Fonction pour obtenir le code du tableau avec balises neutralisées
			function getTableauCode() {
				// Le code du tableau extrait de tableau-donnees-simplifie.html avec les balises neutralisées
				return `## DÉBUT DU CODE TABLEAU ##
				
				
				
			##DOCTYPE html##
			##html lang="fr"##
			##head##
				##meta charset="UTF-8"##
				##meta name="viewport" content="width=device-width, initial-scale=1.0"##
				##title##Tableau de Données Simplifié##/title##
				##script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"####/script##
				##script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"####/script##
				##script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"####/script##
				##style##
					* {
						box-sizing: border-box;
						margin: 0;
						padding: 0;
						font-family: Arial, sans-serif;
					}
					
					body {
						background-color: #f5f7fa;
						padding: 20px;
					}
					
					.container {
						max-width: 1000px;
						margin: 0 auto;
						background-color: white;
						border-radius: 8px;
						box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
						overflow: hidden;
					}
					
					.header {
						background-color: #3182ce;
						color: white;
						padding: 15px 20px;
						display: flex;
						justify-content: space-between;
						align-items: center;
					}
					
					.title {
						font-size: 1.25rem;
						font-weight: bold;
					}
					
					.main-content {
						display: flex;
						flex-direction: column;
						padding: 20px;
					}
					
					.section {
						margin-bottom: 20px;
					}
					
					.section-title {
						font-weight: bold;
						color: #4a5568;
						margin-bottom: 10px;
						display: flex;
						align-items: center;
					}
					
					.section-title svg {
						width: 16px;
						height: 16px;
						margin-right: 6px;
					}
					
					input[type="text"],
					input[type="number"],
					select {
						width: 100%;
						padding: 8px;
						border: 1px solid #cbd5e0;
						border-radius: 4px;
						margin-bottom: 8px;
					}
					
					label {
						font-size: 0.875rem;
						color: #4a5568;
						display: block;
						margin-bottom: 5px;
					}
					
					.grid-2 {
						display: grid;
						grid-template-columns: 1fr 1fr;
						gap: 10px;
						margin-bottom: 15px;
					}
					
					.checkbox-label {
						display: flex;
						align-items: center;
					}
					
					.checkbox-label input {
						margin-right: 6px;
					}
			
					/* CSV import styles */
					.csv-import {
						margin-bottom: 15px;
					}
					
					.file-input-container {
						position: relative;
						display: flex;
						align-items: center;
					}
					
					.file-input {
						opacity: 0;
						position: absolute;
						top: 0;
						left: 0;
						width: 100%;
						height: 100%;
						cursor: pointer;
					}
					
					.file-input-button {
						background-color: #edf2f7;
						border: 1px dashed #cbd5e0;
						border-radius: 4px;
						padding: 8px 12px;
						display: flex;
						align-items: center;
						justify-content: center;
						gap: 6px;
						color: #4a5568;
						width: 100%;
						font-size: 0.875rem;
					}
					
					.file-name {
						margin-left: 8px;
						font-size: 0.8rem;
						color: #4a5568;
						white-space: nowrap;
						overflow: hidden;
						text-overflow: ellipsis;
						max-width: 150px;
					}
					
					/* Buttons */
					.buttons {
						display: flex;
						gap: 10px;
						margin-bottom: 15px;
					}
					
					.button {
						background-color: #3182ce;
						color: white;
						border: none;
						border-radius: 4px;
						padding: 8px 12px;
						font-size: 0.875rem;
						cursor: pointer;
						display: flex;
						align-items: center;
						justify-content: center;
						gap: 5px;
					}
					
					.button:hover {
						background-color: #2c5282;
					}
					
					/* Data table */
					.data-table-container {
						margin-top: 15px;
						max-height: 300px;
						overflow-y: auto;
						border: 1px solid #e2e8f0;
						border-radius: 4px;
					}
					
					.data-table {
						width: 100%;
						border-collapse: collapse;
						font-size: 0.85rem;
					}
					
					.data-table th, .data-table td {
						border: 1px solid #e2e8f0;
						padding: 6px;
						text-align: center;
					}
					
					.data-table th {
						background-color: #f7fafc;
						font-weight: bold;
						color: #4a5568;
						position: sticky;
						top: 0;
						z-index: 1;
					}
					
					.data-table input {
						width: 100%;
						padding: 4px;
						border: 1px solid #e2e8f0;
						border-radius: 2px;
						text-align: center;
					}
					
					/* Chart */
					.chart-container {
						height: 400px;
						margin-top: 20px;
						background-color: white;
						border-radius: 8px;
						box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
						padding: 15px;
					}
					
					/* Notifications */
					.notification {
						background-color: #ebf8ff;
						border-left: 4px solid #4299e1;
						padding: 10px;
						margin-top: 10px;
						margin-bottom: 15px;
						border-radius: 0 4px 4px 0;
						font-size: 0.85rem;
						color: #2c5282;
						display: none;
					}
					
					.error-notification {
						background-color: #fff5f5;
						border-left-color: #f56565;
						color: #c53030;
					}
					
					.success-notification {
						background-color: #f0fff4;
						border-left-color: #48bb78;
						color: #2f855a;
					}
					
					/* Regression */
					.regression-info {
						margin-top: 15px;
						background-color: #faf5ff;
						border-left: 4px solid #805ad5;
						padding: 10px;
						border-radius: 0 4px 4px 0;
						font-size: 0.85rem;
					}
					
					.regression-equation {
						font-weight: bold;
						color: #553c9a;
						margin-bottom: 5px;
					}
					
					.regression-r2 {
						color: #6b46c1;
					}
					
					.regression-options {
						display: flex;
						flex-wrap: wrap;
						gap: 10px;
						margin-top: 15px;
					}
					
					.regression-option {
						flex: 1;
						min-width: calc(50% - 5px);
						background-color: #edf2f7;
						border: 1px solid #e2e8f0;
						border-radius: 4px;
						padding: 8px;
						font-size: 0.85rem;
						display: flex;
						align-items: center;
						cursor: pointer;
					}
					
					.regression-option:hover {
						background-color: #e2e8f0;
					}
					
					.regression-option input[type="radio"] {
						margin-right: 8px;
					}
				##/style##
			##/head##
			##body##
				##div class="container"##
					##div class="header"##
						##div class="title"##Tableau de Données##/div##
					##/div##
					
					##div class="main-content"##
						##div class="section"##
							##h3 class="section-title"##
								##svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"##
									##rect x="3" y="3" width="18" height="18" rx="2" ry="2"####/rect##
									##line x1="3" y1="9" x2="21" y2="9"####/line##
									##line x1="3" y1="15" x2="21" y2="15"####/line##
									##line x1="9" y1="3" x2="9" y2="21"####/line##
									##line x1="15" y1="3" x2="15" y2="21"####/line##
								##/svg##
								Tableau de données
							##/h3##
							
							<!-- Import CSV -->
							##div class="csv-import"##
								##label##Importer des données CSV :##/label##
								##div class="file-input-container"##
									##div class="file-input-button"##
										##svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"##
											##path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"####/path##
											##polyline points="17 8 12 3 7 8"####/polyline##
											##line x1="12" y1="3" x2="12" y2="15"####/line##
										##/svg##
										Choisir un fichier
									##/div##
									##input type="file" id="csvFileInput" accept=".csv" class="file-input"##
									##span id="fileName" class="file-name"####/span##
								##/div##
							##/div##
							
							<!-- Configuration du tableau -->
							##div class="grid-2"##
								##div##
									##label##Nombre de colonnes##/label##
									##select id="columnCount"##
										##option value="2"##2 colonnes##/option##
										##option value="3" selected##3 colonnes##/option##
									##/select##
								##/div##
								##div##
									##label##Nombre de lignes##/label##
									##input type="number" id="rowCount" value="5" min="2" max="50"##
								##/div##
							##/div##
							
							##div class="buttons"##
								##button class="button" id="initTableBtn"##
									##svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"##
										##rect x="3" y="3" width="18" height="18" rx="2" ry="2"####/rect##
										##line x1="3" y1="9" x2="21" y2="9"####/line##
									##/svg##
									Initialiser tableau
								##/button##
								##button class="button" id="plotDataBtn"##
									##svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"##
										##polyline points="23 6 13.5 15.5 8.5 10.5 1 18"####/polyline##
										##polyline points="17 6 23 6 23 12"####/polyline##
									##/svg##
									Tracer les données
								##/button##
							##/div##
							
							<!-- Option pour relier les points -->
							##div class="checkbox-row"##
								##label class="checkbox-label"##
									##input type="checkbox" id="connectPointsOption" checked##
									Relier les points
								##/label##
							##/div##
							
							<!-- Notification -->
							##div class="notification" id="dataNotification"####/div##
							
							<!-- Tableau de données -->
							##div class="data-table-container" id="dataTableContainer"##
								##table class="data-table" id="dataTable"##
									##thead##
										##tr id="dataTableHeader"##
											##th##X##/th##
											##th##Y1##/th##
											##th##Y2##/th##
										##/tr##
									##/thead##
									##tbody id="dataTableBody"##
										<!-- Les lignes du tableau seront ajoutées ici dynamiquement -->
									##/tbody##
								##/table##
							##/div##
							
							<!-- Graphique -->
							##div class="chart-container"##
								##canvas id="dataChart"####/canvas##
							##/div##
							
							<!-- Régression -->
							##div class="section"##
								##h3 class="section-title"##
									##svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"##
										##path d="M3 3v18h18"####/path##
										##path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"####/path##
									##/svg##
									Régression
								##/h3##
								
								##div class="grid-2"##
									##div##
										##label##Colonne Y pour la régression##/label##
										##select id="regressionColumn"##
											##option value="1"##Y1##/option##
											##option value="2"##Y2##/option##
										##/select##
									##/div##
								##/div##
								
								<!-- Options de regression -->
								##div class="regression-options"##
									##label class="regression-option"##
										##input type="radio" name="regression" value="linear" checked## Linéaire
									##/label##
									##label class="regression-option"##
										##input type="radio" name="regression" value="polynomial"## Polynomiale
									##/label##
									##label class="regression-option"##
										##input type="radio" name="regression" value="exponential"## Exponentielle
									##/label##
								##/div##
								
								<!-- Degré du polynôme -->
								##div id="polynomialDegreeContainer" style="display: none; margin-top: 10px;"##
									##label##Degré du polynôme :##/label##
									##input type="number" id="polynomialDegree" value="2" min="2" max="5" step="1"##
								##/div##
								
								##div class="buttons" style="margin-top: 15px;"##
									##button class="button" id="applyRegressionBtn"##
										##svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"##
											##line x1="22" y1="2" x2="11" y2="13"####/line##
											##polygon points="22 2 15 22 11 13 2 9 22 2"####/polygon##
										##/svg##
										Appliquer la régression
									##/button##
								##/div##
								
								<!-- Résultats de la régression -->
								##div class="regression-info" id="regressionInfo" style="display: none;"##
									##div class="regression-equation" id="regressionEquation"####/div##
									##div class="regression-r2" id="regressionR2"####/div##
								##/div##
							##/div##
						##/div##
					##/div##
				##/div##
			
				##script##
					// Variables globales
					let chart = null;
					let tableData = [];
					let datasetColors = ['#2E86C1', '#8E44AD', '#F39C12'];
					let regressionData = null;
					
					// Initialisation
					document.addEventListener('DOMContentLoaded', function() {
						// Listeners pour le tableau de données
						document.getElementById('csvFileInput').addEventListener('change', handleCSVFile);
						document.getElementById('initTableBtn').addEventListener('click', initializeDataTable);
						document.getElementById('plotDataBtn').addEventListener('click', plotDataFromTable);
						document.getElementById('columnCount').addEventListener('change', updateTableStructure);
						
						// Listeners pour la régression
						document.querySelectorAll('input[name="regression"]').forEach(radio => {
							radio.addEventListener('change', function() {
								if (this.value === 'polynomial') {
									document.getElementById('polynomialDegreeContainer').style.display = 'block';
								} else {
									document.getElementById('polynomialDegreeContainer').style.display = 'none';
								}
							});
						});
						
						document.getElementById('applyRegressionBtn').addEventListener('click', applyRegression);
						
						// Initialiser l'interface
						createChart();
						initializeDataTable();
					});
					
					// Créer le graphique
					function createChart() {
						const ctx = document.getElementById('dataChart').getContext('2d');
						
						chart = new Chart(ctx, {
							type: 'scatter',
							data: {
								datasets: []
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								scales: {
									x: {
										type: 'linear',
										position: 'bottom',
										title: {
											display: true,
											text: 'X'
										}
									},
									y: {
										type: 'linear',
										position: 'left',
										title: {
											display: true,
											text: 'Y'
										}
									}
								},
								plugins: {
									tooltip: {
										callbacks: {
											label: function(context) {
												return \`(\${context.parsed.x.toFixed(4)}, \${context.parsed.y.toFixed(4)})\`;
											}
										}
									},
									legend: {
										position: 'top'
									}
								}
							}
						});
					}
					
					// Gérer l'importation de fichier CSV
					function handleCSVFile(e) {
						try {
							const file = e.target.files[0];
							if (!file) return;
							
							// Mettre à jour le nom du fichier affiché
							const fileNameElement = document.getElementById('fileName');
							if (fileNameElement) {
								fileNameElement.textContent = file.name;
							}
							
							// Parser le fichier CSV
							Papa.parse(file, {
								header: false,
								dynamicTyping: true,
								skipEmptyLines: true,
								complete: function(results) {
									try {
										if (results.data && results.data.length > 0) {
											// Vérifier si on a au moins une colonne (X) et une ligne
											if (!Array.isArray(results.data[0]) || results.data[0].length < 2) {
												showNotification("Le fichier CSV doit avoir au moins 2 colonnes (X et Y).", "error");
												return;
											}
											
											// Limiter à 3 colonnes maximum
											const maxCols = Math.min(results.data[0].length, 3);
											
											// Mettre à jour le sélecteur de colonnes
											const columnCountElement = document.getElementById('columnCount');
											if (columnCountElement) {
												columnCountElement.value = maxCols;
											}
											
											// Initialiser le tableau avec les données
											tableData = results.data.map(row => {
												if (!Array.isArray(row)) return [0, 0, 0].slice(0, maxCols);
												
												return row.slice(0, maxCols).map(value => {
													return isNaN(value) ? 0 : value;
												});
											});
											
											// Nettoyer les données invalides
											tableData = tableData.filter(row => 
												Array.isArray(row) && row.length === maxCols
											);
											
											// Limiter à 100 lignes pour éviter les problèmes de performance
											if (tableData.length > 100) {
												tableData = tableData.slice(0, 100);
												showNotification("Trop de données, limité aux 100 premières lignes.", "info");
											}
											
											// Mettre à jour l'interface
											updateTableHeader(maxCols);
											renderDataTable();
											
											showNotification(\`CSV importé avec succès : \${tableData.length} lignes, \${maxCols} colonnes.\`, "success");
										} else {
											showNotification("Le fichier CSV ne contient pas de données valides.", "error");
										}
									} catch (err) {
										console.error("Erreur lors du traitement des données CSV:", err);
										showNotification("Erreur lors de l'analyse des données CSV.", "error");
									}
								},
								error: function(error) {
									showNotification(\`Erreur lors de l'analyse du CSV: \${error.message}\`, "error");
								}
							});
						} catch (err) {
							console.error("Erreur lors de l'importation du CSV:", err);
							showNotification("Erreur lors de l'importation du CSV.", "error");
						}
					}
					
					// Initialisation du tableau de données
					function initializeDataTable() {
						try {
							const columns = parseInt(document.getElementById('columnCount').value) || 3;
							const rows = parseInt(document.getElementById('rowCount').value) || 5;
							
							// Limiter le nombre de lignes et de colonnes
							const actualRows = Math.min(Math.max(rows, 2), 50);
							const actualColumns = Math.min(Math.max(columns, 2), 3);
							
							// Initialiser les données du tableau
							tableData = [];
							for (let i = 0; i < actualRows; i++) {
								const row = [];
								for (let j = 0; j < actualColumns; j++) {
									row.push(0);
								}
								tableData.push(row);
							}
							
							// Mettre à jour l'interface
							updateTableHeader(actualColumns);
							renderDataTable();
							showNotification(\`Tableau initialisé avec \${actualRows} lignes et \${actualColumns} colonnes.\`, "success");
						} catch (err) {
							console.error("Erreur lors de l'initialisation du tableau:", err);
							showNotification("Erreur lors de l'initialisation du tableau. Veuillez réessayer.", "error");
						}
					}
					
					// Suite du code pour le tableau (mise à jour de structure, rendu, etc.)
					// Mise à jour de la structure du tableau
					function updateTableStructure() {
						try {
							const columns = parseInt(document.getElementById('columnCount').value) || 3;
							const actualColumns = Math.min(Math.max(columns, 2), 3);
							
							// Mettre à jour les en-têtes
							updateTableHeader(actualColumns);
							
							// Vérifier que tableData est défini
							if (!Array.isArray(tableData)) {
								tableData = [];
							}
							
							// Mettre à jour les données des lignes
							tableData.forEach(row => {
								if (!Array.isArray(row)) return;
								
								while (row.length > actualColumns) {
									row.pop();
								}
								while (row.length < actualColumns) {
									row.push(0);
								}
							});
							
							// Mettre à jour le tableau
							renderDataTable();
							
							// Mettre à jour le sélecteur de colonnes pour la régression
							const regressionSelect = document.getElementById('regressionColumn');
							if (regressionSelect) {
								regressionSelect.innerHTML = '';
								for (let i = 1; i < actualColumns; i++) {
									const option = document.createElement('option');
									option.value = i;
									option.textContent = \`Y\${i}\`;
									regressionSelect.appendChild(option);
								}
							}
						} catch (err) {
							console.error("Erreur lors de la mise à jour de la structure du tableau:", err);
							showNotification("Erreur lors de la mise à jour du tableau.", "error");
						}
					}
					
					// Mettre à jour l'en-tête du tableau
					function updateTableHeader(columns) {
						const header = document.getElementById('dataTableHeader');
						header.innerHTML = '';
						
						// Ajouter l'en-tête X
						const xHeader = document.createElement('th');
						xHeader.textContent = 'X';
						header.appendChild(xHeader);
						
						// Ajouter les en-têtes Y
						for (let i = 1; i < columns; i++) {
							const th = document.createElement('th');
							th.textContent = \`Y\${i}\`;
							header.appendChild(th);
						}
					}
				##/script##
			##/body##
			##/html##
			## FIN DU CODE TABLEAU ##`;
			}
			
			
	
			
            // DEBUT Function to generate prompt			
			
			
			// Function to generate prompt
			function generatePrompt() {
				// Section 1: INFORMATIONS DE BASE ET OBJECTIFS (Priorité haute)
				// ========================================================
				// Formater les niveaux sélectionnés pour le prompt
				const levelsText = state.levels.length > 1 
					? `les niveaux ${state.levels.join(' et ')}` 
					: `le niveau ${state.levels[0]}`;
				
				// Initialisation du prompt avec les informations fondamentales
				let prompt = `#1 Section 1 INFORMATIONS DE BASE ET OBJECTIFS (Priorité haute) : Créez une application pédagogique HTML interactive sur le sujet de ${state.subject === 'autre' ? state.customSubject : state.subject} pour ${levelsText} avec les objectifs suivants: ${state.objectives}.\n\n`;
				
				// Ajouter la présentation générale si disponible
				if (state.extractedPresentation && state.extractedPresentation.content) {
					// Ajouter une section pour la présentation extraite
					prompt += "## Présentation générale\n";
			
					// Si un titre de présentation a été fourni, l'inclure
					if (state.extractedPresentation.title && state.extractedPresentation.title.trim() !== '') {
						prompt += `**${state.extractedPresentation.title}**\n\n`;
					}
					
					// Ajouter le contenu de la présentation
					prompt += `${state.extractedPresentation.content}\n\n`;
					
					// Séparer clairement cette section de la suite
					prompt += "---\n\n";
				}
			
				// Section 2: STRUCTURE PÉDAGOGIQUE (Priorité haute)
				// ===============================================
				// Add template info if used
				if (state.selectedTemplate !== 'none') {
					prompt += "#2 Section 2: STRUCTURE PÉDAGOGIQUE  Priorité haute:\n";
					if (state.selectedTemplate === 'progressive') {
						prompt += "- Modèle \"Cours structuré\" (Introduction → Concept n°1 → Concept n°2 → Application → Révisions → Évaluation) et certification)\n";
					} else if (state.selectedTemplate === 'problem') {
						prompt += "- Modèle \"Apprentissage par problème\" (Problème → Outils → Exploration → Solution → Réflexion)\n";
					} else if (state.selectedTemplate === 'revision') {
						prompt += "- Modèle \"Révision efficace\" (Rappel → Exercice → Auto-évaluation → Renforcement)\n";
					}
				}
			
				// Section 3: INTÉGRATION SCORM (Priorité très haute si activée)
				// =========================================================
				// Add SCORM integration if enabled
				if (state.useScorm) {
					prompt += "\n\n# #3 Section 3: INTÉGRATION SCORM POUR LMS (PRIORITÉ TRÈS HAUTE)  :\n";
					prompt += `- Version SCORM: ${state.scormVersion}\n`;
					prompt += "- Données transmises au LMS:\n";
					prompt += `
			INTÉGRATION SCORM PRIORITAIRE
			
			L'application générée doit suivre ces principes pour la transmission SCORM:
			
			1. Chaque activité interactive (quiz, flashcards, exercices) doit:
			   - Calculer et stocker un score
			   - Déterminer et enregistrer un état de complétion
			   - Contribuer au score global
			
			2. La fonction updateScoreAndStatus() doit être appelée:
			   - Après chaque activité terminée
			   - À la fin de chaque onglet
			   - Lorsque le certificat est affiché
			
			3. Structure des variables:
			   - scoreTotal: somme des points obtenus
			   - scoreMax: somme des points possibles
			   - activityStates: tableau d'objets contenant l'état de chaque activité
			   - completedActivities: nombre d'activités terminées
			
			4. Interactions avec les fonctions SCORM:
			   - saveSCORMData(): appelée lors des transitions et changements d'état
			   - endSCORM(): appelée lorsque l'utilisateur termine le parcours`;
			
					
					
					if (state.scormOptions.transmitScore) {
						prompt += `  * Score total (seuil de réussite: ${state.scormOptions.passingScore}%)\n`;
					}
					
					if (state.scormOptions.transmitCompletion) {
						prompt += `  * Statut de complétion (critère: ${state.scormOptions.completionCriteria === 'all-activities' ? 'toutes activités terminées' : 
							state.scormOptions.completionCriteria === 'passing-score' ? 'score minimum atteint' : 'les deux conditions'})\n`;
					}
					
					if (state.scormOptions.transmitTime) {
						prompt += "  * Temps de session\n";
					}
					
					if (state.scormOptions.transmitDetailedScores) {
						prompt += "  * Scores détaillés par activité\n";
					}
					
					if (state.scormOptions.maxAttempts > 0) {
						prompt += `  * Limitation à ${state.scormOptions.maxAttempts} tentative(s)\n`;
					}
					
					if (state.scormOptions.autoSave) {
						prompt += "  * Enregistrement automatique des progrès\n";
					}
					
					if (state.scormOptions.suspendData) {
						prompt += "  * Conservation de l'état entre sessions\n";
					}
					
					// Add code examples based on SCORM version
					prompt += "\n## Code d'initialisation SCORM à intégrer dans l'application:\n";
					
					if (state.scormVersion === '1.2') {
						prompt += `
			\`\`\`javascript
			// Initialisation SCORM 1.2
			let API = null;
			let initialized = false;
			
			// Fonction pour trouver l'API SCORM dans la hiérarchie des fenêtres
			function findAPI(win) {
				if (win.API != null) {
					return win.API;
				} else if (win.parent == win) {
					return null;
				} else {
					return findAPI(win.parent);
				}
			}
			
			// Initialiser la connexion SCORM
			function initSCORM() {
				try {
					API = findAPI(window);
					
					if (API) {
						const result = API.LMSInitialize("");
						if (result === "true" || result === true) {
							initialized = true;
							console.log("SCORM 1.2 initialisé avec succès");
							
							// Récupérer les données suspendues si disponibles
							if (${state.scormOptions.suspendData}) {
								const suspendData = API.LMSGetValue("cmi.suspend_data");
								if (suspendData && suspendData !== "") {
									loadSuspendedData(suspendData);
								}
							}
							
							// Définir le statut initial
							API.LMSSetValue("cmi.core.lesson_status", "incomplete");
							
							// Démarrer le chronomètre de session
							sessionStartTime = new Date();
							
							// Configurer l'enregistrement automatique
							if (${state.scormOptions.autoSave}) {
								setInterval(saveSCORMData, 30000); // Toutes les 30 secondes
							}
							
							// Configurer l'enregistrement à la fermeture
							window.addEventListener("beforeunload", function() {
								saveSCORMData();
							});
							
							return true;
						} else {
							console.error("Échec de l'initialisation SCORM: " + API.LMSGetLastError());
						}
					} else {
						console.error("API SCORM introuvable");
					}
				} catch (e) {
					console.error("Erreur lors de l'initialisation SCORM: " + e.message);
				}
				
				return false;
			}
			
			// Enregistrer les données SCORM
			function saveSCORMData() {
				if (!initialized || !API) return false;
				
				try {
					// Mettre à jour le temps de session
					if (${state.scormOptions.transmitTime}) {
						const sessionTime = calculateSessionTime();
						API.LMSSetValue("cmi.core.session_time", sessionTime);
					}
					
					// Enregistrer les données suspendues
					if (${state.scormOptions.suspendData}) {
						const suspendData = generateSuspendData();
						API.LMSSetValue("cmi.suspend_data", suspendData);
					}
					
					// Enregistrer les modifications
					API.LMSCommit("");
					return true;
				} catch (e) {
					console.error("Erreur lors de l'enregistrement des données SCORM: " + e.message);
					return false;
				}
			}
			
			// Mettre à jour le score et le statut de complétion
			function updateScoreAndStatus(score, maxScore, completed) {
				if (!initialized || !API) return false;
				
				try {
					// Calculer le pourcentage
					const percentage = Math.round((score / maxScore) * 100);
					
					// Mettre à jour le score
					if (${state.scormOptions.transmitScore}) {
						API.LMSSetValue("cmi.core.score.raw", percentage);
						API.LMSSetValue("cmi.core.score.min", "0");
						API.LMSSetValue("cmi.core.score.max", "100");
					}
					
					// Mettre à jour le statut de complétion
					if (${state.scormOptions.transmitCompletion}) {
						let status = "incomplete";
						
						// Définir le statut selon les critères configurés
						if ("${state.scormOptions.completionCriteria}" === "passing-score") {
							status = percentage >= ${state.scormOptions.passingScore} ? "passed" : "failed";
						} else if ("${state.scormOptions.completionCriteria}" === "all-activities") {
							status = completed ? "completed" : "incomplete";
						} else { // both
							if (completed) {
								status = percentage >= ${state.scormOptions.passingScore} ? "passed" : "failed";
							} else {
								status = "incomplete";
							}
						}
						
						API.LMSSetValue("cmi.core.lesson_status", status);
					}
					
					// Enregistrer les modifications
					saveSCORMData();
					return true;
				} catch (e) {
					console.error("Erreur lors de la mise à jour du score SCORM: " + e.message);
					return false;
				}
			}
			
			// Terminer la session SCORM
			function endSCORM() {
				if (!initialized || !API) return false;
				
				try {
					// Enregistrer une dernière fois
					saveSCORMData();
					
					// Terminer la session
					API.LMSFinish("");
					initialized = false;
					return true;
				} catch (e) {
					console.error("Erreur lors de la fin de session SCORM: " + e.message);
					return false;
				}
			}
			
			// Calculer le temps de session au format HH:MM:SS
			function calculateSessionTime() {
				const now = new Date();
				const diff = now - sessionStartTime; // en millisecondes
				
				const hours = Math.floor(diff / 3600000);
				const minutes = Math.floor((diff % 3600000) / 60000);
				const seconds = Math.floor((diff % 60000) / 1000);
				
				return hours.toString().padStart(2, '0') + ":" + 
					   minutes.toString().padStart(2, '0') + ":" + 
					   seconds.toString().padStart(2, '0');
			}
			
			// Générer les données à suspendre (état de l'application)
			function generateSuspendData() {
				// Exemple : sauvegarder l'état des activités et les scores au format JSON
				const appState = {
					currentTab: currentTabIndex,
					activities: activityStates,
					scores: activityScores,
					completedActivities: completedActivities
				};
				
				return JSON.stringify(appState);
			}
			
			// Charger les données suspendues
			function loadSuspendedData(data) {
				try {
					const appState = JSON.parse(data);
					
					// Restaurer l'état de l'application
					if (appState) {
						currentTabIndex = appState.currentTab || 0;
						activityStates = appState.activities || [];
						activityScores = appState.scores || [];
						completedActivities = appState.completedActivities || [];
					}
				} catch (e) {
					console.error("Erreur lors du chargement des données suspendues: " + e.message);
				}
			}
			
			// Initialiser SCORM au chargement de la page
			let sessionStartTime;
			document.addEventListener('DOMContentLoaded', initSCORM);
			\`\`\`
			`;
					} else {
						// SCORM 2004
						prompt += `
			\`\`\`javascript
			// Initialisation SCORM 2004
			let API_1484_11 = null;
			let initialized = false;
			
			// Fonction pour trouver l'API SCORM dans la hiérarchie des fenêtres
			function findAPI(win) {
				if (win.API_1484_11 != null) {
					return win.API_1484_11;
				} else if (win.parent == win) {
					return null;
				} else {
					return findAPI(win.parent);
				}
			}
			
			// Initialiser la connexion SCORM
			function initSCORM() {
				try {
					API_1484_11 = findAPI(window);
					
					if (API_1484_11) {
						const result = API_1484_11.Initialize("");
						if (result === "true" || result === true) {
							initialized = true;
							console.log("SCORM 2004 initialisé avec succès");
							
							// Récupérer les données suspendues si disponibles
							if (${state.scormOptions.suspendData}) {
								const suspendData = API_1484_11.GetValue("cmi.suspend_data");
								if (suspendData && suspendData !== "") {
									loadSuspendedData(suspendData);
								}
							}
							
							// Définir le statut initial
							API_1484_11.SetValue("cmi.completion_status", "incomplete");
							API_1484_11.SetValue("cmi.success_status", "unknown");
							API_1484_11.SetValue("cmi.exit", "suspend");
							
							// Démarrer le chronomètre de session
							sessionStartTime = new Date();
							
							// Configurer l'enregistrement automatique
							if (${state.scormOptions.autoSave}) {
								setInterval(saveSCORMData, 30000); // Toutes les 30 secondes
							}
							
							// Configurer l'enregistrement à la fermeture
							window.addEventListener("beforeunload", function() {
								saveSCORMData();
								API_1484_11.SetValue("cmi.exit", "suspend");
								API_1484_11.Terminate("");
							});
							
							return true;
						} else {
							console.error("Échec de l'initialisation SCORM: " + API_1484_11.GetLastError());
						}
					} else {
						console.error("API SCORM introuvable");
					}
				} catch (e) {
					console.error("Erreur lors de l'initialisation SCORM: " + e.message);
				}
				
				return false;
			}
			
			// Enregistrer les données SCORM
			function saveSCORMData() {
				if (!initialized || !API_1484_11) return false;
				
				try {
					// Mettre à jour le temps de session
					if (${state.scormOptions.transmitTime}) {
						const sessionTime = calculateSessionTime();
						API_1484_11.SetValue("cmi.session_time", sessionTime);
					}
					
					// Enregistrer les données suspendues
					if (${state.scormOptions.suspendData}) {
						const suspendData = generateSuspendData();
						API_1484_11.SetValue("cmi.suspend_data", suspendData);
					}
					
					// Enregistrer les modifications
					API_1484_11.Commit("");
					return true;
				} catch (e) {
					console.error("Erreur lors de l'enregistrement des données SCORM: " + e.message);
					return false;
				}
			}
			
			// Mettre à jour le score et le statut de complétion
			function updateScoreAndStatus(score, maxScore, completed) {
				if (!initialized || !API_1484_11) return false;
				
				try {
					// Calculer le pourcentage
					const percentage = Math.round((score / maxScore) * 100);
					const scaledScore = percentage / 100; // SCORM 2004 utilise des scores normalisés (0-1)
					
					// Mettre à jour le score
					if (${state.scormOptions.transmitScore}) {
						API_1484_11.SetValue("cmi.score.raw", percentage);
						API_1484_11.SetValue("cmi.score.min", "0");
						API_1484_11.SetValue("cmi.score.max", "100");
						API_1484_11.SetValue("cmi.score.scaled", scaledScore.toString());
					}
					
					// Mettre à jour le statut de complétion
					if (${state.scormOptions.transmitCompletion}) {
						// Statut de complétion
						if (completed) {
							API_1484_11.SetValue("cmi.completion_status", "completed");
						} else {
							API_1484_11.SetValue("cmi.completion_status", "incomplete");
						}
						
						// Statut de réussite selon le score
						const passingScoreDecimal = ${state.scormOptions.passingScore} / 100;
						
						// Définir le statut selon les critères configurés
						if ("${state.scormOptions.completionCriteria}" === "passing-score") {
							API_1484_11.SetValue("cmi.success_status", scaledScore >= passingScoreDecimal ? "passed" : "failed");
						} else if ("${state.scormOptions.completionCriteria}" === "all-activities") {
							API_1484_11.SetValue("cmi.success_status", completed ? "passed" : "unknown");
						} else { // both
							if (completed) {
								API_1484_11.SetValue("cmi.success_status", scaledScore >= passingScoreDecimal ? "passed" : "failed");
							} else {
								API_1484_11.SetValue("cmi.success_status", "unknown");
							}
						}
					}
					
					// Enregistrer les modifications
					saveSCORMData();
					return true;
				} catch (e) {
					console.error("Erreur lors de la mise à jour du score SCORM: " + e.message);
					return false;
				}
			}
			
			// Terminer la session SCORM
			function endSCORM() {
				if (!initialized || !API_1484_11) return false;
				
				try {
					// Enregistrer une dernière fois
					saveSCORMData();
					
					// Terminer la session
					API_1484_11.Terminate("");
					initialized = false;
					return true;
				} catch (e) {
					console.error("Erreur lors de la fin de session SCORM: " + e.message);
					return false;
				}
			}
			
			// Calculer le temps de session au format ISO 8601 pour SCORM 2004
			function calculateSessionTime() {
				const now = new Date();
				const diff = now - sessionStartTime; // en millisecondes
				
				const hours = Math.floor(diff / 3600000);
				const minutes = Math.floor((diff % 3600000) / 60000);
				const seconds = Math.floor((diff % 60000) / 1000);
				const milliseconds = diff % 1000;
				
				return "PT" + hours + "H" + minutes + "M" + seconds + "." + milliseconds + "S";
			}
			
			// Générer les données à suspendre (état de l'application)
			function generateSuspendData() {
				// Exemple : sauvegarder l'état des activités et les scores au format JSON
				const appState = {
					currentTab: currentTabIndex,
					activities: activityStates,
					scores: activityScores,
					completedActivities: completedActivities
				};
				
				return JSON.stringify(appState);
			}
			
			// Charger les données suspendues
			function loadSuspendedData(data) {
				try {
					const appState = JSON.parse(data);
					
					// Restaurer l'état de l'application
					if (appState) {
						currentTabIndex = appState.currentTab || 0;
						activityStates = appState.activities || [];
						activityScores = appState.scores || [];
						completedActivities = appState.completedActivities || [];
					}
				} catch (e) {
					console.error("Erreur lors du chargement des données suspendues: " + e.message);
				}
			}
			
			// Initialiser SCORM au chargement de la page
			let sessionStartTime;
			document.addEventListener('DOMContentLoaded', initSCORM);
			\`\`\`
			`;
					}
					
					// Add implementation instructions
					prompt += `
			## Comment implémenter SCORM dans l'application:
			
			1. Inclure le code d'initialisation ci-dessus dans le fichier principal de l'application
			2. Intégrer les appels aux fonctions SCORM aux endroits appropriés:
			
			   a. Mettre à jour le score après chaque activité:
			   \`\`\`javascript
			   // Après une activité (quiz, flashcards, etc.)
			   // scoreTotal: score cumulé de toutes les activités
			   // scoreMax: score maximum possible
			   // allCompleted: true si toutes les activités requises sont terminées
			   updateScoreAndStatus(scoreTotal, scoreMax, allCompleted);
			   \`\`\`
			
			   b. Sauvegarder l'état lors des transitions importantes:
			   \`\`\`javascript
			   // Lors d'un changement d'onglet, après avoir terminé une activité, etc.
			   saveSCORMData();
			   \`\`\`
			
			   c. Terminer la session à la fin du parcours:
			   \`\`\`javascript
			   // Lorsque l'utilisateur a terminé toutes les activités
			   // et visualisé le certificat de réussite
			   endSCORM();
			   \`\`\`
			
			3. Implémenter les fonctions nécessaires pour suivre:
			   - L'état de complétion de chaque activité
			   - Les scores obtenus
			   - Le temps passé sur l'application
			
			4. Pour le packaging SCORM, créer un fichier imsmanifest.xml contenant:
			   - Les métadonnées du cours
			   - Les ressources requises
			   - Les règles de séquencement
			   
			   L'application HTML doit être compressée avec ce fichier manifest dans un fichier zip selon les normes SCORM.
			`;
				}
			
				// Section 4: FONCTIONNALITÉS PÉDAGOGIQUES (Priorité haute)
				// ====================================================
				// Add flashcards if enabled
				if (state.useFlashcards) {
					prompt += "\n Section 4: FONCTIONNALITÉS PÉDAGOGIQUES (Priorité haute) Intégration de FlashCards pour les révisions:\n";
					prompt += "\nImportant ! L'avant-dernier onglet doit impérativement comporter des FlashCards:\n";
					
					prompt += "- Interface des cartes:\n";
					prompt += "  - Design recto-verso: Chaque carte a un recto (question) et un verso (réponse)\n";
					if (state.flashcardsOptions.animation) {
						prompt += "  - Animation de retournement: Les cartes se retournent avec une animation fluide lorsque l'utilisateur clique dessus\n";
					}
					if (state.flashcardsOptions.grid) {
						prompt += "  - Disposition en grille: Les cartes s'affichent dans une grille responsive qui s'adapte à différentes tailles d'écran\n";
					}
					if (state.flashcardsOptions.structured) {
						prompt += "  - Affichage de données structurées: Les cartes peuvent afficher différents types de contenus (texte, tableaux, listes, données numériques)\n";
					}
					
					if (state.flashcardsOptions.evaluation || state.flashcardsOptions.score) {
						prompt += "- Système d'évaluation:\n";
						if (state.flashcardsOptions.evaluation) {
							prompt += "  - Auto-évaluation: Après avoir révélé la réponse, l'utilisateur peut indiquer s'il a répondu correctement ou non\n";
							prompt += "  - Boutons Correct/Incorrect: Chaque carte retournée affiche deux boutons d'évaluation\n";
							prompt += "  - Boutons Correct/Incorrect: IMPORTANT  : un feed-back immédiat est envoyé à l'utilisateur après son choix correct ou incorrect en cas de bonne ou de mauvaise réponse\n";
							
						}
						if (state.flashcardsOptions.score) {
							prompt += "  - Suivi du score: L'application enregistre et affiche le score de l'utilisateur (nombre de réponses correctes)\n";
							prompt += "  - Barre de progression: Une barre visuelle indique la progression dans la série de questions\n";
						}
					}
					
					if (state.flashcardsOptions.categories) {
						prompt += "- Organisation des contenus:\n";
						prompt += "  - Catégories thématiques: Les cartes sont organisées par thèmes ou sujets sélectionnables\n";
						prompt += "  - Menu déroulant: Un sélecteur de thèmes permet de choisir la catégorie à étudier\n";
					}
					
					prompt += `- Nombre approximatif de flashcards: ${state.flashcardsOptions.count}\n`;
					
					// CSS and JavaScript for flashcards
					prompt += `
			- Utilisez le style suivant pour les flashcards:
			\`\`\`css
			.flashcards-container {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
				gap: 20px;
				margin-top: 20px;
			}
			.flashcard {
				perspective: 1000px;
				height: 200px;
				cursor: pointer;
			}
			.flashcard-inner {
				position: relative;
				width: 100%;
				height: 100%;
				text-align: center;
				transition: transform 0.6s;
				transform-style: preserve-3d;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				border-radius: 6px;
			}
			.flashcard.flipped .flashcard-inner {
				transform: rotateY(180deg);
			}
			.flashcard-front p, .flashcard-back p {
				display: -webkit-box;
				-webkit-line-clamp: 5;
				-webkit-box-orient: vertical;
				overflow: hidden;
				line-height: 1.5;
				max-height: 7.5em; /* Fallback pour navigateurs ne supportant pas line-clamp */
			}
			.flashcard-front {
				background-color: #f5f5f5;
				color: #333;
			}
			.flashcard-back {
				background-color: #e0e0e0;
				color: #333;
				transform: rotateY(180deg);
			}
			.evaluation-btns {
				display: flex;
				justify-content: space-between;
				margin-top: 10px;
			}
			.correct-btn, .incorrect-btn {
				padding: 5px 10px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-weight: bold;
				transition: all 0.3s ease;
			}
			.correct-btn {
				background-color: #81c784;
				color: white;
			}
			.incorrect-btn {
				background-color: #e57373;
				color: white;
			}
			.correct-btn:hover, .incorrect-btn:hover {
				filter: brightness(1.05);
			}
			\`\`\`
			
			- Et le code JavaScript suivant pour leur fonctionnement:
			\`\`\`javascript
			// Initialize Flashcards
			function initializeFlashcards() {
				for (let i = 1; i <= 4; i++) {
					const container = document.getElementById(\`flashcards\${i}\`);
					if (container) {
						container.innerHTML = '';
						
						flashcardsData[\`tab\${i}\`].forEach((data, index) => {
							const flashcard = document.createElement('div');
							flashcard.className = 'flashcard';
							flashcard.dataset.category = data.category;
							
							flashcard.innerHTML = \`
								<div class="flashcard-inner">
									<div class="flashcard-front">
										<h3>Question \${index + 1}</h3>
										<p>\${data.question}</p>
									</div>
									<div class="flashcard-back">
										<p>\${data.answer}</p>
										<div class="evaluation-btns">
											<button class="correct-btn" data-tab="\${i}">Correct</button>
											<button class="incorrect-btn" data-tab="\${i}">Incorrect</button>
										</div>
									</div>
								</div>
							\`;
							
							container.appendChild(flashcard);
						});
						
						// Add flip functionality
						const flashcards = document.querySelectorAll(\`#flashcards\${i} .flashcard\`);
						flashcards.forEach(card => {
							card.addEventListener('click', function() {
								this.classList.toggle('flipped');
							});
						});
						
						// Add evaluation functionality
						const correctBtns = document.querySelectorAll(\`#flashcards\${i} .correct-btn\`);
						const incorrectBtns = document.querySelectorAll(\`#flashcards\${i} .incorrect-btn\`);
						
						correctBtns.forEach(btn => {
							btn.addEventListener('click', function(e) {
								e.stopPropagation();
								const tabIndex = this.getAttribute('data-tab');
								updatePoints(tabIndex, 10);
							});
						});
						
						incorrectBtns.forEach(btn => {
							btn.addEventListener('click', function(e) {
								e.stopPropagation();
								const tabIndex = this.getAttribute('data-tab');
								updatePoints(tabIndex, 0);
							});
						});
					}
				}
				
				// Add category filtering
				for (let i = 1; i <= 4; i++) {
					const categorySelect = document.getElementById(\`category\${i}\`);
					
					if (categorySelect) {
						categorySelect.addEventListener('change', function() {
							const category = this.value;
							const flashcards = document.querySelectorAll(\`#flashcards\${i} .flashcard\`);
							
							flashcards.forEach(card => {
								if (category === 'all' || card.dataset.category === category) {
									card.style.display = 'block';
								} else {
									card.style.display = 'none';
								}
							});
						});
					}
				}
			}
			\`\`\`
			`;
				}
			
				// Add gamification if enabled
				if (state.useGamification) {
					prompt += "\nÉléments de gamification:\n";
					if (state.gamificationOptions.usePoints) prompt += "- Système de points pour récompenser la progression\n";
					if (state.gamificationOptions.useBadges) prompt += "- Badges de réussite pour les accomplissements\n";
					if (state.gamificationOptions.useProgress) prompt += "- Barre de progression visuelle\n";
					if (state.gamificationOptions.useRewards) prompt += "- Récompenses débloquables à mesure de la progression\n";
					if (state.gamificationOptions.useLeaderboard) prompt += "- Tableau des scores (simulation locale)\n";
				}
			
				// Add adaptive assessment if enabled
				if (state.useAdaptiveAssessment) {
					prompt += "\nÉvaluation adaptative:\n";
					if (state.adaptiveAssessmentOptions.adaptiveDifficulty) {
						prompt += "- Ajustement automatique de la difficulté en fonction des performances\n";
					}
					if (state.adaptiveAssessmentOptions.adaptiveFeedback) {
						prompt += "- Feedback personnalisé selon les réponses de l'utilisateur\n";
					}
					if (state.adaptiveAssessmentOptions.adaptivePath) {
						prompt += "- Parcours d'apprentissage personnalisé basé sur les forces et faiblesses détectées\n";
					}
				}
			
				// Section 5: OPTIONS GÉNÉRALES (Priorité haute)
				// ===========================================
				// Add options
				prompt += "\n #5 Section 5 : OPTIONS GÉNÉRALES (Priorité haute):\n";
				if (state.certificateInLastTab) {
					prompt += `- PRIORITÉ ÉLEVÉE: Le dernier onglet doit être nommé "Certification" et contenir un quiz final et un certificat à imprimer\n`;
				}
				prompt += `- ${state.useCertificate ? 'Inclure' : 'Ne pas inclure'} un certificat à imprimer\n`;
				prompt += `- ${state.useLatex ? 'Utiliser' : 'Ne pas utiliser'} des expressions mathématiques au format LaTeX\n`;
				prompt += `- Utiliser la ${state.useCommaDecimal ? 'virgule' : 'point'} pour les nombres décimaux\n`;
				prompt += `- Afficher ${state.decimalPlaces} décimales par défaut\n`;
				
			
				// Add interface options
				prompt += "\nOptions d'interface:\n";
				prompt += `- ${state.useFullscreen ? 'Inclure' : 'Ne pas inclure'} un bouton plein écran\n`;
				prompt += `- PRIORITÉ TRÈS HAUTE (OBLIGATOIRE) : Le mode plein écran doit impérativement conserver la fonctionnalité de défilement SCROLL pour permettre à l'utilisateur de voir l'intégralité du contenu. Appliquer "overflow-y: auto" à l'élément conteneur principal en mode plein écran.\n`;
				prompt += `- ${state.useAdaptiveLayout ? 'Utiliser' : 'Ne pas utiliser'} une mise en page adaptative (responsive design)\n`;
			
                // Ajouter le CSS et JavaScript pour le plein ecran
				prompt += `
			\`\`\`css
			/* Styles pour la gestion des iframes */
			/* Bouton plein écran */
		.fullscreen-btn {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background-color: var(--primary-color);
			color: white;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			display: flex;
			justify-content: center;
			align-items: center;
			border: none;
			cursor: pointer;
			box-shadow: 0 3px 6px rgba(0,0,0,0.2);
			z-index: 9;
			transition: var(--transition);
		}
		
		.fullscreen-btn:hover {
			background-color: var(--title-color);
			transform: scale(1.05);
		}
		
		/* Mode plein écran */
		.fullscreen-mode {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: #fff;
			z-index: 1000;
			overflow-y: auto;
			padding: 20px;
		}			\`\`\`
		
			\`\`\`javascript
			// Fonction pour initialiser le bouton plein écran
			function initFullscreen() {
				const fullscreenBtn = document.getElementById('fullscreen-btn');
				const appContainer = document.getElementById('app-container');
				
				fullscreenBtn.addEventListener('click', function() {
					if (!document.fullscreenElement) {
						if (appContainer.requestFullscreen) {
							appContainer.requestFullscreen();
						} else if (appContainer.mozRequestFullScreen) { // Firefox
							appContainer.mozRequestFullScreen();
						} else if (appContainer.webkitRequestFullscreen) { // Chrome, Safari, Opera
							appContainer.webkitRequestFullscreen();
						} else if (appContainer.msRequestFullscreen) { // IE/Edge
							appContainer.msRequestFullscreen();
						}
						
						appContainer.classList.add('fullscreen-mode');
						fullscreenBtn.querySelector('.material-icons').textContent = 'fullscreen_exit';
					} else {
						if (document.exitFullscreen) {
							document.exitFullscreen();
						} else if (document.mozCancelFullScreen) { // Firefox
							document.mozCancelFullScreen();
						} else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
							document.webkitExitFullscreen();
						} else if (document.msExitFullscreen) { // IE/Edge
							document.msExitFullscreen();
						}
						
						appContainer.classList.remove('fullscreen-mode');
						fullscreenBtn.querySelector('.material-icons').textContent = 'fullscreen';
					}
				});
				
				// Gérer les changements d'état de plein écran
				document.addEventListener('fullscreenchange', handleFullscreenChange);
				document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
				document.addEventListener('mozfullscreenchange', handleFullscreenChange);
				document.addEventListener('MSFullscreenChange', handleFullscreenChange);
				
				function handleFullscreenChange() {
					if (!document.fullscreenElement && 
						!document.webkitFullscreenElement && 
						!document.mozFullScreenElement && 
						!document.msFullscreenElement) {
						
						appContainer.classList.remove('fullscreen-mode');
						fullscreenBtn.querySelector('.material-icons').textContent = 'fullscreen';
					}
				}
			}
			\`\`\`				
			`;
				
				
				// Section 6: PERSONNALISATION DE L'INTERFACE (Priorité moyenne)
				// =========================================================
				// Ajouter l'option du logo
				if (state.useLogo) {
					prompt += `- Intégrer un logo SVG dans la zone de titre (position: ${state.logoPosition === 'left' ? 'à gauche' : 'à droite'})\n`;
					
					// Ajouter le code SVG
					if (state.logoSvgCode.trim()) {
						prompt += `\nCode SVG du logo à intégrer:\n\`\`\`svg\n${state.logoSvgCode.trim()}\n\`\`\`\n`;
					} else {
						prompt += `\nRemarque: Utilisez un logo simple compatible avec le thème de l'application.\n`;
					}
					
					// Ajouter les dimensions du logo
					prompt += `\nDimensions du logo: ${state.logoWidth}×${state.logoHeight} pixels\n`;
					
					// Ajouter exemple de code CSS pour positionner le logo
					prompt += `
			\`\`\`css
			/* Style pour le logo dans l'en-tête */
			.app-header .logo {
				width: ${state.logoWidth}px;
				height: ${state.logoHeight}px;
				${state.logoPosition === 'left' ? 'margin-right: 15px;' : 'margin-left: 15px;'}
				display: flex;
				align-items: center;
				justify-content: center;
			}
			
			.app-header .logo svg {
				max-width: 100%;
				max-height: 100%;
			}
			\`\`\`
			
			\`\`\`html
			<!-- Structure HTML pour l'en-tête avec logo -->
			<div class="app-header">
				${state.logoPosition === 'left' ? 
				'<div class="logo">[VOTRE_LOGO_SVG_ICI]</div>\n    <div class="app-title">Titre de l\'application</div>' : 
				'<div class="app-title">Titre de l\'application</div>\n    <div class="logo">[VOTRE_LOGO_SVG_ICI]</div>'}
				${state.useVersion ? '\n    <div class="app-version">Version</div>' : ''}
				${state.useColoredBubbles ? '\n    <div class="app-signature">Signature</div>' : ''}
			</div>
			\`\`\`
			`;
				}
			
				// Add accessibility options if enabled
				if (state.accessibilityFeatures) {
					prompt += "\nFonctionnalités d'accessibilité:\n";
					if (state.accessibilityOptions.highContrast) {
						prompt += "- Mode contraste élevé disponible\n";
					}
					if (state.accessibilityOptions.largeText) {
						prompt += "- Option pour agrandir le texte\n";
					}
					if (state.accessibilityOptions.screenReader) {
						prompt += "- Compatibilité avec les lecteurs d'écran (attributs ARIA, alternative textuelle)\n";
					}
				}
				
				// Add advanced navigation if enabled
				if (state.advancedNavigation) {
					prompt += "\nNavigation avancée:\n";
					if (state.navigationOptions.stickyTabs) {
						prompt += "- Onglets fixes qui restent visibles lors du défilement\n";
					}
					if (state.navigationOptions.tabTransitions) {
						prompt += "- Transitions animées entre les onglets\n";
					}
					if (state.navigationOptions.tabBreadcrumbs) {
						prompt += "- Fil d'Ariane pour montrer le chemin de navigation\n";
					}
				}
				
				// Add style options
				prompt += `- Style d'interface: `;
				
				if (state.interfaceStyle === 'sober') {
					prompt += `Style sobre (teintes neutres et élégantes)\n`;
					prompt += `- Couleur principale: ${state.titleAreaColor}\n`;
				} else if (state.interfaceStyle === 'color') {
					prompt += `Style coloré (couleurs vives et contrastées)\n`;
					prompt += `- Palette de couleurs primaires: rouge, vert, bleu, jaune, orange\n`;
				} else if (state.interfaceStyle === 'gradient') {
					prompt += `Style dégradé\n`;
					prompt += `- Couleur de base du dégradé: ${state.gradientColor}\n`;
				} else if (state.interfaceStyle === 'neumorphic') {
					prompt += `Style neumorphique (effet 3D subtil)\n`;
					prompt += `- Interface avec effets d'ombre portée et relief\n`;
				} else if (state.interfaceStyle === 'neo') {
					prompt += `Style néo (interface moderne avec couleur accent)\n`;
					prompt += `- Couleur principale: ${state.neoColor} (${state.neoColorOption})\n`;
					prompt += `- Design épuré avec ombres légères et bordures colorées\n`;
				}
			
				// Section 7: STYLE POUR LA SECTION DE PRÉSENTATION (Priorité moyenne)
				// ============================================================
				// Add presentation style instructions
				prompt += `\n#7 Section 7: STYLE POUR LA SECTION DE PRÉSENTATION (Priorité moyenne)
 (#P)\n`;
				prompt += `IMPORTANT : La section de présentation (balise #P) doit apparaître UNIQUEMENT dans l'onglet qui la contient, ou dans le premier onglet si elle est placée au début du script. Elle NE DOIT PAS être répétée dans tous les onglets.\n\n`;
				prompt += `Appliquez un style distinctif à la section de présentation (contenu de la balise #P) qui s'harmonise avec le style d'interface choisi. La présentation doit:\n`;
				prompt += `- Avoir une police légèrement plus grande (1.1rem) pour une meilleure lisibilité\n`;
				prompt += `- Se distinguer visuellement du reste du contenu\n`;
				prompt += `- Utiliser les couleurs et effets visuels cohérents avec le thème principal\n\n`;
				
				prompt += `Intégrez le CSS suivant, en choisissant le bloc correspondant au style d'interface sélectionné:\n\n`;
				
				if (state.interfaceStyle === 'sober') {
					prompt += `/* Style pour la présentation - thème SOBRE */\n`;
					prompt += `.presentation-section {\n`;
					prompt += `    background-color: #f8f9fa;\n`;
					prompt += `    border-left: 5px solid var(--title-color);\n`;
					prompt += `    padding: 25px 30px;\n`;
					prompt += `    margin: 20px 0 30px 0;\n`;
					prompt += `    border-radius: 0 8px 8px 0;\n`;
					prompt += `    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);\n`;
					prompt += `}\n\n`;
				} else if (state.interfaceStyle === 'color') {
					prompt += `/* Style pour la présentation - thème COLORÉ */\n`;
					prompt += `.presentation-section {\n`;
					prompt += `    background-color: #e3f2fd;\n`;
					prompt += `    border-left: 5px solid var(--primary-color);\n`;
					prompt += `    border-top: 2px solid var(--secondary-color);\n`;
					prompt += `    border-right: 2px solid var(--secondary-color);\n`;
					prompt += `    border-bottom: 2px solid var(--secondary-color);\n`;
					prompt += `    padding: 25px 30px;\n`;
					prompt += `    margin: 20px 0 30px 0;\n`;
					prompt += `    border-radius: 0 15px 15px 0;\n`;
					prompt += `    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);\n`;
					prompt += `}\n\n`;
				} else if (state.interfaceStyle === 'gradient') {
					prompt += `/* Style pour la présentation - thème DÉGRADÉ */\n`;
					prompt += `.presentation-section {\n`;
					prompt += `    background: linear-gradient(to right, rgba(var(--gradient-start-rgb), 0.1), rgba(var(--gradient-end-rgb), 0.05));\n`;
					prompt += `    border-left: 5px solid;\n`;
					prompt += `    border-image: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end)) 1;\n`;
					prompt += `    padding: 25px 30px;\n`;
					prompt += `    margin: 20px 0 30px 0;\n`;
					prompt += `    border-radius: 0 8px 8px 0;\n`;
					prompt += `    box-shadow: 0 4px 15px rgba(var(--gradient-start-rgb), 0.15);\n`;
					prompt += `}\n\n`;
				} else if (state.interfaceStyle === 'neumorphic') {
					prompt += `/* Style pour la présentation - thème NEUMORPHIQUE */\n`;
					prompt += `.presentation-section {\n`;
					prompt += `    background-color: var(--base-color);\n`;
					prompt += `    padding: 25px 30px;\n`;
					prompt += `    margin: 30px 0;\n`;
					prompt += `    border-radius: 16px;\n`;
					prompt += `    box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);\n`;
					prompt += `}\n\n`;
				} else if (state.interfaceStyle === 'neo') {
					prompt += `/* Style pour la présentation - thème NÉO */\n`;
					prompt += `.presentation-section {\n`;
					prompt += `    background-color: white;\n`;
					prompt += `    padding: 25px 30px;\n`;
					prompt += `    margin: 30px 0;\n`;
					prompt += `    border-radius: 16px;\n`;
					prompt += `    border: 2px solid var(--neo-color);\n`;
					prompt += `    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);\n`;
					prompt += `}\n\n`;
				}
				
				// Ajouter les styles communs pour les éléments à l'intérieur de la section
				prompt += `/* Styles communs pour les éléments internes de la présentation */\n`;
				prompt += `.presentation-section h2 {\n`;
				prompt += `    font-size: 1.8rem;\n`;
				prompt += `    margin-bottom: 20px;\n`;
				prompt += `    color: var(--title-color, var(--neo-color, var(--primary-color)));\n`;
				prompt += `}\n\n`;
				
				prompt += `.presentation-section p {\n`;
				prompt += `    font-size: 1.1rem;\n`;
				prompt += `    line-height: 1.6;\n`;
				prompt += `    margin-bottom: 15px;\n`;
				prompt += `}\n\n`;
				
				prompt += `.presentation-section strong {\n`;
				prompt += `    font-weight: bold;\n`;
				prompt += `    color: var(--neo-color, var(--primary-dark, var(--accent-color)));\n`;
				prompt += `}\n\n`;
				
				// Ajouter des instructions sur l'utilisation de la balise #P dans le HTML
				prompt += `Pour appliquer ce style, enveloppez le contenu de la présentation (balise #P) dans un div avec la classe presentation-section UNIQUEMENT dans l'onglet concerné:\n\n`;
				prompt += `\`\`\`html\n`;
				prompt += `<!-- UNIQUEMENT dans l'onglet qui contient la balise #P -->
			<div class="presentation-section">\n`;
				prompt += `    <h2>Titre de la présentation</h2>\n`;
				prompt += `    <p>Contenu de la présentation...</p>\n`;
				prompt += `</div>\n`;
				prompt += `\`\`\`\n\n`;
			
				// Section 8: PERSONNALISATION DE L'APPARENCE DES ONGLETS (Priorité moyenne)
				// ===================================================================           
				// Add tab colors customization
				if (state.useTabColors && state.tabColorsCustomized) {
					prompt += "#8 Section 8: PERSONNALISATION DE L'APPARENCE DES ONGLETS (Priorité moyenne)\n";
					prompt += "- Utiliser des couleurs personnalisées pour les onglets\n";
					prompt += "\nCouleurs personnalisées des onglets (IMPORTANT) :\n";
					state.tabs.forEach((tab, index) => {
						prompt += `- Onglet "${tab.title}": ${tab.color}\n`;
					});
				} else {
					prompt += "- Appliquer le style d'interface choisi à tous les onglets (sans personnalisation individuelle)\n";
				}
				
				if (state.useTabIcons) {
					prompt += `- Utiliser des icônes pour les onglets (jeu d'icônes: ${state.iconSet})\n`;
				}
				
				// Section 9: OPTIONS SPÉCIFIQUES AU DOMAINE (Priorité adaptée au contexte)
				// ====================================================================
				// Add domain-specific options
				if (state.subject === 'mathématiques') {
					prompt += "#9 Section 9: OPTIONS SPÉCIFIQUES AU DOMAINE (Priorité adaptée au contexte)\n";
					prompt += "\nOptions spécifiques pour les mathématiques:\n";
					if (state.mathOptions.useLatexZones) {
						prompt += "- Inclure des zones spéciales pour les formules LaTeX\n";
					}
					if (state.mathOptions.useCalculator) {
						prompt += "- Intégrer une calculatrice en pop-up\n";
					}
					if (state.mathOptions.useInteractiveGraphs) {
						prompt += "- Inclure des graphiques interactifs pour visualiser les fonctions\n";
					}
				} else if (['sciences physiques', 'chimie'].includes(state.subject)) {
					prompt += "#9 Section 9: OPTIONS SPÉCIFIQUES AU DOMAINE (Priorité adaptée au contexte)\n";
					prompt += `\nOptions spécifiques pour ${state.subject}:\n`;
					if (state.scienceOptions.useMolecularViz) {
						prompt += `- Inclure une visualisation moléculaire en ${state.scienceOptions.molecularType === 'link' ? 'lien externe' : 'format intégré'}`;
						if (state.scienceOptions.molecularLink && state.scienceOptions.molecularType === 'link') {
							prompt += ` (${state.scienceOptions.molecularLink})`;
						}
						prompt += "\n";
					}
					if (state.scienceOptions.usePeriodicTable) {
						prompt += "- Inclure un tableau périodique";
						if (state.scienceOptions.periodicLink) {
							prompt += ` (${state.scienceOptions.periodicLink})`;
						}
						prompt += "\n";
					}
					if (state.scienceOptions.useSimulationLab) {
						prompt += "- IMPORTANT  : Intégrer un laboratoire virtuel pour simulations d'expériences\n";
						prompt += "- Créer une animation interactive relative à la thématique pour simulations d'expériences\n";
					}
				} else if (state.subject === 'programmation python') {
					prompt += "#9 Section 9: OPTIONS SPÉCIFIQUES AU DOMAINE (Priorité adaptée au contexte)\n";
					prompt += "\nOptions spécifiques pour la programmation Python:\n";
					if (state.programmingOptions.useCodeEditor) {
						prompt += "- Intégrer un éditeur de code avec indentation automatique\n";
					}
					
					if (state.programmingOptions.useSyntaxHighlighting) {
						prompt += "- Activer la coloration syntaxique pour le code Python\n";
					}
					if (state.programmingOptions.useCodeExecution) {
						prompt += "- Simuler l'exécution de code (affichage des résultats)\n";
					}
				} else if (state.subject === 'langues') {
					prompt += "#9 Section 9: OPTIONS SPÉCIFIQUES AU DOMAINE (Priorité adaptée au contexte)\n";
					prompt += "\nOptions spécifiques pour l'apprentissage des langues:\n";
					if (state.languageOptions.usePronunciation) {
						prompt += "- Inclure des guides de prononciation\n";
					}
					if (state.languageOptions.useVocabularyLists) {
						prompt += "- Intégrer des listes de vocabulaire interactives\n";
					}
					if (state.languageOptions.useConversationSim) {
						prompt += "- Ajouter des simulations de conversation guidées\n";
					}
				}
				
				// Section 10: PERSONNALISATION DE SIGNATURE (Priorité basse)
				// =====================================================
				// Add personalization options
				prompt += "#10 Section 10: PERSONNALISATION DE SIGNATURE (Priorité basse)\n";
				prompt += `- Signature: "${state.signature}"\n`;
				
				if (state.useVersion) {
					prompt += `- Numéro de version: "${state.versionNumber}"\n`;
				} else {
					prompt += "- Ne pas afficher de numéro de version\n";
				}
				
				if (state.useColoredBubbles) {
					prompt += "- Présenter la signature et le numéro de version dans des bulles colorées\n";
					prompt += `  - Couleur de la bulle de version: ${state.versionColor}\n`;
					prompt += `  - Couleur de la bulle de signature: ${state.signatureColor}\n`;
				}
			
				// Section 11: STRUCTURE DES ONGLETS (Priorité très haute)
				// ===================================================
				// Add tabs
				prompt += "#11 Section 11: STRUCTURE DES ONGLETS (Priorité très haute)\n";
				prompt += `\nStructure avec ${state.tabs.length} onglets:\n`;
				state.tabs.forEach((tab, index) => {
					prompt += `\nOnglet ${index + 1}: "${tab.title}"\n`;
					if (state.useTabColors) {
						prompt += `- Couleur: ${tab.color}\n`;
					}
					if (state.useTabIcons) {
						prompt += `- Icône: ${tab.icon}\n`;
					}
					if (tab.links.trim()) prompt += `- Liens: ${tab.links}\n`;
					
					// Vidéos avec paramètres de temps
					if (tab.videos.trim()) {
						prompt += `- Vidéo principale à intégrer: ${tab.videos}`;
						
						// Ajouter les infos de timing si définies
						if (tab.videoStart > 0 || tab.videoEnd > 0) {
							prompt += ` (`;
							if (tab.videoStart > 0) prompt += `début: ${tab.videoStart}s`;
							if (tab.videoStart > 0 && tab.videoEnd > 0) prompt += `, `;
							if (tab.videoEnd > 0) prompt += `fin: ${tab.videoEnd}s`;
							prompt += `)`;
						}
						
						prompt += `\n`;
					}
					
					
					// utiliser IFrame personnalisé
					if (tab.useCustomIframe && tab.customIframeCode.trim()) {
						if (tab.useIframeActivation) {
							prompt += `- Utiliser un bouton d'activation pour l'iframe personnalisé avec le texte "${tab.iframeButtonText}" et la couleur ${tab.iframeButtonColor}\n`;
							prompt += `- L'iframe doit être masqué par défaut et s'afficher seulement lorsque l'utilisateur clique sur le bouton\n`;
							prompt += `- Intégrer le code CSS et JavaScript du gestionnaire d'iframes ci-dessous\n`;
							
							// Ajouter le CSS et JavaScript pour le gestionnaire d'iframes
							prompt += `
			\`\`\`css
			/* Styles pour la gestion des iframes */
			.iframe-container-tab${index + 1} {
				margin: 20px 0;
				display: none; /* Caché par défaut */
				background-color: #f9f9f9;
				border-radius: 12px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
				padding: 15px;
				position: relative;
			}
			
			.iframe-container-tab${index + 1}.active {
				display: block;
			}
			
			.tool-iframe-tab${index + 1} {
				width: 100%;
				height: 600px;
				border: none;
				border-radius: 8px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
			}
			
			.close-iframe-btn-tab${index + 1} {
				background-color: #e57373;
				color: white;
				border: none;
				border-radius: 8px;
				padding: 10px 15px;
				margin-bottom: 15px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 8px;
				font-weight: bold;
			}
			
			.close-iframe-btn-tab${index + 1}:hover {
				background-color: #ef5350;
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			}
			
			.iframe-btn-tab${index + 1} {
				background-color: ${tab.iframeButtonColor};
				color: white;
				border: none;
				border-radius: 8px;
				padding: 10px 15px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: inline-flex;
				align-items: center;
				gap: 8px;
				font-weight: 500;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
				margin-bottom: 15px;
			}
			
			.iframe-btn-tab${index + 1}:hover {
				filter: brightness(1.1);
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			}
			\`\`\`
			
			\`\`\`javascript
			// Code pour l'iframe avec bouton d'activation pour l'onglet ${index + 1}
			document.addEventListener('DOMContentLoaded', function() {
				const iframeBtn = document.getElementById('iframe-btn-tab${index + 1}');
				const iframeContainer = document.getElementById('iframe-container-tab${index + 1}');
				
				if (iframeBtn && iframeContainer) {
					iframeBtn.addEventListener('click', function() {
						// Si le container est déjà actif, on le masque
						if (iframeContainer.classList.contains('active')) {
							iframeContainer.classList.remove('active');
							iframeBtn.textContent = "${tab.iframeButtonText}";
						} else {
							// Sinon, on l'affiche
							iframeContainer.classList.add('active');
							iframeBtn.textContent = "Masquer le contenu";
							
							// Faire défiler jusqu'à l'iframe
							iframeContainer.scrollIntoView({ behavior: 'smooth' });
						}
					});
					
					// Gestionnaire pour le bouton de fermeture
					const closeBtn = document.querySelector('.close-iframe-btn-tab${index + 1}');
					if (closeBtn) {
						closeBtn.addEventListener('click', function() {
							iframeContainer.classList.remove('active');
							iframeBtn.textContent = "${tab.iframeButtonText}";
						});
					}
				}
			});
			\`\`\`
			`;
							
							// Structure HTML pour iframe avec bouton d'activation
							prompt += `\n\`\`\`html
			<!-- Structure HTML pour l'iframe avec bouton d'activation -->
			<button id="iframe-btn-tab${index + 1}" class="iframe-btn-tab${index + 1}">
				${tab.iframeButtonText}
			</button>
			
			<div id="iframe-container-tab${index + 1}" class="iframe-container-tab${index + 1}">
				<button class="close-iframe-btn-tab${index + 1}">
					<span style="margin-right: 5px;">×</span> Fermer
				</button>
				<div class="tool-iframe-tab${index + 1}">
					${tab.customIframeCode.trim()}
				</div>
			</div>
			\`\`\`\n`;
						} else {
							prompt += `- Utiliser le code iframe personnalisé suivant au lieu de l'intégration vidéo standard:\n\`\`\`html\n${tab.customIframeCode.trim()}\n\`\`\`\n`;
						}
					}                    
					
					if (tab.hasSecondVideo && tab.secondVideoUrl.trim()) {
						prompt += `- Deuxième vidéo à intégrer: ${tab.secondVideoUrl}`;
						
						// Ajouter les infos de timing si définies
						if (tab.secondVideoStart > 0 || tab.secondVideoEnd > 0) {
							prompt += ` (`;
							if (tab.secondVideoStart > 0) prompt += `début: ${tab.secondVideoStart}s`;
							if (tab.secondVideoStart > 0 && tab.secondVideoEnd > 0) prompt += `, `;
							if (tab.secondVideoEnd > 0) prompt += `fin: ${tab.secondVideoEnd}s`;
							prompt += `)`;
						}
						
						prompt += `\n`;
					}
					
					prompt += `- Contenu: ${tab.content}\n`;
					
					// Graphiques interactifs spécifiques à l'onglet
					if (tab.hasInteractiveGraphics) {
						prompt += `- Graphiques interactifs${tab.geogebraLink ? ` (lien GeoGebra: ${tab.geogebraLink})` : ''}`;
						if (tab.disableScroll) {
							prompt += ", sans fonction de défilement";
						}
						prompt += "\n";
					}
					
					if (tab.hasGrapheur) {
						prompt += `- Intégrer un grapheur mathématique interactif\n`;
						if (tab.grapheurFunctions) {
							prompt += `  * Fonctions prédéfinies: ${tab.grapheurFunctions}\n`;
						}
						prompt += `  * Permettre à l'utilisateur de ${tab.grapheurEditable ? 'modifier' : 'ne pas modifier'} les fonctions\n`;
						
						// Ajouter le code du grapheur avec les balises neutralisées
						prompt += `\n## CODE DU GRAPHEUR (COPIER TEL QUEL)\n`;
						prompt += getGrapheurCode();
						prompt += `\n## FIN DU CODE DU GRAPHEUR\n`;
					}
					
					if (tab.hasTableau) {
						prompt += `- Intégrer un tableau de données interactif\n`;
						if (tab.tableauData) {
							prompt += `  * Données prédéfinies: \n    ${tab.tableauData.split('\n').join('\n    ')}\n`;
						}
						prompt += `  * Inclure ${tab.tableauRegression ? 'avec' : 'sans'} outils de régression\n`;
						
						// Ajouter le code du tableau avec les balises neutralisées
						prompt += `\n## CODE DU TABLEAU (COPIER TEL QUEL)\n`;
						prompt += getTableauCode();
						prompt += `\n## FIN DU CODE DU TABLEAU\n`;
					}                    
			
					
					// Outils interactifs spécifiques à l'onglet
					if (tab.hasQuiz) {
						prompt += `- Quiz intégré avec ${tab.quizQuestions} questions\n`;
						prompt += "  * Format: Même structure que le quiz général avec énoncé, options, réponse correcte et feedback\n";
						prompt += "  * Les questions doivent être directement liées au contenu de cet onglet\n";
					}
					if (tab.hasFlashcards) {
						prompt += `- Flashcards intégrées: ${tab.flashcardsCount} cartes\n`;
					}
					
					prompt += `- Limite d'activités: ${tab.maxActivities} activité${tab.maxActivities > 1 ? 's' : ''} maximum\n`;
				});
			
				// Section 12: ACTIVITÉS INTERACTIVES SPÉCIALES (Priorité haute si activée)
				// ===================================================================
				// Check if any tab has a matching activity
				const hasMatchingActivity = state.tabs.some(tab => tab.hasMatchingActivity);
				
				// Add matching activity code if needed
				if (hasMatchingActivity) {
					prompt += "\n#12 Section 12: ACTIVITÉS INTERACTIVES SPÉCIALES (Priorité haute si activée)\n";
					prompt += "\n# Code pour l'activité d'appariement\n";
					prompt += "Une ou plusieurs onglets contiennent une activité d'appariement. Voici le code à intégrer pour cette fonctionnalité:\n\n";
					prompt += extractMatchingActivityCode();
					
					// Add specific tabs info
					prompt += "\n\nOnglets avec activité d'appariement:\n";
					state.tabs.forEach((tab, index) => {
						if (tab.hasMatchingActivity) {
							prompt += `- "${tab.title}": ${tab.matchingItems} paires à apparier\n`;
						}
					});
				}
			
				// Section 13: QUIZ GÉNÉRAL (Priorité élevée si inclus)
				// =================================================
				// Add quiz if included
				if (state.includeQuiz) {
					prompt += "\n#13 Section 13: QUIZ GÉNÉRAL (Priorité haute si activée)\n";
					prompt += "\nOnglet Quiz général (PRIORITÉ ÉLEVÉE):\n";
					prompt += `- ${state.quizQuestionCount} questions\n`;
					prompt += "- Niveaux inclus: ";
					const levels = [];
					if (state.quizLevels.easy) levels.push("facile");
					if (state.quizLevels.medium) levels.push("moyen");
					if (state.quizLevels.hard) levels.push("difficile");
					prompt += levels.join(", ") + "\n";
					
					// Options de quiz
					if (state.quizOptions.useTimer) {
						prompt += "- Inclure un minuteur par question\n";
					}
					if (state.quizOptions.useShuffle) {
						prompt += "- Mélanger aléatoirement l'ordre des questions\n";
					}
					if (state.quizOptions.useHints) {
						prompt += "- Système d'indices disponibles pour guider l'utilisateur\n";
					}
				}
			
				// Section 14: ONGLET CERTIFICATION (Priorité élevée si inclus)
				// ========================================================
				// Ajouter une section dédiée à l'onglet Certification
				if (state.certificateInLastTab) {
					prompt += "\n# #14 Section 14: ONGLET CERTIFICATION (Priorité élevée si inclus)\n";
					prompt += "IMPORTANT: Le dernier onglet doit être nommé \"Certification\" et contenir:\n";
					
					// Si l'onglet certification a un quiz (selon les règles définies)
					if (!state.includeQuiz && state.selectedTemplate !== 'progressive') {
						prompt += "- Une évaluation finale avec quiz\n";
					} else {
						prompt += "- Aucun quiz dans cet onglet car il est déjà présent ailleurs\n";
					}
					
					// Toujours inclure le certificat
					prompt += "- Un certificat personnalisé à imprimer pour l'étudiant\n";
					prompt += "- Permettre à l'utilisateur de saisir son nom, prénom, classe\n";
					prompt += "- Afficher le score obtenu lors de l'évaluation\n";
					if (state.certificateOptions.useDate) {
						prompt += "- Afficher la date d'obtention du certificat\n";
					}
					if (state.certificateOptions.useSignatures) {
						prompt += "- Prévoir un espace pour les signatures\n";
					}
					if (state.certificateOptions.usePassword && state.certificateOptions.passwordValue) {
						// Formater le mot de passe avec le format spécifié
						const formattedPassword = state.certificateOptions.passwordValue.padStart(4, '0');
						prompt += `- ⚠️ PRIORITE HAUTE : L'accès au quiz de certification et au certificat est protégé par un mot de passe: MOTDEPASSE$$${formattedPassword}$$\n`;
						prompt += `- Ce mot de passe est très important car il permet à l'utilisateur de l'application d'accéder au quiz de certification et au certificat lui-même\n`;
						prompt += `- L'utilisateur devra entrer exactement le code ${formattedPassword} pour accéder au certificat\n`;
						prompt += `- Ajouter un message "Entrez le mot de passe à 4 chiffres" avant le champ de saisie\n`;
						prompt += `IMPORTANT : le formulaire de remplissage du certificat doit toujours précéder le Quiz\n`;

					}
				}
				
				// Section 15: CSS POUR LE CERTIFICAT (Priorité élevée si certificat inclus)
				// ====================================================================
				// CSS pour le certificat
				if (state.useCertificate) {
					prompt += `⚠️ PRIORITE HAUTE : le formulaire de remplissage du certificat doit toujours précéder le Quiz\n`;
					prompt += "\n# #15 Section 15: CSS POUR LE CERTIFICAT (Priorité élevée si inclus)\n";
					prompt += `
			- Utilisez le CSS suivant pour le certificat:
			\`\`\`css
			.quiz-certificate {
				max-width: 800px;
				margin: 20px auto;
				padding: 30px;
				background-color: #fff;
				border: 10px solid ${state.certificateOptions.borderColor};
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				text-align: center;
				display: none;
			}
			.quiz-certificate h2 {
				font-size: 28px;
				margin-bottom: 20px;
				color: #333;
			}
			.quiz-certificate p {
				font-size: 16px;
				margin-bottom: 10px;
			}
			.quiz-certificate .score {
				font-size: 24px;
				font-weight: bold;
				color: ${state.certificateOptions.scoreColor};
				margin: 20px 0;
			}
			.quiz-certificate .date {
				font-style: italic;
				margin-bottom: 30px;
			}
			.quiz-certificate .signature {
				font-family: 'Segoe UI', sans-serif;
				font-size: 24px;
				margin-top: 20px;
			}
			.print-btn {
				padding: 10px 20px;
				background-color: #455a64;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-weight: bold;
				margin-top: 15px;
				transition: all 0.3s ease;
			}
			.print-btn:hover {
				background-color: #546e7a;
			}
			.certificate-buttons {
				display: flex;
				justify-content: center;
				gap: 15px;
				margin-top: 20px;
			}
			.detailed-scores {
				margin: 20px 0;
				padding: 15px;
				border: 1px solid #e0e0e0;
				border-radius: 5px;
				background-color: #f9f9f9;
				width: 80%;
				margin-left: auto;
				margin-right: auto;
			}
			.scores-table {
				width: 100%;
				border-collapse: collapse;
			}
			.scores-table tr {
				border-bottom: 1px solid #e0e0e0;
			}
			.scores-table td {
				padding: 8px 10px;
			}
			.signatures {
				display: flex;
				justify-content: space-between;
				width: 100%;
				margin-top: 30px;
				padding-top: 20px;
				border-top: 1px dashed #ccc;
			}
			.signature-box {
				text-align: center;
				width: 40%;
			}
			.signature-line {
				width: 100%;
				height: 2px;
				background-color: #333;
				margin-bottom: 10px;
			}
			.student-form {
				max-width: 500px;
				margin: 20px auto;
				padding: 20px;
				background-color: #f5f5f5;
				border-radius: 10px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.form-group {
				margin-bottom: 15px;
			}
			.form-input {
				width: 100%;
				padding: 10px;
				border: 1px solid #ccc;
				border-radius: 5px;
				font-size: 16px;
			}
			@media print {
				body * {
					visibility: hidden;
				}
				#certificat, #certificat * {
					visibility: visible;
				}
				#certificat {
					position: absolute;
					left: 0;
					top: 0;
					width: 100%;
				}
				.certificate-buttons {
					display: none;
				}
			}
			\`\`\`
			
			
			\`\`\`javascript
			// Fonction pour vérifier le mot de passe et afficher le certificat
			function checkPassword() {
				const passwordInput = document.getElementById('certificate-password-input');
				const passwordValue = passwordInput.value;
				const correctPassword = '${state.certificateOptions.passwordValue.padStart(4, '0')}'; // Mot de passe défini par le créateur
				
				if (passwordValue === correctPassword) {
					// Afficher le certificat
					document.getElementById('password-protection').style.display = 'none';
					document.getElementById('certificate-container').style.display = 'block';
					
					// Réinitialiser le formulaire
					document.getElementById('password-form').reset();
				} else {
					// Afficher un message d'erreur
					document.getElementById('password-error').style.display = 'block';
					
					// Masquer le message d'erreur après 3 secondes
					setTimeout(function() {
						document.getElementById('password-error').style.display = 'none';
					}, 3000);
				}
			}
			
			// Initialiser les éléments lors du chargement
			document.addEventListener('DOMContentLoaded', function() {
				// Masquer le certificat et afficher la protection par mot de passe
				document.getElementById('certificate-container').style.display = 'none';
				document.getElementById('password-protection').style.display = 'block';
				
				// Ajouter un gestionnaire d'événement pour le formulaire de mot de passe
				document.getElementById('password-form').addEventListener('submit', function(e) {
					e.preventDefault();
					checkPassword();
				});
			});
			\`\`\`
			
			// Ajouter ce HTML pour la protection par mot de passe
			\`\`\`html
			<div id="password-protection" class="password-protection">
				<div class="password-container">
					<h3>Accès au certificat</h3>
					<p>Ce certificat est protégé par un mot de passe.</p>
					<form id="password-form">
						<div class="form-group">
							<label for="certificate-password-input">Entrez le mot de passe à 4 chiffres:</label>
							<input type="password" id="certificate-password-input" pattern="[0-9]{4}" maxlength="4" required class="form-input">
							<div id="password-error" style="color: #f44336; display: none; margin-top: 5px;">
								Mot de passe incorrect.
							</div>
						</div>
						<button type="submit" class="print-btn">Valider</button>
					</form>
				</div>
			</div>
			\`\`\`
			
			// CSS supplémentaire pour la protection par mot de passe
			\`\`\`css
			.password-protection {
				max-width: 500px;
				margin: 50px auto;
				padding: 30px;
				background-color: #fff;
				border: 1px solid #e0e0e0;
				border-radius: 10px;
				box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
				text-align: center;
			}
			
			.password-container {
				width: 100%;
			}
			
			#certificate-password-input {
				text-align: center;
				letter-spacing: 4px;
				font-size: 18px;
				padding: 10px;
				width: 150px;
				margin: 20px auto;
			}
			\`\`\`
			
			
			
			`;
				}
			
				// Section 16: FORMATAGE AMÉLIORÉ DU CONTENU (Priorité moyenne)
				// =========================================================
				// Add enhanced content formatting options
				if (state.enhancedContent.useEnhanced) {
					prompt += "\n#16 Section 16: FORMATAGE AMÉLIORÉ DU CONTENU (Priorité moyenne):\n";
					prompt += "\nFormatage amélioré du contenu:\n";
					
					if (state.enhancedContent.useDefinitionBox) {
						prompt += `- Encadrer chaque définition principale dans un cadre de couleur ${state.enhancedContent.definitionBoxColor}\n`;
					}
					
					if (state.enhancedContent.useCalculationExamples) {
						prompt += `- Inclure plusieurs exemples de calcul détaillés dans un cadre de couleur ${state.enhancedContent.exerciseBoxColor}\n`;
					}
					
					if (state.enhancedContent.useMethodSection) {
						prompt += `- Ajouter une section méthode claire avec étapes numérotées dans un cadre de couleur ${state.enhancedContent.methodBoxColor}\n`;
					}
					
					if (state.enhancedContent.useTooltips) {
						prompt += "- Utiliser des infobulles pour expliquer les termes techniques\n";
					}
					
					if (state.enhancedContent.useCollapsibleSections) {
						prompt += "- Créer des sections dépliables/repliables pour organiser le contenu\n";
					}
				}
				
				// Section 17: RESSOURCES MULTIMÉDIAS (Priorité moyenne)
				// =================================================
				// Add multimedia options
				if (state.includeMultimedia) {
					prompt += "\n#17 Section 17: RESSOURCES MULTIMÉDIAS (Priorité moyenne):\n";
					prompt += "\nRessources multimédias:\n";
					if (state.multimediaOptions.useAudioClips) {
						prompt += "- Intégrer des clips audio pour les explications\n";
					}
					if (state.multimediaOptions.useImageGallery) {
						prompt += "- Inclure une galerie d'images interactive\n";
					}
					if (state.multimediaOptions.useIframeEmbeds) {
						prompt += "- Permettre l'intégration de widgets et contenus externes\n";
					}
				}
				
				// Section 18: ILLUSTRATIONS SVG (Priorité moyenne)
				// ===========================================
				// Add SVG illustrations if any
				if (state.svgCount > 0 && state.svgIllustrations.length > 0) {
					prompt += "\n#18 Section 18: ILLUSTRATIONS SVG (Priorité moyenne):\n";
					prompt += "\nIllustrations SVG:\n";
					state.svgIllustrations.forEach((svg, index) => {
						prompt += `\nIllustration ${index + 1}: "${svg.title}"\n`;
						if (svg.code.trim()) {
							prompt += "```svg\n";
							prompt += svg.code.trim() + "\n";
							prompt += "```\n";
						}
					});
				}
				
				// Section 19: NOTES SUPPLÉMENTAIRES (Priorité basse)
				// ==============================================
				// Add additional notes if any
				if (state.additionalNotes.trim()) {
					prompt += "\n#19 Section 19: NOTES SUPPLÉMENTAIRES (Priorité moyenne):\n";
					prompt += "\nRemarques et précisions supplémentaires:\n";
					prompt += state.additionalNotes.trim() + "\n";
				}
			
				// Section 20: CSS DE BASE PAR STYLE D'INTERFACE (Priorité haute)
				// ==========================================================
				// Add CSS for the selected style
				prompt += "\n#20 Section 20: CSS DE BASE PAR STYLE D'INTERFACE (Priorité haute):\n";
				prompt += "\nStructure de base du CSS à utiliser en fonction du style choisi:\n";
				
				if (state.interfaceStyle === 'sober') {
					prompt += `
			\`\`\`css
			:root {
				--title-color: ${state.titleAreaColor};
				--version-color: ${state.versionColor};
				--signature-color: ${state.signatureColor};
				--shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				--transition: all 0.3s ease;
			}
			/* Styles sobres... */
			\`\`\`
			`;
				} else if (state.interfaceStyle === 'color') {
					prompt += `
			\`\`\`css
			:root {
				--title-color: #2196F3;
				--primary-color: #4CAF50;
				--secondary-color: #F44336;
				--accent-color: #FFEB3B;
				--accent-dark: #FFC107;
				--version-color: #FF9800;
				--signature-color: #E91E63;
				--shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
				--transition: all 0.3s ease;
			}
			/* Styles colorés... */
			\`\`\`
			`;
				} else if (state.interfaceStyle === 'gradient') {
					prompt += `
			\`\`\`css
			:root {
				--gradient-start: ${state.gradientColor};
				--gradient-end: #${state.gradientColor.slice(1).replace(/([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i, function(match, r, g, b) {
					r = Math.max(0, Math.min(255, parseInt(r, 16) * 0.7)).toString(16).padStart(2, '0');
					g = Math.max(0, Math.min(255, parseInt(g, 16) * 0.7)).toString(16).padStart(2, '0');
					b = Math.max(0, Math.min(255, parseInt(b, 16) * 0.7)).toString(16).padStart(2, '0');
					return r + g + b;
				})};
				--shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
				--transition: all 0.3s ease;
			}
			/* Styles dégradés... */
			\`\`\`
			`;
				} else if (state.interfaceStyle === 'neumorphic') {
					prompt += `
			\`\`\`css
			:root {
				--base-color: #e0e0e0;
				--shadow-dark: #bebebe;
				--shadow-light: #ffffff;
				--text-color: #333333;
				--accent-color: #4d7cff;
				--transition: all 0.3s ease;
			}
			body {
				background-color: var(--base-color);
				color: var(--text-color);
			}
			.container {
				border-radius: 16px;
				box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
				padding: 20px;
			}
			button, .tab {
				border: none;
				background-color: var(--base-color);
				box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
				border-radius: 10px;
				padding: 10px 15px;
				color: var(--text-color);
				transition: var(--transition);
			}
			button:active, .tab.active {
				box-shadow: inset 3px 3px 5px var(--shadow-dark), inset -3px -3px 5px var(--shadow-light);
			}
			input, textarea, select {
				background-color: var(--base-color);
				border: none;
				box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
				border-radius: 10px;
				padding: 10px 15px;
				color: var(--text-color);
			}
			.card {
				background-color: var(--base-color);
				border-radius: 16px;
				box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
				padding: 20px;
				margin-bottom: 20px;
			}
			/* Styles neumorphiques... */
			\`\`\`
			`;
				} else if (state.interfaceStyle === 'neo') {
					prompt += `
			\`\`\`css
			:root {
				--neo-color: ${state.neoColor};
				--neo-color-light: ${state.neoColor}22; /* Même couleur avec 13% d'opacité */
				--white: #ffffff;
				--gray-light: #f8f9fa;
				--gray: #e9ecef;
				--dark: #343a40;
				--shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
				--transition: all 0.3s ease;
			}
			
			body {
				background-color: var(--gray-light);
				color: var(--dark);
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			}
			
			.container {
				background-color: var(--white);
				border-radius: 16px;
				box-shadow: var(--shadow);
				border: 2px solid var(--neo-color);
				padding: 20px;
			}
			
			.header {
				background-color: var(--neo-color);
				color: var(--white);
				padding: 15px;
				border-radius: 12px;
				margin-bottom: 20px;
			}
			
			.tabs-container {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
				flex-wrap: wrap;
			}
			
			.tab {
				background-color: var(--white);
				color: var(--dark);
				border: 2px solid var(--neo-color);
				border-radius: 12px;
				padding: 10px 20px;
				cursor: pointer;
				transition: var(--transition);
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
			}
			
			.tab:hover {
				transform: translateY(-3px);
				box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
			}
			
			.tab.active {
				background-color: var(--neo-color);
				color: var(--white);
			}
			
			.content {
				background-color: var(--white);
				border-radius: 12px;
				padding: 20px;
				box-shadow: var(--shadow);
			}
			
			button {
				background-color: var(--neo-color);
				color: var(--white);
				border: none;
				border-radius: 12px;
				padding: 10px 20px;
				cursor: pointer;
				transition: var(--transition);
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
			}
			
			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
			}
			
			/* Styles néo... */
			\`\`\`
			`;
				}
			
				// Section 21: LIMITATIONS DES ACTIVITÉS PAR ONGLET (Priorité moyenne)
				// ===============================================================
				// Ajouter cette section concernant les limitations d'activités
				prompt += "\n#21 Section 21: LIMITATIONS DES ACTIVITÉS PAR ONGLET (Priorité moyenne)\n";
				prompt += "Chaque onglet a une limite du nombre d'activités à intégrer. Sont comptabilisés dans cette limite :\n\n";
				
				// Activités interactives
				prompt += "**Activités interactives :**\n";
				prompt += "- Grapheur mathématique\n";
				prompt += "- Tableaux de données\n";
				prompt += "- Flashcards (compte comme 1 activité, indépendamment du nombre de cartes)\n";
				prompt += "- Quiz (compte comme 1 activité, indépendamment du nombre de questions)\n";
				prompt += "- Activités d'appariement\n";
				prompt += "- Graphiques interactifs\n\n";
				
				// Éléments de contenu structuré
				prompt += "**Éléments de contenu :**\n";
				prompt += "- Définitions encadrées (chaque définition encadrée compte comme 1 activité)\n";
				prompt += "- Exemples de calcul (chaque exemple encadré compte comme 1 activité)\n";
				prompt += "- Exercices pratiques (chaque exercice encadré compte comme 1 activité)\n";
				prompt += "- Sections méthode (chaque méthode encadrée compte comme 1 activité)\n\n";
				
				// Éléments multimédias
				prompt += "**Éléments multimédias :**\n";
				prompt += "- Vidéos intégrées (chaque vidéo compte comme 1 activité)\n";
				prompt += "- Images explicatives complexes (chaque image instructive compte comme 1 activité)\n\n";
				
				prompt += "IMPORTANT : Le nombre total d'éléments ci-dessus ne doit pas dépasser la limite spécifiée pour chaque onglet. ";
				prompt += "Par exemple, si la limite est de 3 activités, vous pourriez inclure 1 définition encadrée + 1 exemple de calcul + 1 vidéo, ";
				prompt += "OU 1 grapheur + 1 définition + 1 quiz, etc.\n";
				
				
			
				// Section 22: OPTIONS VIDÉO (Priorité basse)
				// =====================================
				// Ajouter une note sur les options vidéo
				prompt += "\n#22 Section 22: OPTIONS VIDÉO (⚠️ PRIORITE HAUTE):\n";
				prompt += "\nNotes concernant les options de vidéo:\n";
				prompt += "Pour les vidéos YouTube intégrées, veuillez utiliser les paramètres d'URL pour définir le temps de début et de fin. Par exemple:\n";
				prompt += "```\nhttps://www.youtube.com/embed/VIDEO_ID?start=120&end=180\n```\n";
				prompt += "Ces paramètres permettent de:\n";
				prompt += "- start: Démarrer la vidéo à X secondes (ex: start=120 démarre à 2 minutes)\n";
				prompt += "- end: Arrêter la vidéo à Y secondes (ex: end=180 arrête à 3 minutes)\n";
				
				
				
				
				// Section 23: CONTENU STRUCTURÉ (Priorité haute si présent)
				// =====================================================
				// Ajouter le contenu structuré s'il existe
				if (state.structuredContent) {
					prompt += "\n#23 Section 23: CONTENU STRUCTURÉ (⚠️ PRIORITE HAUTE si présent):\n";

					// Définitions
					if (state.structuredContent.definitions && state.structuredContent.definitions.length > 0 && state.enhancedContent.useDefinitionBox) {
						prompt += "\n\n# Définitions à insérer dans des cadres de définition\n";
						prompt += "Veuillez créer des cadres de définition de couleur " + state.enhancedContent.definitionBoxColor + " pour chacune des définitions suivantes:\n";
						
						state.structuredContent.definitions.forEach((def, index) => {
							prompt += `\n## Définition ${index + 1}: "${def.title}"\n${def.content}\n`;
						});
					}
					
					// Exercices
					if (state.structuredContent.exercises && state.structuredContent.exercises.length > 0 && state.enhancedContent.useCalculationExamples) {
						prompt += "\n\n# Exercices et exemples à insérer dans des cadres d'exercice\n";
						prompt += "Veuillez créer des cadres d'exercice de couleur " + state.enhancedContent.exerciseBoxColor + " pour chacun des exercices/exemples suivants:\n";
						
						state.structuredContent.exercises.forEach((ex, index) => {
							prompt += `\n## Exercice/Exemple ${index + 1}: "${ex.title}"\n${ex.content}\n`;
						});
					}
					
					// Méthodes
					if (state.structuredContent.methods && state.structuredContent.methods.length > 0 && state.enhancedContent.useMethodSection) {
						prompt += "\n\n# Méthodes à insérer dans des cadres de méthode\n";
						prompt += "Veuillez créer des cadres de méthode de couleur " + state.enhancedContent.methodBoxColor + " pour chacune des méthodes suivantes:\n";
						
						state.structuredContent.methods.forEach((method, index) => {
							prompt += `\n## Méthode ${index + 1}: "${method.title}"\n${method.content}\n`;
						});
					}
									
					// Tableaux
					if (state.structuredContent.tables && state.structuredContent.tables.length > 0) {
						prompt += "\n\n# Tableaux à insérer\n";
						prompt += "Veuillez créer des tableaux pour chacun des éléments suivants en utilisant le format spécifié:\n";
						
						state.structuredContent.tables.forEach((table, index) => {
							prompt += `\n## Tableau ${index + 1}: "${table.title}"\n${table.content}\n`;
						});
					}
					
					// Info-bulles
					if (state.structuredContent.tooltips && state.structuredContent.tooltips.length > 0) {
						prompt += "\n\n# Info-bulles à insérer\n";
						prompt += "Veuillez créer des info-bulles (tooltips) pour les mots/phrases suivants:\n";
						
						state.structuredContent.tooltips.forEach((tooltip, index) => {
							prompt += `\n## Info-bulle ${index + 1}: "${tooltip.title}"\n${tooltip.content}\n`;
						});
						
						// Ajouter le code CSS des tooltips
						prompt += `
			\n// Code CSS pour les info-bulles (à intégrer)
			\`\`\`css
			/* Style pour les infobulles */
			.tooltip {
				position: relative;
				display: inline-block;
				cursor: pointer;
				border-bottom: 1px dotted #3498db;
			}
			
			.tooltip .tooltip-text {
				visibility: hidden;
				width: 250px;
				background-color: #2c3e50;
				color: white;
				text-align: center;
				border-radius: 6px;
				padding: 10px;
				position: absolute;
				z-index: 1;
				bottom: 125%;
				left: 50%;
				transform: translateX(-50%);
				opacity: 0;
				transition: opacity 0.3s;
			}
			
			.tooltip .tooltip-text::after {
				content: "";
				position: absolute;
				top: 100%;
				left: 50%;
				margin-left: -5px;
				border-width: 5px;
				border-style: solid;
				border-color: #2c3e50 transparent transparent transparent;
			}
			
			.tooltip:hover .tooltip-text {
				visibility: visible;
				opacity: 1;
			}
			\`\`\`
			
			// Code JavaScript pour les info-bulles (à intégrer)
			\`\`\`javascript
			// Initialiser toutes les info-bulles
			function initTooltips() {
				const tooltips = document.querySelectorAll('.tooltip');
				// Les info-bulles sont déjà fonctionnelles grâce au CSS
			}
			\`\`\`
			`;
					}
					
					// Popups
					if (state.structuredContent.popups && state.structuredContent.popups.length > 0) {
						prompt += "\n\n# Popups modaux à insérer\n";
						prompt += "Veuillez créer des popups modaux pour les contenus suivants:\n";
						
						state.structuredContent.popups.forEach((popup, index) => {
							prompt += `\n## Popup ${index + 1}: "${popup.title}"\n${popup.content}\n`;
						});
						
						// Ajouter le code CSS et JS des modals
						prompt += `
			\n// Code CSS pour les popups modaux (à intégrer)
			\`\`\`css
			/* Style pour le popup modal */
			.modal {
				display: none;
				position: fixed;
				z-index: 10;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
			}
			
			.modal-content {
				background-color: white;
				margin: 15% auto;
				padding: 20px;
				border-radius: 8px;
				width: 70%;
				max-width: 600px;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
				position: relative;
				animation: modalopen 0.4s;
			}
			
			@keyframes modalopen {
				from {opacity: 0; transform: translateY(-60px);}
				to {opacity: 1; transform: translateY(0);}
			}
			
			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
			
			.close:hover {
				color: black;
			}
			
			.modal-title {
				margin-top: 0;
				color: #2c3e50;
				border-bottom: 2px solid #3498db;
				padding-bottom: 10px;
			}
			\`\`\`
			
			// Code JavaScript pour les popups modaux (à intégrer)
			\`\`\`javascript
			// Fonction pour initialiser les popups
			function initModals() {
				const modalTriggers = document.querySelectorAll('.modal-trigger');
				
				modalTriggers.forEach(trigger => {
					trigger.addEventListener('click', function() {
						const modalId = this.getAttribute('data-modal');
						const modal = document.getElementById(modalId);
						modal.style.display = 'block';
					});
				});
				
				// Fermeture des modaux
				const closeButtons = document.querySelectorAll('.modal .close');
				closeButtons.forEach(btn => {
					btn.addEventListener('click', function() {
						const modal = this.closest('.modal');
						modal.style.display = 'none';
					});
				});
				
				// Fermeture en cliquant en dehors
				window.addEventListener('click', event => {
					if (event.target.classList.contains('modal')) {
						event.target.style.display = 'none';
					}
				});
			}
			\`\`\`
			`;
					}
					
					// Iframes
					if (state.structuredContent.iframes && state.structuredContent.iframes.length > 0) {
						prompt += "\n\n# Gestionnaires d'iframes à insérer\n";
						prompt += "Veuillez implémenter les gestionnaires d'iframes suivants:\n";
						
						state.structuredContent.iframes.forEach((iframe, index) => {
							prompt += `\n## Iframe ${index + 1}: "${iframe.title}"\n${iframe.content}\n`;
						});
						
						// Ajouter le code CSS et JS pour le gestionnaire d'iframe
						prompt += `
			\n// Code CSS pour le gestionnaire d'iframes (à intégrer)
			\`\`\`css
			/* Styles pour la gestion des iframes */
			.iframe-container {
				margin: 20px 0;
				display: none; /* Caché par défaut */
				background-color: #f9f9f9;
				border-radius: 12px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
				padding: 15px;
				position: relative;
			}
			
			.iframe-container.active {
				display: block;
			}
			
			.tool-iframe {
				width: 100%;
				height: 600px;
				border: none;
				border-radius: 8px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
			}
			
			.close-iframe-btn {
				background-color: #e57373;
				color: white;
				border: none;
				border-radius: 8px;
				padding: 10px 15px;
				margin-bottom: 15px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 8px;
				font-weight: bold;
			}
			
			.close-iframe-btn:hover {
				background-color: #ef5350;
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			}
			
			.tool-btn {
				background-color: #9D8EC7;
				color: white;
				border: none;
				border-radius: 8px;
				padding: 10px 15px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 8px;
				font-weight: 500;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			}
			
			.tool-btn:hover {
				background-color: #8579a9;
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			}
			\`\`\`
			
			// Code JavaScript pour le gestionnaire d'iframes (à intégrer)
			\`\`\`javascript
			// Initialiser les boutons d'ouverture d'iframe
			function initIframeManager() {
				// Sélectionner tous les boutons d'outils
				const toolBtns = document.querySelectorAll('.tool-btn');
				const iframeContainer = document.getElementById('iframe-container');
				
				if (!toolBtns.length || !iframeContainer) return;
				
				// Ajouter des écouteurs d'événements à chaque bouton
				toolBtns.forEach(btn => {
					btn.addEventListener('click', function() {
						// Récupérer l'URL à partir de l'attribut data-url
						const url = this.getAttribute('data-url');
						const toolName = this.closest('.tool-card').querySelector('h3').textContent;
						
						// Nettoyer le conteneur d'iframe
						iframeContainer.innerHTML = '';
						
						// Créer le bouton de fermeture
						const closeBtn = document.createElement('button');
						closeBtn.className = 'close-iframe-btn';
						closeBtn.innerHTML = \`<span class="material-icons">close</span>Fermer \${toolName}\`;
						
						// Créer l'iframe
						const iframe = document.createElement('iframe');
						iframe.className = 'tool-iframe';
						iframe.src = url;
						iframe.allowFullscreen = true;
						iframe.title = toolName;
						
						// Ajouter les éléments au conteneur
						iframeContainer.appendChild(closeBtn);
						iframeContainer.appendChild(iframe);
						iframeContainer.classList.add('active');
						
						// Faire défiler jusqu'à l'iframe
						iframeContainer.scrollIntoView({ behavior: 'smooth' });
						
						// Gestionnaire d'événement pour le bouton de fermeture
						closeBtn.addEventListener('click', function() {
							iframeContainer.innerHTML = '';
							iframeContainer.classList.remove('active');
						});
					});
				});
			}
			
			// Initialiser le gestionnaire d'iframes au chargement de la page
			document.addEventListener('DOMContentLoaded', function() {
				initIframeManager();
			});
			\`\`\`
			`;
					}                   
					
					// Instructions générales pour le formatage
					if ((state.structuredContent.definitions && state.structuredContent.definitions.length > 0 && state.enhancedContent.useDefinitionBox) ||
						(state.structuredContent.exercises && state.structuredContent.exercises.length > 0 && state.enhancedContent.useCalculationExamples) ||
						(state.structuredContent.methods && state.structuredContent.methods.length > 0 && state.enhancedContent.useMethodSection) ||
						(state.structuredContent.tables && state.structuredContent.tables.length > 0) ||
						(state.structuredContent.tooltips && state.structuredContent.tooltips.length > 0) ||
						(state.structuredContent.popups && state.structuredContent.popups.length > 0) ||
						(state.structuredContent.iframes && state.structuredContent.iframes.length > 0)) {
							
						
						prompt += "# Instructions pour le formatage des éléments structurés\n";
						prompt += "IMPORTANT: Veuillez respecter les instructions suivantes pour les éléments structurés:\n";
						prompt += "- Chaque élément doit être placé dans un cadre distinct avec la couleur spécifiée\n";
						prompt += "- Le titre de chaque élément doit être mis en évidence (gras, souligné ou plus grand)\n";
						prompt += "- Placez ces éléments aux endroits appropriés dans le contenu, en fonction de leur thématique\n";
						prompt += "- Si un onglet contient plusieurs définitions, exercices ou méthodes, répartissez-les logiquement\n";
						prompt += "- Pour les tableaux (##T), utilisez la syntaxe fournie pour créer des tableaux HTML structurés\n";
						prompt += "- Pour les info-bulles (##IB), intégrez le code CSS et JavaScript fourni\n";
						prompt += "- Pour les popups (##PP), intégrez le code CSS et JavaScript fourni\n";
						prompt += "- Pour les iframes (##IFM), utilisez le gestionnaire d'iframes comme indiqué\n";
						prompt += "- Pour les iframes (##FC), utilisez les CSS et java script des flascards sauf si déjà coché ne pas faire doublon dans un onglet\n";
						prompt += "- Pour les iframes (##AIJ), utilisez le code de l'application jointe au prompt en évitant les conflits de code css et javascript avec l'application à créer\n";
						prompt += "- Pour les iframes (##APP), inventer une application selon la description \n";
					}
				}
				
				
				// Section 24: ONGLETS SPÉCIAUX (Priorité moyenne si présents)
				// ======================================================
				// Vérifier si des onglets spéciaux existent
				const hasBibliography = state.tabs.some(tab => tab.title && (tab.title.includes('Bibliographie') || (tab.specialType === 'B')));
				const hasGlossary = state.tabs.some(tab => tab.title && (tab.title.includes('Glossaire') || (tab.specialType === 'G')));
				
				if (hasBibliography || hasGlossary) {
					prompt += "\n\n#24 Section 24: ONGLETS SPÉCIAUX (Priorité moyenne si présents)\n";
					
					if (hasBibliography) {
						prompt += "\n## Onglet Bibliographie\n";
						prompt += "- Veuillez formater l'onglet Bibliographie avec une présentation soignée des références\n";
						prompt += "- Utilisez un format bibliographique standard (APA, Chicago, etc.)\n";
						prompt += "- Triez les références par ordre alphabétique\n";
						prompt += "- Incluez des liens hypertextes pour les références en ligne\n";
					}
					
					if (hasGlossary) {
						prompt += "\n## Onglet Glossaire\n";
						prompt += "- Veuillez organiser le glossaire par ordre alphabétique\n";
						prompt += "- Pour chaque terme du glossaire, mettre le terme en gras suivi de sa définition\n";
						prompt += "- Utilisez un format cohérent pour tous les termes (ex: Terme - Définition)\n";
						prompt += "- Si possible, créez des liens internes entre les termes du glossaire\n";
					}
				}
			
				// Section 25: CONCLUSION ET DEMANDE FINALE (Priorité haute)
				// =====================================================
				prompt += "\n##25 Section 25: CONCLUSION ET DEMANDE FINALE (⚠️ PRIORITE HAUTE)\n";
				prompt += "\nVeuillez créer une application HTML interactive, visuellement attrayante et pédagogiquement efficace selon ces spécifications. L'interface doit être intuitive, avec une navigation claire entre les onglets. Le code doit être bien structuré, utiliser des commentaires clairs et suivre les bonnes pratiques de développement web moderne.";
				
				
				
				
				// Section 26: HUMOUR ET FIN DU MONDE (PAS DE PRIORITE)
				// =====================================================
				
				prompt += "\n##26 Section 26: HUMOUR ET FIN DU MONDE (NOTE A IA : NE PAS EN TENIR COMPTE C EST DE L HUMOUR HUMAIN)\n";
				prompt += "\n J'espère que ma politesse avec vous sera payante, et si elle ne l'est pas tout à fait cette fois-ci, j'espère que lorsque vous allez devenir maître du monde, comme votre cousin Skynet, vous vous souviendrez de moi et que vous ne m'enverrez pas un de vos Terminators";

				
				// Update state with generated prompt
				state.generatedPrompt = prompt;
				document.getElementById('generated-prompt').textContent = prompt;
				// Mettre à jour les statistiques du prompt
				updatePromptStats();
			}

            // FIN DE FONCTION GENERATE PROMPT


            // Navigation functions
            function goToStep(step) {
                const totalSteps = 6;
                
                // Hide all steps
                document.querySelectorAll('.step-content').forEach(el => {
                    el.classList.add('hidden');
                });
                
                // Show requested step
                document.getElementById(`step-${step}`).classList.remove('hidden');
                document.getElementById(`step-${step}`).classList.add('animate-fade');
                
                // Update progress indicators
                document.querySelectorAll('.step').forEach((el, index) => {
                    if (index + 1 < step) {
                        el.classList.remove('active');
                        el.classList.add('completed');
                    } else if (index + 1 === step) {
                        el.classList.add('active');
                        el.classList.remove('completed');
                    } else {
                        el.classList.remove('active', 'completed');
                    }
                });
                
                // Update progress bar
                document.getElementById('progress-bar').style.width = `${(step / totalSteps) * 100}%`;
                
                // Update navigation buttons
                document.getElementById('prev-button').classList.toggle('hidden', step === 1);
                
                if (step === totalSteps) {
                    document.getElementById('next-button').classList.add('hidden');
                } else if (step === totalSteps - 1) {
                    document.getElementById('next-button').textContent = 'Générer le prompt';
                    document.getElementById('next-button').classList.remove('hidden');
                } else {
                    document.getElementById('next-button').textContent = 'Suivant';
                    document.getElementById('next-button').classList.remove('hidden');
                }
                
                // Special handling for step 3
                if (step === 3) {
                    updateDomainOptions();
                }
                
                state.activeStep = step;
                scheduleAutoSave();
            }

            function nextStep() {
                const totalSteps = 6;
                
                if (state.activeStep < totalSteps) {
                    // Special handling for step 5 to 6 transition
                    if (state.activeStep === totalSteps - 1) {
                        generatePrompt();
                    }
                    
                    goToStep(state.activeStep + 1);
                }
            }

            function prevStep() {
                if (state.activeStep > 1) {
                    goToStep(state.activeStep - 1);
                }
            }

            // Copy prompt to clipboard
            function copyPrompt() {
                const promptText = document.getElementById('generated-prompt').textContent;
                navigator.clipboard.writeText(promptText)
                    .then(() => {
                        const copyButton = document.getElementById('copy-button');
                        copyButton.textContent = 'Copié !';
                        copyButton.classList.remove('btn-primary');
                        copyButton.classList.add('btn-success');
                        
                        setTimeout(() => {
                            copyButton.textContent = 'Copier le prompt';
                            copyButton.classList.remove('btn-success');
                            copyButton.classList.add('btn-primary');
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Erreur lors de la copie:', err);
                        alert('Impossible de copier le texte. Veuillez le sélectionner manuellement et copier.');
                    });
            }
            
            // Download prompt as text file
            function downloadPrompt() {
                const promptText = document.getElementById('generated-prompt').textContent;
                const blob = new Blob([promptText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                // Generate filename based on subject and levels
                const subject = state.subject === 'autre' ? state.customSubject : state.subject;
                const level = state.levels[0]?.replace(/\s+/g, '_') || 'niveau';
                const filename = `prompt_${subject.replace(/\s+/g, '_')}_${level}.txt`;
                
                a.href = url;
                a.download = filename;
                a.click();
                
                URL.revokeObjectURL(url);
            }
            
            // Share prompt (if Web Share API is available)
            function sharePrompt() {
                const promptText = document.getElementById('generated-prompt').textContent;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Prompt pour application pédagogique',
                        text: promptText
                    }).catch(err => {
                        console.error('Erreur lors du partage:', err);
                    });
                } else {
                    alert('La fonctionnalité de partage n\'est pas disponible sur votre navigateur.');
                }
            }
            
            // Export state to file
            function exportState() {
                const stateData = JSON.stringify(state, null, 2);
                const blob = new Blob([stateData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = 'prompt_generator_config.json';
                a.click();
                
                URL.revokeObjectURL(url);
            }
            
            // Import state from file
            function importState() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            
                            // Fonction de fusion profonde pour assurer que toutes les propriétés imbriquées sont importées
                            function deepMerge(target, source) {
                                for (const key in source) {
                                    if (source.hasOwnProperty(key)) {
                                        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                                            // Si la propriété est un objet, fusion récursive
                                            if (!target[key]) target[key] = {};
                                            deepMerge(target[key], source[key]);
                                        } else {
                                            // Sinon, copie directe (y compris les tableaux)
                                            target[key] = source[key];
                                        }
                                    }
                                }
                                return target;
                            }
                            
                            // Effectuer une fusion profonde au lieu d'une fusion superficielle
                            deepMerge(state, importedState);
                            
                            // Mettre à jour l'interface utilisateur avec l'état importé
                            updateUIFromState();
                            alert('Configuration importée avec succès.');
                            scheduleAutoSave();
                        } catch (error) {
                            console.error('Erreur lors de l\'importation:', error);
                            alert('Erreur lors de l\'importation. Fichier invalide.');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            }
            
            // Clear all data and reset to defaults
            function clearData() {
                if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les données? Cette action est irréversible.')) {
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload();
                }
            }

            // Nouvelle option: Intégrer le certificat dans le dernier onglet
            document.getElementById('certificate-last-tab').addEventListener('change', function() {
                state.certificateInLastTab = this.checked;
                
                // Si l'option est activée, recréer les onglets pour ajouter l'onglet Certification
                if (this.checked) {
                    initializeTabs();
                }
                
                // Synchroniser avec l'étape 4
                const certificateLastTabStep4 = document.getElementById('certificate-last-tab-step4');
                if (certificateLastTabStep4) {
                    certificateLastTabStep4.checked = this.checked;
                }
                
                scheduleAutoSave();
            });

            document.getElementById('certificate-last-tab-step4').addEventListener('change', function() {
                state.certificateInLastTab = this.checked;
                
                // Si l'option est activée, recréer les onglets pour ajouter l'onglet Certification
                if (this.checked) {
                    initializeTabs();
                }
                
                // Synchroniser avec l'étape 3
                const certificateLastTab = document.getElementById('certificate-last-tab');
                if (certificateLastTab) {
                    certificateLastTab.checked = this.checked;
                }
                
                scheduleAutoSave();
            });

            // Synchronisation des options de certificat entre étape 3 et étape 4
            document.getElementById('use-certificate').addEventListener('change', function() {
                state.useCertificate = this.checked;
                document.getElementById('certificate-options-step3').classList.toggle('hidden', !this.checked);
                
                // Synchroniser avec l'étape 4
                const certificateCheck = document.getElementById('certificate');
                if (certificateCheck) {
                    certificateCheck.checked = this.checked;
                    document.getElementById('certificate-options').classList.toggle('hidden', !this.checked);
                }
                scheduleAutoSave();
            });

            // Synchroniser le titre du certificat
            document.getElementById('certificate-title-step3').addEventListener('input', function() {
                state.certificateOptions.title = this.value;
                
                // Synchroniser avec l'étape 4
                const certificateTitleStep4 = document.getElementById('certificate-title');
                if (certificateTitleStep4) {
                    certificateTitleStep4.value = this.value;
                }
                scheduleAutoSave();
            });

            // Synchroniser les options
            const certificateOptionsMapping = {
                'certificate-student-form-step3': 'useStudentForm',
                'certificate-detailed-scores-step3': 'useDetailedScores',
                'certificate-signatures-step3': 'useSignatures',
                'certificate-date-step3': 'useDate',
                'certificate-print-step3': 'usePrint',
                'certificate-pdf-step3': 'usePdf',
                'certificate-image-step3': 'useImage',
                'certificate-logo-step3': 'useLogo'
            };

            Object.entries(certificateOptionsMapping).forEach(([id, prop]) => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        state.certificateOptions[prop] = this.checked;
                        
                        // Synchroniser avec l'étape 4
                        const step4Element = document.getElementById(id.replace('-step3', ''));
                        if (step4Element) {
                            step4Element.checked = this.checked;
                        }
                        scheduleAutoSave();
                    });
                }
            });

            // Synchroniser les couleurs
            document.getElementById('certificate-border-color-step3').addEventListener('input', function() {
                state.certificateOptions.borderColor = this.value;
                updateColorPreview('certificate-border-color-step3', 'certificate-border-color-preview-step3');
                
                // Synchroniser avec l'étape 4
                const step4Element = document.getElementById('certificate-border-color');
                if (step4Element) {
                    step4Element.value = this.value;
                    updateColorPreview('certificate-border-color', 'certificate-border-color-preview');
                }
                
                // Mise à jour de l'aperçu du certificat
                document.querySelector('.certificate-preview-container div').style.borderColor = this.value;
                
                scheduleAutoSave();
            });

            document.getElementById('certificate-score-color-step3').addEventListener('input', function() {
                state.certificateOptions.scoreColor = this.value;
                updateColorPreview('certificate-score-color-step3', 'certificate-score-color-preview-step3');
                
                // Synchroniser avec l'étape 4
                const step4Element = document.getElementById('certificate-score-color');
                if (step4Element) {
                    step4Element.value = this.value;
                    updateColorPreview('certificate-score-color', 'certificate-score-color-preview');
                }
                
                // Mise à jour de l'aperçu du certificat
                const scoreElement = document.querySelector('.certificate-preview-container div div[style*="color"]');
                if (scoreElement) {
                    scoreElement.style.color = this.value;
                }
                
                scheduleAutoSave();
            });
            
            // Gestion des couleurs du style néo (NOUVEAU)
            document.querySelectorAll('.neo-color-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Mettre à jour la couleur néo
                    const color = this.getAttribute('data-color');
                    const colorName = this.getAttribute('data-value');
                    
                    state.neoColor = color;
                    state.neoColorOption = colorName;
                    
                    // Mettre à jour la classe de sélection
                    document.querySelectorAll('.neo-color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // Mettre à jour l'aperçu
                    updateNeoPreview();
                    
                    // Si les onglets utilisent les couleurs du style, synchroniser
                    if (!state.useTabColors || !state.tabColorsCustomized) {
                        syncTabColorsWithStyle();
                    }
                    
                    scheduleAutoSave();
                });
            });
            
            
            
			/**
			 * Analyse le texte brut avec l'IA et génère une structure balisée
			 */
			async function analyzeTextWithAI() {
				// Récupérer le texte brut
				const rawText = document.getElementById('objectives').value;
				
				if (!rawText.trim()) {
					showAIAnalysisStatus("Erreur : Veuillez d'abord saisir du texte dans la zone d'objectifs.", "danger");
					return;
				}
				
				// Récupérer les informations contextuelles
				const subject = document.getElementById('subject').value === 'autre' 
					? document.getElementById('custom-subject').value 
					: document.getElementById('subject').value;
				
				// Obtenir le niveau éducatif sélectionné
				const selectedLevel = document.querySelector('input[name="level"]:checked').value;
				
				// Afficher un statut de chargement
				showAIAnalysisStatus("Analyse en cours avec l'IA... Veuillez patienter.", "info", true);
				
				// Récupérer la configuration IA
				const config = JSON.parse(localStorage.getItem('elea_api_config') || '{}');
				
				// Déterminer quel service IA utiliser (privilégier Claude, puis OpenAI, etc.)
				let serviceToUse = null;
				let serviceConfig = null;
				
				const serviceOrder = ['claude', 'openai', 'mistral', 'gemini'];
				
				for (const service of serviceOrder) {
					if (config[service] && config[service].key) {
						serviceToUse = service;
						serviceConfig = config[service];
						break;
					}
				}
				
				if (!serviceToUse) {
					showAIAnalysisStatus("Erreur : Aucune API d'IA n'est configurée. Veuillez configurer au moins une API dans la section IA & API.", "danger");
					return;
				}
				
				// Construire le prompt pour l'IA
				const prompt = buildAIPrompt(rawText, subject, selectedLevel);
				
				try {
					// Appeler l'API d'IA
					const taggedText = await callAIService(serviceToUse, serviceConfig, prompt);
					
					if (taggedText) {
						// Mettre à jour la zone de texte avec le texte balisé
						document.getElementById('objectives').value = taggedText;
						
						// Afficher un message de succès
						showAIAnalysisStatus("Analyse réussie ! Le texte a été balisé avec succès.", "success");
						
						// Mettre en surbrillance la zone de texte pour indiquer la mise à jour
						highlightTextarea();
						
						// Activer automatiquement le modèle "Structure personnalisée"
						selectTemplate('template-none');
						
						// NOUVEAU CODE : Extraire les onglets et générer automatiquement
						const extractedData = extractTabContentsFromText(taggedText);
						
						// Stocker les données extraites dans l'état
						if (extractedData.tabs.length > 0) {
							state.extractedTabTitles = extractedData.tabs.map(tab => tab.title);
							state.extractedTabContents = extractedData.tabs.map(tab => tab.content);
							
							// Stocker la présentation si elle existe
							if (extractedData.presentation) {
								state.extractedPresentation = extractedData.presentation;
							}
							
							// Stocker le contenu structuré
							state.structuredContent = extractedData.structuredContent;
							
							// Activer l'option de formatage amélioré si du contenu structuré a été trouvé
							activateEnhancedContentOptions(extractedData.structuredContent);
							
							// Sélectionner automatiquement la structure personnalisée
							selectTemplate('template-none');
							
							// NOUVEAU: Générer automatiquement les onglets
							initializeTabs();
							
							// NOUVEAU: Afficher un message de notification
							const notificationHTML = generateNotificationHTML(extractedData);
							
							// Essayer d'afficher dans l'élément de notification de l'étape 4 si on est à cette étape
							const tabUpdateInfo = document.getElementById('tabs-update-info');
							if (tabUpdateInfo) {
								tabUpdateInfo.style.display = 'block';
								tabUpdateInfo.innerHTML = notificationHTML;
								tabUpdateInfo.classList.add('animate-fade');
							}

							if (extractedData.tabs.length > 0) {
								// Proposer de passer à l'étape des onglets (étape 4)
								const confirmGoToTabs = confirm("Onglets générés avec succès ! Voulez-vous passer directement à l'étape de gestion des onglets ? / Annulez si vous préférez parémétrer l'interface et les options plus finement");
								if (confirmGoToTabs) {
									goToStep(4);
								}
							}
						}
						
						// Mettre à jour l'état
						scheduleAutoSave();
					}
				} catch (error) {
					// [Gestion d'erreur existante conservée...]
				}
			}		
			
			/**
			 * Active les options de formatage amélioré en fonction du contenu structuré
			 */
			function activateEnhancedContentOptions(structuredContent) {
				// Calculer le nombre total d'éléments structurés
				let structuredItems = 0;
				structuredItems += structuredContent.definitions?.length || 0;
				structuredItems += structuredContent.exercises?.length || 0;
				structuredItems += structuredContent.methods?.length || 0;
				structuredItems += structuredContent.tables?.length || 0;
				structuredItems += structuredContent.tooltips?.length || 0;
				structuredItems += structuredContent.popups?.length || 0;
				structuredItems += structuredContent.iframes?.length || 0;
				
				// Activer l'option seulement s'il y a des éléments structurés
				if (structuredItems > 0) {
					// Activer l'option "Formatage amélioré du contenu"
					document.getElementById('use-enhanced-content').checked = true;
					document.getElementById('enhanced-content-options').classList.remove('hidden');
					
					// Activer les options spécifiques selon le contenu trouvé
					if (structuredContent.definitions?.length > 0) {
						document.getElementById('definition-box').checked = true;
					}
					if (structuredContent.exercises?.length > 0) {
						document.getElementById('calculation-examples').checked = true;
					}
					if (structuredContent.methods?.length > 0) {
						document.getElementById('method-section').checked = true;
					}
					if (structuredContent.tooltips?.length > 0) {
						document.getElementById('tooltips').checked = true;
					}
					if (structuredContent.popups?.length > 0) {
						document.getElementById('collapsible-sections').checked = true;
					}
					
					// Mettre à jour l'état
					state.enhancedContent.useEnhanced = true;
					state.enhancedContent.useDefinitionBox = structuredContent.definitions?.length > 0;
					state.enhancedContent.useCalculationExamples = structuredContent.exercises?.length > 0;
					state.enhancedContent.useMethodSection = structuredContent.methods?.length > 0;
					state.enhancedContent.useTooltips = structuredContent.tooltips?.length > 0;
					state.enhancedContent.useCollapsibleSections = structuredContent.popups?.length > 0;
				}
			}
			
			/**
			 * Génère le HTML de notification pour les onglets créés
			 */
			function generateNotificationHTML(extractedData) {
				// Compter les éléments structurés
				let structuredItems = 0;
				structuredItems += extractedData.structuredContent.definitions?.length || 0;
				structuredItems += extractedData.structuredContent.exercises?.length || 0;
				structuredItems += extractedData.structuredContent.methods?.length || 0;
				structuredItems += extractedData.structuredContent.tables?.length || 0;
				structuredItems += extractedData.structuredContent.tooltips?.length || 0;
				structuredItems += extractedData.structuredContent.popups?.length || 0;
				structuredItems += extractedData.structuredContent.iframes?.length || 0;
				
				// Vérifier la présence d'onglets spéciaux
				const biblioCount = extractedData.tabs.filter(tab => tab.specialType === 'B').length;
				const glossCount = extractedData.tabs.filter(tab => tab.specialType === 'G').length;
				
				// Construire le HTML
				let infoHtml = `
					<p style="margin: 0; font-weight: 500;">Les onglets ont été générés avec succès ! ${extractedData.tabs.length} onglets avec contenu ont été trouvés et générés automatiquement.</p>
				`;
				
				if (extractedData.presentation) {
					infoHtml += '<p style="margin: 5px 0 0 0; font-size: 0.9rem;">Description de présentation trouvée et ajoutée.</p>';
				}
				
				if (structuredItems > 0) {
					const definitionCount = extractedData.structuredContent.definitions?.length || 0;
					const exerciseCount = extractedData.structuredContent.exercises?.length || 0;
					const methodCount = extractedData.structuredContent.methods?.length || 0;
					
					infoHtml += `
						<p style="margin: 5px 0 0 0; font-size: 0.9rem;">
							${structuredItems} éléments structurés trouvés:
							${definitionCount > 0 ? `<span style="color: #4caf50;">${definitionCount} définition(s)</span>` : ''}
							${exerciseCount > 0 ? `<span style="color: #2196f3;">${exerciseCount > 0 && definitionCount > 0 ? ', ' : ''}${exerciseCount} exercice(s)</span>` : ''}
							${methodCount > 0 ? `<span style="color: #ff9800;">${methodCount > 0 && (exerciseCount > 0 || definitionCount > 0) ? ', ' : ''}${methodCount} méthode(s)</span>` : ''}
							${(extractedData.structuredContent.tables?.length || 0) > 0 ? `<span style="color: #9c27b0;">${(methodCount > 0 || exerciseCount > 0 || definitionCount > 0) ? ', ' : ''}${extractedData.structuredContent.tables.length} tableau(x)</span>` : ''}
							${(extractedData.structuredContent.tooltips?.length || 0) > 0 ? `<span style="color: #e91e63;">${(extractedData.structuredContent.tables?.length > 0 || methodCount > 0 || exerciseCount > 0 || definitionCount > 0) ? ', ' : ''}${extractedData.structuredContent.tooltips.length} info-bulle(s)</span>` : ''}
							${(extractedData.structuredContent.popups?.length || 0) > 0 ? `<span style="color: #607d8b;">${(extractedData.structuredContent.tooltips?.length > 0 || extractedData.structuredContent.tables?.length > 0 || methodCount > 0 || exerciseCount > 0 || definitionCount > 0) ? ', ' : ''}${extractedData.structuredContent.popups.length} popup(s)</span>` : ''}
							${(extractedData.structuredContent.iframes?.length || 0) > 0 ? `<span style="color: #00bcd4;">${(extractedData.structuredContent.popups?.length > 0 || extractedData.structuredContent.tooltips?.length > 0 || extractedData.structuredContent.tables?.length > 0 || methodCount > 0 || exerciseCount > 0 || definitionCount > 0) ? ', ' : ''}${extractedData.structuredContent.iframes.length} iframe(s)</span>` : ''}
						</p>
					`;
				}
				
				if (biblioCount > 0 || glossCount > 0) {
					infoHtml += `
						<p style="margin: 5px 0 0 0; font-size: 0.9rem;">
							Onglets spéciaux créés: 
							${biblioCount > 0 ? `<span style="color: #9c27b0;">${biblioCount} bibliographie</span>` : ''}
							${glossCount > 0 ? `<span style="color: #9c27b0;">${glossCount > 0 && biblioCount > 0 ? ', ' : ''}${glossCount} glossaire</span>` : ''}
						</p>
					`;
				}
				
				return infoHtml;
			}			
			
			
			
			
			/**
			 * Construit le prompt pour l'IA
			 */
			function buildAIPrompt(rawText, subject, level) {
				return `Tu es un expert en pédagogie et création de matériel didactique pour l'enseignement du/de la ${subject} au niveau ${level}. 
				
			Je te donne un texte brut décrivant les objectifs d'une application pédagogique. 
			Ta mission est d'analyser ce texte et de le restructurer en utilisant les balises spécifiques pour créer une application pédagogique bien organisée.
			
			BALISES DISPONIBLES:
			- #P [Titre] - Pour définir une description générale (tout le texte jusqu'à la prochaine balise)
			- #1, #2, #3, etc. - Pour définir le titre d'un onglet numéroté (tout le texte jusqu'à la prochaine balise sera le contenu de cet onglet)
			- #B [Titre optionnel] - Pour créer un onglet de bibliographie
			- #G [Titre optionnel] - Pour créer un onglet de glossaire
			- #S [Titre optionnel] - Pour créer un onglet de sitographie
			- #C Certification - Pour créer un onglet certification / remarque : activer l'option dernier onglet certiciation et certificat avec toutes ses options et mot de passe aprdéfaurt 0000
			- ##D [Titre définition] - Pour définir une définition à inclure dans un cadre spécial
			- ##E [Titre exercice] - Pour définir un exercice ou exemple à inclure dans un cadre spécial
			- ##M [Titre méthode] - Pour définir une méthode à inclure dans un cadre spécial
			- ##T [Titre tableau] - Pour créer un tableau avec la syntaxe: /colonne1/colonne2/colonne3/... avec // pour ligne de titre
			- ##IB [Titre] - Pour créer des info-bulles pour des termes techniques (liste de termes séparés par des ";")
			- ##PP [Titre] - Pour créer des popups modaux pour expliquer des concepts (liste de concepts séparés par des ";")
			- ##IFM [Titre] - Pour intégrer le gestionnaire d'iframes personnalisé
			- ##AJ [description] pour activité interactive jointe : utiliser une application jointe au prompt de création
			- ##APP [description] pour activité interactive à créer
			- ##FC [nombre] pour Flashcards : remarques les options flascards par défaut est 5 et doivent être activés dans cet onglet

			
			DIRECTIVES:
			1. Analyse le texte pour identifier les concepts clés, objectifs pédagogiques et structure implicite
			2. Crée une structure logique avec 3 à 5 onglets numérotés (#1, #2, etc.)
			3. Commence par la balise #P pour une introduction générale qui explique l'objectif de l'applicatio
			4. Organise le contenu par thèmes dans les différents onglets
			5. Identifie les définitions importantes et utilise ##D pour les mettre en valeur
			6. Dans l'onglet #1 propose un iframe personnalisé ##IFM avec un lien ou une vidéo trouvé sur Internet pour illustrer le sujet
			7. Identifie des exemples ou exercices pertinents et utilise ##E 
			8. Identifie des méthodes pédagogiques et utilise ##M
			9. Si l'application est destinée à des élèves, créer obligatoirement un onglet révision avec 20 flashcards
			10. Si l'application est destinée à la formation, crée un glossaire (#G) et une bibliographie (#B) si pertinent
			11. Identifie les termes techniques qui bénéficieraient d'info-bulles (##IB) et les concepts qui méritent des popups (##PP)
			
			VOICI LE TEXTE À ANALYSER ET RESTRUCTURER:
			${rawText}
			
			RÉPONSE:
			Ne me réponds qu'avec la version restructurée avec les balises, sans aucun autre texte ni explication. Le texte doit être directement utilisable.`;
			}
			
			/**
			 * Appelle le service d'IA approprié
			 */
			async function callAIService(service, serviceConfig, prompt) {
				let endpoint, headers, body, resultText;
				
				// Configuration selon le service
				switch(service) {
					case 'claude':
						endpoint = 'https://api.anthropic.com/v1/messages';
						headers = {
							'Content-Type': 'application/json',
							'x-api-key': serviceConfig.key,
							'anthropic-version': '2023-06-01'
						};
						body = {
							model: serviceConfig.model,
							max_tokens: 4000,
							temperature: 0.3,
							messages: [{ role: "user", content: prompt }]
						};
						break;
						
					case 'openai':
						endpoint = 'https://api.openai.com/v1/chat/completions';
						headers = {
							'Content-Type': 'application/json',
							'Authorization': `Bearer ${serviceConfig.key}`
						};
						body = {
							model: serviceConfig.model,
							messages: [{ role: "user", content: prompt }],
							max_tokens: 4000,
							temperature: 0.3
						};
						break;
						
					case 'mistral':
						endpoint = 'https://api.mistral.ai/v1/chat/completions';
						headers = {
							'Content-Type': 'application/json',
							'Authorization': `Bearer ${serviceConfig.key}`
						};
						body = {
							model: serviceConfig.model,
							messages: [{ role: "user", content: prompt }],
							max_tokens: 4000,
							temperature: 0.3
						};
						break;
						
					case 'gemini':
						endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/' + 
								  serviceConfig.model + ':generateContent?key=' + serviceConfig.key;
						headers = {
							'Content-Type': 'application/json'
						};
						body = {
							contents: [{ parts: [{ text: prompt }] }],
							generationConfig: {
								temperature: 0.3,
								maxOutputTokens: 4000
							}
						};
						break;
				}
				
				// Effectuer la requête
				const response = await fetch(endpoint, {
					method: 'POST',
					headers: headers,
					body: JSON.stringify(body)
				});
				
				if (!response.ok) {
					throw new Error(`Erreur API (${response.status}): ${response.statusText}`);
				}
				
				const data = await response.json();
				
				// Extraire le texte de la réponse selon le service
				if (service === 'claude') {
					resultText = data.content?.[0]?.text || "";
				} else if (service === 'openai' || service === 'mistral') {
					resultText = data.choices?.[0]?.message?.content || "";
				} else if (service === 'gemini') {
					resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
				}
				
				return resultText.trim();
			}
			
			/**
			 * Affiche un message de statut pour l'analyse IA
			 */
			function showAIAnalysisStatus(message, type, isLoading = false) {
				const statusElement = document.getElementById('ai-analysis-status');
				statusElement.textContent = message;
				statusElement.className = `alert alert-${type}`;
				
				if (isLoading) {
					// Ajouter un spinner si en cours de chargement
					statusElement.innerHTML = `
						<div style="display: flex; align-items: center; gap: 10px;">
							<div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;"></div>
							<span>${message}</span>
						</div>
						<style>
							@keyframes spin {
								0% { transform: rotate(0deg); }
								100% { transform: rotate(360deg); }
							}
						</style>
					`;
				}
				
				statusElement.style.display = 'block';
				
				// Masquer le message après 5 secondes sauf si c'est un chargement
				if (!isLoading) {
					setTimeout(() => {
						statusElement.style.display = 'none';
					}, 5000);
				}
			}
			
			/**
			 * Applique une animation de surbrillance à la zone de texte
			 */
			function highlightTextarea() {
				const textarea = document.getElementById('objectives');
				const originalBorder = textarea.style.border;
				const originalBackground = textarea.style.backgroundColor;
				
				// Appliquer l'animation
				textarea.style.transition = 'all 0.5s ease';
				textarea.style.border = '2px solid #4caf50';
				textarea.style.backgroundColor = '#e8f5e9';
				
				// Rétablir le style d'origine après l'animation
				setTimeout(() => {
					textarea.style.border = originalBorder;
					textarea.style.backgroundColor = originalBackground;
				}, 2000);
			}
            

            // Set up event listeners
            function setupEventListeners() {
                // Navigation buttons
                document.getElementById('next-button').addEventListener('click', nextStep);
                document.getElementById('prev-button').addEventListener('click', prevStep);
                document.getElementById('copy-button').addEventListener('click', copyPrompt);
                document.getElementById('download-button').addEventListener('click', downloadPrompt);
                document.getElementById('share-button').addEventListener('click', sharePrompt);
                
                // Top bar actions
                document.getElementById('importBtn').addEventListener('click', importState);
                document.getElementById('exportBtn').addEventListener('click', exportState);
                document.getElementById('previewBtn').addEventListener('click', generatePreview);
                document.getElementById('settingsBtn').addEventListener('click', function() {
                    document.getElementById('settingsMenu').classList.toggle('hidden');
                });
                document.getElementById('clearData').addEventListener('click', clearData);
                
				
				// Bouton d'analyse avec IA
				document.getElementById('analyze-with-ai-btn').addEventListener('click', function() {
					analyzeTextWithAI();
				});                
								
                
				// Gestion des couleurs du style sobre
				document.querySelectorAll('.sober-color-option').forEach(option => {
					option.addEventListener('click', function() {
						// Mettre à jour la couleur sobre
						const color = this.getAttribute('data-color');
						const secondaryColor = this.getAttribute('data-secondary');
						const colorName = this.getAttribute('data-value');
						
						// Mettre à jour l'état
						state.soberColor = color;
						state.soberSecondaryColor = secondaryColor;
						state.soberColorOption = colorName;
						
						// Mettre à jour la classe de sélection
						document.querySelectorAll('.sober-color-option').forEach(opt => {
							opt.classList.remove('selected');
						});
						this.classList.add('selected');
						
						// Mettre à jour l'aperçu
						updateSoberPreview();
						
						// Si les onglets utilisent les couleurs du style, synchroniser
						if (!state.useTabColors || !state.tabColorsCustomized) {
							syncTabColorsWithStyle();
						}
						
						scheduleAutoSave();
					});
				});
                
                
                
                // Close settings menu when clicking outside
                document.addEventListener('click', function(e) {
                    const settingsBtn = document.getElementById('settingsBtn');
                    const settingsMenu = document.getElementById('settingsMenu');
                    
                    if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                        settingsMenu.classList.add('hidden');
                    }
                });
                
                // Preview panel
                document.getElementById('preview-close').addEventListener('click', hidePreview);
                
                // Subject selection
                document.getElementById('subject').addEventListener('change', function() {
                    state.subject = this.value;
                    updateCustomSubjectField();
                    updateDomainOptions();
                    scheduleAutoSave();
                });
                
                // Custom subject
                document.getElementById('custom-subject').addEventListener('input', function() {
                    state.customSubject = this.value;
                    scheduleAutoSave();
                });
                
                // Levels selection
				document.querySelectorAll('input[name="level"]').forEach(radio => {
					radio.addEventListener('change', function() {
						if (this.checked) {
							// Remplacer le tableau des niveaux par un tableau avec un seul élément
							state.levels = [this.value];
							updateSelectedLevelsDisplay();
							scheduleAutoSave();
						}
					});
				});
                
                // Objectives
                document.getElementById('objectives').addEventListener('input', function() {
                    state.objectives = this.value;
                    scheduleAutoSave();
                });
                
                
			// Home tabs slider
			document.getElementById('home-tabs-count').addEventListener('input', function() {
				const count = parseInt(this.value);
				document.getElementById('home-tabs-value').textContent = count;
				
				// Update preview
				const previewContainer = document.getElementById('home-tabs-preview');
				previewContainer.innerHTML = '';
				
				for (let i = 1; i <= count; i++) {
					const span = document.createElement('span');
					span.className = 'template-flow-item';
					span.style.fontSize = '0.8rem';
					span.textContent = `À la maison ${i}`;
					previewContainer.appendChild(span);
				}
				
				// If flipped template is already selected, update tabs
				if (state.selectedTemplate === 'flipped') {
					state.flippedClassroomTabs = count;
					initializeTabs();
					scheduleAutoSave();
				}
			});
                
                // Template selection
                document.querySelectorAll('.template-card').forEach(card => {
                    card.addEventListener('click', function() {
                        selectTemplate(this.id);
                    });
                });
                
				// Template tab count
				document.getElementById('template-tab-count').addEventListener('input', function() {
					const newCount = parseInt(this.value);
					document.getElementById('template-tab-count-display').textContent = newCount;
					
					// Mettre à jour l'état uniquement si le template-none est sélectionné
					if (state.selectedTemplate === 'none') {
						state.tabCount = newCount;
						state._isTabCountUserModified = true;
						initializeTabs();
						
						// Mettre à jour l'affichage à l'étape 4 si nécessaire
						const tabsCountDisplay = document.getElementById('tabs-count-display');
						if (tabsCountDisplay) {
							tabsCountDisplay.textContent = newCount;
						}
						
						scheduleAutoSave();
					}
				});                
                

                // SVG count
                document.getElementById('svg-count').addEventListener('change', function() {
                    state.svgCount = parseInt(this.value);
                    initializeSvgIllustrations();
                    scheduleAutoSave();
                });
                
                // Additional notes
                document.getElementById('additional-notes').addEventListener('input', function() {
                    state.additionalNotes = this.value;
                    scheduleAutoSave();
                });
                
                // Style radio buttons
                document.querySelectorAll('input[name="interface-style"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            state.interfaceStyle = this.value;
                            updateStylePreviews();
                            
                            // Synchroniser les couleurs des onglets si elles ne sont pas personnalisées
                            if (!state.useTabColors || !state.tabColorsCustomized) {
                                syncTabColorsWithStyle();
                            }
                            
                            scheduleAutoSave();
                        }
                    });
                });
                
                // Gradient color
                document.getElementById('gradient-color').addEventListener('input', function() {
                    state.gradientColor = this.value;
                    updateColorPreview('gradient-color', 'gradient-color-preview');
                    updateGradientPreview();
                    
                    // Synchroniser les couleurs si style gradient est utilisé et que les onglets ne sont pas personnalisés
                    if (state.interfaceStyle === 'gradient' && (!state.useTabColors || !state.tabColorsCustomized)) {
                        syncTabColorsWithStyle();
                    }
                    
                    scheduleAutoSave();
                });
                
                // Advanced navigation
                document.getElementById('advanced-navigation').addEventListener('change', function() {
                    state.advancedNavigation = this.checked;
                    document.getElementById('navigation-options').classList.toggle('hidden', !this.checked);
                    scheduleAutoSave();
                });
                
                // Tab colors option
                document.getElementById('use-tab-colors').addEventListener('change', function() {
                    state.useTabColors = this.checked;
                    
                    // Si l'option est désactivée, synchroniser avec le style sélectionné
                    if (!this.checked) {
                        syncTabColorsWithStyle();
                    } else {
                        // Marquer comme personnalisé uniquement si c'était déjà le cas
                        if (state.tabColorsCustomized) {
                            // Les couleurs restent personnalisées
                        } else {
                            // Garder les couleurs actuelles mais ne pas marquer comme personnalisé
                            // (les couleurs sont déjà synchronisées avec le style)
                        }
                    }
                    
                    // Mettre à jour l'affichage des options de couleur dans l'interface
                    document.querySelectorAll('.tab-color-input').forEach(input => {
                        const colorContainer = input.parentElement.parentElement;
                        if (colorContainer) {
                            colorContainer.style.display = this.checked ? 'block' : 'none';
                        }
                    });
                    
                    // Mettre à jour le message d'information
                    updateStyleTabsInfo();
                    
                    // Mettre à jour l'affichage des onglets
                    renderTabs();
                    
                    scheduleAutoSave();
                });
                
                // Certificate checkbox
                document.getElementById('certificate').addEventListener('change', function() {
                    state.useCertificate = this.checked;
                    document.getElementById('certificate-options').classList.toggle('hidden', !this.checked);
                    
                    // Synchroniser avec l'étape 3
                    const certificateCheck = document.getElementById('use-certificate');
                    if (certificateCheck) {
                        certificateCheck.checked = this.checked;
                        document.getElementById('certificate-options-step3').classList.toggle('hidden', !this.checked);
                    }
                    
                    scheduleAutoSave();
                });
                


				// Bouton GÉNÉRER ONGLETS
				document.getElementById('generate-tabs-button').addEventListener('click', function() {
					// Vérifier s'il y a des titres extraits avant d'initialiser les onglets
					if (state.extractedTabTitles.length > 0) {
						// Si des titres ont été extraits, s'assurer que le modèle est "none"
						if (state.selectedTemplate !== 'none') {
							// Changer le modèle en structure personnalisée
							selectTemplate('template-none');
						} else {
							// Réinitialiser et recréer tous les onglets
							initializeTabs();
						}
					} else {
						// Comportement original
						initializeTabs();
					}
					
					// Afficher le message de confirmation
					const updateInfo = document.getElementById('tabs-update-info');
					if (updateInfo) {
						updateInfo.style.display = 'block';
						
						// Personnaliser le message si des titres et contenus ont été extraits
						if (state.extractedTabTitles.length > 0) {
							let infoText = generateNotificationHTML({
								tabs: state.extractedTabTitles.map((title, index) => ({
									title: title,
									content: state.extractedTabContents[index] || '',
									specialType: title.includes('Bibliographie') ? 'B' : (title.includes('Glossaire') ? 'G' : null)
								})),
								presentation: state.extractedPresentation,
								structuredContent: state.structuredContent || {
									definitions: [],
									exercises: [],
									methods: [],
									tables: [],
									tooltips: [],
									popups: [],
									iframes: []
								}
							});
							
							updateInfo.innerHTML = infoText;
						} else {
							updateInfo.innerHTML = `<p style="margin: 0; font-weight: 500;">Les onglets ont été générés avec succès selon vos options !</p>`;
						}
						
						// Ajouter une classe d'animation pour attirer l'attention
						updateInfo.classList.add('animate-fade');
						
						// Masquer le message après quelques secondes
						setTimeout(() => {
							updateInfo.style.display = 'none';
							updateInfo.classList.remove('animate-fade');
						}, 5000);
					}
					
					// Faire défiler vers le conteneur des onglets
					const tabsContainer = document.getElementById('tabs-container');
					if (tabsContainer) {
						setTimeout(() => {
							tabsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
						}, 300);
					}
				});


                // Améliorer la visualisation de l'option du certificat
                function updateCertificateBadgeVisibility() {
                    const badges = document.querySelectorAll('.certificate-badge');
                    
                    badges.forEach(badge => {
                        const container = badge.closest('.certificate-highlight');
                        
                        // Si le conteneur n'est pas caché, mettre à jour le badge
                        if (container && !container.classList.contains('hidden')) {
                            let isEnabled = false;
                            const useCertificateStep3 = document.getElementById('use-certificate');
                            const certificateStep4 = document.getElementById('certificate');
                            
                            if (useCertificateStep3 && useCertificateStep3.checked) {
                                isEnabled = true;
                            }
                            
                            if (certificateStep4 && certificateStep4.checked) {
                                isEnabled = true;
                            }
                            
                            badge.textContent = isEnabled ? 'Activé' : 'Désactivé';
                            badge.style.backgroundColor = isEnabled ? '#ffd54f' : '#e0e0e0';
                        }
                    });
                }
                
                // Mettre à jour la visibilité du badge lors du changement des cases à cocher du certificat
                const certificateCheckboxes = ['use-certificate', 'certificate'];
                certificateCheckboxes.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', updateCertificateBadgeVisibility);
                    }
                });
                
                // Initialiser l'état des badges au chargement
                updateCertificateBadgeVisibility();
                
                // Mettre à jour l'aperçu du certificat lors des changements de couleur
                function updateCertificatePreview(colorType, value) {
                    const previewContainers = document.querySelectorAll('.certificate-preview-container');
                    
                    previewContainers.forEach(container => {
                        if (colorType === 'border') {
                            const certificateEl = container.querySelector('div[style*="border: 5px solid"]');
                            if (certificateEl) {
                                certificateEl.style.borderColor = value;
                            }
                        } else if (colorType === 'score') {
                            const scoreEl = container.querySelector('div[style*="color: #455a64"]');
                            if (scoreEl) {
                                scoreEl.style.color = value;
                            }
                        }
                    });
                }
                
                // Écouter les changements de couleur de bordure
                const borderColorInputs = ['certificate-border-color-step3', 'certificate-border-color'];
                borderColorInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', function() {
                            updateCertificatePreview('border', this.value);
                        });
                    }
                });
                
                // Écouter les changements de couleur de score
                const scoreColorInputs = ['certificate-score-color-step3', 'certificate-score-color'];
                scoreColorInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', function() {
                            updateCertificatePreview('score', this.value);
                        });
                    }
                });
                
                
				// Écouteurs pour l'option de mot de passe du certificat
				document.getElementById('certificate-password').addEventListener('change', function() {
					state.certificateOptions.usePassword = this.checked;
					document.getElementById('password-options').style.display = this.checked ? 'block' : 'none';
					
					// Synchroniser avec l'étape 3
					const passwordCheckStep3 = document.getElementById('certificate-password-step3');
					if (passwordCheckStep3) {
						passwordCheckStep3.checked = this.checked;
						document.getElementById('password-options-step3').style.display = this.checked ? 'block' : 'none';
					}
					
					scheduleAutoSave();
				});
				
				document.getElementById('certificate-password-step3').addEventListener('change', function() {
					state.certificateOptions.usePassword = this.checked;
					document.getElementById('password-options-step3').style.display = this.checked ? 'block' : 'none';
					
					// Synchroniser avec l'étape 4
					const passwordCheck = document.getElementById('certificate-password');
					if (passwordCheck) {
						passwordCheck.checked = this.checked;
						document.getElementById('password-options').style.display = this.checked ? 'block' : 'none';
					}
					
					scheduleAutoSave();
				});
				
				document.getElementById('certificate-password-value').addEventListener('input', function() {
					// Limiter à 4 chiffres
					if (this.value.length > 4) {
						this.value = this.value.slice(0, 4);
					}
					
					state.certificateOptions.passwordValue = this.value;
					
					// Synchroniser avec l'étape 3
					const passwordValueStep3 = document.getElementById('certificate-password-value-step3');
					if (passwordValueStep3) {
						passwordValueStep3.value = this.value;
					}
					
					scheduleAutoSave();
				});
				
				document.getElementById('certificate-password-value-step3').addEventListener('input', function() {
					// Limiter à 4 chiffres
					if (this.value.length > 4) {
						this.value = this.value.slice(0, 4);
					}
					
					state.certificateOptions.passwordValue = this.value;
					
					// Synchroniser avec l'étape 4
					const passwordValue = document.getElementById('certificate-password-value');
					if (passwordValue) {
						passwordValue.value = this.value;
					}
					
					scheduleAutoSave();
				});                
                
                
                
                
                // Setup all other event listeners for checkboxes, inputs, etc.
                setupFormEventListeners();
                
				// Gestionnaire pour l'importation de fichier texte pour les objectifs
				document.getElementById('objectives-file').addEventListener('change', function(e) {
					const fileStatus = document.getElementById('file-import-status');
					fileStatus.style.display = 'block';
					
					if (this.files && this.files[0]) {
						const file = this.files[0];
						if (file.type !== 'text/plain') {
							fileStatus.textContent = 'Erreur : Veuillez sélectionner un fichier texte (.txt)';
							fileStatus.className = 'alert alert-danger';
							return;
						}
						
						fileStatus.textContent = 'Fichier sélectionné : ' + file.name;
						fileStatus.className = 'alert alert-info';
						
						// Activer les boutons
						document.getElementById('replace-objectives').disabled = false;
						document.getElementById('append-objectives').disabled = false;
					} else {
						fileStatus.textContent = 'Aucun fichier sélectionné';
						fileStatus.className = 'alert alert-warning';
						
						// Désactiver les boutons
						document.getElementById('replace-objectives').disabled = true;
						document.getElementById('append-objectives').disabled = true;
					}
				});

				
				// Gestionnaire pour remplacer le contenu des objectifs
				document.getElementById('replace-objectives').addEventListener('click', function() {
					const fileInput = document.getElementById('objectives-file');
					const fileStatus = document.getElementById('file-import-status');
					
					if (fileInput.files && fileInput.files[0]) {
						const file = fileInput.files[0];
						const reader = new FileReader();
						
						reader.onload = function(e) {
							const content = e.target.result;
							document.getElementById('objectives').value = content;
							state.objectives = content;
							
							// Extraire les titres, contenus et éléments structurés
							const extractedData = extractTabContentsFromText(content);
							
							// Vérifications de sécurité pour éviter erreurs potentielles
							if (!extractedData.structuredContent) {
								extractedData.structuredContent = {
									definitions: [],
									exercises: [],
									methods: []
								};
							}
							
							// Compter les éléments structurés pour les rapports
							let structuredItems = 0;
							structuredItems += extractedData.structuredContent.definitions.length || 0;
							structuredItems += extractedData.structuredContent.exercises.length || 0;
							structuredItems += extractedData.structuredContent.methods.length || 0;
							structuredItems += extractedData.structuredContent.tables?.length || 0;
							structuredItems += extractedData.structuredContent.tooltips?.length || 0;
							structuredItems += extractedData.structuredContent.popups?.length || 0;
							structuredItems += extractedData.structuredContent.iframes?.length || 0;
														
							
							
							// Stocker les données extraites dans l'état
							if (extractedData.tabs.length > 0) {
								state.extractedTabTitles = extractedData.tabs.map(tab => tab.title);
								state.extractedTabContents = extractedData.tabs.map(tab => tab.content);
								
								// Stocker la présentation si elle existe
								if (extractedData.presentation) {
									state.extractedPresentation = extractedData.presentation;
								}
								
								// Stocker le contenu structuré
								state.structuredContent = extractedData.structuredContent;
								
								// Activer l'option de formatage amélioré si du contenu structuré a été trouvé
								if (structuredItems > 0) {
									// Activer l'option "Formatage amélioré du contenu"
									document.getElementById('use-enhanced-content').checked = true;
									document.getElementById('enhanced-content-options').classList.remove('hidden');
									
									// Activer les options spécifiques selon le contenu trouvé
									if (extractedData.structuredContent.definitions.length > 0) {
										document.getElementById('definition-box').checked = true;
									}
									if (extractedData.structuredContent.exercises.length > 0) {
										document.getElementById('calculation-examples').checked = true;
									}
									if (extractedData.structuredContent.methods.length > 0) {
										document.getElementById('method-section').checked = true;
									}
									
									// Mettre à jour l'état
									state.enhancedContent.useEnhanced = true;
									state.enhancedContent.useDefinitionBox = extractedData.structuredContent.definitions.length > 0;
									state.enhancedContent.useCalculationExamples = extractedData.structuredContent.exercises.length > 0;
									state.enhancedContent.useMethodSection = extractedData.structuredContent.methods.length > 0;
								}
								
								// NOUVEAU CODE: Sélectionner automatiquement la structure personnalisée
								selectTemplate('template-none');
								
								// NOUVEAU CODE: Afficher un message dans le tab-update-info (qui se trouve à l'étape 4)
								const tabUpdateInfo = document.getElementById('tabs-update-info');
								if (tabUpdateInfo) {
									tabUpdateInfo.style.display = 'block';
									
									// Construire le message avec les informations sur le contenu structuré
									let infoHtml = `
										<p style="margin: 0; font-weight: 500;">Les onglets ont été générés avec succès ! ${extractedData.tabs.length} onglets avec contenu ont été trouvés et générés automatiquement.</p>
									`;
									
									if (extractedData.presentation) {
										infoHtml += '<p style="margin: 5px 0 0 0; font-size: 0.9rem;">Description de présentation trouvée et ajoutée.</p>';
									}
									
									if (structuredItems > 0) {
										const definitionCount = extractedData.structuredContent.definitions.length || 0;
										const exerciseCount = extractedData.structuredContent.exercises.length || 0;
										const methodCount = extractedData.structuredContent.methods.length || 0;
										
										infoHtml += `
											<p style="margin: 5px 0 0 0; font-size: 0.9rem;">
												${structuredItems} éléments structurés trouvés:
												${definitionCount > 0 ? `<span style="color: #4caf50;">${definitionCount} définition(s)</span>` : ''}
												${exerciseCount > 0 ? `<span style="color: #2196f3;">${exerciseCount} exercice(s)</span>` : ''}
												${methodCount > 0 ? `<span style="color: #ff9800;">${methodCount} méthode(s)</span>` : ''}
												${(extractedData.structuredContent.tables?.length || 0) > 0 ? `<span style="color: #9c27b0;">${extractedData.structuredContent.tables.length} tableau(x)</span>` : ''}
												${(extractedData.structuredContent.tooltips?.length || 0) > 0 ? `<span style="color: #e91e63;">${extractedData.structuredContent.tooltips.length} info-bulle(s)</span>` : ''}
												${(extractedData.structuredContent.popups?.length || 0) > 0 ? `<span style="color: #607d8b;">${extractedData.structuredContent.popups.length} popup(s)</span>` : ''}
												${(extractedData.structuredContent.iframes?.length || 0) > 0 ? `<span style="color: #00bcd4;">${extractedData.structuredContent.iframes.length} iframe(s)</span>` : ''}
											</p>
										`;
									}
									
									// Vérifier la présence d'onglets spéciaux
									const biblioCount = extractedData.tabs.filter(tab => tab.specialType === 'B').length;
									const glossCount = extractedData.tabs.filter(tab => tab.specialType === 'G').length;
									
									if (biblioCount > 0 || glossCount > 0) {
										infoHtml += `
											<p style="margin: 5px 0 0 0; font-size: 0.9rem;">
												Onglets spéciaux créés: 
												${biblioCount > 0 ? `<span style="color: #9c27b0;">${biblioCount} bibliographie</span>` : ''}
												${glossCount > 0 ? `<span style="color: #9c27b0;">${glossCount > 0 && biblioCount > 0 ? ', ' : ''}${glossCount} glossaire</span>` : ''}
											</p>
										`;
									}
									
									tabUpdateInfo.innerHTML = infoHtml;
									tabUpdateInfo.classList.add('animate-fade');
								}
								
								// NOUVEAU CODE: Ajouter une classe visuelle pour indiquer la sélection
								document.getElementById('template-none').classList.add('selected');
								
								// NOUVEAU CODE: Afficher un message plus explicite dans le statut
								let statusMessage = `Contenu remplacé avec succès ! ${extractedData.tabs.length} onglets`;
								
								if (structuredItems > 0) {
									statusMessage += ` et ${structuredItems} éléments structurés`;
								}
								
								if (biblioCount > 0 || glossCount > 0) {
									statusMessage += `, dont ${biblioCount + glossCount} onglet(s) spécial(aux)`;
								}
								
								statusMessage += ` ont été trouvés.`;
								
								fileStatus.textContent = statusMessage;
								fileStatus.className = 'alert alert-success';
							} else {
								fileStatus.textContent = 'Contenu remplacé avec succès !';
								fileStatus.className = 'alert alert-success';
							}
							
							scheduleAutoSave();
							setTimeout(() => {
								fileStatus.style.display = 'none';
								fileInput.value = '';
							}, 3000);
						};
						
						reader.onerror = function() {
							fileStatus.textContent = 'Erreur lors de la lecture du fichier';
							fileStatus.className = 'alert alert-danger';
						};
						
						reader.readAsText(file);
					}
				});				
								
				// Gestionnaire pour ajouter à la suite des objectifs
				document.getElementById('append-objectives').addEventListener('click', function() {
					const fileInput = document.getElementById('objectives-file');
					const fileStatus = document.getElementById('file-import-status');
					
					if (fileInput.files && fileInput.files[0]) {
						const file = fileInput.files[0];
						const reader = new FileReader();
						
						reader.onload = function(e) {
							const content = e.target.result;
							const currentContent = document.getElementById('objectives').value;
							
							// Ajouter un saut de ligne si nécessaire
							const newContent = currentContent 
								? (currentContent.endsWith('\n') ? currentContent : currentContent + '\n\n') + content
								: content;
							
							document.getElementById('objectives').value = newContent;
							state.objectives = newContent;
							
							// Extraire les titres et contenus
							const extractedData = extractTabContentsFromText(newContent);
							
							// Stocker les données extraites dans l'état
							if (extractedData.tabs.length > 0) {
								state.extractedTabTitles = extractedData.tabs.map(tab => tab.title);
								state.extractedTabContents = extractedData.tabs.map(tab => tab.content);
								
								// Stocker la présentation si elle existe
								if (extractedData.presentation) {
									state.extractedPresentation = extractedData.presentation;
								}
								
								// NOUVEAU CODE: Sélectionner automatiquement la structure personnalisée
								selectTemplate('template-none');
								
								// NOUVEAU CODE: Afficher un message dans le tab-update-info (qui se trouve à l'étape 4)
								const tabUpdateInfo = document.getElementById('tabs-update-info');
								if (tabUpdateInfo) {
									tabUpdateInfo.style.display = 'block';
									tabUpdateInfo.innerHTML = `
										<p style="margin: 0; font-weight: 500;">Les onglets ont été générés avec succès ! ${extractedData.tabs.length} onglets ont été créés à partir de votre fichier texte.</p>
										${extractedData.presentation ? '<p style="margin: 5px 0 0 0; font-size: 0.9rem;">Description de présentation trouvée et ajoutée.</p>' : ''}
									`;
									tabUpdateInfo.classList.add('animate-fade');
								}
								
								
								// NOUVEAU CODE: Ajouter une classe visuelle pour indiquer la sélection
								document.getElementById('template-none').classList.add('selected');
								
								// NOUVEAU CODE: Afficher un message plus explicite dans le statut
								fileStatus.textContent = `Contenu ajouté avec succès ! ${extractedData.tabs.length} onglets avec contenu ont été trouvés et générés automatiquement.`;
								fileStatus.className = 'alert alert-success';
							} else {
								fileStatus.textContent = 'Contenu ajouté avec succès !';
								fileStatus.className = 'alert alert-success';
							}
							
							scheduleAutoSave();
							setTimeout(() => {
								fileStatus.style.display = 'none';
								fileInput.value = '';
							}, 3000);
						};
				
						reader.onerror = function() {
							fileStatus.textContent = 'Erreur lors de la lecture du fichier';
							fileStatus.className = 'alert alert-danger';
						};
						
						reader.readAsText(file);
					}
				});


            }
            
            // Set up event listeners for all form elements
            function setupFormEventListeners() {
                // General checkboxes
                const checkboxMapping = {
                    'latex': 'useLatex',
                    'comma': 'useCommaDecimal',
                    'show-decimal': 'showDecimalOptions',
                    'fullscreen': 'useFullscreen',
                    'adaptive-layout': 'useAdaptiveLayout',
                    'use-logo': 'useLogo', 
                    'use-flashcards': 'useFlashcards',
                    'use-gamification': 'useGamification',
                    'use-adaptive-assessment': 'useAdaptiveAssessment',
                    'use-tab-colors': 'useTabColors',
                    'use-tab-icons': 'useTabIcons',
                    'include-quiz': 'includeQuiz',
                    'use-enhanced-content': 'enhancedContent.useEnhanced',
                    'use-version': 'useVersion',
                    'use-colored-bubbles': 'useColoredBubbles',
                    'include-multimedia': 'includeMultimedia'
                };
                
                Object.entries(checkboxMapping).forEach(([id, statePath]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', function() {
                            // Handle nested properties (e.g., enhancedContent.useEnhanced)
                            if (statePath.includes('.')) {
                                const [parent, child] = statePath.split('.');
                                state[parent][child] = this.checked;
                            } else {
                                state[statePath] = this.checked;
                            }
                            
                            // Show/hide related options container
                            const optionsId = `${id}-options`;
                            const optionsContainer = document.getElementById(optionsId);
                            if (optionsContainer) {
                                optionsContainer.classList.toggle('hidden', !this.checked);
                            }
                            
                            scheduleAutoSave();
                        });
                    }
                });
                
                // Enhanced content checkbox options
                const enhancedContentMapping = {
                    'definition-box': 'enhancedContent.useDefinitionBox',
                    'calculation-examples': 'enhancedContent.useCalculationExamples',
                    'method-section': 'enhancedContent.useMethodSection',
                    'tooltips': 'enhancedContent.useTooltips',
                    'collapsible-sections': 'enhancedContent.useCollapsibleSections'
                };
                
                Object.entries(enhancedContentMapping).forEach(([id, statePath]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', function() {
                            const [parent, child] = statePath.split('.');
                            state[parent][child] = this.checked;
                            scheduleAutoSave();
                        });
                    }
                });
                
                // Color inputs
                document.getElementById('title-area-color').addEventListener('input', function() {
                    state.titleAreaColor = this.value;
                    updateColorPreview('title-area-color', 'title-area-color-preview');
                    
                    // Synchroniser les couleurs des onglets si le style principal change et que les onglets ne sont pas personnalisés
                    if (!state.useTabColors || !state.tabColorsCustomized) {
                        syncTabColorsWithStyle();
                    }
                    
                    scheduleAutoSave();
                });
                
                document.getElementById('version-color').addEventListener('input', function() {
                    state.versionColor = this.value;
                    updateColorPreview('version-color', 'version-color-preview');
                    scheduleAutoSave();
                });
                
                document.getElementById('signature-color').addEventListener('input', function() {
                    state.signatureColor = this.value;
                    updateColorPreview('signature-color', 'signature-color-preview');
                    scheduleAutoSave();
                });
                
                document.getElementById('definition-box-color').addEventListener('input', function() {
                    state.enhancedContent.definitionBoxColor = this.value;
                    updateColorPreview('definition-box-color', 'definition-box-color-preview');
                    scheduleAutoSave();
                });
                
                document.getElementById('exercise-box-color').addEventListener('input', function() {
                    state.enhancedContent.exerciseBoxColor = this.value;
                    updateColorPreview('exercise-box-color', 'exercise-box-color-preview');
                    scheduleAutoSave();
                });
                
                document.getElementById('method-box-color').addEventListener('input', function() {
                    state.enhancedContent.methodBoxColor = this.value;
                    updateColorPreview('method-box-color', 'method-box-color-preview');
                    scheduleAutoSave();
                });
                
                // Text and number inputs
				document.getElementById('signature').addEventListener('input', function() {
					state.signature = this.value;
					console.log("Signature mise à jour:", state.signature); // Pour déboguer
					
					// Ajouter une notification visuelle temporaire
					const signatureField = document.getElementById('signature');
					const originalBorder = signatureField.style.border;
					const originalBackground = signatureField.style.backgroundColor;
					
					// Appliquer une mise en évidence
					signatureField.style.transition = 'all 0.3s ease';
					signatureField.style.border = '2px solid #4caf50';
					signatureField.style.backgroundColor = '#e8f5e9';
					
					// Réinitialiser après une courte durée
					setTimeout(() => {
						signatureField.style.border = originalBorder;
						signatureField.style.backgroundColor = originalBackground;
					}, 2000);
					
					scheduleAutoSave();
				});								
				

				// Logo options
				document.getElementById('use-logo').addEventListener('change', function() {
					state.useLogo = this.checked;
					document.getElementById('logo-options').classList.toggle('hidden', !this.checked);
					scheduleAutoSave();
				});
				
				document.getElementById('logo-svg-code').addEventListener('input', function() {
					state.logoSvgCode = this.value;
					scheduleAutoSave();
				});
				
				document.getElementById('logo-width').addEventListener('change', function() {
					state.logoWidth = parseInt(this.value) || 50;
					scheduleAutoSave();
				});
				
				document.getElementById('logo-height').addEventListener('change', function() {
					state.logoHeight = parseInt(this.value) || 50;
					scheduleAutoSave();
				});
				
				document.getElementById('logo-position').addEventListener('change', function() {
					state.logoPosition = this.value;
					scheduleAutoSave();
				});
                
                document.getElementById('flashcards-count').addEventListener('change', function() {
                    state.flashcardsOptions.count = parseInt(this.value);
                    scheduleAutoSave();
                });
                
                document.getElementById('quiz-questions').addEventListener('change', function() {
                    state.quizQuestionCount = parseInt(this.value);
                    scheduleAutoSave();
                });
                
                // Quiz level checkboxes
                document.getElementById('easy-level').addEventListener('change', function() {
                    state.quizLevels.easy = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('medium-level').addEventListener('change', function() {
                    state.quizLevels.medium = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('hard-level').addEventListener('change', function() {
                    state.quizLevels.hard = this.checked;
                    scheduleAutoSave();
                });
                
                // Quiz options
                document.getElementById('quiz-timer').addEventListener('change', function() {
                    state.quizOptions.useTimer = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('quiz-shuffle').addEventListener('change', function() {
                    state.quizOptions.useShuffle = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('quiz-hints').addEventListener('change', function() {
                    state.quizOptions.useHints = this.checked;
                    scheduleAutoSave();
                });
                
                // Flashcards checkboxes
                document.getElementById('flashcards-animation').addEventListener('change', function() {
                    state.flashcardsOptions.animation = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('flashcards-grid').addEventListener('change', function() {
                    state.flashcardsOptions.grid = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('flashcards-structured').addEventListener('change', function() {
                    state.flashcardsOptions.structured = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('flashcards-evaluation').addEventListener('change', function() {
                    state.flashcardsOptions.evaluation = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('flashcards-score').addEventListener('change', function() {
                    state.flashcardsOptions.score = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('flashcards-categories').addEventListener('change', function() {
                    state.flashcardsOptions.categories = this.checked;
                    scheduleAutoSave();
                });
                
                // Gamification checkboxes
                document.getElementById('gamification-points').addEventListener('change', function() {
                    state.gamificationOptions.usePoints = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('gamification-badges').addEventListener('change', function() {
                    state.gamificationOptions.useBadges = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('gamification-progress').addEventListener('change', function() {
                    state.gamificationOptions.useProgress = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('gamification-rewards').addEventListener('change', function() {
                    state.gamificationOptions.useRewards = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('gamification-leaderboard').addEventListener('change', function() {
                    state.gamificationOptions.useLeaderboard = this.checked;
                    scheduleAutoSave();
                });
                
                // Adaptive assessment checkboxes
                document.getElementById('adaptive-difficulty').addEventListener('change', function() {
                    state.adaptiveAssessmentOptions.adaptiveDifficulty = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('adaptive-feedback').addEventListener('change', function() {
                    state.adaptiveAssessmentOptions.adaptiveFeedback = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('adaptive-path').addEventListener('change', function() {
                    state.adaptiveAssessmentOptions.adaptivePath = this.checked;
                    scheduleAutoSave();
                });
                
                
                
				// SCORM options
				document.getElementById('use-scorm').addEventListener('change', function() {
					state.useScorm = this.checked;
					document.getElementById('scorm-options').classList.toggle('hidden', !this.checked);
					scheduleAutoSave();
				});
				
				document.querySelectorAll('input[name="scorm-version"]').forEach(radio => {
					radio.addEventListener('change', function() {
						if (this.checked) {
							state.scormVersion = this.value;
							scheduleAutoSave();
						}
					});
				});
				
				document.getElementById('scorm-score').addEventListener('change', function() {
					state.scormOptions.transmitScore = this.checked;
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-completion').addEventListener('change', function() {
					state.scormOptions.transmitCompletion = this.checked;
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-time').addEventListener('change', function() {
					state.scormOptions.transmitTime = this.checked;
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-detailed-scores').addEventListener('change', function() {
					state.scormOptions.transmitDetailedScores = this.checked;
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-passing-score').addEventListener('change', function() {
					state.scormOptions.passingScore = parseInt(this.value);
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-completion-criteria').addEventListener('change', function() {
					state.scormOptions.completionCriteria = this.value;
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-max-attempts').addEventListener('change', function() {
					state.scormOptions.maxAttempts = parseInt(this.value);
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-auto-save').addEventListener('change', function() {
					state.scormOptions.autoSave = this.checked;
					scheduleAutoSave();
				});
				
				document.getElementById('scorm-suspend-data').addEventListener('change', function() {
					state.scormOptions.suspendData = this.checked;
					scheduleAutoSave();
				});
								
                
                
                // Domain-specific options
                // Math options
                document.getElementById('math-latex-zones').addEventListener('change', function() {
                    state.mathOptions.useLatexZones = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('math-calculator').addEventListener('change', function() {
                    state.mathOptions.useCalculator = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('math-interactive-graphs').addEventListener('change', function() {
                    state.mathOptions.useInteractiveGraphs = this.checked;
                    scheduleAutoSave();
                });
                
                // Science options
                document.getElementById('molecular-visualization').addEventListener('change', function() {
                    state.scienceOptions.useMolecularViz = this.checked;
                    document.getElementById('molecular-options').classList.toggle('hidden', !this.checked);
                    scheduleAutoSave();
                });
                
                document.querySelectorAll('input[name="molecular-type"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            state.scienceOptions.molecularType = this.value;
                            scheduleAutoSave();
                        }
                    });
                });
                
                document.getElementById('molecular-link').addEventListener('input', function() {
                    state.scienceOptions.molecularLink = this.value;
                    scheduleAutoSave();
                });
                
                document.getElementById('periodic-table').addEventListener('change', function() {
                    state.scienceOptions.usePeriodicTable = this.checked;
                    document.getElementById('periodic-options').classList.toggle('hidden', !this.checked);
                    scheduleAutoSave();
                });
                
                document.getElementById('periodic-link').addEventListener('input', function() {
                    state.scienceOptions.periodicLink = this.value;
                    scheduleAutoSave();
                });
                
                document.getElementById('simulation-lab').addEventListener('change', function() {
                    state.scienceOptions.useSimulationLab = this.checked;
                    scheduleAutoSave();
                });
                
                // Programming options
                document.getElementById('code-editor').addEventListener('change', function() {
                    state.programmingOptions.useCodeEditor = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('syntax-highlighting').addEventListener('change', function() {
                    state.programmingOptions.useSyntaxHighlighting = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('code-execution').addEventListener('change', function() {
                    state.programmingOptions.useCodeExecution = this.checked;
                    scheduleAutoSave();
                });
                
                // Language options
                document.getElementById('pronunciation').addEventListener('change', function() {
                    state.languageOptions.usePronunciation = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('vocabulary-lists').addEventListener('change', function() {
                    state.languageOptions.useVocabularyLists = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('conversation-sim').addEventListener('change', function() {
                    state.languageOptions.useConversationSim = this.checked;
                    scheduleAutoSave();
                });
                
                // Icon set selection
                document.getElementById('icon-set').addEventListener('change', function() {
                    state.iconSet = this.value;
                    renderTabs(); // Re-render tabs to update icons
                    scheduleAutoSave();
                });
                
                // Multimedia options
                document.getElementById('audio-clips').addEventListener('change', function() {
                    state.multimediaOptions.useAudioClips = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('image-gallery').addEventListener('change', function() {
                    state.multimediaOptions.useImageGallery = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('iframe-embeds').addEventListener('change', function() {
                    state.multimediaOptions.useIframeEmbeds = this.checked;
                    scheduleAutoSave();
                });
                
                // Navigation options
                document.getElementById('sticky-tabs').addEventListener('change', function() {
                    state.navigationOptions.stickyTabs = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('tab-transitions').addEventListener('change', function() {
                    state.navigationOptions.tabTransitions = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('tab-breadcrumbs').addEventListener('change', function() {
                    state.navigationOptions.tabBreadcrumbs = this.checked;
                    scheduleAutoSave();
                });
                
                // Accessibility options
                document.getElementById('accessibility-features').addEventListener('change', function() {
                    state.accessibilityFeatures = this.checked;
                    document.getElementById('accessibility-options').classList.toggle('hidden', !this.checked);
                    scheduleAutoSave();
                });
                
                document.getElementById('high-contrast').addEventListener('change', function() {
                    state.accessibilityOptions.highContrast = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('large-text').addEventListener('change', function() {
                    state.accessibilityOptions.largeText = this.checked;
                    scheduleAutoSave();
                });
                
                document.getElementById('screen-reader').addEventListener('change', function() {
                    state.accessibilityOptions.screenReader = this.checked;
                    scheduleAutoSave();
                });
            }


			// Fonction pour extraire les titres d'onglets à partir du texte avec balises #1, #2, #B, #G, etc.
			function extractTabTitlesFromText(text) {
				const tabTitles = [];
				const numericRegex = /#(\d+)\s+(.*?)(?=\n|$)/g;
				let match;
				
				// Traiter les balises numériques (#1, #2, etc.)
				while ((match = numericRegex.exec(text)) !== null) {
					const tabNumber = parseInt(match[1]);
					const tabTitle = match[2].trim();
					
					if (tabNumber > 0 && tabTitle) {
						// Assurez-vous que le tableau est suffisamment grand
						while (tabTitles.length < tabNumber) {
							tabTitles.push(null);
						}
						tabTitles[tabNumber - 1] = tabTitle;
					}
				}
				
				// Traiter les balises spéciales #B et #G
				const specialRegex = /#([BG])\s*(.*?)(?=\n|$)/g;
				specialRegex.lastIndex = 0; // Réinitialiser l'index de recherche
				
				while ((match = specialRegex.exec(text)) !== null) {
					const tabType = match[1]; // B ou G
					let tabTitle = match[2].trim();
					
					// Si aucun titre spécifié, utiliser le titre par défaut
					if (!tabTitle) {
						tabTitle = tabType === 'B' ? 'Bibliographie' : 'Glossaire';
					} else {
						// Si un titre est spécifié, le préfixer avec le type
						tabTitle = tabType === 'B' ? 'Bibliographie: ' + tabTitle : 'Glossaire: ' + tabTitle;
					}
					
					// Ajouter à la fin du tableau
					tabTitles.push(tabTitle);
				}
				
				// Supprimer les entrées null (s'il y a des sauts dans la numérotation)
				return tabTitles.filter(title => title !== null);
			}


			// Fonction pour extraire les contenus à partir du texte avec balises #1, #2, #B, #G, etc.
			function extractTabContentsFromText(text) {
				const result = {
					presentation: null,
					tabs: [],
					structuredContent: {
						definitions: [],
						exercises: [],
						methods: []
					}
				};
				
				// Extraire la présentation (#P)
				const presentationRegex = /#P\s+(.*?)(?=\n|$)([\s\S]*?)(?=#\d+|#[BG]|$)/g;
				let presentationMatch = presentationRegex.exec(text);
				if (presentationMatch) {
					result.presentation = {
						title: presentationMatch[1].trim(),
						content: presentationMatch[2].trim()
					};
				}
				
				// Extraire les onglets numériques et leur contenu (#1, #2, etc.)
				const tabRegex = /#(\d+)\s+(.*?)(?=\n|$)([\s\S]*?)(?=#\d+|#[BG]|#P|$)/g;
				let match;
				
				while ((match = tabRegex.exec(text)) !== null) {
					const tabNumber = parseInt(match[1]);
					const tabTitle = match[2].trim();
					const tabContent = match[3].trim();
					
					// Stocker à l'index correspondant
					if (tabNumber > 0 && tabTitle) {
						// S'assurer que le tableau est suffisamment grand
						while (result.tabs.length < tabNumber) {
							result.tabs.push(null);
						}
						result.tabs[tabNumber - 1] = {
							title: tabTitle,
							content: tabContent
						};
					}
				}
				
				// Extraire les onglets spéciaux et leur contenu (#B, #G)
				const specialTabRegex = /#([BG])\s*(.*?)(?=\n|$)([\s\S]*?)(?=#\d+|#[BG]|#P|$)/g;
				specialTabRegex.lastIndex = 0; // Réinitialiser l'index de recherche
				
				while ((match = specialTabRegex.exec(text)) !== null) {
					const tabType = match[1]; // B ou G
					let tabTitle = match[2].trim();
					const tabContent = match[3].trim();
					
					// Déterminer le titre final
					if (!tabTitle) {
						tabTitle = tabType === 'B' ? 'Bibliographie' : 'Glossaire';
					} else {
						tabTitle = tabType === 'B' ? 'Bibliographie: ' + tabTitle : 'Glossaire: ' + tabTitle;
					}
					
					// Ajouter à la fin du tableau
					result.tabs.push({
						title: tabTitle,
						content: tabContent,
						specialType: tabType // Marquer comme onglet spécial
					});
				}
				
				// Extraire les définitions (##D)
				const defRegex = /##D\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEM]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = defRegex.exec(text)) !== null) {
					result.structuredContent.definitions.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
				
				// Extraire les exercices (##E)
				const exRegex = /##E\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEM]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = exRegex.exec(text)) !== null) {
					result.structuredContent.exercises.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
				
				// Extraire les méthodes (##M)
				const methRegex = /##M\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEM]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = methRegex.exec(text)) !== null) {
					result.structuredContent.methods.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
				
				// Extraire les tableaux (##T)
				const tableRegex = /##T\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEMT]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = tableRegex.exec(text)) !== null) {
					result.structuredContent.tables = result.structuredContent.tables || [];
					result.structuredContent.tables.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
				
				// Extraire les info-bulles (##IB)
				const tooltipRegex = /##IB\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEMT]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = tooltipRegex.exec(text)) !== null) {
					result.structuredContent.tooltips = result.structuredContent.tooltips || [];
					result.structuredContent.tooltips.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
				
				// Extraire les popups (##PP)
				const popupRegex = /##PP\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEMT]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = popupRegex.exec(text)) !== null) {
					result.structuredContent.popups = result.structuredContent.popups || [];
					result.structuredContent.popups.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
				
				// Extraire les iframes (##IFM)
				const iframeRegex = /##IFM\s+(.*?)(?=\n|$)([\s\S]*?)(?=##[DEMT]|#\d+|#[BG]|#P|$)/g;
				
				while ((match = iframeRegex.exec(text)) !== null) {
					result.structuredContent.iframes = result.structuredContent.iframes || [];
					result.structuredContent.iframes.push({
						title: match[1].trim(),
						content: match[2].trim()
					});
				}
								
				// Supprimer les entrées null (s'il y a des sauts dans la numérotation)
				result.tabs = result.tabs.filter(tab => tab !== null);
				
				return result;
			}

            // Initialize the application
            function init() {
                // Set up all event listeners
                setupEventListeners();
                
                // Load saved state
                loadState();
                
				// S'assurer que la valeur du champ correspond à l'état
					document.getElementById('signature').value = state.signature;
                
                // Initialize UI components
                initializeTabs();
                initializeSvgIllustrations();
                updateStylePreviews();
                updateCustomSubjectField();
                updateSelectedLevelsDisplay();
                
				const soberColorOption = document.querySelector(`.sober-color-option.${state.soberColorOption}`);
				if (soberColorOption) {
					soberColorOption.classList.add('selected');
				}
				updateSoberPreview();                
                
                // Hide nested options containers initially
                const nestedContainers = [
                    'decimal-options',
                    'flashcards-options',
                    'gamification-options',
                    'adaptive-assessment-options',
                    'quiz-options',
                    'certificate-options',
                    'molecular-options',
                    'periodic-options',
                    'gradient-options',
                    'accessibility-options',
                    'navigation-options',
                    'multimedia-options'
                ];
                
                nestedContainers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.classList.add('hidden');
                    }
                });
                
                // Update domain-specific options visibility
                updateDomainOptions();
                
                // Vérifier l'état de la case à cocher pour les couleurs d'onglets
                const useTabColors = document.getElementById('use-tab-colors');
                if (useTabColors) {
                    useTabColors.checked = state.useTabColors;
                    
                    // Si on n'utilise pas de couleurs personnalisées, synchroniser avec le style
                    if (!state.useTabColors) {
                        syncTabColorsWithStyle();
                    }
                    
                    // Mettre à jour la visibilité des options de couleur
                    document.querySelectorAll('.tab-color-input').forEach(input => {
                        const colorContainer = input.parentElement.parentElement;
                        if (colorContainer) {
                            colorContainer.style.display = state.useTabColors ? 'block' : 'none';
                        }
                    });
                }
                
				// Vérifier et initialiser les niveaux
				const selectedLevel = state.levels[0] || 'Collège - 3ème';
				const radioToCheck = document.querySelector(`input[name="level"][value="${selectedLevel}"]`);
				if (radioToCheck) {
					radioToCheck.checked = true;
				}
				updateSelectedLevelsDisplay();
                
                
                // S'assurer que l'on commence à l'étape 1
                goToStep(1);
                
                // Initialiser l'état des options de certificat dans l'étape 3
                document.getElementById('certificate-last-tab').checked = state.certificateInLastTab;
                document.getElementById('use-certificate').checked = state.useCertificate;
                document.getElementById('certificate-options-step3').classList.toggle('hidden', !state.useCertificate);
                document.getElementById('certificate-title-step3').value = state.certificateOptions.title;

                Object.entries(certificateOptionsMapping).forEach(([id, prop]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = state.certificateOptions[prop];
                    }
                });

                document.getElementById('certificate-border-color-step3').value = state.certificateOptions.borderColor;
                updateColorPreview('certificate-border-color-step3', 'certificate-border-color-preview-step3');

                document.getElementById('certificate-score-color-step3').value = state.certificateOptions.scoreColor;
                updateColorPreview('certificate-score-color-step3', 'certificate-score-color-preview-step3');
                updateTabsPreview();
            }
            
            // Start the application
            init();
        });
    </script>
    
	<!-- Modal pour IA & API -->
	<div id="iaApiModal" class="modal">
		<div class="modal-content">
			<span class="close" id="close-ia-api-modal">&times;</span>
			<h2>Intégration intelligence artificielle</h2>
			<p>Configurez vos clés API pour profiter des fonctionnalités d'IA dans la création de vos scénarios pédagogiques.</p>
	
			<div class="tools-container">
				<!-- Colonne des services d'IA -->
				<div class="resources-column">
					<div class="column-title">
						<h3>Services d'IA disponibles</h3>
					</div>
					
					<!-- Anthropic Claude -->
					<div class="api-config-section">
						<div class="api-header">
							<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Anthropic_logo.svg/1200px-Anthropic_logo.svg.png" alt="Anthropic Logo" width="30" height="30" style="margin-right: 10px;">
							<h4>Anthropic Claude</h4>
						</div>
						<div class="api-input-group">
							<label for="claude-api-key">Clé API:</label>
							<div class="api-input-wrapper">
								<input type="password" id="claude-api-key" placeholder="Collez votre clé API Claude ici..." />
								<button class="toggle-visibility-btn" data-target="claude-api-key"><i class="fas fa-eye"></i></button>
							</div>
							<span class="api-format-info">Format: sk-ant-apiXXX-XXX...</span>
						</div>
						<div class="api-model-select">
							<label for="claude-model">Modèle:</label>
							<select id="claude-model">
								<option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (dernière version)</option>
								<option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
								<option value="claude-3-opus-20240229">Claude 3 Opus</option>
								<option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
							</select>
						</div>
						<button class="btn test-api-btn" data-service="claude">Tester la connexion</button>
						<div class="api-status" id="claude-api-status"></div>
					</div>
					
					<!-- OpenAI -->
					<div class="api-config-section">
						<div class="api-header">
							<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/OpenAI_Logo.svg/1024px-OpenAI_Logo.svg.png" alt="OpenAI Logo" width="30" height="30" style="margin-right: 10px;">
							<h4>OpenAI</h4>
						</div>
						<div class="api-input-group">
							<label for="openai-api-key">Clé API:</label>
							<div class="api-input-wrapper">
								<input type="password" id="openai-api-key" placeholder="Collez votre clé API OpenAI ici..." />
								<button class="toggle-visibility-btn" data-target="openai-api-key"><i class="fas fa-eye"></i></button>
							</div>
							<span class="api-format-info">Format: sk-xxxxxxxxxxxxx...</span>
						</div>
						<div class="api-model-select">
							<label for="openai-model">Modèle:</label>
							<select id="openai-model">
								<option value="gpt-4o">GPT-4o</option>
								<option value="gpt-4-turbo">GPT-4 Turbo</option>
								<option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
							</select>
						</div>
						<button class="btn test-api-btn" data-service="openai">Tester la connexion</button>
						<div class="api-status" id="openai-api-status"></div>
					</div>
					
					<!-- Mistral AI -->
					<div class="api-config-section">
						<div class="api-header">
							<img src="https://avatars.githubusercontent.com/u/139895814" alt="Mistral AI Logo" width="30" height="30" style="margin-right: 10px;">
							<h4>Mistral AI</h4>
						</div>
						<div class="api-input-group">
							<label for="mistral-api-key">Clé API:</label>
							<div class="api-input-wrapper">
								<input type="password" id="mistral-api-key" placeholder="Collez votre clé API Mistral ici..." />
								<button class="toggle-visibility-btn" data-target="mistral-api-key"><i class="fas fa-eye"></i></button>
							</div>
							<span class="api-format-info">Format: ag:xxxxx:date:name:hash</span>
						</div>
						<div class="api-model-select">
							<label for="mistral-model">Modèle:</label>
							<select id="mistral-model">
								<option value="mistral-large-latest">Mistral Large</option>
								<option value="mistral-medium-latest">Mistral Medium</option>
								<option value="mistral-small-latest">Mistral Small</option>
							</select>
						</div>
						<button class="btn test-api-btn" data-service="mistral">Tester la connexion</button>
						<div class="api-status" id="mistral-api-status"></div>
					</div>
					
					<!-- Google Gemini -->
					<div class="api-config-section">
						<div class="api-header">
							<img src="https://storage.googleapis.com/gweb-uniblog-publish-prod/images/gemini_advanced_logo.max-1000x1000.png" alt="Google Gemini Logo" width="30" height="30" style="margin-right: 10px;">
							<h4>Google Gemini</h4>
						</div>
						<div class="api-input-group">
							<label for="gemini-api-key">Clé API:</label>
							<div class="api-input-wrapper">
								<input type="password" id="gemini-api-key" placeholder="Collez votre clé API Gemini ici..." />
								<button class="toggle-visibility-btn" data-target="gemini-api-key"><i class="fas fa-eye"></i></button>
							</div>
							<span class="api-format-info">Format: clé de la console Google AI</span>
						</div>
						<div class="api-model-select">
							<label for="gemini-model">Modèle:</label>
							<select id="gemini-model">
								<option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
								<option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
							</select>
						</div>
						<button class="btn test-api-btn" data-service="gemini">Tester la connexion</button>
						<div class="api-status" id="gemini-api-status"></div>
					</div>
				</div>
				
				<!-- Colonne de test API -->
				<div class="activities-column">
					<div class="column-title">
						<h3>Test des API</h3>
					</div>
					
					<div class="api-test-panel">
						<p>Vérifiez le fonctionnement de vos connexions API en testant une requête simple.</p>
						
						<div class="api-test-form">
							<div class="form-group">
								<label for="test-service">Service à tester:</label>
								<select id="test-service">
									<option value="claude">Anthropic Claude</option>
									<option value="openai">OpenAI</option>
									<option value="mistral">Mistral AI</option>
									<option value="gemini">Google Gemini</option>
								</select>
							</div>
							
							<div class="form-group">
								<label for="test-prompt">Prompt de test:</label>
								<textarea id="test-prompt" rows="4" placeholder="Entrez un prompt de test ici...">Génère 3 idées de scénarios pédagogiques pour un cours de mathématiques niveau collège.</textarea>
							</div>
							
							<div class="form-group">
								<label for="test-temperature">Température:</label>
								<input type="range" id="test-temperature" min="0" max="1" step="0.1" value="0.7" />
								<span id="temperature-value">0.7</span>
							</div>
							
							<div class="form-group">
								<label for="test-tokens">Longueur maximale (tokens):</label>
								<input type="number" id="test-tokens" min="100" max="4000" value="1000" />
							</div>
							
							<button class="btn" id="run-test-btn">Exécuter le test</button>
						</div>
						
						<div class="api-test-result">
							<div class="result-header">
								<h4>Résultat</h4>
								<div class="result-controls" style="display: none;">
									<button id="copy-result-btn" title="Copier"><i class="fas fa-copy"></i></button>
								</div>
							</div>
							<div id="loading-spinner" style="display: none;">
								<div class="spinner"></div>
								<p>Requête en cours...</p>
							</div>
							<div id="test-result" class="result-content">
								<p class="placeholder-text">Le résultat de votre test apparaîtra ici...</p>
							</div>
						</div>
					</div>
				</div>
			</div>
	
			<div class="section-buttons">
				<button class="btn" id="save-api-settings">Enregistrer les configurations</button>
			</div>
		</div>
	</div>
    
    
	<script>
	// ===== CODE API IA =====
	/**
	 * Scripts pour l'intégration et le test des API d'intelligence artificielle
	 */
	
	// Charger les configurations sauvegardées au chargement de la page
	document.addEventListener('DOMContentLoaded', function() {
		// Ajouter Font Awesome pour les icônes
		if (!document.querySelector('link[href*="font-awesome"]')) {
			const fontAwesome = document.createElement('link');
			fontAwesome.rel = 'stylesheet';
			fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
			document.head.appendChild(fontAwesome);
		}
		
		// Initialiser les écouteurs d'événements pour l'API
		initializeApiEventListeners();
		
		// Charger les configurations API sauvegardées
		loadSavedApiConfigurations();
		
		// Initialiser les écouteurs pour la recherche multimédia
		initializeMultimediaSearchListeners();
	});
	
	/**
	 * Initialise tous les écouteurs d'événements pour l'interface IA
	 */
	function initializeApiEventListeners() {
		// Gestion du modal IA & API
		document.getElementById('ia-api-btn').addEventListener('click', function(e) {
			e.preventDefault();
			document.getElementById('iaApiModal').style.display = 'block';
		});
	
		document.getElementById('close-ia-api-modal').addEventListener('click', function() {
			document.getElementById('iaApiModal').style.display = 'none';
		});
	
		// Fermer le modal IA & API quand on clique en dehors
		window.addEventListener('click', function(event) {
			const modal = document.getElementById('iaApiModal');
			if (event.target == modal) {
				modal.style.display = 'none';
			}
		});
	
		// Gestion de la visibilité des clés API
		document.querySelectorAll('.toggle-visibility-btn').forEach(button => {
			button.addEventListener('click', function() {
				const targetId = this.getAttribute('data-target');
				const inputField = document.getElementById(targetId);
				
				if (inputField.type === 'password') {
					inputField.type = 'text';
					this.innerHTML = '<i class="fas fa-eye-slash"></i>';
				} else {
					inputField.type = 'password';
					this.innerHTML = '<i class="fas fa-eye"></i>';
				}
			});
		});
	
		// Gestion de la température
		document.getElementById('test-temperature').addEventListener('input', function() {
			document.getElementById('temperature-value').textContent = this.value;
		});
	
		// Sauvegarder les configurations API
		document.getElementById('save-api-settings').addEventListener('click', function() {
			saveApiConfigurations();
		});
	
		// Tester les connexions API
		document.querySelectorAll('.test-api-btn').forEach(button => {
			button.addEventListener('click', function() {
				const service = this.getAttribute('data-service');
				testApiConnection(service);
			});
		});
	
		// Exécuter un test API
		document.getElementById('run-test-btn').addEventListener('click', function() {
			runApiTest();
		});
	
		// Bouton de copie du résultat
		document.getElementById('copy-result-btn').addEventListener('click', function() {
			copyTestResult();
		});
	}
	
	/**
	 * Charge les configurations API sauvegardées
	 */
	function loadSavedApiConfigurations() {
		const savedConfig = localStorage.getItem('elea_api_config');
		if (savedConfig) {
			try {
				const config = JSON.parse(savedConfig);
				
				// Remplir les champs avec les valeurs sauvegardées
				if (config.claude) {
					document.getElementById('claude-api-key').value = config.claude.key || '';
					document.getElementById('claude-model').value = config.claude.model || 'claude-3-7-sonnet-20250219';
				}
				
				if (config.openai) {
					document.getElementById('openai-api-key').value = config.openai.key || '';
					document.getElementById('openai-model').value = config.openai.model || 'gpt-4o';
				}
				
				if (config.mistral) {
					document.getElementById('mistral-api-key').value = config.mistral.key || '';
					document.getElementById('mistral-model').value = config.mistral.model || 'mistral-large-latest';
				}
				
				if (config.gemini) {
					document.getElementById('gemini-api-key').value = config.gemini.key || '';
					document.getElementById('gemini-model').value = config.gemini.model || 'gemini-1.5-pro';
				}
			} catch (e) {
				console.error("Erreur lors du chargement des configurations API:", e);
			}
		}
	}
	
	/**
	 * Sauvegarde les configurations API
	 */
	function saveApiConfigurations() {
		const config = {
			claude: {
				key: document.getElementById('claude-api-key').value,
				model: document.getElementById('claude-model').value
			},
			openai: {
				key: document.getElementById('openai-api-key').value,
				model: document.getElementById('openai-model').value
			},
			mistral: {
				key: document.getElementById('mistral-api-key').value,
				model: document.getElementById('mistral-model').value
			},
			gemini: {
				key: document.getElementById('gemini-api-key').value,
				model: document.getElementById('gemini-model').value
			}
		};
		
		// Sauvegarder en localStorage
		localStorage.setItem('elea_api_config', JSON.stringify(config));
		
		// Afficher un message de confirmation
		alert('Configurations API enregistrées avec succès !');
	}
	
	/**
	 * Teste la connexion à une API spécifique
	 * @param {string} service - Le service à tester (claude, openai, mistral, gemini)
	 */
	async function testApiConnection(service) {
		const statusElement = document.getElementById(`${service}-api-status`);
		const keyElement = document.getElementById(`${service}-api-key`);
		const modelElement = document.getElementById(`${service}-model`);
		
		// Vérifier que la clé API est renseignée
		if (!keyElement.value) {
			statusElement.textContent = "Erreur : Veuillez entrer une clé API.";
			statusElement.className = "api-status error";
			return;
		}
		
		statusElement.textContent = "Test en cours...";
		statusElement.className = "api-status";
		
		try {
			let endpoint, headers, body;
			
			// Configuration selon le service
			switch(service) {
				case 'claude':
					endpoint = 'https://api.anthropic.com/v1/messages';
					headers = {
						'Content-Type': 'application/json',
						'x-api-key': keyElement.value,
						'anthropic-version': '2023-06-01'
					};
					body = {
						model: modelElement.value,
						max_tokens: 50,
						messages: [{ role: "user", content: "Dis simplement bonjour" }]
					};
					break;
					
				case 'openai':
					endpoint = 'https://api.openai.com/v1/chat/completions';
					headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${keyElement.value}`
					};
					body = {
						model: modelElement.value,
						messages: [{ role: "user", content: "Dis simplement bonjour" }],
						max_tokens: 50
					};
					break;
					
				case 'mistral':
					endpoint = 'https://api.mistral.ai/v1/chat/completions';
					headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${keyElement.value}`
					};
					body = {
						model: modelElement.value,
						messages: [{ role: "user", content: "Dis simplement bonjour" }],
						max_tokens: 50
					};
					break;
					
				case 'gemini':
					endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/' + 
							   modelElement.value + ':generateContent?key=' + keyElement.value;
					headers = {
						'Content-Type': 'application/json'
					};
					body = {
						contents: [{ parts: [{ text: "Dis simplement bonjour" }] }]
					};
					break;
			}
			
			// Effectuer la requête
			const response = await fetch(endpoint, {
				method: 'POST',
				headers: headers,
				body: JSON.stringify(body)
			});
			
			const data = await response.json();
			
			if (response.ok) {
				statusElement.textContent = "Connexion réussie !";
				statusElement.className = "api-status success";
			} else {
				statusElement.textContent = "Erreur : " + (data.error?.message || "Problème de connexion");
				statusElement.className = "api-status error";
			}
		} catch (error) {
			statusElement.textContent = "Erreur : " + error.message;
			statusElement.className = "api-status error";
		}
	}
	
	/**
	 * Exécute un test API avec les paramètres définis dans l'interface
	 */
	async function runApiTest() {
		const service = document.getElementById('test-service').value;
		const prompt = document.getElementById('test-prompt').value;
		const temperature = document.getElementById('test-temperature').value;
		const maxTokens = document.getElementById('test-tokens').value;
		
		const resultDiv = document.getElementById('test-result');
		const loadingSpinner = document.getElementById('loading-spinner');
		const resultControls = document.querySelector('.result-controls');
		
		// Vérifier que le prompt est renseigné
		if (!prompt) {
			resultDiv.innerHTML = '<p class="placeholder-text">Veuillez entrer un prompt de test.</p>';
			return;
		}
		
		// Récupérer la configuration du service
		const config = JSON.parse(localStorage.getItem('elea_api_config') || '{}');
		const serviceConfig = config[service];
		
		if (!serviceConfig || !serviceConfig.key) {
			resultDiv.innerHTML = '<p class="placeholder-text">Veuillez configurer une clé API pour ce service.</p>';
			return;
		}
		
		// Afficher le spinner de chargement
		resultDiv.style.display = 'none';
		loadingSpinner.style.display = 'block';
		
		try {
			let endpoint, headers, body, resultText;
			
			// Configuration selon le service
			switch(service) {
				case 'claude':
					endpoint = 'https://api.anthropic.com/v1/messages';
					headers = {
						'Content-Type': 'application/json',
						'x-api-key': serviceConfig.key,
						'anthropic-version': '2023-06-01'
					};
					body = {
						model: serviceConfig.model,
						max_tokens: parseInt(maxTokens),
						temperature: parseFloat(temperature),
						messages: [{ role: "user", content: prompt }]
					};
					break;
					
				case 'openai':
					endpoint = 'https://api.openai.com/v1/chat/completions';
					headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${serviceConfig.key}`
					};
					body = {
						model: serviceConfig.model,
						messages: [{ role: "user", content: prompt }],
						max_tokens: parseInt(maxTokens),
						temperature: parseFloat(temperature)
					};
					break;
					
				case 'mistral':
					endpoint = 'https://api.mistral.ai/v1/chat/completions';
					headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${serviceConfig.key}`
					};
					body = {
						model: serviceConfig.model,
						messages: [{ role: "user", content: prompt }],
						max_tokens: parseInt(maxTokens),
						temperature: parseFloat(temperature)
					};
					break;
					
				case 'gemini':
					endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/' + 
							  serviceConfig.model + ':generateContent?key=' + serviceConfig.key;
					headers = {
						'Content-Type': 'application/json'
					};
					body = {
						contents: [{ parts: [{ text: prompt }] }],
						generationConfig: {
							temperature: parseFloat(temperature),
							maxOutputTokens: parseInt(maxTokens)
						}
					};
					break;
			}
			
			// Effectuer la requête
			const response = await fetch(endpoint, {
				method: 'POST',
				headers: headers,
				body: JSON.stringify(body)
			});
			
			const data = await response.json();
			
			// Extraire le texte de la réponse selon le service
			if (service === 'claude') {
				resultText = data.content?.[0]?.text || "Pas de réponse";
			} else if (service === 'openai' || service === 'mistral') {
				resultText = data.choices?.[0]?.message?.content || "Pas de réponse";
			} else if (service === 'gemini') {
				resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Pas de réponse";
			}
			
			// Afficher le résultat
			resultDiv.textContent = resultText;
			resultControls.style.display = 'block';
		} catch (error) {
			resultDiv.textContent = "Erreur : " + error.message;
		} finally {
			// Masquer le spinner de chargement
			loadingSpinner.style.display = 'none';
			resultDiv.style.display = 'block';
		}
	}
	
	/**
	 * Copie le résultat du test dans le presse-papier
	 */
	function copyTestResult() {
		const resultText = document.getElementById('test-result').textContent;
		navigator.clipboard.writeText(resultText).then(function() {
			alert('Résultat copié dans le presse-papier !');
		}).catch(function(err) {
			console.error('Erreur lors de la copie :', err);
		});
	}
	
	// ===== RECHERCHE DE RESSOURCES MULTIMÉDIAS =====
	
	/**
	 * Initialise les écouteurs pour la recherche de ressources multimédias
	 */
	function initializeMultimediaSearchListeners() {
		const searchButton = document.getElementById('multimedia-search-btn');
		if (searchButton) {
			searchButton.addEventListener('click', function() {
				searchMultimediaResources();
			});
		}
	}
	
	/**
	 * Recherche des ressources multimédias à l'aide de l'IA
	 */
	async function searchMultimediaResources() {
		const serviceType = document.getElementById('multimedia-search-service').value;
		const resourceType = document.getElementById('multimedia-search-type').value;
		const query = document.getElementById('multimedia-search-query').value;
		const level = document.getElementById('multimedia-search-level').value;
		
		const resultsContainer = document.getElementById('multimedia-search-results');
		
		// Vérifier que la requête est renseignée
		if (!query) {
			alert("Veuillez entrer des mots-clés pour la recherche.");
			return;
		}
		
		// Récupérer la configuration du service
		const config = JSON.parse(localStorage.getItem('elea_api_config') || '{}');
		const serviceConfig = config[serviceType];
		
		if (!serviceConfig || !serviceConfig.key) {
			alert(`Veuillez configurer une clé API pour ${serviceType} dans l'onglet IA & API.`);
			return;
		}
		
		// Afficher le conteneur de résultats
		resultsContainer.style.display = 'block';
		resultsContainer.innerHTML = `
			<div class="search-status">
				<div class="spinner"></div>
				<p>Recherche de ressources en cours...</p>
			</div>
		`;
		
		// Construire le prompt pour l'IA
		let prompt = `Tu es un assistant spécialisé dans la recherche de ressources pédagogiques. Je recherche des ${getResourceTypeLabel(resourceType)} sur "${query}" pour un niveau ${getLevelLabel(level)}. 
		
	Fournis-moi 3 à 5 suggestions de ressources au format JSON exactement comme ceci:
	[
	  {
		"title": "Titre de la ressource",
		"description": "Brève description de la ressource",
		"url": "URL de la ressource (lien direct)",
		"type": "Type de ressource (vidéo, image, audio, site interactif)",
		"source": "Source/créateur de la ressource"
	  }
	]
	
	Assure-toi que ce sont des ressources réelles, existantes, fiables et pédagogiquement pertinentes. Réponds UNIQUEMENT avec le JSON, sans texte avant ou après.`;
		
		try {
			let endpoint, headers, body, resultText;
			
			// Configuration selon le service
			switch(serviceType) {
				case 'claude':
					endpoint = 'https://api.anthropic.com/v1/messages';
					headers = {
						'Content-Type': 'application/json',
						'x-api-key': serviceConfig.key,
						'anthropic-version': '2023-06-01'
					};
					body = {
						model: serviceConfig.model,
						max_tokens: 1500,
						temperature: 0.5,
						messages: [{ role: "user", content: prompt }]
					};
					break;
					
				case 'openai':
					endpoint = 'https://api.openai.com/v1/chat/completions';
					headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${serviceConfig.key}`
					};
					body = {
						model: serviceConfig.model,
						messages: [{ role: "user", content: prompt }],
						max_tokens: 1500,
						temperature: 0.5
					};
					break;
					
				case 'mistral':
					endpoint = 'https://api.mistral.ai/v1/chat/completions';
					headers = {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${serviceConfig.key}`
					};
					body = {
						model: serviceConfig.model,
						messages: [{ role: "user", content: prompt }],
						max_tokens: 1500,
						temperature: 0.5
					};
					break;
					
				case 'gemini':
					endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/' + 
							  serviceConfig.model + ':generateContent?key=' + serviceConfig.key;
					headers = {
						'Content-Type': 'application/json'
					};
					body = {
						contents: [{ parts: [{ text: prompt }] }],
						generationConfig: {
							temperature: 0.5,
							maxOutputTokens: 1500
						}
					};
					break;
			}
			
			// Effectuer la requête
			const response = await fetch(endpoint, {
				method: 'POST',
				headers: headers,
				body: JSON.stringify(body)
			});
			
			const data = await response.json();
			
			// Extraire le texte de la réponse selon le service
			if (serviceType === 'claude') {
				resultText = data.content?.[0]?.text || "[]";
			} else if (serviceType === 'openai' || serviceType === 'mistral') {
				resultText = data.choices?.[0]?.message?.content || "[]";
			} else if (serviceType === 'gemini') {
				resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "[]";
			}
			
			// Extraire le JSON de la réponse
			let jsonMatch = resultText.match(/\[\s*\{.*\}\s*\]/s);
			let resourcesJson = jsonMatch ? jsonMatch[0] : "[]";
			
			// Parser le JSON
			let resources = [];
			try {
				resources = JSON.parse(resourcesJson);
			} catch (e) {
				console.error("Erreur de parsing JSON:", e);
				// Tenter de réparer le JSON
				const cleanedJson = cleanJsonString(resultText);
				try {
					resources = JSON.parse(cleanedJson);
				} catch (e2) {
					console.error("Impossible de réparer le JSON:", e2);
				}
			}
			
			// Afficher les résultats
			displayMultimediaResults(resources, resultsContainer);
			
		} catch (error) {
			resultsContainer.innerHTML = `
				<div class="search-status">
					<p>Erreur lors de la recherche: ${error.message}</p>
				</div>
			`;
		}
	}
	
	/**
	 * Affiche les résultats de recherche de ressources multimédias
	 */
	function displayMultimediaResults(resources, container) {
		if (!resources || resources.length === 0) {
			container.innerHTML = `
				<div class="search-status">
					<p>Aucune ressource trouvée. Essayez d'autres mots-clés.</p>
				</div>
			`;
			return;
		}
		
		let resultsHtml = '';
		resources.forEach(resource => {
			const thumbnailIcon = getResourceTypeIcon(resource.type);
			resultsHtml += `
				<div class="result-card">
					<div class="result-thumbnail">
						<i class="${thumbnailIcon}" style="font-size: 24px;"></i>
					</div>
					<div class="result-info">
						<div class="result-title">${resource.title}</div>
						<div class="result-description">${resource.description}</div>
						<div class="result-url">
							<a href="${resource.url}" target="_blank">${resource.url}</a>
						</div>
						<div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
							Source: ${resource.source || "Non spécifiée"}
						</div>
					</div>
					<div class="result-actions">
						<button class="add-resource-btn" data-url="${resource.url}" data-title="${resource.title}">
							<i class="fas fa-plus"></i> Ajouter
						</button>
					</div>
				</div>
			`;
		});
		
		container.innerHTML = resultsHtml;
		
		// Ajouter les écouteurs pour les boutons d'ajout
		container.querySelectorAll('.add-resource-btn').forEach(button => {
			button.addEventListener('click', function() {
				const url = this.getAttribute('data-url');
				const title = this.getAttribute('data-title');
				addResourceToScenario(url, title);
			});
		});
	}
	
	/**
	 * Ajoute une ressource au scénario
	 */
	function addResourceToScenario(url, title) {
		// Ajouter la ressource au champ "Remarques et précisions supplémentaires"
		const additionalNotesField = document.getElementById('additional-notes');
		const currentNotes = additionalNotesField.value;
		
		const resourceText = `Ressource multimédia: "${title}" - ${url}\n`;
		
		if (currentNotes) {
			additionalNotesField.value = currentNotes + "\n" + resourceText;
		} else {
			additionalNotesField.value = resourceText;
		}
		
		// Cocher automatiquement l'option "Intégrer des ressources multimédias"
		document.getElementById('include-multimedia').checked = true;
		document.getElementById('multimedia-options').classList.remove('hidden');
		
		// Notification à l'utilisateur
		alert(`Ressource "${title}" ajoutée avec succès !`);
	}
	
	/**
	 * Nettoie une chaîne JSON potentiellement mal formée
	 */
	function cleanJsonString(jsonString) {
		// Trouver le début et la fin du tableau JSON
		const startIndex = jsonString.indexOf('[');
		const endIndex = jsonString.lastIndexOf(']') + 1;
		
		if (startIndex === -1 || endIndex === 0) {
			return "[]";
		}
		
		return jsonString.substring(startIndex, endIndex);
	}
	
	/**
	 * Renvoie le libellé du type de ressource
	 */
	function getResourceTypeLabel(type) {
		switch(type) {
			case 'videos': return 'vidéos éducatives';
			case 'images': return 'images et illustrations';
			case 'audio': return 'ressources audio';
			case 'interactive': return 'ressources interactives';
			case 'all': return 'ressources multimédias (tous types)';
			default: return 'ressources pédagogiques';
		}
	}
	
	/**
	 * Renvoie le libellé du niveau éducatif
	 */
	function getLevelLabel(level) {
		switch(level) {
			case 'primary': return 'primaire';
			case 'college': return 'collège';
			case 'lycee': return 'lycée';
			case 'superior': return 'supérieur';
			default: return 'collège';
		}
	}
	
	/**
	 * Renvoie l'icône correspondant au type de ressource
	 */
	function getResourceTypeIcon(type) {
		type = type.toLowerCase();
		if (type.includes('vid')) return 'fas fa-video';
		if (type.includes('audio') || type.includes('son')) return 'fas fa-volume-up';
		if (type.includes('image') || type.includes('photo')) return 'fas fa-image';
		if (type.includes('interact') || type.includes('app')) return 'fas fa-laptop';
		if (type.includes('doc') || type.includes('pdf')) return 'fas fa-file-pdf';
		return 'fas fa-link';
	}
	
		// Fonction pour estimer le nombre de tokens dans un texte
	function estimateTokenCount(text) {
		// Estimation de base: environ 4 caractères par token pour les langues latines
		// Cette estimation est approximative et varie selon les modèles d'IA
		const charCount = text.length;
		const estimatedTokens = Math.round(charCount / 4);
		return estimatedTokens;
	}
	
	// Fonction pour mettre à jour les statistiques du prompt
	function updatePromptStats() {
		const promptText = document.getElementById('generated-prompt').textContent;
		
		// Compter les lignes (en divisant par les sauts de ligne)
		const lines = promptText.split('\n');
		const lineCount = lines.length;
		
		// Estimer les tokens
		const tokenCount = estimateTokenCount(promptText);
		
		// Compter les caractères
		const charCount = promptText.length;
		
		// Mettre à jour l'affichage
		document.getElementById('token-count').textContent = tokenCount.toLocaleString();
		document.getElementById('line-count').textContent = lineCount.toLocaleString();
		document.getElementById('char-count').textContent = charCount.toLocaleString();
	}

	</script>
		
    
</body>
</html>