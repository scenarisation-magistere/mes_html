<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercices Interactifs</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .formula {
            text-align: center;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
            color: #444;
        }
        
        .exercises {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .exercise-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .material-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .question-text {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #333;
        }
        
        .data-table {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #666;
        }
        
        .data-value {
            font-weight: bold;
            color: #333;
        }
        
        .input-group {
            margin-top: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .check-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .check-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .check-btn:disabled {
            background: #a0aef8;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .result.show {
            opacity: 1;
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hint {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .score {
            color: #667eea;
            font-size: 1.2em;
            margin-right: 15px;
        }
        
        .fullscreen-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .fullscreen-btn:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }
        
        .fullscreen-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .finish-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto 0;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .finish-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .finish-btn:disabled {
            background: #8fcb99;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }

        #scorm-debug {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            font-size: 12px;
            font-family: monospace;
            display: none;
        }

        @media (max-width: 768px) {
            .exercises {
                grid-template-columns: 1fr;
            }
            
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
                display: flex;
                justify-content: center;
                width: 100%;
            }
        }
        
        /* Styles pour le mode plein écran */
        .fullscreen-container {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">6</span>
        <button id="fullscreenBtn" class="fullscreen-btn" title="Mode plein écran">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
            </svg>
        </button>
    </div>
    
    <div class="container">
        <h1>Exercices Interactifs</h1>
        
        <div class="formula">
            Formule Générique: A = B × C × D
            <br>
            <small style="font-weight: normal; color: #666;">
                Formule pour résoudre les exercices ci-dessous
            </small>
        </div>
        
        <div class="exercises">
            <!-- Exercice 1 -->
            <div class="exercise-card" data-exercise="1">
                <div class="material-header">
                    <span>Exercice 1</span>
                </div>
                
                <div class="question-text">
                    Calculez A en utilisant la formule A = B × C × D
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label">Valeur B :</span>
                        <span class="data-value">2,5</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur C :</span>
                        <span class="data-value">4</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur D :</span>
                        <span class="data-value">20</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Valeur A :</label>
                    <input type="number" id="answer1" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkAnswer(1, 200)">Vérifier</button>
                    <div class="result" id="result1"></div>
                    <div class="hint" id="hint1">💡 Appliquez simplement la formule A = B × C × D</div>
                </div>
            </div>
            
            <!-- Exercice 2 -->
            <div class="exercise-card" data-exercise="2">
                <div class="material-header">
                    <span>Exercice 2</span>
                </div>
                
                <div class="question-text">
                    Calculez A en utilisant la formule A = B × C × D
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label">Valeur B :</span>
                        <span class="data-value">0,8</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur C :</span>
                        <span class="data-value">9</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur D :</span>
                        <span class="data-value">15</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Valeur A :</label>
                    <input type="number" id="answer2" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkAnswer(2, 108)">Vérifier</button>
                    <div class="result" id="result2"></div>
                    <div class="hint" id="hint2">💡 N'oubliez pas que B est un nombre décimal</div>
                </div>
            </div>
            
            <!-- Exercice 3 -->
            <div class="exercise-card" data-exercise="3">
                <div class="material-header">
                    <span>Exercice 3</span>
                </div>
                
                <div class="question-text">
                    Calculez A en utilisant la formule A = B × C × D
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label">Valeur B :</span>
                        <span class="data-value">3,2</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur C :</span>
                        <span class="data-value">4,5</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur D :</span>
                        <span class="data-value">15</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Valeur A :</label>
                    <input type="number" id="answer3" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkAnswer(3, 216)">Vérifier</button>
                    <div class="result" id="result3"></div>
                    <div class="hint" id="hint3">💡 Calculez B × C × D avec précision</div>
                </div>
            </div>
            
            <!-- Exercice 4 -->
            <div class="exercise-card" data-exercise="4">
                <div class="material-header">
                    <span>Exercice 4</span>
                </div>
                
                <div class="question-text">
                    Calculez A en utilisant la formule A = B × C × D
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label">Valeur B :</span>
                        <span class="data-value">1,5</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur C :</span>
                        <span class="data-value">3,9</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur D :</span>
                        <span class="data-value">20</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Valeur A :</label>
                    <input type="number" id="answer4" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkAnswer(4, 117)">Vérifier</button>
                    <div class="result" id="result4"></div>
                    <div class="hint" id="hint4">💡 Multipliez les trois valeurs</div>
                </div>
            </div>
            
            <!-- Exercice 5 -->
            <div class="exercise-card" data-exercise="5">
                <div class="material-header">
                    <span>Exercice 5</span>
                </div>
                
                <div class="question-text">
                    Calculez A en utilisant la formule A = B × C × D
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label">Valeur B :</span>
                        <span class="data-value">0,5</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur C :</span>
                        <span class="data-value">20</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur D :</span>
                        <span class="data-value">18</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Valeur A :</label>
                    <input type="number" id="answer5" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkAnswer(5, 180)">Vérifier</button>
                    <div class="result" id="result5"></div>
                    <div class="hint" id="hint5">💡 Utilisez la formule A = B × C × D</div>
                </div>
            </div>
            
            <!-- Exercice 6 -->
            <div class="exercise-card" data-exercise="6">
                <div class="material-header">
                    <span>Exercice 6</span>
                </div>
                
                <div class="question-text">
                    Calculez A en utilisant la formule A = B × C × D
                </div>
                
                <div class="data-table">
                    <div class="data-row">
                        <span class="data-label">Valeur B :</span>
                        <span class="data-value">5</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur C :</span>
                        <span class="data-value">8,8</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Valeur D :</span>
                        <span class="data-value">10</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Valeur A :</label>
                    <input type="number" id="answer6" placeholder="Entrez votre réponse">
                    <button class="check-btn" onclick="checkAnswer(6, 440)">Vérifier</button>
                    <div class="result" id="result6"></div>
                    <div class="hint" id="hint6">💡 Multipliez 5 × 8,8 × 10</div>
                </div>
            </div>
        </div>
        
        <button id="finishBtn" class="finish-btn">Terminer l'activité</button>
    </div>
    
    <div id="scorm-debug">
        <h3>SCORM Debug</h3>
        <div id="scorm-log"></div>
        <button id="toggleDebugBtn">Masquer</button>
        <button id="testSCORMBtn">Tester SCORM</button>
    </div>
    
    <script>
        // Variables globales pour le quiz
        let score = 0;
        let answered = new Set();
        const totalExercises = 6;
        let startTime = Date.now();
        let testCompleted = false;
        
        // Variables globales pour SCORM
        let API = null;
        let API_1484_11 = null;
        const scormVersion = "2004";
        let initialized = false;
        let terminated = false;
        let lastError = "";
        let suspendData = "";
        let entryStatus = "ab-initio";
        let sessionStartTime = Date.now();
        let totalTime = 0;
        let lastTimeUpdate = sessionStartTime;
        let timeInterval = null;
        
        // Stockage des réponses de l'utilisateur
        let userAnswers = Array(totalExercises).fill(null);
        
        // Activation du bouton "Terminer" dès qu'au moins un exercice est complété
        function updateFinishButton() {
            const finishBtn = document.getElementById('finishBtn');
            if (answered.size >= 1) {
                finishBtn.disabled = false;
            } else {
                finishBtn.disabled = true;
            }
        }
        
        // Fonction principale pour vérifier une réponse
        function checkAnswer(exerciseNum, correctAnswer) {
            const userAnswer = parseFloat(document.getElementById(`answer${exerciseNum}`).value);
            const resultDiv = document.getElementById(`result${exerciseNum}`);
            const hintDiv = document.getElementById(`hint${exerciseNum}`);
            
            if (isNaN(userAnswer)) {
                resultDiv.textContent = "⚠️ Veuillez entrer un nombre";
                resultDiv.className = "result incorrect show";
                return;
            }
            
            const tolerance = Math.abs(correctAnswer) * 0.01; // 1% de tolérance
            const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
            
            if (isCorrect) {
                resultDiv.textContent = "✅ Correct ! Bien joué !";
                resultDiv.className = "result correct show";
                hintDiv.style.display = "none";
                
                if (!answered.has(exerciseNum)) {
                    answered.add(exerciseNum);
                    score++;
                    document.getElementById('score').textContent = score;
                    
                    // Sauvegarder la réponse
                    userAnswers[exerciseNum - 1] = userAnswer;
                    
                    // SCORM: Enregistrer l'interaction
                    recordInteraction(exerciseNum - 1, isCorrect);
                    
                    // SCORM: Sauvegarder le score
                    saveScore(score);
                    
                    // SCORM: Sauvegarder l'état
                    saveState();
                    
                    // Mettre à jour le bouton de fin
                    updateFinishButton();
                }
                
                // Désactiver l'input et le bouton
                document.getElementById(`answer${exerciseNum}`).disabled = true;
                event.target.disabled = true;
            } else {
                resultDiv.textContent = `❌ Incorrect. Réessayez ou vérifiez votre calcul.`;
                resultDiv.className = "result incorrect show";
                hintDiv.style.display = "block";
            }
        }
        
        // Permettre la validation avec Enter
        document.querySelectorAll('input[type="number"]').forEach((input) => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const btn = this.parentElement.querySelector('.check-btn');
                    btn.click();
                }
            });
        });
        
        // Bouton de fin d'activité
        document.getElementById('finishBtn').addEventListener('click', finishTest);
        
        // Fonction pour terminer le test
        function finishTest() {
            // Vérifier si au moins une question est répondue
            if (answered.size === 0) {
                alert("Vous devez répondre à au moins une question avant de terminer l'activité.");
                return;
            }
            
            // Marquer le test comme terminé
            testCompleted = true;
            
            // Afficher le message de fin
            alert(`Activité terminée! Votre score final est de ${score}/${totalExercises}.`);
            
            // SCORM: Marquer comme terminé
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
            setValue("cmi.exit", "normal");
            
            // SCORM: Mettre à jour le temps de session
            updateSessionTime();
            
            // SCORM: Sauvegarder l'état final
            saveState();
            
            // SCORM: Effectuer un commit final
            commitSCORM();
            
            // SCORM: Terminer la session
            terminateSCORM();
            
            console.log("Activité terminée et résultats sauvegardés dans SCORM");
            
            // Désactiver tous les inputs et boutons
            document.querySelectorAll('input, .check-btn, .finish-btn').forEach(el => {
                el.disabled = true;
            });
        }
        
        // ========== FONCTIONS SCORM ==========
        
        // Détection de l'API SCORM
        function findAPI(win) {
            // Recherche SCORM 2004 API
            if (win.API_1484_11) return win.API_1484_11;
            
            // Recherche dans les frames
            let findAPITries = 0;
            while (win.parent && win.parent != win && findAPITries < 10) {
                findAPITries++;
                win = win.parent;
                if (win.API_1484_11) return win.API_1484_11;
            }
            
            // Si on n'a pas trouvé, essayer avec les frames
            let frames = win.frames;
            for (let i = 0; i < frames.length; i++) {
                let api = findAPI(frames[i]);
                if (api) return api;
            }
            
            return null;
        }
        
        // Gestion des erreurs
        function getLastError() {
            if (API_1484_11) {
                let errorCode = API_1484_11.GetLastError();
                let errorString = API_1484_11.GetErrorString(errorCode);
                let errorDescription = API_1484_11.GetDiagnostic(errorCode);
                
                let errorInfo = "Code: " + errorCode + "\nDescription: " + errorString + "\nDiagnostic: " + errorDescription;
                console.error("SCORM Error: " + errorInfo);
                
                lastError = errorInfo;
                return errorCode;
            }
            return 0;
        }
        
        // Initialisation SCORM
        function initSCORM() {
            if (initialized) return true;
            
            // Trouver l'API SCORM 2004
            API_1484_11 = findAPI(window);
            
            if (!API_1484_11) {
                console.error("SCORM API non trouvée");
                return false;
            }
            
            // Initialiser la communication
            let result = API_1484_11.Initialize("");
            
            if (result === "true" || result === true) {
                console.log("SCORM API initialisée avec succès");
                initialized = true;
                
                // Récupérer l'état précédent si disponible
                entryStatus = getValue("cmi.entry");
                suspendData = getValue("cmi.suspend_data");
                
                // Récupérer les données sauvegardées si elles existent
                if (suspendData) {
                    try {
                        restoreState(suspendData);
                    } catch (e) {
                        console.error("Erreur lors de la restauration des données:", e);
                    }
                }
                
                return true;
            } else {
                console.error("Échec de l'initialisation SCORM");
                getLastError();
                return false;
            }
        }
        
        // Définir une valeur SCORM
        function setValue(element, value) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialisée");
                return false;
            }
            
            let result = API_1484_11.SetValue(element, value);
            
            if (result === "false" || result === false) {
                console.error(`Erreur lors de la définition de ${element} = ${value}`);
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Obtenir une valeur SCORM
        function getValue(element) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialisée");
                return "";
            }
            
            let value = API_1484_11.GetValue(element);
            
            if (API_1484_11.GetLastError() !== "0") {
                console.error(`Erreur lors de la récupération de ${element}`);
                getLastError();
                return "";
            }
            
            return value;
        }
        
        // Sauvegarder les changements SCORM
        function commitSCORM() {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialisée");
                return false;
            }
            
            let result = API_1484_11.Commit("");
            
            if (result === "false" || result === false) {
                console.error("Erreur lors du commit SCORM");
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Terminer la session SCORM
        function terminateSCORM() {
            if (!initialized || !API_1484_11 || terminated) {
                return false;
            }
            
            // Arrêter le suivi du temps
            stopTimeTracking();
            
            // Mettre à jour le temps de session final
            updateSessionTime();
            
            // Commit final avant de terminer
            commitSCORM();
            
            // Terminer la session
            let result = API_1484_11.Terminate("");
            
            if (result === "true" || result === true) {
                console.log("Session SCORM terminée avec succès");
                terminated = true;
                return true;
            } else {
                console.error("Erreur lors de la terminaison de la session SCORM");
                getLastError();
                return false;
            }
        }
        
        // Sauvegarde de l'état
        function saveState() {
            // Créer un objet avec toutes les données à sauvegarder
            const stateData = {
                userAnswers: userAnswers,
                score: score,
                answered: Array.from(answered),
                testCompleted: testCompleted
            };
            
            // Convertir en JSON
            suspendData = JSON.stringify(stateData);
            
            // Sauvegarder dans SCORM
            setValue("cmi.suspend_data", suspendData);
            
            // Sauvegarder le score actuel
            saveScore(score);
            
            // Sauvegarder l'état de progression
            saveProgress();
            
            // Commit immédiat pour assurer la persistance des données
            commitSCORM();
            
            console.log("État sauvegardé avec succès après modification");
        }
        
        // Restauration de l'état
        function restoreState(jsonString) {
            if (!jsonString) return;
            
            try {
                const data = JSON.parse(jsonString);
                
                // Restaurer les données
                userAnswers = data.userAnswers || Array(totalExercises).fill(null);
                score = data.score || 0;
                answered = new Set(data.answered || []);
                testCompleted = data.testCompleted || false;
                
                // Mettre à jour l'interface
                document.getElementById('score').textContent = score;
                
                // Mettre à jour chaque exercice
                for (let i = 0; i < userAnswers.length; i++) {
                    if (userAnswers[i] !== null) {
                        const exerciseNum = i + 1;
                        const inputElement = document.getElementById(`answer${exerciseNum}`);
                        const buttonElement = inputElement.parentElement.querySelector('.check-btn');
                        const resultDiv = document.getElementById(`result${exerciseNum}`);
                        
                        // Afficher la réponse
                        inputElement.value = userAnswers[i];
                        inputElement.disabled = true;
                        buttonElement.disabled = true;
                        
                        // Afficher le résultat
                        resultDiv.textContent = "✅ Déjà répondu";
                        resultDiv.className = "result correct show";
                    }
                }
                
                // Mettre à jour le bouton de fin
                updateFinishButton();
                
                // Si le test est déjà terminé, désactiver tous les contrôles
                if (testCompleted) {
                    document.querySelectorAll('input, .check-btn, .finish-btn').forEach(el => {
                        el.disabled = true;
                    });
                    alert("Cette activité a déjà été complétée. Votre score est de " + score + "/" + totalExercises);
                }
                
                console.log("État restauré avec succès");
            } catch (e) {
                console.error("Erreur lors de la restauration de l'état:", e);
            }
        }
        
        // Sauvegarde du score
        function saveScore(currentScore) {
            // Normaliser le score sur 100
            const normalizedScore = Math.min(Math.max((currentScore / totalExercises) * 100, 0), 100);
            
            // Sauvegarder dans SCORM 2004
            setValue("cmi.score.raw", normalizedScore);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", normalizedScore / 100);
            
            // Déterminer si le test est réussi (seuil de réussite à 70%)
            if (testCompleted) {
                const passed = normalizedScore >= 70;
                setValue("cmi.success_status", passed ? "passed" : "failed");
            }
            
            console.log(`Score sauvegardé: ${normalizedScore}/100 (${currentScore}/${totalExercises})`);
            
            // Commit immédiat pour assurer la persistance du score
            commitSCORM();
        }
        
        // Suivi de la progression
        function saveProgress() {
            // Calculer le pourcentage de complétion
            const progress = answered.size / totalExercises;
            
            // Déterminer l'état de complétion
            let completionStatus = "incomplete";
            
            if (testCompleted) {
                completionStatus = "completed";
            } else if (progress > 0) {
                completionStatus = "incomplete";
            } else {
                completionStatus = "not attempted";
            }
            
            // Sauvegarder dans SCORM
            setValue("cmi.completion_status", completionStatus);
            setValue("cmi.progress_measure", progress.toFixed(2));
            
            console.log(`Progression sauvegardée: ${(progress * 100).toFixed(0)}%, état: ${completionStatus}`);
        }
        
        // Enregistrement des interactions
        function recordInteraction(exerciseIndex, isCorrect) {
            if (!initialized) return;
            
            // Générer un ID unique pour l'interaction
            const interactionId = `ex${exerciseIndex}`;
            
            // Type d'interaction (choix numérique)
            const interactionType = "numeric";
            
            // Description de l'exercice
            const description = `Exercice ${exerciseIndex + 1}`;
            
            // Réponse de l'utilisateur
            const learnerAnswer = userAnswers[exerciseIndex].toString();
            
            // Résultat
            const result = isCorrect ? "correct" : "incorrect";
            
            // Horodatage
            const timestamp = new Date().toISOString();
            
            // Poids de l'exercice (1 point par exercice)
            const weighting = "1";
            
            // Durée (non implémentée ici)
            const latency = "PT0H0M0S";
            
            // Nombre total d'interactions jusqu'à présent
            const n = parseInt(getValue("cmi.interactions._count"), 10) || 0;
            
            // Enregistrer l'interaction
            setValue(`cmi.interactions.${n}.id`, interactionId);
            setValue(`cmi.interactions.${n}.type`, interactionType);
            setValue(`cmi.interactions.${n}.description`, description);
            setValue(`cmi.interactions.${n}.learner_response`, learnerAnswer);
            setValue(`cmi.interactions.${n}.result`, result);
            setValue(`cmi.interactions.${n}.timestamp`, timestamp);
            setValue(`cmi.interactions.${n}.weighting`, weighting);
            setValue(`cmi.interactions.${n}.latency`, latency);
            
            console.log(`Interaction enregistrée: Exercice ${exerciseIndex + 1}, Résultat: ${result}`);
            
            // Commit pour sauvegarder cette interaction
            commitSCORM();
        }
        
        // Gestion du temps de session
        function startTimeTracking() {
            sessionStartTime = Date.now();
            lastTimeUpdate = sessionStartTime;
            
            // Mettre à jour le temps toutes les 30 secondes
            timeInterval = setInterval(() => {
                updateSessionTime();
            }, 30000); // 30 secondes
        }
        
        function updateSessionTime() {
            const currentTime = Date.now();
            const elapsedTime = currentTime - lastTimeUpdate;
            
            totalTime += elapsedTime;
            lastTimeUpdate = currentTime;
            
            // Formater le temps selon SCORM 2004
            const formattedTime = formatScormTime(totalTime);
            
            // Sauvegarder dans SCORM
            setValue("cmi.session_time", formattedTime);
            
            // Commit pour sauvegarder le temps
            commitSCORM();
        }
        
        function formatScormTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Format SCORM 2004: PTxHyMzS
            return `PT${hours}H${minutes}M${seconds}S`;
        }
        
        function stopTimeTracking() {
            if (timeInterval) {
                clearInterval(timeInterval);
                updateSessionTime(); // Enregistrer le temps final
            }
        }
        
        // Gestion du débogage SCORM
        function enableSCORMDebugging() {
            const debugContainer = document.getElementById('scorm-debug');
            debugContainer.style.display = 'block';
            
            // Bouton pour masquer/afficher
            const toggleBtn = document.getElementById('toggleDebugBtn');
            toggleBtn.addEventListener('click', () => {
                const log = document.getElementById('scorm-log');
                if (log.style.display === 'none') {
                    log.style.display = 'block';
                    toggleBtn.textContent = 'Masquer';
                } else {
                    log.style.display = 'none';
                    toggleBtn.textContent = 'Afficher';
                }
            });
            
            // Bouton pour tester SCORM
            document.getElementById('testSCORMBtn').addEventListener('click', testSCORMConnection);
            
            // Remplacer console.log pour SCORM
            const originalLog = console.log;
            const originalError = console.error;
            
            console.log = function(message) {
                if (message && typeof message === 'string' && message.includes('SCORM')) {
                    const logElement = document.getElementById('scorm-log');
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = `<span style="color: #8F8;">[LOG]</span> ${message}`;
                    logElement.appendChild(logEntry);
                    logElement.scrollTop = logElement.scrollHeight;
                }
                originalLog.apply(console, arguments);
            };
            
            console.error = function(message) {
                if (message && typeof message === 'string' && message.includes('SCORM')) {
                    const logElement = document.getElementById('scorm-log');
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = `<span style="color: #F88;">[ERR]</span> ${message}`;
                    logElement.appendChild(logEntry);
                    logElement.scrollTop = logElement.scrollHeight;
                }
                originalError.apply(console, arguments);
            };
        }
        
        // Fonction pour tester la connexion SCORM
        function testSCORMConnection() {
            console.log("SCORM: Test de connexion");
            
            const tests = [
                { name: "API Initialisée", value: initialized },
                { name: "API Terminée", value: terminated },
                { name: "Version SCORM", value: scormVersion },
                { name: "Dernière erreur", value: lastError || "Aucune" },
                { name: "Status d'entrée", value: getValue("cmi.entry") || "Non défini" },
                { name: "Score brut", value: getValue("cmi.score.raw") || "Non défini" },
                { name: "Score échelle", value: getValue("cmi.score.scaled") || "Non défini" },
                { name: "Status de réussite", value: getValue("cmi.success_status") || "Non défini" },
                { name: "Status de complétion", value: getValue("cmi.completion_status") || "Non défini" },
                { name: "Temps de session", value: getValue("cmi.session_time") || "Non défini" },
                { name: "Données suspendues", value: getValue("cmi.suspend_data")?.substring(0, 50) + "..." || "Non défini" },
                { name: "Nombre d'interactions", value: getValue("cmi.interactions._count") || "0" }
            ];
            
            const logElement = document.getElementById('scorm-log');
            logElement.innerHTML = '<h4>Résultats du test:</h4>';
            
            tests.forEach(test => {
                const entry = document.createElement('div');
                entry.innerHTML = `<strong>${test.name}:</strong> ${test.value}`;
                logElement.appendChild(entry);
            });
            
            console.log("SCORM: Test terminé");
        }
        
        // Initialisation au chargement
        window.addEventListener('load', () => {
            // Initialiser SCORM
            initSCORM();
            startTimeTracking();
            
            // Activer le débogage en mode développement
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                enableSCORMDebugging();
            }
        });
        
        // Sauvegarde avant déchargement
        window.addEventListener('beforeunload', () => {
            if (!testCompleted) {
                // Sauvegarder l'état actuel
                saveState();
                setValue("cmi.exit", "suspend");
            }
            
            terminateSCORM();
        });
        
        // Événement pour la mise en veille
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // L'utilisateur quitte la page ou la met en arrière-plan
                saveState();
                setValue("cmi.exit", "suspend");
                commitSCORM();
            }
        });
        
        // Gestion du plein écran
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullScreen);
        
        function toggleFullScreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                // Passer en mode plein écran
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
                updateFullscreenButton(true);
                document.body.classList.add('fullscreen-container');
            } else {
                // Quitter le mode plein écran
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                updateFullscreenButton(false);
                document.body.classList.remove('fullscreen-container');
            }
        }
        
        function updateFullscreenButton(isFullscreen) {
            const btn = document.getElementById('fullscreenBtn');
            if (isFullscreen) {
                btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>
                </svg>`;
                btn.title = "Quitter le plein écran";
            } else {
                btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                </svg>`;
                btn.title = "Mode plein écran";
            }
        }
        
        // Détection des changements de plein écran
        document.addEventListener('fullscreenchange', () => {
            updateFullscreenButton(!!document.fullscreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.fullscreenElement);
        });
        document.addEventListener('webkitfullscreenchange', () => {
            updateFullscreenButton(!!document.webkitFullscreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.webkitFullscreenElement);
        });
        document.addEventListener('mozfullscreenchange', () => {
            updateFullscreenButton(!!document.mozFullScreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.mozFullScreenElement);
        });
        document.addEventListener('MSFullscreenChange', () => {
            updateFullscreenButton(!!document.msFullscreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.msFullscreenElement);
        });
    </script>
</body>
</html>