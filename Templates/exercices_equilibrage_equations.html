<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercices d'√©quilibrage d'√©quations chimiques</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .formula {
            text-align: center;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.3em;
            font-weight: bold;
            color: #444;
        }
        
        .exercises {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .exercise-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .material-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .question-text {
            background: #f7f7f7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #333;
        }
        
        .reaction {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            gap: 3px;
            margin: 15px 0;
            padding: 12px 8px;
            background-color: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 1rem;
            overflow-x: auto;
            white-space: nowrap;
            min-height: 60px;
        }
        
        .molecule {
            display: inline-flex;
            align-items: center;
            margin: 0 1px;
        }
        
        .molecule select {
            width: 40px;
            padding: 2px 3px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .plus-sign, .arrow-sign {
            margin: 0 3px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .check-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .check-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .check-btn:disabled {
            background: #a0aef8;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .result.show {
            opacity: 1;
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hint {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .score {
            color: #667eea;
            font-size: 1.2em;
            margin-right: 15px;
        }
        
        .fullscreen-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .fullscreen-btn:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }
        
        .fullscreen-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .finish-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto 0;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .finish-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .finish-btn:disabled {
            background: #8fcb99;
            opacity: 0.7;
            cursor: default;
            transform: none;
        }
        
        #scorm-debug {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            font-size: 12px;
            font-family: monospace;
            display: none;
        }
        
        @media (max-width: 768px) {
            .exercises {
                grid-template-columns: 1fr;
            }
            
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
                display: flex;
                justify-content: center;
                width: 100%;
            }
            
            .reaction {
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px 5px;
            }
        }
        
        /* Styles pour le mode plein √©cran */
        .fullscreen-container {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">6</span>
        <button id="fullscreenBtn" class="fullscreen-btn" title="Mode plein √©cran">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
            </svg>
        </button>
    </div>
    
    <div class="container">
        <h1>Exercices d'√©quilibrage d'√©quations chimiques</h1>
        
        <div class="formula">
            R√®gle de conservation de la mati√®re : Le nombre d'atomes de chaque √©l√©ment doit √™tre identique dans les r√©actifs et les produits
            <br>
            <small style="font-weight: normal; color: #666;">
                Ajustez les coefficients pour √©quilibrer les √©quations
            </small>
        </div>
        
        <div class="exercises">
            <!-- Exercice 1 -->
            <div class="exercise-card" data-exercise="1">
                <div class="material-header">
                    <span>Exercice 1</span>
                </div>
                
                <div class="question-text">
                    √âquilibrez l'√©quation suivante en s√©lectionnant les coefficients appropri√©s.
                </div>
                
                <div class="reaction" id="reaction1"></div>
                
                <div class="input-group">
                    <button class="check-btn" id="check-btn1" onclick="checkEquation(1)">V√©rifier</button>
                    <div class="result" id="result1"></div>
                    <div class="hint" id="hint1">üí° Assurez-vous que le nombre d'atomes de chaque √©l√©ment est √©gal des deux c√¥t√©s de la fl√®che.</div>
                </div>
            </div>
            
            <!-- Exercice 2 -->
            <div class="exercise-card" data-exercise="2">
                <div class="material-header">
                    <span>Exercice 2</span>
                </div>
                
                <div class="question-text">
                    √âquilibrez l'√©quation suivante en s√©lectionnant les coefficients appropri√©s.
                </div>
                
                <div class="reaction" id="reaction2"></div>
                
                <div class="input-group">
                    <button class="check-btn" id="check-btn2" onclick="checkEquation(2)">V√©rifier</button>
                    <div class="result" id="result2"></div>
                    <div class="hint" id="hint2">üí° Commencez par compter les atomes de carbone puis √©quilibrez les autres √©l√©ments.</div>
                </div>
            </div>
            
            <!-- Exercice 3 -->
            <div class="exercise-card" data-exercise="3">
                <div class="material-header">
                    <span>Exercice 3</span>
                </div>
                
                <div class="question-text">
                    √âquilibrez l'√©quation suivante en s√©lectionnant les coefficients appropri√©s.
                </div>
                
                <div class="reaction" id="reaction3"></div>
                
                <div class="input-group">
                    <button class="check-btn" id="check-btn3" onclick="checkEquation(3)">V√©rifier</button>
                    <div class="result" id="result3"></div>
                    <div class="hint" id="hint3">üí° Faites attention aux atomes d'oxyg√®ne de part et d'autre de l'√©quation.</div>
                </div>
            </div>
            
            <!-- Exercice 4 -->
            <div class="exercise-card" data-exercise="4">
                <div class="material-header">
                    <span>Exercice 4</span>
                </div>
                
                <div class="question-text">
                    √âquilibrez l'√©quation suivante en s√©lectionnant les coefficients appropri√©s.
                </div>
                
                <div class="reaction" id="reaction4"></div>
                
                <div class="input-group">
                    <button class="check-btn" id="check-btn4" onclick="checkEquation(4)">V√©rifier</button>
                    <div class="result" id="result4"></div>
                    <div class="hint" id="hint4">üí° Essayez d'√©quilibrer d'abord les m√©taux, puis les autres √©l√©ments.</div>
                </div>
            </div>
            
            <!-- Exercice 5 -->
            <div class="exercise-card" data-exercise="5">
                <div class="material-header">
                    <span>Exercice 5</span>
                </div>
                
                <div class="question-text">
                    √âquilibrez l'√©quation suivante en s√©lectionnant les coefficients appropri√©s.
                </div>
                
                <div class="reaction" id="reaction5"></div>
                
                <div class="input-group">
                    <button class="check-btn" id="check-btn5" onclick="checkEquation(5)">V√©rifier</button>
                    <div class="result" id="result5"></div>
                    <div class="hint" id="hint5">üí° La conservation de la mati√®re est la cl√©.</div>
                </div>
            </div>
            
            <!-- Exercice 6 -->
            <div class="exercise-card" data-exercise="6">
                <div class="material-header">
                    <span>Exercice 6</span>
                </div>
                
                <div class="question-text">
                    √âquilibrez l'√©quation suivante en s√©lectionnant les coefficients appropri√©s.
                </div>
                
                <div class="reaction" id="reaction6"></div>
                
                <div class="input-group">
                    <button class="check-btn" id="check-btn6" onclick="checkEquation(6)">V√©rifier</button>
                    <div class="result" id="result6"></div>
                    <div class="hint" id="hint6">üí° Cette √©quation peut n√©cessiter des coefficients plus √©lev√©s.</div>
                </div>
            </div>
        </div>
        
        <button id="finishBtn" class="finish-btn" disabled>Terminer l'activit√©</button>
    </div>
    
    <div id="scorm-debug">
        <h3>SCORM Debug</h3>
        <div id="scorm-log"></div>
        <button id="toggleDebugBtn">Masquer</button>
        <button id="testSCORMBtn">Tester SCORM</button>
    </div>
    
    <script>
        // Structure des √©quations
        const equations = [
            { // 1: CH‚ÇÑ + O‚ÇÇ ‚Üí CO‚ÇÇ + H‚ÇÇO
                reactifs: [{formule: "CH‚ÇÑ"}, {formule: "O‚ÇÇ"}],
                produits: [{formule: "CO‚ÇÇ"}, {formule: "H‚ÇÇO"}],
                solution: [1, 2, 1, 2]
            },
            { // 2: C‚ÇÇH‚ÇÜ + O‚ÇÇ ‚Üí CO‚ÇÇ + H‚ÇÇO
                reactifs: [{formule: "C‚ÇÇH‚ÇÜ"}, {formule: "O‚ÇÇ"}],
                produits: [{formule: "CO‚ÇÇ"}, {formule: "H‚ÇÇO"}],
                solution: [2, 7, 4, 6]
            },
            { // 3: C‚ÇÉH‚Çà + O‚ÇÇ ‚Üí CO‚ÇÇ + H‚ÇÇO
                reactifs: [{formule: "C‚ÇÉH‚Çà"}, {formule: "O‚ÇÇ"}],
                produits: [{formule: "CO‚ÇÇ"}, {formule: "H‚ÇÇO"}],
                solution: [1, 5, 3, 4]
            },
            { // 4: Fe + O‚ÇÇ ‚Üí Fe‚ÇÇO‚ÇÉ
                reactifs: [{formule: "Fe"}, {formule: "O‚ÇÇ"}],
                produits: [{formule: "Fe‚ÇÇO‚ÇÉ"}],
                solution: [4, 3, 2]
            },
            { // 5: Al + H‚ÇÇO ‚Üí Al(OH)‚ÇÉ + H‚ÇÇ
                reactifs: [{formule: "Al"}, {formule: "H‚ÇÇO"}],
                produits: [{formule: "Al(OH)‚ÇÉ"}, {formule: "H‚ÇÇ"}],
                solution: [2, 6, 2, 3]
            },
            { // 6: CO‚ÇÇ + H‚ÇÇO ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + O‚ÇÇ
                reactifs: [{formule: "CO‚ÇÇ"}, {formule: "H‚ÇÇO"}],
                produits: [{formule: "C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ"}, {formule: "O‚ÇÇ"}],
                solution: [6, 6, 1, 6]
            }
        ];
        
        // Variables globales pour le quiz
        let score = 0;
        let answered = new Set();
        const totalExercises = 6;
        let startTime = Date.now();
        let testCompleted = false;
        
        // Variables globales pour SCORM
        let API = null;
        let API_1484_11 = null;
        const scormVersion = "2004";
        let initialized = false;
        let terminated = false;
        let lastError = "";
        let suspendData = "";
        let entryStatus = "ab-initio";
        let sessionStartTime = Date.now();
        let totalTime = 0;
        let lastTimeUpdate = sessionStartTime;
        let timeInterval = null;
        
        // Stockage des r√©ponses de l'utilisateur
        let userAnswers = Array(totalExercises).fill(null);
        
        // Cr√©ation des menus d√©roulants pour les coefficients (1 √† 10)
        function creerSelectCoefficient(id) {
            const select = document.createElement("select");
            select.id = id;
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement("option");
                option.value = i;
                option.textContent = i;
                select.appendChild(option);
            }
            return select;
        }
        
        // Initialisation des exercices
        function initializeExercises() {
            // Pour chaque exercice, cr√©er l'interface d'√©quation
            for (let exNum = 1; exNum <= 6; exNum++) {
                const equation = equations[exNum - 1];
                const reactionDiv = document.getElementById(`reaction${exNum}`);
                reactionDiv.innerHTML = "";
                
                // R√©actifs
                for (let i = 0; i < equation.reactifs.length; i++) {
                    const reactif = equation.reactifs[i];
                    
                    // Cr√©ation du bloc pour chaque r√©actif
                    const reactifDiv = document.createElement("div");
                    reactifDiv.classList.add("molecule");
                    
                    // Ajout du menu d√©roulant de coefficient
                    const coeffSelect = creerSelectCoefficient(`ex${exNum}_coef_r${i}`);
                    reactifDiv.appendChild(coeffSelect);
                    
                    // Ajout de la formule chimique
                    const formuleSpan = document.createElement("span");
                    formuleSpan.textContent = reactif.formule;
                    reactifDiv.appendChild(formuleSpan);
                    
                    // Ajout √† la r√©action
                    reactionDiv.appendChild(reactifDiv);
                    
                    // Ajouter le signe + si ce n'est pas le dernier r√©actif
                    if (i < equation.reactifs.length - 1) {
                        const plusSign = document.createElement("span");
                        plusSign.classList.add("plus-sign");
                        plusSign.textContent = "+";
                        reactionDiv.appendChild(plusSign);
                    }
                }
                
                // Ajout de la fl√®che
                const arrowSign = document.createElement("span");
                arrowSign.classList.add("arrow-sign");
                arrowSign.textContent = "‚Üí";
                reactionDiv.appendChild(arrowSign);
                
                // Produits
                for (let i = 0; i < equation.produits.length; i++) {
                    const produit = equation.produits[i];
                    
                    // Cr√©ation du bloc pour chaque produit
                    const produitDiv = document.createElement("div");
                    produitDiv.classList.add("molecule");
                    
                    // Ajout du menu d√©roulant de coefficient
                    const coeffSelect = creerSelectCoefficient(`ex${exNum}_coef_p${i}`);
                    produitDiv.appendChild(coeffSelect);
                    
                    // Ajout de la formule chimique
                    const formuleSpan = document.createElement("span");
                    formuleSpan.textContent = produit.formule;
                    produitDiv.appendChild(formuleSpan);
                    
                    // Ajout √† la r√©action
                    reactionDiv.appendChild(produitDiv);
                    
                    // Ajouter le signe + si ce n'est pas le dernier produit
                    if (i < equation.produits.length - 1) {
                        const plusSign = document.createElement("span");
                        plusSign.classList.add("plus-sign");
                        plusSign.textContent = "+";
                        reactionDiv.appendChild(plusSign);
                    }
                }
            }
            
            // Activation du bouton "Terminer" d√®s qu'au moins un exercice est compl√©t√©
            updateFinishButton();
        }
        
        // Mise √† jour du bouton de fin
        function updateFinishButton() {
            const finishBtn = document.getElementById('finishBtn');
            if (answered.size >= 1) {
                finishBtn.disabled = false;
            } else {
                finishBtn.disabled = true;
            }
        }
        
        // V√©rification des √©quations
        function checkEquation(exNum) {
            const equation = equations[exNum - 1];
            const resultDiv = document.getElementById(`result${exNum}`);
            const hintDiv = document.getElementById(`hint${exNum}`);
            
            // R√©cup√©ration des coefficients entr√©s par l'utilisateur
            const coefficients = [];
            
            // Pour les r√©actifs
            for (let i = 0; i < equation.reactifs.length; i++) {
                coefficients.push(parseInt(document.getElementById(`ex${exNum}_coef_r${i}`).value));
            }
            
            // Pour les produits
            for (let i = 0; i < equation.produits.length; i++) {
                coefficients.push(parseInt(document.getElementById(`ex${exNum}_coef_p${i}`).value));
            }
            
            // V√©rification de l'√©quilibrage
            let estEquilibree = true;
            
            // Comparer avec la solution attendue
            if (coefficients.length === equation.solution.length) {
                // V√©rifier si les coefficients sont proportionnels √† la solution
                // Par exemple, si solution = [1, 2, 1, 2] et coefficients = [2, 4, 2, 4]
                const rapport = coefficients[0] / equation.solution[0];
                
                for (let i = 0; i < coefficients.length; i++) {
                    if (coefficients[i] !== equation.solution[i] * rapport) {
                        estEquilibree = false;
                        break;
                    }
                }
            } else {
                estEquilibree = false;
            }
            
            // Sauvegarde de la r√©ponse
            userAnswers[exNum - 1] = coefficients;
            
            // Affichage du r√©sultat
            if (estEquilibree) {
                resultDiv.textContent = "‚úÖ √âquation parfaitement √©quilibr√©e ! Bravo !";
                resultDiv.className = "result correct show";
                hintDiv.style.display = "none";
                
                if (!answered.has(exNum)) {
                    answered.add(exNum);
                    score++;
                    document.getElementById('score').textContent = score;
                    
                    // SCORM: Enregistrer l'interaction
                    recordInteraction(exNum - 1, true);
                    
                    // SCORM: Sauvegarder le score
                    saveScore(score);
                    
                    // SCORM: Sauvegarder l'√©tat
                    saveState();
                    
                    // Mettre √† jour le bouton de fin
                    updateFinishButton();
                }
                
                // D√©sactiver le bouton
                document.getElementById(`check-btn${exNum}`).disabled = true;
                
                // D√©sactiver les s√©lecteurs
                const selectors = document.querySelectorAll(`#reaction${exNum} select`);
                selectors.forEach(selector => {
                    selector.disabled = true;
                });
            } else {
                resultDiv.textContent = "‚ùå L'√©quation n'est pas √©quilibr√©e. Essayez encore.";
                resultDiv.className = "result incorrect show";
                hintDiv.style.display = "block";
                
                // SCORM: Enregistrer l'interaction incorrecte
                recordInteraction(exNum - 1, false);
            }
        }
        
        // Bouton de fin d'activit√©
        document.getElementById('finishBtn').addEventListener('click', finishTest);
        
        // Fonction pour terminer le test
        function finishTest() {
            // V√©rifier si au moins une question est r√©pondue
            if (answered.size === 0) {
                alert("Vous devez r√©soudre au moins un exercice avant de terminer l'activit√©.");
                return;
            }
            
            // Marquer le test comme termin√©
            testCompleted = true;
            
            // Afficher le message de fin
            alert(`Activit√© termin√©e ! Votre score final est de ${score}/${totalExercises}.`);
            
            // SCORM: Marquer comme termin√©
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
            setValue("cmi.exit", "normal");
            
            // SCORM: Mettre √† jour le temps de session
            updateSessionTime();
            
            // SCORM: Sauvegarder l'√©tat final
            saveState();
            
            // SCORM: Effectuer un commit final
            commitSCORM();
            
            // SCORM: Terminer la session
            terminateSCORM();
            
            console.log("Activit√© termin√©e et r√©sultats sauvegard√©s dans SCORM");
            
            // D√©sactiver tous les inputs et boutons
            document.querySelectorAll('select, .check-btn, .finish-btn').forEach(el => {
                el.disabled = true;
            });
        }
        
        // ========== FONCTIONS SCORM ==========
        
        // D√©tection de l'API SCORM
        function findAPI(win) {
            // Recherche SCORM 2004 API
            if (win.API_1484_11) return win.API_1484_11;
            
            // Recherche dans les frames
            let findAPITries = 0;
            while (win.parent && win.parent != win && findAPITries < 10) {
                findAPITries++;
                win = win.parent;
                if (win.API_1484_11) return win.API_1484_11;
            }
            
            // Si on n'a pas trouv√©, essayer avec les frames
            let frames = win.frames;
            for (let i = 0; i < frames.length; i++) {
                let api = findAPI(frames[i]);
                if (api) return api;
            }
            
            return null;
        }
        
        // Gestion des erreurs
        function getLastError() {
            if (API_1484_11) {
                let errorCode = API_1484_11.GetLastError();
                let errorString = API_1484_11.GetErrorString(errorCode);
                let errorDescription = API_1484_11.GetDiagnostic(errorCode);
                
                let errorInfo = "Code: " + errorCode + "\nDescription: " + errorString + "\nDiagnostic: " + errorDescription;
                console.error("SCORM Error: " + errorInfo);
                
                lastError = errorInfo;
                return errorCode;
            }
            return 0;
        }
        
        // Initialisation SCORM
        function initSCORM() {
            if (initialized) return true;
            
            // Trouver l'API SCORM 2004
            API_1484_11 = findAPI(window);
            
            if (!API_1484_11) {
                console.error("SCORM API non trouv√©e");
                return false;
            }
            
            // Initialiser la communication
            let result = API_1484_11.Initialize("");
            
            if (result === "true" || result === true) {
                console.log("SCORM API initialis√©e avec succ√®s");
                initialized = true;
                
                // R√©cup√©rer l'√©tat pr√©c√©dent si disponible
                entryStatus = getValue("cmi.entry");
                suspendData = getValue("cmi.suspend_data");
                
                // R√©cup√©rer les donn√©es sauvegard√©es si elles existent
                if (suspendData) {
                    try {
                        restoreState(suspendData);
                    } catch (e) {
                        console.error("Erreur lors de la restauration des donn√©es:", e);
                    }
                }
                
                return true;
            } else {
                console.error("√âchec de l'initialisation SCORM");
                getLastError();
                return false;
            }
        }
        
        // D√©finir une valeur SCORM
        function setValue(element, value) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.SetValue(element, value);
            
            if (result === "false" || result === false) {
                console.error(`Erreur lors de la d√©finition de ${element} = ${value}`);
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Obtenir une valeur SCORM
        function getValue(element) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return "";
            }
            
            let value = API_1484_11.GetValue(element);
            
            if (API_1484_11.GetLastError() !== "0") {
                console.error(`Erreur lors de la r√©cup√©ration de ${element}`);
                getLastError();
                return "";
            }
            
            return value;
        }
        
        // Sauvegarder les changements SCORM
        function commitSCORM() {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.Commit("");
            
            if (result === "false" || result === false) {
                console.error("Erreur lors du commit SCORM");
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Terminer la session SCORM
        function terminateSCORM() {
            if (!initialized || !API_1484_11 || terminated) {
                return false;
            }
            
            // Arr√™ter le suivi du temps
            stopTimeTracking();
            
            // Mettre √† jour le temps de session final
            updateSessionTime();
            
            // Commit final avant de terminer
            commitSCORM();
            
            // Terminer la session
            let result = API_1484_11.Terminate("");
            
            if (result === "true" || result === true) {
                console.log("Session SCORM termin√©e avec succ√®s");
                terminated = true;
                return true;
            } else {
                console.error("Erreur lors de la terminaison de la session SCORM");
                getLastError();
                return false;
            }
        }
        
        // Sauvegarde de l'√©tat
        function saveState() {
            // Cr√©er un objet avec toutes les donn√©es √† sauvegarder
            const stateData = {
                userAnswers: userAnswers,
                score: score,
                answered: Array.from(answered),
                testCompleted: testCompleted
            };
            
            // Convertir en JSON
            suspendData = JSON.stringify(stateData);
            
            // Sauvegarder dans SCORM
            setValue("cmi.suspend_data", suspendData);
            
            // Sauvegarder le score actuel
            saveScore(score);
            
            // Sauvegarder l'√©tat de progression
            saveProgress();
            
            // Commit imm√©diat pour assurer la persistance des donn√©es
            commitSCORM();
            
            console.log("√âtat sauvegard√© avec succ√®s apr√®s modification");
        }
        
        // Restauration de l'√©tat
        function restoreState(jsonString) {
            if (!jsonString) return;
            
            try {
                const data = JSON.parse(jsonString);
                
                // Restaurer les donn√©es
                userAnswers = data.userAnswers || Array(totalExercises).fill(null);
                score = data.score || 0;
                answered = new Set(data.answered || []);
                testCompleted = data.testCompleted || false;
                
                // Mettre √† jour l'interface
                document.getElementById('score').textContent = score;
                
                // Mettre √† jour chaque exercice
                for (let i = 0; i < userAnswers.length; i++) {
                    if (userAnswers[i] !== null) {
                        const exerciseNum = i + 1;
                        
                        // Mettre √† jour les coefficients
                        for (let j = 0; j < userAnswers[i].length; j++) {
                            let selectorId;
                            if (j < equations[i].reactifs.length) {
                                selectorId = `ex${exerciseNum}_coef_r${j}`;
                            } else {
                                selectorId = `ex${exerciseNum}_coef_p${j - equations[i].reactifs.length}`;
                            }
                            
                            const selector = document.getElementById(selectorId);
                            if (selector) {
                                selector.value = userAnswers[i][j];
                                selector.disabled = answered.has(exerciseNum);
                            }
                        }
                        
                        // Si l'exercice est r√©pondu correctement
                        if (answered.has(exerciseNum)) {
                            const resultDiv = document.getElementById(`result${exerciseNum}`);
                            const checkBtn = document.getElementById(`check-btn${exerciseNum}`);
                            
                            resultDiv.textContent = "‚úÖ √âquation parfaitement √©quilibr√©e ! Bravo !";
                            resultDiv.className = "result correct show";
                            checkBtn.disabled = true;
                        }
                    }
                }
                
                // Mettre √† jour le bouton de fin
                updateFinishButton();
                
                // Si le test est d√©j√† termin√©, d√©sactiver tous les contr√¥les
                if (testCompleted) {
                    document.querySelectorAll('select, .check-btn, .finish-btn').forEach(el => {
                        el.disabled = true;
                    });
                    alert("Cette activit√© a d√©j√† √©t√© compl√©t√©e. Votre score est de " + score + "/" + totalExercises);
                }
                
                console.log("√âtat restaur√© avec succ√®s");
            } catch (e) {
                console.error("Erreur lors de la restauration de l'√©tat:", e);
            }
        }
        
        // Sauvegarde du score
        function saveScore(currentScore) {
            // Normaliser le score sur 100
            const normalizedScore = Math.min(Math.max((currentScore / totalExercises) * 100, 0), 100);
            
            // Sauvegarder dans SCORM 2004
            setValue("cmi.score.raw", normalizedScore);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", normalizedScore / 100);
            
            // D√©terminer si le test est r√©ussi (seuil de r√©ussite √† 70%)
            if (testCompleted) {
                const passed = normalizedScore >= 70;
                setValue("cmi.success_status", passed ? "passed" : "failed");
            }
            
            console.log(`Score sauvegard√©: ${normalizedScore}/100 (${currentScore}/${totalExercises})`);
            
            // Commit imm√©diat pour assurer la persistance du score
            commitSCORM();
        }
        
        // Suivi de la progression
        function saveProgress() {
            // Calculer le pourcentage de compl√©tion
            const progress = answered.size / totalExercises;
            
            // D√©terminer l'√©tat de compl√©tion
            let completionStatus = "incomplete";
            
            if (testCompleted) {
                completionStatus = "completed";
            } else if (progress > 0) {
                completionStatus = "incomplete";
            } else {
                completionStatus = "not attempted";
            }
            
            // Sauvegarder dans SCORM
            setValue("cmi.completion_status", completionStatus);
            setValue("cmi.progress_measure", progress.toFixed(2));
            
            console.log(`Progression sauvegard√©e: ${(progress * 100).toFixed(0)}%, √©tat: ${completionStatus}`);
        }
        
        // Enregistrement des interactions
        function recordInteraction(exerciseIndex, isCorrect) {
            if (!initialized) return;
            
            // G√©n√©rer un ID unique pour l'interaction
            const interactionId = `ex${exerciseIndex}`;
            
            // Type d'interaction
            const interactionType = "performance";
            
            // Description de l'exercice
            const description = `√âquilibrage de l'√©quation ${exerciseIndex + 1}`;
            
            // R√©ponse de l'utilisateur (coefficients s√©par√©s par des virgules)
            const learnerAnswer = userAnswers[exerciseIndex].join(',');
            
            // R√©sultat
            const result = isCorrect ? "correct" : "incorrect";
            
            // Horodatage
            const timestamp = new Date().toISOString();
            
            // Poids de l'exercice (1 point par exercice)
            const weighting = "1";
            
            // Dur√©e (non impl√©ment√©e ici)
            const latency = "PT0H0M0S";
            
            // Nombre total d'interactions jusqu'√† pr√©sent
            const n = parseInt(getValue("cmi.interactions._count"), 10) || 0;
            
            // Enregistrer l'interaction
            setValue(`cmi.interactions.${n}.id`, interactionId);
            setValue(`cmi.interactions.${n}.type`, interactionType);
            setValue(`cmi.interactions.${n}.description`, description);
            setValue(`cmi.interactions.${n}.learner_response`, learnerAnswer);
            setValue(`cmi.interactions.${n}.result`, result);
            setValue(`cmi.interactions.${n}.timestamp`, timestamp);
            setValue(`cmi.interactions.${n}.weighting`, weighting);
            setValue(`cmi.interactions.${n}.latency`, latency);
            
            console.log(`Interaction enregistr√©e: Exercice ${exerciseIndex + 1}, R√©sultat: ${result}`);
            
            // Commit pour sauvegarder cette interaction
            commitSCORM();
        }
        
        // Gestion du temps de session
        function startTimeTracking() {
            sessionStartTime = Date.now();
            lastTimeUpdate = sessionStartTime;
            
            // Mettre √† jour le temps toutes les 30 secondes
            timeInterval = setInterval(() => {
                updateSessionTime();
            }, 30000); // 30 secondes
        }
        
        function updateSessionTime() {
            const currentTime = Date.now();
            const elapsedTime = currentTime - lastTimeUpdate;
            
            totalTime += elapsedTime;
            lastTimeUpdate = currentTime;
            
            // Formater le temps selon SCORM 2004
            const formattedTime = formatScormTime(totalTime);
            
            // Sauvegarder dans SCORM
            setValue("cmi.session_time", formattedTime);
            
            // Commit pour sauvegarder le temps
            commitSCORM();
        }
        
        function formatScormTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Format SCORM 2004: PTxHyMzS
            return `PT${hours}H${minutes}M${seconds}S`;
        }
        
        function stopTimeTracking() {
            if (timeInterval) {
                clearInterval(timeInterval);
                updateSessionTime(); // Enregistrer le temps final
            }
        }
        
        // Gestion du plein √©cran
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullScreen);
        
        function toggleFullScreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                // Passer en mode plein √©cran
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
                updateFullscreenButton(true);
                document.body.classList.add('fullscreen-container');
            } else {
                // Quitter le mode plein √©cran
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                updateFullscreenButton(false);
                document.body.classList.remove('fullscreen-container');
            }
        }
        
        function updateFullscreenButton(isFullscreen) {
            const btn = document.getElementById('fullscreenBtn');
            if (isFullscreen) {
                btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>
                </svg>`;
                btn.title = "Quitter le plein √©cran";
            } else {
                btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                </svg>`;
                btn.title = "Mode plein √©cran";
            }
        }
        
        // D√©tection des changements de plein √©cran
        document.addEventListener('fullscreenchange', () => {
            updateFullscreenButton(!!document.fullscreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.fullscreenElement);
        });
        document.addEventListener('webkitfullscreenchange', () => {
            updateFullscreenButton(!!document.webkitFullscreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.webkitFullscreenElement);
        });
        document.addEventListener('mozfullscreenchange', () => {
            updateFullscreenButton(!!document.mozFullScreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.mozFullScreenElement);
        });
        document.addEventListener('MSFullscreenChange', () => {
            updateFullscreenButton(!!document.msFullscreenElement);
            document.body.classList.toggle('fullscreen-container', !!document.msFullscreenElement);
        });
        
        // Initialisation au chargement
        window.addEventListener('load', () => {
            // Initialiser les exercices
            initializeExercises();
            
            // Initialiser SCORM
            initSCORM();
            startTimeTracking();
            
            // Activer le d√©bogage en mode d√©veloppement
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const debugContainer = document.getElementById('scorm-debug');
                debugContainer.style.display = 'block';
                
                // Bouton pour masquer/afficher
                const toggleBtn = document.getElementById('toggleDebugBtn');
                toggleBtn.addEventListener('click', () => {
                    const log = document.getElementById('scorm-log');
                    if (log.style.display === 'none') {
                        log.style.display = 'block';
                        toggleBtn.textContent = 'Masquer';
                    } else {
                        log.style.display = 'none';
                        toggleBtn.textContent = 'Afficher';
                    }
                });
            }
        });
        
        // Sauvegarde avant d√©chargement
        window.addEventListener('beforeunload', () => {
            if (!testCompleted) {
                // Sauvegarder l'√©tat actuel
                saveState();
                setValue("cmi.exit", "suspend");
            }
            
            terminateSCORM();
        });
        
        // √âv√©nement pour la mise en veille
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // L'utilisateur quitte la page ou la met en arri√®re-plan
                saveState();
                setValue("cmi.exit", "suspend");
                commitSCORM();
            }
        });
    </script>
</body>
</html>