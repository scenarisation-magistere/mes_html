<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application d'appariement par drag-and-drop</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        
        .formula-box {
            text-align: center;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            color: #444;
        }
        
        .formula {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .formula-explanation {
            font-size: 0.9em;
            color: #666;
        }
        
        .exercises {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .exercise-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .exercise-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            justify-content: center;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 10px;
        }
        
        .question-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
        
        .matching-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        
        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .left-column h3, .right-column h3 {
            text-align: center;
            color: #555;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .term-block {
            background: #667eea;
            color: white;
            border: 2px solid #5a67d8;
            padding: 12px;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            font-size: 1.1em;
            text-align: center;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .term-block:hover {
            background: #5a67d8;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .definition-zone {
            background: #f0f7ff;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 12px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            transition: all 0.2s;
            position: relative;
        }
        
        .definition-zone.filled {
            background: white;
            border: 2px solid #667eea;
            font-style: normal;
            padding: 8px;
        }
        
        .definition-zone.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .definition-zone.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .definition-text {
            color: #333;
            font-weight: 500;
            text-align: center;
            flex: 1;
        }
        
        .paired-term {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-right: 10px;
            font-weight: 500;
            display: inline-block;
        }
        
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 5;
        }
        
        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
        }
        
        .check-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .check-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reset-btn:hover {
            background: #e0e0e0;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .result.show {
            opacity: 1;
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hint {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            z-index: 100;
        }
        
        .score {
            color: #667eea;
            font-size: 1.2em;
        }
        
        /* Bouton plein √©cran */
        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .fullscreen-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        
        .fullscreen-icon {
            font-size: 1.5em;
            color: #667eea;
        }

        /* Bouton terminer */
        .finish-activity-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff5722;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
            border: none;
            min-width: 250px;
            text-align: center;
        }
        
        .finish-activity-btn:hover {
            background: #e64a19;
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        
        /* SCORM Debug panel */
        #scorm-debug {
            position: fixed;
            bottom: 10px;
            right: 80px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            font-size: 12px;
            font-family: monospace;
            display: none;
        }

        @media (max-width: 768px) {
            .exercises {
                grid-template-columns: 1fr;
            }
            
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .finish-activity-btn {
                position: static;
                margin: 20px auto;
                display: block;
            }
            
            .matching-area {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">6</span>
    </div>
    
    <div class="container">
        <h1>üîó Application d'appariement par drag-and-drop üéØ</h1>
        
        <div class="formula-box">
            <div class="formula">
                Appariement de termes et d√©finitions
            </div>
            <div class="formula-explanation">
                Glissez chaque terme vers sa d√©finition correspondante pour cr√©er les bonnes paires.
            </div>
        </div>
        
        <div class="exercises">
            <!-- Exercice 1 -->
            <div class="exercise-card" data-exercise="1">
                <div class="question-header">
                    <span class="question-icon">üîó</span>
                    <span>Exercice 1: Associez les termes</span>
                </div>
                
                <div class="matching-area">
                    <div class="left-column">
                        <h3>Termes</h3>
                        <div id="terms1">
                            <div class="term-block" draggable="true" data-pair="1">Terme A</div>
                            <div class="term-block" draggable="true" data-pair="2">Terme B</div>
                            <div class="term-block" draggable="true" data-pair="3">Terme C</div>
                            <div class="term-block" draggable="true" data-pair="4">Terme D</div>
                        </div>
                    </div>
                    
                    <div class="right-column">
                        <h3>D√©finitions</h3>
                        <div id="definitions1">
                            <div class="definition-zone" data-pair="3">
                                <div class="definition-text">D√©finition du terme C</div>
                            </div>
                            <div class="definition-zone" data-pair="1">
                                <div class="definition-text">D√©finition du terme A</div>
                            </div>
                            <div class="definition-zone" data-pair="4">
                                <div class="definition-text">D√©finition du terme D</div>
                            </div>
                            <div class="definition-zone" data-pair="2">
                                <div class="definition-text">D√©finition du terme B</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" onclick="checkMatching(1)">V√©rifier mes associations</button>
                <button class="reset-btn" onclick="resetExercise(1)">R√©initialiser</button>
                <div class="result" id="result1"></div>
                <div class="hint" id="hint1">üí° Lisez attentivement chaque d√©finition avant d'associer</div>
            </div>
            
            <!-- Exercice 2 -->
            <div class="exercise-card" data-exercise="2">
                <div class="question-header">
                    <span class="question-icon">üîó</span>
                    <span>Exercice 2: Associez les termes</span>
                </div>
                
                <div class="matching-area">
                    <div class="left-column">
                        <h3>Termes</h3>
                        <div id="terms2">
                            <div class="term-block" draggable="true" data-pair="1">Terme E</div>
                            <div class="term-block" draggable="true" data-pair="2">Terme F</div>
                            <div class="term-block" draggable="true" data-pair="3">Terme G</div>
                            <div class="term-block" draggable="true" data-pair="4">Terme H</div>
                        </div>
                    </div>
                    
                    <div class="right-column">
                        <h3>D√©finitions</h3>
                        <div id="definitions2">
                            <div class="definition-zone" data-pair="2">
                                <div class="definition-text">D√©finition du terme F</div>
                            </div>
                            <div class="definition-zone" data-pair="4">
                                <div class="definition-text">D√©finition du terme H</div>
                            </div>
                            <div class="definition-zone" data-pair="1">
                                <div class="definition-text">D√©finition du terme E</div>
                            </div>
                            <div class="definition-zone" data-pair="3">
                                <div class="definition-text">D√©finition du terme G</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" onclick="checkMatching(2)">V√©rifier mes associations</button>
                <button class="reset-btn" onclick="resetExercise(2)">R√©initialiser</button>
                <div class="result" id="result2"></div>
                <div class="hint" id="hint2">üí° Recherchez les mots-cl√©s dans les d√©finitions</div>
            </div>
            
            <!-- Exercice 3 -->
            <div class="exercise-card" data-exercise="3">
                <div class="question-header">
                    <span class="question-icon">üîó</span>
                    <span>Exercice 3: Associez les termes</span>
                </div>
                
                <div class="matching-area">
                    <div class="left-column">
                        <h3>Termes</h3>
                        <div id="terms3">
                            <div class="term-block" draggable="true" data-pair="1">Terme I</div>
                            <div class="term-block" draggable="true" data-pair="2">Terme J</div>
                            <div class="term-block" draggable="true" data-pair="3">Terme K</div>
                            <div class="term-block" draggable="true" data-pair="4">Terme L</div>
                        </div>
                    </div>
                    
                    <div class="right-column">
                        <h3>D√©finitions</h3>
                        <div id="definitions3">
                            <div class="definition-zone" data-pair="4">
                                <div class="definition-text">D√©finition du terme L</div>
                            </div>
                            <div class="definition-zone" data-pair="1">
                                <div class="definition-text">D√©finition du terme I</div>
                            </div>
                            <div class="definition-zone" data-pair="3">
                                <div class="definition-text">D√©finition du terme K</div>
                            </div>
                            <div class="definition-zone" data-pair="2">
                                <div class="definition-text">D√©finition du terme J</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" onclick="checkMatching(3)">V√©rifier mes associations</button>
                <button class="reset-btn" onclick="resetExercise(3)">R√©initialiser</button>
                <div class="result" id="result3"></div>
                <div class="hint" id="hint3">üí° Proc√©dez par √©limination si n√©cessaire</div>
            </div>
            
            <!-- Exercice 4 -->
            <div class="exercise-card" data-exercise="4">
                <div class="question-header">
                    <span class="question-icon">üîó</span>
                    <span>Exercice 4: Associez les termes</span>
                </div>
                
                <div class="matching-area">
                    <div class="left-column">
                        <h3>Termes</h3>
                        <div id="terms4">
                            <div class="term-block" draggable="true" data-pair="1">Terme M</div>
                            <div class="term-block" draggable="true" data-pair="2">Terme N</div>
                            <div class="term-block" draggable="true" data-pair="3">Terme O</div>
                            <div class="term-block" draggable="true" data-pair="4">Terme P</div>
                        </div>
                    </div>
                    
                    <div class="right-column">
                        <h3>D√©finitions</h3>
                        <div id="definitions4">
                            <div class="definition-zone" data-pair="3">
                                <div class="definition-text">D√©finition du terme O</div>
                            </div>
                            <div class="definition-zone" data-pair="2">
                                <div class="definition-text">D√©finition du terme N</div>
                            </div>
                            <div class="definition-zone" data-pair="4">
                                <div class="definition-text">D√©finition du terme P</div>
                            </div>
                            <div class="definition-zone" data-pair="1">
                                <div class="definition-text">D√©finition du terme M</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" onclick="checkMatching(4)">V√©rifier mes associations</button>
                <button class="reset-btn" onclick="resetExercise(4)">R√©initialiser</button>
                <div class="result" id="result4"></div>
                <div class="hint" id="hint4">üí° V√©rifiez bien toutes vos associations avant de valider</div>
            </div>
            
            <!-- Exercice 5 -->
            <div class="exercise-card" data-exercise="5">
                <div class="question-header">
                    <span class="question-icon">üîó</span>
                    <span>Exercice 5: Associez les termes</span>
                </div>
                
                <div class="matching-area">
                    <div class="left-column">
                        <h3>Termes</h3>
                        <div id="terms5">
                            <div class="term-block" draggable="true" data-pair="1">Terme Q</div>
                            <div class="term-block" draggable="true" data-pair="2">Terme R</div>
                            <div class="term-block" draggable="true" data-pair="3">Terme S</div>
                            <div class="term-block" draggable="true" data-pair="4">Terme T</div>
                        </div>
                    </div>
                    
                    <div class="right-column">
                        <h3>D√©finitions</h3>
                        <div id="definitions5">
                            <div class="definition-zone" data-pair="2">
                                <div class="definition-text">D√©finition du terme R</div>
                            </div>
                            <div class="definition-zone" data-pair="3">
                                <div class="definition-text">D√©finition du terme S</div>
                            </div>
                            <div class="definition-zone" data-pair="1">
                                <div class="definition-text">D√©finition du terme Q</div>
                            </div>
                            <div class="definition-zone" data-pair="4">
                                <div class="definition-text">D√©finition du terme T</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" onclick="checkMatching(5)">V√©rifier mes associations</button>
                <button class="reset-btn" onclick="resetExercise(5)">R√©initialiser</button>
                <div class="result" id="result5"></div>
                <div class="hint" id="hint5">üí° Faites attention aux d√©tails dans chaque d√©finition</div>
            </div>
            
            <!-- Exercice 6 -->
            <div class="exercise-card" data-exercise="6">
                <div class="question-header">
                    <span class="question-icon">üîó</span>
                    <span>Exercice 6: Associez les termes</span>
                </div>
                
                <div class="matching-area">
                    <div class="left-column">
                        <h3>Termes</h3>
                        <div id="terms6">
                            <div class="term-block" draggable="true" data-pair="1">Terme U</div>
                            <div class="term-block" draggable="true" data-pair="2">Terme V</div>
                            <div class="term-block" draggable="true" data-pair="3">Terme W</div>
                            <div class="term-block" draggable="true" data-pair="4">Terme X</div>
                        </div>
                    </div>
                    
                    <div class="right-column">
                        <h3>D√©finitions</h3>
                        <div id="definitions6">
                            <div class="definition-zone" data-pair="1">
                                <div class="definition-text">D√©finition du terme U</div>
                            </div>
                            <div class="definition-zone" data-pair="4">
                                <div class="definition-text">D√©finition du terme X</div>
                            </div>
                            <div class="definition-zone" data-pair="2">
                                <div class="definition-text">D√©finition du terme V</div>
                            </div>
                            <div class="definition-zone" data-pair="3">
                                <div class="definition-text">D√©finition du terme W</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" onclick="checkMatching(6)">V√©rifier mes associations</button>
                <button class="reset-btn" onclick="resetExercise(6)">R√©initialiser</button>
                <div class="result" id="result6"></div>
                <div class="hint" id="hint6">üí° Relisez chaque paire pour vous assurer de leur coh√©rence</div>
            </div>
        </div>
    </div>
    
    <!-- Bouton terminer l'activit√© -->
    <button class="finish-activity-btn" id="finishActivityBtn">Terminer l'activit√©</button>
    
    <!-- Bouton plein √©cran -->
    <div class="fullscreen-btn" id="fullscreenBtn">
        <span class="fullscreen-icon">‚õ∂</span>
    </div>
    
    <!-- Zone de d√©bogage SCORM (cach√©e par d√©faut) -->
    <div id="scorm-debug">
        <h3>SCORM Debug</h3>
        <div id="scorm-log"></div>
        <button id="toggleDebugBtn">Masquer</button>
        <button id="testScormBtn">Tester SCORM</button>
    </div>
    
    <script>
        /* -------- VARIABLES GLOBALES -------- */
        let score = 0;
        let solved = new Set();
        let allExercisesCompleted = false;
        
        /* -------- VARIABLES GLOBALES SCORM -------- */
        let API = null;
        let API_1484_11 = null;
        const scormVersion = "2004";
        let initialized = false;
        let terminated = false;
        let lastError = "";
        let suspendData = "";
        let entryStatus = "ab-initio";
        let sessionStartTime = Date.now();
        let totalTime = 0;
        let lastTimeUpdate = sessionStartTime;
        let timeInterval = null;
        
        /* -------- INITIALISATION -------- */
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser le SCORM
            initSCORM();
            startTimeTracking();
            
            // Initialiser le drag & drop
            const termBlocks = document.querySelectorAll('.term-block');
            termBlocks.forEach(block => {
                block.addEventListener('dragstart', dragStart);
                block.addEventListener('dragend', dragEnd);
            });
            
            // Obtenir toutes les zones de d√©finition
            const definitionZones = document.querySelectorAll('.definition-zone');
            definitionZones.forEach(zone => {
                zone.addEventListener('dragover', dragOver);
                zone.addEventListener('dragenter', dragEnter);
                zone.addEventListener('dragleave', dragLeave);
                zone.addEventListener('drop', drop);
            });
            
            // Initialiser le bouton terminer
            document.getElementById('finishActivityBtn').addEventListener('click', finishActivity);
            
            // Initialiser le bouton plein √©cran
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // Initialiser les boutons de d√©bogage SCORM
            document.getElementById('toggleDebugBtn').addEventListener('click', toggleDebugPanel);
            document.getElementById('testScormBtn').addEventListener('click', testSCORMConnection);
            
            // Activer le d√©bogage en mode d√©veloppement
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('scorm-debug').style.display = 'block';
            }
            
            // Surveiller les changements de visibilit√© de la page
            document.addEventListener('visibilitychange', handleVisibilityChange);
        });
        
        // Sauvegarde avant d√©chargement
        window.addEventListener('beforeunload', () => {
            if (!allExercisesCompleted) {
                // Sauvegarder l'√©tat actuel
                saveState();
                setValue("cmi.exit", "suspend");
            }
            
            terminateSCORM();
        });
        
        /* -------- FONCTIONS DRAG & DROP -------- */
        function dragStart(e) {
            // Ne pas d√©marrer le drag si on a cliqu√© sur la croix de suppression
            if (e.target.classList.contains('delete-btn')) {
                return;
            }
            
            e.dataTransfer.setData('text/plain', e.target.id);
            e.dataTransfer.setData('application/json', JSON.stringify({
                parentId: e.target.parentElement.id,
                html: e.target.outerHTML,
                pair: e.target.dataset.pair,
                text: e.target.textContent
            }));
            
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }
        
        function dragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        function dragOver(e) {
            e.preventDefault();
        }
        
        function dragEnter(e) {
            e.preventDefault();
            if (e.target.classList.contains('definition-zone')) {
                e.target.classList.add('drag-over');
            }
        }
        
        function dragLeave(e) {
            if (e.target.classList.contains('definition-zone')) {
                e.target.classList.remove('drag-over');
            }
        }
        
        function drop(e) {
            e.preventDefault();
            
            const dropZone = e.target.closest('.definition-zone');
            if (!dropZone) return;
            
            dropZone.classList.remove('drag-over');
            
            // Si la zone contient d√©j√† un terme, ne rien faire
            if (dropZone.classList.contains('filled')) {
                return;
            }
            
            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            
            // Cr√©er l'√©l√©ment pour le terme associ√©
            const pairedTerm = document.createElement('div');
            pairedTerm.className = 'paired-term';
            pairedTerm.textContent = data.text;
            pairedTerm.dataset.pair = data.pair;
            
            // Ajouter le terme avant la d√©finition
            const definitionText = dropZone.querySelector('.definition-text');
            dropZone.insertBefore(pairedTerm, definitionText);
            
            // Marquer la zone comme remplie
            dropZone.classList.add('filled');
            
            // Ajouter le bouton de suppression
            addDeleteButton(dropZone, data.parentId);
            
            // Supprimer le terme de sa position d'origine
            const sourceContainer = document.getElementById(data.parentId);
            const sourceBlocks = sourceContainer.querySelectorAll('.term-block');
            sourceBlocks.forEach(b => {
                if (b.dataset.pair === data.pair) {
                    b.remove();
                }
            });
        }
        
        function addDeleteButton(zone, originalContainerId) {
            // V√©rifier si la zone a d√©j√† un bouton de suppression
            if (zone.querySelector('.delete-btn')) {
                return;
            }
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '√ó';
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                const pairedTerm = zone.querySelector('.paired-term');
                if (!pairedTerm) return;
                
                // R√©cr√©er le bloc de terme
                const termBlock = document.createElement('div');
                termBlock.className = 'term-block';
                termBlock.draggable = true;
                termBlock.dataset.pair = pairedTerm.dataset.pair;
                termBlock.textContent = pairedTerm.textContent;
                
                // Ajouter les √©v√©nements
                termBlock.addEventListener('dragstart', dragStart);
                termBlock.addEventListener('dragend', dragEnd);
                
                // Remettre le terme dans son conteneur d'origine
                const originalContainer = document.getElementById(originalContainerId);
                originalContainer.appendChild(termBlock);
                
                // Nettoyer la zone de d√©finition
                pairedTerm.remove();
                deleteBtn.remove();
                zone.classList.remove('filled', 'correct', 'incorrect');
            });
            
            zone.appendChild(deleteBtn);
        }
        
        /* -------- FONCTIONS DE V√âRIFICATION ET RESET -------- */
        function checkMatching(exerciseNum) {
            const definitionsContainer = document.getElementById(`definitions${exerciseNum}`);
            const definitionZones = definitionsContainer.querySelectorAll('.definition-zone');
            const resultDiv = document.getElementById(`result${exerciseNum}`);
            const hintDiv = document.getElementById(`hint${exerciseNum}`);
            
            let correctCount = 0;
            let allFilled = true;
            
            definitionZones.forEach(zone => {
                // R√©initialiser les classes de feedback
                zone.classList.remove('correct', 'incorrect');
                
                if (!zone.classList.contains('filled')) {
                    allFilled = false;
                    return;
                }
                
                const pairedTerm = zone.querySelector('.paired-term');
                if (pairedTerm && pairedTerm.dataset.pair === zone.dataset.pair) {
                    zone.classList.add('correct');
                    correctCount++;
                } else {
                    zone.classList.add('incorrect');
                }
            });
            
            if (!allFilled) {
                resultDiv.textContent = "‚ö†Ô∏è Associez tous les termes avant de v√©rifier";
                resultDiv.className = "result incorrect show";
                return;
            }
            
            if (correctCount === 4) {
                resultDiv.textContent = "‚úÖ Parfait ! Toutes les associations sont correctes !";
                resultDiv.className = "result correct show";
                hintDiv.style.display = "none";
                
                if (!solved.has(exerciseNum)) {
                    solved.add(exerciseNum);
                    score++;
                    document.getElementById('score').textContent = score;
                    
                    // SCORM: Enregistrer l'interaction pour cet exercice
                    recordInteraction(exerciseNum, true);
                    
                    // SCORM: Sauvegarder l'√©tat et le score
                    saveState();
                    
                    // V√©rifier si tous les exercices sont compl√©t√©s
                    checkAllCompleted();
                }
                
                // D√©sactiver l'exercice
                const checkBtn = document.querySelector(`[data-exercise="${exerciseNum}"] .check-btn`);
                checkBtn.disabled = true;
                
                // Supprimer les boutons de suppression
                definitionZones.forEach(zone => {
                    const deleteBtn = zone.querySelector('.delete-btn');
                    if (deleteBtn) deleteBtn.remove();
                });
            } else {
                resultDiv.textContent = `‚ùå ${correctCount}/4 associations correctes. V√©rifiez les zones en rouge.`;
                resultDiv.className = "result incorrect show";
                hintDiv.style.display = "block";
                
                // SCORM: Enregistrer l'interaction incorrecte
                recordInteraction(exerciseNum, false);
            }
        }
        
        function resetExercise(exerciseNum) {
            const definitionsContainer = document.getElementById(`definitions${exerciseNum}`);
            const definitionZones = definitionsContainer.querySelectorAll('.definition-zone');
            const termsContainer = document.getElementById(`terms${exerciseNum}`);
            const resultDiv = document.getElementById(`result${exerciseNum}`);
            
            // R√©initialiser le r√©sultat
            resultDiv.className = "result";
            
            // Remettre tous les termes dans leur conteneur d'origine
            definitionZones.forEach(zone => {
                const pairedTerm = zone.querySelector('.paired-term');
                const deleteBtn = zone.querySelector('.delete-btn');
                
                if (pairedTerm) {
                    // R√©cr√©er le bloc de terme
                    const termBlock = document.createElement('div');
                    termBlock.className = 'term-block';
                    termBlock.draggable = true;
                    termBlock.dataset.pair = pairedTerm.dataset.pair;
                    termBlock.textContent = pairedTerm.textContent;
                    
                    // Ajouter les √©v√©nements
                    termBlock.addEventListener('dragstart', dragStart);
                    termBlock.addEventListener('dragend', dragEnd);
                    
                    // Ajouter au conteneur des termes
                    termsContainer.appendChild(termBlock);
                    
                    // Nettoyer la zone
                    pairedTerm.remove();
                }
                
                if (deleteBtn) {
                    deleteBtn.remove();
                }
                
                zone.classList.remove('filled', 'correct', 'incorrect');
            });
        }
        
        function checkAllCompleted() {
            const totalExercises = document.querySelectorAll('.exercise-card').length;
            if (solved.size === totalExercises) {
                allExercisesCompleted = true;
                
                // Afficher un message de compl√©tion
                alert("F√©licitations ! Vous avez compl√©t√© tous les exercices d'appariement.");
                
                // SCORM: Marquer comme compl√©t√©
                setValue("cmi.completion_status", "completed");
                setValue("cmi.success_status", score >= (totalExercises * 0.7) ? "passed" : "failed");
                commitSCORM();
            }
        }
        
        /* -------- FONCTIONS UTILITAIRES -------- */
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Erreur lors du passage en plein √©cran : ${err.message}`);
                });
                document.querySelector('.fullscreen-icon').textContent = '‚õù';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.querySelector('.fullscreen-icon').textContent = '‚õ∂';
                }
            }
        }
        
        function finishActivity() {
            const totalExercises = document.querySelectorAll('.exercise-card').length;
            const completedCount = solved.size;
            
            if (completedCount < totalExercises) {
                const confirmation = confirm(`Vous n'avez compl√©t√© que ${completedCount} exercices sur ${totalExercises}. √ätes-vous s√ªr de vouloir terminer l'activit√© ?`);
                if (!confirmation) return;
            }
            
            // Marquer comme termin√©
            allExercisesCompleted = true;
            
            // SCORM: D√©finir l'√©tat final
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", score >= (totalExercises * 0.7) ? "passed" : "failed");
            setValue("cmi.exit", "normal");
            
            // SCORM: Enregistrer le score final
            saveScore();
            
            // SCORM: Sauvegarder l'√©tat final
            saveState();
            
            // SCORM: Terminer la session
            commitSCORM();
            
            // Afficher un r√©sum√©
            alert(`Activit√© termin√©e!\nScore final: ${score}/${totalExercises}\n${score >= (totalExercises * 0.7) ? "R√©ussite" : "√âchec"}`);
            
            // D√©sactiver tous les contr√¥les
            document.querySelectorAll('.check-btn, .reset-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            document.getElementById('finishActivityBtn').disabled = true;
        }
        
        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden') {
                // L'utilisateur quitte la page ou la met en arri√®re-plan
                saveState();
                setValue("cmi.exit", "suspend");
                commitSCORM();
            } else {
                // L'utilisateur revient sur la page
                // Rien √† faire ici, l'√©tat est d√©j√† restaur√© √† l'initialisation
            }
        }
        
        function toggleDebugPanel() {
            const log = document.getElementById('scorm-log');
            const toggleBtn = document.getElementById('toggleDebugBtn');
            
            if (log.style.display === 'none') {
                log.style.display = 'block';
                toggleBtn.textContent = 'Masquer';
            } else {
                log.style.display = 'none';
                toggleBtn.textContent = 'Afficher';
            }
        }
        
        /* -------- FONCTIONS SCORM -------- */
        
        // D√©tection de l'API SCORM
        function findAPI(win) {
            // Recherche SCORM 2004 API
            if (win.API_1484_11) return win.API_1484_11;
            
            // Recherche dans les frames
            let findAPITries = 0;
            while (win.parent && win.parent != win && findAPITries < 10) {
                findAPITries++;
                win = win.parent;
                if (win.API_1484_11) return win.API_1484_11;
            }
            
            // Si on n'a pas trouv√©, essayer avec les frames
            let frames = win.frames;
            for (let i = 0; i < frames.length; i++) {
                let api = findAPI(frames[i]);
                if (api) return api;
            }
            
            return null;
        }
        
        // Gestion des erreurs
        function getLastError() {
            if (API_1484_11) {
                let errorCode = API_1484_11.GetLastError();
                let errorString = API_1484_11.GetErrorString(errorCode);
                let errorDescription = API_1484_11.GetDiagnostic(errorCode);
                
                let errorInfo = "Code: " + errorCode + "\nDescription: " + errorString + "\nDiagnostic: " + errorDescription;
                console.error("SCORM Error: " + errorInfo);
                
                lastError = errorInfo;
                return errorCode;
            }
            return 0;
        }
        
        // Initialisation de la communication SCORM
        function initSCORM() {
            if (initialized) return true;
            
            // Trouver l'API SCORM 2004
            API_1484_11 = findAPI(window);
            
            if (!API_1484_11) {
                console.error("SCORM API non trouv√©e");
                return false;
            }
            
            // Initialiser la communication
            let result = API_1484_11.Initialize("");
            
            if (result === "true" || result === true) {
                console.log("SCORM API initialis√©e avec succ√®s");
                initialized = true;
                
                // R√©cup√©rer l'√©tat pr√©c√©dent si disponible
                entryStatus = getValue("cmi.entry");
                suspendData = getValue("cmi.suspend_data");
                
                // R√©cup√©rer les donn√©es sauvegard√©es si elles existent
                if (suspendData) {
                    try {
                        restoreState(suspendData);
                    } catch (e) {
                        console.error("Erreur lors de la restauration des donn√©es:", e);
                    }
                }
                
                return true;
            } else {
                console.error("√âchec de l'initialisation SCORM");
                getLastError();
                return false;
            }
        }
        
        // D√©finir une valeur SCORM
        function setValue(element, value) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.SetValue(element, value);
            
            if (result === "false" || result === false) {
                console.error(`Erreur lors de la d√©finition de ${element} = ${value}`);
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Obtenir une valeur SCORM
        function getValue(element) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return "";
            }
            
            let value = API_1484_11.GetValue(element);
            
            if (API_1484_11.GetLastError() !== "0") {
                console.error(`Erreur lors de la r√©cup√©ration de ${element}`);
                getLastError();
                return "";
            }
            
            return value;
        }
        
        // Sauvegarder les changements SCORM
        function commitSCORM() {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.Commit("");
            
            if (result === "false" || result === false) {
                console.error("Erreur lors du commit SCORM");
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Terminer la session SCORM
        function terminateSCORM() {
            if (!initialized || !API_1484_11 || terminated) {
                return false;
            }
            
            // Arr√™ter le suivi du temps
            stopTimeTracking();
            
            // Mettre √† jour le temps de session final
            updateSessionTime();
            
            // Commit final avant de terminer
            commitSCORM();
            
            // Terminer la session
            let result = API_1484_11.Terminate("");
            
            if (result === "true" || result === true) {
                console.log("Session SCORM termin√©e avec succ√®s");
                terminated = true;
                return true;
            } else {
                console.error("Erreur lors de la terminaison de la session SCORM");
                getLastError();
                return false;
            }
        }
        
        // Sauvegarder l'√©tat
        function saveState() {
            if (!initialized) return;
            
            // Cr√©er un objet avec toutes les donn√©es √† sauvegarder
            const stateData = {
                score: score,
                solved: Array.from(solved),
                allExercisesCompleted: allExercisesCompleted
            };
            
            // Convertir en JSON
            suspendData = JSON.stringify(stateData);
            
            // Sauvegarder dans SCORM
            setValue("cmi.suspend_data", suspendData);
            
            // Sauvegarder le score actuel
            saveScore();
            
            // Sauvegarder l'√©tat de progression
            saveProgress();
            
            // Commit imm√©diat pour assurer la persistance des donn√©es
            commitSCORM();
            
            console.log("√âtat sauvegard√© avec succ√®s");
        }
        
        // Restaurer l'√©tat pr√©c√©dent
        function restoreState(jsonString) {
            if (!jsonString) return;
            
            try {
                const data = JSON.parse(jsonString);
                
                // Restaurer le score
                score = data.score || 0;
                document.getElementById('score').textContent = score;
                
                // Restaurer les exercices r√©solus
                solved = new Set(data.solved || []);
                
                // Restaurer l'√©tat de compl√©tion
                allExercisesCompleted = data.allExercisesCompleted || false;
                
                // Mettre √† jour l'interface
                updateUIFromState();
                
                console.log("√âtat restaur√© avec succ√®s");
            } catch (e) {
                console.error("Erreur lors de la restauration de l'√©tat:", e);
            }
        }
        
        // Mettre √† jour l'interface √† partir de l'√©tat restaur√©
        function updateUIFromState() {
            // Mettre √† jour l'affichage des exercices r√©solus
            solved.forEach(exerciseNum => {
                // D√©sactiver les contr√¥les pour cet exercice
                const exerciseCard = document.querySelector(`[data-exercise="${exerciseNum}"]`);
                if (exerciseCard) {
                    const checkBtn = exerciseCard.querySelector('.check-btn');
                    if (checkBtn) checkBtn.disabled = true;
                    
                    // Afficher le r√©sultat correct
                    const resultDiv = document.getElementById(`result${exerciseNum}`);
                    if (resultDiv) {
                        resultDiv.textContent = "‚úÖ Parfait ! Toutes les associations sont correctes !";
                        resultDiv.className = "result correct show";
                    }
                    
                    // Cacher l'indice
                    const hintDiv = document.getElementById(`hint${exerciseNum}`);
                    if (hintDiv) hintDiv.style.display = "none";
                }
            });
            
            // Si tous les exercices sont compl√©t√©s, d√©sactiver les contr√¥les
            if (allExercisesCompleted) {
                document.querySelectorAll('.check-btn, .reset-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                document.getElementById('finishActivityBtn').disabled = true;
            }
        }
        
        // Sauvegarder le score
        function saveScore() {
            if (!initialized) return;
            
            const totalExercises = document.querySelectorAll('.exercise-card').length;
            
            // Normaliser le score sur 100
            const normalizedScore = Math.round((score / totalExercises) * 100);
            
            // Sauvegarder dans SCORM 2004
            setValue("cmi.score.raw", normalizedScore);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", (normalizedScore / 100).toFixed(2));
            
            // D√©terminer si le test est r√©ussi (seuil de r√©ussite √† 70%)
            const passed = normalizedScore >= 70;
            setValue("cmi.success_status", passed ? "passed" : "failed");
            
            console.log(`Score sauvegard√©: ${normalizedScore}/100 (${score}/${totalExercises})`);
            
            // Commit imm√©diat pour assurer la persistance du score
            commitSCORM();
        }
        
        // Sauvegarder la progression
        function saveProgress() {
            if (!initialized) return;
            
            const totalExercises = document.querySelectorAll('.exercise-card').length;
            const progress = (solved.size / totalExercises);
            
            // D√©terminer l'√©tat de compl√©tion
            let completionStatus = "incomplete";
            
            if (allExercisesCompleted) {
                completionStatus = "completed";
            } else if (progress > 0) {
                completionStatus = "incomplete";
            } else {
                completionStatus = "not attempted";
            }
            
            // Sauvegarder dans SCORM
            setValue("cmi.completion_status", completionStatus);
            setValue("cmi.progress_measure", progress.toFixed(2));
            
            console.log(`Progression sauvegard√©e: ${(progress * 100).toFixed(0)}%, √©tat: ${completionStatus}`);
        }
        
        // Enregistrer une interaction (r√©ponse √† un exercice)
        function recordInteraction(exerciseNum, isCorrect) {
            if (!initialized) return;
            
            // G√©n√©rer un ID unique pour l'interaction
            const interactionId = `matching_${exerciseNum}`;
            
            // Type d'interaction (appariement)
            const interactionType = "matching";
            
            // Description de la question
            const description = document.querySelector(`[data-exercise="${exerciseNum}"] .question-header span:last-child`).textContent;
            
            // R√©ponse correcte et r√©ponse de l'utilisateur
            const correctAnswer = "all_pairs_matched";
            const learnerAnswer = isCorrect ? "all_pairs_matched" : "incorrect_matches";
            
            // R√©sultat
            const result = isCorrect ? "correct" : "incorrect";
            
            // Horodatage
            const timestamp = new Date().toISOString();
            
            // Poids de la question (1 point par exercice)
            const weighting = "1";
            
            // Nombre total d'interactions jusqu'√† pr√©sent
            const n = parseInt(getValue("cmi.interactions._count"), 10) || 0;
            
            // Enregistrer l'interaction
            setValue(`cmi.interactions.${n}.id`, interactionId);
            setValue(`cmi.interactions.${n}.type`, interactionType);
            setValue(`cmi.interactions.${n}.description`, description);
            setValue(`cmi.interactions.${n}.correct_responses.0.pattern`, correctAnswer);
            setValue(`cmi.interactions.${n}.learner_response`, learnerAnswer);
            setValue(`cmi.interactions.${n}.result`, result);
            setValue(`cmi.interactions.${n}.timestamp`, timestamp);
            setValue(`cmi.interactions.${n}.weighting`, weighting);
            
            console.log(`Interaction enregistr√©e: Exercice ${exerciseNum}, R√©sultat: ${result}`);
            
            // Commit pour sauvegarder cette interaction
            commitSCORM();
        }
        
        // D√©marrer le suivi du temps
        function startTimeTracking() {
            sessionStartTime = Date.now();
            lastTimeUpdate = sessionStartTime;
            
            // Mettre √† jour le temps toutes les 30 secondes
            timeInterval = setInterval(() => {
                updateSessionTime();
            }, 30000); // 30 secondes
        }
        
        // Mettre √† jour le temps de session
        function updateSessionTime() {
            if (!initialized) return;
            
            const currentTime = Date.now();
            const elapsedTime = currentTime - lastTimeUpdate;
            
            totalTime += elapsedTime;
            lastTimeUpdate = currentTime;
            
            // Formater le temps selon SCORM 2004
            const formattedTime = formatScormTime(totalTime);
            
            // Sauvegarder dans SCORM
            setValue("cmi.session_time", formattedTime);
            
            // Commit pour sauvegarder le temps
            commitSCORM();
        }
        
        // Formater le temps pour SCORM 2004
        function formatScormTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Format SCORM 2004: PTxHyMzS
            return `PT${hours}H${minutes}M${seconds}S`;
        }
        
        // Terminer le suivi du temps
        function stopTimeTracking() {
            if (timeInterval) {
                clearInterval(timeInterval);
                updateSessionTime(); // Enregistrer le temps final
            }
        }
        
        // Tester la connexion SCORM
        function testSCORMConnection() {
            console.log("SCORM: Test de connexion");
            
            const tests = [
                { name: "API Initialis√©e", value: initialized },
                { name: "API Termin√©e", value: terminated },
                { name: "Version SCORM", value: scormVersion },
                { name: "Derni√®re erreur", value: lastError || "Aucune" },
                { name: "Status d'entr√©e", value: getValue("cmi.entry") || "Non d√©fini" },
                { name: "Score brut", value: getValue("cmi.score.raw") || "Non d√©fini" },
                { name: "Score √©chelle", value: getValue("cmi.score.scaled") || "Non d√©fini" },
                { name: "Status de r√©ussite", value: getValue("cmi.success_status") || "Non d√©fini" },
                { name: "Status de compl√©tion", value: getValue("cmi.completion_status") || "Non d√©fini" },
                { name: "Temps de session", value: getValue("cmi.session_time") || "Non d√©fini" },
                { name: "Donn√©es suspendues", value: getValue("cmi.suspend_data")?.substring(0, 50) + "..." || "Non d√©fini" },
                { name: "Nombre d'interactions", value: getValue("cmi.interactions._count") || "0" }
            ];
            
            const logElement = document.getElementById('scorm-log');
            logElement.innerHTML = '<h4>R√©sultats du test:</h4>';
            
            tests.forEach(test => {
                const entry = document.createElement('div');
                entry.innerHTML = `<strong>${test.name}:</strong> ${test.value}`;
                logElement.appendChild(entry);
            });
            
            console.log("SCORM: Test termin√©");
        }
    </script>
</body>
</html>