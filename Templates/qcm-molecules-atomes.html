<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM Interactif - Mol√©cules et Atomes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a5276 0%, #154360 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #154360;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #2874A6;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        
        .info-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #e8f6fc;
            border-radius: 10px;
            border: 2px solid #1a5276;
        }
        
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .info-card h3 {
            color: #1a5276;
            margin-bottom: 10px;
            border-bottom: 2px solid #1a5276;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .example-card {
            background: #f8fbff;
            border: 2px solid #e8f6fc;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .example-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1a5276 0%, #154360 100%);
        }
        
        .example-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .example-header {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .example-question {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .answer-btn {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .option-a-btn {
            background: #1a5276;
        }
        
        .option-a-btn:hover {
            background: #154360;
        }
        
        .option-b-btn {
            background: #2874A6;
        }
        
        .option-b-btn:hover {
            background: #21618C;
        }
        
        .option-c-btn {
            background: #3498DB;
        }
        
        .option-c-btn:hover {
            background: #2E86C1;
        }
        
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        
        .correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .explanation {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border: 1px solid #b8daff;
            color: #004085;
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
        }
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            border: 2px solid #1a5276;
            z-index: 100;
        }
        
        .score {
            background: linear-gradient(135deg, #1a5276 0%, #154360 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2em;
        }
        
        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
            border: 2px solid #1a5276;
        }
        
        .fullscreen-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        
        .fullscreen-icon {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
        }
        
        .finish-btn {
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            background: linear-gradient(135deg, #1a5276 0%, #154360 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .finish-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .results-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .results-container h2 {
            color: #1a5276;
            margin-bottom: 20px;
        }
        
        .final-score {
            font-size: 3em;
            font-weight: bold;
            color: #1a5276;
            margin: 30px 0;
        }
        
        .result-message {
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
        }
        
        .failure-message {
            background: #f8d7da;
            color: #721c24;
        }
        
        .molecule-display {
            text-align: center;
            margin: 15px auto;
            width: 300px;
            height: 200px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            background: #f5f9fc;
        }
        
        .molecule-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 82, 118, 0.7);
            padding: 5px;
            display: flex;
            justify-content: center;
            z-index: 10;
        }
        
        .control-btn {
            background: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            margin: 0 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a5276;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: #e8f6fc;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .examples {
                grid-template-columns: 1fr;
            }
            
            .info-box {
                grid-template-columns: 1fr;
            }
            
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .molecule-display {
                width: 250px;
                height: 180px;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        #scorm-debug {
            display: none;
        }
        
        /* Styles pour le mode d√©veloppement */
        .dev-mode #scorm-debug {
            display: block;
        }
    </style>
</head>
<body>
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">6</span>
    </div>
    
    <div class="container">
        <h1>‚öõÔ∏è QCM: Mol√©cules et Atomes ‚öóÔ∏è</h1>
        <div class="subtitle">Testez vos connaissances sur les structures atomiques et mol√©culaires</div>
        
        <div class="info-box">
            <div class="info-card">
                <h3>üìã Instructions</h3>
                <p>Ce questionnaire contient 6 questions √† choix multiples sur les atomes et les mol√©cules. Pour chaque question, s√©lectionnez la r√©ponse qui vous semble correcte. Une fois toutes les questions r√©pondues, cliquez sur "Terminer le test" pour voir vos r√©sultats.</p>
            </div>
            <div class="info-card">
                <h3>üèÜ Notation</h3>
                <p>Chaque r√©ponse correcte vaut 1 point. Score maximum: 6 points. Seuil de r√©ussite: 4/6.</p>
            </div>
        </div>
        
        <div class="examples">
            <!-- Question 1 -->
            <div class="example-card" data-answer="optionB">
                <div class="example-header">
                    <span>Question 1</span>
                </div>
                <div class="example-question">
                    Quelle est la formule chimique de l'eau ?
                </div>
                <div class="molecule-display" id="water-model">
                    <div class="molecule-controls">
                        <button class="control-btn" onclick="rotateMolecule('water', 'reset')">R</button>
                        <button class="control-btn" onclick="rotateMolecule('water', 'pause')">‚è∏Ô∏è</button>
                        <button class="control-btn" onclick="rotateMolecule('water', 'play')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">H‚ÇÇO‚ÇÇ</button>
                    <button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">H‚ÇÇO</button>
                    <button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">HO‚ÇÇ</button>
                </div>
                <div class="result"></div>
                <div class="explanation">
                    La mol√©cule d'eau est compos√©e de deux atomes d'hydrog√®ne et un atome d'oxyg√®ne, ce qui donne la formule chimique <strong>H‚ÇÇO</strong>. Sa structure mol√©culaire est coud√©e avec un angle d'environ 104,5¬∞.
                </div>
            </div>
            
            <!-- Question 2 -->
            <div class="example-card" data-answer="optionC">
                <div class="example-header">
                    <span>Question 2</span>
                </div>
                <div class="example-question">
                    Quel est le type de liaison pr√©sent dans la mol√©cule de diazote (N‚ÇÇ) ?
                </div>
                <div class="molecule-display" id="nitrogen-model">
                    <div class="molecule-controls">
                        <button class="control-btn" onclick="rotateMolecule('nitrogen', 'reset')">R</button>
                        <button class="control-btn" onclick="rotateMolecule('nitrogen', 'pause')">‚è∏Ô∏è</button>
                        <button class="control-btn" onclick="rotateMolecule('nitrogen', 'play')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">Liaison simple</button>
                    <button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">Liaison double</button>
                    <button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">Liaison triple</button>
                </div>
                <div class="result"></div>
                <div class="explanation">
                    La mol√©cule de diazote (N‚ÇÇ) poss√®de une <strong>liaison triple</strong> entre les deux atomes d'azote. Cette triple liaison est tr√®s forte, ce qui explique pourquoi le diazote est tr√®s stable et relativement inerte chimiquement.
                </div>
            </div>
            
            <!-- Question 3 -->
            <div class="example-card" data-answer="optionA">
                <div class="example-header">
                    <span>Question 3</span>
                </div>
                <div class="example-question">
                    Quelle est la g√©om√©trie mol√©culaire du m√©thane (CH‚ÇÑ) ?
                </div>
                <div class="molecule-display" id="methane-model">
                    <div class="molecule-controls">
                        <button class="control-btn" onclick="rotateMolecule('methane', 'reset')">R</button>
                        <button class="control-btn" onclick="rotateMolecule('methane', 'pause')">‚è∏Ô∏è</button>
                        <button class="control-btn" onclick="rotateMolecule('methane', 'play')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">T√©tra√©drique</button>
                    <button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">Trigonale plane</button>
                    <button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">Pyramidale</button>
                </div>
                <div class="result"></div>
                <div class="explanation">
                    Le m√©thane (CH‚ÇÑ) poss√®de une g√©om√©trie <strong>t√©tra√©drique</strong>. L'atome de carbone est au centre, et les quatre atomes d'hydrog√®ne sont dispos√©s aux sommets d'un t√©tra√®dre, avec des angles de liaison de 109,5¬∞.
                </div>
            </div>
            
            <!-- Question 4 -->
            <div class="example-card" data-answer="optionC">
                <div class="example-header">
                    <span>Question 4</span>
                </div>
                <div class="example-question">
                    Quel est l'√©l√©ment chimique qui poss√®de 6 protons dans son noyau ?
                </div>
                <div class="molecule-display" id="carbon-model">
                    <div class="molecule-controls">
                        <button class="control-btn" onclick="rotateMolecule('carbon', 'reset')">R</button>
                        <button class="control-btn" onclick="rotateMolecule('carbon', 'pause')">‚è∏Ô∏è</button>
                        <button class="control-btn" onclick="rotateMolecule('carbon', 'play')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">Oxyg√®ne</button>
                    <button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">Azote</button>
                    <button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">Carbone</button>
                </div>
                <div class="result"></div>
                <div class="explanation">
                    Le <strong>carbone</strong> poss√®de 6 protons dans son noyau, ce qui correspond √† son num√©ro atomique Z=6. Sa configuration √©lectronique est 1s¬≤ 2s¬≤ 2p¬≤, ce qui lui permet de former 4 liaisons covalentes.
                </div>
            </div>
            
            <!-- Question 5 -->
            <div class="example-card" data-answer="optionB">
                <div class="example-header">
                    <span>Question 5</span>
                </div>
                <div class="example-question">
                    Quelle est la formule chimique du dioxyde de carbone ?
                </div>
                <div class="molecule-display" id="carbon-dioxide-model">
                    <div class="molecule-controls">
                        <button class="control-btn" onclick="rotateMolecule('carbon-dioxide', 'reset')">R</button>
                        <button class="control-btn" onclick="rotateMolecule('carbon-dioxide', 'pause')">‚è∏Ô∏è</button>
                        <button class="control-btn" onclick="rotateMolecule('carbon-dioxide', 'play')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">CO</button>
                    <button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">CO‚ÇÇ</button>
                    <button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">C‚ÇÇO</button>
                </div>
                <div class="result"></div>
                <div class="explanation">
                    Le dioxyde de carbone a pour formule <strong>CO‚ÇÇ</strong>. Sa structure est lin√©aire avec l'atome de carbone au centre et deux atomes d'oxyg√®ne de part et d'autre, reli√©s par des liaisons doubles.
                </div>
            </div>
            
            <!-- Question 6 -->
            <div class="example-card" data-answer="optionA">
                <div class="example-header">
                    <span>Question 6</span>
                </div>
                <div class="example-question">
                    Quelle est la g√©om√©trie mol√©culaire de l'ammoniac (NH‚ÇÉ) ?
                </div>
                <div class="molecule-display" id="ammonia-model">
                    <div class="molecule-controls">
                        <button class="control-btn" onclick="rotateMolecule('ammonia', 'reset')">R</button>
                        <button class="control-btn" onclick="rotateMolecule('ammonia', 'pause')">‚è∏Ô∏è</button>
                        <button class="control-btn" onclick="rotateMolecule('ammonia', 'play')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">Pyramidale trigonale</button>
                    <button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">T√©tra√©drique</button>
                    <button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">Trigonale plane</button>
                </div>
                <div class="result"></div>
                <div class="explanation">
                    L'ammoniac (NH‚ÇÉ) poss√®de une g√©om√©trie <strong>pyramidale trigonale</strong>. L'atome d'azote est au sommet de la pyramide, et les trois atomes d'hydrog√®ne forment la base. Cette g√©om√©trie est due √† la pr√©sence d'un doublet non liant sur l'atome d'azote.
                </div>
            </div>
        </div>
        
        <button id="finishBtn" class="finish-btn">Terminer le test</button>
        
        <div id="resultsContainer" class="results-container">
            <h2>R√©sultats du test</h2>
            <div class="final-score">
                <span id="finalScore">0</span>/6
            </div>
            <div id="resultMessage" class="result-message">
                <!-- Message de r√©ussite ou d'√©chec sera affich√© ici -->
            </div>
        </div>
    </div>
    
    <!-- Bouton plein √©cran -->
    <div class="fullscreen-btn" id="fullscreenBtn">
        <svg class="fullscreen-icon" id="fullscreenIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#1a5276" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
        </svg>
    </div>
    
    <script>
        // =====================================================================
        // VARIABLES GLOBALES
        // =====================================================================
        
        // Variables QCM
        let score = 0;
        let answered = new Set();
        let userAnswers = Array(6).fill(null);
        let testCompleted = false;
        let startTime = Date.now();
        
        // Variables Three.js
        let scenes = {};
        let cameras = {};
        let renderers = {};
        let molecules = {};
        let animations = {};
        let animationStatus = {};
        
        // Variables SCORM
        let API = null;
        let API_1484_11 = null;
        const scormVersion = "2004";
        let initialized = false;
        let terminated = false;
        let lastError = "";
        let suspendData = "";
        let entryStatus = "ab-initio";
        let sessionStartTime = Date.now();
        let totalTime = 0;
        let lastTimeUpdate = sessionStartTime;
        let timeInterval = null;
        
        // =====================================================================
        // INITIALISATION
        // =====================================================================
        
        // Initialisation au chargement de la page
        window.addEventListener('load', () => {
            // Initialiser SCORM
            initSCORM();
            startTimeTracking();
            
            // Initialiser les mod√®les 3D
            initMoleculeModels();
            
            // Ajouter √©couteur pour le bouton "Terminer le test"
            document.getElementById('finishBtn').addEventListener('click', finishTest);
            
            // V√©rifier si on est en mode d√©veloppement
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.body.classList.add('dev-mode');
                enableSCORMDebugging();
            }
            
            // Gestion du redimensionnement de la fen√™tre
            window.addEventListener('resize', resizeMoleculeViewers);
        });
        
        // Sauvegarde avant d√©chargement de la page
        window.addEventListener('beforeunload', () => {
            if (!testCompleted) {
                // Sauvegarder l'√©tat actuel
                saveState();
                setValue("cmi.exit", "suspend");
            }
            
            terminateSCORM();
        });
        
        // Gestion de la mise en veille de la page
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // L'utilisateur quitte la page ou la met en arri√®re-plan
                saveState();
                setValue("cmi.exit", "suspend");
                commitSCORM();
            } else {
                // L'utilisateur revient sur la page
                // √âventuellement restaurer l'√©tat si n√©cessaire
            }
        });
        
        // =====================================================================
        // FONCTIONS THREE.JS - MOD√àLES 3D
        // =====================================================================
        
        // Initialiser tous les mod√®les 3D
        function initMoleculeModels() {
            initWaterModel();
            initNitrogenModel();
            initMethaneModel();
            initCarbonModel();
            initCarbonDioxideModel();
            initAmmoniaModel();
            
            // D√©marrer les animations
            animateAllMolecules();
        }
        
        // Redimensionner tous les renderers lors du redimensionnement de la fen√™tre
        function resizeMoleculeViewers() {
            Object.keys(renderers).forEach(key => {
                const container = document.getElementById(`${key}-model`);
                if (container && renderers[key]) {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    
                    renderers[key].setSize(width, height);
                    cameras[key].aspect = width / height;
                    cameras[key].updateProjectionMatrix();
                    
                    renderers[key].render(scenes[key], cameras[key]);
                }
            });
        }
        
        // Animer toutes les mol√©cules
        function animateAllMolecules() {
            requestAnimationFrame(animateAllMolecules);
            
            Object.keys(molecules).forEach(key => {
                if (animationStatus[key] !== 'paused') {
                    molecules[key].rotation.y += 0.01;
                    molecules[key].rotation.x += 0.005;
                    
                    renderers[key].render(scenes[key], cameras[key]);
                }
            });
        }
        
        // Contr√¥ler la rotation d'une mol√©cule sp√©cifique
        function rotateMolecule(moleculeId, action) {
            if (action === 'reset') {
                // R√©initialiser la position
                if (molecules[moleculeId]) {
                    molecules[moleculeId].rotation.x = 0;
                    molecules[moleculeId].rotation.y = 0;
                    molecules[moleculeId].rotation.z = 0;
                    renderers[moleculeId].render(scenes[moleculeId], cameras[moleculeId]);
                }
            } else if (action === 'pause') {
                // Mettre en pause l'animation
                animationStatus[moleculeId] = 'paused';
            } else if (action === 'play') {
                // Reprendre l'animation
                animationStatus[moleculeId] = 'playing';
            }
        }
        
        // Cr√©er un atome (sph√®re)
        function createAtom(color, radius, detail = 16) {
            const geometry = new THREE.SphereGeometry(radius, detail, detail);
            const material = new THREE.MeshPhongMaterial({ 
                color: color, 
                shininess: 80,
                specular: 0x222222
            });
            return new THREE.Mesh(geometry, material);
        }
        
        // Cr√©er une liaison (cylindre)
        function createBond(startPosition, endPosition, color, radius = 0.1) {
            const direction = new THREE.Vector3().subVectors(endPosition, startPosition);
            const midpoint = new THREE.Vector3().addVectors(startPosition, endPosition).multiplyScalar(0.5);
            const length = direction.length();
            
            const geometry = new THREE.CylinderGeometry(radius, radius, length, 12, 1);
            const material = new THREE.MeshPhongMaterial({ color: color });
            
            const cylinder = new THREE.Mesh(geometry, material);
            
            // Positionner et orienter le cylindre
            cylinder.position.copy(midpoint);
            cylinder.lookAt(endPosition);
            cylinder.rotateX(Math.PI / 2);
            
            return cylinder;
        }
        
        // Initialiser une sc√®ne 3D de base
        function initBaseScene(containerId) {
            const container = document.getElementById(containerId);
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Cr√©er la sc√®ne
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f9fc);
            
            // Cr√©er la cam√©ra
            const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.z = 5;
            
            // Cr√©er le renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Vider le container et ajouter le renderer
            container.innerHTML = '';
            container.appendChild(renderer.domElement);
            
            // Ajouter l'√©clairage
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(5, 5, 5);
            scene.add(light1);
            
            const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
            light2.position.set(-5, -5, 5);
            scene.add(light2);
            
            return { scene, camera, renderer };
        }
        
        // Mod√®le de l'eau (H‚ÇÇO)
        function initWaterModel() {
            const id = 'water';
            const { scene, camera, renderer } = initBaseScene(`${id}-model`);
            
            // Cr√©er un groupe pour la mol√©cule
            const molecule = new THREE.Group();
            
            // Cr√©er les atomes
            const oxygen = createAtom(0xff0000, 0.5); // Oxyg√®ne en rouge
            molecule.add(oxygen);
            
            const hydrogen1 = createAtom(0xffffff, 0.3); // Hydrog√®ne en blanc
            hydrogen1.position.set(-0.8, 0.6, 0);
            molecule.add(hydrogen1);
            
            const hydrogen2 = createAtom(0xffffff, 0.3); // Hydrog√®ne en blanc
            hydrogen2.position.set(0.8, 0.6, 0);
            molecule.add(hydrogen2);
            
            // Cr√©er les liaisons
            const bond1 = createBond(oxygen.position, hydrogen1.position, 0xaaaaaa);
            molecule.add(bond1);
            
            const bond2 = createBond(oxygen.position, hydrogen2.position, 0xaaaaaa);
            molecule.add(bond2);
            
            // Ajuster la position de la cam√©ra
            camera.position.z = 3;
            
            // Ajouter la mol√©cule √† la sc√®ne
            scene.add(molecule);
            
            // Stocker les r√©f√©rences
            scenes[id] = scene;
            cameras[id] = camera;
            renderers[id] = renderer;
            molecules[id] = molecule;
            animationStatus[id] = 'playing';
            
            // Rendu initial
            renderer.render(scene, camera);
        }
        
        // Mod√®le du diazote (N‚ÇÇ)
        function initNitrogenModel() {
            const id = 'nitrogen';
            const { scene, camera, renderer } = initBaseScene(`${id}-model`);
            
            // Cr√©er un groupe pour la mol√©cule
            const molecule = new THREE.Group();
            
            // Cr√©er les atomes
            const nitrogen1 = createAtom(0x0000ff, 0.5); // Azote en bleu
            nitrogen1.position.set(-0.7, 0, 0);
            molecule.add(nitrogen1);
            
            const nitrogen2 = createAtom(0x0000ff, 0.5); // Azote en bleu
            nitrogen2.position.set(0.7, 0, 0);
            molecule.add(nitrogen2);
            
            // Cr√©er les liaisons (liaison triple)
            const bond1 = createBond(nitrogen1.position, nitrogen2.position, 0xaaaaaa, 0.15);
            molecule.add(bond1);
            
            const bond2 = createBond(
                new THREE.Vector3(nitrogen1.position.x, nitrogen1.position.y + 0.15, nitrogen1.position.z),
                new THREE.Vector3(nitrogen2.position.x, nitrogen2.position.y + 0.15, nitrogen2.position.z),
                0xaaaaaa, 0.1
            );
            molecule.add(bond2);
            
            const bond3 = createBond(
                new THREE.Vector3(nitrogen1.position.x, nitrogen1.position.y - 0.15, nitrogen1.position.z),
                new THREE.Vector3(nitrogen2.position.x, nitrogen2.position.y - 0.15, nitrogen2.position.z),
                0xaaaaaa, 0.1
            );
            molecule.add(bond3);
            
            // Ajuster la position de la cam√©ra
            camera.position.z = 3;
            
            // Ajouter la mol√©cule √† la sc√®ne
            scene.add(molecule);
            
            // Stocker les r√©f√©rences
            scenes[id] = scene;
            cameras[id] = camera;
            renderers[id] = renderer;
            molecules[id] = molecule;
            animationStatus[id] = 'playing';
            
            // Rendu initial
            renderer.render(scene, camera);
        }
        
        // Mod√®le du m√©thane (CH‚ÇÑ)
        function initMethaneModel() {
            const id = 'methane';
            const { scene, camera, renderer } = initBaseScene(`${id}-model`);
            
            // Cr√©er un groupe pour la mol√©cule
            const molecule = new THREE.Group();
            
            // Cr√©er les atomes
            const carbon = createAtom(0x444444, 0.5); // Carbone en gris
            molecule.add(carbon);
            
            // Positions t√©tra√©driques pour les atomes d'hydrog√®ne
            const positions = [
                new THREE.Vector3(0.8, 0.8, 0.8),
                new THREE.Vector3(-0.8, 0.8, -0.8),
                new THREE.Vector3(0.8, -0.8, -0.8),
                new THREE.Vector3(-0.8, -0.8, 0.8)
            ];
            
            // Cr√©er les hydrog√®nes et les liaisons
            positions.forEach(position => {
                const hydrogen = createAtom(0xffffff, 0.3); // Hydrog√®ne en blanc
                hydrogen.position.copy(position);
                molecule.add(hydrogen);
                
                const bond = createBond(carbon.position, hydrogen.position, 0xaaaaaa);
                molecule.add(bond);
            });
            
            // Ajuster la position de la cam√©ra
            camera.position.z = 4;
            
            // Ajouter la mol√©cule √† la sc√®ne
            scene.add(molecule);
            
            // Stocker les r√©f√©rences
            scenes[id] = scene;
            cameras[id] = camera;
            renderers[id] = renderer;
            molecules[id] = molecule;
            animationStatus[id] = 'playing';
            
            // Rendu initial
            renderer.render(scene, camera);
        }
        
        // Mod√®le du carbone (atome)
        function initCarbonModel() {
            const id = 'carbon';
            const { scene, camera, renderer } = initBaseScene(`${id}-model`);
            
            // Cr√©er un groupe pour l'atome
            const molecule = new THREE.Group();
            
            // Cr√©er l'atome de carbone
            const carbon = createAtom(0x444444, 0.8); // Carbone en gris
            molecule.add(carbon);
            
            // Ajouter une repr√©sentation des √©lectrons (6 √©lectrons)
            const electronGeometry = new THREE.SphereGeometry(0.08, 12, 12);
            const electronMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            
            // 2 √©lectrons dans la couche K (1s¬≤)
            for (let i = 0; i < 2; i++) {
                const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                const angle = (i / 2) * Math.PI * 2;
                electron.position.set(
                    Math.cos(angle) * 0.4,
                    Math.sin(angle) * 0.4,
                    0
                );
                molecule.add(electron);
            }
            
            // 4 √©lectrons dans la couche L (2s¬≤ 2p¬≤)
            for (let i = 0; i < 4; i++) {
                const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                const angle = (i / 4) * Math.PI * 2;
                electron.position.set(
                    Math.cos(angle) * 1,
                    Math.sin(angle) * 1,
                    0
                );
                molecule.add(electron);
            }
            
            // Ajuster la position de la cam√©ra
            camera.position.z = 3;
            
            // Ajouter la mol√©cule √† la sc√®ne
            scene.add(molecule);
            
            // Stocker les r√©f√©rences
            scenes[id] = scene;
            cameras[id] = camera;
            renderers[id] = renderer;
            molecules[id] = molecule;
            animationStatus[id] = 'playing';
            
            // Rendu initial
            renderer.render(scene, camera);
        }
        
        // Mod√®le du dioxyde de carbone (CO‚ÇÇ)
        function initCarbonDioxideModel() {
            const id = 'carbon-dioxide';
            const { scene, camera, renderer } = initBaseScene(`${id}-model`);
            
            // Cr√©er un groupe pour la mol√©cule
            const molecule = new THREE.Group();
            
            // Cr√©er les atomes
            const carbon = createAtom(0x444444, 0.5); // Carbone en gris
            molecule.add(carbon);
            
            const oxygen1 = createAtom(0xff0000, 0.5); // Oxyg√®ne en rouge
            oxygen1.position.set(-1.4, 0, 0);
            molecule.add(oxygen1);
            
            const oxygen2 = createAtom(0xff0000, 0.5); // Oxyg√®ne en rouge
            oxygen2.position.set(1.4, 0, 0);
            molecule.add(oxygen2);
            
            // Cr√©er les liaisons (liaisons doubles)
            const bond1a = createBond(carbon.position, oxygen1.position, 0xaaaaaa, 0.12);
            molecule.add(bond1a);
            
            const bond1b = createBond(
                new THREE.Vector3(carbon.position.x, carbon.position.y + 0.15, carbon.position.z),
                new THREE.Vector3(oxygen1.position.x, oxygen1.position.y + 0.15, oxygen1.position.z),
                0xaaaaaa, 0.08
            );
            molecule.add(bond1b);
            
            const bond2a = createBond(carbon.position, oxygen2.position, 0xaaaaaa, 0.12);
            molecule.add(bond2a);
            
            const bond2b = createBond(
                new THREE.Vector3(carbon.position.x, carbon.position.y + 0.15, carbon.position.z),
                new THREE.Vector3(oxygen2.position.x, oxygen2.position.y + 0.15, oxygen2.position.z),
                0xaaaaaa, 0.08
            );
            molecule.add(bond2b);
            
            // Ajuster la position de la cam√©ra
            camera.position.z = 4;
            
            // Ajouter la mol√©cule √† la sc√®ne
            scene.add(molecule);
            
            // Stocker les r√©f√©rences
            scenes[id] = scene;
            cameras[id] = camera;
            renderers[id] = renderer;
            molecules[id] = molecule;
            animationStatus[id] = 'playing';
            
            // Rendu initial
            renderer.render(scene, camera);
        }
        
        // Mod√®le de l'ammoniac (NH‚ÇÉ)
        function initAmmoniaModel() {
            const id = 'ammonia';
            const { scene, camera, renderer } = initBaseScene(`${id}-model`);
            
            // Cr√©er un groupe pour la mol√©cule
            const molecule = new THREE.Group();
            
            // Cr√©er les atomes
            const nitrogen = createAtom(0x0000ff, 0.5); // Azote en bleu
            nitrogen.position.set(0, 0.4, 0);
            molecule.add(nitrogen);
            
            // Positions pour les atomes d'hydrog√®ne (base de la pyramide)
            const positions = [
                new THREE.Vector3(0, -0.4, 0.8),
                new THREE.Vector3(0.7, -0.4, -0.4),
                new THREE.Vector3(-0.7, -0.4, -0.4)
            ];
            
            // Cr√©er les hydrog√®nes et les liaisons
            positions.forEach(position => {
                const hydrogen = createAtom(0xffffff, 0.3); // Hydrog√®ne en blanc
                hydrogen.position.copy(position);
                molecule.add(hydrogen);
                
                const bond = createBond(nitrogen.position, hydrogen.position, 0xaaaaaa);
                molecule.add(bond);
            });
            
            // Repr√©sentation du doublet non liant
            const doubletGeometry = new THREE.SphereGeometry(0.2, 16, 16);
            const doubletMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x66ccff,
                transparent: true,
                opacity: 0.5
            });
            const doublet = new THREE.Mesh(doubletGeometry, doubletMaterial);
            doublet.position.set(0, 1.1, 0);
            molecule.add(doublet);
            
            // Cr√©er une ligne pointill√©e entre l'azote et le doublet
            const points = [];
            points.push(nitrogen.position);
            points.push(doublet.position);
            
            const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const lineMaterial = new THREE.LineDashedMaterial({
                color: 0x66ccff,
                dashSize: 0.1,
                gapSize: 0.05,
            });
            
            const line = new THREE.Line(lineGeometry, lineMaterial);
            line.computeLineDistances();
            molecule.add(line);
            
            // Ajuster la position de la cam√©ra
            camera.position.z = 4;
            
            // Ajouter la mol√©cule √† la sc√®ne
            scene.add(molecule);
            
            // Stocker les r√©f√©rences
            scenes[id] = scene;
            cameras[id] = camera;
            renderers[id] = renderer;
            molecules[id] = molecule;
            animationStatus[id] = 'playing';
            
            // Rendu initial
            renderer.render(scene, camera);
        }
        
        // =====================================================================
        // FONCTIONS SCORM
        // =====================================================================
        
        // Trouver l'API SCORM
        function findAPI(win) {
            // Recherche SCORM 2004 API
            if (win.API_1484_11) return win.API_1484_11;
            
            // Recherche dans les frames
            let findAPITries = 0;
            while (win.parent && win.parent != win && findAPITries < 10) {
                findAPITries++;
                win = win.parent;
                if (win.API_1484_11) return win.API_1484_11;
            }
            
            // Si on n'a pas trouv√©, essayer avec les frames
            let frames = win.frames;
            for (let i = 0; i < frames.length; i++) {
                let api = findAPI(frames[i]);
                if (api) return api;
            }
            
            return null;
        }
        
        // Obtenir la derni√®re erreur SCORM
        function getLastError() {
            if (API_1484_11) {
                let errorCode = API_1484_11.GetLastError();
                let errorString = API_1484_11.GetErrorString(errorCode);
                let errorDescription = API_1484_11.GetDiagnostic(errorCode);
                
                let errorInfo = "Code: " + errorCode + "\nDescription: " + errorString + "\nDiagnostic: " + errorDescription;
                console.error("SCORM Error: " + errorInfo);
                
                lastError = errorInfo;
                return errorCode;
            }
            return 0;
        }
        
        // Initialiser la communication SCORM
        function initSCORM() {
            if (initialized) return true;
            
            // Trouver l'API SCORM 2004
            API_1484_11 = findAPI(window);
            
            if (!API_1484_11) {
                console.error("SCORM API non trouv√©e");
                return false;
            }
            
            // Initialiser la communication
            let result = API_1484_11.Initialize("");
            
            if (result === "true" || result === true) {
                console.log("SCORM API initialis√©e avec succ√®s");
                initialized = true;
                
                // R√©cup√©rer l'√©tat pr√©c√©dent si disponible
                entryStatus = getValue("cmi.entry");
                suspendData = getValue("cmi.suspend_data");
                
                // R√©cup√©rer les donn√©es sauvegard√©es si elles existent
                if (suspendData) {
                    try {
                        restoreState(suspendData);
                    } catch (e) {
                        console.error("Erreur lors de la restauration des donn√©es:", e);
                    }
                }
                
                return true;
            } else {
                console.error("√âchec de l'initialisation SCORM");
                getLastError();
                return false;
            }
        }
        
        // D√©finir une valeur dans SCORM
        function setValue(element, value) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.SetValue(element, value);
            
            if (result === "false" || result === false) {
                console.error(`Erreur lors de la d√©finition de ${element} = ${value}`);
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Obtenir une valeur depuis SCORM
        function getValue(element) {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return "";
            }
            
            let value = API_1484_11.GetValue(element);
            
            if (API_1484_11.GetLastError() !== "0") {
                console.error(`Erreur lors de la r√©cup√©ration de ${element}`);
                getLastError();
                return "";
            }
            
            return value;
        }
        
        // Sauvegarder les changements dans SCORM
        function commitSCORM() {
            if (!initialized || !API_1484_11) {
                console.error("SCORM API non initialis√©e");
                return false;
            }
            
            let result = API_1484_11.Commit("");
            
            if (result === "false" || result === false) {
                console.error("Erreur lors du commit SCORM");
                getLastError();
                return false;
            }
            
            return true;
        }
        
        // Terminer la session SCORM
        function terminateSCORM() {
            if (!initialized || !API_1484_11 || terminated) {
                return false;
            }
            
            // Arr√™ter le suivi du temps
            stopTimeTracking();
            
            // Mettre √† jour le temps de session final
            updateSessionTime();
            
            // Commit final avant de terminer
            commitSCORM();
            
            // Terminer la session
            let result = API_1484_11.Terminate("");
            
            if (result === "true" || result === true) {
                console.log("Session SCORM termin√©e avec succ√®s");
                terminated = true;
                return true;
            } else {
                console.error("Erreur lors de la terminaison de la session SCORM");
                getLastError();
                return false;
            }
        }
        
        // Sauvegarde de l'√©tat
        function saveState() {
            // Cr√©er un objet avec toutes les donn√©es √† sauvegarder
            const stateData = {
                userAnswers: userAnswers,
                score: score,
                testCompleted: testCompleted,
                answered: Array.from(answered)
            };
            
            // Convertir en JSON
            suspendData = JSON.stringify(stateData);
            
            // Sauvegarder dans SCORM
            setValue("cmi.suspend_data", suspendData);
            
            // Sauvegarder le score actuel
            saveScore(score);
            
            // Sauvegarder l'√©tat de progression
            saveProgress();
            
            // Commit imm√©diat pour assurer la persistance des donn√©es
            commitSCORM();
            
            console.log("√âtat sauvegard√© avec succ√®s apr√®s modification");
        }
        
        // Restaurer l'√©tat pr√©c√©dent
        function restoreState(jsonString) {
            if (!jsonString) return;
            
            try {
                const data = JSON.parse(jsonString);
                
                // Restaurer les donn√©es
                userAnswers = data.userAnswers || Array(6).fill(null);
                score = data.score || 0;
                testCompleted = data.testCompleted || false;
                
                if (data.answered && Array.isArray(data.answered)) {
                    answered = new Set(data.answered);
                }
                
                // Mettre √† jour l'interface
                document.getElementById('score').textContent = score;
                
                // D√©sactiver les boutons des questions d√©j√† r√©pondues
                userAnswers.forEach((answer, index) => {
                    if (answer !== null) {
                        const card = document.querySelectorAll('.example-card')[index];
                        if (card) {
                            const resultDiv = card.querySelector('.result');
                            const explanationDiv = card.querySelector('.explanation');
                            const allButtons = card.querySelectorAll('.answer-btn');
                            
                            // D√©sactiver tous les boutons
                            allButtons.forEach(btn => btn.disabled = true);
                            
                            // Afficher le r√©sultat
                            const correctAnswer = card.dataset.answer;
                            if (answer === correctAnswer) {
                                resultDiv.textContent = "‚úÖ Correct ! ";
                                resultDiv.className = "result correct";
                                resultDiv.style.display = "block";
                            } else {
                                resultDiv.textContent = `‚ùå Incorrect. La bonne r√©ponse est : Option ${correctAnswer.replace("option", "")}`;
                                resultDiv.className = "result incorrect";
                                resultDiv.style.display = "block";
                            }
                            
                            // Afficher l'explication
                            explanationDiv.style.display = "block";
                        }
                    }
                });
                
                // Si le test est d√©j√† compl√©t√©, afficher les r√©sultats
                if (testCompleted) {
                    document.getElementById('resultsContainer').style.display = 'block';
                    document.getElementById('finalScore').textContent = score;
                    
                    const resultMessage = document.getElementById('resultMessage');
                    if (score >= 4) {
                        resultMessage.textContent = "F√©licitations ! Vous avez r√©ussi le test.";
                        resultMessage.className = "result-message success-message";
                    } else {
                        resultMessage.textContent = "Vous n'avez pas atteint le seuil de r√©ussite. Essayez √† nouveau.";
                        resultMessage.className = "result-message failure-message";
                    }
                }
                
                console.log("√âtat restaur√© avec succ√®s");
            } catch (e) {
                console.error("Erreur lors de la restauration de l'√©tat:", e);
            }
        }
        
        // Sauvegarde du score
        function saveScore(currentScore) {
            // Normaliser le score sur 100
            const normalizedScore = Math.min(Math.max(currentScore * 100 / 6, 0), 100);
            
            // Sauvegarder dans SCORM 2004
            setValue("cmi.score.raw", normalizedScore);
            setValue("cmi.score.min", "0");
            setValue("cmi.score.max", "100");
            setValue("cmi.score.scaled", normalizedScore / 100);
            
            // D√©terminer si le test est r√©ussi (seuil de r√©ussite √† 66%)
            if (testCompleted) {
                const passed = normalizedScore >= 66.67;
                setValue("cmi.success_status", passed ? "passed" : "failed");
            }
            
            console.log(`Score sauvegard√©: ${normalizedScore}/100 (${currentScore}/6)`);
            
            // Commit imm√©diat pour assurer la persistance du score
            commitSCORM();
        }
        
        // Suivi de la progression
        function saveProgress() {
            // Calculer le pourcentage de compl√©tion
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            const progress = (answeredCount / 6);
            
            // D√©terminer l'√©tat de compl√©tion
            let completionStatus = "incomplete";
            
            if (testCompleted) {
                completionStatus = "completed";
            } else if (progress > 0) {
                completionStatus = "incomplete";
            } else {
                completionStatus = "not attempted";
            }
            
            // Sauvegarder dans SCORM
            setValue("cmi.completion_status", completionStatus);
            setValue("cmi.progress_measure", progress.toFixed(2));
            
            console.log(`Progression sauvegard√©e: ${(progress * 100).toFixed(0)}%, √©tat: ${completionStatus}`);
        }
        
        // Enregistrer une interaction (r√©ponse √† une question)
        function recordInteraction(questionIndex, userAnswer) {
            if (!initialized) return;
            
            const question = document.querySelectorAll('.example-card')[questionIndex];
            if (!question) return;
            
            // G√©n√©rer un ID unique pour l'interaction
            const interactionId = `q${questionIndex}`;
            
            // Type d'interaction (choix multiple)
            const interactionType = "choice";
            
            // Description de la question
            const description = question.querySelector('.example-question').textContent.trim();
            
            // R√©ponse correcte
            const correctAnswer = question.dataset.answer;
            
            // R√©ponse de l'utilisateur
            const learnerAnswer = userAnswer;
            
            // R√©sultat
            const result = (userAnswer === correctAnswer) ? "correct" : "incorrect";
            
            // Horodatage
            const timestamp = new Date().toISOString();
            
            // Poids de la question (1 point par question)
            const weighting = "1";
            
            // Dur√©e (non impl√©ment√©e ici)
            const latency = "PT0H0M0S";
            
            // Nombre total d'interactions jusqu'√† pr√©sent
            const n = parseInt(getValue("cmi.interactions._count"), 10) || 0;
            
            // Enregistrer l'interaction
            setValue(`cmi.interactions.${n}.id`, interactionId);
            setValue(`cmi.interactions.${n}.type`, interactionType);
            setValue(`cmi.interactions.${n}.description`, description);
            setValue(`cmi.interactions.${n}.correct_responses.0.pattern`, correctAnswer);
            setValue(`cmi.interactions.${n}.learner_response`, learnerAnswer);
            setValue(`cmi.interactions.${n}.result`, result);
            setValue(`cmi.interactions.${n}.timestamp`, timestamp);
            setValue(`cmi.interactions.${n}.weighting`, weighting);
            setValue(`cmi.interactions.${n}.latency`, latency);
            
            console.log(`Interaction enregistr√©e: Question ${questionIndex + 1}, R√©sultat: ${result}`);
            
            // Commit pour sauvegarder cette interaction
            commitSCORM();
        }
        
        // D√©marrer le suivi du temps
        function startTimeTracking() {
            sessionStartTime = Date.now();
            lastTimeUpdate = sessionStartTime;
            
            // Mettre √† jour le temps toutes les 30 secondes
            timeInterval = setInterval(() => {
                updateSessionTime();
            }, 30000); // 30 secondes
        }
        
        // Mettre √† jour le temps de session
        function updateSessionTime() {
            const currentTime = Date.now();
            const elapsedTime = currentTime - lastTimeUpdate;
            
            totalTime += elapsedTime;
            lastTimeUpdate = currentTime;
            
            // Formater le temps selon SCORM 2004
            const formattedTime = formatScormTime(totalTime);
            
            // Sauvegarder dans SCORM
            setValue("cmi.session_time", formattedTime);
            
            // Commit pour sauvegarder le temps
            commitSCORM();
        }
        
        // Formater le temps pour SCORM 2004
        function formatScormTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Format SCORM 2004: PTxHyMzS
            return `PT${hours}H${minutes}M${seconds}S`;
        }
        
        // Terminer le suivi du temps
        function stopTimeTracking() {
            if (timeInterval) {
                clearInterval(timeInterval);
                updateSessionTime(); // Enregistrer le temps final
            }
        }
        
        // =====================================================================
        // FONCTIONS QCM
        // =====================================================================
        
        // V√©rifier la r√©ponse
        function checkAnswer(button, selectedAnswer) {
            const card = button.closest('.example-card');
            const cardIndex = Array.from(document.querySelectorAll('.example-card')).indexOf(card);
            const correctAnswer = card.dataset.answer;
            const resultDiv = card.querySelector('.result');
            const explanationDiv = card.querySelector('.explanation');
            const allButtons = card.querySelectorAll('.answer-btn');
            
            // D√©sactiver tous les boutons pour √©viter plusieurs tentatives
            allButtons.forEach(btn => btn.disabled = true);
            
            // Enregistrer la r√©ponse de l'utilisateur
            userAnswers[cardIndex] = selectedAnswer;
            
            if (selectedAnswer === correctAnswer) {
                resultDiv.textContent = "‚úÖ Correct ! ";
                resultDiv.className = "result correct";
                resultDiv.style.display = "block";
                
                card.style.animation = 'pulse 0.5s ease';
                setTimeout(() => {
                    card.style.animation = '';
                }, 500);
                
                if (!answered.has(card)) {
                    answered.add(card);
                    score++;
                    document.getElementById('score').textContent = score;
                }
            } else {
                resultDiv.textContent = `‚ùå Incorrect. La bonne r√©ponse est l'option ${correctAnswer.replace('option', '')}`;
                resultDiv.className = "result incorrect";
                resultDiv.style.display = "block";
                
                button.style.animation = 'shake 0.5s ease';
                setTimeout(() => {
                    button.style.animation = '';
                }, 500);
            }
            
            // Afficher l'explication dans tous les cas
            explanationDiv.style.display = "block";
            
            // PRIORIT√â: Enregistrer l'interaction dans SCORM
            recordInteraction(cardIndex, selectedAnswer);
            
            // PRIORIT√â: Sauvegarder l'√©tat actuel et le score
            saveState();
            
            // V√©rifier si toutes les questions ont √©t√© r√©pondues
            const allAnswered = userAnswers.every(answer => answer !== null);
            if (allAnswered && !testCompleted) {
                // Afficher le bouton "Terminer" de mani√®re plus visible
                const finishBtn = document.getElementById('finishBtn');
                finishBtn.style.animation = 'pulse 1s infinite';
                finishBtn.textContent = "Toutes les questions sont r√©pondues - Terminer le test";
            }
        }
        
        // Terminer le test
        function finishTest() {
            // V√©rifier si toutes les questions sont r√©pondues
            const unansweredCount = userAnswers.filter(answer => answer === null).length;
            
            if (unansweredCount > 0) {
                if (!confirm(`Vous n'avez pas r√©pondu √† ${unansweredCount} question(s). Voulez-vous vraiment terminer le test?`)) {
                    return;
                }
            }
            
            // Marquer le test comme termin√©
            testCompleted = true;
            
            // PRIORIT√â: Sauvegarder le statut final
            setValue("cmi.completion_status", "completed");
            setValue("cmi.success_status", (score >= 4) ? "passed" : "failed");
            setValue("cmi.exit", "normal");
            
            // Afficher les r√©sultats
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('finalScore').textContent = score;
            
            const resultMessage = document.getElementById('resultMessage');
            if (score >= 4) {
                resultMessage.textContent = "F√©licitations ! Vous avez r√©ussi le test.";
                resultMessage.className = "result-message success-message";
            } else {
                resultMessage.textContent = "Vous n'avez pas atteint le seuil de r√©ussite. Essayez √† nouveau.";
                resultMessage.className = "result-message failure-message";
            }
            
            // Masquer le bouton Terminer
            document.getElementById('finishBtn').style.display = 'none';
            
            // Sauvegarder l'√©tat final
            saveState();
            
            // Effectuer un commit final
            commitSCORM();
            
            console.log("Test termin√© et r√©sultats sauvegard√©s dans SCORM");
        }
        
        // Gestion du mode plein √©cran
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const fullscreenIcon = document.getElementById('fullscreenIcon');
        
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        
        function toggleFullScreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                // Passage en plein √©cran
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
                // Changer l'ic√¥ne pour "r√©duire"
                fullscreenIcon.innerHTML = `
                <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                `;
            } else {
                // Sortie du plein √©cran
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                // Changer l'ic√¥ne pour "plein √©cran"
                fullscreenIcon.innerHTML = `
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                `;
            }
        }
        
        // √âcouter les changements d'√©tat du plein √©cran
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);
        
        function updateFullscreenButton() {
            if (document.fullscreenElement || 
                document.webkitFullscreenElement || 
                document.mozFullScreenElement || 
                document.msFullscreenElement) {
                // En plein √©cran - afficher l'ic√¥ne "r√©duire"
                fullscreenIcon.innerHTML = `
                <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                `;
            } else {
                // Mode normal - afficher l'ic√¥ne "plein √©cran"
                fullscreenIcon.innerHTML = `
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                `;
            }
        }
        
        // =====================================================================
        // D√âBOGAGE SCORM
        // =====================================================================
        
        // Fonctions de d√©bogage SCORM
        function enableSCORMDebugging() {
            const debugContainer = document.createElement('div');
            debugContainer.id = 'scorm-debug';
            debugContainer.style.position = 'fixed';
            debugContainer.style.bottom = '10px';
            debugContainer.style.right = '10px';
            debugContainer.style.background = 'rgba(0,0,0,0.7)';
            debugContainer.style.color = 'white';
            debugContainer.style.padding = '10px';
            debugContainer.style.borderRadius = '5px';
            debugContainer.style.maxHeight = '300px';
            debugContainer.style.overflowY = 'auto';
            debugContainer.style.zIndex = '9999';
            debugContainer.style.fontSize = '12px';
            debugContainer.style.fontFamily = 'monospace';
            debugContainer.innerHTML = '<h3>SCORM Debug</h3><div id="scorm-log"></div>';
            
            // Bouton pour masquer/afficher
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = 'Masquer';
            toggleBtn.style.marginTop = '10px';
            toggleBtn.addEventListener('click', () => {
                const log = document.getElementById('scorm-log');
                if (log.style.display === 'none') {
                    log.style.display = 'block';
                    toggleBtn.textContent = 'Masquer';
                } else {
                    log.style.display = 'none';
                    toggleBtn.textContent = 'Afficher';
                }
            });
            
            debugContainer.appendChild(toggleBtn);
            document.body.appendChild(debugContainer);
            
            // Remplacer console.log pour SCORM
            const originalLog = console.log;
            const originalError = console.error;
            
            console.log = function(message) {
                if (message && typeof message === 'string' && message.includes('SCORM')) {
                    const logElement = document.getElementById('scorm-log');
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = `<span style="color: #8F8;">[LOG]</span> ${message}`;
                    logElement.appendChild(logEntry);
                    logElement.scrollTop = logElement.scrollHeight;
                }
                originalLog.apply(console, arguments);
            };
            
            console.error = function(message) {
                if (message && typeof message === 'string' && message.includes('SCORM')) {
                    const logElement = document.getElementById('scorm-log');
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = `<span style="color: #F88;">[ERR]</span> ${message}`;
                    logElement.appendChild(logEntry);
                    logElement.scrollTop = logElement.scrollHeight;
                }
                originalError.apply(console, arguments);
            };
            
            // Ajouter un bouton pour tester SCORM
            const testBtn = document.createElement('button');
            testBtn.textContent = 'Tester SCORM';
            testBtn.style.marginLeft = '10px';
            testBtn.addEventListener('click', testSCORMConnection);
            debugContainer.appendChild(testBtn);
        }
        
        // Fonction pour tester la connexion SCORM
        function testSCORMConnection() {
            console.log("SCORM: Test de connexion");
            
            const tests = [
                { name: "API Initialis√©e", value: initialized },
                { name: "API Termin√©e", value: terminated },
                { name: "Version SCORM", value: scormVersion },
                { name: "Derni√®re erreur", value: lastError || "Aucune" },
                { name: "Status d'entr√©e", value: getValue("cmi.entry") || "Non d√©fini" },
                { name: "Score brut", value: getValue("cmi.score.raw") || "Non d√©fini" },
                { name: "Score √©chelle", value: getValue("cmi.score.scaled") || "Non d√©fini" },
                { name: "Status de r√©ussite", value: getValue("cmi.success_status") || "Non d√©fini" },
                { name: "Status de compl√©tion", value: getValue("cmi.completion_status") || "Non d√©fini" },
                { name: "Temps de session", value: getValue("cmi.session_time") || "Non d√©fini" },
                { name: "Donn√©es suspendues", value: getValue("cmi.suspend_data")?.substring(0, 50) + "..." || "Non d√©fini" },
                { name: "Nombre d'interactions", value: getValue("cmi.interactions._count") || "0" }
            ];
            
            const logElement = document.getElementById('scorm-log');
            logElement.innerHTML = '<h4>R√©sultats du test:</h4>';
            
            tests.forEach(test => {
                const entry = document.createElement('div');
                entry.innerHTML = `<strong>${test.name}:</strong> ${test.value}`;
                logElement.appendChild(entry);
            });
            
            console.log("SCORM: Test termin√©");
        }
    </script>
</body>
</html>
