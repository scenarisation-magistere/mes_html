<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Generator - Générateur d'Applications Éducatives</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Variables et styles de base */
        :root {
            /* Couleurs principales du gradient */
			--gradient-start: #ea6687;
			--gradient-end: #8c4152;
            
            /* Couleur d'accent et ombres */
            --accent-color: #a24b5f;
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --shadow-light: rgba(255, 255, 255, 0.2);
            
            /* Couleurs des onglets */
            --tab1-color: #a24b5f;
            --tab2-color: #b85570; 
            --tab3-color: #c96581;
            --tab4-color: #da7592;
            --tab5-color: #eb85a3;
            
            /* Couleurs des boutons */
            --btn-primary: #a24b5f;
            --btn-secondary: #9e9e9e;
            --btn-special: #8c4152;
            --btn-danger: #f44336;
            
            /* Autres variables */
            --text-color: #333333;
            --base-color: #f5f5f5;
            --transition: all 0.3s ease;
            
            /* Nouvelles variables pour les prévisualisations */
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #ed8936;
            --border-radius: 12px;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.05), 0 6px 6px rgba(0,0,0,0.1);
            --light-bg: #f8f9fa;
            --mid-text: #555;
            --light-text: #888;
            
			/* Nouvelles couleurs pour les catégories de templates */
			--math-color: #ff9b9b;       /* Rouge pâle pour mathématiques */
			--general-color: #ea6687;    /* Bleu pour templates généralistes (inchangé) */
			--science-color: #4ade80;    /* Vert pour sciences */
			--programming-color: #fcd34d; /* Jaune pour programmation */
        }

        /* Styles globaux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 20px;
            background-color: white;
            box-shadow: 8px 8px 16px var(--shadow-dark);
        }

        h1 {
            text-align: center;
            color: var(--accent-color);
            margin: 0;
            padding: 0 60px;
        }

        .version-bubble {
            background-color: #b85570;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            left: 35px;
            top: 30%;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .signature {
            background-color: #a24b5f;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        
        .typescorm {
            background-color: #e2c00c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            left: 15px;
            top: 70%;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .description {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: inset 3px 3px 7px rgba(0,0,0,0.2), inset -3px -3px 7px rgba(255,255,255,0.1);
        }

        /* Structure des onglets */
        .tabs-container {
            display: flex;
            margin-bottom: 20px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 8px 8px 16px var(--shadow-dark);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            box-shadow: inset 0 0 0 rgba(0,0,0,0.1), inset 0 0 0 rgba(255,255,255,0.1);
            color: white;
        }

        .tab.active {
            box-shadow: inset 3px 3px 5px rgba(0,0,0,0.2), inset -1px -1px 3px rgba(255,255,255,0.1);
            background-color: white;
            color: var(--accent-color);
        }

        .tab-1 { background-color: var(--tab1-color); }
        .tab-2 { background-color: var(--tab2-color); }
        .tab-3 { background-color: var(--tab3-color); }
        .tab-4 { background-color: var(--tab4-color); }
        .tab-5 { background-color: var(--tab5-color); }

        .tab-content {
            padding: 20px;
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--shadow-dark);
            margin-bottom: 20px;
            display: none;
            background-color: white;
        }

        .tab-content.active {
            display: block;
        }

        /* Boutons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 10px;
            margin-bottom: 10px;
            background-color: var(--base-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -2px -2px 5px var(--shadow-light);
            color: var(--text-color);
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 12px var(--shadow-dark), -2px -2px 5px var(--shadow-light);
        }

        .btn:active {
            box-shadow: inset 3px 3px 5px rgba(0,0,0,0.2), inset -1px -1px 3px rgba(255,255,255,0.1);
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--btn-primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--btn-secondary);
            color: white;
        }

        .btn-special {
            background-color: var(--btn-special);
            color: white;
        }

        .btn-danger {
            background-color: var(--btn-danger);
            color: white;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            margin: 15px 0;
            gap: 10px;
        }

        /* Étapes et paramètres */
        .step-title {
            font-size: 1.5rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
            min-height: 100px;
            resize: vertical;
        }

        /* Notification style */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 16px;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .notification.show {
            display: block;
            opacity: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 20px;
            width: 80%;
            max-width: 1000px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent-color);
        }

        /* API Config */
        .api-config-section {
            background-color: var(--base-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Checkbox styles */
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background-color: #f5f5f5;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background-color: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        /* Preview du prompt */
        .preview-container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 20px;
            margin-top: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-content {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }

        /* Info container */
        .info-container {
            background-color: #f0f8ff;
            padding: 20px;
            border-radius: 20px;
            border-left: 5px solid var(--accent-color);
        }

        .info-container h3 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .info-container ol {
            margin-left: 20px;
        }

        .info-container li {
            margin-bottom: 8px;
        }

        /* Card-based grid layout */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .template-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .template-card.selected {
            border: 3px solid var(--accent-color);
        }

        .card-header {
            background-color: var(--tab2-color);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
            position: relative;
        }

        .card-body {
            padding: 15px;
        }

        .card-description {
	        text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-align: center;
            display: block;
        }

        .check-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            color: var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-card.selected .check-icon {
            opacity: 1;
        }

        /* Section blocks */
        .section-block {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent-color);
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        
        
		/* Style pour le titre et le contenu de l'aperçu du template */
		.section-title {
			font-size: 1.2rem;
			font-weight: bold;
			margin-bottom: 15px;
			color: var(--accent-color);
			border-bottom: 1px solid #ddd;
			padding-bottom: 8px;
		}
		
		#template-preview {
			color: var(--text-color); /* Couleur de base du texte dans l'aperçu */
			padding: 15px;
			background-color: var(--light-bg);
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.05);
		}
		
		#template-preview .preview-card {
			margin: 0 auto;
		}
		
		#template-preview p {
			color: var(--mid-text); /* Couleur pour les paragraphes dans l'aperçu */
			margin-bottom: 15px;
		}
		
		#template-preview .preview-header {
			margin-bottom: 15px;
		}
		
		#template-preview .preview-description {
			color: var(--mid-text);
		}
        
        

        /* Content tabs */
        .content-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .content-tab {
            padding: 10px 15px;
            cursor: pointer;
            position: relative;
            font-weight: bold;
            color: #666;
        }

        .content-tab.active {
            color: #a24b5f;
        }

        .content-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #a24b5f;
        }

        .content-body {
            display: none;
        }

        .content-body.active {
            display: block;
        }

        /* Code styling */
        .code-preview {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            margin: 15px 0;
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #a24b5f;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }

        /* Toggle switch */
        .switch-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .switch-label {
            margin-right: 10px;
            font-weight: bold;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #a24b5f;
        }

        input:focus + .slider {
            box-shadow: 0 1px var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Styles pour les prévisualisations améliorées */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .preview-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .preview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1), 0 8px 8px rgba(0,0,0,0.05);
        }

        .preview-header {
            background: var(--accent-color);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-icon {
            background: white;
            color: var(--accent-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .preview-body {
            padding: 20px;
        }

        .preview-description {
            margin-bottom: 20px;
            color: var(--mid-text);
            font-size: 0.95rem;
        }

        /* Séquençage */
        .sequence-container {
            margin-top: 15px;
        }

        .sequence-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

		/* Pour les éléments vides ou en attente d'être déplacés */
		.sequence-items .sequence-item {
			background-color: #a24b5f; /* Couleur de fond pour assurer la visibilité */
			color: white; /* Texte en blanc qui sera visible sur le fond coloré */
		}


		.sequence-item {
			background: var(--primary-color);
			color: white;
			padding: 10px 15px;
			border-radius: 6px;
			cursor: grab;
			font-weight: 500;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			transition: var(--transition);
			border: 1px solid #ddd;
		}
		
        .sequence-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .sequence-dropzones {
            background: var(--light-bg);
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
        }

		.dropzone {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 6px;
			padding: 12px 15px;
			margin-bottom: 10px;
			display: flex;
			align-items: center;
			min-height: 50px;
		}

        .dropzone-number {
            background: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

		.dropzone-placeholder {
			color: #aaa; /* Gris clair pour le texte d'indication */
			font-style: italic;
		}

        .dropzone-content {
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            flex-grow: 1;
            text-align: center;
        }

        /* Catégorisation */
        .category-container {
            margin-top: 15px;
        }

		.category-items {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			margin-bottom: 20px;
			padding: 15px;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.05);
			border: 1px solid #eee;
		}



		.category-item {
            background-color: #6e92b5;
            color: white;
            border-radius: 10px;
            padding: 8px 15px;
            cursor: grab;
            margin-bottom: 20px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

		.category {
			background: var(--light-bg);
			border: 2px dashed #ccc;
			border-radius: 8px;
			padding: 15px;
			min-height: 150px;
			transition: all 0.2s ease;
		}
		
		.category:hover {
			border-color: #aab7c4;
			background-color: #f4f6f9;
		}
		
		.category-title {
			background: #a24b5f; /* Même couleur que les éléments pour cohérence */
			color: white;
			padding: 6px 12px;
			border-radius: 20px;
			display: inline-block;
			margin-bottom: 15px;
			font-weight: 500;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

        .category-content {
            min-height: 80px;
        }

        .category-content .category-item {
            margin-bottom: 8px;
            display: inline-block;
        }


        /* Appariement */
        .match-container {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .match-column {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 15px;
        }

        .match-column-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--mid-text);
        }

        .match-terms {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-term {
            background: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: center;
            cursor: grab;
            font-weight: 500;
        }

        .match-definitions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-definition {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
        }

        .match-definition-content {
            flex-grow: 1;
        }

        .match-definition-term {
            background: var(--primary-color);
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            margin-right: 10px;
        }

        /* Calculs */
        .calcul-container {
            margin-top: 15px;
            background: var(--light-bg);
            border-radius: 10px;
            padding: 20px;
        }

        .calcul-question {
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--dark-text);
        }

        .calcul-data {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .calcul-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .calcul-row:last-child {
            border-bottom: none;
        }

        .calcul-label {
            color: var(--mid-text);
        }

        .calcul-value {
            font-weight: bold;
            color: var(--dark-text);
        }

        .calcul-input-group {
            margin-top: 20px;
        }

        .calcul-input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--mid-text);
        }

        .calcul-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
            transition: border-color 0.3s;
        }

        .calcul-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Python */
        .python-container {
            margin-top: 15px;
        }

        .python-question {
            margin-bottom: 15px;
            font-weight: 500;
        }

        .python-expected {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .python-expected-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--mid-text);
        }

        .python-expected-code {
            background: #282c34;
            color: #abb2bf;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            overflow: auto;
        }

        .python-editor {
            margin-bottom: 20px;
            position: relative;
        }

        .python-editor-header {
            background: #282c34;
            color: white;
            padding: 8px 12px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .python-editor-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .python-editor-content {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            font-family: 'Courier New', monospace;
            min-height: 100px;
        }

        .python-output {
            background: #282c34;
            color: #abb2bf;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .python-output-header {
            color: white;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* 3D Models */
        .model3d-container {
            margin-top: 15px;
            background: #0c0e1a;
            border-radius: 10px;
            padding: 20px;
            color: #e1e1e1;
        }

        .model3d-preview {
            text-align: center;
            margin: 15px auto;
            width: 100%;
            height: 300px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            background: #0c0e1a;
        }

        .model3d-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20, 32, 68, 0.7);
            padding: 5px;
            display: flex;
            justify-content: center;
            z-index: 10;
        }

        .model3d-btn {
            background: #232b42;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            margin: 0 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8aa0c8;
            font-weight: bold;
            transition: all 0.2s;
        }

        .model3d-btn:hover {
            background: #2f3d63;
            transform: scale(1.1);
        }

        .model3d-info {
            background: #1a1f35;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .model3d-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #f9fafb;
            margin-bottom: 10px;
        }

        .model3d-description {
            color: #b5b5b5;
            font-size: 0.95em;
            line-height: 1.5;
        }

        /* Boutons pour les prévisualisations */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .preview-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .preview-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .preview-btn-primary:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .preview-btn-secondary {
            background: #e2e8f0;
            color: var(--mid-text);
        }

        .preview-btn-secondary:hover {
            background: #d2d8e0;
            transform: translateY(-2px);
        }

        .result-box {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .result-box.success {
            background: #d4edda;
            color: #155724;
        }

        .result-box.error {
            background: #f8d7da;
            color: #721c24;
        }

        .result-icon {
            margin-right: 10px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .hint-box {
            margin-top: 15px;
            padding: 12px;
            background: #fff3cd;
            color: #856404;
            border-radius: 6px;
            font-size: 0.95rem;
            display: flex;
            align-items: flex-start;
        }

        .hint-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Styles responsifs */
        @media (max-width: 768px) {
            .template-grid {
                grid-template-columns: 1fr;
            }

            .tabs-container {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }

            .header-container {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            h1 {
                padding: 0;
                margin: 10px 0;
            }

            .version-bubble, .signature {
                position: static;
                transform: none;
                margin: 5px 0;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
            }
            
            .match-container, .categories {
                grid-template-columns: 1fr;
            }
            
			/* Styles à ajouter */
			.color-picker-container {
				display: flex;
				align-items: center;
				gap: 15px;
			}
			
			.color-input {
				width: 100px !important;
				height: 40px;
				padding: 2px;
				border: 2px solid #ddd;
				border-radius: 8px;
				cursor: pointer;
			}
			
			.color-preview {
				height: 40px;
				flex-grow: 1;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 8px;
				color: white;
				text-shadow: 0 0 2px rgba(0,0,0,0.6);
				font-weight: bold;
				transition: all 0.3s;
			}
			
			.status-indicator {
				margin-left: 10px;
				font-size: 0.9em;
				padding: 3px 8px;
				border-radius: 12px;
				background-color: #f0f0f0;
				transition: all 0.3s;
			}
			
			.status-active {
				background-color: #4CAF50;
				color: white;
			}
			
			.status-inactive {
				background-color: #ccc;
				color: #333;
			}
			
			/* Styles pour le sélecteur de couleur amélioré */
			.color-picker-container {
				display: flex;
				align-items: center;
				gap: 15px;
			}
			
			.color-input {
				width: 100px !important;
				height: 40px;
				padding: 2px;
				border: 2px solid #ddd;
				border-radius: 8px;
				cursor: pointer;
			}
			
			.color-preview {
				height: 40px;
				flex-grow: 1;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 8px;
				color: white;
				text-shadow: 0 0 2px rgba(0,0,0,0.6);
				font-weight: bold;
				transition: all 0.3s;
			}
			
			.status-indicator {
				margin-left: 10px;
				font-size: 0.9em;
				padding: 3px 8px;
				border-radius: 12px;
				background-color: #f0f0f0;
				transition: all 0.3s;
			}
			
			.status-active {
				background-color: #4CAF50;
				color: white;
			}
			
			.status-inactive {
				background-color: #ccc;
				color: #333;
			}
			
			/* Styles pour le tableau périodique */
			:root {
				--alkali-color: #ff5733;
				--alkaline-earth-color: #ffbd33;
				--transition-color: #e6a5c4;
				--post-transition-color: #a5e6d2;
				--metalloid-color: #b5e6a5;
				--nonmetal-color: #a5d8e6;
				--noble-gas-color: #d3a5e6;
			}
			
			.periodic-table {
				display: grid;
				grid-template-columns: repeat(18, 45px);
				grid-template-rows: repeat(5, 45px);
				gap: 2px;
				justify-content: center;
				margin: 20px 0;
				overflow-x: auto;
				padding: 15px;
				background: #f5f7fa;
				border-radius: 10px;
			}
			
			.element {
				width: 45px;
				height: 45px;
				border: 1px solid rgba(0, 0, 0, 0.1);
				border-radius: 4px;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				transition: all 0.3s ease;
				position: relative;
				overflow: hidden;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
				font-size: 0.7rem;
			}
			
			.element:hover {
				transform: scale(1.1);
				z-index: 10;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			}
			
			.element.active {
				border: 2px solid #000;
			}
			
			.element .atomic-number {
				position: absolute;
				top: 2px;
				left: 2px;
				font-size: 0.6rem;
				font-weight: bold;
			}
			
			.element .symbol {
				font-size: 1rem;
				font-weight: bold;
				margin: 2px 0;
			}
			
			.element .name {
				font-size: 0.5rem;
				text-align: center;
				max-width: 90%;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			
			.empty {
				visibility: hidden;
			}
			
			.element.alkali {
				background-color: var(--alkali-color);
				color: white;
			}
			
			.element.alkaline-earth {
				background-color: var(--alkaline-earth-color);
			}
			
			.element.transition {
				background-color: var(--transition-color);
			}
			
			.element.post-transition {
				background-color: var(--post-transition-color);
			}
			
			.element.metalloid {
				background-color: var(--metalloid-color);
			}
			
			.element.nonmetal {
				background-color: var(--nonmetal-color);
			}
			
			.element.noble-gas {
				background-color: var(--noble-gas-color);
			}
			
			.legend {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				gap: 10px;
				margin: 10px 0;
				padding: 10px;
				background: white;
				border-radius: 8px;
			}
			
			.legend-item {
				display: flex;
				align-items: center;
				margin: 5px;
				font-size: 0.75rem;
			}
			
			.legend-color {
				width: 12px;
				height: 12px;
				border-radius: 3px;
				margin-right: 5px;
			}
			
			.element-info {
				text-align: center;
				margin-top: 20px;
				padding: 15px;
				background-color: #f0f5fa;
				border-radius: 8px;
				box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
			}
			
			.element-name {
				font-size: 1.5rem;
				color: #3498db;
				margin-bottom: 5px;
			}
			
			.element-details {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				gap: 10px;
				margin-top: 10px;
			}
			
			.element-detail {
				padding: 6px 12px;
				background-color: white;
				border-radius: 15px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
				font-size: 0.85rem;
			}
			
			@media (max-width: 992px) {
				.periodic-table {
					grid-template-columns: repeat(18, 35px);
					grid-template-rows: repeat(5, 35px);
				}
				.element {
					width: 35px;
					height: 35px;
					font-size: 0.6rem;
				}
				.element .symbol {
					font-size: 0.8rem;
				}
				.element .name {
					font-size: 0.4rem;
				}
			}
			
			/* Styles pour les statistiques */
			.stats-container {
				background-color: #f0f8ff;
				padding: 15px;
				border-radius: 10px;
				border-left: 5px solid var(--accent-color);
				margin-top: 15px;
			}
			
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(3, 1fr);
				gap: 10px;
			}
			
			.stat-box {
				background: white;
				padding: 15px;
				border-radius: 8px;
				text-align: center;
				box-shadow: 0 2px 5px rgba(0,0,0,0.05);
			}
			
			.stat-label {
				font-size: 0.9em;
				color: #666;
				margin-bottom: 5px;
			}
			
			.stat-value {
				font-size: 1.8em;
				font-weight: bold;
				color: var(--accent-color);
			}
			
			/* Ajout pour les indicateurs de complexité */
			.icon-container {
				display: flex;
				flex-direction: column;
				align-items: center;
				margin: 0 auto 15px auto;
				width: 100%;
				text-align: center;
			}
			
			
			.complexity-indicator {
				display: flex;
				justify-content: center;
				color: gold;
				font-size: 0.9em;
				width: 100%;
			}
			
			.complexity-indicator i {
				margin: 0 3px;
			}
						
			
			/* Styles pour les catégories de templates avec plus de spécificité */
			.template-card[data-category="general"] .card-header {
				background-color: #b85570; !important;
			}
			
			.template-card[data-category="math"] .card-header {
				background-color: var(--math-color) !important;
			}
			
			.template-card[data-category="science"] .card-header {
				background-color: var(--science-color) !important;
			}
			
			.template-card[data-category="programming"] .card-header {
				background-color: var(--programming-color) !important;
			}

			
			/* Style pour le badge de catégorie */
			.category-badge {
				position: absolute;
				top: -10px;
				right: -10px;
				background-color: white;
				color: #333;
				border-radius: 12px;
				padding: 2px 8px;
				font-size: 0.7em;
				font-weight: bold;
				box-shadow: 0 2px 5px rgba(0,0,0,0.2);
			}
			
			/* Styles spécifiques pour le template Statistiques à Deux Variables */
			.chart-container {
				position: relative;
				height: 400px;
				margin: 20px 0;
				background: white;
				border-radius: 8px;
				padding: 15px;
				box-shadow: 0 5px 15px rgba(0,0,0,0.1);
			}
			
			.stats-display {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 15px;
				margin: 20px 0;
			}
			
			.stat-card {
				background: white;
				padding: 15px;
				border-radius: 8px;
				text-align: center;
				box-shadow: 0 4px 6px rgba(0,0,0,0.1);
				border-top: 4px solid var(--primary);
			}
			
			.stat-value {
				font-size: 1.8rem;
				font-weight: bold;
				margin: 5px 0;
				color: var(--primary-dark);
			}
			
			.stat-label {
				font-size: 0.9rem;
				color: #666;
			}
			
			.data-table-container {
				max-height: 300px;
				overflow-y: auto;
				border: 1px solid #e2e8f0;
				border-radius: 8px;
				margin: 20px 0;
			}
			
			.data-table {
				width: 100%;
				border-collapse: collapse;
				font-size: 0.9rem;
			}
			
			.data-table th,
			.data-table td {
				border: 1px solid #e2e8f0;
				padding: 8px;
				text-align: center;
			}
			
			.data-table th {
				background: #f7fafc;
				font-weight: bold;
				position: sticky;
				top: 0;
				z-index: 10;
			}
			
			.simulation-card {
				background: white;
				border-radius: var(--border-radius);
				box-shadow: var(--shadow);
				padding: 25px;
				margin-bottom: 30px;
			}
			
			.simulation-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}
			
			.simulation-title {
				font-size: 1.5rem;
				font-weight: bold;
				color: var(--primary-dark);
			}
			
			.data-display {
				background: #f8f9fa;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 15px;
				font-family: 'Courier New', monospace;
				font-size: 0.95em;
			}
			
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header-container">
            <div class="version-bubble">V5.3.2</div>
            <h1>SCORM Generator - Générateur d'Applications Éducatives</h1>
            <div class="signature">@yoblin</div>
            <div class="typescorm">SCORM App</div>
        </div>

        <div class="description">
            <p>Créez facilement des prompts optimisés pour générer des applications HTML interactives personnalisées compatibles SCORM (score transmis au LMS ELEA).</p>
        </div>

        <div class="tabs-container">
            <div class="tab tab-1 active" data-tab="1">
                Configuration
            </div>
            <div class="tab tab-2" data-tab="2">
                Template
            </div>
            <div class="tab tab-3" data-tab="3">
                Contenu
            </div>
            <div class="tab tab-4" data-tab="4">
                Apparence
            </div>
            <div class="tab tab-5" data-tab="5">
                Génération
            </div>
        </div>

        <!-- Tab 1: Configuration -->
        <div id="tab-content-1" class="tab-content active">
            <h2 class="step-title">Étape 1: Configuration de base</h2>
            
            <div class="form-group">
                <label class="form-label" for="app-title">Titre de l'application:</label>
                <input 
                    type="text" 
                    id="app-title" 
                    class="form-input" 
                    placeholder="Ex: Mathématiques - Calculs basiques" 
                    value="Activité SCORM Interactive"
                >
            </div>

            <div class="form-group">
                <label class="form-label" for="app-description">Description de l'application:</label>
                <textarea 
                    id="app-description" 
                    class="form-textarea" 
                    placeholder="Décrivez le but et le contenu de votre application..."
                >Une application interactive pour l'apprentissage et l'évaluation des connaissances.</textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="app-author">Auteur / Organisation:</label>
                <input 
                    type="text" 
                    id="app-author" 
                    class="form-input" 
                    placeholder="Ex: Votre nom ou organisation" 
                    value="Formateur SCORM"
                >
            </div>
            
            <div class="form-group">
                <label class="form-label" for="subject-select">Matière / Sujet:</label>
                <select 
                    id="subject-select" 
                    class="form-select"
                >
                    <option value="general" selected>Général</option>
                    <option value="math">Mathématiques</option>
                    <option value="science">Sciences</option>
                    <option value="language">Langues</option>
                    <option value="history">Histoire</option>
                    <option value="geography">Géographie</option>
                    <option value="computer">Informatique</option>
                    <option value="custom">Personnalisé</option>
                </select>
            </div>
            
            <div class="form-group" id="custom-subject-container" style="display: none;">
                <label class="form-label" for="custom-subject">Sujet personnalisé:</label>
                <input 
                    type="text" 
                    id="custom-subject" 
                    class="form-input" 
                    placeholder="Entrez votre sujet personnalisé"
                >
            </div>

            <div class="form-group">
                <label class="form-label" for="difficulty-select">Niveau de difficulté:</label>
                <select 
                    id="difficulty-select" 
                    class="form-select"
                >
                    <option value="beginner">Débutant</option>
                    <option value="intermediate" selected>Intermédiaire</option>
                    <option value="advanced">Avancé</option>
                    <option value="expert">Expert</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="audience-select">Public cible:</label>
                <select 
                    id="audience-select" 
                    class="form-select"
                >
                    <option value="primary">École primaire</option>
                    <option value="secondary">Collège</option>
                    <option value="highschool">Lycée</option>
                    <option value="university">Université</option>
                    <option value="professional" selected>Formation professionnelle</option>
                    <option value="all">Tout public</option>
                </select>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="reset-button-1"
                >
                    <i class="fas fa-sync-alt"></i> Réinitialiser
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-1"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 2: Template -->
        <div id="tab-content-2" class="tab-content">
            <h2 class="step-title">Étape 2: Choix du template</h2>
            
            <div class="form-group">
                <h3>Choisissez le type d'activité que vous souhaitez créer :</h3>
                <h4>(les étoiles indiquent la complexité du prompt et son coût approximatif en token)</h4>
                <div class="template-grid">
                    <!-- QCM Template -->
                    <div class="template-card" data-template="qcm">
                        <div class="card-header">
                            QCM
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fas fa-list-check card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Questionnaire à choix multiples avec feedback immédiat et explications personnalisées.</div>
                        </div>
                    </div>
                    
                    <!-- Drag & Drop Sequence Template -->
                    <div class="template-card" data-template="sequence">
                        <div class="card-header">
                            Séquençage
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fas fa-arrow-down-1-9 card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Activité de glisser-déposer pour ordonner des étapes ou des éléments dans le bon ordre.</div>
                        </div>
                    </div>
                    
                    <!-- Category Template -->
                    <div class="template-card" data-template="category">
                        <div class="card-header">
                            Catégorisation
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fa fa-sort-amount-desc card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Classez des éléments dans différentes catégories par glisser-déposer.</div>
                        </div>
                    </div>
                    
                    <!-- Matching Template -->
                    <div class="template-card" data-template="match">
                        <div class="card-header">
                            Appariement
                            <div class="check-icon"><i class="fas fa-link card-icon"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fa fa-th-list card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Associez des termes et des définitions par glisser-déposer.</div>
                        </div>
                    </div>
                    
                    <!-- Calculation Template -->
                    <div class="template-card" data-template="calcul">
                        <div class="card-header">
                            Calculs
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fas fa-calculator card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Exercices de calculs mathématiques avec vérification automatique des réponses.</div>
                        </div>
                    </div>
                    
                    
					<!-- Graphique Template -->
					<div class="template-card" data-template="graphique">
						<div class="card-header">
							Graphiques
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-chart-line card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Application interactive pour la visualisation, lecture et interprétation de graphiques cartésiens.</div>
						</div>
					</div> 
                    
                    
					<!-- Tableaux de valeurs Template -->
					<div class="template-card" data-template="tableaux">
						<div class="card-header">
							Tableaux de valeurs
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
                            <i class="fas fa-table card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>	                        							
							<div class="card-description">Exercices de tableaux de valeurs pour différents types de fonctions mathématiques avec calculs d'images et d'antécédents.</div>
						</div>
					</div>
                    
                    
					<!-- Dérivées Template -->
                    <div class="template-card" data-template="derivees">
                        <div class="card-header">
                            Fonctions Dérivées
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
                            <i class="fas fa-chart-line card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>	                        
                            <div class="card-description">Exercices sur les fonctions dérivées avec génération aléatoire de polynômes et différents types de questions.</div>
                        </div>
                    </div>
                    
                    
					<!-- Template Statistiques -->
					<div class="template-card" data-template="statistics">
						<div class="card-header">
							Statistiques
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fa fa-pie-chart card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Application interactive pour explorer différents types de visualisations statistiques et comprendre l'analyse de données.</div>
						</div>
					</div>   
                    
                    
                    
					<!-- Statistics Template -->
					<div class="template-card" data-template="stats">
						<div class="card-header">
							Statistiques 2 Variables
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fa fa-pie-chart card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Analyse de données statistiques à deux variables avec nuage de points, régression linéaire et coefficient de corrélation.</div>
						</div>
					</div>
                    
                    
                    
					<!-- Suites Arithmétiques Template -->
					<div class="template-card" data-template="arithmetique">
						<div class="card-header">
							Suites Arithmétiques
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-calculator card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Exercices interactifs sur les suites arithmétiques avec simulation, calculs de termes et propriétés.</div>
						</div>
					</div>
                    
                    
                    
					<!-- Suites Géométriques Template -->
					<div class="template-card" data-template="geometrique">
						<div class="card-header">
							Suites Géométriques
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-calculator card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Exercices interactifs sur les suites géométriques avec simulation, calculs de termes et propriétés.</div>
						</div>
					</div>
                    

                    
					<!-- Probabilités Template -->
					<div class="template-card" data-template="probability">
						<div class="card-header">
							Probabilités
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-dice card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Simuler des expériences aléatoires (lancer de pièces, dés) et répondre à des questions sur les probabilités et fréquences.</div>
						</div>
					</div>
                    
					<!-- Ajouter dans la div class="template-grid" -->
					<div class="template-card" data-template="arbre_proba">
						<div class="card-header">
							Arbres de Probabilité
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fa fa-sitemap card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Simulation interactive d'arbres de probabilité avec exercices sur les naissances et les événements pondérés.</div>
						</div>
					</div>
                    
                    
                    
					<!-- Probability Table Template -->
					<div class="template-card" data-template="proba">
						<div class="card-header">
							Tableau de Probabilité
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-table card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Exercices interactifs basés sur un tableau pour l'apprentissage des probabilités simples, composées et conditionnelles.</div>
						</div>
					</div>
                    
                    
					<!-- Geometry 3D Template -->
					<div class="template-card" data-template="geometry3d">
						<div class="card-header">
							Géométrie 3D
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-cube card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Visualisation interactive de formes géométriques 3D avec calcul de propriétés mathématiques.</div>
						</div>
					</div>
                    
                    <!-- Python Template -->
                    <div class="template-card" data-template="python">
                        <div class="card-header">
                            Python
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fab fa-python card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Exercices de programmation Python interactifs avec exécution dans le navigateur.</div>
                        </div>
                    </div>
                    
                    
					<div class="template-card" data-template="turtle">
						<div class="card-header">
							Console Turtle
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-dragon card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Exercices interactifs de programmation Python avec la bibliothèque Turtle pour dessiner des formes géométriques.</div>
						</div>
					</div>
                    				
					                                    
					<div class="template-card" data-template="periodic">
						<div class="card-header">
							Tableau Périodique
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fa fa-th card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Exercices interactifs basés sur le tableau périodique des éléments chimiques.</div>
						</div>
					</div>                    
                    
                    
					<div class="template-card" data-template="equation">
						<div class="card-header">
							Equations bilan
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fa fa-balance-scale card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
							<div class="card-description">Exercices d'équilibrage d'équations chimiques avec sélection de coefficients et vérification automatique.</div>
						</div>
					</div>
					

					<div class="template-card" data-template="titrage">
						<div class="card-header">
							Titrages acido-basiques
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-flask card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
								</div>
							</div>
							<div class="card-description">Simulation interactive de titrages acido-basiques avec burette, erlenmeyer et calculs de concentration.</div>
						</div>
					</div>
					
					<div class="template-card" data-template="chimie-orga">
						<div class="card-header">
							Chimie Orga
							<div class="check-icon"><i class="fas fa-check"></i></div>
						</div>
						<div class="card-body">
							<div class="icon-container">
								<i class="fas fa-atom card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
								</div>
							</div>				
							<div class="card-description">Simulateur interactif de molécules organiques avec exercices de construction et d'identification.</div>
						</div>
					</div>
					
                    <div class="template-card" data-template="3d">
                        <div class="card-header">
                            Modèles scientifiques 3D
                            <div class="check-icon"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="card-body">
							<div class="icon-container">
								<i class="fa fa-globe card-icon"></i>
								<div class="complexity-indicator">
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="far fa-star"></i>
									<i class="far fa-star"></i>
								</div>
							</div>
                            <div class="card-description">Visualisation de modèles scientifiques 3D interactifs avec rotation, zoom et exploration détaillée.</div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <div class="form-group">
                <div class="section-block" id="template-details">
                    <div class="section-title">Détails du template</div>
                    <p>Sélectionnez un template pour voir sa description détaillée.</p>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-2"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-2"
                    disabled
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 3: Content -->
        <div id="tab-content-3" class="tab-content">
            <h2 class="step-title">Étape 3: Configuration du contenu</h2>
            
            <div class="section-block">
                <div class="section-title">Paramètres du contenu</div>
                
                <div class="form-group">
                    <label class="form-label" for="exercise-count">Nombre d'exercices:</label>
                    <select id="exercise-count" class="form-select">
                        <option value="4">4 exercices</option>
                        <option value="6" selected>6 exercices</option>
                        <option value="8">8 exercices</option>
                        <option value="custom">Personnalisé</option>
                    </select>
                </div>
                
                <div class="form-group" id="custom-count-container" style="display: none;">
                    <label class="form-label" for="custom-exercise-count">Nombre personnalisé:</label>
                    <input 
                        type="number" 
                        id="custom-exercise-count" 
                        class="form-input" 
                        min="1" 
                        max="50" 
                        placeholder="Entrez un nombre d'exercices (1-50)"
                        value="5"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="content-theme">Thème du contenu:</label>
                    <input 
                        type="text" 
                        id="content-theme" 
                        class="form-input" 
                        placeholder="Ex: Fractions, Conjugaison au présent, etc."
                        value=""
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="content-instructions">Instructions générales pour l'IAG (très important pour donner le contexte de votre application)</label>
                    <textarea 
                        id="content-instructions" 
                        class="form-textarea" 
                        placeholder="Instructions générales pour l'apprenant..."
                    >Important : détaillez ici les instructions que doit suivre l'IA pour personnaliser votre application .</textarea>
                </div>
            </div>

            <div class="section-block" id="template-specific-settings">
                <!-- Cette section sera remplie dynamiquement en fonction du template sélectionné -->
                <div class="section-title">Paramètres spécifiques au template</div>
                <p>Veuillez d'abord sélectionner un template dans l'étape précédente.</p>
            </div>
            
            <div class="section-block">
                <div class="section-title">Aperçu du template</div>
                <div id="template-preview">
                    <!-- La prévisualisation du template sera insérée ici -->
                    <p>Veuillez d'abord sélectionner un template dans l'étape précédente.</p>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-title">Gamification</div>
                
                <div class="switch-container">
                    <span class="switch-label">Activer les badges:</span>
                    <label class="switch">
                        <input type="checkbox" id="enable-badges" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="badges-settings">
                    <div class="form-group">
                        <label class="form-label" for="badge-threshold">Seuil pour débloquer les badges:</label>
                        <select id="badge-threshold" class="form-select">
                            <option value="percentage">Pourcentage de complétion</option>
                            <option value="count" selected>Nombre d'exercices complétés</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="badge-count">Nombre de badges:</label>
                        <select id="badge-count" class="form-select">
                            <option value="2">2 badges</option>
                            <option value="3">3 badges</option>
                            <option value="4" selected>4 badges</option>
                            <option value="5">5 badges</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-3"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-3"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 4: Appearance -->
        <div id="tab-content-4" class="tab-content">
            <h2 class="step-title">Étape 4: Personnalisation de l'apparence</h2>
            
            <div class="section-block">
                <div class="section-title">Thème et couleurs</div>
                
                <div class="form-group">
                    <label class="form-label" for="color-theme">Thème de couleur:</label>
                    <select id="color-theme" class="form-select">
                        <option value="blue" selected>Bleu</option>
                        <option value="green">Vert</option>
                        <option value="purple">Violet</option>
                        <option value="orange">Orange</option>
                        <option value="gold">Or</option>
                        <option value="silver">Argenté</option>
                        <option value="yellow">Jaune</option>
                        <option value="red">Rouge</option>
                        <option value="pourpre">Pourpre</option>
                        <option value="anthracite">Anthracite</option>
                        <option value="dark">Sombre</option>
                        <option value="theme">Thème de l'application</option>
                    </select>
                </div>
                
				<div class="form-group">
					<label class="form-label" for="custom-primary-color">Couleur principale (personnalisée):</label>
					<div class="color-picker-container">
						<input 
							type="color" 
							id="custom-primary-color" 
							class="form-input color-input" 
							value="#667eea"
						>
						<div id="color-preview" class="color-preview" style="background-color: #ea6687;">
							<span id="color-value">#ea6687</span>
						</div>
					</div>
				</div>            
                
                
				<div class="switch-container">
					<span class="switch-label">Utiliser la couleur personnalisée:</span>
					<label class="switch">
						<input type="checkbox" id="use-custom-color">
						<span class="slider"></span>
					</label>
					<span id="custom-color-status" class="status-indicator">Non activé</span>
				</div>      
            </div>
            
            <div class="section-block">
                <div class="section-title">Style d'interface</div>
                
                <div class="form-group">
                    <label class="form-label" for="ui-style">Style d'interface:</label>
                    <select id="ui-style" class="form-select">
                        <option value="modern" selected>Moderne (cards et ombres)</option>
                        <option value="flat">Plat (minimaliste)</option>
                        <option value="gradient">Dégradés (coloré)</option>
                        <option value="classic">Classique (bordures fines)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="font-family">Police de caractères:</label>
                    <select id="font-family" class="form-select">
                        <option value="sans-serif" selected>Sans-serif (Arial, Helvetica)</option>
                        <option value="serif">Serif (Times New Roman)</option>
                        <option value="monospace">Monospace (Courier)</option>
                        <option value="rounded">Arrondie (Comic Sans MS)</option>
                    </select>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-title">Fonctionnalités d'interface</div>
                
                <div class="checkbox-container">
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-fullscreen" checked>
                        <label for="feature-fullscreen">Mode plein écran</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-progress" checked>
                        <label for="feature-progress">Barre de progression</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-scoreboard" checked>
                        <label for="feature-scoreboard">Tableau de score</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-timer">
                        <label for="feature-timer">Chronomètre</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-hints" checked>
                        <label for="feature-hints">Indices</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="feature-feedback" checked>
                        <label for="feature-feedback">Feedback détaillé</label>
                    </div>
                </div>
            </div>
            
            <div class="section-block">
                <div class="section-title">Styles CSS personnalisés (avancé)</div>
                
                <div class="form-group">
                    <label class="form-label" for="custom-css">CSS personnalisé:</label>
                    <textarea 
                        id="custom-css" 
                        class="form-textarea" 
                        placeholder="/* Ajoutez votre CSS personnalisé ici */"
                        style="font-family: monospace; min-height: 150px;"
                    ></textarea>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-4"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="next-tab-4"
                >
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Tab 5: Generation -->
        <div id="tab-content-5" class="tab-content">
            <h2 class="step-title">Étape 5: Génération du prompt</h2>
            
            <div class="buttons" style="margin-bottom: 20px">
                <button 
                    class="btn btn-primary" 
                    id="generate-prompt-btn"
                >
                    <i class="fas fa-wand-magic-sparkles"></i> Générer le prompt
                </button>
                <button 
                    class="btn btn-special" 
                    id="copy-prompt-btn"
                    disabled
                >
                    <i class="fas fa-copy"></i> Copier le prompt
                </button>
                <button 
                    class="btn btn-secondary" 
                    id="download-prompt-btn"
                    disabled
                >
                    <i class="fas fa-download"></i> Télécharger le prompt
                </button>
            </div>
            
            <div class="section-block">
                <div class="section-title">Options de génération</div>
                
                <div class="form-group">
                    <label class="form-label" for="prompt-format">Format du prompt:</label>
                    <select id="prompt-format" class="form-select">
                        <option value="detailed" selected>Détaillé (recommandé)</option>
                        <option value="concise">Concis</option>
                        <option value="technical">Technique (avancé)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ai-target">Optimisé pour:</label>
                    <select id="ai-target" class="form-select">
                        <option value="claude" selected>Claude (Anthropic)</option>
                        <option value="gpt">ChatGPT (OpenAI)</option>
                        <option value="generic">IA générique</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="include-code">Inclure le code technique:</label>
                    <select id="include-code" class="form-select">
                        <option value="full" selected>Oui, code complet</option>
                        <option value="partial">Oui, code partiel</option>
                        <option value="no">Non, seulement les instructions</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="additional-instructions">Instructions supplémentaires:</label>
                    <textarea 
                        id="additional-instructions" 
                        class="form-textarea" 
                        placeholder="Instructions supplémentaires pour l'IA..."
                    ></textarea>
                </div>
            </div>
            
            <div id="loading-indicator">
                <div class="spinner"></div>
                <p>Génération du prompt en cours...</p>
            </div>
            
            <div class="form-group">
                <div class="preview-container">
                    <div class="preview-header">
                        <h3>Prompt généré</h3>
                        <div>
                            <button 
                                class="btn btn-special" 
                                id="toggle-technical-btn" 
                                title="Afficher/masquer les sections techniques"
                                disabled
                            >
                                <i class="fas fa-code"></i> Afficher code
                            </button>
                        </div>
                    </div>
                    <div class="preview-content" id="prompt-preview">
                        Cliquez sur "Générer le prompt" pour créer votre prompt personnalisé...
                    </div>
                </div>

				<div class="stats-container" style="margin-top: 15px; background-color: #f0f8ff; padding: 15px; border-radius: 10px; border-left: 5px solid var(--accent-color);">
					<h3 style="color: var(--accent-color); margin-bottom: 10px;">Statistiques du prompt</h3>
					<div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
						<div class="stat-box">
							<div class="stat-label">Lignes</div>
							<div class="stat-value" id="line-count">0</div>
						</div>
						<div class="stat-box">
							<div class="stat-label">Mots</div>
							<div class="stat-value" id="word-count">0</div>
						</div>
						<div class="stat-box">
							<div class="stat-label">Tokens (estimés)</div>
							<div class="stat-value" id="token-count">0</div>
						</div>
					</div>
				</div>

            </div>
            
            <div class="form-group">
                <div class="info-container">
                    <h3>Comment utiliser ce prompt ?</h3>
                    <ol>
                        <li>Cliquez sur le bouton "Générer le prompt" ci-dessus</li>
                        <li>Utilisez "Copier le prompt" pour le copier dans votre presse-papiers</li>
                        <li>Ouvrez votre IA préférée (Claude, ChatGPT, etc.)</li>
                        <li>Collez le prompt et envoyez-le</li>
                        <li>L'IA générera une application SCORM complète basée sur vos spécifications</li>
                        <li>Copiez le code généré dans un fichier HTML et ouvrez-le dans votre navigateur</li>
                        <li>Vous pouvez également l'intégrer dans votre LMS compatible SCORM</li>
                    </ol>
                </div>
            </div>

            <div class="buttons">
                <button 
                    class="btn btn-secondary" 
                    id="prev-tab-5"
                >
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button 
                    class="btn btn-primary" 
                    id="open-claude-btn"
                >
                    <i class="fas fa-robot"></i> Ouvrir Claude
                </button>
                <button 
                    class="btn btn-secondary" 
                    id="open-chatgpt-btn"
                >
                    <i class="fas fa-comment-dots"></i> Ouvrir ChatGPT
                </button>
            </div>
        </div>
    </div>

    <!-- Template Details Modal -->
    <div id="template-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-template-modal">&times;</span>
            <h2 id="modal-template-title">Détails du Template</h2>
            
            <div class="content-tabs">
                <div class="content-tab active" data-content="description">Description</div>
                <div class="content-tab" data-content="preview">Aperçu</div>
                <div class="content-tab" data-content="code">Code</div>
            </div>
            
            <div id="modal-description" class="content-body active">
                <!-- Contenu de description -->
            </div>
            
            <div id="modal-preview" class="content-body">
                <!-- Aperçu -->
            </div>
            
            <div id="modal-code" class="content-body">
                <!-- Code -->
            </div>
            
            <div class="buttons" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="close-modal-btn">Fermer</button>
                <button class="btn btn-primary" id="select-template-btn">Sélectionner ce template</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">Opération réussie!</div>

    <script>
	    
		// Définir les couleurs par défaut pour chaque thème
		const themeColors = {
			'blue': '#667eea',
			'green': '#48bb78',
			'purple': '#b85570',
			'gold': '#face82',
			'silver':'#dcddde',
			'orange': '#ed8936',
			'yellow': '#f5ed18',
			'red': '#f56565',
			'pourpre':'#a3082f',
			'anthracite':'#5d6366',
			'dark': '#2d3748',
			'theme': '#ea6687'
			
		};	    
	    
	    
	    
        // État de l'application
        const appState = {
            // Tab 1: Configuration
            title: "Activité SCORM Interactive",
            description: "Une application interactive pour l'apprentissage et l'évaluation des connaissances.",
            author: "Formateur SCORM",
            subject: "general",
            customSubject: "",
            difficulty: "intermediate",
            audience: "professional",
            
            // Tab 2: Template
            selectedTemplate: null,
            
            // Tab 3: Content
            exerciseCount: 6,
            contentTheme: "",
            contentInstructions: "Complétez les exercices suivants. Vérifiez vos réponses à chaque étape avant de continuer.",
            enableBadges: true,
            badgeThreshold: "count",
            badgeCount: 4,
            
            // Template specific settings
            templateSettings: {
                qcm: {
                    optionsPerQuestion: 4,
                    allowMultipleCorrect: false,
                    showExplanations: true,
					disableAfterAnswer: true, // Nouvelle option
					attemptsPerQuestion: 1    // Nouvelle option
                },
                sequence: {
                    showHints: true,
                    allowReordering: true,
                    attemptsPerExercise: 1,    // Nouvelle propriété
                    allowMultipleAttempts: false // Nouvelle propriété
                },
                category: {
                    categoryCount: 2,
                    itemsPerCategory: 3,
                    attemptsPerExercise: 1,    // Nouvelle propriété
                    allowMultipleAttempts: false // Nouvelle propriété
                },
                
                
                match: {
                    pairCount: 5,
                    showHints: true,
                    attemptsPerExercise: 1,    // Nouvelle propriété
                    allowMultipleAttempts: false // Nouvelle propriété
                },
                
				derivees: {
                    questionType: 'derivative_expression',
                     polynomialDegree: 2, // NOUVEAU : degré du polynôme
                    allowMultipleAttempts: true,
                    maxAttempts: 2,
                    difficulty: 'medium'
                },
                
				tableaux: {
					functionType: 'lineaire',
					customFunction: '',
					columnCount: 7,
					valuesCount: 4,
					calculationType: 'images',
					allowMultipleAttempts: true,
					maxAttempts: 2
				},
                
                
				arithmetique: {
					allowMultipleAttempts: true,
					showFormulas: true,
					highlightPatterns: true,
					exerciseTypes: {
						nextTerm: true,       // Calculer le terme suivant
						missingTerm: true,    // Trouver le terme manquant
						reason: true,         // Calculer la raison
						nthTerm: true,        // Calculer le terme de rang n
						rank: true,           // Calculer le rang d'un terme spécifique
						sum: true,            // Calculer la somme des n premiers termes
						application: true     // Problème appliqué
					},
					difficultyLevel: "intermediate",
					maxAttempts: 3,
					firstTermRange: [-10, 20], // Plage pour le premier terme
					reasonRange: [-5, 5],      // Plage pour la raison
					termCount: 7              // Nombre de termes affichés
				},
                
        
				geometrique: {
					allowMultipleAttempts: true,
					showFormulas: true,
					highlightPatterns: true,
					exerciseTypes: {
						nextTerm: true,       // Calculer le terme suivant
						missingTerm: true,    // Trouver le terme manquant
						reason: true,         // Calculer la raison
						rank: true,           // Calculer le rang d'un terme spécifique
						nthTerm: true,        // Calculer le terme de rang N
						sum: true,            // Calculer la somme des n premiers termes
						application: true     // Problème appliqué
					},
					difficultyLevel: "intermediate",
					maxAttempts: 3,
					firstTermRange: [1, 10],  // Plage pour le premier terme
					reasonRange: [1.5, 4],    // Plage pour la raison
					termCount: 6,             // Nombre de termes affichés
					decimalPrecision: 1,      // Précision pour les nombres décimaux
					allowNegativeTerms: false // Autoriser les termes négatifs
				},
							
                
                
                calcul: {
                    allowMultipleAttempts: true,
                    showFormulas: true,
                    attemptsPerExercise: 1,    // Nouvelle propriété
                    allowMultipleAttempts: false // Nouvelle propriété
                },
                
                
				python: {
					allowCodeEditing: true,
					showExpectedOutput: true,
					level: 'intermediate',
					attempts: 'unlimited',
					codeTypes: {
						'print-input': true,
						'variables': true,
						'conditions': true,
						'for-loops': true,
						'while-loops': false,
						'functions': false,
						'python-lists': false
					},
					customInstructions: ''
				},                
                
                
				stats: {
					correlationStrength: 'random',
					correlationType: 'random',
					multipleAttempts: true,
					maxAttempts: 3,
					questions: {
						extrapolation: true,
						interpolation: true,
						correlationType: true,
						r2Interpretation: true,
						fitQuality: true,
						correlationStrength: true
					}
				},
                

                
                "3d": {
                    modelCount: 6,
                    showControls: true,
                    enableRotation: true,
                    enableZoom: true,
                    showDetails: true,
                    darkTheme: true,
                    modelTheme: "planets", // Nouveau paramètre pour le thème des modèles 3D
                    attemptsPerExercise: 1,    // Nouvelle propriété
                    allowMultipleAttempts: false // Nouvelle propriété
                },
                
				graphique: {
					exerciseCount: 6,
					showGrid: true,
					allowHints: true,
					showPoints: true,
					showLabels: true
				},
				
				"geometry3d": {
					showWireframe: true,
					autoRotation: true,
					showAxes: true,
					darkTheme: true,
					shapeCount: 6,
					showFormulas: true,
					allowDimensionControls: true,
					attemptsPerExercise: 1,    // Nouvelle propriété
					allowMultipleAttempts: false // Nouvelle propriété
				},
 
				"statistics": {
					graphTypes: ["histogram", "radar", "boxplot", "piechart", "multiHistogram", "donut"],
					selectedGraphs: ["histogram", "piechart", "radar"],
					showLegends: true,
					showLabels: true,
					colorScheme: "default", // options: default, blue, green, red, etc.
					animateGraphs: true,
					dataMode: "demo", // options: demo, custom
					attemptsPerExercise: 1,    // Nouvelle propriété
					allowMultipleAttempts: false // Nouvelle propriété
				},
				

				periodic: {
					questionTypes: ["property", "molecule", "identification"],
					allowMultipleAttempts: true,
					maxAttempts: 3,
					showHints: true
				},
				

				titrage: {
					titrageType: 'acid-base',
					indicators: 'both',
					difficulty: 'medium',
					showHints: true
				},

				
				// Ajout des paramètres pour le template Chimie Orga
				'chimie-orga': {
					families: {
						alcane: true,
						alcene: true,
						alcyne: true,
						alcool: true,
						aldehyde: true,
						acide: true,
						ester: true
					},
					questionTypes: {
						type1: true,
						type2: true
					},
					allowMultipleAttempts: 'multiple',
					maxAttempts: 3,
					showHints: 'after-attempt'
				},
				
				
				equation: {
					reactifCount: 2,
					produitCount: 2,
					allowMultipleAttempts: true,
					maxAttempts: 3,
					showHints: true
				},
				
				probability: {
					simulationType: 'both',
					questionType: 'all',
					includeFrequencyCalc: true,
					showExplanations: true,
					maxSimulations: 1000
				},


				proba: {
					eventAName: "Fleur",
					eventBName: "Rouge",
					questionTypes: ["basic", "compound", "conditional"],
					allowMultipleAttempts: true,
					maxAttempts: 3,
					showHints: true
				},



				// Ajouter dans l'objet appState.templateSettings
				arbre_proba: {
					arbreType: 'both',          // both, birth, weighted
					questionsType: 'both',      // both, birth, weighted
					contextualizeEvents: true,
					eventADescription: 'Il pleut',
					eventBDescription: 'J ai un parapluie',
					eventAEmoji: '🌧️',
					eventBEmoji: '💧',
					probA: 0.6,
					probBGivenA: 0.7,
					probBGivenNotA: 0.2
				},

				turtle: {
					challengeCount: 6,
					showExpectedImages: true,
					allowHints: true,
					customChallenges: false,
					challenges: {
						challenge1: "Carré de 100 pixels de côté",
						challenge2: "Rectangle de 150×80 pixels",
						challenge3: "Triangle équilatéral de 100 pixels de côté",
						challenge4: "Pentagone régulier de 70 pixels de côté",
						challenge5: "Hexagone régulier de 50 pixels de côté",
						challenge6: "Cercle de rayon 50 pixels"
					}
				}
            },
            
            // Tab 4: Appearance
            colorTheme: "blue",
            customPrimaryColor: "#ea6687",
            useCustomColor: false,
            uiStyle: "modern",
            fontFamily: "sans-serif",
            features: {
                fullscreen: true,
                progress: true,
                scoreboard: true,
                timer: false,
                hints: true,
                feedback: true
            },
            customCSS: "",
            
            // Tab 5: Generation
            promptFormat: "detailed",
            aiTarget: "claude",
            includeCode: "full",
            additionalInstructions: "",
            showCode: false,
            generatedPrompt: ""
        };
        
        // Templates détails
        const templatesDetails = {


            qcm: {
                title: "Questionnaire à Choix Multiples",
                description: "Un template pour créer des questionnaires à choix multiples interactifs. Chaque question peut avoir plusieurs options, avec une ou plusieurs réponses correctes. Des explications détaillées peuvent être affichées après chaque réponse.",
                features: [
                    "Questions à choix unique ou multiple",
                    "Feedback immédiat après chaque réponse",
                    "Explications détaillées personnalisables",
                    "Calcul automatique du score",
                    "Indicateurs visuels de réussite/échec"
                ],
                icon: "fas fa-list-check",
                previewHtml: `
                <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px; color: #a24b5f;">Question 1:</h3>
                        <p style="margin-bottom: 15px;">Quelle est la capitale de la France?</p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button style="padding: 10px; text-align: left; background: #e9ecef; border: none; border-radius: 5px; cursor: pointer;">A) Londres</button>
                            <button style="padding: 10px; text-align: left; background: #d4edda; border: none; border-radius: 5px; cursor: pointer;">B) Paris</button>
                            <button style="padding: 10px; text-align: left; background: #e9ecef; border: none; border-radius: 5px; cursor: pointer;">C) Berlin</button>
                            <button style="padding: 10px; text-align: left; background: #e9ecef; border: none; border-radius: 5px; cursor: pointer;">D) Madrid</button>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
                            ✅ Correct ! Paris est la capitale de la France.
                        </div>
                    </div>
                </div>
                `,
                
                jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE QCM : PRIORITE OBLIGATOIRE SI CHOISIE
            
			function initQCM() {
				// Récupérer toutes les options
				const options = document.querySelectorAll('.option-btn');
				
				// Récupérer toutes les questions pour initialiser le tableau des réponses
				const questions = document.querySelectorAll('.exercise-card');
				userAnswers = Array(questions.length).fill(null);
				
				// Ajouter les écouteurs d'événements aux options
				options.forEach(option => {
					option.addEventListener('click', function() {
						const questionCard = this.closest('.exercise-card');
						const questionId = questionCard.getAttribute('data-exercise');
						const questionIndex = Array.from(questions).indexOf(questionCard);
						const optionValue = this.getAttribute('data-option');
						
						// Vérifier la réponse et mettre à jour l'interface
						checkAnswer(questionId, optionValue, questionIndex);
						
						// Sauvegarder l'état après chaque réponse
						saveState();
					});
				});
				
				// Restaurer l'état précédent si disponible
				restoreState();
				
				// Initialiser les animations sur les cartes de questions
				initCardAnimations();
			}

            
            document.addEventListener('DOMContentLoaded', function() {
                // Initialisation du QCM
                initQCM();
            });
            
            function initQCM() {
                // Récupérer toutes les options
                const options = document.querySelectorAll('.option-btn');
                
                // Ajouter les écouteurs d'événements aux options
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const questionId = this.closest('.exercise-card').getAttribute('data-exercise');
                        const optionValue = this.getAttribute('data-option');
                        checkAnswer(questionId, optionValue);
                    });
                });
            }
            
				// =====================================================================
				## ⚠️ PRIORITÉS HAUTE : EXEMPLES DE QUESTIONS
				// =====================================================================

            function checkAnswer(questionId, selectedOption) {
                // Définir les réponses correctes pour chaque question
                
                
                const correctAnswers = {
                    '1': 'B', // Paris est la capitale de la France
                    '2': 'A', // H2O est la formule chimique de l'eau
                    '3': 'D', // La photosynthèse est un processus utilisé par les plantes
                    '4': 'C', // 42 est la réponse à la grande question sur la vie
                    '5': 'B', // Le soleil est une étoile
                    '6': 'A'  // La Terre tourne autour du Soleil
                };
                
                // Vérifier si la réponse est correcte
                const isCorrect = selectedOption === correctAnswers[questionId];
                
                // Récupérer les éléments de résultat et d'explication
                const resultDiv = document.getElementById('result' + questionId);
                const explanationDiv = document.getElementById('explanation' + questionId);
                
                // Mettre à jour l'interface utilisateur
                if (isCorrect) {
                    resultDiv.innerHTML = '<span class="success-icon">✓</span> Correct!';
                    resultDiv.className = 'result correct';
                    
                    // Mettre à jour le score
                    incrementScore();
                    
                    // Marquer cette question comme résolue
                    markAsSolved(questionId);
                } else {
                    resultDiv.innerHTML = '<span class="error-icon">✗</span> Incorrect. La bonne réponse était: ' + correctAnswers[questionId];
                    resultDiv.className = 'result incorrect';
                }
                
                // Afficher le résultat et l'explication
                resultDiv.style.display = 'block';
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
                
                // Désactiver les autres options de cette question
                const options = document.querySelectorAll('.exercise-card[data-exercise="' + questionId + '"] .option-btn');
                options.forEach(opt => {
                    opt.disabled = true;
                    
                    // Mettre en évidence la bonne réponse
                    if (opt.getAttribute('data-option') === correctAnswers[questionId]) {
                        opt.classList.add('correct-option');
                    }
                });
                
                // Vérifier si toutes les questions sont complétées
                checkAllCompleted();

            }`,
                
                code: `<div class="exercise-card" data-exercise="1">
    <div class="question-header">
        <span class="question-icon">📝</span>
        <span>Question 1: Quelle est la capitale de la France?</span>
    </div>
    
    <div class="options-container">
        <button class="option-btn" onclick="checkAnswer(1, 'A')">A) Londres</button>
        <button class="option-btn" onclick="checkAnswer(1, 'B')">B) Paris</button>
        <button class="option-btn" onclick="checkAnswer(1, 'C')">C) Berlin</button>
        <button class="option-btn" onclick="checkAnswer(1, 'D')">D) Madrid</button>
    </div>
    
    <div class="result" id="result1"></div>
    <div class="explanation" id="explanation1">Paris est la capitale de la France depuis très longtemps.</div>
</div>`
            },
            

            
			stats: {
				title: "Statistiques à Deux Variables",
				description: "Un template pour explorer les relations entre deux variables statistiques à travers des nuages de points, des droites de régression et l'analyse de corrélation.",
				features: [
					"Simulation interactive avec nuage de points",
					"Calcul et affichage de la droite de régression",
					"Calcul du coefficient de corrélation R et R²",
					"Questions d'extrapolation, d'interpolation et d'analyse de corrélation",
					"Génération de données avec différents niveaux de corrélation"
				],
				icon: "fas fa-chart-scatter",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #5a67d8;">Simulation: Statistiques à Deux Variables</h3>
					</div>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
						<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
							<div style="font-weight: bold; margin-bottom: 5px;">Coefficient R</div>
							<div style="font-size: 1.5em; color: #5a67d8;">0.85</div>
						</div>
						<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
							<div style="font-weight: bold; margin-bottom: 5px;">Coefficient R²</div>
							<div style="font-size: 1.5em; color: #5a67d8;">0.72</div>
						</div>
					</div>
					
					<div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; height: 200px; position: relative;">
						<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666;">
							[Graphique: Nuage de points avec droite de régression]
						</div>
					</div>
					
					<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
						<div style="font-weight: bold; margin-bottom: 5px;">Équation de régression</div>
						<div style="font-size: 1.2em; color: #5a67d8;">y = 2.3x + 1.5</div>
					</div>
					
					<div style="margin-top: 15px; background: #e9ecef; padding: 10px; border-radius: 8px;">
						<div style="font-weight: bold; margin-bottom: 5px;">Question d'exemple:</div>
						<p>En utilisant l'équation de régression, prédisez la valeur de y pour x = 15.</p>
						<div style="display: flex; margin-top: 10px; gap: 10px;">
							<input type="number" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Votre réponse">
							<button style="background: #5a67d8; color: white; border: none; border-radius: 5px; padding: 0 15px;">Vérifier</button>
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE STATISTIQUES À DEUX VARIABLES : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation du template statistiques à deux variables
				initStatsTemplate();
				initializeChart();
				setupEventListeners();
				generateDefaultData();
			});
			
			// Variables globales
			let chart = null;
			let currentData = [];
			let regressionData = null;
			let score = 0;
			let totalAttempts = 0;
			let exerciseAttempts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0};
			let maxAttemptsAllowed = 3;
			let solvedExercises = new Set();
			let currentStats = {
				n: 10,
				r: 0,
				r2: 0,
				equation: '',
				a: 0,
				b: 0
			};
			let isFullscreen = false;
			let targetClickX = 0;
			let targetClickY = 0;
			let activeExercise = null;
			let exerciseData = {}; // Store data for each exercise
			
			function initStatsTemplate() {
				// Initialisation spécifique au template
				console.log("Initialisation du template statistiques à deux variables");
			}
			
			function setupEventListeners() {
				// Enter key for inputs
				document.querySelectorAll('input[type="number"]').forEach(input => {
					input.addEventListener('keypress', function(e) {
						if (e.key === 'Enter') {
							const exerciseNum = this.id.match(/\\d+/)?.[0];
							if (exerciseNum) {
								checkAnswer(parseInt(exerciseNum));
							}
						}
					});
				});
			}
			
			function initializeChart() {
				const ctx = document.getElementById('dataChart').getContext('2d');
				
				chart = new Chart(ctx, {
					type: 'scatter',
					data: {
						datasets: [{
							label: 'Points de données',
							data: [],
							backgroundColor: 'rgba(67, 97, 238, 0.6)',
							borderColor: 'rgba(67, 97, 238, 1)',
							pointRadius: 6,
							pointHoverRadius: 8
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: {
								type: 'linear',
								position: 'bottom',
								title: {
									display: true,
									text: 'Variable X'
								}
							},
							y: {
								title: {
									display: true,
									text: 'Variable Y'
								}
							}
						},
						plugins: {
							tooltip: {
								callbacks: {
									label: function(context) {
										return \`(\${context.parsed.x.toFixed(2)}, \${context.parsed.y.toFixed(2)})\`;
									}
								}
							},
							legend: {
								position: 'top'
							}
						}
					}
				});
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : FONCTIONS POUR GENERER EXERCICES ALEATOIRES
// =====================================================================
			
			// Fonction pour générer des paramètres aléatoires
			function getRandomParameters() {
				const pointCounts = [8, 10, 12, 15];
				const correlationTypes = ['positive', 'negative', 'neutral'];
				const correlationStrengths = [0.3, 0.5, 0.7, 0.8, 0.9];
				
				return {
					pointCount: pointCounts[Math.floor(Math.random() * pointCounts.length)],
					correlationType: correlationTypes[Math.floor(Math.random() * correlationTypes.length)],
					correlationStrength: correlationStrengths[Math.floor(Math.random() * correlationStrengths.length)]
				};
			}
			
			// Fonction pour générer des données par défaut
			function generateDefaultData() {
				const defaultParams = getRandomParameters();
				currentData = generateCorrelatedData(defaultParams.pointCount, defaultParams.correlationType, defaultParams.correlationStrength);
				calculateLinearRegression();
				updateChart();
				updateStats();
				updateDataTable();
			}
			
			// Fonction pour générer des données pour un exercice spécifique
			function generateExerciseData(exerciseNum) {
				// Marquer cet exercice comme actif
				activeExercise = exerciseNum;
				
				// Réinitialiser les tentatives pour cet exercice
				exerciseAttempts[exerciseNum] = 0;
				document.getElementById(\`attempts\${exerciseNum}\`).textContent = maxAttemptsAllowed;
				
				// Générer des paramètres aléatoires pour cet exercice
				const params = getRandomParameters();
				
				
				// Ajuster les paramètres selon le type d'exercice
				switch(exerciseNum) {
					case 1: // Extrapolation - corrélation modérée à forte
						params.correlationStrength = Math.random() * 0.4 + 0.6; // 0.6 à 1.0
						break;
					case 2: // Type de corrélation - tout type possible
						// Garder les paramètres aléatoires
						break;
					case 3: // R² - tout type possible
						// Garder les paramètres aléatoires
						break;
					case 4: // Qualité d'ajustement - tout type possible
						// Garder les paramètres aléatoires
						break;
					case 5: // Interpolation - corrélation modérée à forte
						params.correlationStrength = Math.random() * 0.4 + 0.6; // 0.6 à 1.0
						break;
					case 6: // Force de corrélation - tout type possible
						// Garder les paramètres aléatoires
						break;
				}
				
				// Générer les données spécifiques à cet exercice
				const exerciseSpecificData = generateCorrelatedData(params.pointCount, params.correlationType, params.correlationStrength);
				
				// Stocker les données pour cet exercice
				exerciseData[exerciseNum] = {
					data: exerciseSpecificData,
					params: params
				};
				
				// Mettre à jour la simulation globale avec ces données
				currentData = exerciseSpecificData;
				calculateLinearRegression();
				updateChart();
				updateStats();
				updateDataTable();
				
				// Mettre à jour les données spécifiques de l'exercice
				updateExerciseSpecificData(exerciseNum);
				
				// Réinitialiser l'état de l'exercice
				resetExerciseState(exerciseNum);
				
				// Marquer visuellement l'exercice actif
				document.querySelectorAll('.exercise-card').forEach(card => {
					card.classList.remove('active');
				});
				document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`).classList.add('active');
			}
			
			// Fonction pour générer des données corrélées
			function generateCorrelatedData(n, type, strength) {
				const data = [];
				
				// Générer des valeurs X aléatoirement distribuées
				const xValues = [];
				for (let i = 0; i < n; i++) {
					xValues.push(Math.random() * 20 + 1); // Entre 1 et 21
				}
				xValues.sort((a, b) => a - b);
				
				// Générer des valeurs Y selon la corrélation
				for (let i = 0; i < n; i++) {
					const x = xValues[i];
					let y;
					
					if (type === 'positive') {
						// Corrélation positive
						y = 2 * x + 5 + (Math.random() - 0.5) * (20 * (1 - strength));
					} else if (type === 'negative') {
						// Corrélation négative
						y = -1.5 * x + 30 + (Math.random() - 0.5) * (20 * (1 - strength));
					} else if (type === 'neutral') {
						// Pas de corrélation
						y = 15 + (Math.random() - 0.5) * 20;
					} else {
						// Aléatoire
						const randomType = Math.random() > 0.5 ? 1 : -1;
						const randomStrength = Math.random() * strength;
						y = randomType * randomStrength * x + Math.random() * 10 + 10;
					}
					
					data.push({x: x, y: Math.max(0, y)});
				}
				
				return data;
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : REGRESSION LINEAIRE ET GRAPHIQUE
// =====================================================================			
			
			// Fonction pour calculer la régression linéaire
			function calculateLinearRegression() {
				if (currentData.length < 2) return;
				
				const n = currentData.length;
				let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
				
				currentData.forEach(point => {
					sumX += point.x;
					sumY += point.y;
					sumXY += point.x * point.y;
					sumX2 += point.x * point.x;
					sumY2 += point.y * point.y;
				});
				
				// Calcul des coefficients
				const a = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
				const b = (sumY - a * sumX) / n;
				
				// Calcul du coefficient de corrélation
				const numerator = n * sumXY - sumX * sumY;
				const denominatorX = Math.sqrt(n * sumX2 - sumX * sumX);
				const denominatorY = Math.sqrt(n * sumY2 - sumY * sumY);
				const r = numerator / (denominatorX * denominatorY);
				
				// Mise à jour des statistiques
				currentStats = {
					n: n,
					r: r,
					r2: r * r,
					equation: \`y = \${a.toFixed(3)}x + \${b.toFixed(3)}\`,
					a: a,
					b: b
				};
				
				// Créer les points de la droite de régression
				const minX = Math.min(...currentData.map(p => p.x));
				const maxX = Math.max(...currentData.map(p => p.x));
				regressionData = [
					{x: minX, y: a * minX + b},
					{x: maxX, y: a * maxX + b}
				];
			}
			
			// Fonction pour mettre à jour le graphique
			function updateChart() {
				if (!chart) return;
				
				// Mettre à jour les points de données
				chart.data.datasets[0].data = currentData;
				
				// Ajouter la droite de régression si elle n'existe pas
				if (chart.data.datasets.length === 1) {
					chart.data.datasets.push({
						label: 'Droite de régression',
						data: regressionData,
						borderColor: 'rgba(231, 76, 60, 1)',
						backgroundColor: 'rgba(231, 76, 60, 0.1)',
						pointRadius: 0,
						pointHoverRadius: 0,
						showLine: true,
						borderWidth: 2,
						type: 'line'
					});
				} else {
					chart.data.datasets[1].data = regressionData;
				}
				
				chart.update();
			}
			
			// Fonction pour mettre à jour les statistiques affichées
			function updateStats() {
				document.getElementById('statN').textContent = currentStats.n;
				document.getElementById('statR').textContent = currentStats.r.toFixed(3);
				document.getElementById('statR2').textContent = currentStats.r2.toFixed(3);
				document.getElementById('statEquation').textContent = currentStats.equation;
			}
			
			// Fonction pour mettre à jour le tableau de données
			function updateDataTable() {
				const tbody = document.getElementById('dataTableBody');
				tbody.innerHTML = '';
				
				currentData.forEach((point, index) => {
					const row = tbody.insertRow();
					row.insertCell(0).textContent = index + 1;
					row.insertCell(1).textContent = point.x.toFixed(2);
					row.insertCell(2).textContent = point.y.toFixed(2);
					row.insertCell(3).textContent = \`(\${point.x.toFixed(2)}, \${point.y.toFixed(2)})\`;
				});
			}
				
// =====================================================================
## ⚠️ IMPORTANT  : DONNEES D EXERCICES
// =====================================================================			

			// Fonction pour mettre à jour les données spécifiques d'un exercice
			function updateExerciseSpecificData(exerciseNum) {
				switch(exerciseNum) {
					case 1:
						const extrapolationX = Math.round(Math.max(...currentData.map(p => p.x)) + Math.random() * 5 + 2);
						document.getElementById('extrapolationX').textContent = extrapolationX;
						document.getElementById('data1').innerHTML = \`
							<strong>Données pour extrapolation:</strong><br>
							Équation: \${currentStats.equation}<br>
							Calcul pour x = \${extrapolationX}:<br>
							y = \${currentStats.a.toFixed(3)} × \${extrapolationX} + \${currentStats.b.toFixed(3)}
						\`;
						break;
						
					case 2:
						document.getElementById('data2').innerHTML = \`
							<strong>Analyse de corrélation:</strong><br>
							Coefficient de corrélation R = \${currentStats.r.toFixed(3)}<br>
							Analysez le signe et la valeur absolue de R pour déterminer le type de corrélation.
						\`;
						break;
						
					case 3:
						document.getElementById('r2Value').textContent = currentStats.r2.toFixed(3);
						document.getElementById('data3').innerHTML = \`
							<strong>Interprétation du R²:</strong><br>
							R² = \${currentStats.r2.toFixed(3)}<br>
							Le R² représente la proportion de variance de Y expliquée par X.<br>
							Convertissez cette valeur en pourcentage.
						\`;
						break;
			
					case 4:
						document.getElementById('data4').innerHTML = \`
							<strong>Évaluation de la qualité:</strong><br>
							R² = \${currentStats.r2.toFixed(3)}<br>
							Critères d'évaluation:<br>
							• Excellent: R² > 0.9<br>
							• Bon: 0.7 < R² ≤ 0.9<br>
							• Modéré: 0.5 < R² ≤ 0.7<br>
							• Faible: R² ≤ 0.5
						\`;
						break;
			
					case 5:
						// Interpolation - choisir une valeur entre min et max des X
						const minX = Math.min(...currentData.map(p => p.x));
						const maxX = Math.max(...currentData.map(p => p.x));
						const interpolationX = Math.round(minX + (maxX - minX) * (0.3 + Math.random() * 0.4)); // Entre 30% et 70% de la plage
						document.getElementById('interpolationX').textContent = interpolationX;
						document.getElementById('data5').innerHTML = \`
							<strong>Données pour interpolation:</strong><br>
							Équation: \${currentStats.equation}<br>
							Calcul pour x = \${interpolationX} (valeur intermédiaire):<br>
							y = \${currentStats.a.toFixed(3)} × \${interpolationX} + \${currentStats.b.toFixed(3)}
						\`;
						break;
						
					case 6:
						document.getElementById('data6').innerHTML = \`
							<strong>Analyse de la force de corrélation:</strong><br>
							Coefficient de corrélation R = \${currentStats.r.toFixed(3)}<br>
							Valeur absolue |R| = \${Math.abs(currentStats.r).toFixed(3)}<br>
							Évaluez la force de cette corrélation indépendamment du signe.
						\`;
						break;
				}
			}
			
			// Fonction pour réinitialiser l'état d'un exercice
			function resetExerciseState(exerciseNum) {
				// Réinitialiser les champs de saisie
				const inputs = document.querySelectorAll(\`.exercise-card[data-exercise="\${exerciseNum}"] input\`);
				const selects = document.querySelectorAll(\`.exercise-card[data-exercise="\${exerciseNum}"] select\`);
				
				inputs.forEach(input => {
					input.value = '';
					input.disabled = false;
				});
				
				selects.forEach(select => {
					select.selectedIndex = 0;
					select.disabled = false;
				});
				
				// Réinitialiser les résultats et indices
				const result = document.getElementById(\`result\${exerciseNum}\`);
				const hint = document.getElementById(\`hint\${exerciseNum}\`);
				const button = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"] .check-btn\`);
				
				if (result) {
					result.className = 'result';
					result.innerHTML = '';
				}
				
				if (hint) {
					hint.style.display = 'none';
				}
				
				if (button) {
					button.disabled = false;
				}
				
				// Retirer le statut résolu
				const card = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`);
				if (card) {
					card.classList.remove('solved');
				}
				
				// Retirer de la liste des exercices résolus
				solvedExercises.delete(exerciseNum);
			}
			
			// Fonction pour vérifier les réponses
			function checkAnswer(exerciseNum) {
				// Vérifier si des données ont été générées pour cet exercice
				if (activeExercise !== exerciseNum) {
					alert("Veuillez d'abord générer un nuage de points pour cet exercice.");
					return;
				}
				
				// Vérifier si déjà résolu
				if (solvedExercises.has(exerciseNum)) {
					return;
				}
				
				// Incrémenter les tentatives
				exerciseAttempts[exerciseNum]++;
				totalAttempts++;
				
				// Mettre à jour l'affichage des tentatives
				document.getElementById(\`attempts\${exerciseNum}\`).textContent = 
					Math.max(0, maxAttemptsAllowed - exerciseAttempts[exerciseNum]);
				
				let isCorrect = false;
				let explanation = '';
				
				// Vérifier la réponse selon l'exercice
				switch(exerciseNum) {
					case 1:
						isCorrect = checkExtrapolation();
						explanation = "La valeur correcte est " + (currentStats.a * parseFloat(document.getElementById('extrapolationX').textContent) + currentStats.b).toFixed(2);
						break;
					case 2:
						isCorrect = checkCorrelationType();
						explanation = getCorrelationExplanation();
						break;
					case 3:
						isCorrect = checkR2Interpretation();
						explanation = "R² = " + currentStats.r2.toFixed(3) + " équivaut à " + (currentStats.r2 * 100).toFixed(1) + "%";
						break;
					case 4:
						isCorrect = checkFitQuality();
						explanation = getFitQualityExplanation();
						break;
					case 5:
						isCorrect = checkInterpolation();
						explanation = "La valeur correcte est " + (currentStats.a * parseFloat(document.getElementById('interpolationX').textContent) + currentStats.b).toFixed(2);
						break;
					case 6:
						isCorrect = checkCorrelationStrength();
						explanation = getCorrelationStrengthExplanation();
						break;
				}
				
				// Afficher le résultat
				const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
				const hintDiv = document.getElementById(\`hint\${exerciseNum}\`);
				
				if (isCorrect) {
					resultDiv.innerHTML = \`✓ Correct! \${explanation}\`;
					resultDiv.className = 'result correct show';
					hintDiv.style.display = 'none';
					
					// Marquer comme résolu
					solvedExercises.add(exerciseNum);
					document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`).classList.add('solved');
					
					// Désactiver les contrôles
					disableExerciseControls(exerciseNum);
					
					// Incrémenter le score en fonction du nombre de tentatives
					incrementScore(exerciseNum);
					
					// Vérifier si tous les exercices sont complétés
					checkAllCompleted();
					
				} else {
					resultDiv.textContent = '✗ Incorrect. Essayez encore!';
					resultDiv.className = 'result incorrect show';
					
					if (exerciseAttempts[exerciseNum] >= maxAttemptsAllowed) {
						hintDiv.style.display = 'block';
						disableExerciseControls(exerciseNum);
						resultDiv.innerHTML += \`<br>Réponse correcte: \${explanation}\`;
					} else {
						hintDiv.style.display = 'block';
					}
				}
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : VERIFICATION DES RESULTATS
// =====================================================================
			
			// Fonction pour vérifier l'extrapolation
			function checkExtrapolation() {
				const extrapolationX = parseFloat(document.getElementById('extrapolationX').textContent);
				const expectedY = currentStats.a * extrapolationX + currentStats.b;
				const answerY = parseFloat(document.getElementById('answer1').value);
				
				const tolerance = Math.abs(expectedY * 0.05); // 5% de tolérance
				return Math.abs(answerY - expectedY) <= Math.max(tolerance, 0.5);
			}
			
			// Fonction pour vérifier le type de corrélation
			function checkCorrelationType() {
				const answer = document.getElementById('answer2').value;
				const r = currentStats.r;
				
				if (r > 0.7) return answer === 'positive-forte';
				if (r > 0.3) return answer === 'positive-moderee';
				if (r > 0) return answer === 'positive-faible';
				if (r < -0.7) return answer === 'negative-forte';
				if (r < -0.3) return answer === 'negative-moderee';
				if (r < 0) return answer === 'negative-faible';
				return answer === 'nulle';
			}
			
			// Fonction pour obtenir l'explication du type de corrélation
			function getCorrelationExplanation() {
				const r = currentStats.r;
				if (r > 0.7) return 'Corrélation positive forte';
				if (r > 0.3) return 'Corrélation positive modérée';
				if (r > 0) return 'Corrélation positive faible';
				if (r < -0.7) return 'Corrélation négative forte';
				if (r < -0.3) return 'Corrélation négative modérée';
				if (r < 0) return 'Corrélation négative faible';
				return 'Corrélation nulle';
			}
			
			// Fonction pour vérifier l'interprétation du R²
			function checkR2Interpretation() {
				const expectedPercentage = currentStats.r2 * 100;
				const answerPercentage = parseFloat(document.getElementById('answer3').value);
				
				return Math.abs(answerPercentage - expectedPercentage) <= 2; // 2% de tolérance
			}
			
			// Fonction pour vérifier la qualité d'ajustement
			function checkFitQuality() {
				const answer = document.getElementById('answer4').value;
				const r2 = currentStats.r2;
				
				if (r2 > 0.9) return answer === 'excellent';
				if (r2 > 0.7) return answer === 'bon';
				if (r2 > 0.5) return answer === 'modere';
				return answer === 'faible';
			}
			
			// Fonction pour obtenir l'explication de la qualité d'ajustement
			function getFitQualityExplanation() {
				const r2 = currentStats.r2;
				if (r2 > 0.9) return 'Ajustement excellent';
				if (r2 > 0.7) return 'Bon ajustement';
				if (r2 > 0.5) return 'Ajustement modéré';
				return 'Ajustement faible';
			}
			
			// Fonction pour vérifier l'interpolation
			function checkInterpolation() {
				const interpolationX = parseFloat(document.getElementById('interpolationX').textContent);
				const expectedY = currentStats.a * interpolationX + currentStats.b;
				const answerY = parseFloat(document.getElementById('answer5').value);
				
				const tolerance = Math.abs(expectedY * 0.05); // 5% de tolérance
				return Math.abs(answerY - expectedY) <= Math.max(tolerance, 0.5);
			}
			
			// Fonction pour vérifier la force de corrélation
			function checkCorrelationStrength() {
				const answer = document.getElementById('answer6').value;
				const absR = Math.abs(currentStats.r);
				
				if (absR > 0.9) return answer === 'tres-forte';
				if (absR > 0.7) return answer === 'forte';
				if (absR > 0.5) return answer === 'moderee';
				if (absR > 0.3) return answer === 'faible';
				return answer === 'tres-faible';
			}
			
			// Fonction pour obtenir l'explication de la force de corrélation
			function getCorrelationStrengthExplanation() {
				const absR = Math.abs(currentStats.r);
				if (absR > 0.9) return 'Corrélation très forte';
				if (absR > 0.7) return 'Corrélation forte';
				if (absR > 0.5) return 'Corrélation modérée';
				if (absR > 0.3) return 'Corrélation faible';
				return 'Corrélation très faible';
			}
			
			// Fonction pour désactiver les contrôles d'un exercice
			function disableExerciseControls(exerciseNum) {
				const card = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`);
				const inputs = card.querySelectorAll('input, select');
				const button = card.querySelector('.check-btn');
				
				inputs.forEach(input => input.disabled = true);
				if (button) button.disabled = true;
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : SCORE ET TENTATIVES
// =====================================================================			
			
			// Fonction pour incrémenter le score selon le nombre de tentatives
			function incrementScore(exerciseNum) {
				// Cette fonction est remplacée par celle commune à toutes les applications
				console.log("Fonction incrementScore à remplacer par celle commune");
			}
			
			// Fonction pour vérifier si tous les exercices sont complétés
			function checkAllCompleted() {
				// Cette fonction est remplacée par celle commune à toutes les applications
				console.log("Fonction checkAllCompleted à remplacer par celle commune");
			}`,
				
				code: `<!-- Simulation Card -->
			<div class="simulation-card" id="simulationCard">
				<div class="simulation-header">
					<h2 class="simulation-title">Simulation Interactive</h2>
				</div>
			
				<!-- Statistics Display -->
				<div class="stats-display">
					<div class="stat-card">
						<div class="stat-value" id="statN">10</div>
						<div class="stat-label">Nombre de points</div>
					</div>
					<div class="stat-card">
						<div class="stat-value" id="statR">0.85</div>
						<div class="stat-label">Coefficient R</div>
					</div>
					<div class="stat-card">
						<div class="stat-value" id="statR2">0.72</div>
						<div class="stat-label">Coefficient R²</div>
					</div>
					<div class="stat-card">
						<div class="stat-value" id="statEquation">y = 2.3x + 1.5</div>
						<div class="stat-label">Équation de régression</div>
					</div>
				</div>
			
				<!-- Chart -->
				<div class="chart-container">
					<canvas id="dataChart"></canvas>
				</div>
			
				<!-- Data Table -->
				<div class="data-table-container">
					<table class="data-table" id="dataTable">
						<thead>
							<tr>
								<th>Point</th>
								<th>X</th>
								<th>Y</th>
								<th>Coordonnées</th>
							</tr>
						</thead>
						<tbody id="dataTableBody">
							<!-- Data will be populated here -->
						</tbody>
					</table>
				</div>
			</div>
			
			
// =====================================================================
## ⚠️ EXERCICES SELON CHOIX UTILISATEUR

Si TYPE_1 est sélectionné → Inclure le code d'exercice "Extrapolation"
Si TYPE_2 est sélectionné → Inclure le code d'exercice "Type de corrélation"
Si TYPE_3 est sélectionné → Inclure le code d'exercice "Interprétation du R²"
Si TYPE_4 est sélectionné → Inclure le code d'exercice "Qualité d'ajustement"
Si TYPE_5 est sélectionné → Inclure le code d'exercice "Interpolation"
Si TYPE_6 est sélectionné → Inclure le code d'exercice "Force de corrélation"

Pour chaque type NON sélectionné :

❌ Ne pas inclure le code HTML correspondant
❌ Ne pas inclure les fonctions JavaScript correspondantes
❌ Ne pas inclure les vérifications de réponses correspondantes
// =====================================================================
			
### ⚠️⚠️ PRIORITE HAUTE : : UTILISER UNIQUEMENT SI CHOISI LE TYPE D EXERCICE 1
${appState.templateSettings.stats.questions.extrapolation ? '- Extrapolation: Prédire Y pour une valeur X située en dehors des données observées' : ''}

			<!-- TYPE D EXERCICE 1 : EXTRAPOLATION -->
			<div class="exercises">
				<!-- Exercise 1: Extrapolation -->
				<div class="exercise-card" data-exercise="1">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 1: Extrapolation</div>
						<div class="exercise-attempts" id="attempts1">3</div>
					</div>
					
					<div style="text-align: center; margin-bottom: 15px;">
						<button class="btn" onclick="generateExerciseData(1)">
							🎲 Générer un nuage de points
						</button>
					</div>
					
					<div class="question-text" id="question1">
						En utilisant l'équation de régression, prédisez la valeur de y pour x = <span id="extrapolationX">15</span>.
					</div>
					
					<div class="data-display" id="data1">
						Données actuelles: Cliquez sur "Générer un nuage de points" pour commencer cet exercice.
					</div>
					
					<div class="input-group">
						<label>Valeur prédite de y:</label>
						<input type="number" id="answer1" placeholder="Entrez votre prédiction" step="0.01">
					</div>
					
					<button class="check-btn" onclick="checkAnswer(1)">Vérifier</button>
					<div class="result" id="result1"></div>
					<div class="hint" id="hint1">
						Indice: Substituez la valeur de x dans l'équation de régression pour calculer y.
					</div>
				</div>
			
### ⚠️⚠️ PRIORITE HAUTE : : UTILISER UNIQUEMENT SI CHOISI LE TYPE D EXERCICE 5		
${appState.templateSettings.stats.questions.interpolation ? '- Interpolation: Estimer Y pour une valeur X située entre les données observées' : ''}
			
				<!-- TYPE D EXERCICE 5 : INTRAPOLATION -->
				<div class="exercise-card" data-exercise="5">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 5: Interpolation</div>
						<div class="exercise-attempts" id="attempts5">3</div>
					</div>
					
					<div style="text-align: center; margin-bottom: 15px;">
						<button class="btn" onclick="generateExerciseData(5)">
							🎲 Générer un nuage de points
						</button>
					</div>
					
					<div class="question-text" id="question5">
						En utilisant l'équation de régression, estimez la valeur de y pour x = <span id="interpolationX">12</span> (valeur située entre les points observés).
					</div>
					
					<div class="data-display" id="data5">
						Données actuelles: Cliquez sur "Générer un nuage de points" pour commencer cet exercice.
					</div>
					
					<div class="input-group">
						<label>Valeur interpolée de y:</label>
						<input type="number" id="answer5" placeholder="Entrez votre estimation" step="0.01">
					</div>
					
					<button class="check-btn" onclick="checkAnswer(5)">Vérifier</button>
					<div class="result" id="result5"></div>
					<div class="hint" id="hint5">
						Indice: L'interpolation consiste à estimer une valeur située entre les points observés en utilisant l'équation de régression.
					</div>
				</div>			
				
### ⚠️⚠️ PRIORITE HAUTE : : UTILISER UNIQUEMENT SI CHOISI LE TYPE D EXERCICE 2					
${appState.templateSettings.stats.questions.correlationType ? '- Type de corrélation: Déterminer si la corrélation est positive, négative ou neutre' : ''}			
				
				<!-- EXERCICES TYPE 2 : TYPE DE CORRELATION -->
				<div class="exercise-card" data-exercise="2">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 2: Type de corrélation</div>
						<div class="exercise-attempts" id="attempts2">3</div>
					</div>
					
					<div style="text-align: center; margin-bottom: 15px;">
						<button class="btn" onclick="generateExerciseData(2)">
							🎲 Générer un nuage de points
						</button>
					</div>
					
					<div class="question-text" id="question2">
						Observez le nuage de points et déterminez le type de corrélation entre les variables X et Y.
					</div>
					
					<div class="data-display" id="data2">
						Données actuelles: Cliquez sur "Générer un nuage de points" pour commencer cet exercice.
					</div>
					
					<div class="input-group">
						<label>Type de corrélation:</label>
						<select id="answer2">
							<option value="">Sélectionnez...</option>
							<option value="positive-forte">Positive forte (R > 0.7)</option>
							<option value="positive-moderee">Positive modérée (0.3 < R ≤ 0.7)</option>
							<option value="positive-faible">Positive faible (0 < R ≤ 0.3)</option>
							<option value="negative-forte">Négative forte (R < -0.7)</option>
							<option value="negative-moderee">Négative modérée (-0.7 ≤ R < -0.3)</option>
							<option value="negative-faible">Négative faible (-0.3 ≤ R < 0)</option>
							<option value="nulle">Nulle ou très faible (R ≈ 0)</option>
						</select>
					</div>
					
					<button class="check-btn" onclick="checkAnswer(2)">Vérifier</button>
					<div class="result" id="result2"></div>
					<div class="hint" id="hint2">
						Indice: Une corrélation positive signifie que Y augmente quand X augmente. Une corrélation négative signifie que Y diminue quand X augmente.
					</div>
				</div>
			
### ⚠️⚠️ PRIORITE HAUTE : : UTILISER UNIQUEMENT SI CHOISI LE TYPE D EXERCICE 3	
${appState.templateSettings.stats.questions.r2Interpretation ? '- Interprétation du R²: Convertir R² en pourcentage de variance expliquée' : ''}
			
				<!-- EXERCICES TYPES 3 / INTERPRETATION DE R²-->
				<div class="exercise-card" data-exercise="3">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 3: Interprétation du R²</div>
						<div class="exercise-attempts" id="attempts3">3</div>
					</div>
					
					<div style="text-align: center; margin-bottom: 15px;">
						<button class="btn" onclick="generateExerciseData(3)">
							🎲 Générer un nuage de points
						</button>
					</div>
					
					<div class="question-text" id="question3">
						Avec un coefficient de détermination R² = <span id="r2Value">0.72</span>, quel pourcentage de la variance de Y est expliqué par X ?
					</div>
					
					<div class="data-display" id="data3">
						Données actuelles: Cliquez sur "Générer un nuage de points" pour commencer cet exercice.
					</div>
					
					<div class="input-group">
						<label>Pourcentage de variance expliquée (%):</label>
						<input type="number" id="answer3" placeholder="Entrez le pourcentage" step="0.1" min="0" max="100">
					</div>
					
					<button class="check-btn" onclick="checkAnswer(3)">Vérifier</button>
					<div class="result" id="result3"></div>
					<div class="hint" id="hint3">
						Indice: R² s'exprime souvent en pourcentage. Multipliez la valeur par 100.
					</div>
				</div>
			
			
### ⚠️⚠️ PRIORITE HAUTE : : UTILISER UNIQUEMENT SI CHOISI LE TYPE D EXERCICE 4	
${appState.templateSettings.stats.questions.fitQuality ? '- Qualité d\'ajustement: Évaluer la qualité du modèle basé sur R²' : ''}
			
				<!-- EXERCICES TYPES 4 :  QUALITE D AJUSTEMENT -->
				<div class="exercise-card" data-exercise="4">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 4: Qualité de l'ajustement</div>
						<div class="exercise-attempts" id="attempts4">3</div>
					</div>
					
					<div style="text-align: center; margin-bottom: 15px;">
						<button class="btn" onclick="generateExerciseData(4)">
							🎲 Générer un nuage de points
						</button>
					</div>
					
					<div class="question-text" id="question4">
						Évaluez la qualité de l'ajustement du modèle linéaire basé sur le coefficient R².
					</div>
					
					<div class="data-display" id="data4">
						Données actuelles: Cliquez sur "Générer un nuage de points" pour commencer cet exercice.
					</div>
					
					<div class="input-group">
						<label>Qualité de l'ajustement:</label>
						<select id="answer4">
							<option value="">Sélectionnez...</option>
							<option value="excellent">Excellent (R² > 0.9)</option>
							<option value="bon">Bon (0.7 < R² ≤ 0.9)</option>
							<option value="modere">Modéré (0.5 < R² ≤ 0.7)</option>
							<option value="faible">Faible (R² ≤ 0.5)</option>
						</select>
					</div>
					
					<button class="check-btn" onclick="checkAnswer(4)">Vérifier</button>
					<div class="result" id="result4"></div>
					<div class="hint" id="hint4">
						Indice: Plus R² est proche de 1, meilleure est la qualité de l'ajustement du modèle.
					</div>
				</div>
			
### ⚠️⚠️ PRIORITE HAUTE : : UTILISER UNIQUEMENT SI CHOISI LE TYPE D EXERCICE 6	
${appState.templateSettings.stats.questions.correlationStrength ? '- Force de corrélation: Analyser la force de la relation entre X et Y' : ''}

				<!-- TYPE D EXERCICE 6 :  FORCE DE CORRELATION -->
				<div class="exercise-card" data-exercise="6">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 6: Analyse de la force de corrélation</div>
						<div class="exercise-attempts" id="attempts6">3</div>
					</div>
					
					<div style="text-align: center; margin-bottom: 15px;">
						<button class="btn" onclick="generateExerciseData(6)">
							🎲 Générer un nuage de points
						</button>
					</div>
					
					<div class="question-text" id="question6">
						Analysez la force de la corrélation basée sur la valeur du coefficient R.
					</div>
					
					<div class="data-display" id="data6">
						Données actuelles: Cliquez sur "Générer un nuage de points" pour commencer cet exercice.
					</div>
					
					<div class="input-group">
						<label>Force de la corrélation:</label>
						<select id="answer6">
							<option value="">Sélectionnez...</option>
							<option value="tres-forte">Très forte (|R| > 0.9)</option>
							<option value="forte">Forte (0.7 < |R| ≤ 0.9)</option>
							<option value="moderee">Modérée (0.5 < |R| ≤ 0.7)</option>
							<option value="faible">Faible (0.3 < |R| ≤ 0.5)</option>
							<option value="tres-faible">Très faible (|R| ≤ 0.3)</option>
						</select>
					</div>
					
					<button class="check-btn" onclick="checkAnswer(6)">Vérifier</button>
					<div class="result" id="result6"></div>
					<div class="hint" id="hint6">
						Indice: La force de la corrélation dépend de la valeur absolue de R, indépendamment du signe (positif ou négatif).
					</div>
				</div>
			</div>`
			},
            
            
            
			tableaux: {
				title: "Tableaux de valeurs de fonctions",
				description: "Un template pour créer des exercices de tableaux de valeurs pour différents types de fonctions mathématiques. L'apprenant doit compléter les tableaux en calculant les images ou antécédents des fonctions.",
				features: [
					"Support de multiples types de fonctions (linéaires, affines, polynômes, trigonométriques)",
					"Calcul d'images et/ou d'antécédents",
					"Tableaux avec colonnes configurables", 
					"Pré-remplissage aléatoire de certaines valeurs",
					"Graphiques interactifs avec repère cartésien",
					"Gestion des tentatives multiples",
					"Vérification automatique avec tolérance"
				],
				icon: "fas fa-table",
				previewHtml: `
					<div style="max-width: 600px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
						<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
							<h3 style="margin-bottom: 10px; color: #5a67d8;">Exercice: Fonction f(x) = 2x + 1</h3>
							<p style="margin-bottom: 15px;">Complétez le tableau de valeurs</p>
							
							<div style="overflow-x: auto; margin-bottom: 15px;">
								<table style="width: 100%; border-collapse: collapse;">
									<tr style="background: #f0f8ff;">
										<th style="border: 1px solid #ddd; padding: 8px;">x</th>
										<th style="border: 1px solid #ddd; padding: 8px;">-2</th>
										<th style="border: 1px solid #ddd; padding: 8px;">-1</th>
										<th style="border: 1px solid #ddd; padding: 8px;">0</th>
										<th style="border: 1px solid #ddd; padding: 8px;">1</th>
										<th style="border: 1px solid #ddd; padding: 8px;">2</th>
									</tr>
									<tr>
										<td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">f(x)</td>
										<td style="border: 1px solid #ddd; padding: 8px; background: #f9f9f9;">-3</td>
										<td style="border: 1px solid #ddd; padding: 8px;"><input type="text" style="width: 50px; text-align: center;" value="?"></td>
										<td style="border: 1px solid #ddd; padding: 8px;"><input type="text" style="width: 50px; text-align: center;" value="1"></td>
										<td style="border: 1px solid #ddd; padding: 8px;"><input type="text" style="width: 50px; text-align: center;" value="?"></td>
										<td style="border: 1px solid #ddd; padding: 8px; background: #f9f9f9;">5</td>
									</tr>
								</table>
							</div>
							
							<div style="background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
								<canvas width="300" height="200" style="display: block; margin: 0 auto; background: white; border-radius: 5px;"></canvas>
							</div>
							
							<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
								✅ Correct ! Les valeurs manquantes sont: -1 et 3
							</div>
						</div>
					</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE TABLEAUX DE VALEURS : PRIORITE OBLIGATOIRE SI CHOISIE
			
			// ========== VARIABLES SPECIFIQUES AUX TABLEAUX DE VALEURS ==========
			let tableauxSolved = new Set();
			let tableauxAnswered = new Set(); 
			let tableauxAttempts = {};
			let prefilledCells = {}; // Cellules pré-remplies par exercice
			let functionDefinitions = {}; // Définitions des fonctions par exercice
			
			// ========== TYPES DE FONCTIONS SUPPORTEES ==========
			const functionTypes = {
				'lineaire': {
					name: 'Linéaire f(x) = ax',
					generate: (a = 2) => ({
						formula: \`f(x) = \${a}x\`,
						calculate: (x) => a * x,
						params: { a }
					})
				},
				'affine': {
					name: 'Affine f(x) = ax + b', 
					generate: (a = 2, b = 1) => ({
						formula: \`f(x) = \${a}x + \${b}\`,
						calculate: (x) => a * x + b,
						params: { a, b }
					})
				},
				'polynome': {
					name: 'Polynôme f(x) = ax² + bx + c',
					generate: (a = 1, b = 0, c = 0) => ({
						formula: \`f(x) = \${a}x² + \${b}x + \${c}\`,
						calculate: (x) => a * x * x + b * x + c,
						params: { a, b, c }
					})
				},
				'trigonometrique': {
					name: 'Trigonométrique f(x) = a*sin(x) + b',
					generate: (a = 1, b = 0) => ({
						formula: \`f(x) = \${a}sin(x) + \${b}\`,
						calculate: (x) => a * Math.sin(x) + b,
						params: { a, b }
					})
				}
			};
			
			// ========== INITIALISATION DES TABLEAUX DE VALEURS ==========
			document.addEventListener('DOMContentLoaded', function() {
				initTableauxExercises();
			});
			
			function initTableauxExercises() {
				// Générer les définitions de fonctions pour chaque exercice
				generateFunctionDefinitions();
				
				// Générer les indices des cellules à pré-remplir
				generatePrefilledIndices();
				
				// Initialiser les graphiques
				initTableauxGraphs();
				
				// Pré-remplir les tableaux
				prefillTableaux();
				
				// Configurer les exercices
				setupTableauxExercises();
			}
			
// =====================================================================
## ⚠️⚠️ PRIORITE HAUTE : SELECTIONNER EXERCICES SELON CHOIX UTILISATEUR
// =====================================================================
			
			// ========== GENERATION DES FONCTIONS ==========
			function generateFunctionDefinitions() {
				const types = ['lineaire', 'affine', 'polynome', 'affine', 'lineaire', 'polynome'];
				
				for (let i = 1; i <= 6; i++) {
					const type = types[i - 1];
					let params;
					
					switch(type) {
						case 'lineaire':
							params = [Math.floor(Math.random() * 4) + 1]; // a entre 1 et 4
							break;
						case 'affine':
							params = [
								Math.floor(Math.random() * 3) + 1, // a entre 1 et 3
								Math.floor(Math.random() * 5) - 2  // b entre -2 et 2
							];
							break;
						case 'polynome':
							params = [
								Math.random() < 0.5 ? 1 : 0.5, // a = 1 ou 0.5
								Math.floor(Math.random() * 3),  // b entre 0 et 2
								Math.floor(Math.random() * 3)   // c entre 0 et 2
							];
							break;
					}
					
					functionDefinitions[i] = functionTypes[type].generate(...params);
					functionDefinitions[i].type = type;
				}
			}
			
			// ========== GENERATION DES CELLULES PRE-REMPLIES ==========
			function generatePrefilledIndices() {
				for (let exerciseId = 1; exerciseId <= 6; exerciseId++) {
					const totalColumns = 7; // Colonnes par défaut (-3 à 3)
					const indices = Array.from({length: totalColumns}, (_, i) => i);
					
					// Mélanger et sélectionner 3-4 cellules à pré-remplir
					shuffleArray(indices);
					const numPrefilled = Math.floor(Math.random() * 2) + 3; // 3 ou 4
					prefilledCells[exerciseId] = indices.slice(0, numPrefilled);
				}
			}
			
			// ========== FONCTIONS DE GESTION DES TABLEAUX ==========
			function prefillTableaux() {
				const inputLetters = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
				const xValues = [-3, -2, -1, 0, 1, 2, 3];
				
				for (let exerciseId = 1; exerciseId <= 6; exerciseId++) {
					const func = functionDefinitions[exerciseId];
					
					for (let index of prefilledCells[exerciseId]) {
						const inputId = 'answer' + exerciseId + inputLetters[index];
						const input = document.getElementById(inputId);
						
						if (input) {
							const x = xValues[index];
							let value = func.calculate(x);
							
							// Formater la valeur (arrondir à 1 décimale)
							value = Math.round(value * 10) / 10;
							let displayValue = Number.isInteger(value) 
								? value.toString() 
								: value.toString().replace('.', ',');
							
							input.value = displayValue;
							input.disabled = true;
						}
					}
				}
			}
			
			// ========== GENERATION ALEATOIRE DES CELLULES PRE-REMPLIES ==========
			
			javascriptfunction generatePrefilledCells() {
				for (let exerciseId = 1; exerciseId <= 6; exerciseId++) {
					const indices = [0, 1, 2, 3, 4, 5, 6];
					shuffleArray(indices);
					prefilledCells[exerciseId] = indices.slice(0, 3); // 3 cellules pré-remplies
				}
			}
			
			function shuffleArray(array) {
				for (let i = array.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[array[i], array[j]] = [array[j], array[i]];
				}
				return array;
			}	
			
			function prefillTables() {
				const inputLetters = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
				const xValues = [-3, -2, -1, 0, 1, 2, 3];
				
				for (let exerciseId = 1; exerciseId <= 6; exerciseId++) {
					const func = exerciseFunctions[exerciseId];
					
					for (let index of prefilledCells[exerciseId]) {
						const inputId = 'answer' + exerciseId + inputLetters[index];
						const input = document.getElementById(inputId);
						
						if (input) {
							const x = xValues[index];
							let value = func.calculate(x); // ← Calcul de la valeur
							
							// Formater avec virgule pour les décimaux
							let displayValue = Number.isInteger(value) 
								? value.toString() 
								: value.toString().replace('.', ',');
							
							input.value = displayValue;
							input.disabled = true;
						}
					}
				}
			}
			
			// ========== GESTION DES GRAPHIQUES ==========
			function initTableauxGraphs() {
				for (let i = 1; i <= 6; i++) {
					drawTableauxGraph(i);
				}
			}
			
			function drawTableauxGraph(id) {
				const canvas = document.getElementById('canvas' + id);
				if (!canvas) return;
				
				const func = functionDefinitions[id];
				const coords = drawCoordinateSystem(canvas, -3, 3, -10, 20);
				
				// Dessiner la fonction
				drawFunction(coords, func.calculate, '#1E90FF');
				
				// Dessiner les points du tableau
				const xValues = [-3, -2, -1, 0, 1, 2, 3];
				drawTablePoints(coords, xValues, func.calculate, '#ff0000');
				
				// Ajouter le titre
				coords.ctx.fillStyle = '#1E90FF';
				coords.ctx.font = 'bold 14px Arial';
				coords.ctx.textAlign = 'center';
				coords.ctx.fillText(func.formula, coords.width / 2, 20);
			}
			
			// ========== CONFIGURATION DES EXERCICES ==========
			function setupTableauxExercises() {
				for (let i = 1; i <= 6; i++) {
					const checkBtn = document.getElementById('checkBtn' + i);
					
					// Initialiser les tentatives
					if (!tableauxAttempts[i]) {
						tableauxAttempts[i] = 0;
					}
					
					// Vérifier si déjà résolu
					if (tableauxSolved.has(i)) {
						markTableauxAsSolved(i);
						continue;
					}
					
					// Ajouter écouteur pour le bouton
					checkBtn.addEventListener('click', function() {
						checkTableauxAnswer(i);
					});
					
					// Configuration navigation clavier
					const inputLetters = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
					for (let j = 0; j < inputLetters.length; j++) {
						const inputId = 'answer' + i + inputLetters[j];
						const input = document.getElementById(inputId);
						
						if (input) {
							input.addEventListener('keypress', function(e) {
								if (e.key === 'Enter') {
									if (j === inputLetters.length - 1) {
										checkTableauxAnswer(i);
									} else {
										// Chercher le prochain champ actif
										let nextIndex = j + 1;
										let nextInput;
										
										while (nextIndex < inputLetters.length) {
											nextInput = document.getElementById('answer' + i + inputLetters[nextIndex]);
											if (nextInput && !nextInput.disabled) break;
											nextIndex++;
										}
										
										if (nextInput && !nextInput.disabled) nextInput.focus();
									}
								}
							});
						}
					}
				}
			}
			
			// ========== VERIFICATION DES REPONSES ==========
			function checkTableauxAnswer(id) {
				if (tableauxSolved.has(id)) return;
				
				const resultDiv = document.getElementById('result' + id);
				const hintDiv = document.getElementById('hint' + id);
				const exerciseCard = document.querySelector('.exercise-card[data-exercise="' + id + '"]');
				
				// Marquer comme répondu
				tableauxAnswered.add(id);
				tableauxAttempts[id] = (tableauxAttempts[id] || 0) + 1;
				
				const inputLetters = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
				const xValues = [-3, -2, -1, 0, 1, 2, 3];
				const func = functionDefinitions[id];
				
				let allCorrect = true;
				let userAnswers = [];
				let correctAnswers = [];
				
				// Vérifier uniquement les champs non pré-remplis
				for (let i = 0; i < inputLetters.length; i++) {
					const inputId = 'answer' + id + inputLetters[i];
					const input = document.getElementById(inputId);
					
					if (input && !input.disabled) {
						const userValue = parseFloat(input.value.trim().replace(',', '.'));
						const correctValue = Math.round(func.calculate(xValues[i]) * 10) / 10;
						
						userAnswers.push(input.value);
						correctAnswers.push(correctValue.toString());
						
						// Vérification avec tolérance de 0.1
						if (Math.abs(userValue - correctValue) > 0.1) {
							allCorrect = false;
						}
					}
				}
				
				// Construire le message de résultat
				let userMessage = "";
				if (allCorrect) {
					userMessage = \`<span style="color:#155724; font-weight:bold;">✓ Correct ! Le tableau de valeurs pour \${func.formula} est bien complété.</span>\`;
				} else {
					userMessage = \`<span style='color:#721c24;'>✗ Incorrect. Vérifiez vos calculs pour \${func.formula}.</span>\`;
				}
				
				// Enregistrer l'interaction SCORM
				recordInteraction(id, userAnswers.join(','), allCorrect, correctAnswers.join(','));
				
				// Mettre à jour l'interface
				resultDiv.innerHTML = userMessage;
				resultDiv.className = "result " + (allCorrect ? "correct" : "incorrect");
				resultDiv.style.display = "block";
				
				if (allCorrect) {
					markTableauxAsSolved(id);
					hintDiv.style.display = "none";
					score++;
					updateScore();
					updateBadges();
					saveState();
				} else {
					hintDiv.style.display = "block";
					exerciseCard.classList.add('incorrect');
					
					// Gestion des tentatives multiples
					const maxAttempts = 2; // Configurable selon les paramètres
					if (tableauxAttempts[id] >= maxAttempts) {
						// Désactiver après max tentatives
						for (let i = 0; i < inputLetters.length; i++) {
							const input = document.getElementById('answer' + id + inputLetters[i]);
							if (input && !input.disabled) {
								input.disabled = true;
							}
						}
						document.getElementById('checkBtn' + id).disabled = true;
						
						// Afficher les bonnes réponses
						let correctValues = [];
						for (let i = 0; i < inputLetters.length; i++) {
							if (!prefilledCells[id].includes(i)) {
								const correctValue = Math.round(func.calculate(xValues[i]) * 10) / 10;
								const formattedValue = Number.isInteger(correctValue) 
									? correctValue.toString() 
									: correctValue.toString().replace('.', ',');
								correctValues.push(formattedValue);
							}
						}
						resultDiv.innerHTML = "Nombre de tentatives dépassé. Les réponses correctes sont : " + correctValues.join(', ');
					}
				}
				
				updateFinishButton();
				saveState();
			}
			
			// ========== FONCTIONS UTILITAIRES ==========
			function markTableauxAsSolved(id) {
				tableauxSolved.add(parseInt(id));
				
				const exerciseCard = document.querySelector('.exercise-card[data-exercise="' + id + '"]');
				exerciseCard.classList.add('solved');
				exerciseCard.classList.remove('incorrect');
				
				// Désactiver les entrées
				const inputLetters = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
				for (let i = 0; i < inputLetters.length; i++) {
					const input = document.getElementById('answer' + id + inputLetters[i]);
					if (input) input.disabled = true;
				}
				
				const checkBtn = document.getElementById('checkBtn' + id);
				if (checkBtn) checkBtn.disabled = true;
			}
			
			function shuffleArray(array) {
				for (let i = array.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[array[i], array[j]] = [array[j], array[i]];
				}
				return array;
			}
			
			// ========== FONCTIONS DE DESSIN (GRAPHIQUES) ==========
			function drawFunction(coords, func, color = '#1E90FF') {
				const { ctx, centerX, centerY, scaleX, scaleY, minX, maxX, width, height, padding } = coords;
				
				ctx.strokeStyle = color;
				ctx.lineWidth = 2;
				ctx.beginPath();
				
				let first = true;
				for (let x = minX; x <= maxX; x += 0.05) {
					const y = func(x);
					const px = centerX + x * scaleX;
					const py = centerY - y * scaleY;
					
					if (py >= padding && py <= height - padding) {
						if (first) {
							ctx.moveTo(px, py);
							first = false;
						} else {
							ctx.lineTo(px, py);
						}
					}
				}
				ctx.stroke();
			}
			
			function drawTablePoints(coords, xValues, func, color = '#ff0000') {
				for (let x of xValues) {
					const y = func(x);
					drawPoint(coords, x, y, color);
				}
			}
			
			function drawPoint(coords, x, y, color = '#1E90FF') {
				const { ctx, centerX, centerY, scaleX, scaleY, minX, maxX, minY, maxY } = coords;
				
				if (x < minX || x > maxX || y < minY || y > maxY) return;
				
				const px = centerX + x * scaleX;
				const py = centerY - y * scaleY;
				
				ctx.fillStyle = color;
				ctx.beginPath();
				ctx.arc(px, py, 5, 0, 2 * Math.PI);
				ctx.fill();
			}
			
			function drawCoordinateSystem(canvas, minX = -3, maxX = 3, minY = -10, maxY = 20) {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				const padding = 30;
				
				const scaleX = (width - 2 * padding) / (maxX - minX);
				const scaleY = (height - 2 * padding) / (maxY - minY);
				
				const centerX = padding + (-minX) * scaleX;
				const centerY = height - padding - (-minY) * scaleY;
				
				ctx.clearRect(0, 0, width, height);
				
				// Grille
				ctx.strokeStyle = '#e0e0e0';
				ctx.lineWidth = 1;
				
				for (let x = minX; x <= maxX; x += 1) {
					if (x === 0) continue;
					const px = padding + (x - minX) * scaleX;
					ctx.beginPath();
					ctx.moveTo(px, padding);
					ctx.lineTo(px, height - padding);
					ctx.stroke();
				}
				
				for (let y = minY; y <= maxY; y += 5) {
					if (y === 0) continue;
					const py = height - padding - (y - minY) * scaleY;
					ctx.beginPath();
					ctx.moveTo(padding, py);
					ctx.lineTo(width - padding, py);
					ctx.stroke();
				}
				
				// Axes
				ctx.strokeStyle = '#333';
				ctx.lineWidth = 2;
				
				// Axe X
				ctx.beginPath();
				ctx.moveTo(padding, centerY);
				ctx.lineTo(width - padding, centerY);
				ctx.stroke();
				
				// Axe Y
				ctx.beginPath();
				ctx.moveTo(centerX, padding);
				ctx.lineTo(centerX, height - padding);
				ctx.stroke();
				
				// Graduations
				ctx.fillStyle = '#333';
				ctx.font = '10px Arial';
				ctx.textAlign = 'center';
				ctx.textBaseline = 'middle';
				
				for (let x = minX; x <= maxX; x += 1) {
					const px = padding + (x - minX) * scaleX;
					ctx.fillText(x.toString(), px, centerY + 15);
				}
				
				ctx.textAlign = 'right';
				for (let y = minY; y <= maxY; y += 5) {
					if (y !== 0) {
						const py = height - padding - (y - minY) * scaleY;
						ctx.fillText(y.toString(), centerX - 5, py);
					}
				}
				
				return { 
					ctx, centerX, centerY, scaleX, scaleY, 
					minX, maxX, minY, maxY, padding, width, height
				};
			}`,
				
				code: `<div class="exercise-card" data-exercise="1">
				<h2>Exercice 1: Fonction f(x) = 2x + 1</h2>
				<p>Complétez le tableau de valeurs pour la fonction f(x) = 2x + 1</p>
				
				<div style="overflow-x: auto; margin-bottom: 15px;">
					<table class="value-table">
						<tr>
							<th>x</th>
							<th>-3</th>
							<th>-2</th>
							<th>-1</th>
							<th>0</th>
							<th>1</th>
							<th>2</th>
							<th>3</th>
						</tr>
						<tr>
							<td style="font-weight: bold;">f(x)</td>
							<td><input type="text" id="answer1a" class="table-input"></td>
							<td><input type="text" id="answer1b" class="table-input"></td>
							<td><input type="text" id="answer1c" class="table-input"></td>
							<td><input type="text" id="answer1d" class="table-input"></td>
							<td><input type="text" id="answer1e" class="table-input"></td>
							<td><input type="text" id="answer1f" class="table-input"></td>
							<td><input type="text" id="answer1g" class="table-input"></td>
						</tr>
					</table>
				</div>
				
				<canvas id="canvas1" width="400" height="300"></canvas>
				
				<button class="check-btn" id="checkBtn1">Vérifier ma réponse</button>
				<div class="result" id="result1"></div>
				<div class="hint" id="hint1">💡 Pour calculer f(x) = 2x + 1, multipliez x par 2 puis ajoutez 1.</div>
			</div>
			
			<!-- CSS spécifique aux tableaux de valeurs -->
			<style>
			.value-table {
				width: 100%;
				border-collapse: collapse;
				margin-bottom: 20px;
				overflow-x: auto;
			}
			
			.value-table th, .value-table td {
				border: 1px solid #ddd;
				padding: 8px;
				text-align: center;
			}
			
			.value-table th {
				background-color: #EFF7FF;
				font-weight: bold;
			}
			
			.table-input {
				width: 60px;
				text-align: center;
				padding: 4px;
				border: 1px solid #ddd;
				border-radius: 4px;
			}
			
			.table-input:disabled {
				background-color: #f9f9f9;
				border: 1px solid #eee;
				color: #555;
				font-weight: bold;
			}
			
			.value-table input:focus {
				outline: none;
				border-color: #1E90FF;
			}
			</style>`
			},
						
            


			geometrique: {
				title: "Suites Géométriques",
				description: "Un template pour créer des exercices interactifs sur les suites géométriques. L'apprenant peut explorer les propriétés des suites, calculer différents termes, raisons et sommes, et visualiser la croissance exponentielle.",
				features: [
					"Simulation interactive des suites géométriques",
					"Calcul du terme suivant ou d'un terme manquant",
					"Détermination de la raison d'une suite",
					"Calcul du rang d'un terme spécifique",
					"Calcul du terme de rang N",
					"Calcul de la somme des n premiers termes",
					"Applications aux problèmes de croissance"
				],
				icon: "fas fa-chart-line",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #6157ff;">Suites Géométriques</h3>
						
						<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-family: monospace;">
							<div style="font-weight: bold;">u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup> = 2 × 3<sup>n-1</sup></div>
						</div>
						
						<div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
							<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 8px; font-weight: bold;">2</div>
							<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 8px; font-weight: bold;">6</div>
							<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 8px; font-weight: bold;">18</div>
							<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 8px; font-weight: bold;">54</div>
						</div>
						
						<div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
							<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; flex-grow: 1;">
								<div style="color: #666; font-size: 0.9em;">Premier terme</div>
								<div style="font-weight: bold; font-size: 1.5em;">2</div>
							</div>
							<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; flex-grow: 1;">
								<div style="color: #666; font-size: 0.9em;">Raison</div>
								<div style="font-weight: bold; font-size: 1.5em;">3</div>
							</div>
							<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; flex-grow: 1;">
								<div style="color: #666; font-size: 0.9em;">u₈</div>
								<div style="font-weight: bold; font-size: 1.5em;">4374</div>
							</div>
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE SUITES GEOMETRIQUES : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation des variables globales
				let currentSequence = [];
				let currentFirstTerm = 2;
				let currentReason = 3;
				let termCount = 6;  // Maximum 6 termes pour éviter des valeurs trop grandes
				let missingIndex = null;
				let specialTermRank = 8;
				let specialTermValue = 0;
				let score = 0;
				let solved = new Set();
				let allExercisesCompleted = false;
				const totalExercises = 7; // Incluant l'exercice pour calculer le terme de rang N
				let currentHighlight = '';
				let activeExercise = null;
				let exerciseAnswers = {
					1: null, // Terme suivant
					2: null, // Terme manquant
					3: null, // Raison
					4: null, // Rang d'un terme
					5: null, // Terme de rang N
					6: null, // Somme des n premiers termes
					7: null  // Problème appliqué
				};
				
				// Initialisation de la séquence
				function initSequence() {
					// Créer la séquence complète
					currentSequence = [];
					for (let i = 0; i < termCount; i++) {
						const term = currentFirstTerm * Math.pow(currentReason, i);
						currentSequence.push(term);
					}
					
					// Calcul du terme spécial (u8 par défaut)
					specialTermValue = currentFirstTerm * Math.pow(currentReason, specialTermRank - 1);
					
					// Mise à jour de l'affichage
					displaySequence();
					updateStats();
				}
				
				// Générer une séquence aléatoire
				function generateRandomSequence() {
					resetActiveExercise();
					
					// Premier terme entre 1 et 10
					currentFirstTerm = Math.floor(Math.random() * 10) + 1;
					
					// Raison entre 0.5 et 3 (non nulle, pas trop grande pour éviter l'explosion des valeurs)
					const reasonOptions = [0.5, 0.75, 1.5, 2, 2.5, 3];
					currentReason = reasonOptions[Math.floor(Math.random() * reasonOptions.length)];
					
					// Nombre de termes limité à 6
					termCount = Math.floor(Math.random() * 3) + 4; // Entre 4 et 6
					
					// Réinitialiser le terme manquant
					missingIndex = null;
					
					// Initialiser la séquence
					initSequence();
					
					// Mettre à jour les données des exercices
					updateExerciseData();
				}
				
				// Afficher la séquence
				function displaySequence() {
					const sequenceDisplay = document.getElementById('sequenceDisplay');
					const formulaDisplay = document.getElementById('formulaDisplay');
					
					// Vider l'affichage
					sequenceDisplay.innerHTML = '';
					
					// Afficher chaque terme
					for (let i = 0; i < termCount; i++) {
						const term = currentSequence[i];
						const numberBox = document.createElement('div');
						numberBox.className = 'number-box';
						
						// Si c'est un terme manquant
						if (i === missingIndex) {
							numberBox.textContent = '?';
							numberBox.classList.add('missing');
						} else {
							// Afficher les nombres arrondis s'ils sont grands ou décimaux
							if (Number.isInteger(term) && term < 10000) {
								numberBox.textContent = term;
							} else {
								numberBox.textContent = term.toFixed(1);
							}
						}
						
						numberBox.title = "u" + (i+1) + " = " + term;
						sequenceDisplay.appendChild(numberBox);
					}
					
					// Mettre à jour la formule
					formulaDisplay.innerHTML = "u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup> = " + currentFirstTerm + " × " + currentReason + "<sup>n-1</sup>";
				}
				
				// Mettre à jour les statistiques
				function updateStats() {
					document.getElementById('firstTerm').textContent = currentFirstTerm;
					document.getElementById('reason').textContent = currentReason;
					document.getElementById('termCount').textContent = termCount;
					document.getElementById('specialTerm').textContent = '?';
				}
				
				// Mettre en évidence le motif (animation des termes)
				function highlightPattern() {
					const boxes = document.querySelectorAll('.number-box');
					
					// Retirer les highlights précédents
					boxes.forEach(box => box.classList.remove('highlight'));
					
					// Animation séquentielle
					boxes.forEach((box, index) => {
						setTimeout(() => {
							box.classList.add('highlight');
							
							// Retirer après un délai
							setTimeout(() => {
								box.classList.remove('highlight');
							}, 800);
						}, index * 300);
					});
				}
				
				// Créer un terme manquant
				function showMissingTerm() {
					// Sélectionner un index aléatoire (pas le premier)
					missingIndex = Math.floor(Math.random() * (termCount - 1)) + 1;
					
					// Réafficher la séquence
					displaySequence();
					
					// Mettre à jour les données de l'exercice 2
					updateExerciseData();
				}
				
				// Calculer un terme spécial (u8 par défaut)
				function calculateSpecialTerm() {
					// Animation du point d'interrogation pour indiquer que c'est une valeur à calculer
					const specialTermEl = document.getElementById('specialTerm');
					specialTermEl.style.transition = 'all 0.3s ease';
					specialTermEl.style.transform = 'scale(1.2)';
					specialTermEl.style.color = '#4361ee';
					
					// Calculer et afficher le terme spécial
					specialTermValue = currentFirstTerm * Math.pow(currentReason, specialTermRank - 1);
					
					// Formater le résultat
					if (Number.isInteger(specialTermValue) && specialTermValue < 10000) {
						specialTermEl.textContent = specialTermValue;
					} else {
						specialTermEl.textContent = specialTermValue.toFixed(1);
					}
					
					// Remettre à la normale après animation
					setTimeout(() => {
						specialTermEl.style.transform = 'scale(1)';
						specialTermEl.style.color = 'var(--dark)';
					}, 1000);
					
					// Générer un exercice pour le calcul de ce terme spécial
					generateSequenceForNthTermCalculation();
				}
				
				// Réinitialiser l'exercice actif
				function resetActiveExercise() {
					// Supprimer la classe active de l'exercice précédent
					if (activeExercise) {
						document.querySelector(".exercise-card[data-exercise='" + activeExercise + "']").classList.remove('active-exercise');
					}
					activeExercise = null;
				}
				
				// Définir un exercice comme actif
				function setActiveExercise(exerciseNum) {
					resetActiveExercise();
					
					// Ajouter la classe active au nouvel exercice
					const exerciseCard = document.querySelector(".exercise-card[data-exercise='" + exerciseNum + "']");
					if (exerciseCard) {
						exerciseCard.classList.add('active-exercise');
						activeExercise = exerciseNum;
						
						// Faire défiler jusqu'à la simulation
						document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
					}
				}
				
				// =====================================================================
				## ⚠️ PRIORITÉS HAUTE : N UTILISER QUE LES THEMES D EXERCICES ACTIVÉS 
				// =====================================================================

				
				// Type 1: Générer une suite pour l'exercice du terme suivant
				function generateSequenceForNextTerm() {
					setActiveExercise(1);
					
					// Générer une suite avec des valeurs simples
					currentFirstTerm = Math.floor(Math.random() * 5) + 1; // Entre 1 et 5
					currentReason = Math.floor(Math.random() * 3) + 2; // Entre 2 et 4
					termCount = 5; // Suite assez courte pour éviter des valeurs trop grandes
					missingIndex = null;
					
					// Initialiser la séquence
					initSequence();
					
					// Calculer la réponse correcte (terme suivant)
					exerciseAnswers[1] = currentSequence[termCount-1] * currentReason;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex1').innerHTML = 
						"Premier terme (u₁): " + currentFirstTerm + "<br>" +
						"Raison (q): " + currentReason + "<br>" +
						"Dernier terme affiché: " + currentSequence[termCount-1];
					
					// Animer le dernier terme pour indiquer qu'il faut trouver le suivant
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						const lastBox = boxes[boxes.length - 1];
						lastBox.classList.add('highlight');
						setTimeout(() => {
							lastBox.classList.remove('highlight');
						}, 1500);
					}, 500);
				}
				
				// Type 2: Générer une suite pour l'exercice du terme manquant
				function generateSequenceForMissingTerm() {
					setActiveExercise(2);
					
					// Générer une suite simple pour faciliter le calcul du terme manquant
					currentFirstTerm = Math.floor(Math.random() * 3) + 1; // Entre 1 et 3
					currentReason = Math.floor(Math.random() * 3) + 2; // Entre 2 et 4
					termCount = 6;
					
					// Créer un terme manquant (pas le premier ni le dernier)
					missingIndex = Math.floor(Math.random() * (termCount - 2)) + 1;
					
					// Initialiser la séquence
					initSequence();
					
					// Calculer la réponse correcte (terme manquant)
					exerciseAnswers[2] = currentFirstTerm * Math.pow(currentReason, missingIndex);
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex2').innerHTML = 
						"Premier terme (u₁): " + currentFirstTerm + "<br>" +
						"Raison (q): " + currentReason + "<br>" +
						"Position du terme manquant: " + (missingIndex + 1);
					
					// Animer le terme manquant
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						const missingBox = boxes[missingIndex];
						missingBox.classList.add('highlight');
						setTimeout(() => {
							missingBox.classList.remove('highlight');
						}, 1500);
					}, 500);
				}
				
				// Type 3: Générer une suite pour l'exercice de calcul de la raison
				function generateSequenceForReasonCalculation() {
					setActiveExercise(3);
					
					// Générer une suite avec une raison simple
					currentFirstTerm = Math.floor(Math.random() * 5) + 1; // Entre 1 et 5
					
					// Raisons plus variées mais calculables facilement
					const reasonOptions = [1.5, 2, 2.5, 3, 4];
					currentReason = reasonOptions[Math.floor(Math.random() * reasonOptions.length)];
					
					termCount = 5;
					missingIndex = null;
					
					// Initialiser la séquence
					initSequence();
					
					// La réponse est la raison elle-même
					exerciseAnswers[3] = currentReason;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex3').innerHTML = 
						"Premier terme (u₁): " + currentFirstTerm + "<br>" +
						"Rapport entre termes consécutifs: ?";
					
					// Animer les termes pour montrer le rapport
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						
						// Animer séquentiellement les paires de termes
						for (let i = 0; i < boxes.length - 1; i++) {
							setTimeout(() => {
								boxes[i].classList.add('highlight');
								boxes[i+1].classList.add('highlight');
								
								setTimeout(() => {
									boxes[i].classList.remove('highlight');
									boxes[i+1].classList.remove('highlight');
								}, 1000);
							}, i * 1200);
						}
					}, 500);
				}
				
				// Type 4: Générer une suite pour l'exercice de calcul du rang
				function generateSequenceForRankCalculation() {
					setActiveExercise(4);
					
					// Générer une suite avec des valeurs simples
					currentFirstTerm = Math.floor(Math.random() * 3) + 1; // Entre 1 et 3
					
					// Raison entière pour simplifier le calcul du rang
					currentReason = Math.floor(Math.random() * 2) + 2; // 2 ou 3
					
					termCount = 5;
					missingIndex = null;
					
					// Calculer un terme spécial à un rang calculable simplement
					let targetRank = Math.floor(Math.random() * 5) + 7; // Entre 7 et 11
					let targetValue = currentFirstTerm * Math.pow(currentReason, targetRank - 1);
					
					// Initialiser la séquence
					initSequence();
					
					// Mettre à jour la valeur cible dans la question
					document.getElementById('rankTerm').textContent = targetValue;
					
					// La réponse est le rang calculé
					exerciseAnswers[4] = targetRank;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex4').innerHTML = 
						"u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup><br>" +
						"On cherche n tel que u<sub>n</sub> = " + targetValue + "<br>" +
						"Donc : " + targetValue + " = " + currentFirstTerm + " × " + currentReason + "<sup>n-1</sup>";
					
					// Mettre à jour le terme spécial
					specialTermRank = targetRank;
					specialTermValue = targetValue;
					
					// Animation sur la carte de statistiques
					setTimeout(() => {
						const specialTermEl = document.getElementById('specialTerm');
						specialTermEl.textContent = targetValue;
						specialTermEl.style.transition = 'all 0.3s ease';
						specialTermEl.style.transform = 'scale(1.2)';
						specialTermEl.style.color = '#4361ee';
						
						setTimeout(() => {
							specialTermEl.style.transform = 'scale(1)';
							specialTermEl.style.color = 'var(--dark)';
						}, 1000);
					}, 500);
				}
				
				// Type 5: Générer une suite pour l'exercice du calcul du terme de rang N
				function generateSequenceForNthTermCalculation() {
					setActiveExercise(5);
					
					// Générer une suite
					currentFirstTerm = Math.floor(Math.random() * 5) + 1; // Entre 1 et 5
					currentReason = Math.floor(Math.random() * 3) + 2; // Entre 2 et 4
					termCount = 5;
					missingIndex = null;
					
					// Choisir un rang à calculer (entre 10 et 15 pour que ce soit un peu difficile)
					let targetRank = Math.floor(Math.random() * 6) + 10; // Entre 10 et 15
					
					// Initialiser la séquence
					initSequence();
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex5').innerHTML = 
						"Premier terme (u₁): " + currentFirstTerm + "<br>" +
						"Raison (q): " + currentReason + "<br>" +
						"Rang à calculer: " + targetRank;
					
					// Calculer la réponse (terme de rang N)
					const correctAnswer = currentFirstTerm * Math.pow(currentReason, targetRank - 1);
					exerciseAnswers[5] = correctAnswer;
					
					// Mettre à jour le rang cible dans l'affichage
					document.getElementById('targetRank').textContent = targetRank;
					document.getElementById('targetRankLabel').textContent = targetRank;
					
					// Animer la formule pour attirer l'attention
					setTimeout(() => {
						const formulaDiv = document.getElementById('formulaDisplay');
						if (formulaDiv) {
							formulaDiv.style.transition = 'all 0.3s ease';
							formulaDiv.style.transform = 'scale(1.05)';
							formulaDiv.style.boxShadow = '0 0 10px rgba(67, 97, 238, 0.5)';
							
							setTimeout(() => {
								formulaDiv.style.transform = 'scale(1)';
								formulaDiv.style.boxShadow = 'none';
							}, 1000);
						}
					}, 500);
				}
				
				// Type 6: Générer une suite pour l'exercice de calcul de la somme
				function generateSequenceForSumCalculation() {
					setActiveExercise(6);
					
					// Générer une suite avec des valeurs simples pour faciliter la somme
					currentFirstTerm = Math.floor(Math.random() * 3) + 1; // Entre 1 et 3
					currentReason = Math.floor(Math.random() * 2) + 2; // 2 ou 3
					termCount = 5;
					missingIndex = null;
					
					// Nombre de termes à sommer
					const sumCount = Math.floor(Math.random() * 3) + 6; // Entre 6 et 8
					document.getElementById('sumCount').textContent = sumCount;
					
					// Initialiser la séquence
					initSequence();
					
					// Calculer la somme (formule: u1 * (1-q^n)/(1-q) si q≠1)
					const qPowerN = Math.pow(currentReason, sumCount);
					exerciseAnswers[6] = currentFirstTerm * (1 - qPowerN) / (1 - currentReason);
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex6').innerHTML = 
						"S<sub>n</sub> = u<sub>1</sub> × (1 - q<sup>n</sup>) / (1 - q) si q ≠ 1<br>" +
						"Pour cette suite: u<sub>1</sub> = " + currentFirstTerm + ", q = " + currentReason + ", n = " + sumCount + "<br>" +
						"S<sub>" + sumCount + "</sub> = " + currentFirstTerm + " × (1 - " + currentReason + "<sup>" + sumCount + "</sup>) / (1 - " + currentReason + ")";
					
					// Animer tous les termes pour montrer qu'il faut les sommer
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						
						boxes.forEach((box, index) => {
							setTimeout(() => {
								box.classList.add('highlight');
								
								setTimeout(() => {
									box.classList.remove('highlight');
								}, 700);
							}, index * 200);
						});
					}, 500);
				}
				
				// Type 7: Générer une suite pour l'exercice de problème appliqué
				function generateSequenceForApplicationProblem() {
					setActiveExercise(7);
					
					// Paramètres du problème
					const initialProduction = Math.floor(Math.random() * 900) + 100; // Entre 100 et 1000
					const percentIncrease = Math.floor(Math.random() * 30) + 10; // Entre 10% et 40%
					const targetYear = Math.floor(Math.random() * 4) + 4; // Entre 4 et 7
					
					// Mettre à jour le texte du problème
					document.getElementById('problem1').textContent = initialProduction;
					document.getElementById('problem2').textContent = percentIncrease;
					document.getElementById('problem3').textContent = targetYear;
					
					// Calculer la raison (1 + pourcentage d'augmentation)
					const reason = 1 + (percentIncrease / 100);
					
					// Calculer la réponse (production de l'année cible)
					exerciseAnswers[7] = Math.round(initialProduction * Math.pow(reason, targetYear - 1));
					
					// Mise à jour de la suite géométrique pour représenter ce problème
					currentFirstTerm = initialProduction;
					currentReason = reason;
					termCount = Math.min(targetYear, 6); // Limiter à 6 termes ou l'année cible
					
					// Initialiser la séquence pour visualiser le problème
					initSequence();
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex7').innerHTML = 
						"On peut modéliser la production par une suite géométrique où:<br>" +
						"- u<sub>1</sub> = " + initialProduction + " (production initiale)<br>" +
						"- La raison q = " + reason.toFixed(2) + " (augmentation de " + percentIncrease + "% par an, donc ×" + reason.toFixed(2) + ")<br>" +
						"- On cherche u<sub>" + targetYear + "</sub> (production de la " + targetYear + "ème année)";
				}
				
				// Mise à jour des données des exercices
				function updateExerciseData() {
					// Les mises à jour spécifiques à chaque exercice...
					// [Code similaire à ce qui est dans le template arithmétique]
					
					// Pour éviter trop de code répétitif, nous nous concentrons sur la fonction de vérification
				}
			
				// VÉRIFICATION DES RÉPONSES
				
				// Fonction principale pour vérifier une réponse
				function checkAnswer(exerciseNum) {
					const userAnswer = parseFloat(document.getElementById("answer" + exerciseNum).value);
					const resultDiv = document.getElementById("result" + exerciseNum);
					const hintDiv = document.getElementById("hint" + exerciseNum);
					
					if (isNaN(userAnswer)) {
						resultDiv.textContent = "⚠️ Veuillez entrer un nombre valide";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Vérifier si une suite a été générée pour cet exercice
					if (exerciseAnswers[exerciseNum] === null) {
						resultDiv.textContent = "⚠️ Veuillez d'abord créer une suite pour cet exercice";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Obtenir la réponse correcte
					const correctAnswer = exerciseAnswers[exerciseNum];
					let explanation = "";
					
					// Préparer l'explication selon le type d'exercice
					switch(parseInt(exerciseNum)) {
						case 1: // Terme suivant
							explanation = "Le terme suivant est u<sub>" + (termCount+1) + "</sub> = u<sub>" + termCount + "</sub> × q = " + currentSequence[termCount-1] + " × " + currentReason + " = " + correctAnswer;
							break;
							
						case 2: // Terme manquant
							explanation = "Le terme manquant est u<sub>" + (missingIndex+1) + "</sub> = u<sub>1</sub> × q<sup>" + missingIndex + "</sup> = " + currentFirstTerm + " × " + currentReason + "<sup>" + missingIndex + "</sup> = " + correctAnswer;
							break;
							
						case 3: // Calcul de la raison
							explanation = "La raison est q = u<sub>n+1</sub> / u<sub>n</sub> = " + currentSequence[1] + " / " + currentSequence[0] + " = " + correctAnswer;
							break;
							
						case 4: // Calcul du rang
							const rankTerm = parseFloat(document.getElementById('rankTerm').textContent);
							explanation = "Pour trouver n: " + rankTerm + " = " + currentFirstTerm + " × " + currentReason + "<sup>n-1</sup>" +
										  "<br>" + rankTerm + " / " + currentFirstTerm + " = " + currentReason + "<sup>n-1</sup>" +
										  "<br>" + (rankTerm / currentFirstTerm).toFixed(2) + " = " + currentReason + "<sup>n-1</sup>" +
										  "<br>log<sub>" + currentReason + "</sub>(" + (rankTerm / currentFirstTerm).toFixed(2) + ") = n-1" +
										  "<br>n = 1 + log<sub>" + currentReason + "</sub>(" + (rankTerm / currentFirstTerm).toFixed(2) + ")" +
										  "<br>n = " + correctAnswer;
							break;
							
						case 5: // Calcul du terme de rang N
							const targetRank = parseInt(document.getElementById('targetRank').textContent);
							explanation = "Le terme de rang " + targetRank + " est u<sub>" + targetRank + "</sub> = u<sub>1</sub> × q<sup>" + (targetRank-1) + "</sup> = " + currentFirstTerm + " × " + currentReason + "<sup>" + (targetRank-1) + "</sup> = " + currentFirstTerm + " × " + Math.pow(currentReason, targetRank-1).toFixed(2) + " = " + correctAnswer.toFixed(2);
							break;
							
						case 6: // Somme des termes
							const sumCount = parseInt(document.getElementById('sumCount').textContent);
							explanation = "S<sub>" + sumCount + "</sub> = " + currentFirstTerm + " × (1 - " + currentReason + "<sup>" + sumCount + "</sup>) / (1 - " + currentReason + ")" +
										 "<br>S<sub>" + sumCount + "</sub> = " + currentFirstTerm + " × (1 - " + Math.pow(currentReason, sumCount).toFixed(2) + ") / " + (1 - currentReason).toFixed(2) +
										 "<br>S<sub>" + sumCount + "</sub> = " + correctAnswer.toFixed(2);
							break;
							
						case 7: // Problème appliqué
							const initialProduction = parseInt(document.getElementById('problem1').textContent);
							const percentIncrease = parseInt(document.getElementById('problem2').textContent);
							const targetYear = parseInt(document.getElementById('problem3').textContent);
							const reason = 1 + (percentIncrease / 100);
							
							explanation = "On utilise la formule u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup>" +
										 "<br>La raison q = 1 + " + percentIncrease + "% = " + reason.toFixed(2) +
										 "<br>u<sub>" + targetYear + "</sub> = " + initialProduction + " × " + reason.toFixed(2) + "<sup>" + (targetYear-1) + "</sup>" +
										 "<br>u<sub>" + targetYear + "</sub> = " + initialProduction + " × " + Math.pow(reason, targetYear-1).toFixed(4) +
										 "<br>u<sub>" + targetYear + "</sub> = " + correctAnswer;
							break;
					}
					
					// Vérifier la réponse avec une tolérance
					const tolerance = 0.1; // Plus de tolérance pour les suites géométriques qui peuvent avoir des valeurs décimales
					const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
					
					if (isCorrect) {
						resultDiv.innerHTML = "✓ Correct! " + explanation;
						resultDiv.className = "result correct show";
						hintDiv.style.display = "none";
						
						// Mettre à jour le score et marquer comme résolu si pas déjà fait
						if (!solved.has(exerciseNum)) {
							solved.add(exerciseNum);
							score++;
							document.getElementById('score').textContent = score;
							
							// Marquer visuellement comme résolu
							const exerciseCard = document.querySelector(".exercise-card[data-exercise='" + exerciseNum + "']");
							if (exerciseCard) {
								exerciseCard.classList.add('solved');
							}
							
							// Vérifier si tous les exercices sont complétés
							if (solved.size >= totalExercises) {
								allExercisesCompleted = true;
								const finishBtn = document.getElementById('finishBtn');
								if (finishBtn) {
									finishBtn.classList.add('pulse-animation');
								}
							}
						}
						
						// Désactiver les contrôles
						document.getElementById("answer" + exerciseNum).disabled = true;
						const checkBtn = document.querySelector(".exercise-card[data-exercise='" + exerciseNum + "'] .check-btn");
						if (checkBtn) {
							checkBtn.disabled = true;
						}
					} else {
						resultDiv.textContent = "✗ Incorrect. Essayez encore!";
						resultDiv.className = "result incorrect show";
						hintDiv.style.display = "block";
					}
				}
				
				// Fonction pour terminer le test
				function finishTest() {
					// Vérifier si au moins une question est répondue
					if (solved.size === 0) {
						alert("Vous devez répondre à au moins une question avant de terminer l'activité.");
						return;
					}
					
					// Afficher le message de fin
					alert("Activité terminée! Votre score final est de " + score + "/" + totalExercises + ".");
					
					// Désactiver tous les inputs et boutons
					document.querySelectorAll('input, .check-btn, .finish-btn, .question-specific-btn').forEach(el => {
						el.disabled = true;
					});
					
					// Ajouter un message de félicitations
					if (score === totalExercises) {
						const container = document.querySelector('.container');
						if (container) {
							const completionMsg = document.createElement('div');
							completionMsg.className = 'completion-message';
							completionMsg.innerHTML = '<div>🎉 Félicitations! Vous avez terminé tous les exercices avec un score parfait! 🎉</div>';
							container.appendChild(completionMsg);
						}
					}
				}
				
				// Exposer les fonctions nécessaires au niveau global pour être utilisées dans le HTML
				window.generateRandomSequence = generateRandomSequence;
				window.highlightPattern = highlightPattern;
				window.showMissingTerm = showMissingTerm;
				window.calculateSpecialTerm = calculateSpecialTerm;
				window.generateSequenceForNextTerm = generateSequenceForNextTerm;
				window.generateSequenceForMissingTerm = generateSequenceForMissingTerm;
				window.generateSequenceForReasonCalculation = generateSequenceForReasonCalculation;
				window.generateSequenceForRankCalculation = generateSequenceForRankCalculation;
				window.generateSequenceForNthTermCalculation = generateSequenceForNthTermCalculation;
				window.generateSequenceForSumCalculation = generateSequenceForSumCalculation;
				window.generateSequenceForApplicationProblem = generateSequenceForApplicationProblem;
				window.checkAnswer = checkAnswer;
				window.finishTest = finishTest;
				
				// Initialiser la séquence au chargement
				initSequence();
				
				// Permettre la validation avec Enter pour tous les champs de réponse
				document.querySelectorAll('input[type="number"]').forEach((input) => {
					input.addEventListener('keypress', function(e) {
						if (e.key === 'Enter') {
							const exerciseId = this.id.replace('answer', '');
							checkAnswer(exerciseId);
						}
					});
				});
			});`,
				
				code: `<!-- Structure principale du template de suites géométriques -->
			<div class="card">
			  <h2 style="text-align: center; margin-bottom: 20px;">Simulation de Suite Géométrique</h2>
			  
			  <!-- Simulation de suite géométrique -->
			  <div class="sequence-container">
				<div class="formula-display" id="formulaDisplay">
				  u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup> = 2 × 3<sup>n-1</sup>
				</div>
				
				<div class="sequence-display" id="sequenceDisplay">
				  <div class="number-box">2</div>
				  <div class="number-box">6</div>
				  <div class="number-box">18</div>
				  <div class="number-box">54</div>
				  <div class="number-box">162</div>
				  <div class="number-box">486</div>
				</div>
			  </div>
			
			  <div class="sequence-info">
				<div class="stat-card card1">
				  <div class="stat-label">Premier terme (u₁)</div>
				  <div class="stat-value" id="firstTerm">2</div>
				</div>
				<div class="stat-card card2">
				  <div class="stat-label">Raison (q)</div>
				  <div class="stat-value" id="reason">3</div>
				</div>
				<div class="stat-card card3">
				  <div class="stat-label">Nombre de termes</div>
				  <div class="stat-value" id="termCount">6</div>
				</div>
				<div class="stat-card card4">
				  <div class="stat-label">Terme spécial (u₈)</div>
				  <div class="stat-value" id="specialTerm">?</div>
				</div>
			  </div>
			
			  <div class="btn-group">
				<button id="btnRandom" onclick="generateRandomSequence()">Générer aléatoirement</button>
				<button id="btnHighlightPattern" onclick="highlightPattern()">Mettre en évidence le motif</button>
				<button id="btnShowMissing" onclick="showMissingTerm()">Terme manquant</button>
				<button id="btnCalculateSpecial" onclick="calculateSpecialTerm()">Calculer u₈</button>
			  </div>
			</div>
			
			<div class="exercises">
			  <!-- Exercice 1: Calcul du terme suivant -->
			  <div class="exercise-card" data-exercise="1">
				<div class="material-header">
				  <span>Exercice 1</span>
				</div>
				
				<div class="question-text">
				  Calculer le terme suivant de la suite géométrique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForNextTerm()">Créer une suite pour cet exercice</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données actuelles:</div>
				  <div id="stats-ex1">
					Premier terme (u₁): 2<br>
					Raison (q): 3<br>
					Dernier terme affiché: 486
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Terme suivant:</label>
				  <input type="number" id="answer1" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(1)">Vérifier</button>
				  <div class="result" id="result1"></div>
				  <div class="hint" id="hint1">Indice: Dans une suite géométrique, on multiplie par la raison q pour passer d'un terme au suivant.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 2: Calcul d'un terme manquant -->
			  <div class="exercise-card" data-exercise="2">
				<div class="material-header">
				  <span>Exercice 2</span>
				</div>
				
				<div class="question-text">
				  Calculer le terme manquant de la suite géométrique.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForMissingTerm()">Créer une suite avec terme manquant</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données pour le calcul:</div>
				  <div id="stats-ex2">
					Premier terme (u₁): 2<br>
					Raison (q): 3<br>
					Position du terme manquant: ?
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Terme manquant:</label>
				  <input type="number" id="answer2" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(2)">Vérifier</button>
				  <div class="result" id="result2"></div>
				  <div class="hint" id="hint2">Indice: Identifiez la position du terme manquant puis utilisez la formule générale u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup>.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 3: Calcul de la raison -->
			  <div class="exercise-card" data-exercise="3">
				<div class="material-header">
				  <span>Exercice 3</span>
				</div>
				
				<div class="question-text">
				  Déterminer la raison q de la suite géométrique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForReasonCalculation()">Créer une suite pour calculer la raison</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données de la suite:</div>
				  <div id="stats-ex3">
					Premier terme (u₁): 2<br>
					Rapport entre termes consécutifs: ?
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Raison (q):</label>
				  <input type="number" id="answer3" placeholder="Entrez votre réponse" step="0.01">
				  <button class="check-btn" onclick="checkAnswer(3)">Vérifier</button>
				  <div class="result" id="result3"></div>
				  <div class="hint" id="hint3">Indice: La raison est le quotient constant entre deux termes consécutifs: q = u<sub>n+1</sub> / u<sub>n</sub>.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 4: Calcul du rang d'un terme -->
			  <div class="exercise-card" data-exercise="4">
				<div class="material-header">
				  <span>Exercice 4</span>
				</div>
				
				<div class="question-text">
				  Déterminer le rang n du terme u<sub>n</sub> = <span id="rankTerm">1458</span> dans la suite géométrique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForRankCalculation()">Créer une suite pour cet exercice</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Formule à utiliser:</div>
				  <div id="stats-ex4">
					u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup><br>
					On cherche n tel que u<sub>n</sub> = <span>1458</span><br>
					Donc : <span>1458</span> = <span>2</span> × <span>3</span><sup>n-1</sup>
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Rang n:</label>
				  <input type="number" id="answer4" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(4)">Vérifier</button>
				  <div class="result" id="result4"></div>
				  <div class="hint" id="hint4">Indice: Isolez n dans l'équation en utilisant les logarithmes: log(u<sub>n</sub>/u<sub>1</sub>) = (n-1) × log(q).</div>
				</div>
			  </div>
			  
			  <!-- Exercice 5: Calcul du terme de rang N -->
			  <div class="exercise-card" data-exercise="5">
				<div class="material-header">
				  <span>Exercice 5</span>
				</div>
				
				<div class="question-text">
				  Calculer le terme de rang <span id="targetRank">12</span> de la suite géométrique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForNthTermCalculation()">Créer une suite pour cet exercice</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Formule à utiliser:</div>
				  <div id="stats-ex5">
					Premier terme (u₁): 2<br>
					Raison (q): 3<br>
					Rang à calculer: 12
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Terme u<sub><span id="targetRankLabel">12</span></sub>:</label>
				  <input type="number" id="answer5" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(5)">Vérifier</button>
				  <div class="result" id="result5"></div>
				  <div class="hint" id="hint5">Indice: Utilisez la formule u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup> en remplaçant n par le rang cible.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 6: Calcul de la somme des n premiers termes -->
			  <div class="exercise-card" data-exercise="6">
				<div class="material-header">
				  <span>Exercice 6</span>
				</div>
				
				<div class="question-text">
				  Calculer la somme des <span id="sumCount">8</span> premiers termes de la suite géométrique.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForSumCalculation()">Créer une suite pour calculer la somme</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Formule de la somme:</div>
				  <div id="stats-ex6">
					S<sub>n</sub> = u<sub>1</sub> × (1 - q<sup>n</sup>) / (1 - q) si q ≠ 1<br>
					Pour cette suite: u<sub>1</sub> = <span>2</span>, q = <span>3</span>, n = <span>8</span><br>
					S<sub>8</sub> = <span>2</span> × (1 - <span>3</span><sup>8</sup>) / (1 - <span>3</span>)
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Somme:</label>
				  <input type="number" id="answer6" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(6)">Vérifier</button>
				  <div class="result" id="result6"></div>
				  <div class="hint" id="hint6">Indice: Utilisez la formule S<sub>n</sub> = u<sub>1</sub> × (1 - q<sup>n</sup>) / (1 - q) après avoir calculé q<sup>n</sup>.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 7: Problème appliqué -->
			  <div class="exercise-card" data-exercise="7">
				<div class="material-header">
				  <span>Exercice 7</span>
				</div>
				
				<div class="question-text">
				  Une entreprise produit <span id="problem1">1000</span> objets la première année. Sa production augmente de <span id="problem2">20</span>% chaque année.
				  Quelle sera sa production la <span id="problem3">5</span>ème année?
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForApplicationProblem()">Créer un problème de croissance</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Approche par suite géométrique:</div>
				  <div id="stats-ex7">
					On peut modéliser la production par une suite géométrique où:<br>
					- u<sub>1</sub> = 1000 (production initiale)<br>
					- La raison q = 1.2 (augmentation de 20% par an, donc ×1.2)<br>
					- On cherche u<sub>5</sub> (production de la 5ème année)
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Production de la 5ème année:</label>
				  <input type="number" id="answer7" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(7)">Vérifier</button>
				  <div class="result" id="result7"></div>
				  <div class="hint" id="hint7">Indice: Utilisez la formule u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup> avec u<sub>1</sub> = 1000 et q = 1.2.</div>
				</div>
			  </div>
			</div>`,
			
				cssCode: `/* Variables de couleurs et de style */
			
			/* Styles pour la suite géométrique */
			.sequence-container {
			  width: 100%;
			  margin: 20px 0;
			  text-align: center;
			}
			
			.sequence-display {
			  display: flex;
			  justify-content: center;
			  align-items: center;
			  flex-wrap: wrap;
			  gap: 10px;
			  margin: 20px 0;
			}
			
			.number-box {
			  width: 70px;
			  height: 70px;
			  display: flex;
			  align-items: center;
			  justify-content: center;
			  background-color: white;
			  border: 2px solid var(--primary);
			  border-radius: 8px;
			  font-size: 1.3rem;
			  font-weight: bold;
			  box-shadow: var(--shadow);
			  transition: all 0.3s ease;
			}
			
			.number-box.highlight {
			  transform: scale(1.1);
			  background-color: #ffeb3b;
			  border-color: #ffc107;
			  box-shadow: 0 0 10px rgba(255, 235, 59, 0.7);
			  font-weight: bold;
			}
			
			.number-box.missing {
			  border-style: dashed;
			  color: #aaa;
			}
			
			.formula-display {
			  background-color: #f0f7ff;
			  padding: 15px;
			  border-radius: 8px;
			  margin: 20px auto;
			  max-width: 80%;
			  text-align: center;
			  font-family: "Times New Roman", Times, serif;
			  font-size: 1.3rem;
			  box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
			}
			
			.sequence-info {
			  display: flex;
			  justify-content: space-around;
			  flex-wrap: wrap;
			  gap: 20px;
			  margin: 20px 0;
			}
			
			.stat-card {
			  background-color: white;
			  border-radius: var(--border-radius);
			  padding: 15px;
			  min-width: 120px;
			  text-align: center;
			  box-shadow: var(--shadow);
			  flex-grow: 1;
			}
			
			.stat-card.card1 {
			  border-top: 4px solid var(--geometric-1);
			}
			
			.stat-card.card2 {
			  border-top: 4px solid var(--geometric-2);
			}
			
			.stat-card.card3 {
			  border-top: 4px solid var(--primary);
			}
			
			.stat-card.card4 {
			  border-top: 4px solid var(--secondary);
			}`
			},



			arithmetique: {
				title: "Suites Arithmétiques",
				description: "Un template pour créer des exercices interactifs sur les suites arithmétiques. L'apprenant peut explorer les propriétés des suites, calculer différents termes et sommes, et visualiser les patterns.",
				features: [
					"Simulation interactive des suites arithmétiques",
					"Calcul du terme suivant ou d'un terme manquant",
					"Détermination de la raison d'une suite",
					"Calcul du rang d'un terme spécifique",
					"Calcul de la somme des n premiers termes",
					"Visualisation dynamique des patterns"
				],
				icon: "fas fa-calculator",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Suites Arithmétiques</h3>
						
						<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-family: monospace;">
							<div style="font-weight: bold;">u<sub>n</sub> = u<sub>1</sub> + (n-1)×r = 3 + (n-1)×2</div>
						</div>
						
						<div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
							<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #a24b5f; border-radius: 8px; font-weight: bold;">3</div>
							<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #a24b5f; border-radius: 8px; font-weight: bold;">5</div>
							<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #a24b5f; border-radius: 8px; font-weight: bold;">7</div>
							<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #a24b5f; border-radius: 8px; font-weight: bold;">9</div>
							<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #a24b5f; border-radius: 8px; font-weight: bold;">11</div>
						</div>
						
						<div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
							<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; flex-grow: 1;">
								<div style="color: #666; font-size: 0.9em;">Premier terme</div>
								<div style="font-weight: bold; font-size: 1.5em;">3</div>
							</div>
							<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; flex-grow: 1;">
								<div style="color: #666; font-size: 0.9em;">Raison</div>
								<div style="font-weight: bold; font-size: 1.5em;">2</div>
							</div>
							<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; flex-grow: 1;">
								<div style="color: #666; font-size: 0.9em;">u₁₀</div>
								<div style="font-weight: bold; font-size: 1.5em;">21</div>
							</div>
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE SUITES ARITHMETIQUES : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation des variables globales
				let currentSequence = [];
				let currentFirstTerm = 3;
				let currentReason = 2;
				let termCount = 7;
				let missingIndex = null;
				let specialTermRank = 10;
				let specialTermValue = 0;
				let score = 0;
				let solved = new Set();
				let allExercisesCompleted = false;
				const totalExercises = 6;
				let currentHighlight = '';
				let activeExercise = null;
				let exerciseAnswers = {
					1: null, // Terme suivant
					2: null, // Terme manquant
					3: null, // Raison
					4: null, // Rang d'un terme
					5: null, // Somme
					6: null  // Problème appliqué
				};
				
				// Initialisation de l'application
				initSequence();
				
				// Permettre la validation avec Enter pour tous les champs de réponse
				document.querySelectorAll('input[type="number"]').forEach((input) => {
					input.addEventListener('keypress', function(e) {
						if (e.key === 'Enter') {
							const exerciseId = this.id.replace('answer', '');
							checkAnswer(exerciseId);
						}
					});
				});
				
				// =====================================================================
				## ⚠️ GESTION DE LA SUITE ARITHMETIQUE
				// =====================================================================
				
				// Fonctions de gestion de la suite arithmétique
				
				// Initialisation de la séquence
				function initSequence() {
					// Créer la séquence complète
					currentSequence = [];
					for (let i = 0; i < termCount; i++) {
						const term = currentFirstTerm + i * currentReason;
						currentSequence.push(term);
					}
					
					// Calcul du terme spécial (u10 par défaut)
					specialTermValue = currentFirstTerm + (specialTermRank - 1) * currentReason;
					
					// Mise à jour de l'affichage
					displaySequence();
					updateStats();
				}
				
				// Générer une séquence aléatoire
				function generateRandomSequence() {
					resetActiveExercise();
					
					// Premier terme entre -10 et 20
					currentFirstTerm = Math.floor(Math.random() * 30) - 10;
					
					// Raison entre -5 et 5 (non nulle)
					do {
						currentReason = Math.floor(Math.random() * 11) - 5;
					} while (currentReason === 0);
					
					// Nombre de termes entre 5 et 9
					termCount = Math.floor(Math.random() * 5) + 5;
					
					// Réinitialiser le terme manquant
					missingIndex = null;
					
					// Initialiser la séquence
					initSequence();
					
					// Mettre à jour les données des exercices
					updateExerciseData();
				}
				
				// Afficher la séquence
				function displaySequence() {
					const sequenceDisplay = document.getElementById('sequenceDisplay');
					const formulaDisplay = document.getElementById('formulaDisplay');
					
					// Vider l'affichage
					sequenceDisplay.innerHTML = '';
					
					// Afficher chaque terme
					for (let i = 0; i < termCount; i++) {
						const term = currentSequence[i];
						const numberBox = document.createElement('div');
						numberBox.className = 'number-box';
						
						// Si c'est un terme manquant
						if (i === missingIndex) {
							numberBox.textContent = '?';
							numberBox.classList.add('missing');
						} else {
							numberBox.textContent = term;
						}
						
						numberBox.title = \`u\${i+1} = \${term}\`;
						sequenceDisplay.appendChild(numberBox);
					}
					
					// Mettre à jour la formule
					formulaDisplay.innerHTML = \`u<sub>n</sub> = u<sub>1</sub> + (n-1)×r = \${currentFirstTerm} + (n-1)×\${currentReason}\`;
				}
				
				// Mettre à jour les statistiques
				function updateStats() {
					document.getElementById('firstTerm').textContent = currentFirstTerm;
					document.getElementById('reason').textContent = currentReason;
					document.getElementById('termCount').textContent = termCount;
					document.getElementById('specialTerm').textContent = '?';
				}
				
				// Mettre en évidence le motif (animation des termes)
				function highlightPattern() {
					const boxes = document.querySelectorAll('.number-box');
					
					// Retirer les highlights précédents
					boxes.forEach(box => box.classList.remove('highlight'));
					
					// Animation séquentielle
					boxes.forEach((box, index) => {
						setTimeout(() => {
							box.classList.add('highlight');
							
							// Retirer après un délai
							setTimeout(() => {
								box.classList.remove('highlight');
							}, 800);
						}, index * 300);
					});
				}
				
				// Créer un terme manquant
				function showMissingTerm() {
					// Sélectionner un index aléatoire (pas le premier)
					missingIndex = Math.floor(Math.random() * (termCount - 1)) + 1;
					
					// Réafficher la séquence
					displaySequence();
					
					// Mettre à jour les données de l'exercice 2
					updateExerciseData();
				}
				
				// Calculer un terme spécial (u10 par défaut)
				function calculateSpecialTerm() {
					// Animation du point d'interrogation pour indiquer que c'est une valeur à calculer
					const specialTermEl = document.getElementById('specialTerm');
					specialTermEl.style.transition = 'all 0.3s ease';
					specialTermEl.style.transform = 'scale(1.2)';
					specialTermEl.style.color = '#4361ee';
					
					// Remettre à la normale après animation
					setTimeout(() => {
						specialTermEl.style.transform = 'scale(1)';
						specialTermEl.style.color = 'var(--dark)';
					}, 1000);
					
					// Générer un exercice pour le calcul de ce terme spécial
					generateSequenceForRankCalculation();
				}
				
				// Réinitialiser l'exercice actif
				function resetActiveExercise() {
					// Supprimer la classe active de l'exercice précédent
					if (activeExercise) {
						document.querySelector(\`.exercise-card[data-exercise="\${activeExercise}"]\`).classList.remove('active-exercise');
					}
					activeExercise = null;
				}
				
				// Définir un exercice comme actif
				function setActiveExercise(exerciseNum) {
					resetActiveExercise();
					
					// Ajouter la classe active au nouvel exercice
					const exerciseCard = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`);
					if (exerciseCard) {
						exerciseCard.classList.add('active-exercise');
						activeExercise = exerciseNum;
						
						// Faire défiler jusqu'à la simulation
						document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
					}
				}
				
				// =====================================================================
				## ⚠️ PRIORITÉS HAUTE : N UTILISER QUE LES THEMES D EXERCICES ACTIVÉS 
				// =====================================================================
				
								
				// Type 1: Générer une suite pour l'exercice du terme suivant
				function generateSequenceForNextTerm() {
					setActiveExercise(1);
					
					// Générer une suite avec des valeurs simples
					currentFirstTerm = Math.floor(Math.random() * 10) - 5; // Entre -5 et 5
					currentReason = Math.floor(Math.random() * 5) + 1; // Entre 1 et 5
					termCount = 6; // Suite assez courte
					missingIndex = null;
					
					// Initialiser la séquence
					initSequence();
					
					// Calculer la réponse correcte (terme suivant)
					exerciseAnswers[1] = currentSequence[termCount-1] + currentReason;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex1').innerHTML = \`
						Premier terme (u₁): \${currentFirstTerm}<br>
						Raison (r): \${currentReason}<br>
						Dernier terme affiché: \${currentSequence[termCount-1]}
					\`;
					
					// Animer le dernier terme pour indiquer qu'il faut trouver le suivant
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						const lastBox = boxes[boxes.length - 1];
						lastBox.classList.add('highlight');
						setTimeout(() => {
							lastBox.classList.remove('highlight');
						}, 1500);
					}, 500);
				}
				
				// Type 2: Générer une suite pour l'exercice du terme manquant
				function generateSequenceForMissingTerm() {
					setActiveExercise(2);
					
					// Générer une suite
					currentFirstTerm = Math.floor(Math.random() * 10) - 3; // Entre -3 et 7
					currentReason = Math.floor(Math.random() * 5) + 1; // Entre 1 et 5
					termCount = 7;
					
					// Créer un terme manquant (pas le premier ni le dernier)
					missingIndex = Math.floor(Math.random() * (termCount - 2)) + 1;
					
					// Initialiser la séquence
					initSequence();
					
					// Calculer la réponse correcte (terme manquant)
					exerciseAnswers[2] = currentFirstTerm + missingIndex * currentReason;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex2').innerHTML = \`
						Premier terme (u₁): \${currentFirstTerm}<br>
						Raison (r): \${currentReason}<br>
						Position du terme manquant: \${missingIndex + 1}
					\`;
					
					// Animer le terme manquant
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						const missingBox = boxes[missingIndex];
						missingBox.classList.add('highlight');
						setTimeout(() => {
							missingBox.classList.remove('highlight');
						}, 1500);
					}, 500);
				}
				
				// Type 3: Générer une suite pour l'exercice de calcul de la raison
				function generateSequenceForReasonCalculation() {
					setActiveExercise(3);
					
					// Générer une suite avec une raison plus distincte
					currentFirstTerm = Math.floor(Math.random() * 10);
					currentReason = Math.floor(Math.random() * 7) - 3; // Entre -3 et 3, mais pas 0
					if (currentReason === 0) currentReason = 1;
					
					termCount = 6;
					missingIndex = null;
					
					// Initialiser la séquence
					initSequence();
					
					// La réponse est la raison elle-même
					exerciseAnswers[3] = currentReason;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex3').innerHTML = \`
						Premier terme (u₁): \${currentFirstTerm}<br>
						Différence entre termes consécutifs: ?
					\`;
					
					// Animer les termes pour montrer la différence
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						
						// Animer séquentiellement les paires de termes
						for (let i = 0; i < boxes.length - 1; i++) {
							setTimeout(() => {
								boxes[i].classList.add('highlight');
								boxes[i+1].classList.add('highlight');
								
								setTimeout(() => {
									boxes[i].classList.remove('highlight');
									boxes[i+1].classList.remove('highlight');
								}, 1000);
							}, i * 1200);
						}
					}, 500);
				}
				
				// Type 4: Générer une suite pour l'exercice de calcul du rang
				function generateSequenceForRankCalculation() {
					setActiveExercise(4);
					
					// Générer une suite
					currentFirstTerm = Math.floor(Math.random() * 10) - 5;
					currentReason = Math.floor(Math.random() * 5) + 1; // Raison positive pour simplifier
					termCount = 6;
					missingIndex = null;
					
					// Calculer un terme spécial à un rang calculable simplement
					let targetRank = Math.floor(Math.random() * 10) + 8; // Entre 8 et 17
					let targetValue = currentFirstTerm + (targetRank - 1) * currentReason;
					
					// Initialiser la séquence
					initSequence();
					
					// Mettre à jour la valeur cible dans la question
					document.getElementById('rankTerm').textContent = targetValue;
					
					// La réponse est le rang calculé
					exerciseAnswers[4] = targetRank;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex4').innerHTML = \`
						u<sub>n</sub> = u<sub>1</sub> + (n-1) × r<br>
						On cherche n tel que u<sub>n</sub> = \${targetValue}<br>
						Donc : \${targetValue} = \${currentFirstTerm} + (n-1) × \${currentReason}
					\`;
					
					// Ajouter un terme à la suite qui sera animé comme référence
					specialTermRank = targetRank;
					specialTermValue = targetValue;
					updateStats();
					
					// Animation sur la carte de statistiques
					setTimeout(() => {
						const specialTermEl = document.getElementById('specialTerm');
						specialTermEl.style.transition = 'all 0.3s ease';
						specialTermEl.style.transform = 'scale(1.2)';
						specialTermEl.style.color = '#4361ee';
						
						setTimeout(() => {
							specialTermEl.style.transform = 'scale(1)';
							specialTermEl.style.color = 'var(--dark)';
						}, 1000);
					}, 500);
				}
				
				// Type 5: Générer une suite pour l'exercice de calcul de la somme
				function generateSequenceForSumCalculation() {
					setActiveExercise(5);
					
					// Générer une suite avec des valeurs simples pour faciliter la somme
					currentFirstTerm = Math.floor(Math.random() * 6); // Entre 0 et 5
					currentReason = Math.floor(Math.random() * 3) + 1; // Entre 1 et 3
					termCount = 6;
					missingIndex = null;
					
					// Nombre de termes à sommer
					const sumCount = Math.floor(Math.random() * 4) + 7; // Entre 7 et 10
					document.getElementById('sumCount').textContent = sumCount;
					
					// Initialiser la séquence
					initSequence();
					
					// Calculer le dernier terme de la somme
					const lastTermSum = currentFirstTerm + (sumCount - 1) * currentReason;
					
					// Calculer la somme (formule: n*(premier + dernier)/2)
					exerciseAnswers[5] = sumCount * (currentFirstTerm + lastTermSum) / 2;
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex5').innerHTML = \`
						S<sub>n</sub> = n × (u<sub>1</sub> + u<sub>n</sub>) / 2<br>
						Pour calculer u<sub>n</sub>, utilisez : u<sub>n</sub> = u<sub>1</sub> + (n-1) × r<br>
						Donc u<sub>\${sumCount}</sub> = \${currentFirstTerm} + (\${sumCount}-1) × \${currentReason} = \${lastTermSum}<br>
						S<sub>\${sumCount}</sub> = \${sumCount} × (\${currentFirstTerm} + \${lastTermSum}) / 2
					\`;
					
					// Animer tous les termes pour montrer qu'il faut les sommer
					setTimeout(() => {
						const boxes = document.querySelectorAll('.number-box');
						
						boxes.forEach((box, index) => {
							setTimeout(() => {
								box.classList.add('highlight');
								
								setTimeout(() => {
									box.classList.remove('highlight');
								}, 700);
							}, index * 200);
						});
					}, 500);
				}
				
				// Type 6: Générer une suite pour l'exercice de problème appliqué
				function generateSequenceForApplicationProblem() {
					setActiveExercise(6);
					
					// Paramètres du problème
					const totalSeats = Math.floor(Math.random() * 50) + 100; // Entre 100 et 150
					const baseSpectators = Math.floor(Math.random() * 20) + 70; // Entre 70 et 90
					const decreaseRate = Math.floor(Math.random() * 10) + 10; // Entre 10 et 20
					const baseRevenue = Math.floor(Math.random() * 500) + 1000; // Entre 1000 et 1500
					const targetSpectators = Math.floor(Math.random() * 20) + 40; // Entre 40 et 60
					
					// Mettre à jour le texte du problème
					document.getElementById('problem1').textContent = totalSeats;
					document.getElementById('problem2').textContent = baseSpectators;
					document.getElementById('problem3').textContent = decreaseRate;
					document.getElementById('problem4').textContent = baseRevenue;
					document.getElementById('problem5').textContent = targetSpectators;
					
					// Calculer la réponse
					const spectatorDiff = baseSpectators - targetSpectators;
					exerciseAnswers[6] = baseRevenue - spectatorDiff * decreaseRate;
					
					// Mise à jour de la suite arithmétique pour représenter ce problème
					currentFirstTerm = baseRevenue + (baseSpectators * decreaseRate);
					currentReason = -decreaseRate;
					termCount = 6;
					
					// Initialiser la séquence pour visualiser le problème
					initSequence();
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex6').innerHTML = \`
						On peut modéliser la recette par une suite arithmétique où:<br>
						- u<sub>\${baseSpectators}</sub> = \${baseRevenue}€ (recette pour \${baseSpectators} spectateurs)<br>
						- La raison r = -\${decreaseRate}€ (diminution par spectateur)<br>
						- On cherche u<sub>\${targetSpectators}</sub> (recette pour \${targetSpectators} spectateurs)
					\`;
				}
				
				
				// Type 7: Générer une suite pour l'exercice du calcul du terme de rang N
				function generateSequenceForNthTermCalculation() {
					setActiveExercise(7);
					
					// Générer une suite
					currentFirstTerm = Math.floor(Math.random() * 10) - 5; // Entre -5 et 5
					currentReason = Math.floor(Math.random() * 5) + 1; // Entre 1 et 5
					termCount = 6;
					missingIndex = null;
					
					// Choisir un rang à calculer (entre 15 et 30 pour que ce soit un peu difficile)
					let targetRank = Math.floor(Math.random() * 16) + 15; // Entre 15 et 30
					
					// Initialiser la séquence
					initSequence();
					
					// Mettre à jour les informations de l'exercice
					document.getElementById('stats-ex7').innerHTML = 
						"Premier terme (u₁): " + currentFirstTerm + "<br>" +
						"Raison (r): " + currentReason + "<br>" +
						"Rang à calculer: " + targetRank;
					
					// Calculer la réponse (terme de rang N)
					const correctAnswer = currentFirstTerm + (targetRank - 1) * currentReason;
					exerciseAnswers[7] = correctAnswer;
					
					// Mettre à jour le rang cible dans l'affichage
					document.getElementById('targetRank').textContent = targetRank;
					
					// Animer la formule pour attirer l'attention
					setTimeout(() => {
						const formulaDiv = document.getElementById('formulaDisplay');
						if (formulaDiv) {
							formulaDiv.style.transition = 'all 0.3s ease';
							formulaDiv.style.transform = 'scale(1.05)';
							formulaDiv.style.boxShadow = '0 0 10px rgba(67, 97, 238, 0.5)';
							
							setTimeout(() => {
								formulaDiv.style.transform = 'scale(1)';
								formulaDiv.style.boxShadow = 'none';
							}, 1000);
						}
					}, 500);
				}
				
				
				// Mise à jour des données des exercices
				function updateExerciseData() {
					// Exercice 1: Terme suivant
					document.getElementById('stats-ex1').innerHTML = \`
						Premier terme (u₁): \${currentFirstTerm}<br>
						Raison (r): \${currentReason}<br>
						Dernier terme affiché: \${currentSequence[termCount-1]}
					\`;
					
					// Exercice 2: Terme manquant
					if (missingIndex !== null) {
						document.getElementById('stats-ex2').innerHTML = \`
							Premier terme (u₁): \${currentFirstTerm}<br>
							Raison (r): \${currentReason}<br>
							Position du terme manquant: \${missingIndex + 1}
						\`;
					}
					
					// Exercice 3: Calcul de la raison
					document.getElementById('stats-ex3').innerHTML = \`
						Premier terme (u₁): \${currentFirstTerm}<br>
						Différence entre termes consécutifs: ?
					\`;
					
					// Exercice 4: Calcul du rang
					const rankTerm = currentFirstTerm + (specialTermRank + 2) * currentReason;
					document.getElementById('rankTerm').textContent = rankTerm;
					
					document.getElementById('stats-ex4').innerHTML = \`
						u<sub>n</sub> = u<sub>1</sub> + (n-1) × r<br>
						On cherche n tel que u<sub>n</sub> = \${rankTerm}<br>
						Donc : \${rankTerm} = \${currentFirstTerm} + (n-1) × \${currentReason}
					\`;
					
					// Exercice 5: Somme des termes
					const sumCount = 10;
					document.getElementById('sumCount').textContent = sumCount;
					const lastTermSum = currentFirstTerm + (sumCount - 1) * currentReason;
					
					document.getElementById('stats-ex5').innerHTML = \`
						S<sub>n</sub> = n × (u<sub>1</sub> + u<sub>n</sub>) / 2<br>
						Pour calculer u<sub>n</sub>, utilisez : u<sub>n</sub> = u<sub>1</sub> + (n-1) × r<br>
						Donc u<sub>\${sumCount}</sub> = \${currentFirstTerm} + (\${sumCount}-1) × \${currentReason} = \${lastTermSum}<br>
						S<sub>\${sumCount}</sub> = \${sumCount} × (\${currentFirstTerm} + \${lastTermSum}) / 2
					\`;
					
					// Exercice 6: Problème appliqué
					const totalSeats = 120;
					const baseSpectators = 80;
					const decreaseRate = 15;
					const baseRevenue = 1200;
					const targetSpectators = 50;
					
					document.getElementById('problem1').textContent = totalSeats;
					document.getElementById('problem2').textContent = baseSpectators;
					document.getElementById('problem3').textContent = decreaseRate;
					document.getElementById('problem4').textContent = baseRevenue;
					document.getElementById('problem5').textContent = targetSpectators;
					
					document.getElementById('stats-ex6').innerHTML = \`
						On peut modéliser la recette par une suite arithmétique où:<br>
						- u<sub>\${baseSpectators}</sub> = \${baseRevenue}€ (recette pour \${baseSpectators} spectateurs)<br>
						- La raison r = -\${decreaseRate}€ (diminution par spectateur)<br>
						- On cherche u<sub>\${targetSpectators}</sub> (recette pour \${targetSpectators} spectateurs)
					\`;
					
					// Mettre à jour les réponses attendues
					exerciseAnswers[1] = currentSequence[termCount-1] + currentReason;
					if (missingIndex !== null) {
						exerciseAnswers[2] = currentSequence[missingIndex];
					}
					exerciseAnswers[3] = currentReason;
					exerciseAnswers[4] = 1 + (rankTerm - currentFirstTerm) / currentReason;
					exerciseAnswers[5] = sumCount * (currentFirstTerm + lastTermSum) / 2;
					
					const spectatorDiff = baseSpectators - targetSpectators;
					exerciseAnswers[6] = baseRevenue - spectatorDiff * decreaseRate;
				}
				
				// VÉRIFICATION DES RÉPONSES
				
				// Fonction principale pour vérifier une réponse
				function checkAnswer(exerciseNum) {
					const userAnswer = parseFloat(document.getElementById(\`answer\${exerciseNum}\`).value);
					const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
					const hintDiv = document.getElementById(\`hint\${exerciseNum}\`);
					
					if (isNaN(userAnswer)) {
						resultDiv.textContent = "⚠️ Veuillez entrer un nombre valide";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Vérifier si une suite a été générée pour cet exercice
					if (exerciseAnswers[exerciseNum] === null) {
						resultDiv.textContent = "⚠️ Veuillez d'abord créer une suite pour cet exercice";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Obtenir la réponse correcte
					const correctAnswer = exerciseAnswers[exerciseNum];
					let explanation = "";
					
					// Préparer l'explication
					switch(parseInt(exerciseNum)) {
						case 1: // Terme suivant
							explanation = \`Le terme suivant est u<sub>\${termCount+1}</sub> = u<sub>\${termCount}</sub> + r = \${currentSequence[termCount-1]} + \${currentReason} = \${correctAnswer}\`;
							break;
							
						case 2: // Terme manquant
							explanation = \`Le terme manquant est u<sub>\${missingIndex+1}</sub> = u<sub>1</sub> + (\${missingIndex+1}-1) × r = \${currentFirstTerm} + \${missingIndex} × \${currentReason} = \${correctAnswer}\`;
							break;
							
						case 3: // Calcul de la raison
							explanation = \`La raison est r = u<sub>n+1</sub> - u<sub>n</sub> = \${currentSequence[1]} - \${currentSequence[0]} = \${correctAnswer}\`;
							break;
							
						case 4: // Calcul du rang
							const rankTerm = parseInt(document.getElementById('rankTerm').textContent);
							explanation = \`Pour trouver n: \${rankTerm} = \${currentFirstTerm} + (n-1) × \${currentReason}
											<br>\${rankTerm} - \${currentFirstTerm} = (n-1) × \${currentReason}
											<br>\${rankTerm - currentFirstTerm} = (n-1) × \${currentReason}
											<br>(n-1) = \${(rankTerm - currentFirstTerm) / currentReason}
											<br>n = \${correctAnswer}\`;
							break;
							
						case 5: // Somme des termes
							const sumCount = parseInt(document.getElementById('sumCount').textContent);
							const lastTermSum = currentFirstTerm + (sumCount - 1) * currentReason;
							explanation = \`S<sub>\${sumCount}</sub> = \${sumCount} × (\${currentFirstTerm} + \${lastTermSum}) / 2 = \${sumCount} × \${currentFirstTerm + lastTermSum} / 2 = \${correctAnswer}\`;
							break;
							
						case 6: // Problème appliqué
							const baseSpectators = parseInt(document.getElementById('problem2').textContent);
							const targetSpectators = parseInt(document.getElementById('problem5').textContent);
							const decreaseRate = parseInt(document.getElementById('problem3').textContent);
							const baseRevenue = parseInt(document.getElementById('problem4').textContent);
							
							const spectatorDiff = baseSpectators - targetSpectators;
							explanation = \`La différence de spectateurs est \${baseSpectators} - \${targetSpectators} = \${spectatorDiff}
											<br>La diminution de recette est \${spectatorDiff} × \${decreaseRate}€ = \${spectatorDiff * decreaseRate}€
											<br>La recette pour \${targetSpectators} spectateurs est \${baseRevenue}€ - \${spectatorDiff * decreaseRate}€ = \${correctAnswer}€\`;
							break;
							
						case 7: // Calcul du terme de rang N
							const targetRank = parseInt(document.getElementById('targetRank').textContent);
							explanation = "Le terme de rang " + targetRank + " est u<sub>" + targetRank + "</sub> = u<sub>1</sub> + (" + targetRank + "-1) × r = " + currentFirstTerm + " + " + (targetRank-1) + " × " + currentReason + " = " + currentFirstTerm + " + " + ((targetRank-1) * currentReason) + " = " + correctAnswer;
							break;					
							
					}
					
					// Vérifier la réponse avec une tolérance
					const tolerance = 0.01;
					const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
					
					if (isCorrect) {
						resultDiv.innerHTML = "✓ Correct! " + explanation;
						resultDiv.className = "result correct show";
						hintDiv.style.display = "none";
						
						// Mettre à jour le score et marquer comme résolu si pas déjà fait
						if (!solved.has(exerciseNum)) {
							solved.add(exerciseNum);
							score++;
							document.getElementById('score').textContent = score;
							
							// Marquer visuellement comme résolu
							const exerciseCard = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`);
							if (exerciseCard) {
								exerciseCard.classList.add('solved');
							}
							
							// Vérifier si tous les exercices sont complétés
							if (solved.size >= totalExercises) {
								allExercisesCompleted = true;
								const finishBtn = document.getElementById('finishBtn');
								if (finishBtn) {
									finishBtn.classList.add('pulse-animation');
								}
							}
						}
						
						// Désactiver les contrôles
						document.getElementById(\`answer\${exerciseNum}\`).disabled = true;
						const checkBtn = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"] .check-btn\`);
						if (checkBtn) {
							checkBtn.disabled = true;
						}
					} else {
						resultDiv.textContent = "✗ Incorrect. Essayez encore!";
						resultDiv.className = "result incorrect show";
						hintDiv.style.display = "block";
					}
				}
				
				// Exposer les fonctions nécessaires au niveau global pour être utilisées dans le HTML
				window.generateRandomSequence = generateRandomSequence;
				window.highlightPattern = highlightPattern;
				window.showMissingTerm = showMissingTerm;
				window.calculateSpecialTerm = calculateSpecialTerm;
				window.generateSequenceForNextTerm = generateSequenceForNextTerm;
				window.generateSequenceForMissingTerm = generateSequenceForMissingTerm;
				window.generateSequenceForReasonCalculation = generateSequenceForReasonCalculation;
				window.generateSequenceForRankCalculation = generateSequenceForRankCalculation;
				window.generateSequenceForNthTermCalculation = generateSequenceForNthTermCalculation; // Nouvelle fonction
				window.generateSequenceForSumCalculation = generateSequenceForSumCalculation;
				window.generateSequenceForApplicationProblem = generateSequenceForApplicationProblem;
				window.checkAnswer = checkAnswer;
			});`,
				
				code: `<!-- Structure principale du template de suites arithmétiques -->
			<div class="card">
			  <h2 style="text-align: center; margin-bottom: 20px;">Simulation de Suite Arithmétique</h2>
			  
			  <!-- Simulation de suite arithmétique -->
			  <div class="sequence-container">
				<div class="formula-display" id="formulaDisplay">
				  u<sub>n</sub> = u<sub>1</sub> + (n-1)×r = 3 + (n-1)×2
				</div>
				
				<div class="sequence-display" id="sequenceDisplay">
				  <div class="number-box">3</div>
				  <div class="number-box">5</div>
				  <div class="number-box">7</div>
				  <div class="number-box">9</div>
				  <div class="number-box">11</div>
				  <div class="number-box">13</div>
				  <div class="number-box">15</div>
				</div>
			  </div>
			
			  <div class="sequence-info">
				<div class="stat-card card1">
				  <div class="stat-label">Premier terme (u₁)</div>
				  <div class="stat-value" id="firstTerm">3</div>
				</div>
				<div class="stat-card card2">
				  <div class="stat-label">Raison (r)</div>
				  <div class="stat-value" id="reason">2</div>
				</div>
				<div class="stat-card card3">
				  <div class="stat-label">Nombre de termes</div>
				  <div class="stat-value" id="termCount">7</div>
				</div>
				<div class="stat-card card4">
				  <div class="stat-label">Terme spécial (u₁₀)</div>
				  <div class="stat-value" id="specialTerm">?</div>
				</div>
			  </div>
			
			  <div class="btn-group">
				<button id="btnRandom" onclick="generateRandomSequence()">Générer aléatoirement</button>
				<button id="btnHighlightPattern" onclick="highlightPattern()">Mettre en évidence le motif</button>
				<button id="btnShowMissing" onclick="showMissingTerm()">Terme manquant</button>
				<button id="btnCalculateSpecial" onclick="calculateSpecialTerm()">Calculer u₁₀</button>
			  </div>
			</div>
			
			<div class="exercises">
			  <!-- Exercice 1: Calcul du terme suivant -->
			  <div class="exercise-card" data-exercise="1">
				<div class="material-header">
				  <span>Exercice 1</span>
				</div>
				
				<div class="question-text">
				  Calculer le terme suivant de la suite arithmétique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForNextTerm()">Créer une suite pour cet exercice</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données actuelles:</div>
				  <div id="stats-ex1">
					Premier terme (u₁): 3<br>
					Raison (r): 2<br>
					Dernier terme affiché: 15
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Terme suivant:</label>
				  <input type="number" id="answer1" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(1)">Vérifier</button>
				  <div class="result" id="result1"></div>
				  <div class="hint" id="hint1">Indice: Dans une suite arithmétique, on ajoute la raison r pour passer d'un terme au suivant.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 2: Calcul d'un terme manquant -->
			  <div class="exercise-card" data-exercise="2">
				<div class="material-header">
				  <span>Exercice 2</span>
				</div>
				
				<div class="question-text">
				  Calculer le terme manquant de la suite arithmétique.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForMissingTerm()">Créer une suite avec terme manquant</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données pour le calcul:</div>
				  <div id="stats-ex2">
					Premier terme (u₁): 3<br>
					Raison (r): 2<br>
					Position du terme manquant: ?
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Terme manquant:</label>
				  <input type="number" id="answer2" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(2)">Vérifier</button>
				  <div class="result" id="result2"></div>
				  <div class="hint" id="hint2">Indice: Identifiez la position du terme manquant puis utilisez la formule générale.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 3: Calcul de la raison -->
			  <div class="exercise-card" data-exercise="3">
				<div class="material-header">
				  <span>Exercice 3</span>
				</div>
				
				<div class="question-text">
				  Déterminer la raison r de la suite arithmétique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForReasonCalculation()">Créer une suite pour calculer la raison</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données de la suite:</div>
				  <div id="stats-ex3">
					Premier terme (u₁): 3<br>
					Différence entre termes consécutifs: ?
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Raison (r):</label>
				  <input type="number" id="answer3" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(3)">Vérifier</button>
				  <div class="result" id="result3"></div>
				  <div class="hint" id="hint3">Indice: La raison est la différence constante entre deux termes consécutifs.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 4: Calcul du rang d'un terme -->
			  <div class="exercise-card" data-exercise="4">
				<div class="material-header">
				  <span>Exercice 4</span>
				</div>
				
				<div class="question-text">
				  Déterminer le rang n du terme u<sub>n</sub> = <span id="rankTerm">25</span> dans la suite arithmétique affichée.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForRankCalculation()">Créer une suite pour cet exercice</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Formule à utiliser:</div>
				  <div id="stats-ex4">
					u<sub>n</sub> = u<sub>1</sub> + (n-1) × r<br>
					On cherche n tel que u<sub>n</sub> = <span>25</span><br>
					Donc : <span>25</span> = <span>3</span> + (n-1) × <span>2</span>
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Rang n:</label>
				  <input type="number" id="answer4" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(4)">Vérifier</button>
				  <div class="result" id="result4"></div>
				  <div class="hint" id="hint4">Indice: Isolez n dans l'équation en utilisant les opérations appropriées.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 5: Calcul de la somme des n premiers termes -->
			  <div class="exercise-card" data-exercise="5">
				<div class="material-header">
				  <span>Exercice 5</span>
				</div>
				
				<div class="question-text">
				  Calculer la somme des <span id="sumCount">10</span> premiers termes de la suite arithmétique.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForSumCalculation()">Créer une suite pour calculer la somme</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Formule de la somme:</div>
				  <div id="stats-ex5">
					S<sub>n</sub> = n × (u<sub>1</sub> + u<sub>n</sub>) / 2<br>
					Pour calculer u<sub>n</sub>, utilisez : u<sub>n</sub> = u<sub>1</sub> + (n-1) × r<br>
					Donc u<sub>10</sub> = <span>3</span> + (10-1) × <span>2</span> = <span>21</span><br>
					S<sub>10</sub> = 10 × (<span>3</span> + <span>21</span>) / 2
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Somme:</label>
				  <input type="number" id="answer5" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(5)">Vérifier</button>
				  <div class="result" id="result5"></div>
				  <div class="hint" id="hint5">Indice: Utilisez la formule S<sub>n</sub> = n × (u<sub>1</sub> + u<sub>n</sub>) / 2 après avoir calculé u<sub>n</sub>.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 6: Problème appliqué -->
			  <div class="exercise-card" data-exercise="6">
				<div class="material-header">
				  <span>Exercice 6</span>
				</div>
				
				<div class="question-text">
				  Un cinéma a <span id="problem1">120</span> places. Pour chaque séance avec moins de <span id="problem2">80</span> spectateurs, la recette diminue de <span id="problem3">15</span>€. 
				  La recette pour <span id="problem2">80</span> spectateurs est de <span id="problem4">1200</span>€.
				  Calculer la recette pour <span id="problem5">50</span> spectateurs.
				</div>
				
				<button class="question-specific-btn" onclick="generateSequenceForApplicationProblem()">Créer un problème de cinéma</button>
				
				<div class="simulation-stats">
				  <div class="stats-header">Approche par suite arithmétique:</div>
				  <div id="stats-ex6">
					On peut modéliser la recette par une suite arithmétique où:<br>
					- u<sub>80</sub> = 1200€ (recette pour 80 spectateurs)<br>
					- La raison r = -15€ (diminution par spectateur)<br>
					- On cherche u<sub>50</sub> (recette pour 50 spectateurs)
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Recette pour 50 spectateurs (en €):</label>
				  <input type="number" id="answer6" placeholder="Entrez votre réponse">
				  <button class="check-btn" onclick="checkAnswer(6)">Vérifier</button>
				  <div class="result" id="result6"></div>
				  <div class="hint" id="hint6">Indice: Calculez la différence de spectateurs et multipliez-la par la raison pour trouver l'évolution de la recette.</div>
				</div>
			  </div>
			</div>
			
			
			<!-- Exercice 7: Calcul du terme de rang N -->
			<div class="exercise-card" data-exercise="7">
			  <div class="material-header">
				<span>Exercice 7</span>
			  </div>
			  
			  <div class="question-text">
				Calculer le terme de rang <span id="targetRank">20</span> de la suite arithmétique affichée.
			  </div>
			  
			  <button class="question-specific-btn" onclick="generateSequenceForNthTermCalculation()">Créer une suite pour cet exercice</button>
			  
			  <div class="simulation-stats">
				<div class="stats-header">Formule à utiliser:</div>
				<div id="stats-ex7">
				  Premier terme (u₁): 3<br>
				  Raison (r): 2<br>
				  Rang à calculer: 20
				</div>
			  </div>
			  
			  <div class="input-group">
				<label>Terme u<sub><span id="targetRankLabel">20</span></sub>:</label>
				<input type="number" id="answer7" placeholder="Entrez votre réponse">
				<button class="check-btn" onclick="checkAnswer(7)">Vérifier</button>
				<div class="result" id="result7"></div>
				<div class="hint" id="hint7">Indice: Utilisez la formule u<sub>n</sub> = u<sub>1</sub> + (n-1) × r en remplaçant n par le rang cible.</div>
			  </div>
			</div>
			`,
			
				cssCode: `/* Variables de couleurs et de style */

			/* Styles pour la suite arithmétique */
			.sequence-container {
			  width: 100%;
			  margin: 20px 0;
			  text-align: center;
			}
			
			.sequence-display {
			  display: flex;
			  justify-content: center;
			  align-items: center;
			  flex-wrap: wrap;
			  gap: 10px;
			  margin: 20px 0;
			}
			
			.number-box {
			  width: 60px;
			  height: 60px;
			  display: flex;
			  align-items: center;
			  justify-content: center;
			  background-color: white;
			  border: 2px solid var(--primary);
			  border-radius: 8px;
			  font-size: 1.3rem;
			  font-weight: bold;
			  box-shadow: var(--shadow);
			  transition: all 0.3s ease;
			}
			
			.number-box.highlight {
			  transform: scale(1.1);
			  background-color: #ffeb3b;
			  border-color: #ffc107;
			  box-shadow: 0 0 10px rgba(255, 235, 59, 0.7);
			  font-weight: bold;
			}
			
			.number-box.missing {
			  border-style: dashed;
			  color: #aaa;
			}
			
			.formula-display {
			  background-color: #f0f7ff;
			  padding: 15px;
			  border-radius: 8px;
			  margin: 20px auto;
			  max-width: 80%;
			  text-align: center;
			  font-family: "Times New Roman", Times, serif;
			  font-size: 1.3rem;
			  box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
			}
			
			.sequence-info {
			  display: flex;
			  justify-content: space-around;
			  flex-wrap: wrap;
			  gap: 20px;
			  margin: 20px 0;
			}
			
			.stat-card {
			  background-color: white;
			  border-radius: var(--border-radius);
			  padding: 15px;
			  min-width: 120px;
			  text-align: center;
			  box-shadow: var(--shadow);
			  flex-grow: 1;
			}
			
			.stat-card.card1 {
			  border-top: 4px solid var(--arithmetic-1);
			}
			
			.stat-card.card2 {
			  border-top: 4px solid var(--arithmetic-2);
			}
			
			.stat-card.card3 {
			  border-top: 4px solid var(--primary);
			}
			
			.stat-card.card4 {
			  border-top: 4px solid var(--secondary);
			}
			
			.stat-value {
			  font-size: 2.2rem;
			  font-weight: 700;
			  margin: 10px 0;
			  color: var(--dark);
			}
			
			.stat-label {
			  font-size: 1.0rem;
			  color: #666;
			}
			
			.btn-group {
			  display: flex;
			  flex-wrap: wrap;
			  gap: 10px;
			  justify-content: center;
			  margin: 20px 0;
			}
			
			/* Styles pour les exercices */
			.exercises {
			  display: grid;
			  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
			  gap: 20px;
			  margin-top: 30px;
			}
			
			.exercise-card {
			  background: #f8f9fa;
			  border: 2px solid #e9ecef;
			  border-radius: 15px;
			  padding: 20px;
			  transition: all 0.3s ease;
			}
			
			.exercise-card:hover {
			  transform: translateY(-5px);
			  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
			}
			
			.material-header {
			  display: flex;
			  align-items: center;
			  margin-bottom: 15px;
			  font-size: 1.2em;
			  font-weight: bold;
			  color: #333;
			}
			
			.question-text {
			  background: #f7f7f7;
			  border-radius: 8px;
			  padding: 15px;
			  margin-bottom: 15px;
			  font-size: 1.1em;
			  color: #333;
			}
			
			.simulation-stats {
			  background: #f0f7ff;
			  padding: 15px;
			  border-radius: 10px;
			  margin-bottom: 15px;
			  border: 1px solid #d1e3ff;
			}
			
			.stats-header {
			  font-weight: bold;
			  margin-bottom: 10px;
			  color: #1a56db;
			}
			
			.input-group {
			  margin-top: 15px;
			}
			
			.input-group label {
			  display: block;
			  margin-bottom: 5px;
			  color: #555;
			  font-weight: bold;
			}
			
			input[type="number"] {
			  width: 100%;
			  padding: 10px;
			  border: 2px solid #ddd;
			  border-radius: 8px;
			  font-size: 1.1em;
			  transition: border-color 0.3s;
			}
			
			input[type="number"]:focus {
			  outline: none;
			  border-color: #ea6687;
			}
			
			.check-btn {
			  width: 100%;
			  padding: 12px;
			  margin-top: 10px;
			  background: #ea6687;
			  color: white;
			  border: none;
			  border-radius: 8px;
			  font-size: 1.1em;
			  font-weight: bold;
			  cursor: pointer;
			  transition: all 0.3s;
			}
			
			.check-btn:hover {
			  background: #a24b5f;
			  transform: translateY(-2px);
			}
			
			.result {
			  margin-top: 10px;
			  padding: 10px;
			  border-radius: 8px;
			  font-weight: bold;
			  text-align: center;
			  opacity: 0;
			  transition: opacity 0.3s;
			}
			
			.result.show {
			  opacity: 1;
			}
			
			.result.correct {
			  background: #d4edda;
			  color: #155724;
			  border: 1px solid #c3e6cb;
			}
			
			.result.incorrect {
			  background: #f8d7da;
			  color: #721c24;
			  border: 1px solid #f5c6cb;
			}
			
			.hint {
			  background: #fff3cd;
			  border: 1px solid #ffeeba;
			  color: #856404;
			  padding: 10px;
			  border-radius: 8px;
			  margin-top: 10px;
			  font-size: 0.9em;
			  display: none;
			}
			
			.question-specific-btn {
			  background-color: var(--question-btn);
			  color: white;
			  border: none;
			  border-radius: 8px;
			  padding: 10px 15px;
			  font-size: 0.9em;
			  cursor: pointer;
			  margin-bottom: 15px;
			  transition: all 0.3s;
			}
			
			.question-specific-btn:hover {
			  background-color: var(--question-btn-hover);
			  transform: translateY(-2px);
			}
			
			/* Animation pour la mise en évidence */
			@keyframes highlight {
			  0% { background-color: #fff; box-shadow: none; transform: scale(1); }
			  20% { background-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; transform: scale(1.05); }
			  80% { background-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; transform: scale(1.05); }
			  100% { background-color: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; transform: scale(1.05); }
			}`
			
			},



			"chimie-orga": {
				title: "Simulateur de Molécules Organiques",
				description: "Un template pour créer des exercices de chimie organique interactifs. L'apprenant peut visualiser, construire et identifier différentes familles de molécules organiques.",
				features: [
					"Simulateur de molécules 2D interactif",
					"8 familles de molécules organiques",
					"Questions de construction et d'identification",
					"Feedback détaillé avec explications chimiques",
					"Suivi des scores et progression"
				],
				icon: "fas fa-atom",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Simulateur de Molécules</h3>
					</div>
					<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px;">
						<div style="background: #a24b5f; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcanes</div>
						<div style="background: #6a88ca; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcènes</div>
						<div style="background: #8ba4da; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcynes</div>
						<div style="background: #6a88ca; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcools</div>
					</div>
					<div style="background: white; border: 1px solid #ddd; border-radius: 8px; height: 180px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
						<div style="text-align: center; color: #a24b5f;">
							<svg width="200" height="100" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
								<!-- Simple molecule representation -->
								<circle cx="50" cy="50" r="10" fill="black" />
								<circle cx="100" cy="50" r="10" fill="black" />
								<circle cx="150" cy="50" r="10" fill="black" />
								<line x1="60" y1="50" x2="90" y2="50" stroke="black" stroke-width="3" />
								<line x1="110" y1="50" x2="140" y2="50" stroke="black" stroke-width="3" />
								<circle cx="50" cy="30" r="6" fill="#e0e0e0" />
								<circle cx="50" cy="70" r="6" fill="#e0e0e0" />
								<circle cx="150" cy="30" r="6" fill="#e0e0e0" />
								<circle cx="150" cy="70" r="6" fill="#e0e0e0" />
								<circle cx="100" cy="30" r="6" fill="#e0e0e0" />
								<circle cx="100" cy="70" r="6" fill="#e0e0e0" />
								<line x1="50" y1="40" x2="50" y2="30" stroke="black" stroke-width="1.5" />
								<line x1="50" y1="60" x2="50" y2="70" stroke="black" stroke-width="1.5" />
								<line x1="100" y1="40" x2="100" y2="30" stroke="black" stroke-width="1.5" />
								<line x1="100" y1="60" x2="100" y2="70" stroke="black" stroke-width="1.5" />
								<line x1="150" y1="40" x2="150" y2="30" stroke="black" stroke-width="1.5" />
								<line x1="150" y1="60" x2="150" y2="70" stroke="black" stroke-width="1.5" />
							</svg>
							<div style="margin-top: 10px;">Propane (C₃H₈)</div>
						</div>
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
						<div style="background: #a24b5f; color: white; padding: 10px; border-radius: 5px; text-align: center;">Construire</div>
						<div style="background: #a24b5f; color: white; padding: 10px; border-radius: 5px; text-align: center;">Identifier</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE CHIMIE ORGA : PRIORITE OBLIGATOIRE SI CHOISIE
			/* ============================================================================
			   LA SIMULATION
			============================================================================ */
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation du simulateur de molécules
				initMoleculeSimulator();
				
				// Initialiser les écouteurs d'événements pour les questions
				initQuestionEvents();
				
				// Préparer la première question
				setupNextQuestion();
			});
			
			// Variables globales
			let score = 0;
			let answered = new Set();
			let userAnswers = Array(6).fill(null);
			let currentQuestion = null;
			let currentMoleculeType = 'alcane';
			let currentMoleculeData = {
				type: 'alcane',
				carbonCount: 5,
				doubleBondPos: 1,
				tripleBondPos: 1,
				alcoholPos: 1,
				groupType: 'aldehyde',
				funcPos: 1,
				acylCount: 2,
				alkoxyCount: 1
			};
			
			// Paramètres du canvas
			const canvas = document.getElementById('moleculeCanvas');
			const context = canvas.getContext('2d');
			const infoLabel = document.getElementById('moleculeInfo');
			
			// Paramètres de dessin communs
			const carbonRadius = 12;
			const hydrogenRadius = 8;
			const oxygenRadius = 11;
			const hydrogenOffset = 40;
			
			// Fonction pour initialiser le simulateur
			function initMoleculeSimulator() {
				// Initialiser les écouteurs d'événements pour les boutons de type
				document.querySelectorAll('.molecule-button').forEach(button => {
					button.addEventListener('click', () => {
						changeMoleculeType(button.dataset.type);
					});
				});
				
				// Initialiser les écouteurs d'événements pour les curseurs
				setupSliders();
				
				// Initialiser les écouteurs pour le redimensionnement
				window.addEventListener('resize', resizeCanvas);
				
				// Initialisation des valeurs par défaut
				resizeCanvas();
				updateAlceneDoubleBondSliderMax();
				updateAlcyneTripleBondSliderMax();
				updateAldehydeCetoneSliders();
				
				// Dessiner la molécule initiale (alcane par défaut)
				drawCurrentMolecule();
			}
			
			// Configuration des curseurs pour toutes les familles de molécules
			function setupSliders() {
				// Alcanes
				document.getElementById('alcane-carbonSlider').addEventListener('input', () => {
					document.getElementById('alcane-carbonCount').textContent = document.getElementById('alcane-carbonSlider').value;
					currentMoleculeData.carbonCount = parseInt(document.getElementById('alcane-carbonSlider').value);
					drawCurrentMolecule();
				});
				
				// Alcènes
				document.getElementById('alcene-carbonSlider').addEventListener('input', () => {
					document.getElementById('alcene-carbonCount').textContent = document.getElementById('alcene-carbonSlider').value;
					currentMoleculeData.carbonCount = parseInt(document.getElementById('alcene-carbonSlider').value);
					updateAlceneDoubleBondSliderMax();
					drawCurrentMolecule();
				});
				document.getElementById('alcene-doubleBondSlider').addEventListener('input', () => {
					document.getElementById('alcene-doubleBondCount').textContent = document.getElementById('alcene-doubleBondSlider').value;
					currentMoleculeData.doubleBondPos = parseInt(document.getElementById('alcene-doubleBondSlider').value);
					drawCurrentMolecule();
				});
				
				// Alcynes
				document.getElementById('alcyne-carbonSlider').addEventListener('input', () => {
					document.getElementById('alcyne-carbonCount').textContent = document.getElementById('alcyne-carbonSlider').value;
					currentMoleculeData.carbonCount = parseInt(document.getElementById('alcyne-carbonSlider').value);
					updateAlcyneTripleBondSliderMax();
					drawCurrentMolecule();
				});
				document.getElementById('alcyne-tripleBondSlider').addEventListener('input', () => {
					document.getElementById('alcyne-tripleBondCount').textContent = document.getElementById('alcyne-tripleBondSlider').value;
					currentMoleculeData.tripleBondPos = parseInt(document.getElementById('alcyne-tripleBondSlider').value);
					drawCurrentMolecule();
				});
				
				// Alcools
				document.getElementById('alcool-carbonSlider').addEventListener('input', () => {
					const n = parseInt(document.getElementById('alcool-carbonSlider').value);
					document.getElementById('alcool-carbonCount').textContent = n;
					currentMoleculeData.carbonCount = n;
					
					// Mettre à jour le slider de position pour ne pas dépasser n
					const posSlider = document.getElementById('alcool-positionSlider');
					posSlider.max = n;
					if (parseInt(posSlider.value) > n) {
						posSlider.value = n;
						document.getElementById('alcool-positionCount').textContent = n;
						currentMoleculeData.alcoholPos = n;
					}
					
					drawCurrentMolecule();
				});
				document.getElementById('alcool-positionSlider').addEventListener('input', () => {
					document.getElementById('alcool-positionCount').textContent = document.getElementById('alcool-positionSlider').value;
					currentMoleculeData.alcoholPos = parseInt(document.getElementById('alcool-positionSlider').value);
					drawCurrentMolecule();
				});
				
				// Aldéhydes et cétones
				document.getElementById('aldehyde-cetone-carbonSlider').addEventListener('input', () => {
					currentMoleculeData.carbonCount = parseInt(document.getElementById('aldehyde-cetone-carbonSlider').value);
					updateAldehydeCetoneSliders();
					drawCurrentMolecule();
				});
				document.getElementById('aldehyde-cetone-funcSlider').addEventListener('input', () => {
					document.getElementById('aldehyde-cetone-funcPosDisplay').textContent = document.getElementById('aldehyde-cetone-funcSlider').value;
					currentMoleculeData.funcPos = parseInt(document.getElementById('aldehyde-cetone-funcSlider').value);
					drawCurrentMolecule();
				});
				document.getElementById('aldehydeRadio').addEventListener('change', () => {
					if (document.getElementById('aldehydeRadio').checked) {
						currentMoleculeData.groupType = 'aldehyde';
						updateAldehydeCetoneSliders();
						drawCurrentMolecule();
					}
				});
				document.getElementById('ketoneRadio').addEventListener('change', () => {
					if (document.getElementById('ketoneRadio').checked) {
						currentMoleculeData.groupType = 'ketone';
						updateAldehydeCetoneSliders();
						drawCurrentMolecule();
					}
				});
				
				// Acides carboxyliques
				document.getElementById('acide-carbonSlider').addEventListener('input', () => {
					document.getElementById('acide-carbonCount').textContent = document.getElementById('acide-carbonSlider').value;
					currentMoleculeData.carbonCount = parseInt(document.getElementById('acide-carbonSlider').value);
					drawCurrentMolecule();
				});
				
				// Esters
				document.getElementById('ester-acylSlider').addEventListener('input', () => {
					document.getElementById('ester-acylCount').textContent = document.getElementById('ester-acylSlider').value;
					currentMoleculeData.acylCount = parseInt(document.getElementById('ester-acylSlider').value);
					drawCurrentMolecule();
				});
				document.getElementById('ester-alkoxySlider').addEventListener('input', () => {
					document.getElementById('ester-alkoxyCount').textContent = document.getElementById('ester-alkoxySlider').value;
					currentMoleculeData.alkoxyCount = parseInt(document.getElementById('ester-alkoxySlider').value);
					drawCurrentMolecule();
				});
			}
			
			
			--------------------------------------------------------------------------
			   ### PRIORITÉ ABSOLUE:  UTILISER EXCLUSIVEMENT POUR LA SIMULATION LES FAMILLES DE MOLÉCULES SÉLECTIONNÉES PAR L'UTILISATEUR
			-------------------------------------------------------------------------- */
		
		
		

			/* --------------------------------------------------------------------------
			   FAMILLE 1 : ALCANES
			-------------------------------------------------------------------------- */
			function drawAlcane(n) {
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// Calculer les positions des carbones
				let carbonPositions = [];
				if (n === 1) {
					carbonPositions.push({ x: canvas.width / 2, y: canvas.height / 2 });
				} else {
					carbonPositions = computeChainPositions(n, 100, canvas.width - 100, canvas.height / 2);
				}
				
				// Dessiner les liaisons C-C
				for (let i = 0; i < carbonPositions.length - 1; i++) {
					drawBond(
						carbonPositions[i].x, carbonPositions[i].y,
						carbonPositions[i+1].x, carbonPositions[i+1].y,
						3
					);
				}
				
				// Dessiner les atomes de carbone
				for (let i = 0; i < carbonPositions.length; i++) {
					drawAtom(carbonPositions[i].x, carbonPositions[i].y, carbonRadius, 'black');
				}
				
				// Dessiner les hydrogènes
				context.lineWidth = 1.5;
				for (let i = 0; i < carbonPositions.length; i++) {
					const pos = carbonPositions[i];
					let hydrogens = [];
					
					if (n === 1) {
						// Méthane: CH4
						hydrogens.push({ x: pos.x - hydrogenOffset, y: pos.y });
						hydrogens.push({ x: pos.x + hydrogenOffset, y: pos.y });
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					else if (i === 0 || i === carbonPositions.length - 1) {
						// Carbones terminaux (CH3)
						if (i === 0) {
							// Premier carbone
							let vec = {
								x: carbonPositions[1].x - pos.x,
								y: carbonPositions[1].y - pos.y
							};
							let len = Math.hypot(vec.x, vec.y);
							vec.x /= len; vec.y /= len;
							// Hydrogène dans la direction opposée
							hydrogens.push({ x: pos.x - vec.x * hydrogenOffset, y: pos.y - vec.y * hydrogenOffset });
						} else {
							// Dernier carbone
							let vec = {
								x: pos.x - carbonPositions[carbonPositions.length - 2].x,
								y: pos.y - carbonPositions[carbonPositions.length - 2].y
							};
							let len = Math.hypot(vec.x, vec.y);
							vec.x /= len; vec.y /= len;
							hydrogens.push({ x: pos.x + vec.x * hydrogenOffset, y: pos.y + vec.y * hydrogenOffset });
						}
						// Deux hydrogènes verticaux
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					else {
						// Carbones internes (CH2)
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					
					// Dessiner les liaisons C-H et les H
					hydrogens.forEach(h => {
						const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
						gradient.addColorStop(0, '#333');
						gradient.addColorStop(1, '#999');
						
						context.strokeStyle = gradient;
						context.beginPath();
						context.moveTo(pos.x, pos.y);
						context.lineTo(h.x, h.y);
						context.stroke();
						
						drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
					});
				}
				
				// Mettre à jour l'étiquette d'information
				let formula = n === 1 ? "CH<sub>4</sub>" : "C<sub>" + n + "</sub>H<sub>" + (2 * n + 2) + "</sub>";
				let name = n === 1 ? "Méthane" : n === 2 ? "Éthane" : n === 3 ? "Propane" : n === 4 ? "Butane" : n === 5 ? "Pentane" : n === 6 ? "Hexane" : n === 7 ? "Heptane" : n === 8 ? "Octane" : n === 9 ? "Nonane" : n === 10 ? "Décane" : "Alcane à " + n + " carbones";
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'alcane',
					carbonCount: n
				};
			}
			
			/* --------------------------------------------------------------------------
			   FAMILLE 2 : ALCÈNES
			-------------------------------------------------------------------------- */
			function drawAlcene(n, d) {
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// Vérifier que n est au moins 2 pour un alcène
				if (n < 2) {
					n = 2; // Un alcène a besoin d'au moins 2 carbones
				}
				
				// Calculer les positions des carbones
				let carbonPositions = computeChainPositions(n, 100, canvas.width - 100, canvas.height / 2);
				
				// Calcul du vecteur perpendiculaire pour la double liaison
				let doubleBondPerp = { x: 0, y: 0 };
				if (d >= 1 && d < n) {
					let dx = carbonPositions[d].x - carbonPositions[d - 1].x;
					let dy = carbonPositions[d].y - carbonPositions[d - 1].y;
					let norm = Math.hypot(dx, dy);
					const offsetDouble = 4;
					doubleBondPerp = { x: -dy / norm * offsetDouble, y: dx / norm * offsetDouble };
				}
				
				// Dessiner les liaisons C-C
				for (let i = 0; i < n - 1; i++) {
					const startX = carbonPositions[i].x;
					const startY = carbonPositions[i].y;
					const endX = carbonPositions[i+1].x;
					const endY = carbonPositions[i+1].y;
					
					if (i === d - 1) {
						// Double liaison
						drawDoubleBond(startX, startY, endX, endY, 2, 4);
					} else {
						// Liaison simple
						drawBond(startX, startY, endX, endY, 3);
					}
				}
				
				// Dessiner les atomes de carbone
				for (let i = 0; i < n; i++) {
					drawAtom(carbonPositions[i].x, carbonPositions[i].y, carbonRadius, 'black');
				}
				
				// Dessiner les hydrogènes
				context.lineWidth = 1.5;
				for (let i = 0; i < n; i++) {
					let pos = carbonPositions[i];
					let hydrogens = [];
					let inDouble = (i === d - 1) || (i === d);
					let hCount;
					if (inDouble) {
						// Carbone impliqué dans la double liaison
						if ((i === 0 && d === 1) || (i === n - 1 && d === n - 1)) {
							hCount = 2; // Terminal (CH₂)
						} else {
							hCount = 1; // Interne (CH)
						}
					} else {
						// Carbone non impliqué dans la double liaison
						if (i === 0 || i === n - 1) {
							hCount = 3; // CH₃
						} else {
							hCount = 2; // CH₂
						}
					}
					
					// Placement des hydrogènes
					if (inDouble && hCount === 1) {
						// Pour un carbone doublement lié interne: placer l'hydrogène perpendiculairement
						if (d >= 1 && d < n) {
							if (i === d - 1) {
								hydrogens.push({ x: pos.x + doubleBondPerp.x * 2, y: pos.y + doubleBondPerp.y * 2 });
							} else if (i === d) {
								hydrogens.push({ x: pos.x - doubleBondPerp.x * 2, y: pos.y - doubleBondPerp.y * 2 });
							}
						}
					} else if (!inDouble && (i === 0 || i === n - 1)) {
						// Carbone terminal non impliqué (CH₃)
						let vec;
						if (i === 0) {
							vec = { x: pos.x - carbonPositions[1].x, y: pos.y - carbonPositions[1].y };
						} else {
							vec = { x: pos.x - carbonPositions[n - 2].x, y: pos.y - carbonPositions[n - 2].y };
						}
						let normVec = normalize(vec);
						let opp = { x: normVec.x * hydrogenOffset, y: normVec.y * hydrogenOffset };
						hydrogens.push({ x: pos.x + opp.x, y: pos.y + opp.y });
						// Deux hydrogènes verticaux
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else if (!inDouble && (i !== 0 && i !== n - 1)) {
						// Carbone interne non impliqué (CH₂)
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else if (inDouble && hCount === 2) {
						// Carbone terminal impliqué (CH₂)
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					
					// Dessiner les liaisons C-H et les H
					hydrogens.forEach(h => {
						const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
						gradient.addColorStop(0, '#333');
						gradient.addColorStop(1, '#999');
						
						context.strokeStyle = gradient;
						context.beginPath();
						context.moveTo(pos.x, pos.y);
						context.lineTo(h.x, h.y);
						context.stroke();
						
						drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
					});
				}
				
				// Mettre à jour l'étiquette d'information
				let formula = "C<sub>" + n + "</sub>H<sub>" + (2 * n) + "</sub>";
				// Normalisation de la position
				let norm_d = d;
				if (d > n / 2) {
					norm_d = n - d;
				}
				let name = "";
				if (n === 2) {
					name = "éthène";
				} else {
					name = norm_d + "-" + (n === 3 ? "prop" : n === 4 ? "but" : n === 5 ? "pent" : n === 6 ? "hex" : n === 7 ? "hept" : n === 8 ? "oct" : n === 9 ? "non" : n === 10 ? "déc" : (n + "-carbon")) + "ène";
				}
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'alcene',
					carbonCount: n,
					doubleBondPos: d
				};
			}
			
			/* --------------------------------------------------------------------------
			   FAMILLE 3 : ALCYNES
			-------------------------------------------------------------------------- */
			function drawAlcyne(n, d) {
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// Calculer les positions des carbones
				let carbonPositions = computeChainPositions(n, 100, canvas.width - 100, canvas.height / 2);
				const tripleOffset = 4;
				
				// Dessiner les liaisons C-C
				for (let i = 0; i < n - 1; i++) {
					const startX = carbonPositions[i].x;
					const startY = carbonPositions[i].y;
					const endX = carbonPositions[i+1].x;
					const endY = carbonPositions[i+1].y;
					
					if (i === d - 1) {
						// Triple liaison
						let dx = carbonPositions[i + 1].x - carbonPositions[i].x;
						let dy = carbonPositions[i + 1].y - carbonPositions[i].y;
						let norm = Math.hypot(dx, dy);
						// Vecteur perpendiculaire
						let perp = { x: -dy / norm * tripleOffset, y: dx / norm * tripleOffset };
						
						// Liaison centrale
						drawBond(startX, startY, endX, endY, 2);
						
						// Liaisons latérales
						context.lineWidth = 2;
						
						// Liaison supérieure
						context.beginPath();
						context.moveTo(startX + perp.x, startY + perp.y);
						context.lineTo(endX + perp.x, endY + perp.y);
						context.stroke();
						
						// Liaison inférieure
						context.beginPath();
						context.moveTo(startX - perp.x, startY - perp.y);
						context.lineTo(endX - perp.x, endY - perp.y);
						context.stroke();
					} else {
						// Liaison simple
						drawBond(startX, startY, endX, endY, 3);
					}
				}
				
				// Dessiner les atomes de carbone
				for (let i = 0; i < n; i++) {
					drawAtom(carbonPositions[i].x, carbonPositions[i].y, carbonRadius, 'black');
				}
				
				// Dessiner les hydrogènes
				context.lineWidth = 1.5;
				for (let i = 0; i < n; i++) {
					const pos = carbonPositions[i];
					let hydrogens = [];
					let inTriple = (i === d - 1 || i === d);
					let hCount;
					
					if (inTriple) {
						// Carbone impliqué dans la triple liaison
						if (i === 0 || i === n - 1) {
							hCount = 1; // Terminal triple : CH
						} else {
							hCount = 0; // Interne triple : aucun hydrogène
						}
					} else {
						// Carbone non impliqué dans la triple liaison
						if (i === 0 || i === n - 1) {
							hCount = 3; // Terminal : CH₃
						} else {
							hCount = 2; // Interne : CH₂
						}
					}
					
					// Placement des hydrogènes
					if (inTriple && hCount === 1) {
						// Pour un carbone triple lié terminal
						if (d >= 1 && d < n) {
							let dx = carbonPositions[d].x - carbonPositions[d - 1].x;
							let dy = carbonPositions[d].y - carbonPositions[d - 1].y;
							let norm = Math.hypot(dx, dy);
							let perp = { x: -dy / norm * tripleOffset * 2, y: dx / norm * tripleOffset * 2 };
							if (i === d - 1) {
								hydrogens.push({ x: pos.x + perp.x * 2, y: pos.y + perp.y * 2 });
							} else if (i === d) {
								hydrogens.push({ x: pos.x - perp.x * 2, y: pos.y - perp.y * 2 });
							}
						}
					} else if (!inTriple && (i === 0 || i === n - 1)) {
						// Carbone terminal non triple : groupe CH₃
						let vec;
						if (i === 0) {
							vec = { x: pos.x - carbonPositions[1].x, y: pos.y - carbonPositions[1].y };
						} else {
							vec = { x: pos.x - carbonPositions[n - 2].x, y: pos.y - carbonPositions[n - 2].y };
						}
						let normVec = normalize(vec);
						let opp = { x: normVec.x * hydrogenOffset, y: normVec.y * hydrogenOffset };
						hydrogens.push({ x: pos.x + opp.x, y: pos.y + opp.y });
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else if (!inTriple && (i !== 0 && i !== n - 1)) {
						// Carbone interne non triple : groupe CH₂
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					
					// Dessiner les liaisons C-H et les H
					hydrogens.forEach(h => {
						const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
						gradient.addColorStop(0, '#333');
						gradient.addColorStop(1, '#999');
						
						context.strokeStyle = gradient;
						context.beginPath();
						context.moveTo(pos.x, pos.y);
						context.lineTo(h.x, h.y);
						context.stroke();
						
						drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
					});
				}
				
				// Mettre à jour l'étiquette d'information
				let formula = "C<sub>" + n + "</sub>H<sub>" + (2 * n - 2) + "</sub>";
				// Normalisation de la position
				let norm_d = d;
				if (d > n / 2) {
					norm_d = n - d;
				}
				let name = "";
				if (n === 2) {
					name = "éthyne";
				} else {
					name = norm_d + "-" + (n === 3 ? "prop" : n === 4 ? "but" : n === 5 ? "pent" : n === 6 ? "hex" : n === 7 ? "hept" : n === 8 ? "oct" : n === 9 ? "non" : n === 10 ? "déc" : (n + "-carbon")) + "yne";
				}
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'alcyne',
					carbonCount: n,
					tripleBondPos: d
				};
			}
			
			/* --------------------------------------------------------------------------
			   FAMILLE 4 : ALCOOLS
			-------------------------------------------------------------------------- */
			function drawAlcool(n, position) {
				// Ensure position is valid (between 1 and n)
				position = Math.max(1, Math.min(n, position || 1));
				
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// Calculer les positions des carbones
				let carbonPositions = [];
				if (n === 1) {
					carbonPositions.push({ x: canvas.width / 2, y: canvas.height / 2 });
				} else {
					carbonPositions = computeChainPositions(n, 100, canvas.width - 100, canvas.height / 2);
				}
				
				// Dessiner les liaisons C-C
				for (let i = 0; i < carbonPositions.length - 1; i++) {
					drawBond(
						carbonPositions[i].x, carbonPositions[i].y,
						carbonPositions[i+1].x, carbonPositions[i+1].y,
						3
					);
				}
				
				// Dessiner les atomes de carbone
				for (let i = 0; i < carbonPositions.length; i++) {
					drawAtom(carbonPositions[i].x, carbonPositions[i].y, carbonRadius, 'black');
				}
				
				// Position de l'oxygène et de l'hydrogène du groupe OH
				const targetCarbon = carbonPositions[position - 1]; // Converted to 0-based index
				
				// Calculate appropriate direction for the OH group
				let oxygenOffsetX, oxygenOffsetY;
				
				if (position === 1) {
					// For first carbon, place OH to the left
					oxygenOffsetX = -40;
					oxygenOffsetY = -40;
				} else if (position === n) {
					// For last carbon, place OH to the right
					oxygenOffsetX = 40;
					oxygenOffsetY = -40;
				} else {
					// For middle carbons, place OH upward or based on zigzag pattern
					oxygenOffsetX = 0;
					oxygenOffsetY = -40;
					
					// If we're in zigzag pattern and on an odd position, adjust for the angle
					if (position % 2 === 1) {
						oxygenOffsetX = -20;
						oxygenOffsetY = -40;
					} else {
						oxygenOffsetX = 20;
						oxygenOffsetY = -40;
					}
				}
				
				const oxygenPos = { 
					x: targetCarbon.x + oxygenOffsetX, 
					y: targetCarbon.y + oxygenOffsetY 
				};
				
				// Liaison carbone-oxygène
				context.lineWidth = 2;
				context.beginPath();
				context.moveTo(targetCarbon.x, targetCarbon.y);
				context.lineTo(oxygenPos.x, oxygenPos.y);
				context.strokeStyle = '#3366cc';
				context.stroke();
				
				// Dessiner l'atome d'oxygène
				drawAtom(oxygenPos.x, oxygenPos.y, oxygenRadius, 'red');
				
				// Position de l'hydrogène du groupe hydroxyle - prolongement dans la direction opposée au carbone
				// On calcule un vecteur normalisé de C vers O
				let vecCO = {
					x: oxygenPos.x - targetCarbon.x,
					y: oxygenPos.y - targetCarbon.y
				};
				
				// Normaliser le vecteur
				let lenCO = Math.hypot(vecCO.x, vecCO.y);
				vecCO.x /= lenCO;
				vecCO.y /= lenCO;
				
				// Placer H dans la même direction que CO, mais à partir de O (donc O-H s'éloigne de C)
				const hydroxyleHydrogenPos = {
					x: oxygenPos.x + vecCO.x * 20, 
					y: oxygenPos.y + vecCO.y * 20
				};
				
				// Liaison oxygène-hydrogène
				context.lineWidth = 1.5;
				context.beginPath();
				context.moveTo(oxygenPos.x, oxygenPos.y);
				context.lineTo(hydroxyleHydrogenPos.x, hydroxyleHydrogenPos.y);
				context.strokeStyle = '#3366cc';
				context.stroke();
				
				// Dessiner l'hydrogène du groupe hydroxyle
				drawAtom(hydroxyleHydrogenPos.x, hydroxyleHydrogenPos.y, hydrogenRadius, '#e0e0e0');
				
				// Dessiner les hydrogènes sur les carbones
				context.lineWidth = 1.5;
				for (let i = 0; i < carbonPositions.length; i++) {
					const pos = carbonPositions[i];
					let hydrogens = [];
					
					if (i === position - 1) {
						// Carbon with OH group has one less hydrogen
						// Calcul du vecteur C-O pour orienter les hydrogènes en opposition
						let vecCO = {
							x: oxygenPos.x - pos.x,
							y: oxygenPos.y - pos.y
						};
						let lenCO = Math.hypot(vecCO.x, vecCO.y);
						vecCO.x /= lenCO;
						vecCO.y /= lenCO;
						
						// Vecteur perpendiculaire pour placer les hydrogènes
						let perpVec = { x: -vecCO.y, y: vecCO.x };
						
						// Vecteur inverse pour placer un hydrogène vers le bas
						let inverseVec = { x: -vecCO.x, y: -vecCO.y };
						
						if (n === 1) {
							// Methanol (CH3OH): 3 hydrogens on carbon
							// On place un H en opposition au groupe OH (vers le bas)
							hydrogens.push({ x: pos.x + inverseVec.x * hydrogenOffset, y: pos.y + inverseVec.y * hydrogenOffset });
							// Les deux autres de chaque côté
							hydrogens.push({ x: pos.x + perpVec.x * hydrogenOffset, y: pos.y + perpVec.y * hydrogenOffset });
							hydrogens.push({ x: pos.x - perpVec.x * hydrogenOffset, y: pos.y - perpVec.y * hydrogenOffset });
						} else if (i === 0) {
							// Terminal carbon with OH: needs 2 hydrogens
							let vec = {
								x: carbonPositions[1].x - pos.x,
								y: carbonPositions[1].y - pos.y
							};
							let len = Math.hypot(vec.x, vec.y);
							vec.x /= len; vec.y /= len;
							
							// Add one hydrogen towards the bottom relative to OH
							hydrogens.push({ x: pos.x + inverseVec.x * hydrogenOffset, y: pos.y + inverseVec.y * hydrogenOffset });
							// Second hydrogen perpendicular to both OH and chain direction
							let crossVec = {
								x: vecCO.y * vec.z - vecCO.z * vec.y,
								y: vecCO.z * vec.x - vecCO.x * vec.z,
								z: vecCO.x * vec.y - vecCO.y * vec.x
							};
							if (!crossVec.z) crossVec.z = 0;
							let crossLen = Math.hypot(crossVec.x, crossVec.y, crossVec.z);
							if (crossLen > 0) {
								hydrogens.push({ 
									x: pos.x + (crossVec.x / crossLen) * hydrogenOffset, 
									y: pos.y + (crossVec.y / crossLen) * hydrogenOffset 
								});
							} else {
								// Fallback if vectors are parallel
								hydrogens.push({ x: pos.x + perpVec.x * hydrogenOffset, y: pos.y + perpVec.y * hydrogenOffset });
							}
						} else if (i === carbonPositions.length - 1) {
							// Terminal carbon with OH: needs 2 hydrogens
							let vec = {
								x: pos.x - carbonPositions[carbonPositions.length - 2].x,
								y: pos.y - carbonPositions[carbonPositions.length - 2].y
							};
							let len = Math.hypot(vec.x, vec.y);
							vec.x /= len; vec.y /= len;
							
							// Add one hydrogen towards the bottom relative to OH
							hydrogens.push({ x: pos.x + inverseVec.x * hydrogenOffset, y: pos.y + inverseVec.y * hydrogenOffset });
							// Add second hydrogen perpendicular to the plane
							hydrogens.push({ x: pos.x + perpVec.x * hydrogenOffset, y: pos.y + perpVec.y * hydrogenOffset });
						} else {
							// Internal carbon with OH: needs 1 hydrogen in opposite direction to OH (down)
							hydrogens.push({ x: pos.x + inverseVec.x * hydrogenOffset, y: pos.y + inverseVec.y * hydrogenOffset });
						}
					} else if (i === 0) {
						// First carbon (CH3) without OH
						let vec = {
							x: carbonPositions[1].x - pos.x,
							y: carbonPositions[1].y - pos.y
						};
						let len = Math.hypot(vec.x, vec.y);
						vec.x /= len; vec.y /= len;
						
						hydrogens.push({ x: pos.x - vec.x * hydrogenOffset, y: pos.y - vec.y * hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else if (i === carbonPositions.length - 1) {
						// Last carbon (CH3) without OH
						let vec = {
							x: pos.x - carbonPositions[carbonPositions.length - 2].x,
							y: pos.y - carbonPositions[carbonPositions.length - 2].y
						};
						let len = Math.hypot(vec.x, vec.y);
						vec.x /= len; vec.y /= len;
						
						hydrogens.push({ x: pos.x + vec.x * hydrogenOffset, y: pos.y + vec.y * hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else {
						// Internal carbons (CH2) without OH
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					
					// Dessiner les liaisons C-H et les H
					hydrogens.forEach(h => {
						const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
						gradient.addColorStop(0, '#333');
						gradient.addColorStop(1, '#999');
						
						context.strokeStyle = gradient;
						context.beginPath();
						context.moveTo(pos.x, pos.y);
						context.lineTo(h.x, h.y);
						context.stroke();
						
						drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
					});
				}
				
				// Mettre à jour l'étiquette d'information
				let formula = "";
				if (n === 1) {
					formula = "CH<sub>3</sub>OH";
				} else {
					formula = "C<sub>" + n + "</sub>H<sub>" + (2 * n + 1) + "</sub>OH";
				}
				
				// Update name based on position
				let name;
				if (n === 1) {
					name = "Méthanol";
				} else if (n === 2) {
					name = "Éthanol";
				} else {
					// For longer chains, use systematic naming with position
					name = (n === 3 ? "propan" : n === 4 ? "butan" : n === 5 ? "pentan" : n === 6 ? "hexan" : n === 7 ? "heptan" : n === 8 ? "octan" : n === 9 ? "nonan" : n === 10 ? "décan" : "alcane") + "-" + position + "-ol";
				}
				
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'alcool',
					carbonCount: n,
					alcoholPos: position
				};
			}
			
			/* --------------------------------------------------------------------------
			   FAMILLE 5 : ALDÉHYDES ET CÉTONES
			-------------------------------------------------------------------------- */
			function drawAldehydeCetone(n, funcPos, type) {
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// Calculer les positions des carbones
				let carbonPositions = computeChainPositions(n, 100, canvas.width - 100, canvas.height / 2);
				
				// Dessiner les liaisons C-C
				for (let i = 0; i < n - 1; i++) {
					drawBond(
						carbonPositions[i].x, carbonPositions[i].y,
						carbonPositions[i+1].x, carbonPositions[i+1].y,
						3
					);
				}
				
				// Dessiner les atomes de carbone
				for (let i = 0; i < n; i++) {
					drawAtom(carbonPositions[i].x, carbonPositions[i].y, carbonRadius, 'black');
				}
				
				// Détermine l'index du carbone porteur du groupe fonctionnel
				let funcIndex;
				if (type === "aldehyde") {
					// Pour un aldéhyde, le groupe est terminal: 1 → premier carbone, 2 → dernier carbone
					funcIndex = (parseInt(funcPos) === 1) ? 0 : n - 1;
				} else if (type === "ketone") {
					funcIndex = parseInt(funcPos) - 1;
				}
				
				// Dessiner les hydrogènes sur les carbones non fonctionnels
				context.lineWidth = 1.5;
				for (let i = 0; i < n; i++) {
					if ((type === "aldehyde" && (i === 0 || i === n - 1) && i === funcIndex) ||
						(type === "ketone" && i === funcIndex)) {
						continue; // Sauter les carbones fonctionnels
					}
					
					const pos = carbonPositions[i];
					let hCount;
					if (type === "aldehyde") {
						hCount = (i === 0 || i === n - 1) ? 3 : 2;
					} else if (type === "ketone") {
						hCount = ((i === 0 || i === n - 1) ? 3 : 2);
					}
					
					const hydrogens = [];
					if (i === 0) {
						let vec = { x: carbonPositions[1].x - pos.x, y: carbonPositions[1].y - pos.y };
						let norm = Math.hypot(vec.x, vec.y);
						vec.x /= norm; vec.y /= norm;
						hydrogens.push({ x: pos.x - vec.x * hydrogenOffset, y: pos.y - vec.y * hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else if (i === n - 1) {
						let vec = { x: carbonPositions[n-2].x - pos.x, y: carbonPositions[n-2].y - pos.y };
						let norm = Math.hypot(vec.x, vec.y);
						vec.x /= norm; vec.y /= norm;
						hydrogens.push({ x: pos.x - vec.x * hydrogenOffset, y: pos.y - vec.y * hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					} else {
						hydrogens.push({ x: pos.x, y: pos.y - hydrogenOffset });
						hydrogens.push({ x: pos.x, y: pos.y + hydrogenOffset });
					}
					
					// Dessiner les liaisons C-H et les H
					hydrogens.forEach(h => {
						const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
						gradient.addColorStop(0, '#333');
						gradient.addColorStop(1, '#999');
						
						context.strokeStyle = gradient;
						context.beginPath();
						context.moveTo(pos.x, pos.y);
						context.lineTo(h.x, h.y);
						context.stroke();
						
						drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
					});
				}
				
				// Dessiner le groupe fonctionnel
				if (type === "aldehyde") {
					// Pour un aldéhyde: carbone lié à une double liaison vers O et un H
					let pos = carbonPositions[funcIndex];
					// Calcul du vecteur directeur
					let v;
					if (funcIndex === 0) {
						v = { x: carbonPositions[1].x - pos.x, y: carbonPositions[1].y - pos.y };
					} else {
						v = { x: carbonPositions[n-2].x - pos.x, y: carbonPositions[n-2].y - pos.y };
					}
					let norm = Math.hypot(v.x, v.y);
					v.x /= norm; v.y /= norm;
					// Vecteur perpendiculaire
					let p = { x: -v.y, y: v.x };
					let ox = pos.x + p.x * hydrogenOffset;
					let oy = pos.y + p.y * hydrogenOffset;
					// Hydrogène dans la direction opposée
					let hx = pos.x - p.x * hydrogenOffset;
					let hy = pos.y - p.y * hydrogenOffset;
					
					// Dessiner la double liaison C=O
					drawDoubleBond(pos.x, pos.y, ox, oy);
					
					// Dessiner l'atome d'oxygène
					drawAtom(ox, oy, oxygenRadius, 'red');
					
					// Dessiner la liaison C-H
					const gradient = context.createLinearGradient(pos.x, pos.y, hx, hy);
					gradient.addColorStop(0, '#333');
					gradient.addColorStop(1, '#999');
					
					context.strokeStyle = gradient;
					context.beginPath();
					context.moveTo(pos.x, pos.y);
					context.lineTo(hx, hy);
					context.stroke();
					
					// Dessiner l'atome d'hydrogène
					drawAtom(hx, hy, hydrogenRadius, '#e0e0e0');
				} else if (type === "ketone") {
					// Pour une cétone: carbone lié par double liaison à O, sans H
					let pos = carbonPositions[funcIndex];
					// Vecteur vertical
					let vec = (pos.y < canvas.height / 2) ? { x: 0, y: -1 } : { x: 0, y: 1 };
					let ox = pos.x + vec.x * hydrogenOffset;
					let oy = pos.y + vec.y * hydrogenOffset;
					
					// Dessiner la double liaison C=O
					drawDoubleBond(pos.x, pos.y, ox, oy);
					
					// Dessiner l'atome d'oxygène
					drawAtom(ox, oy, oxygenRadius, 'red');
				}
				
				// Mettre à jour l'étiquette d'information
				let formula = "C<sub>" + n + "</sub>H<sub>" + (2 * n) + "</sub>O";
				let name = "";
				if (type === "aldehyde") {
					let prefix = (n === 2) ? "acét" : (n === 3 ? "propan" : n === 4 ? "butan" : n === 5 ? "pentan" : n === 6 ? "hexan" : n === 7 ? "heptan" : n === 8 ? "octan" : n === 9 ? "nonan" : n === 10 ? "décan" : (n + "-carbone"));
					name = (n === 2) ? prefix + "aldéhyde" : prefix + "al";
				} else if (type === "ketone") {
					let locant = Math.min(parseInt(funcPos), n + 1 - parseInt(funcPos));
					let prefix = (n === 3 ? "propan" : n === 4 ? "butan" : n === 5 ? "pentan" : n === 6 ? "hexan" : n === 7 ? "heptan" : n === 8 ? "octan" : n === 9 ? "nonan" : n === 10 ? "décan" : (n + "-carbone"));
					name = prefix + "-" + locant + "-one";
				}
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'aldehyde-cetone',
					carbonCount: n,
					funcPos: funcPos,
					groupType: type
				};
			}
			
			/* --------------------------------------------------------------------------
			   FAMILLE 6 : ACIDES CARBOXYLIQUES
			-------------------------------------------------------------------------- */
			function drawAcide(n) {
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// Calculer les positions des carbones
				let carbonPositions = [];
				if (n === 1) {
					carbonPositions.push({ x: canvas.width / 2, y: canvas.height / 2 });
				} else {
					carbonPositions = computeChainPositions(n, 100, canvas.width - 100, canvas.height / 2);
				}
				
				// Dessiner les liaisons C-C
				for (let i = 0; i < carbonPositions.length - 1; i++) {
					drawBond(
						carbonPositions[i].x, carbonPositions[i].y,
						carbonPositions[i+1].x, carbonPositions[i+1].y,
						2
					);
				}
				
				// Dessiner les atomes de carbone
				for (let i = 0; i < carbonPositions.length; i++) {
					drawAtom(carbonPositions[i].x, carbonPositions[i].y, carbonRadius, 'black');
				}
				
				// Cas n = 1: acide méthanoïque HCOOH
				if (n === 1) {
					let pos = carbonPositions[0];
					// Pour orienter le groupement COOH vers la droite
					let baseVec = { x: 1, y: 0 };
					let theta = Math.PI / 6; // Angle de rotation (environ 30°)
					let vecDouble = rotateVector(baseVec, +theta);
					let vecOH = rotateVector(baseVec, -theta);
					let posO_double = {
						x: pos.x + vecDouble.x * hydrogenOffset,
						y: pos.y + vecDouble.y * hydrogenOffset
					};
					let posO_single = {
						x: pos.x + vecOH.x * hydrogenOffset,
						y: pos.y + vecOH.y * hydrogenOffset
					};
					
					// Dessiner le groupement COOH
					drawDoubleBond(pos.x, pos.y, posO_double.x, posO_double.y, 2, 3);
					drawAtom(posO_double.x, posO_double.y, oxygenRadius, 'red');
					drawBond(pos.x, pos.y, posO_single.x, posO_single.y, 2);
					drawAtom(posO_single.x, posO_single.y, oxygenRadius, 'red');
					
					let posH_OH = {
						x: posO_single.x + baseVec.x * 20,
						y: posO_single.y + baseVec.y * 20
					};
					
					// Dessiner la liaison O-H
					const gradient = context.createLinearGradient(posO_single.x, posO_single.y, posH_OH.x, posH_OH.y);
					gradient.addColorStop(0, '#800000');
					gradient.addColorStop(1, '#999');
					
					context.strokeStyle = gradient;
					context.lineWidth = 1.5;
					context.beginPath();
					context.moveTo(posO_single.x, posO_single.y);
					context.lineTo(posH_OH.x, posH_OH.y);
					context.stroke();
					
					drawAtom(posH_OH.x, posH_OH.y, hydrogenRadius, '#e0e0e0');
					
					// Ajout de l'hydrogène directement attaché au carbone
					let posH_extra = {
						x: pos.x - baseVec.x * hydrogenOffset,
						y: pos.y - baseVec.y * hydrogenOffset
					};
					
					// Dessiner la liaison C-H
					const gradientH = context.createLinearGradient(pos.x, pos.y, posH_extra.x, posH_extra.y);
					gradientH.addColorStop(0, '#333');
					gradientH.addColorStop(1, '#999');
					
					context.strokeStyle = gradientH;
					context.lineWidth = 1.5;
					context.beginPath();
					context.moveTo(pos.x, pos.y);
					context.lineTo(posH_extra.x, posH_extra.y);
					context.stroke();
					
					drawAtom(posH_extra.x, posH_extra.y, hydrogenRadius, '#e0e0e0');
				} else {
					// Pour n >= 2, dessiner les substituants
					for (let i = 0; i < carbonPositions.length; i++) {
						const pos = carbonPositions[i];
						// Carbone 0: groupe CH₃
						if (i === 0) {
							// Pour le CH₃, placer un hydrogène vers la gauche
							let H1 = { x: pos.x - hydrogenOffset, y: pos.y };
							let H2 = { x: pos.x, y: pos.y - hydrogenOffset };
							let H3 = { x: pos.x, y: pos.y + hydrogenOffset };
							
							// Dessiner les liaisons C-H
							context.lineWidth = 1.5;
							[H1, H2, H3].forEach(h => {
								const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
								gradient.addColorStop(0, '#333');
								gradient.addColorStop(1, '#999');
								
								context.strokeStyle = gradient;
								context.beginPath();
								context.moveTo(pos.x, pos.y);
								context.lineTo(h.x, h.y);
								context.stroke();
								
								drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
							});
						}
						// Dernier carbone: groupement carboxyle (COOH)
						else if (i === carbonPositions.length - 1) {
							// Calcul du vecteur directeur
							let baseVec = normalize({
								x: pos.x - carbonPositions[i-1].x,
								y: pos.y - carbonPositions[i-1].y
							});
							let theta = Math.PI / 6; // Angle de rotation (environ 30°)
							let vecDouble = rotateVector(baseVec, +theta);
							let vecOH = rotateVector(baseVec, -theta);
							let posO_double = {
								x: pos.x + vecDouble.x * hydrogenOffset,
								y: pos.y + vecDouble.y * hydrogenOffset
							};
							let posO_single = {
								x: pos.x + vecOH.x * hydrogenOffset,
								y: pos.y + vecOH.y * hydrogenOffset
							};
							
							// Dessiner la double liaison C=O
							drawDoubleBond(pos.x, pos.y, posO_double.x, posO_double.y, 2, 3);
							drawAtom(posO_double.x, posO_double.y, oxygenRadius, 'red');
							
							// Dessiner la liaison C-O
							drawBond(pos.x, pos.y, posO_single.x, posO_single.y, 2);
							drawAtom(posO_single.x, posO_single.y, oxygenRadius, 'red');
							
							let posH = {
								x: posO_single.x + baseVec.x * 20,
								y: posO_single.y + baseVec.y * 20
							};
							
							// Dessiner la liaison O-H
							const gradient = context.createLinearGradient(posO_single.x, posO_single.y, posH.x, posH.y);
							gradient.addColorStop(0, '#800000');
							gradient.addColorStop(1, '#999');
							
							context.strokeStyle = gradient;
							context.lineWidth = 1.5;
							context.beginPath();
							context.moveTo(posO_single.x, posO_single.y);
							context.lineTo(posH.x, posH.y);
							context.stroke();
							
							drawAtom(posH.x, posH.y, hydrogenRadius, '#e0e0e0');
						}
						// Carbones internes: groupe CH₂
						else {
							let H1 = { x: pos.x, y: pos.y - hydrogenOffset };
							let H2 = { x: pos.x, y: pos.y + hydrogenOffset };
							
							// Dessiner les liaisons C-H
							[H1, H2].forEach(h => {
								const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
								gradient.addColorStop(0, '#333');
								gradient.addColorStop(1, '#999');
								
								context.strokeStyle = gradient;
								context.lineWidth = 1.5;
								context.beginPath();
								context.moveTo(pos.x, pos.y);
								context.lineTo(h.x, h.y);
								context.stroke();
								
								drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
							});
						}
					}
				}
				
				// Mettre à jour l'étiquette d'information
				let formula = "";
				if (n === 1) {
					formula = "HCOOH";
				} else if (n === 2) {
					formula = "CH<sub>3</sub>COOH";
				} else {
					formula = "CH<sub>3</sub>–(CH<sub>2</sub>)<sub>" + (n - 2) + "</sub>–COOH";
				}
				let name = n === 1 ? "Acide méthanoïque" : n === 2 ? "Acide éthanoïque" : n === 3 ? "Acide propanoïque" : n === 4 ? "Acide butanoïque" : n === 5 ? "Acide pentanoïque" : n === 6 ? "Acide hexanoïque" : n === 7 ? "Acide heptanoïque" : n === 8 ? "Acide octanoïque" : n === 9 ? "Acide nonanoïque" : n === 10 ? "Acide décanoïque" : "Acide à " + n + " carbones";
				
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'acide',
					carbonCount: n
				};
			}
			
			/* --------------------------------------------------------------------------
			   FAMILLE 7 : ESTERS
			-------------------------------------------------------------------------- */
			function drawEster(nAcyl, nAlkoxy) {
				// Effacer le canvas
				context.clearRect(0, 0, canvas.width, canvas.height);
				
				// --- Groupe R1 (anciennement chaîne acyle) ---
				// Dessiner le Groupe R1 dans la zone de x de 100 à 400, y autour de 300
				const acylPositions = computeChainPositions(nAcyl, 100, 400, 300);
				
				// Dessiner les liaisons entre les carbones du Groupe R1
				for(let i = 0; i < acylPositions.length - 1; i++) {
					drawBond(acylPositions[i].x, acylPositions[i].y, acylPositions[i+1].x, acylPositions[i+1].y, 2);
				}
				
				// Dessiner les atomes de carbone du Groupe R1
				acylPositions.forEach(pos => drawAtom(pos.x, pos.y, carbonRadius, 'black'));
				
				// Dessiner les hydrogènes pour le Groupe R1
				drawEsterHydrogens(acylPositions, "acyl");
				
				// --- Groupe carboxyle ---
				// Le dernier atome du Groupe R1 est le carbone carbonyle
				const carbonylC = acylPositions[acylPositions.length - 1];
				const bondLength = 40;
				// Le double lien (C=O) sera dessiné vers le haut (angle -90°)
				const angleDouble = -Math.PI/2; // -90° en radians
				// Le simple lien (vers l'oxygène ester) sera orienté à 120° par rapport à la liaison double
				const angleSingle = angleDouble + (120 * Math.PI/180); // -90° + 120° = 30° environ
				const oxyCarbonyl = { 
					x: carbonylC.x + bondLength * Math.cos(angleDouble), 
					y: carbonylC.y + bondLength * Math.sin(angleDouble)
				};
				const oxyEster = { 
					x: carbonylC.x + bondLength * Math.cos(angleSingle), 
					y: carbonylC.y + bondLength * Math.sin(angleSingle)
				};
				
				// Dessiner la double liaison vers l'oxygène carbonyle
				drawDoubleBond(carbonylC.x, carbonylC.y, oxyCarbonyl.x, oxyCarbonyl.y, 2, 4);
				drawAtom(oxyCarbonyl.x, oxyCarbonyl.y, oxygenRadius, 'red');
				
				// Dessiner la simple liaison vers l'oxygène ester
				drawBond(carbonylC.x, carbonylC.y, oxyEster.x, oxyEster.y, 2);
				drawAtom(oxyEster.x, oxyEster.y, oxygenRadius, 'red');
				
				// --- Groupe R2 (anciennement chaîne alkoxy) ---
				// Le Groupe R2 part de l'oxygène ester
				// Pour laisser de l'espace, on décale horizontalement de 40 pixels
				const alkoxyStart = { x: oxyEster.x + 40, y: oxyEster.y };
				let alkoxyPositions = [];
				if(nAlkoxy === 1) {
					alkoxyPositions.push(alkoxyStart);
				} else {
					alkoxyPositions = computeChainPositions(nAlkoxy, alkoxyStart.x, alkoxyStart.x + 300, alkoxyStart.y);
				}
				
				// Dessiner la liaison entre l'oxygène ester et le premier carbone du Groupe R2
				drawBond(oxyEster.x, oxyEster.y, alkoxyPositions[0].x, alkoxyPositions[0].y, 2);
				
				// Dessiner les liaisons entre les carbones du Groupe R2
				for(let i = 0; i < alkoxyPositions.length - 1; i++) {
					drawBond(alkoxyPositions[i].x, alkoxyPositions[i].y, alkoxyPositions[i+1].x, alkoxyPositions[i+1].y, 2);
				}
				
				// Dessiner les atomes de carbone du Groupe R2
				alkoxyPositions.forEach(pos => drawAtom(pos.x, pos.y, carbonRadius, 'black'));
				
				// Dessiner les hydrogènes pour le Groupe R2
				drawEsterHydrogens(alkoxyPositions, "alkoxy");
				
				// Mettre à jour l'étiquette d'information
				const totalC = nAcyl + nAlkoxy;
				// Calcul simplifié du nombre d'hydrogènes
				const H_acyl = (nAcyl === 1) ? 1 : (nAcyl === 2 ? 3 : (3 + 2 * (nAcyl - 2)));
				const H_alkoxy = (nAlkoxy === 1) ? 3 : (nAlkoxy === 2 ? (2 + 3) : (2 + 2 * (nAlkoxy - 2) + 3));
				const totalH = H_acyl + H_alkoxy;
				const totalO = 2;
				
				const formula = "C<sub>" + totalC + "</sub>H<sub>" + totalH + "</sub>O<sub>" + totalO + "</sub>";
				
				// Noms des groupes acyle et alkoxy
				let acylName = nAcyl === 1 ? "formate" : nAcyl === 2 ? "acétate" : nAcyl === 3 ? "propanoate" : nAcyl === 4 ? "butanoate" : nAcyl === 5 ? "pentanoate" : nAcyl === 6 ? "hexanoate" : nAcyl === 7 ? "heptanoate" : nAcyl === 8 ? "octanoate" : nAcyl === 9 ? "nonanoate" : nAcyl === 10 ? "décanoate" : nAcyl + "-acylate";
				let alkoxyName = nAlkoxy === 1 ? "méthyl" : nAlkoxy === 2 ? "éthyl" : nAlkoxy === 3 ? "propyl" : nAlkoxy === 4 ? "butyl" : nAlkoxy === 5 ? "pentyl" : nAlkoxy === 6 ? "hexyl" : nAlkoxy === 7 ? "heptyl" : nAlkoxy === 8 ? "octyl" : nAlkoxy === 9 ? "nonyl" : nAlkoxy === 10 ? "décyl" : nAlkoxy + "-alkoxy";
				
				const name = alkoxyName + " " + acylName;
				
				infoLabel.innerHTML = "<span class='formula'>Formule brute : " + formula + "</span> - <span class='name'>" + name + "</span>";
				
				// Stocker les informations de la molécule actuelle pour la validation
				currentMoleculeData = {
					...currentMoleculeData,
					type: 'ester',
					acylCount: nAcyl,
					alkoxyCount: nAlkoxy
				};
			}
			
			// Fonction auxiliaire pour dessiner les hydrogènes des esters
			function drawEsterHydrogens(chainPositions, group) {
				// Calcul du centre de la chaîne
				let center = {x: 0, y: 0};
				chainPositions.forEach(pos => {
					center.x += pos.x;
					center.y += pos.y;
				});
				center.x /= chainPositions.length;
				center.y /= chainPositions.length;
				
				chainPositions.forEach((pos, i) => {
					let numH = 0;
					if(group === "acyl") {
						if(chainPositions.length === 1) {
							numH = 1; // Cas du formate
						} else {
							if(i === 0) numH = 3;         // Carbone terminal gauche CH₃
							else if(i === chainPositions.length - 1) numH = 0; // Carbone carbonyle sans H
							else numH = 2;               // CH₂
						}
					} else if(group === "alkoxy") {
						if(chainPositions.length === 1) {
							numH = 3; // CH₃
						} else {
							if(i === 0) numH = 2;         // Carbone lié à l'oxygène (CH₂)
							else if(i === chainPositions.length - 1) numH = 3; // Terminal CH₃
							else numH = 2;               // CH₂
						}
					}
					
					// Calcul de la direction pour placer les hydrogènes
					let dir = {x: 0, y: 0};
					// Pour les atomes terminaux, utiliser le vecteur du centre vers l'atome
					if(i === 0 || i === chainPositions.length - 1) {
						dir.x = pos.x - center.x;
						dir.y = pos.y - center.y;
						let len = Math.hypot(dir.x, dir.y);
						if(len !== 0) { 
							dir.x /= len; 
							dir.y /= len; 
						}
					} else {
						// Pour les atomes internes, on moyenne le vecteur précédent et le vecteur vers le suivant
						let v1 = { x: pos.x - chainPositions[i-1].x, y: pos.y - chainPositions[i-1].y };
						let v2 = { x: chainPositions[i+1].x - pos.x, y: chainPositions[i+1].y - pos.y };
						let len1 = Math.hypot(v1.x, v1.y);
						let len2 = Math.hypot(v2.x, v2.y);
						if(len1 !== 0 && len2 !== 0) {
							dir.x = (v1.x/len1 + v2.x/len2) / 2;
							dir.y = (v1.y/len1 + v2.y/len2) / 2;
							let len = Math.hypot(dir.x, dir.y);
							if(len !== 0) { 
								dir.x /= len; 
								dir.y /= len; 
							}
						} else if(len1 !== 0) {
							dir.x = v1.x/len1; dir.y = v1.y/len1;
						} else if(len2 !== 0) {
							dir.x = v2.x/len2; dir.y = v2.y/len2;
						}
					}
					
					// Calcul du vecteur perpendiculaire à dir
					let perp = { x: -dir.y, y: dir.x };
					
					let hydrogens = [];
					const offset = 30;
					if(numH === 1) {
						// Cas CH (formate)
						hydrogens.push({ x: pos.x + dir.x * offset, y: pos.y + dir.y * offset });
					} else if(numH === 2) {
						// CH₂
						hydrogens.push({ x: pos.x + perp.x * offset, y: pos.y + perp.y * offset });
						hydrogens.push({ x: pos.x - perp.x * offset, y: pos.y - perp.y * offset });
					} else if(numH === 3) {
						// CH₃
						hydrogens.push({ x: pos.x - dir.x * offset, y: pos.y - dir.y * offset });
						hydrogens.push({ x: pos.x + perp.x * offset, y: pos.y + perp.y * offset });
						hydrogens.push({ x: pos.x - perp.x * offset, y: pos.y - perp.y * offset });
					}
					
					// Dessiner les liaisons C-H et les H
					hydrogens.forEach(h => {
						const gradient = context.createLinearGradient(pos.x, pos.y, h.x, h.y);
						gradient.addColorStop(0, '#333');
						gradient.addColorStop(1, '#999');
						
						context.strokeStyle = gradient;
						context.lineWidth = 1.5;
						context.beginPath();
						context.moveTo(pos.x, pos.y);
						context.lineTo(h.x, h.y);
						context.stroke();
						
						drawAtom(h.x, h.y, hydrogenRadius, '#e0e0e0');
					});
				});
			}
			
			/* --------------------------------------------------------------------------
			   FONCTIONS UTILITAIRES
			-------------------------------------------------------------------------- */
			// Fonction pour changer le type de molécule
			function changeMoleculeType(type) {
				// Mettre à jour le type actuel
				currentMoleculeType = type;
				currentMoleculeData.type = type;
				
				// Cacher tous les panneaux de contrôle
				document.querySelectorAll('.control-group').forEach(group => {
					group.classList.remove('active');
				});
				
				// Afficher le panneau de contrôle correspondant au type
				document.getElementById(\`\${type}-controls\`).classList.add('active');
				
				// Mettre à jour les boutons de sélection
				document.querySelectorAll('.molecule-button').forEach(button => {
					button.classList.remove('active');
				});
				document.querySelector(\`.molecule-button[data-type="\${type}"]\`).classList.add('active');
				
				// Dessiner la molécule
				drawCurrentMolecule();
			}
			
			// Adapter la taille du canvas au redimensionnement de la fenêtre
			function resizeCanvas() {
				const container = document.querySelector('.canvas-container');
				const containerWidth = container.offsetWidth;
				if (containerWidth < 800) {
					const ratio = 400 / 800;
					canvas.style.width = containerWidth + 'px';
					canvas.style.height = (containerWidth * ratio) + 'px';
				} else {
					canvas.style.width = '800px';
					canvas.style.height = '400px';
				}
			}
			
			// Mettre à jour la plage du slider de la position de la double liaison (alcènes)
			function updateAlceneDoubleBondSliderMax() {
				const n = parseInt(document.getElementById('alcene-carbonSlider').value);
				const doubleBondSlider = document.getElementById('alcene-doubleBondSlider');
				doubleBondSlider.max = n - 1;
				if (parseInt(doubleBondSlider.value) > n - 1) {
					doubleBondSlider.value = n - 1;
					currentMoleculeData.doubleBondPos = n - 1;
				}
				document.getElementById('alcene-doubleBondCount').textContent = doubleBondSlider.value;
			}
			
			// Mettre à jour la plage du slider de la position de la triple liaison (alcynes)
			function updateAlcyneTripleBondSliderMax() {
				const n = parseInt(document.getElementById('alcyne-carbonSlider').value);
				const tripleBondSlider = document.getElementById('alcyne-tripleBondSlider');
				tripleBondSlider.max = n - 1;
				if (parseInt(tripleBondSlider.value) > n - 1) {
					tripleBondSlider.value = n - 1;
					currentMoleculeData.tripleBondPos = n - 1;
				}
				document.getElementById('alcyne-tripleBondCount').textContent = tripleBondSlider.value;
			}
			
			// Ajuster les sliders pour aldéhydes et cétones
			function updateAldehydeCetoneSliders() {
				const carbonSlider = document.getElementById('aldehyde-cetone-carbonSlider');
				const funcSlider = document.getElementById('aldehyde-cetone-funcSlider');
				const funcSliderLabel = document.getElementById('aldehyde-cetone-funcSliderLabel');
				const type = document.getElementById('aldehydeRadio').checked ? 'aldehyde' : 'ketone';
				const n = parseInt(carbonSlider.value);
				
				if (type === "aldehyde") {
					// Pour un aldéhyde, le groupe est terminal
					carbonSlider.min = 2;
					if (parseInt(carbonSlider.value) < 2) {
						carbonSlider.value = 2;
						currentMoleculeData.carbonCount = 2;
					}
					funcSlider.min = 1;
					funcSlider.max = 2;
					if (parseInt(funcSlider.value) > 2) {
						funcSlider.value = 1;
						currentMoleculeData.funcPos = 1;
					}
					funcSliderLabel.textContent = "Position du groupe (1 : premier carbone, 2 : dernier carbone) : ";
				} else if (type === "ketone") {
					// Pour une cétone, le groupe est sur un carbone interne (n ≥ 3)
					carbonSlider.min = 3;
					if (parseInt(carbonSlider.value) < 3) {
						carbonSlider.value = 3;
						currentMoleculeData.carbonCount = 3;
					}
					funcSlider.min = 2;
					funcSlider.max = n - 1;
					if (parseInt(funcSlider.value) < 2 || parseInt(funcSlider.value) > n - 1) {
						funcSlider.value = 2;
						currentMoleculeData.funcPos = 2;
					}
					funcSliderLabel.textContent = "Position du groupe (entre 2 et n-1) : ";
				}
				
				document.getElementById('aldehyde-cetone-carbonCount').textContent = carbonSlider.value;
				document.getElementById('aldehyde-cetone-funcPosDisplay').textContent = funcSlider.value;
			}
			
			// Fonction pour dessiner la molécule actuelle
			function drawCurrentMolecule() {
				// Appeler la fonction appropriée selon le type de molécule
				switch (currentMoleculeType) {
					case 'alcane':
						drawAlcane(currentMoleculeData.carbonCount);
						break;
					case 'alcene':
						drawAlcene(currentMoleculeData.carbonCount, currentMoleculeData.doubleBondPos);
						break;
					case 'alcyne':
						drawAlcyne(currentMoleculeData.carbonCount, currentMoleculeData.tripleBondPos);
						break;
					case 'alcool':
						drawAlcool(currentMoleculeData.carbonCount, currentMoleculeData.alcoholPos);
						break;
					case 'aldehyde-cetone':
						drawAldehydeCetone(
							currentMoleculeData.carbonCount, 
							currentMoleculeData.funcPos, 
							currentMoleculeData.groupType
						);
						break;
					case 'acide':
						drawAcide(currentMoleculeData.carbonCount);
						break;
					case 'ester':
						drawEster(currentMoleculeData.acylCount, currentMoleculeData.alkoxyCount);
						break;
				}
				
				// Si nous sommes sur une question active, vérifier si on peut activer le bouton de validation
				if (currentQuestion && currentQuestion.dataset.type === "1") {
					const validateBtn = currentQuestion.querySelector('.validate-btn');
					validateBtn.disabled = false;
				}
			}
			
			// Fonction qui dessine un atome (cercle plein avec bordure et ombre)
			function drawAtom(x, y, radius, color) {
				// Ombre
				context.shadowColor = 'rgba(0, 0, 0, 0.3)';
				context.shadowBlur = 5;
				context.shadowOffsetX = 2;
				context.shadowOffsetY = 2;
				
				// Cercle principal
				context.fillStyle = color;
				context.beginPath();
				context.arc(x, y, radius, 0, 2 * Math.PI);
				context.fill();
				
				// Bordure
				context.strokeStyle = color === 'black' ? '#333' : (color === 'red' ? '#800000' : '#999');
				context.lineWidth = 1;
				context.stroke();
				
				// Reflet (pour effet 3D)
				context.shadowColor = 'transparent';
				context.beginPath();
				context.arc(x - radius/3, y - radius/3, radius/2, 0, Math.PI/2);
				context.strokeStyle = 'rgba(255, 255, 255, 0.4)';
				context.stroke();
			}
			
			// Fonction pour dessiner une liaison simple avec gradient
			function drawBond(x1, y1, x2, y2, width = 2) {
				// Créer un dégradé pour la liaison
				const gradient = context.createLinearGradient(x1, y1, x2, y2);
				gradient.addColorStop(0, '#333');
				gradient.addColorStop(1, '#555');
				
				context.shadowColor = 'rgba(0, 0, 0, 0.2)';
				context.shadowBlur = 3;
				context.shadowOffsetX = 1;
				context.shadowOffsetY = 1;
				
				context.strokeStyle = gradient;
				context.lineWidth = width;
				context.beginPath();
				context.moveTo(x1, y1);
				context.lineTo(x2, y2);
				context.stroke();
				
				// Réinitialiser l'ombre
				context.shadowColor = 'transparent';
			}
			
			// Fonction pour dessiner une double liaison (deux segments parallèles)
			function drawDoubleBond(x1, y1, x2, y2, width = 2, gap = 3) {
				let dx = x2 - x1, dy = y2 - y1;
				let len = Math.hypot(dx, dy);
				let px = -dy / len, py = dx / len;
				
				// Créer un dégradé pour la liaison
				const gradient = context.createLinearGradient(x1, y1, x2, y2);
				gradient.addColorStop(0, '#333');
				gradient.addColorStop(1, '#800000');
				
				context.shadowColor = 'rgba(0, 0, 0, 0.2)';
				context.shadowBlur = 3;
				context.shadowOffsetX = 1;
				context.shadowOffsetY = 1;
				context.strokeStyle = gradient;
				context.lineWidth = width;
				
				// Première ligne décalée positivement
				context.beginPath();
				context.moveTo(x1 + px * gap, y1 + py * gap);
				context.lineTo(x2 + px * gap, y2 + py * gap);
				context.stroke();
				
				// Deuxième ligne décalée négativement
				context.beginPath();
				context.moveTo(x1 - px * gap, y1 - py * gap);
				context.lineTo(x2 - px * gap, y2 - py * gap);
				context.stroke();
				
				// Réinitialiser l'ombre
				context.shadowColor = 'transparent';
			}
			
			// Fonction qui calcule des positions pour une chaîne en zigzag
			function computeChainPositions(n, startX, endX, centerY, offset = 30) {
				let positions = [];
				if (n === 1) {
					positions.push({ x: (startX + endX) / 2, y: centerY });
				} else {
					const spacing = (endX - startX) / (n - 1);
					for (let i = 0; i < n; i++) {
						let x = startX + i * spacing;
						let y = (i % 2 === 0) ? centerY - offset : centerY + offset;
						positions.push({ x: x, y: y });
					}
				}
				return positions;
			}
			
			// Rotation d'un vecteur
			function rotateVector(vec, angle) {
				return {
					x: vec.x * Math.cos(angle) - vec.y * Math.sin(angle),
					y: vec.x * Math.sin(angle) + vec.y * Math.cos(angle)
				};
			}
			
			// Normalisation d'un vecteur
			function normalize(vec) {
				let len = Math.hypot(vec.x, vec.y);
				return { x: vec.x / len, y: vec.y / len };
			}
			
			/* ============================================================================
			   GESTION DES QUESTIONS
			============================================================================ */
			// Initialiser les écouteurs d'événements pour les questions
			function initQuestionEvents() {
				// Ajouter des écouteurs pour les questions
				document.querySelectorAll('.example-card').forEach(card => {
					card.addEventListener('click', (e) => {
						// Ignorer si la question a déjà été répondue
						if (answered.has(card)) {
							return;
						}
						
						// Ignorer si on a cliqué sur un bouton
						if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
							return;
						}
						
						// Retirer la classe active de toutes les questions
						document.querySelectorAll('.example-card').forEach(q => {
							q.classList.remove('active');
						});
						
						// Rendre cette question active
						currentQuestion = card;
						card.classList.add('active');
						
						// Pour les questions de type 1, activer le simulateur
						if (card.dataset.type === '1') {
							enableSimulator();
						}
					});
				});
				
				// Ajouter des écouteurs pour les boutons "Afficher la molécule"
				document.querySelectorAll('.show-molecule-btn').forEach(btn => {
					btn.addEventListener('click', () => {
						const card = btn.closest('.example-card');
						if (card && card.dataset.type === '2') {
							setupMoleculeForQuestion(card);
						}
					});
				});
			}
			
			// Préparation de la question suivante
			function setupNextQuestion() {
				// Si toutes les questions ont été répondues, sortir
				if (answered.size === 6) {
					return;
				}
				
				// Retirer la classe active de toutes les questions
				document.querySelectorAll('.example-card').forEach(q => {
					q.classList.remove('active');
				});
				
				// Trouver la prochaine question qui n'a pas encore été répondue
				const questions = document.querySelectorAll('.example-card');
				for (let i = 0; i < questions.length; i++) {
					const question = questions[i];
					if (!answered.has(question)) {
						// Question trouvée, la préparer selon son type
						currentQuestion = question;
						question.classList.add('active'); // Ajouter la classe active
						
						// Pour les questions de type 1, activer le simulateur
						if (question.dataset.type === '1') {
							enableSimulator();
						}
						break;
					}
				}
			}
			
			// Activer les contrôles du simulateur
			function enableSimulator() {
				const simulatorControls = document.querySelector('.molecule-selector');
				const controlPanel = document.querySelector('.control-panel');
				
				simulatorControls.style.pointerEvents = 'auto';
				simulatorControls.style.opacity = '1';
				controlPanel.style.pointerEvents = 'auto';
				controlPanel.style.opacity = '1';
			}
			
			// Configuration du simulateur pour une question de type 2
			function setupMoleculeForQuestion(questionCard) {
				// Configurer la molécule selon les données de la question
				const moleculeType = questionCard.dataset.moleculeType;
				
				// Changer le type de molécule
				changeMoleculeType(moleculeType);
				
				// Configurer les paramètres spécifiques selon le type
				switch (moleculeType) {
					case 'alcane':
						document.getElementById('alcane-carbonSlider').value = questionCard.dataset.carbonCount;
						document.getElementById('alcane-carbonCount').textContent = questionCard.dataset.carbonCount;
						currentMoleculeData.carbonCount = parseInt(questionCard.dataset.carbonCount);
						break;
					case 'alcene':
						document.getElementById('alcene-carbonSlider').value = questionCard.dataset.carbonCount;
						document.getElementById('alcene-carbonCount').textContent = questionCard.dataset.carbonCount;
						document.getElementById('alcene-doubleBondSlider').value = questionCard.dataset.doubleBond;
						document.getElementById('alcene-doubleBondCount').textContent = questionCard.dataset.doubleBond;
						currentMoleculeData.carbonCount = parseInt(questionCard.dataset.carbonCount);
						currentMoleculeData.doubleBondPos = parseInt(questionCard.dataset.doubleBond);
						break;
					case 'alcyne':
						document.getElementById('alcyne-carbonSlider').value = questionCard.dataset.carbonCount;
						document.getElementById('alcyne-carbonCount').textContent = questionCard.dataset.carbonCount;
						document.getElementById('alcyne-tripleBondSlider').value = questionCard.dataset.tripleBond;
						document.getElementById('alcyne-tripleBondCount').textContent = questionCard.dataset.tripleBond;
						currentMoleculeData.carbonCount = parseInt(questionCard.dataset.carbonCount);
						currentMoleculeData.tripleBondPos = parseInt(questionCard.dataset.tripleBond);
						break;
					case 'alcool':
						document.getElementById('alcool-carbonSlider').value = questionCard.dataset.carbonCount;
						document.getElementById('alcool-carbonCount').textContent = questionCard.dataset.carbonCount;
						document.getElementById('alcool-positionSlider').value = questionCard.dataset.position || 1;
						document.getElementById('alcool-positionCount').textContent = questionCard.dataset.position || 1;
						currentMoleculeData.carbonCount = parseInt(questionCard.dataset.carbonCount);
						currentMoleculeData.alcoholPos = parseInt(questionCard.dataset.position || 1);
						break;
					case 'aldehyde-cetone':
						document.getElementById('aldehyde-cetone-carbonSlider').value = questionCard.dataset.carbonCount;
						document.getElementById('aldehyde-cetone-carbonCount').textContent = questionCard.dataset.carbonCount;
						document.getElementById('aldehyde-cetone-funcSlider').value = questionCard.dataset.funcPos || 1;
						document.getElementById('aldehyde-cetone-funcPosDisplay').textContent = questionCard.dataset.funcPos || 1;
						
						if (questionCard.dataset.groupType === 'ketone') {
							document.getElementById('ketoneRadio').checked = true;
							currentMoleculeData.groupType = 'ketone';
						} else {
							document.getElementById('aldehydeRadio').checked = true;
							currentMoleculeData.groupType = 'aldehyde';
						}
						
						currentMoleculeData.carbonCount = parseInt(questionCard.dataset.carbonCount);
						currentMoleculeData.funcPos = parseInt(questionCard.dataset.funcPos || 1);
						break;
					case 'acide':
						document.getElementById('acide-carbonSlider').value = questionCard.dataset.carbonCount;
						document.getElementById('acide-carbonCount').textContent = questionCard.dataset.carbonCount;
						currentMoleculeData.carbonCount = parseInt(questionCard.dataset.carbonCount);
						break;
					case 'ester':
						document.getElementById('ester-acylSlider').value = questionCard.dataset.acylCount;
						document.getElementById('ester-acylCount').textContent = questionCard.dataset.acylCount;
						document.getElementById('ester-alkoxySlider').value = questionCard.dataset.alkoxyCount;
						document.getElementById('ester-alkoxyCount').textContent = questionCard.dataset.alkoxyCount;
						currentMoleculeData.acylCount = parseInt(questionCard.dataset.acylCount);
						currentMoleculeData.alkoxyCount = parseInt(questionCard.dataset.alkoxyCount);
						break;
				}
				
				// Redessiner la molécule
				drawCurrentMolecule();
			}
			
			/* ============================================================================
			   VALIDATION DES RÉPONSES
			============================================================================ */
			/* --------------------------------------------------------------------------
			   TYPE 1 : CONSTRUIRE UNE MOLÉCULE
			-------------------------------------------------------------------------- */
			// Validation de la molécule créée pour les questions de type 1
			function validateMolecule(button) {
				const card = button.closest('.example-card');
				const resultDiv = card.querySelector('.result');
				const explanationDiv = card.querySelector('.explanation');
				
				// Vérifier si la molécule créée correspond à celle demandée
				let isCorrect = false;
				const expectedAnswer = card.dataset.answer;
				
				// Cas spécial pour les aldéhydes et cétones
				if (expectedAnswer.startsWith('aldehyde-cetone-')) {
					// Format attendu: aldehyde-cetone-[groupType]-[carbonCount]-[funcPos]
					const parts = expectedAnswer.split('-');
					const expectedGroupType = parts[2]; // aldehyde ou ketone
					const expectedCarbonCount = parseInt(parts[3]);
					const expectedFuncPos = parseInt(parts[4]);
					
					isCorrect = currentMoleculeData.type === 'aldehyde-cetone' && 
							   currentMoleculeData.groupType === expectedGroupType && 
							   currentMoleculeData.carbonCount === expectedCarbonCount && 
							   currentMoleculeData.funcPos === expectedFuncPos;
				} else {
					// Pour les autres types de molécules, utiliser l'approche originale
					let [expectedType, ...params] = expectedAnswer.split('-');
					
					// Vérifier le type de molécule
					if (expectedType === 'alcane' && currentMoleculeData.type === 'alcane') {
						// Pour les alcanes, vérifier le nombre de carbones
						isCorrect = currentMoleculeData.carbonCount === parseInt(params[0]);
					} 
					else if (expectedType === 'alcene' && currentMoleculeData.type === 'alcene') {
						// Pour les alcènes, vérifier le nombre de carbones et la position de la double liaison
						isCorrect = currentMoleculeData.carbonCount === parseInt(params[0]) && 
								   currentMoleculeData.doubleBondPos === parseInt(params[1]);
					}
					else if (expectedType === 'alcyne' && currentMoleculeData.type === 'alcyne') {
						// Pour les alcynes, vérifier le nombre de carbones et la position de la triple liaison
						isCorrect = currentMoleculeData.carbonCount === parseInt(params[0]) && 
								   currentMoleculeData.tripleBondPos === parseInt(params[1]);
					}
					else if (expectedType === 'alcool' && currentMoleculeData.type === 'alcool') {
						// Pour les alcools, vérifier le nombre de carbones et la position du groupe OH
						isCorrect = currentMoleculeData.carbonCount === parseInt(params[0]) && 
								   currentMoleculeData.alcoholPos === parseInt(params[1]);
					}
					else if (expectedType === 'acide' && currentMoleculeData.type === 'acide') {
						// Pour les acides, vérifier le nombre de carbones
						isCorrect = currentMoleculeData.carbonCount === parseInt(params[0]);
					}
					else if (expectedType === 'ester' && currentMoleculeData.type === 'ester') {
						// Pour les esters, vérifier les nombres de carbones des deux groupes
						isCorrect = currentMoleculeData.acylCount === parseInt(params[0]) && 
								   currentMoleculeData.alkoxyCount === parseInt(params[1]);
					}
				}
				
				// Afficher le résultat
				if (isCorrect) {
					resultDiv.textContent = "✅ Correct ! ";
					resultDiv.className = "result correct";
					resultDiv.style.display = "block";
					
					card.style.animation = 'pulse 0.5s ease';
					setTimeout(() => {
						card.style.animation = '';
					}, 500);
					
					if (!answered.has(card)) {
						answered.add(card);
						score++;
						document.getElementById('score').textContent = score;
						
						// Enregistrer la réponse
						const cardIndex = Array.from(document.querySelectorAll('.example-card')).indexOf(card);
						userAnswers[cardIndex] = 'correct';
					}
					
					// Afficher l'explication
					explanationDiv.style.display = "block";
				} else {
					resultDiv.textContent = "❌ Incorrect. Essayez à nouveau.";
					resultDiv.className = "result incorrect";
					resultDiv.style.display = "block";
					
					button.style.animation = 'shake 0.5s ease';
					setTimeout(() => {
						button.style.animation = '';
					}, 500);
					
					return; // Ne pas afficher l'explication en cas d'échec
				}
				
				// Préparer la question suivante si c'est une question de type 2
				setupNextQuestion();
				
				// Vérifier si toutes les questions ont été répondues
				const allAnswered = userAnswers.every(answer => answer !== null);
				if (allAnswered && !testCompleted) {
					// Afficher le bouton "Terminer" de manière plus visible
					const finishBtn = document.getElementById('finishBtn');
					finishBtn.style.animation = 'pulse 1s infinite';
					finishBtn.textContent = "Toutes les questions sont répondues - Terminer le test";
				}
			}
			
			/* --------------------------------------------------------------------------
			   TYPE 2 : IDENTIFIER UNE MOLÉCULE
			-------------------------------------------------------------------------- */
			// Vérification des réponses pour les questions de type 2
			function checkAnswer(button, selectedAnswer) {
				const card = button.closest('.example-card');
				const cardIndex = Array.from(document.querySelectorAll('.example-card')).indexOf(card);
				const correctAnswer = card.dataset.answer;
				const resultDiv = card.querySelector('.result');
				const explanationDiv = card.querySelector('.explanation');
				const allButtons = card.querySelectorAll('.answer-btn');
				
				// Désactiver tous les boutons pour éviter plusieurs tentatives
				allButtons.forEach(btn => btn.disabled = true);
				
				// Enregistrer la réponse de l'utilisateur
				userAnswers[cardIndex] = selectedAnswer;
				
				if (selectedAnswer === correctAnswer) {
					resultDiv.textContent = "✅ Correct ! ";
					resultDiv.className = "result correct";
					resultDiv.style.display = "block";
					
					card.style.animation = 'pulse 0.5s ease';
					setTimeout(() => {
						card.style.animation = '';
					}, 500);
					
					if (!answered.has(card)) {
						answered.add(card);
						score++;
						document.getElementById('score').textContent = score;
					}
				} else {
					resultDiv.textContent = \`❌ Incorrect. La bonne réponse est : \${correctAnswer.charAt(6).toUpperCase() + correctAnswer.slice(7)}\`;
					resultDiv.className = "result incorrect";
					resultDiv.style.display = "block";
					
					button.style.animation = 'shake 0.5s ease';
					setTimeout(() => {
						button.style.animation = '';
					}, 500);
				}
				
				// Afficher l'explication dans tous les cas
				explanationDiv.style.display = "block";
				
				// Préparer la question suivante
				setupNextQuestion();
				
				// Vérifier si toutes les questions ont été répondues
				const allAnswered = userAnswers.every(answer => answer !== null);
				if (allAnswered && !testCompleted) {
					// Afficher le bouton "Terminer" de manière plus visible
					const finishBtn = document.getElementById('finishBtn');
					finishBtn.style.animation = 'pulse 1s infinite';
					finishBtn.textContent = "Toutes les questions sont répondues - Terminer le test";
				}
			}`,
				
				code: `<!-- Structure du simulateur de molécules -->
			<div class="simulator-container">
				<div class="simulator-header">
					<div class="simulator-title">Simulateur de Molécules Organiques</div>
				</div>
				
				<div class="molecule-selector">
					<button class="molecule-button active" data-type="alcane">Alcanes</button>
					<button class="molecule-button" data-type="alcene">Alcènes</button>
					<button class="molecule-button" data-type="alcyne">Alcynes</button>
					<button class="molecule-button" data-type="alcool">Alcools</button>
					<button class="molecule-button" data-type="aldehyde-cetone">Aldéhydes/Cétones</button>
					<button class="molecule-button" data-type="acide">Acides Carboxyliques</button>
					<button class="molecule-button" data-type="ester">Esters</button>
				</div>
				
				<div class="control-panel">
					<!-- Contrôles pour les alcanes - visible par défaut -->
					<div class="control-group active" id="alcane-controls">
						<div class="slider-container">
							<label for="alcane-carbonSlider">Nombre d'atomes de carbone : </label>
							<input type="range" id="alcane-carbonSlider" min="1" max="20" value="5">
							<span id="alcane-carbonCount" class="count-display">5</span>
						</div>
					</div>
					
					<!-- Contrôles pour les alcènes -->
					<div class="control-group" id="alcene-controls">
						<div class="slider-container">
							<label for="alcene-carbonSlider">Nombre d'atomes de carbone : </label>
							<input type="range" id="alcene-carbonSlider" min="2" max="20" value="4">
							<span id="alcene-carbonCount" class="count-display">4</span>
						</div>
						<div class="slider-container">
							<label for="alcene-doubleBondSlider">Position de la double liaison : </label>
							<input type="range" id="alcene-doubleBondSlider" min="1" max="3" value="1">
							<span id="alcene-doubleBondCount" class="count-display">1</span>
						</div>
					</div>
					
					<!-- Contrôles pour les alcynes -->
					<div class="control-group" id="alcyne-controls">
						<div class="slider-container">
							<label for="alcyne-carbonSlider">Nombre d'atomes de carbone : </label>
							<input type="range" id="alcyne-carbonSlider" min="2" max="20" value="4">
							<span id="alcyne-carbonCount" class="count-display">4</span>
						</div>
						<div class="slider-container">
							<label for="alcyne-tripleBondSlider">Position de la triple liaison : </label>
							<input type="range" id="alcyne-tripleBondSlider" min="1" max="3" value="1">
							<span id="alcyne-tripleBondCount" class="count-display">1</span>
						</div>
					</div>
					
					<!-- Contrôles pour les alcools -->
					<div class="control-group" id="alcool-controls">
						<div class="slider-container">
							<label for="alcool-carbonSlider">Nombre d'atomes de carbone : </label>
							<input type="range" id="alcool-carbonSlider" min="1" max="12" value="3">
							<span id="alcool-carbonCount" class="count-display">3</span>
						</div>
						<div class="slider-container">
							<label for="alcool-positionSlider">Position du groupe hydroxyle : </label>
							<input type="range" id="alcool-positionSlider" min="1" max="3" value="1">
							<span id="alcool-positionCount" class="count-display">1</span>
						</div>
					</div>
					
					<!-- Contrôles pour les aldéhydes et cétones -->
					<div class="control-group" id="aldehyde-cetone-controls">
						<div class="radio-group">
							<label class="radio-label">
								<input type="radio" name="groupType" value="aldehyde" id="aldehydeRadio" checked> Aldéhyde
							</label>
							<label class="radio-label">
								<input type="radio" name="groupType" value="ketone" id="ketoneRadio"> Cétone
							</label>
						</div>
						<div class="slider-container">
							<label for="aldehyde-cetone-carbonSlider">Nombre d'atomes de carbone : </label>
							<input type="range" id="aldehyde-cetone-carbonSlider" min="2" max="20" value="5">
							<span id="aldehyde-cetone-carbonCount" class="count-display">5</span>
						</div>
						<div class="slider-container">
							<label for="aldehyde-cetone-funcSlider" id="aldehyde-cetone-funcSliderLabel">Position du groupe fonctionnel : </label>
							<input type="range" id="aldehyde-cetone-funcSlider" min="1" max="2" value="1">
							<span id="aldehyde-cetone-funcPosDisplay" class="count-display">1</span>
						</div>
					</div>
					
					<!-- Contrôles pour les acides carboxyliques -->
					<div class="control-group" id="acide-controls">
						<div class="slider-container">
							<label for="acide-carbonSlider">Nombre d'atomes de carbone : </label>
							<input type="range" id="acide-carbonSlider" min="1" max="20" value="1">
							<span id="acide-carbonCount" class="count-display">1</span>
						</div>
					</div>
					
					<!-- Contrôles pour les esters -->
					<div class="control-group" id="ester-controls">
						<div class="slider-container">
							<label for="ester-acylSlider">Nombre de C (Groupe R1) : </label>
							<input type="range" id="ester-acylSlider" min="1" max="10" value="2">
							<span id="ester-acylCount" class="count-display">2</span>
						</div>
						<div class="slider-container">
							<label for="ester-alkoxySlider">Nombre de C (Groupe R2) : </label>
							<input type="range" id="ester-alkoxySlider" min="1" max="10" value="1">
							<span id="ester-alkoxyCount" class="count-display">1</span>
						</div>
					</div>
				</div>
				
				<div class="canvas-container">
					<canvas id="moleculeCanvas" width="800" height="400"></canvas>
				</div>
				
				<!-- Info sur la molécule (masqué mais utilisé pour la validation) -->
				<div id="moleculeInfo"></div>
			</div>
			
			<!-- Structure des questions (exemples) -->
			<div class="examples">
				<!-- Question 1 - Type 1: Construire une molécule -->
				<div class="example-card" data-type="1" data-answer="alcane-5" data-molecule-type="alcane" data-carbon-count="5">
					<div class="example-header">
						<span>Question 1</span>
					</div>
					<div class="example-question">
						Construisez un ...... dans le simulateur puis validez votre réponse / IMPORTANT !!! RESPECTER LES FAMILLES DE MOLECULES SELECTIONNEES PAR UTILISATEUR
					</div>
					<button class="validate-btn" onclick="validateMolecule(this)">Valider la molécule</button>
					<div class="result"></div>
					<div class="explanation">
						Le pentane est un alcane linéaire à 5 atomes de carbone ayant pour formule C<sub>5</sub>H<sub>12</sub>.
					</div>
				</div>
				
				<!-- Question 2 - Type 2: Identifier une molécule -->
				<div class="example-card" data-type="2" data-answer="optionB" data-molecule-type="alcene" data-carbon-count="4" data-double-bond="1">
					<div class="example-header">
						<span>Question 2</span>
					</div>
					<div class="example-question">
						Identifiez la molécule affichée dans le simulateur.  / IMPORTANT !!! RESPECTER LES FAMILLES DE MOLECULES SELECTIONNEES PAR UTILISATEUR
					</div>
					<button class="show-molecule-btn">Afficher la molécule dans le simulateur</button>
					<div class="btn-group">
						<button class="answer-btn option-a-btn" onclick="checkAnswer(this, 'optionA')">Butane</button>
						<button class="answer-btn option-b-btn" onclick="checkAnswer(this, 'optionB')">But-1-ène</button>
						<button class="answer-btn option-c-btn" onclick="checkAnswer(this, 'optionC')">But-1-yne</button>
					</div>
					<div class="result"></div>
					<div class="explanation">
						La molécule affichée est le but-1-ène, un alcène à 4 atomes de carbone avec une double liaison en position 1.
					</div>
				</div>
			</div>
			
			<!-- Styles CSS pour le simulateur et les questions -->
			<style>
				/* Styles pour le simulateur de molécules */
				.simulator-container {
					margin-bottom: 30px;
					background: #f8fbff;
					border-radius: 15px;
					padding: 20px;
					box-shadow: 0 5px 15px rgba(0,0,0,0.1);
				}
				
				.simulator-header {
					display: flex;
					justify-content: space-between;
					align-items: center;
					margin-bottom: 15px;
				}
				
				.simulator-title {
					font-size: 1.4em;
					color: #a24b5f;
					font-weight: bold;
				}
				
				.molecule-selector {
					display: flex;
					flex-wrap: wrap;
					justify-content: center;
					gap: 10px;
					margin: 15px 0;
				}
				
				.molecule-button {
					padding: 10px 15px;
					background-color: #f8fbff;
					border: 2px solid #a24b5f;
					border-radius: 8px;
					color: #333;
					font-weight: 500;
					cursor: pointer;
					transition: all 0.3s;
				}
				
				.molecule-button:hover {
					background-color: rgba(41, 128, 185, 0.1);
					transform: translateY(-2px);
				}
				
				.molecule-button.active {
					background-color: #a24b5f;
					color: white;
				}
				
				.control-panel {
					display: flex;
					flex-direction: column;
					align-items: center;
					justify-content: center;
					flex-wrap: wrap;
					gap: 15px;
					margin: 20px 0;
				}
				
				.slider-container {
					display: flex;
					align-items: center;
					flex-wrap: wrap;
					gap: 10px;
					margin: 10px 0;
					width: 100%;
					max-width: 600px;
					justify-content: center;
				}
				
				.radio-group {
					display: flex;
					justify-content: center;
					gap: 20px;
					margin-bottom: 15px;
					padding: 10px;
					background-color: rgba(41, 128, 185, 0.1);
					border-radius: 10px;
				}
				
				.radio-label {
					display: flex
					.radio-label {
					display: flex;
					align-items: center;
					cursor: pointer;
					padding: 6px 12px;
					border-radius: 8px;
					transition: all 0.3s;
				}
				
				.radio-label:hover {
					background-color: rgba(41, 128, 185, 0.2);
				}
				
				.radio-label input[type="radio"] {
					margin-right: 8px;
					cursor: pointer;
				}
				
				input[type="range"] {
					width: 300px;
					height: 8px;
					-webkit-appearance: none;
					background: linear-gradient(to right, #a24b5f, #6a88ca);
					border-radius: 10px;
					outline: none;
					cursor: pointer;
				}
				
				input[type="range"]::-webkit-slider-thumb {
					-webkit-appearance: none;
					width: 20px;
					height: 20px;
					background: white;
					border: 2px solid #a24b5f;
					border-radius: 50%;
					cursor: pointer;
					transition: all 0.3s;
				}
				
				input[type="range"]::-webkit-slider-thumb:hover {
					background: #a24b5f;
				}
				
				input[type="range"]::-moz-range-thumb {
					width: 20px;
					height: 20px;
					background: white;
					border: 2px solid #a24b5f;
					border-radius: 50%;
					cursor: pointer;
					transition: all 0.3s;
				}
				
				input[type="range"]::-moz-range-thumb:hover {
					background: #a24b5f;
				}
				
				.count-display {
					display: inline-block;
					width: 40px;
					height: 40px;
					line-height: 40px;
					text-align: center;
					background-color: #a24b5f;
					color: white;
					font-weight: bold;
					border-radius: 50%;
					margin-left: 10px;
				}
				
				.canvas-container {
					display: flex;
					justify-content: center;
					width: 100%;
					margin: 0 auto;
				}
				
				canvas {
					background-color: white;
					border-radius: 8px;
					max-width: 100%;
					height: auto;
					box-shadow: 0 3px 10px rgba(0,0,0,0.1);
				}
				
				#moleculeInfo {
					/* On masque les noms des molécules mais on garde l'espace */
					visibility: hidden;
					height: 0;
					overflow: hidden;
					margin: 0;
					padding: 0;
				}
				
				/* Style pour les contrôles du simulateur */
				.control-group {
					display: none;
					width: 100%;
				}
				
				.control-group.active {
					display: flex;
					flex-direction: column;
					align-items: center;
				}
				
				/* Styles pour les questions */
				.examples {
					display: grid;
					grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
					gap: 20px;
					margin-top: 30px;
				}
				
				.example-card {
					background: #f8fbff;
					border: 2px solid #e8f4ff;
					border-radius: 15px;
					padding: 20px;
					transition: all 0.3s ease;
					position: relative;
					overflow: hidden;
					margin-bottom: 15px;
				}
				
				.example-card::before {
					content: '';
					position: absolute;
					top: 0;
					left: 0;
					width: 100%;
					height: 4px;
					background: linear-gradient(90deg, #a24b5f 0%, #182848 100%);
				}
				
				.example-card:hover {
					transform: translateY(-5px);
					box-shadow: 0 10px 20px rgba(0,0,0,0.1);
				}
				
				.example-card.active {
					border: 3px solid #a24b5f;
					transform: translateY(-5px);
					box-shadow: 0 12px 24px rgba(0,0,0,0.15);
				}
				
				.example-header {
					font-size: 1.2em;
					font-weight: bold;
					color: #333;
					margin-bottom: 15px;
				}
				
				.example-question {
					background: #fff;
					padding: 20px;
					border-radius: 8px;
					margin-bottom: 20px;
					box-shadow: 0 2px 5px rgba(0,0,0,0.05);
					font-weight: bold;
					color: #555;
					font-size: 1.1em;
				}
				
				.btn-group {
					display: grid;
					grid-template-columns: repeat(3, 1fr);
					gap: 10px;
				}
				
				.answer-btn {
					padding: 10px 15px;
					border: none;
					border-radius: 5px;
					font-weight: bold;
					cursor: pointer;
					transition: all 0.3s;
					color: white;
				}
				
				.answer-btn:hover {
					transform: translateY(-2px);
					box-shadow: 0 5px 10px rgba(0,0,0,0.1);
				}
				
				.option-a-btn {
					background: #a24b5f;
				}
				
				.option-a-btn:hover {
					background: #3a5ba3;
				}
				
				.option-b-btn {
					background: #6a88ca;
				}
				
				.option-b-btn:hover {
					background: #5a76b5;
				}
				
				.option-c-btn {
					background: #8ba4da;
				}
				
				.option-c-btn:hover {
					background: #7a91c5;
				}
				
				.validate-btn {
					background: #27ae60;
					color: white;
					border: none;
					border-radius: 5px;
					padding: 10px 15px;
					font-weight: bold;
					cursor: pointer;
					transition: all 0.3s;
					margin-top: 10px;
					width: 100%;
				}
				
				.validate-btn:hover {
					background: #219653;
					transform: translateY(-2px);
					box-shadow: 0 5px 10px rgba(0,0,0,0.1);
				}
				
				.validate-btn:disabled {
					background: #cccccc;
					cursor: not-allowed;
					transform: none;
					box-shadow: none;
				}
				
				.show-molecule-btn {
					background: #a24b5f;
					color: white;
					border: none;
					border-radius: 5px;
					padding: 10px 15px;
					margin-bottom: 15px;
					cursor: pointer;
					font-weight: bold;
					transition: all 0.3s;
					width: 100%;
				}
				
				.show-molecule-btn:hover {
					background: #3a5ba3;
					transform: translateY(-2px);
					box-shadow: 0 5px 10px rgba(0,0,0,0.1);
				}
				
				.result {
					margin-top: 15px;
					padding: 10px;
					border-radius: 8px;
					font-weight: bold;
					text-align: center;
					display: none;
				}
				
				.correct {
					background: #d4edda;
					color: #155724;
					border: 1px solid #c3e6cb;
				}
				
				.incorrect {
					background: #f8d7da;
					color: #721c24;
					border: 1px solid #f5c6cb;
				}
				
				.explanation {
					margin-top: 10px;
					padding: 10px;
					background: #e7f3ff;
					border: 1px solid #b8daff;
					color: #004085;
					border-radius: 8px;
					font-size: 0.9em;
					display: none;
				}
				
				@keyframes pulse {
					0% { transform: scale(1); }
					50% { transform: scale(1.05); }
					100% { transform: scale(1); }
				}
				
				@keyframes shake {
					0%, 100% { transform: translateX(0); }
					25% { transform: translateX(-5px); }
					75% { transform: translateX(5px); }
				}
				
				@media (max-width: 768px) {
					.examples {
						grid-template-columns: 1fr;
					}
					
					.molecule-button {
						padding: 8px 12px;
						font-size: 0.9rem;
					}
					
					input[type="range"] {
						width: 200px;
					}
				}
			</style>`
            },
			


			proba: {
				title: "Tableau de Probabilités",
				description: "Un template pour créer des exercices interactifs sur les probabilités basés sur un tableau de contingence. Les apprenants peuvent visualiser les événements A, B, leur intersection et leur union, puis calculer différentes probabilités.",
				features: [
					"Tableau de contingence interactif",
					"Mise en évidence visuelle des événements",
					"Exercices sur les probabilités simples, composées et conditionnelles",
					"Feedback immédiat sur les réponses",
					"Vérification automatique des calculs",
					"Indices pour guider les apprenants"
				],
				icon: "fas fa-table",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<h3 style="margin-bottom: 10px; color: #a24b5f;">Tableau de Probabilités</h3>
					
					<table style="width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1.1rem;">
						<tr>
							<th style="border: 2px solid #ddd; padding: 8px; background-color: #f0f0f0;"></th>
							<th style="border: 2px solid #ddd; padding: 8px; background-color: #e6e6ff;">Fleur</th>
							<th style="border: 2px solid #ddd; padding: 8px; background-color: rgba(255, 123, 84, 0.1);">Pomme</th>
							<th style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5;">Total</th>
						</tr>
						<tr>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: rgba(255, 92, 92, 0.1); font-weight: bold;">Rouge</td>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: yellow;">1</td>
							<td style="border: 2px solid #ddd; padding: 8px;">3</td>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">4</td>
						</tr>
						<tr>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: rgba(255, 195, 86, 0.1); font-weight: bold;">Jaune</td>
							<td style="border: 2px solid #ddd; padding: 8px;">4</td>
							<td style="border: 2px solid #ddd; padding: 8px;">2</td>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">6</td>
						</tr>
						<tr>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">Total</td>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">5</td>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">5</td>
							<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">10</td>
						</tr>
					</table>
					
					<div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
						<div style="background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-grow: 1; text-align: center; border-top: 4px solid #6a8caf;">
							<div style="color: #666; font-size: 0.9em;">Événement A: Fleur</div>
							<div style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">P(A) = 0.5</div>
						</div>
						<div style="background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-grow: 1; text-align: center; border-top: 4px solid #ff5c5c;">
							<div style="color: #666; font-size: 0.9em;">Événement B: Rouge</div>
							<div style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">P(B) = 0.4</div>
						</div>
					</div>
					
					<div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 15px;">
						<div style="font-weight: bold; margin-bottom: 10px;">Exercice: Calculer P(A ∩ B)</div>
						<div style="display: flex; align-items: center; gap: 10px;">
							<input type="number" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Votre réponse" step="0.01" min="0" max="1">
							<button style="background: #ea6687; color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer;">Vérifier</button>
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE TABLEAU DE PROBABILITE : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation du tableau de probabilité
				initTable();
				
				// Configuration des boutons de mise en évidence
				document.getElementById('btnHighlightA').addEventListener('click', () => highlightEvent('A'));
				document.getElementById('btnHighlightB').addEventListener('click', () => highlightEvent('B'));
				document.getElementById('btnHighlightAandB').addEventListener('click', () => highlightEvent('AandB'));
				document.getElementById('btnHighlightAorB').addEventListener('click', () => highlightEvent('AorB'));
				
				// Configuration du bouton de génération aléatoire
				document.getElementById('btnRandom').addEventListener('click', generateRandomData);
				
				// Initialisation des écouteurs pour les réponses
				initAnswerListeners();
			});
			
			// ********************************************
			// LE TABLEAU ET SA PRESENTATION INTERACTIVE
			// ********************************************
			// Variables globales pour les données du tableau
			let tableData = {
				redFlower: 1,
				redFruit: 3,
				yellowFlower: 4,
				yellowFruit: 2
			};
			let currentHighlight = '';
			
			// Initialisation du tableau
			function initTable() {
				// Mettre à jour les valeurs du tableau
				document.getElementById("redFlower").textContent = tableData.redFlower;
				document.getElementById("redFruit").textContent = tableData.redFruit;
				document.getElementById("yellowFlower").textContent = tableData.yellowFlower;
				document.getElementById("yellowFruit").textContent = tableData.yellowFruit;
				
				// Calculer et mettre à jour les totaux
				const totalRed = tableData.redFlower + tableData.redFruit;
				const totalYellow = tableData.yellowFlower + tableData.yellowFruit;
				const totalFlower = tableData.redFlower + tableData.yellowFlower;
				const totalFruit = tableData.redFruit + tableData.yellowFruit;
				const totalTotal = totalRed + totalYellow;
				
				document.getElementById("totalRed").textContent = totalRed;
				document.getElementById("totalYellow").textContent = totalYellow;
				document.getElementById("totalFlower").textContent = totalFlower;
				document.getElementById("totalFruit").textContent = totalFruit;
				document.getElementById("totalTotal").textContent = totalTotal;
				
				// Mise à jour des statistiques des exercices
				updateExerciseStats();
			}
			
			// Générer des données aléatoires pour le tableau
			function generateRandomData() {
				// Réinitialiser toutes les cellules highlight
				resetHighlight();
				
				// Générer des valeurs aléatoires entre 1 et 5 pour chaque cellule
				tableData = {
					redFlower: Math.floor(Math.random() * 5) + 1,
					redFruit: Math.floor(Math.random() * 5) + 1,
					yellowFlower: Math.floor(Math.random() * 5) + 1,
					yellowFruit: Math.floor(Math.random() * 5) + 1
				};
				
				// Mettre à jour le tableau
				initTable();
				
				// Si un événement était en surbrillance, le maintenir
				if (currentHighlight) {
					highlightEvent(currentHighlight);
				}
			}
			
			// Mettre en évidence un événement dans le tableau
			function highlightEvent(event) {
				// Stocker l'événement en cours
				currentHighlight = event;
				
				// Réinitialiser toutes les cellules highlight
				resetHighlight();
				
				// Ajouter la classe highlight aux cellules correspondantes
				switch(event) {
					case 'A': // Fleurs
						document.getElementById("redFlower").classList.add("highlight-cell");
						document.getElementById("redFlower").classList.add("pulse");
						document.getElementById("yellowFlower").classList.add("highlight-cell");
						document.getElementById("yellowFlower").classList.add("pulse");
						
						// Mettre également en évidence le total des fleurs
						document.getElementById("totalFlower").classList.add("highlight-cell");
						break;
						
					case 'B': // Rouge
						document.getElementById("redFlower").classList.add("highlight-cell");
						document.getElementById("redFlower").classList.add("pulse");
						document.getElementById("redFruit").classList.add("highlight-cell");
						document.getElementById("redFruit").classList.add("pulse");
						
						// Mettre également en évidence le total des rouges
						document.getElementById("totalRed").classList.add("highlight-cell");
						break;
						
					case 'AandB': // Fleur rouge
						document.getElementById("redFlower").classList.add("highlight-cell");
						document.getElementById("redFlower").classList.add("pulse");
						break;
						
					case 'AorB': // Fleur ou Rouge
						document.getElementById("redFlower").classList.add("highlight-cell");
						document.getElementById("redFlower").classList.add("pulse");
						document.getElementById("redFruit").classList.add("highlight-cell");
						document.getElementById("redFruit").classList.add("pulse");
						document.getElementById("yellowFlower").classList.add("highlight-cell");
						document.getElementById("yellowFlower").classList.add("pulse");
						break;
				}
				
				// Mettre à jour l'interface pour indiquer l'événement actif
				const buttons = document.querySelectorAll('.btn-group button');
				buttons.forEach(btn => {
					btn.style.opacity = "0.7";
					btn.style.transform = "none";
				});
				
				document.getElementById(\`btnHighlight\${event}\`).style.opacity = "1";
				document.getElementById(\`btnHighlight\${event}\`).style.transform = "translateY(-2px)";
				document.getElementById(\`btnHighlight\${event}\`).style.boxShadow = "0 6px 12px rgba(0,0,0,0.15)";
			}
			
			// Réinitialiser les highlights
			function resetHighlight() {
				const cells = document.querySelectorAll(".proba-table td");
				cells.forEach(cell => {
					cell.classList.remove("highlight-cell");
					cell.classList.remove("pulse");
				});
				
				// Réinitialiser le style des boutons
				const buttons = document.querySelectorAll('.btn-group button');
				buttons.forEach(btn => {
					btn.style.opacity = "1";
					btn.style.transform = "none";
					btn.style.boxShadow = "var(--shadow)";
				});
				
				// Réinitialiser l'événement en cours
				currentHighlight = '';
			}
			
			// Mise à jour des statistiques pour les exercices
			function updateExerciseStats() {
				const totalRed = tableData.redFlower + tableData.redFruit;
				const totalYellow = tableData.yellowFlower + tableData.yellowFruit;
				const totalFlower = tableData.redFlower + tableData.yellowFlower;
				const totalFruit = tableData.redFruit + tableData.yellowFruit;
				const totalTotal = totalRed + totalYellow;
				
				// Exercice 1
				document.getElementById("stats-ex1").innerHTML = \`
				  Total d'objets: \${totalTotal}<br>
				  Nombre de fleurs: \${totalFlower}
				\`;
				
				// Exercice 3
				document.getElementById("stats-ex3").innerHTML = \`
				  Nombre de fleurs rouges: \${tableData.redFlower}<br>
				  Nombre total d'objets: \${totalTotal}
				\`;
				
				// Mettre à jour les autres stats selon les exercices configurés
				if (document.getElementById("stats-ex5")) {
					document.getElementById("stats-ex5").innerHTML = \`
						La probabilité conditionnelle P(Pomme|Rouge) se calcule par:<br>
						P(Pomme|Rouge) = P(Pomme ∩ Rouge) / P(Rouge)<br><br>
						Dans notre cas:<br>
						- Nombre de pommes rouges: \${tableData.redFruit}<br>
						- Nombre total d'objets rouges: \${totalRed}
					\`;
				}
				
				if (document.getElementById("stats-ex6")) {
					document.getElementById("stats-ex6").innerHTML = \`
						La probabilité conditionnelle P(Jaune|Fleur) se calcule par:<br>
						P(Jaune|Fleur) = P(Jaune ∩ Fleur) / P(Fleur)<br><br>
						Données actuelles:<br>
						- Nombre de fleurs jaunes: \${tableData.yellowFlower}<br>
						- Nombre total de fleurs: \${totalFlower}
					\`;
				}
			}
			
			// ********************************************
			// GESTION DES QUESTIONS
			// ********************************************
			
			// Initialisation des écouteurs pour les réponses
			function initAnswerListeners() {
				// Pour chaque exercice, ajouter un écouteur sur le bouton de vérification
				document.querySelectorAll('.exercise-card').forEach(card => {
					const exerciseId = card.getAttribute('data-exercise');
					const checkBtn = card.querySelector('.check-btn');
					const answerInput = card.querySelector('input[type="number"]');
					
					if (checkBtn) {
						checkBtn.addEventListener('click', () => checkAnswer(exerciseId));
					}
					
					if (answerInput) {
						answerInput.addEventListener('keypress', function(e) {
							if (e.key === 'Enter') {
								checkAnswer(exerciseId);
							}
						});
					}
				});
			}
			
			// ********************************************
			// QUESTIONS DE TYPE 1: PROBABILITÉS SIMPLES
			// ********************************************
			// Vérification des réponses de type P(A), P(B), P(non A)
			function checkBasicProbability(exerciseId, userAnswer) {
				// Calculer les valeurs actuelles
				const totalRed = tableData.redFlower + tableData.redFruit;
				const totalYellow = tableData.yellowFlower + tableData.yellowFruit;
				const totalFlower = tableData.redFlower + tableData.yellowFlower;
				const totalFruit = tableData.redFruit + tableData.yellowFruit;
				const totalTotal = totalRed + totalYellow;
				
				let correctAnswer;
				let explanation;
				
				// Déterminer la réponse correcte selon l'exercice
				switch(exerciseId) {
					case "1": // P(A) - Probabilité d'avoir une fleur
						correctAnswer = totalFlower / totalTotal;
						explanation = \`P(A) = \${totalFlower} / \${totalTotal} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "2": // P(B) - Probabilité d'avoir un objet rouge
						correctAnswer = totalRed / totalTotal;
						explanation = \`P(B) = \${totalRed} / \${totalTotal} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "7": // P(non A) - Probabilité de ne pas avoir une fleur
						correctAnswer = 1 - (totalFlower / totalTotal);
						explanation = \`P(non A) = 1 - P(A) = 1 - (\${totalFlower} / \${totalTotal}) = \${correctAnswer.toFixed(2)}\`;
						break;
					case "8": // P(non B) - Probabilité de ne pas avoir un objet rouge
						correctAnswer = 1 - (totalRed / totalTotal);
						explanation = \`P(non B) = 1 - P(B) = 1 - (\${totalRed} / \${totalTotal}) = \${correctAnswer.toFixed(2)}\`;
						break;
				}
				
				return { correctAnswer, explanation };
			}
			
			// ********************************************
			// QUESTIONS DE TYPE 2: PROBABILITÉS COMPOSÉES
			// ********************************************
			// Vérification des réponses de type P(A et B), P(A ou B)
			function checkCompoundProbability(exerciseId, userAnswer) {
				// Calculer les valeurs actuelles
				const totalRed = tableData.redFlower + tableData.redFruit;
				const totalYellow = tableData.yellowFlower + tableData.yellowFruit;
				const totalFlower = tableData.redFlower + tableData.yellowFlower;
				const totalFruit = tableData.redFruit + tableData.yellowFruit;
				const totalTotal = totalRed + totalYellow;
				
				const probA = totalFlower / totalTotal;
				const probB = totalRed / totalTotal;
				
				let correctAnswer;
				let explanation;
				
				// Déterminer la réponse correcte selon l'exercice
				switch(exerciseId) {
					case "3": // P(A ∩ B) - Probabilité d'avoir une fleur rouge
						correctAnswer = tableData.redFlower / totalTotal;
						explanation = \`P(A ∩ B) = \${tableData.redFlower} / \${totalTotal} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "4": // P(A ∪ B) - Probabilité d'avoir une fleur ou un objet rouge
						correctAnswer = (totalFlower + totalRed - tableData.redFlower) / totalTotal;
						explanation = \`P(A ∪ B) = P(A) + P(B) - P(A ∩ B) = \${probA.toFixed(2)} + \${probB.toFixed(2)} - \${(tableData.redFlower / totalTotal).toFixed(2)} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "9": // P(A ∩ non B) - Probabilité d'avoir une fleur non rouge
						correctAnswer = tableData.yellowFlower / totalTotal;
						explanation = \`P(A ∩ non B) = \${tableData.yellowFlower} / \${totalTotal} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "10": // P(non A ∩ B) - Probabilité d'avoir un fruit rouge
						correctAnswer = tableData.redFruit / totalTotal;
						explanation = \`P(non A ∩ B) = \${tableData.redFruit} / \${totalTotal} = \${correctAnswer.toFixed(2)}\`;
						break;
				}
				
				return { correctAnswer, explanation };
			}
			
			// ********************************************
			// QUESTIONS DE TYPE 3: PROBABILITÉS CONDITIONNELLES
			// ********************************************
			// Vérification des réponses de type P(A|B), P(B|A)
			function checkConditionalProbability(exerciseId, userAnswer) {
				// Calculer les valeurs actuelles
				const totalRed = tableData.redFlower + tableData.redFruit;
				const totalYellow = tableData.yellowFlower + tableData.yellowFruit;
				const totalFlower = tableData.redFlower + tableData.yellowFlower;
				const totalFruit = tableData.redFruit + tableData.yellowFruit;
				const totalTotal = totalRed + totalYellow;
				
				let correctAnswer;
				let explanation;
				
				// Déterminer la réponse correcte selon l'exercice
				switch(exerciseId) {
					case "5": // P(Pomme|Rouge) - Probabilité d'avoir une pomme sachant qu'on a un objet rouge
						correctAnswer = tableData.redFruit / totalRed;
						explanation = \`P(Pomme|Rouge) = P(Pomme ∩ Rouge) / P(Rouge) = \${tableData.redFruit} / \${totalRed} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "6": // P(Jaune|Fleur) - Probabilité qu'une fleur soit jaune
						correctAnswer = tableData.yellowFlower / totalFlower;
						explanation = \`P(Jaune|Fleur) = P(Jaune ∩ Fleur) / P(Fleur) = \${tableData.yellowFlower} / \${totalFlower} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "11": // P(Fleur|Rouge) - Probabilité d'avoir une fleur sachant qu'on a un objet rouge
						correctAnswer = tableData.redFlower / totalRed;
						explanation = \`P(Fleur|Rouge) = P(Fleur ∩ Rouge) / P(Rouge) = \${tableData.redFlower} / \${totalRed} = \${correctAnswer.toFixed(2)}\`;
						break;
					case "12": // P(Rouge|Fleur) - Probabilité qu'une fleur soit rouge
						correctAnswer = tableData.redFlower / totalFlower;
						explanation = \`P(Rouge|Fleur) = P(Rouge ∩ Fleur) / P(Fleur) = \${tableData.redFlower} / \${totalFlower} = \${correctAnswer.toFixed(2)}\`;
						break;
				}
				
				return { correctAnswer, explanation };
			}
			
			// ********************************************
			// VALIDATION DES RÉPONSES
			// ********************************************
			// Fonction principale pour vérifier une réponse
			function checkAnswer(exerciseId) {
				const userAnswer = parseFloat(document.getElementById(\`answer\${exerciseId}\`).value.replace(',', '.'));
				const resultDiv = document.getElementById(\`result\${exerciseId}\`);
				const hintDiv = document.getElementById(\`hint\${exerciseId}\`);
				
				if (isNaN(userAnswer)) {
					resultDiv.textContent = "⚠️ Veuillez entrer un nombre valide";
					resultDiv.className = "result incorrect show";
					return;
				}
				
				// Déterminer le type de question et obtenir la réponse correcte
				let result;
				const exerciseType = getExerciseType(exerciseId);
				
				switch(exerciseType) {
					case "basic":
						result = checkBasicProbability(exerciseId, userAnswer);
						break;
					case "compound":
						result = checkCompoundProbability(exerciseId, userAnswer);
						break;
					case "conditional":
						result = checkConditionalProbability(exerciseId, userAnswer);
						break;
					default:
						result = { correctAnswer: 0, explanation: "Type d'exercice non reconnu" };
				}
				
				const { correctAnswer, explanation } = result;
				
				// Vérifier la réponse avec une tolérance
				const tolerance = 0.01;
				const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
				
				if (isCorrect) {
					resultDiv.innerHTML = "✓ Correct! " + explanation;
					resultDiv.className = "result correct show";
					hintDiv.style.display = "none";
					
					// Mettre à jour le score
					incrementScore();
					markAsSolved(exerciseId);
					
					// Vérifier si tous les exercices sont complétés
					checkAllCompleted();
				} else {
					resultDiv.textContent = "✗ Incorrect. Essayez encore!";
					resultDiv.className = "result incorrect show";
					hintDiv.style.display = "block";
				}
			}
			
			// Déterminer le type d'exercice (basic, compound, conditional)
			function getExerciseType(exerciseId) {
				const basicIds = ["1", "2", "7", "8"];
				const compoundIds = ["3", "4", "9", "10"];
				const conditionalIds = ["5", "6", "11", "12"];
				
				if (basicIds.includes(exerciseId)) return "basic";
				if (compoundIds.includes(exerciseId)) return "compound";
				if (conditionalIds.includes(exerciseId)) return "conditional";
				
				return "unknown";
			}
			
			// Marquer un exercice comme résolu
			function markAsSolved(exerciseId) {
				// Ajouter l'exercice à l'ensemble des exercices résolus
				solved.add(exerciseId);
				
				// Mettre à jour visuellement l'exercice
				const exerciseCard = document.querySelector(\`.exercise-card[data-exercise="\${exerciseId}"]\`);
				if (exerciseCard) {
					exerciseCard.classList.add('solved');
				}
				
				// Désactiver les contrôles
				const answerInput = document.getElementById(\`answer\${exerciseId}\`);
				const checkBtn = exerciseCard.querySelector('.check-btn');
				
				if (answerInput) answerInput.disabled = true;
				if (checkBtn) checkBtn.disabled = true;
			}
			
			// Incrémenter le score
			function incrementScore() {
				const scoreElement = document.getElementById('score');
				const currentScore = parseInt(scoreElement.textContent);
				scoreElement.textContent = currentScore + 1;
			}
			
			// Vérifier si tous les exercices sont complétés
			function checkAllCompleted() {
				const totalExercises = document.querySelectorAll('.exercise-card').length;
				
				if (solved.size >= totalExercises) {
					allExercisesCompleted = true;
					
					// Activer le bouton de fin si présent
					const finishBtn = document.getElementById('finishBtn');
					if (finishBtn) {
						finishBtn.disabled = false;
						finishBtn.classList.add('pulse-animation');
					}
					
					// Afficher un message de félicitations
					const container = document.querySelector('.container');
					if (container) {
						const completionMsg = document.createElement('div');
						completionMsg.className = 'completion-message';
						completionMsg.innerHTML = '<div>🎉 Félicitations! Vous avez terminé tous les exercices. 🎉</div>';
						container.appendChild(completionMsg);
					}
				}
			}
			
			// Fonction pour terminer l'activité
			function finishTest() {
				// Vérifier si au moins une question est répondue
				if (solved.size === 0) {
					alert("Vous devez répondre à au moins une question avant de terminer l'activité.");
					return;
				}
				
				// Afficher le message de fin
				alert(\`Activité terminée! Votre score final est de \${solved.size}/\${document.querySelectorAll('.exercise-card').length}.\`);
				
				// Désactiver tous les inputs et boutons
				document.querySelectorAll('input, .check-btn, .finish-btn').forEach(el => {
					el.disabled = true;
				});
				
				// Sauvegarder l'état dans SCORM si applicable
				if (typeof saveState === 'function') {
					saveState();
				}
			}`,
				
				code: `<div class="card">
			  <h2 style="text-align: center; margin-bottom: 20px;">Événements et Probabilités</h2>
			  
			  <!-- Tableau de probabilité -->
			  <table class="proba-table" id="probaTable">
				<thead>
				  <tr>
					<th></th>
					<th class="header-cell flower-cell">Fleur</th>
					<th class="header-cell fruit-cell">Pomme</th>
					<th class="totals-col">Total des couleurs</th>
				  </tr>
				</thead>
				<tbody>
				  <tr class="red-row">
					<td class="header-cell">Rouge</td>
					<td id="redFlower">1</td>
					<td id="redFruit">3</td>
					<td class="totals-col" id="totalRed">4</td>
				  </tr>
				  <tr class="yellow-row">
					<td class="header-cell">Jaune</td>
					<td id="yellowFlower">4</td>
					<td id="yellowFruit">2</td>
					<td class="totals-col" id="totalYellow">6</td>
				  </tr>
				  <tr class="totals-row">
					<td class="header-cell">Total des objets</td>
					<td class="totals-col" id="totalFlower">5</td>
					<td class="totals-col" id="totalFruit">5</td>
					<td class="totals-col" id="totalTotal">10</td>
				  </tr>
				</tbody>
			  </table>
			
			  <div class="event-info">
				<div class="stat-card event-a">
				  <div class="stat-label">Événement A: Fleur</div>
				  <div class="stat-label">À vous de calculer la probabilité</div>
				</div>
				<div class="stat-card event-b">
				  <div class="stat-label">Événement B: Rouge</div>
				  <div class="stat-label">À vous de calculer la probabilité</div>
				</div>
				<div class="stat-card event-a-and-b">
				  <div class="stat-label">A ∩ B: Fleur rouge</div>
				  <div class="stat-label">À vous de calculer la probabilité</div>
				</div>
				<div class="stat-card event-a-or-b">
				  <div class="stat-label">A ∪ B: Fleur ou Rouge</div>
				  <div class="stat-label">À vous de calculer la probabilité</div>
				</div>
			  </div>
			
			  <div class="btn-group">
				<button id="btnRandom" onclick="generateRandomData()">Générer aléatoirement</button>
				<button id="btnHighlightA" onclick="highlightEvent('A')">Mettre en évidence A</button>
				<button id="btnHighlightB" onclick="highlightEvent('B')">Mettre en évidence B</button>
				<button id="btnHighlightAandB" onclick="highlightEvent('AandB')">Mettre en évidence A ∩ B</button>
				<button id="btnHighlightAorB" onclick="highlightEvent('AorB')">Mettre en évidence A ∪ B</button>
			  </div>
			</div>
			
			<style>
			  /* Variables de couleurs et de style */
			  :root {
				--primary: #4361ee;
				--primary-dark: #3251d4;
				--secondary: #ff6b6b;
				--fruit: #ff7b54;
				--flower: #6a8caf;
				--red: #ff5c5c;
				--yellow: #ffc356;
				--dark: #212529;
				--light: #f8f9fa;
				--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
				--border-radius: 12px;
			  }
			
			  /* Styles pour le tableau de probabilité */
			  .proba-table {
				width: 100%;
				border-collapse: collapse;
				margin: 20px 0;
				font-size: 1.1rem;
			  }
			
			  .proba-table th, .proba-table td {
				border: 2px solid #ddd;
				padding: 12px;
				text-align: center;
				transition: all 0.3s ease;
			  }
			
			  .proba-table th {
				background-color: #f0f0f0;
				font-weight: bold;
			  }
			
			  .proba-table .header-cell {
				background-color: #e6e6ff;
				font-weight: bold;
			  }
			
			  .proba-table .totals-row {
				background-color: #f5f5f5;
				font-weight: bold;
			  }
			
			  .proba-table .totals-col {
				background-color: #f5f5f5;
				font-weight: bold;
			  }
			
			  .proba-table .fruit-cell {
				background-color: rgba(255, 123, 84, 0.1);
			  }
			
			  .proba-table .flower-cell {
				background-color: rgba(106, 140, 175, 0.1);
			  }
			
			  .proba-table .red-row {
				background-color: rgba(255, 92, 92, 0.1);
			  }
			
			  .proba-table .yellow-row {
				background-color: rgba(255, 195, 86, 0.1);
			  }
			
			  .event-info {
				display: flex;
				justify-content: space-around;
				flex-wrap: wrap;
				gap: 20px;
				margin: 20px 0;
			  }
			
			  .stat-card {
				background-color: white;
				border-radius: var(--border-radius);
				padding: 15px;
				min-width: 120px;
				text-align: center;
				box-shadow: var(--shadow);
				flex-grow: 1;
			  }
			
			  .stat-card.event-a {
				border-top: 4px solid var(--flower);
			  }
			
			  .stat-card.event-b {
				border-top: 4px solid var(--red);
			  }
			
			  .stat-card.event-a-or-b {
				border-top: 4px solid var(--primary);
			  }
			
			  .stat-card.event-a-and-b {
				border-top: 4px solid var(--secondary);
			  }
			
			  .stat-value {
				font-size: 2.2rem;
				font-weight: 700;
				margin: 10px 0;
				color: var(--dark);
			  }
			
			  .stat-label {
				font-size: 1.0rem;
				color: #666;
			  }
			
			  .btn-group {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				justify-content: center;
				margin: 20px 0;
			  }
			
			  button {
				background-color: var(--primary);
				color: white;
				border: none;
				border-radius: 50px;
				padding: 12px 24px;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: var(--shadow);
				min-width: 140px;
			  }
			
			  button:hover {
				background-color: var(--primary-dark);
				transform: translateY(-2px);
			  }
			
			  button:disabled {
				background-color: #b4b4b4;
				cursor: not-allowed;
				transform: none;
			  }
			
			  button.secondary {
				background-color: var(--secondary);
			  }
			
			  /* Styles pour les exercices */
			  .exercises {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
				gap: 20px;
				margin-top: 30px;
			  }
			
			  .exercise-card {
				background: #f8f9fa;
				border: 2px solid #e9ecef;
				border-radius: 15px;
				padding: 20px;
				transition: all 0.3s ease;
			  }
			
			  .exercise-card:hover {
				transform: translateY(-5px);
				box-shadow: 0 10px 20px rgba(0,0,0,0.1);
			  }
			
			  .material-header {
				display: flex;
				align-items: center;
				margin-bottom: 15px;
				font-size: 1.2em;
				font-weight: bold;
				color: #333;
			  }
			
			  .question-text {
				background: #f7f7f7;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 15px;
				font-size: 1.1em;
				color: #333;
			  }
			
			  .data-table {
				background: white;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 15px;
			  }
			
			  .data-row {
				display: flex;
				justify-content: space-between;
				padding: 5px 0;
				border-bottom: 1px solid #eee;
			  }
			
			  .data-row:last-child {
				border-bottom: none;
			  }
			
			  .data-label {
				color: #666;
			  }
			
			  .data-value {
				font-weight: bold;
				color: #333;
			  }
			
			  .input-group {
				margin-top: 15px;
			  }
			
			  .input-group label {
				display: block;
				margin-bottom: 5px;
				color: #555;
				font-weight: bold;
			  }
			
			  input[type="number"] {
				width: 100%;
				padding: 10px;
				border: 2px solid #ddd;
				border-radius: 8px;
				font-size: 1.1em;
				transition: border-color 0.3s;
			  }
			
			  input[type="number"]:focus {
				outline: none;
				border-color: #ea6687;
			  }
			
			  .check-btn {
				width: 100%;
				padding: 12px;
				margin-top: 10px;
				background: #ea6687;
				color: white;
				border: none;
				border-radius: 8px;
				font-size: 1.1em;
				font-weight: bold;
				cursor: pointer;
				transition: all 0.3s;
			  }
			
			  .check-btn:hover {
				background: #a24b5f;
				transform: translateY(-2px);
			  }
			
			  .result {
				margin-top: 10px;
				padding: 10px;
				border-radius: 8px;
				font-weight: bold;
				text-align: center;
				opacity: 0;
				transition: opacity 0.3s;
			  }
			
			  .result.show {
				opacity: 1;
			  }
			
			  .result.correct {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			  }
			
			  .result.incorrect {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			  }
			
			  .hint {
				background: #fff3cd;
				border: 1px solid #ffeeba;
				color: #856404;
				padding: 10px;
				border-radius: 8px;
				margin-top: 10px;
				font-size: 0.9em;
				display: none;
			  }
			
			  .simulation-stats {
				background: #f0f7ff;
				padding: 15px;
				border-radius: 10px;
				margin-bottom: 15px;
				border: 1px solid #d1e3ff;
			  }
			
			  .stats-header {
				font-weight: bold;
				margin-bottom: 10px;
				color: #1a56db;
			  }
			
			  /* Amélioration de l'animation pour la mise en évidence */
			  .highlight-cell {
				animation: highlight 1.5s ease-in-out;
				background-color: #ffeb3b !important;
				box-shadow: 0 0 10px #ffeb3b;
				transform: scale(1.05);
				z-index: 5;
				font-weight: bold;
			  }
			
			  @keyframes highlight {
				0% { background-color: #fff; box-shadow: none; transform: scale(1); }
				20% { background-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; transform: scale(1.05); }
				80% { background-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; transform: scale(1.05); }
				100% { background-color: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; transform: scale(1.05); }
			  }
			
			  /* Ajout d'un effet de pulsation continue pour les cellules en évidence */
			  .pulse {
				animation: pulse 2s infinite;
			  }
			
			  @keyframes pulse {
				0% { box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7); }
				70% { box-shadow: 0 0 0 10px rgba(255, 235, 59, 0); }
				100% { box-shadow: 0 0 0 0 rgba(255, 235, 59, 0); }
			  }
			
			  /* Styles responsifs */
			  @media (max-width: 768px) {
				.btn-group {
				  flex-direction: column;
				  width: 100%;
				}
				
				button {
				  width: 100%;
				}
				
				.stat-card {
				  min-width: 45%;
				}
			
				.exercises {
				  grid-template-columns: 1fr;
				}
				
				.proba-table {
				  font-size: 0.9rem;
				}
			
				.proba-table th, .proba-table td {
				  padding: 8px;
				}
			  }
			
			  /* Animation pour les exercices résolus */
			  .exercise-card.solved {
				border-color: #28a745;
				background-color: #f0fff4;
			  }
			
			  /* Style pour le message de complétion */
			  .completion-message {
				background: linear-gradient(135deg, #ea6687, #8c4152);
				color: white;
				text-align: center;
				padding: 20px;
				border-radius: 15px;
				margin-top: 30px;
				font-size: 1.5em;
				font-weight: bold;
				box-shadow: 0 10px 20px rgba(0,0,0,0.2);
				animation: pulse-animation 2s infinite;
			  }
			
			  @keyframes pulse-animation {
				0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
				70% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
				100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
			  }
			</style>
			
			<div class="exercises">
			  <!-- Exercice 1: Probabilité simple P(A) -->
			  <div class="exercise-card" data-exercise="1">
				<div class="material-header">
				  <span>Exercice 1</span>
				</div>
				
				<div class="question-text">
				  Calculer la probabilité de l'événement A (avoir une fleur). Arrondir à 2 décimales (0,01 près).
				</div>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données actuelles du tableau:</div>
				  <div id="stats-ex1">
					Total d'objets: 10<br>
					Nombre de fleurs: 5
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Réponse:</label>
				  <input type="number" id="answer1" min="0" max="1" step="0.01" placeholder="Valeur entre 0 et 1">
				  <button class="check-btn" onclick="checkAnswer(1)">Vérifier</button>
				  <div class="result" id="result1"></div>
				  <div class="hint" id="hint1">Indice: La probabilité est le rapport entre le nombre de cas favorables et le nombre de cas possibles.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 2: Probabilité simple P(B) -->
			  <div class="exercise-card" data-exercise="2">
				<div class="material-header">
				  <span>Exercice 2</span>
				</div>
				
				<div class="question-text">
				  Calculer la probabilité de l'événement B (avoir un objet rouge).
				</div>
				
				<div class="simulation-stats">
				  <div class="stats-header">Rappel théorique:</div>
				  <div>
					La probabilité d'un événement est définie par le rapport entre le nombre de cas favorables et le nombre de cas possibles.<br>
					P(B) = nombre d'objets rouges / nombre total d'objets<br>
					Valeur arrondie à 2 décimales (0,01 près)
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Réponse:</label>
				  <input type="number" id="answer2" min="0" max="1" step="0.01" placeholder="Valeur entre 0 et 1">
				  <button class="check-btn" onclick="checkAnswer(2)">Vérifier</button>
				  <div class="result" id="result2"></div>
				  <div class="hint" id="hint2">Indice: Comptez le nombre total d'objets rouges et divisez par le nombre total d'objets.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 3: Probabilité composée P(A∩B) -->
			  <div class="exercise-card" data-exercise="3">
				<div class="material-header">
				  <span>Exercice 3</span>
				</div>
				
				<div class="question-text">
				  Calculer la probabilité de l'événement "A et B" (avoir une fleur rouge).<br>
				  Arrondir à 2 décimales (0,01 près).
				</div>
				
				<div class="simulation-stats">
				  <div class="stats-header">Données du tableau:</div>
				  <div id="stats-ex3">
					Nombre de fleurs rouges: 1<br>
					Nombre total d'objets: 10
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Réponse:</label>
				  <input type="number" id="answer3" min="0" max="1" step="0.01" placeholder="Valeur entre 0 et 1">
				  <button class="check-btn" onclick="checkAnswer(3)">Vérifier</button>
				  <div class="result" id="result3"></div>
				  <div class="hint" id="hint3">Indice: L'intersection A ∩ B correspond aux éléments qui sont à la fois dans A et dans B.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 4: Probabilité composée P(A∪B) -->
			  <div class="exercise-card" data-exercise="4">
				<div class="material-header">
				  <span>Exercice 4</span>
				</div>
				
				<div class="question-text">
				  Calculer la probabilité de l'événement "A ou B" (avoir une fleur ou un objet rouge).<br>
				  Arrondir à 2 décimales (0,01 près).
				</div>
				
				<div class="simulation-stats">
				  <div class="stats-header">Formule à appliquer:</div>
				  <div id="stats-ex4">
					P(A ∪ B) = P(A) + P(B) - P(A ∩ B)
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Réponse:</label>
				  <input type="number" id="answer4" min="0" max="1" step="0.01" placeholder="Valeur entre 0 et 1">
				  <button class="check-btn" onclick="checkAnswer(4)">Vérifier</button>
				  <div class="result" id="result4"></div>
				  <div class="hint" id="hint4">Indice: Utilisez la formule P(A ∪ B) = P(A) + P(B) - P(A ∩ B), ou comptez directement les cas favorables.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 5: Probabilité conditionnelle P(Pomme|Rouge) -->
			  <div class="exercise-card" data-exercise="5">
				<div class="material-header">
				  <span>Exercice 5</span>
				</div>
				
				<div class="question-text">
				  Sachant qu'un objet est rouge, quelle est la probabilité que ce soit une pomme ? Calculez P(Pomme|Rouge).<br>
				  Arrondir à 2 décimales (0,01 près)
				</div>
				
				<div class="simulation-stats">
				  <div class="stats-header">Probabilité conditionnelle:</div>
				  <div id="stats-ex5">
					La probabilité conditionnelle P(Pomme|Rouge) se calcule par:<br>
					P(Pomme|Rouge) = P(Pomme ∩ Rouge) / P(Rouge)<br><br>
					Dans notre cas:<br>
					- Identifiez le nombre de pommes rouges<br>
					- Identifiez le nombre total d'objets rouges
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Réponse:</label>
				  <input type="number" id="answer5" min="0" max="1" step="0.01" placeholder="Valeur entre 0 et 1">
				  <button class="check-btn" onclick="checkAnswer(5)">Vérifier</button>
				  <div class="result" id="result5"></div>
				  <div class="hint" id="hint5">Indice: Divisez le nombre de pommes rouges par le nombre total d'objets rouges.</div>
				</div>
			  </div>
			  
			  <!-- Exercice 6: Probabilité conditionnelle P(Jaune|Fleur) -->
			  <div class="exercise-card" data-exercise="6">
				<div class="material-header">
				  <span>Exercice 6</span>
				</div>
				
				<div class="question-text">
				  Sachant qu'on a tiré une fleur, quelle est la probabilité que ce soit une fleur jaune ? Calculez P(Jaune|Fleur).<br>
				  Arrondir à 2 décimales (0,01 près).
				</div>
				
				<div class="simulation-stats">
				  <div class="stats-header">Probabilité conditionnelle:</div>
				  <div id="stats-ex6">
					La probabilité conditionnelle P(Jaune|Fleur) se calcule par:<br>
					P(Jaune|Fleur) = P(Jaune ∩ Fleur) / P(Fleur)<br><br>
					Données actuelles:<br>
					À partir du tableau, identifiez:<br>
					- Le nombre de fleurs jaunes<br>
					- Le nombre total de fleurs
				  </div>
				</div>
				
				<div class="input-group">
				  <label>Réponse:</label>
				  <input type="number" id="answer6" min="0" max="1" step="0.01" placeholder="Valeur entre 0 et 1">
				  <button class="check-btn" onclick="checkAnswer(6)">Vérifier</button>
				  <div class="result" id="result6"></div>
				  <div class="hint" id="hint6">Indice: Divisez le nombre de fleurs jaunes par le nombre total de fleurs.</div>
				</div>
			  </div>
			</div>
			
			<button id="finishBtn" class="finish-btn" style="display: block; width: 100%; max-width: 300px; margin: 30px auto 0; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer;" onclick="finishTest()">Terminer l'activité</button>
			`
			},







			titrage: {
				title: "Titrages acido-basiques",
				description: "Un template pour créer des simulations interactives de titrages acido-basiques. L'apprenant peut manipuler une burette et un erlenmeyer, réaliser des titrages et calculer des concentrations inconnues en utilisant les volumes équivalents.",
				features: [
					"Simulation visuelle interactive avec burette et erlenmeyer",
					"Indicateurs colorés avec changements de couleur au point d'équivalence",
					"Calculs de concentration basés sur les volumes et équivalences",
					"Différents types de titrages (acide/base)",
					"Feedback immédiat sur les calculs",
					"Progression sauvegardée automatiquement"
				],
				icon: "fas fa-flask",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Titrage acido-basique</h3>
						
						<div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
							<div style="background: #f0f0f0; padding: 10px; border-radius: 8px; width: 45%;">
								<p style="font-weight: bold; margin-bottom: 5px;">Configuration:</p>
								<div style="margin-bottom: 5px;">Burette: Base</div>
								<div style="margin-bottom: 5px;">Erlenmeyer: Acide</div>
								<div>Indicateur: Phénolphtaléine</div>
							</div>
							<div style="background: #f0f0f0; padding: 10px; border-radius: 8px; width: 45%;">
								<p style="font-weight: bold; margin-bottom: 5px;">Informations:</p>
								<div style="margin-bottom: 5px;">Volume: 20.0 mL</div>
								<div style="margin-bottom: 5px;">Concentration: 0.1 mol/L</div>
								<div>Volume équivalent: 10.0 mL</div>
							</div>
						</div>
									
					</div>
					
					<div style="background: white; padding: 15px; border-radius: 8px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Calcul de concentration</h3>
						<div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
							<div style="font-weight: bold; margin-bottom: 5px;">Formule: Ca × Va = Cb × Vb</div>
						</div>
						
						<div style="margin-bottom: 15px;">
							<p style="margin-bottom: 10px;">Données:</p>
							<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
								<span>Volume d'acide (Va):</span>
								<span>20.0 mL</span>
							</div>
							<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
								<span>Concentration de base (Cb):</span>
								<span>0.1 mol/L</span>
							</div>
							<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
								<span>Volume équivalent (Vb):</span>
								<span>10.0 mL</span>
							</div>
						</div>
						
						<div style="margin-bottom: 15px;">
							<label style="display: block; margin-bottom: 5px; font-weight: bold;">Concentration acide (Ca) en mol/L:</label>
							<div style="display: flex; gap: 10px;">
								<input type="number" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" value="0.05">
								<button style="background: #ea6687; color: white; border: none; border-radius: 5px; padding: 0 15px; cursor: pointer;">Vérifier</button>
							</div>
						</div>
						
						<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
							✅ Correct! Ca = (Cb × Vb) / Va = (0.1 × 10) / 20 = 0.05 mol/L
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE TITRAGE : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Variables globales pour le quiz
				let score = 0;
				let answered = new Set();
				const totalExercises = 6;
				let currentExercise = 1;
				let testCompleted = false;
				
				// Variables pour la simulation de titrage
				let buretteFillLevel = 0;
				let erlenFillLevel = 0;
				let dropsAdded = 0;
				let isStirring = false;
				let equivalenceReached = false;
				let dropInterval;
				let titrantUsed = 0;
				let userChangedSetup = false; // Variable pour suivre si l'utilisateur a modifié la configuration
				let setupValidated = false; // Variable pour suivre si la préparation a été validée
				
				// Variable pour suivre l'exercice actuellement sélectionné
				let selectedExerciseNum = null;
				
				// Variables globales pour SCORM
				let API = null;
				let API_1484_11 = null;
				const scormVersion = "2004";
				let initialized = false;
				let terminated = false;
				let lastError = "";
				let suspendData = "";
				let entryStatus = "ab-initio";
				let sessionStartTime = Date.now();
				let totalTime = 0;
				let lastTimeUpdate = sessionStartTime;
				let timeInterval = null;
				
				// Stockage des réponses de l'utilisateur
				let userAnswers = Array(totalExercises).fill(null);
				
				// Données des exercices
				const exerciseData = [
					// Exercice 1 - initialisé par défaut
					{
						titrationType: 'acid-base', // acide titré par base
						productTitrated: 'Acide',
						volumeTitrated: 20,
						titrant: 'Base',
						titrantConcentration: 0.1,
						equivalenceVolume: 10,
						correctAnswer: 0.05, // Ca = (Cb × Vb) / Va = (0.1 × 10) / 20 = 0.05
						recommendedIndicator: 'bromothymol',
						decimalPlaces: 3 // Nombre de décimales attendues pour le résultat
					},
					// Les autres exercices seront générés aléatoirement
				];
				
				// Initialisation au chargement de la page
				window.initTitrageApp = function() {
					// Initialiser SCORM
					initSCORM();
					startTimeTracking();
					
					// Générer les données des exercices
					generateExerciseData();
					
					// Mettre à jour les UI des exercices
					updateExercisesUI();
					
					// Initialiser la simulation de titrage
					initTitrationSimulation();
					
					// Mise à jour du bouton Terminer
					updateFinishButton();
					
					// Permettre la validation avec Enter
					document.querySelectorAll('input[type="number"]').forEach((input) => {
						input.addEventListener('keypress', function(e) {
							if (e.key === 'Enter') {
								const exerciseNum = parseInt(this.id.replace('answer', ''));
								checkAnswer(exerciseNum);
							}
						});
					});
					
					// Lier les sélecteurs de produits
					document.getElementById('burette-content').addEventListener('change', function() {
						userChangedSetup = true; // L'utilisateur a changé la configuration
						const buretteContent = this.value;
						document.getElementById('erlenmeyer-content').value = buretteContent === 'acid' ? 'base' : 'acid';
						updateTitrationSetup();
					});
					
					document.getElementById('erlenmeyer-content').addEventListener('change', function() {
						userChangedSetup = true; // L'utilisateur a changé la configuration
						const erlenmeyerContent = this.value;
						document.getElementById('burette-content').value = erlenmeyerContent === 'acid' ? 'base' : 'acid';
						updateTitrationSetup();
					});
					
					// Désactiver le bouton de démarrage du titrage par défaut
					document.getElementById('start-titration').disabled = true;
					
					// Bouton de démarrage du titrage
					document.getElementById('start-titration').addEventListener('click', startTitrationSimulation);
					
					// Bouton de validation de la préparation
					document.getElementById('validate-setup').addEventListener('click', validateSetup);
					
					// Gestion du choix de l'indicateur
					document.getElementById('indicator-type').addEventListener('change', updateIndicatorInfo);
					
					// Bouton de fin d'activité
					document.getElementById('finishBtn').addEventListener('click', finishActivity);
					
					// Si des données sont suspendues, restaurer l'état
					if (suspendData) {
						try {
							restoreState(suspendData);
						} catch (e) {
							console.error("Erreur lors de la restauration des données:", e);
						}
					}
				};
			
				// Génération des données des exercices
				function generateExerciseData() {
					// L'exercice 1 est déjà défini avec l'indicateur bleu de bromothymol par défaut
					exerciseData[0].recommendedIndicator = 'bromothymol';
					exerciseData[0].decimalPlaces = 3; // Nombre de décimales attendues pour le résultat
					
					// Tableau des concentrations possibles (en mol/L)
					const concentrations = [0.5, 0.2, 0.1, 0.05, 0.02, 0.01, 0.005, 0.001];
					
					// Générer les exercices 2 à 6
					for (let i = 1; i < totalExercises; i++) {
						// Déterminer le type de titrage (alternance)
						const titrationType = i % 2 === 0 ? 'base-acid' : 'acid-base';
						
						// Définir le produit titré et le titrant en fonction du type
						const productTitrated = titrationType === 'acid-base' ? 'Acide' : 'Base';
						const titrant = titrationType === 'acid-base' ? 'Base' : 'Acide';
						
						// Générer des valeurs aléatoires
						const volumeTitrated = [10, 15, 20, 25][Math.floor(Math.random() * 4)]; // 10, 15, 20 ou 25 mL
						
						// Choisir une concentration parmi les valeurs prédéfinies
						const titrantConcentration = concentrations[Math.floor(Math.random() * concentrations.length)];
						
						// Générer un volume équivalent aléatoire entre 5 et 15 mL avec 1 décimale
						const equivalenceVolume = parseFloat((Math.random() * 10 + 5).toFixed(1)); // 5 à 15 mL
						
						// Détermination contextuelle ou aléatoire de l'indicateur
						let recommendedIndicator;
						
						// Option 1: Attribution contextuelle basée sur le type de titrage
						// La phénolphtaléine est meilleure pour les titrages acide fort - base forte
						// Le bleu de bromothymol est meilleur pour les titrages acide faible - base forte ou base faible - acide fort
						if (i % 3 === 0) {
							// Pour certains exercices, on attribue de manière contextuelle
							recommendedIndicator = titrationType === 'acid-base' ? 'phenolphthalein' : 'bromothymol';
						} else {
							// Pour d'autres, on attribue de manière aléatoire
							recommendedIndicator = Math.random() < 0.5 ? 'bromothymol' : 'phenolphthalein';
						}
						
						// Calculer la réponse correcte
						let correctAnswer;
						if (titrationType === 'acid-base') {
							// Ca = (Cb × Vb) / Va
							correctAnswer = (titrantConcentration * equivalenceVolume) / volumeTitrated;
						} else {
							// Cb = (Ca × Va) / Vb
							correctAnswer = (titrantConcentration * equivalenceVolume) / volumeTitrated;
						}
						
						// Déterminer le nombre de décimales nécessaires pour le résultat
						// Plus la concentration du titrant est faible, plus nous avons besoin de décimales
						let decimalPlaces;
						if (titrantConcentration >= 0.1) {
							decimalPlaces = 3; // 3 décimales pour les concentrations ≥ 0,1 mol/L
						} else if (titrantConcentration >= 0.01) {
							decimalPlaces = 4; // 4 décimales pour les concentrations entre 0,01 et 0,1 mol/L
						} else {
							decimalPlaces = 5; // 5 décimales pour les concentrations < 0,01 mol/L
						}
						
						// Arrondir la réponse correcte au nombre de décimales approprié
						correctAnswer = parseFloat(correctAnswer.toFixed(decimalPlaces));
						
						// Ajouter l'exercice aux données
						exerciseData.push({
							titrationType,
							productTitrated,
							volumeTitrated,
							titrant,
							titrantConcentration,
							equivalenceVolume,
							correctAnswer,
							recommendedIndicator,
							decimalPlaces // Nombre de décimales attendues pour le résultat
						});
					}
				}
				
				// Mise à jour des UI des exercices
				function updateExercisesUI() {
					for (let i = 0; i < totalExercises; i++) {
						const exerciseNum = i + 1;
						const data = exerciseData[i];
						
						// Définir les textes des badges
						const badge = document.getElementById(\`badge\${exerciseNum}\`);
						badge.textContent = data.titrationType === 'acid-base' ? 'Acide/Base' : 'Base/Acide';
						
						// Mettre à jour les valeurs dans les tableaux de données
						document.getElementById(\`value\${exerciseNum}-1\`).textContent = data.productTitrated;
						
						if (data.productTitrated === 'Acide') {
							document.getElementById(\`label\${exerciseNum}-2\`).textContent = 'Volume titré (Va):';
							document.getElementById(\`value\${exerciseNum}-2\`).textContent = \`\${data.volumeTitrated} mL\`;
						} else {
							document.getElementById(\`label\${exerciseNum}-2\`).textContent = 'Volume titré (Vb):';
							document.getElementById(\`value\${exerciseNum}-2\`).textContent = \`\${data.volumeTitrated} mL\`;
						}
						
						document.getElementById(\`value\${exerciseNum}-3\`).textContent = data.titrant;
						
						if (data.titrant === 'Acide') {
							document.getElementById(\`label\${exerciseNum}-4\`).textContent = 'Concentration du titrant (Ca):';
							document.getElementById(\`value\${exerciseNum}-4\`).textContent = \`\${data.titrantConcentration} mol/L\`;
							document.getElementById(\`label\${exerciseNum}-5\`).textContent = 'Volume équivalent (Va):';
							// Ne pas afficher le volume équivalent au départ
							document.getElementById(\`value\${exerciseNum}-5\`).textContent = '? mL';
							document.getElementById(\`answer-label\${exerciseNum}\`).textContent = \`Concentration inconnue (Cb) en mol/L (\${data.decimalPlaces} décimales):\`;
						} else {
							document.getElementById(\`label\${exerciseNum}-4\`).textContent = 'Concentration du titrant (Cb):';
							document.getElementById(\`value\${exerciseNum}-4\`).textContent = \`\${data.titrantConcentration} mol/L\`;
							document.getElementById(\`label\${exerciseNum}-5\`).textContent = 'Volume équivalent (Vb):';
							// Ne pas afficher le volume équivalent au départ
							document.getElementById(\`value\${exerciseNum}-5\`).textContent = '? mL';
							document.getElementById(\`answer-label\${exerciseNum}\`).textContent = \`Concentration inconnue (Ca) en mol/L (\${data.decimalPlaces} décimales):\`;
						}
						
						// Ajouter l'information sur l'indicateur recommandé
						const dataTable = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"] .data-table\`);
						
						// Vérifier si la ligne d'indicateur existe déjà
						let indicatorRow = dataTable.querySelector('.indicator-row');
						if (!indicatorRow) {
							// Créer une nouvelle ligne pour l'indicateur
							indicatorRow = document.createElement('div');
							indicatorRow.className = 'data-row indicator-row';
							
							const labelSpan = document.createElement('span');
							labelSpan.className = 'data-label';
							labelSpan.textContent = 'Indicateur recommandé:';
							
							const valueSpan = document.createElement('span');
							valueSpan.className = 'data-value';
							valueSpan.id = \`indicator-value-\${exerciseNum}\`;
							
							indicatorRow.appendChild(labelSpan);
							indicatorRow.appendChild(valueSpan);
							dataTable.appendChild(indicatorRow);
						}
						
						// Mettre à jour la valeur de l'indicateur
						const indicatorValue = document.getElementById(\`indicator-value-\${exerciseNum}\`);
						indicatorValue.textContent = data.recommendedIndicator === 'bromothymol' ? 
							'Bleu de bromothymol' : 'Phénolphtaléine';
					}
				}
				
				// Initialisation de la simulation de titrage
				function initTitrationSimulation() {
					// Configuration initiale
					updateTitrationSetup();
					
					// Mise à jour des informations
					updateTitrationInfo();
				}
				
				// Préparer le titrage pour un exercice spécifique
				function prepareExerciseTitration(exerciseNum) {
					// Mettre à jour l'exercice sélectionné
					selectedExerciseNum = exerciseNum;
					currentExercise = exerciseNum;
					
					// Mettre à jour l'apparence des cartes d'exercice
					document.querySelectorAll('.exercise-card').forEach(card => {
						card.classList.remove('selected');
					});
					document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"]\`).classList.add('selected');
					
					// Réinitialiser la simulation
					resetTitrationSimulation();
					
					// Récupérer les données de l'exercice, mais ne pas les appliquer directement
					const data = exerciseData[exerciseNum - 1];
					
					// Informer l'utilisateur qu'il doit configurer manuellement la simulation
					const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
					resultDiv.textContent = "Veuillez configurer la simulation selon les paramètres de cette question puis valider la préparation.";
					resultDiv.className = "result show";
					resultDiv.style.backgroundColor = "#fff3cd";
					resultDiv.style.color = "#856404";
					resultDiv.style.border = "1px solid #ffeeba";
					
					// Faire défiler vers la simulation
					document.querySelector('.titration-panel').scrollIntoView({ behavior: 'smooth' });
				}
				
				// Validation de la préparation
				function validateSetup() {
					// Vérifier si un exercice est sélectionné
					if (selectedExerciseNum === null) {
						// Afficher un message d'erreur intégré à l'interface
						const validationMessage = document.getElementById('validation-message');
						validationMessage.style.display = 'block';
						validationMessage.style.backgroundColor = '#f8d7da';
						validationMessage.style.border = '1px solid #f5c6cb';
						validationMessage.style.color = '#721c24';
						validationMessage.textContent = "Veuillez d'abord sélectionner un exercice avant de valider la préparation.";
						
						// Masquer le message après 5 secondes
						setTimeout(() => {
							validationMessage.style.display = 'none';
						}, 5000);
						return;
					}
					
					// Récupérer les données de l'exercice sélectionné
					const data = exerciseData[selectedExerciseNum - 1];
					
					// Récupérer les valeurs actuelles de la simulation
					const buretteContent = document.getElementById('burette-content').value;
					const indicatorType = document.getElementById('indicator-type').value;
					
					// Vérifier que le produit dans la burette est correct selon le type de titrage
					let isCorrectBurette = false;
					let expectedBuretteContent = "";
					
					if (data.titrationType === 'acid-base') {
						// Pour un titrage acide/base, le produit dans la burette doit être une base
						isCorrectBurette = (buretteContent === 'base');
						expectedBuretteContent = "Base";
					} else {
						// Pour un titrage base/acide, le produit dans la burette doit être un acide
						isCorrectBurette = (buretteContent === 'acid');
						expectedBuretteContent = "Acide";
					}
					
					// Vérifier si l'indicateur coloré correspond à celui recommandé
					const isCorrectIndicator = (indicatorType === data.recommendedIndicator);
					const expectedIndicator = data.recommendedIndicator === 'bromothymol' ? 'Bleu de bromothymol' : 'Phénolphtaléine';
					
					// Si la configuration n'est pas correcte, informer l'utilisateur
					if (!isCorrectBurette || !isCorrectIndicator) {
						// Construire le message d'erreur
						let errorMessages = [];
						
						if (!isCorrectBurette) {
							errorMessages.push(\`Le produit dans la burette devrait être: \${expectedBuretteContent}\`);
						}
						
						if (!isCorrectIndicator) {
							errorMessages.push(\`L'indicateur coloré recommandé est: \${expectedIndicator}\`);
						}
						
						// Afficher un message d'erreur intégré à l'interface
						const validationMessage = document.getElementById('validation-message');
						validationMessage.style.display = 'block';
						validationMessage.style.backgroundColor = '#f8d7da';
						validationMessage.style.border = '1px solid #f5c6cb';
						validationMessage.style.color = '#721c24';
						validationMessage.textContent = \`La configuration ne correspond pas à l'exercice sélectionné:\\n\${errorMessages.join('\\n')}\`;
						
						// Masquer le message après 5 secondes
						setTimeout(() => {
							validationMessage.style.display = 'none';
						}, 5000);
						return;
					}
					
					// Marquer la préparation comme validée
					setupValidated = true;
					document.getElementById('validate-setup').disabled = true;
					
					// Désactiver les sélecteurs après validation
					document.getElementById('burette-content').disabled = true;
					document.getElementById('erlenmeyer-content').disabled = true;
					document.getElementById('indicator-type').disabled = true;
					
					// Corriger le remplissage de la burette (liquide en bas, pas en haut)
					const buretteFill = document.getElementById('burette-fill');
					const totalHeight = 915.97;
					const fillPercentage = 80; // 80% rempli
					const fillHeight = fillPercentage / 100 * totalHeight;
					
					// Position de départ de la burette dans le SVG
					const buretteTopY = 11.698;
					
					// Pour que le liquide apparaisse en bas de la burette:
					// Y = position du bas de la burette - hauteur du remplissage
					const bottomY = buretteTopY + totalHeight - fillHeight;
					
					// Désactiver la transition pour le remplissage initial
					buretteFill.classList.remove('level-transition');
					
					// Positionner le liquide en bas de la burette
					buretteFill.setAttribute('y', bottomY);
					buretteFill.setAttribute('height', fillHeight);
					buretteFillLevel = fillPercentage;
					
					// Remplir l'erlenmeyer avec la couleur initiale
					const erlenFill = document.getElementById('erlen-fill');
					erlenFill.style.display = 'block';
					
					// Définir les couleurs en fonction du contenu et de l'indicateur
					const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
					
					let initialColor;
					if (indicatorType === 'bromothymol') {
						initialColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-acid)' : 'var(--bromothymol-base)';
					} else { // phénolphtaléine
						initialColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-acid)' : 'var(--phenolphthalein-base)';
					}
					
					// Appliquer les couleurs immédiatement
					const stops = document.querySelectorAll('#erlenFill stop');
					stops.forEach(stop => {
						stop.style.stopColor = initialColor;
					});
					
					// Ajouter la classe de transition uniquement pour l'erlenmeyer
					erlenFill.classList.add('color-transition');
					
					// Réactiver la transition pour l'animation de vidage
					setTimeout(() => {
						buretteFill.classList.add('level-transition');
					}, 100);
					
					// Mettre à jour les informations de titrage avec les données de l'exercice
					document.getElementById('volume-info').textContent = \`Volume dans l'erlenmeyer: \${data.volumeTitrated.toFixed(1)} mL\`;
					document.getElementById('concentration-info').textContent = \`Concentration du titrant: \${data.titrantConcentration.toFixed(3)} mol/L\`;
					
					// Activer le bouton de démarrage du titrage
					document.getElementById('start-titration').disabled = false;
					
					// Afficher le message de validation dans la zone de texte
					const validationMessage = document.getElementById('validation-message');
					validationMessage.style.display = 'block';
					validationMessage.style.backgroundColor = 'rgba(46, 196, 182, 0.1)';
					validationMessage.style.border = '1px solid rgba(46, 196, 182, 0.3)';
					validationMessage.style.color = '#3c6a56';
					validationMessage.textContent = "Préparation validée ! La burette et l'erlenmeyer sont maintenant remplis. Vous pouvez démarrer le titrage.";
					
					// Masquer le message après 5 secondes
					setTimeout(() => {
						validationMessage.style.display = 'none';
					}, 5000);
				}        
				
				// Mise à jour des informations sur l'indicateur
				function updateIndicatorInfo() {
					const indicatorType = document.getElementById('indicator-type').value;
					let indicatorName = indicatorType === 'bromothymol' ? 'Bleu de bromothymol' : 'Phénolphtaléine';
					document.getElementById('indicator-info').textContent = \`Indicateur: \${indicatorName}\`;
				}
				
				// Mise à jour des informations de titrage
				function updateTitrationInfo() {
					const exerciseData = getCurrentExerciseData();
					updateIndicatorInfo();
					document.getElementById('volume-info').textContent = \`Volume dans l'erlenmeyer: \${exerciseData.volumeTitrated.toFixed(1)} mL\`;
					document.getElementById('concentration-info').textContent = \`Concentration du titrant: \${exerciseData.titrantConcentration.toFixed(3)} mol/L\`;
					document.getElementById('equivalence-info').style.display = 'none';
				}
				
				// Récupérer les données de l'exercice courant
				function getCurrentExerciseData() {
					if (selectedExerciseNum === null) {
						// Si aucun exercice n'est sélectionné, utiliser l'exercice 1 par défaut
						return exerciseData[currentExercise - 1];
					}
					return exerciseData[selectedExerciseNum - 1];
				}
				
				// Mise à jour de la configuration du titrage
				function updateTitrationSetup() {
					// Ne pas écraser les sélections de l'utilisateur si userChangedSetup est vrai
					if (!userChangedSetup) {
						const exerciseData = getCurrentExerciseData();
						
						// Mettre à jour les sélecteurs en fonction de l'exercice courant
						const buretteSelect = document.getElementById('burette-content');
						const erlenmeyerSelect = document.getElementById('erlenmeyer-content');
						
						if (exerciseData.titrant === 'Base') {
							buretteSelect.value = 'base';
							erlenmeyerSelect.value = 'acid';
						} else {
							buretteSelect.value = 'acid';
							erlenmeyerSelect.value = 'base';
						}
					}
					
					// Réinitialiser la simulation sans toucher aux sélecteurs
					resetTitrationSimulation();
					
					
					// Mise à jour des informations
					updateTitrationInfo();
				}
				
				// Réinitialiser la simulation de titrage
				function resetTitrationSimulation() {
					// Arrêter l'animation de gouttes en cours
					if (dropInterval) {
						clearInterval(dropInterval);
						dropInterval = null;
					// Masquer le message de validation
					document.getElementById('validation-message').style.display = 'none';
					}
					
					// Réinitialiser les variables de simulation
					buretteFillLevel = 0;
					erlenFillLevel = 0;
					dropsAdded = 0;
					isStirring = false;
					equivalenceReached = false;
					titrantUsed = 0;
					setupValidated = false;
					
					// Réinitialiser l'UI
					document.getElementById('equivalence-notice').style.display = 'none';
					document.getElementById('start-titration').textContent = 'Démarrer le Titrage';
					
					// Gestion des boutons et sélecteurs
					document.getElementById('start-titration').disabled = true;
					document.getElementById('validate-setup').disabled = false;
					document.getElementById('burette-content').disabled = false;
					document.getElementById('erlenmeyer-content').disabled = false;
					document.getElementById('indicator-type').disabled = false;
					
					// IMPORTANT: Supprimer toutes les classes de transition avant de réinitialiser
					const buretteFill = document.getElementById('burette-fill');
					buretteFill.classList.remove('level-transition');
					
					const erlenFill = document.getElementById('erlen-fill');
					erlenFill.classList.remove('color-transition');
					
					// Forcer un reflow pour que les changements prennent effet immédiatement
					void buretteFill.offsetWidth;
					void erlenFill.offsetWidth;
					
					// Masquer le remplissage de la burette sans animation
					buretteFill.setAttribute('y', 11.698);
					buretteFill.setAttribute('height', '0');
					
					// Masquer le remplissage de l'erlenmeyer
					erlenFill.style.display = 'none';
					
					// Masquer la goutte
					document.getElementById('drop').style.display = 'none';
					
					// Arrêter l'agitation
					const stirBar = document.getElementById('stir-bar');
					stirBar.style.display = 'none';
					stirBar.classList.remove('active');
					document.getElementById('stirrer-indicator').classList.remove('active');
				}
				
				// Démarrer la simulation de titrage
				function startTitrationSimulation() {
					// Si le bouton affiche "Recommencer le Titrage", réinitialiser complètement et quitter
					// pour permettre à l'utilisateur d'appuyer à nouveau sur "Démarrer le Titrage"
					if (document.getElementById('start-titration').textContent === 'Recommencer le Titrage') {
						resetTitrationSimulation();
						// Réinitialiser userChangedSetup pour le prochain titrage après un recommencement
						userChangedSetup = false;
						// Ne pas continuer avec le titrage, simplement réinitialiser
						return;
					}
					
					// Vérifier si la préparation a été validée
					if (!setupValidated) {
						// Afficher un message d'erreur intégré à l'interface
						const validationMessage = document.getElementById('validation-message');
						validationMessage.style.display = 'block';
						validationMessage.style.backgroundColor = '#f8d7da';
						validationMessage.style.border = '1px solid #f5c6cb';
						validationMessage.style.color = '#721c24';
						validationMessage.textContent = "Veuillez d'abord valider la préparation avant de démarrer le titrage.";
						
						// Masquer le message après 5 secondes
						setTimeout(() => {
							validationMessage.style.display = 'none';
						}, 5000);
						return;
					}
					
					// Désactiver le bouton
					document.getElementById('start-titration').disabled = true;
					document.getElementById('start-titration').textContent = 'Titrage en cours...';
					
					// Afficher le barreau magnétique
					const stirBar = document.getElementById('stir-bar');
					stirBar.style.display = 'block';
					stirBar.classList.add('active');
					isStirring = true;
					document.getElementById('stirrer-indicator').classList.add('active');
					
					// Démarrer l'animation du niveau de la burette qui descend
					lowerBuretteLevel();
				}
				
				// Animation du niveau de la burette qui baisse avec transition de couleur progressive
				function lowerBuretteLevel() {
					const buretteFill = document.getElementById('burette-fill');
					const erlenFill = document.getElementById('erlen-fill');
					const exerciseData = getCurrentExerciseData();
					
					// Déterminer les couleurs de début et de fin en fonction du contenu et de l'indicateur
					const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
					const indicatorType = document.getElementById('indicator-type').value;
					
					let initialColor, finalColor;
					
					if (indicatorType === 'bromothymol') {
						initialColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-acid)' : 'var(--bromothymol-base)';
						finalColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-base)' : 'var(--bromothymol-acid)';
					} else { // phénolphtaléine
						initialColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-acid)' : 'var(--phenolphthalein-base)';
						finalColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-base)' : 'var(--phenolphthalein-acid)';
					}
					
					// Durée totale de l'animation en ms
					const animationDuration = 3000;
					
					// Définir les couleurs intermédiaires pour la transition progressive
					const stops = document.querySelectorAll('#erlenFill stop');
					
					// S'assurer que la couleur initiale est correcte
					stops.forEach(stop => {
						stop.style.stopColor = initialColor;
					});
					
					// Baisser le niveau à 10% dans la burette
					buretteFill.setAttribute('y', 11.698 + ((100 - 10) / 100) * 915.97);
					buretteFill.setAttribute('height', 10 / 100 * 915.97);
					
					// Créer une animation de couleur progressive
					let startTime = null;
					
					// Fonction d'animation pour la transition de couleur
					function animateColor(timestamp) {
						if (!startTime) startTime = timestamp;
						
						// Calculer la progression (0 à 1)
						const progress = Math.min((timestamp - startTime) / animationDuration, 1);
						
						// Définir la couleur intermédiaire en fonction de la progression
						// Pour cette démo, on utilise une transition linéaire entre les couleurs
						// Une vraie transition de couleur utiliserait une interpolation plus complexe
						if (progress < 1) {
							// Simuler un changement de couleur qui s'accélère vers la fin
							// comme dans un vrai titrage (changement soudain près du point d'équivalence)
							let colorProgress;
							
							if (progress < 0.7) {
								// Changement lent au début (70% du temps)
								colorProgress = progress * 0.2; // Seulement 20% du changement de couleur
							} else {
								// Changement rapide à la fin (30% du temps restant)
								colorProgress = 0.2 + (progress - 0.7) * (0.8 / 0.3); // Les 80% restants
							}
							
							// Appliquer la couleur intermédiaire
							// Note: comme nous utilisons des variables CSS, on ne peut pas réellement
							// mélanger les couleurs, donc on bascule vers la couleur finale près de la fin
							const currentColor = progress > 0.85 ? finalColor : initialColor;
							stops.forEach(stop => {
								stop.style.stopColor = currentColor;
							});
							
							requestAnimationFrame(animateColor);
						} else {
							// Animation terminée, définir la couleur finale
							stops.forEach(stop => {
								stop.style.stopColor = finalColor;
							});
							
							// Afficher le point d'équivalence
							setTimeout(finishTitration, 100);
						}
					}
					
					// Démarrer l'animation
					requestAnimationFrame(animateColor);
				}
				
				// Changement progressif de la couleur de la solution dans l'erlenmeyer
				function changeErlenColor() {
					const exerciseData = getCurrentExerciseData();
					
					// Déterminer la couleur finale en fonction du contenu et de l'indicateur
					const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
					const indicatorType = document.getElementById('indicator-type').value;
					
					let finalColor;
					
					if (indicatorType === 'bromothymol') {
						finalColor = erlenmeyerContent === 'acid' ? 'var(--bromothymol-base)' : 'var(--bromothymol-acid)';
					} else { // phénolphtaléine
						finalColor = erlenmeyerContent === 'acid' ? 'var(--phenolphthalein-base)' : 'var(--phenolphthalein-acid)';
					}
					
					// Appliquer la couleur finale avec transition
					const stops = document.querySelectorAll('#erlenFill stop');
					stops.forEach(stop => {
						stop.style.stopColor = finalColor;
					});
				}
				
				// Terminer directement le titrage (sans animation)
				function finishTitration() {
					// Vérifier si un exercice est sélectionné
					if (selectedExerciseNum === null) {
						alert("Aucun exercice n'est sélectionné. Veuillez d'abord sélectionner un exercice.");
						return;
					}
					
					const data = exerciseData[selectedExerciseNum - 1];
					
					// Déterminer le message d'équivalence en fonction du contenu et de l'indicateur
					const erlenmeyerContent = document.getElementById('erlenmeyer-content').value;
					const indicatorType = document.getElementById('indicator-type').value;
					
					let equivalenceMessage;
					
					if (indicatorType === 'bromothymol') {
						if (erlenmeyerContent === 'acid') {
							equivalenceMessage = "La solution est passée du jaune au bleu, indiquant que tout l'acide a été neutralisé.";
						} else {
							equivalenceMessage = "La solution est passée du bleu au jaune, indiquant que toute la base a été neutralisée.";
						}
					} else { // phénolphtaléine
						if (erlenmeyerContent === 'acid') {
							equivalenceMessage = "La solution est passée d'incolore à rose, indiquant que tout l'acide a été neutralisé.";
						} else {
							equivalenceMessage = "La solution est passée de rose à incolore, indiquant que toute la base a été neutralisée.";
						}
					}
					
					// Afficher les notifications d'équivalence atteinte dans la simulation
					document.getElementById('equivalence-notice').style.display = 'block';
					document.getElementById('equivalence-info').style.display = 'block';
					document.getElementById('equivalence-info').textContent = \`Volume équivalent: \${data.equivalenceVolume.toFixed(1)} mL\`;
					
					// Mettre à jour le message d'équivalence
					document.getElementById('equivalence-message').textContent = equivalenceMessage;
					
					// Mettre à jour le bouton pour permettre de recommencer
					document.getElementById('start-titration').disabled = false;
					document.getElementById('start-titration').textContent = 'Recommencer le Titrage';
					
					// Mettre à jour le volume équivalent dans l'exercice sélectionné
					const volumeValueElement = document.getElementById(\`value\${selectedExerciseNum}-5\`);
					if (volumeValueElement) {
						volumeValueElement.textContent = \`\${data.equivalenceVolume.toFixed(1)} mL\`;
						
						// Mettre en évidence le changement
						volumeValueElement.style.backgroundColor = "#d4edda";
						volumeValueElement.style.padding = "2px 5px";
						volumeValueElement.style.borderRadius = "4px";
						
						// Revenir à la normale après quelques secondes
						setTimeout(() => {
							volumeValueElement.style.backgroundColor = "";
							volumeValueElement.style.padding = "";
						}, 3000);
					}
					
					// Informer l'utilisateur que les données sont prêtes pour le calcul
					const resultDiv = document.getElementById(\`result\${selectedExerciseNum}\`);
					resultDiv.textContent = "Le volume équivalent a été déterminé. Vous pouvez maintenant calculer la concentration inconnue.";
					resultDiv.className = "result show";
					resultDiv.style.backgroundColor = "#d1ecf1";
					resultDiv.style.color = "#0c5460";
					resultDiv.style.border = "1px solid #bee5eb";
				}
				
				// Vérifier la réponse de l'utilisateur
				function checkAnswer(exerciseNum) {
					const userAnswer = parseFloat(document.getElementById(\`answer\${exerciseNum}\`).value);
					const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
					const hintDiv = document.getElementById(\`hint\${exerciseNum}\`);
					const data = exerciseData[exerciseNum - 1];
					
					// Vérifier si l'exercice actuel a été sélectionné
					if (selectedExerciseNum !== exerciseNum) {
						resultDiv.textContent = "⚠️ Veuillez d'abord préparer et effectuer le titrage pour cet exercice";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Vérifier si le volume équivalent a été déterminé
					const volumeValueElement = document.getElementById(\`value\${exerciseNum}-5\`);
					if (volumeValueElement.textContent === "? mL") {
						resultDiv.textContent = "⚠️ Le volume équivalent n'a pas encore été déterminé. Effectuez d'abord le titrage.";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					if (isNaN(userAnswer)) {
						resultDiv.textContent = "⚠️ Veuillez entrer un nombre";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Récupérer le nombre de décimales attendues
					const decimalPlaces = data.decimalPlaces || 3; // Par défaut 3 décimales si non spécifié
					
					// Arrondir la réponse de l'utilisateur au nombre de décimales attendues
					const roundedUserAnswer = parseFloat(userAnswer.toFixed(decimalPlaces));
					
					// Tolérance adaptée au nombre de décimales
					// Plus le nombre de décimales est élevé, plus la tolérance doit être fine
					const tolerance = Math.max(Math.abs(data.correctAnswer) * 0.01, Math.pow(10, -decimalPlaces) * 5);
					
					const isCorrect = Math.abs(roundedUserAnswer - data.correctAnswer) <= tolerance;
					
					if (isCorrect) {
						resultDiv.textContent = \`✅ Correct ! Bien joué ! (\${decimalPlaces} décimales attendues)\`;
						resultDiv.className = "result correct show";
						hintDiv.style.display = "none";
						
						if (!answered.has(exerciseNum)) {
							answered.add(exerciseNum);
							score++;
							document.getElementById('score').textContent = score;
							
							// Sauvegarder la réponse
							userAnswers[exerciseNum - 1] = userAnswer;
							
							// SCORM: Enregistrer l'interaction
							recordInteraction(exerciseNum - 1, isCorrect);
							
							// SCORM: Sauvegarder le score
							saveScore();
							
							// SCORM: Sauvegarder l'état
							saveState();
							
							// Mettre à jour le bouton de fin
							updateFinishButton();
						}
						
						// Désactiver l'input et le bouton
						document.getElementById(\`answer\${exerciseNum}\`).disabled = true;
						document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"] .check-btn\`).disabled = true;
						document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"] .prepare-titration-btn\`).disabled = true;
					} else {
						resultDiv.textContent = \`❌ Incorrect. Réessayez ou vérifiez votre calcul. (\${decimalPlaces} décimales attendues)\`;
						resultDiv.className = "result incorrect show";
						hintDiv.style.display = "block";
					}
				}
				
				// Mettre à jour le bouton de fin
				function updateFinishButton() {
					const finishBtn = document.getElementById('finishBtn');
					if (answered.size >= 1) {
						finishBtn.disabled = false;
					} else {
						finishBtn.disabled = true;
					}
				}
				
				// Terminer l'activité
				function finishActivity() {
					// Vérifier si au moins une question est répondue
					if (answered.size === 0) {
						// Afficher un message d'erreur intégré à l'interface
						const validationMessage = document.getElementById('validation-message');
						validationMessage.style.display = 'block';
						validationMessage.style.backgroundColor = '#f8d7da';
						validationMessage.style.border = '1px solid #f5c6cb';
						validationMessage.style.color = '#721c24';
						validationMessage.textContent = "Vous devez répondre à au moins une question avant de terminer l'activité.";
						
						// Masquer le message après 5 secondes
						setTimeout(() => {
							validationMessage.style.display = 'none';
						}, 5000);
						return;
					}
					
					// Marquer le test comme terminé
					testCompleted = true;
					
					// SCORM: Marquer comme terminé
					setValue("cmi.completion_status", "completed");
					setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
					setValue("cmi.exit", "normal");
					
					// SCORM: Mettre à jour le temps de session
					updateSessionTime();
					
					// SCORM: Sauvegarder l'état final
					saveState();
					
					// SCORM: Effectuer un commit final
					commitSCORM();
					
					// Désactiver tous les inputs et boutons
					document.querySelectorAll('input, .check-btn, .finish-btn, .start-titration-btn, .prepare-titration-btn, select').forEach(el => {
						el.disabled = true;
					});
					
					// Afficher le modal de fin d'activité
					showCompletionModal();
				}
				
				// Afficher le modal de fin d'activité
				function showCompletionModal() {
					// Mettre à jour les données du modal
					document.getElementById('modal-score').textContent = score;
					document.getElementById('modal-total').textContent = totalExercises;
					
					// Calculer le pourcentage
					const percentage = Math.round((score / totalExercises) * 100);
					document.getElementById('modal-badge').textContent = percentage + '%';
					
					// Définir si l'étudiant a réussi ou échoué (seuil à 70%)
					const isPassed = percentage >= 70;
					if (!isPassed) {
						document.getElementById('modal-badge').classList.add('failed');
					}
					
					// Mettre à jour le texte du score
					const scoreText = document.getElementById('modal-score-text');
					if (isPassed) {
						scoreText.textContent = "Félicitations ! Vous avez réussi l'activité.";
					} else {
						scoreText.textContent = "Vous n'avez pas atteint le score minimum requis de 70%.";
					}
					
					// Générer le résumé des exercices
					const summaryContainer = document.getElementById('exercise-summary');
					summaryContainer.innerHTML = '';
					
					for (let i = 0; i < totalExercises; i++) {
						const exerciseNum = i + 1;
						const isCompleted = answered.has(exerciseNum);
						
						const exerciseItem = document.createElement('div');
						exerciseItem.className = 'exercise-item';
						
						exerciseItem.innerHTML = \`
							<span>Exercice \${exerciseNum}</span>
							<span class="exercise-status \${isCompleted ? 'status-completed' : 'status-incomplete'}">
								\${isCompleted ? 'Complété ✓' : 'Non complété ✗'}
							</span>
						\`;
						
						summaryContainer.appendChild(exerciseItem);
					}
					
					// Afficher le modal
					const modal = document.getElementById('completion-modal');
					modal.style.display = 'flex';
					
					// Ajouter l'événement de fermeture au bouton
					document.getElementById('close-modal-btn').addEventListener('click', () => {
						modal.style.display = 'none';
					});
					
					// Fermer le modal en cliquant en dehors
					modal.addEventListener('click', (event) => {
						if (event.target === modal) {
							modal.style.display = 'none';
						}
					});
				}
			
				// ========== FONCTIONS SCORM ==========
				
				// Détection de l'API SCORM
				function findAPI(win) {
					// Recherche SCORM 2004 API
					if (win.API_1484_11) return win.API_1484_11;
					
					// Recherche dans les frames
					let findAPITries = 0;
					while (win.parent && win.parent != win && findAPITries < 10) {
						findAPITries++;
						win = win.parent;
						if (win.API_1484_11) return win.API_1484_11;
					}
					
					// Si on n'a pas trouvé, essayer avec les frames
					let frames = win.frames;
					for (let i = 0; i < frames.length; i++) {
						let api = findAPI(frames[i]);
						if (api) return api;
					}
					
					return null;
				}
				
				// Gestion des erreurs
				function getLastError() {
					if (API_1484_11) {
						let errorCode = API_1484_11.GetLastError();
						let errorString = API_1484_11.GetErrorString(errorCode);
						let errorDescription = API_1484_11.GetDiagnostic(errorCode);
						
						let errorInfo = "Code: " + errorCode + "\\nDescription: " + errorString + "\\nDiagnostic: " + errorDescription;
						console.error("SCORM Error: " + errorInfo);
						
						lastError = errorInfo;
						return errorCode;
					}
					return 0;
				}
				
				// Initialisation SCORM
				function initSCORM() {
					if (initialized) return true;
					
					// Trouver l'API SCORM 2004
					API_1484_11 = findAPI(window);
					
					if (!API_1484_11) {
						console.error("SCORM API non trouvée");
						return false;
					}
					
					// Initialiser la communication
					let result = API_1484_11.Initialize("");
					
					if (result === "true" || result === true) {
						console.log("SCORM API initialisée avec succès");
						initialized = true;
						
						// Récupérer l'état précédent si disponible
						entryStatus = getValue("cmi.entry");
						suspendData = getValue("cmi.suspend_data");
						
						// Récupérer les données sauvegardées si elles existent
						if (suspendData) {
							try {
								restoreState(suspendData);
							} catch (e) {
								console.error("Erreur lors de la restauration des données:", e);
							}
						}
						
						return true;
					} else {
						console.error("Échec de l'initialisation SCORM");
						getLastError();
						return false;
					}
				}
				
				// Définir une valeur SCORM
				function setValue(element, value) {
					if (!initialized || !API_1484_11) {
						console.error("SCORM API non initialisée");
						return false;
					}
					
					let result = API_1484_11.SetValue(element, value);
					
					if (result === "false" || result === false) {
						console.error(\`Erreur lors de la définition de \${element} = \${value}\`);
						getLastError();
						return false;
					}
					
					return true;
				}
				
				// Obtenir une valeur SCORM
				function getValue(element) {
					if (!initialized || !API_1484_11) {
						console.error("SCORM API non initialisée");
						return "";
					}
					
					let value = API_1484_11.GetValue(element);
					
					if (API_1484_11.GetLastError() !== "0") {
						console.error(\`Erreur lors de la récupération de \${element}\`);
						getLastError();
						return "";
					}
					
					return value;
				}
				
				// Sauvegarder les changements SCORM
				function commitSCORM() {
					if (!initialized || !API_1484_11) {
						console.error("SCORM API non initialisée");
						return false;
					}
					
					let result = API_1484_11.Commit("");
					
					if (result === "false" || result === false) {
						console.error("Erreur lors du commit SCORM");
						getLastError();
						return false;
					}
					
					return true;
				}
				
				// Terminer la session SCORM
				function terminateSCORM() {
					if (!initialized || !API_1484_11 || terminated) {
						return false;
					}
					
					// Arrêter le suivi du temps
					stopTimeTracking();
					
					// Mettre à jour le temps de session final
					updateSessionTime();
					
					// Commit final avant de terminer
					commitSCORM();
					
					// Terminer la session
					let result = API_1484_11.Terminate("");
					
					if (result === "true" || result === true) {
						console.log("Session SCORM terminée avec succès");
						terminated = true;
						return true;
					} else {
						console.error("Erreur lors de la terminaison de la session SCORM");
						getLastError();
						return false;
					}
				}
				
				// Sauvegarde de l'état
				function saveState() {
					// Créer un objet avec toutes les données à sauvegarder
					const stateData = {
						userAnswers: userAnswers,
						score: score,
						answered: Array.from(answered),
						testCompleted: testCompleted,
						selectedExerciseNum: selectedExerciseNum,
						setupValidated: setupValidated
					};
					
					// Convertir en JSON
					suspendData = JSON.stringify(stateData);
					
					// Sauvegarder dans SCORM
					setValue("cmi.suspend_data", suspendData);
					
					// Sauvegarder le score actuel
					saveScore();
					
					// Sauvegarder l'état de progression
					saveProgress();
					
					// Commit immédiat pour assurer la persistance des données
					commitSCORM();
					
					console.log("État sauvegardé avec succès après modification");
				}
				
				// Restauration de l'état
				function restoreState(jsonString) {
					if (!jsonString) return;
					
					try {
						const data = JSON.parse(jsonString);
						
						// Restaurer les données
						userAnswers = data.userAnswers || Array(totalExercises).fill(null);
						score = data.score || 0;
						answered = new Set(data.answered || []);
						testCompleted = data.testCompleted || false;
						selectedExerciseNum = data.selectedExerciseNum || null;
						setupValidated = data.setupValidated || false;
						
						// Mettre à jour l'interface
						document.getElementById('score').textContent = score;
						
						// Mettre à jour chaque exercice
						for (let i = 0; i < userAnswers.length; i++) {
							if (userAnswers[i] !== null) {
								const exerciseNum = i + 1;
								const inputElement = document.getElementById(\`answer\${exerciseNum}\`);
								const buttonElement = inputElement.parentElement.querySelector('.check-btn');
								const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
								const volumeValueElement = document.getElementById(\`value\${exerciseNum}-5\`);
								
								// Afficher la réponse
								inputElement.value = userAnswers[i];
								inputElement.disabled = true;
								buttonElement.disabled = true;
								
								// Afficher le volume équivalent s'il a été déterminé
								if (exerciseData[i] && exerciseData[i].equivalenceVolume) {
									volumeValueElement.textContent = \`\${exerciseData[i].equivalenceVolume.toFixed(1)} mL\`;
								}
								
								// Afficher le résultat
								resultDiv.textContent = "✅ Déjà répondu";
								resultDiv.className = "result correct show";
								
								// Désactiver le bouton de préparation
								const prepareBtn = document.querySelector(\`.exercise-card[data-exercise="\${exerciseNum}"] .prepare-titration-btn\`);
								if (prepareBtn) prepareBtn.disabled = true;
							}
						}
						
						// Si un exercice était sélectionné, mettre à jour l'interface
						if (selectedExerciseNum !== null) {
							// Mettre en évidence l'exercice sélectionné
							document.querySelectorAll('.exercise-card').forEach(card => {
								card.classList.remove('selected');
							});
							const selectedCard = document.querySelector(\`.exercise-card[data-exercise="\${selectedExerciseNum}"]\`);
							if (selectedCard) selectedCard.classList.add('selected');
							
							// Si la préparation était validée, mettre à jour l'interface
							if (setupValidated) {
								document.getElementById('validate-setup').disabled = true;
								document.getElementById('burette-content').disabled = true;
								document.getElementById('erlenmeyer-content').disabled = true;
								document.getElementById('indicator-type').disabled = true;
								document.getElementById('start-titration').disabled = false;
							}
						}
						
						// Mettre à jour le bouton de fin
						updateFinishButton();
						
						// Si le test est déjà terminé, désactiver tous les contrôles
						if (testCompleted) {
							document.querySelectorAll('input, .check-btn, .finish-btn, .prepare-titration-btn, select, .start-titration-btn, .validate-setup-btn').forEach(el => {
								el.disabled = true;
							});
							
							// Afficher un message indiquant que l'activité est terminée
							const validationMessage = document.getElementById('validation-message');
							validationMessage.style.display = 'block';
							validationMessage.style.backgroundColor = '#d4edda';
							validationMessage.style.border = '1px solid #c3e6cb';
							validationMessage.style.color = '#155724';
							validationMessage.textContent = \`Cette activité a déjà été complétée. Votre score est de \${score}/\${totalExercises}.\`;
						}
						
						console.log("État restauré avec succès");
					} catch (e) {
						console.error("Erreur lors de la restauration de l'état:", e);
					}
				}
				
				// Sauvegarde du score
				function saveScore() {
					// Normaliser le score sur 100
					const normalizedScore = Math.min(Math.max((score / totalExercises) * 100, 0), 100);
					
					// Sauvegarder dans SCORM 2004
					setValue("cmi.score.raw", normalizedScore);
					setValue("cmi.score.min", "0");
					setValue("cmi.score.max", "100");
					setValue("cmi.score.scaled", normalizedScore / 100);
					
					// Déterminer si le test est réussi (seuil de réussite à 70%)
					if (testCompleted) {
						const passed = normalizedScore >= 70;
						setValue("cmi.success_status", passed ? "passed" : "failed");
					}
					
					console.log(\`Score sauvegardé: \${normalizedScore}/100 (\${score}/\${totalExercises})\`);
					
					// Commit immédiat pour assurer la persistance du score
					commitSCORM();
				}
				
				// Suivi de la progression
				function saveProgress() {
					// Calculer le pourcentage de complétion
					const progress = answered.size / totalExercises;
					
					// Déterminer l'état de complétion
					let completionStatus = "incomplete";
					
					if (testCompleted) {
						completionStatus = "completed";
					} else if (progress > 0) {
						completionStatus = "incomplete";
					} else {
						completionStatus = "not attempted";
					}
					
					// Sauvegarder dans SCORM
					setValue("cmi.completion_status", completionStatus);
					setValue("cmi.progress_measure", progress.toFixed(2));
					
					console.log(\`Progression sauvegardée: \${(progress * 100).toFixed(0)}%, état: \${completionStatus}\`);
				}
				
				// Enregistrement des interactions
				function recordInteraction(exerciseIndex, isCorrect) {
					if (!initialized) return;
					
					// Générer un ID unique pour l'interaction
					const interactionId = \`ex\${exerciseIndex}\`;
					
					// Type d'interaction (choix numérique)
					const interactionType = "numeric";
					
					// Description de l'exercice
					const description = \`Exercice \${exerciseIndex + 1}\`;
					
					// Réponse de l'utilisateur
					const learnerAnswer = userAnswers[exerciseIndex].toString();
					
					// Résultat
					const result = isCorrect ? "correct" : "incorrect";
					
					// Horodatage
					const timestamp = new Date().toISOString();
					
					// Poids de l'exercice (1 point par exercice)
					const weighting = "1";
					
					// Durée (non implémentée ici)
					const latency = "PT0H0M0S";
					
					// Nombre total d'interactions jusqu'à présent
					const n = parseInt(getValue("cmi.interactions._count"), 10) || 0;
					
					// Enregistrer l'interaction
					setValue(\`cmi.interactions.\${n}.id\`, interactionId);
					setValue(\`cmi.interactions.\${n}.type\`, interactionType);
					setValue(\`cmi.interactions.\${n}.description\`, description);
					setValue(\`cmi.interactions.\${n}.learner_response\`, learnerAnswer);
					setValue(\`cmi.interactions.\${n}.result\`, result);
					setValue(\`cmi.interactions.\${n}.timestamp\`, timestamp);
					setValue(\`cmi.interactions.\${n}.weighting\`, weighting);
					setValue(\`cmi.interactions.\${n}.latency\`, latency);
					
					console.log(\`Interaction enregistrée: Exercice \${exerciseIndex + 1}, Résultat: \${result}\`);
					
					// Commit pour sauvegarder cette interaction
					commitSCORM();
				}
				
				// Gestion du temps de session
				function startTimeTracking() {
					sessionStartTime = Date.now();
					lastTimeUpdate = sessionStartTime;
					
					// Mettre à jour le temps toutes les 30 secondes
					timeInterval = setInterval(() => {
						updateSessionTime();
					}, 30000); // 30 secondes
				}
				
				function updateSessionTime() {
					const currentTime = Date.now();
					const elapsedTime = currentTime - lastTimeUpdate;
					
					totalTime += elapsedTime;
					lastTimeUpdate = currentTime;
					
					// Formater le temps selon SCORM 2004
					const formattedTime = formatScormTime(totalTime);
					
					// Sauvegarder dans SCORM
					setValue("cmi.session_time", formattedTime);
					
					// Commit pour sauvegarder le temps
					commitSCORM();
				}
				
				function formatScormTime(milliseconds) {
					const totalSeconds = Math.floor(milliseconds / 1000);
					const hours = Math.floor(totalSeconds / 3600);
					const minutes = Math.floor((totalSeconds % 3600) / 60);
					const seconds = totalSeconds % 60;
					
					// Format SCORM 2004: PTxHyMzS
					return \`PT\${hours}H\${minutes}M\${seconds}S\`;
				}
				
				function stopTimeTracking() {
					if (timeInterval) {
						clearInterval(timeInterval);
						updateSessionTime(); // Enregistrer le temps final
					}
				}
			}`,
				
				code: `<div class="score-board">
				Score: <span class="score" id="score">0</span> / <span id="total">6</span>
			</div>
			
			<div class="container">
				<h1>Exercices de Titrage Acido-Basique</h1>
				
				<!-- Titration Simulation Panel -->
				<div class="titration-panel">
					<div class="titration-controls">
						<div class="control-group">
							<h3>Configuration du Titrage</h3>
							<div class="input-group">
								<label for="burette-content">Produit dans la burette:</label>
								<select id="burette-content">
									<option value="acid">Acide</option>
									<option value="base" selected>Base</option>
								</select>
							</div>
							<div class="input-group">
								<label for="erlenmeyer-content">Produit dans l'erlenmeyer:</label>
								<select id="erlenmeyer-content">
									<option value="acid" selected>Acide</option>
									<option value="base">Base</option>
								</select>
							</div>
							<div class="input-group">
								<label for="indicator-type">Indicateur coloré:</label>
								<select id="indicator-type">
									<option value="bromothymol" selected>Bleu de bromothymol</option>
									<option value="phenolphthalein">Phénolphtaléine</option>
								</select>
							</div>
							<button id="validate-setup" class="validate-setup-btn">Valider la préparation</button>
						</div>
						
						<div class="control-group">
							<h3>Informations</h3>
							<div id="titration-info">
								<p id="indicator-info">Indicateur: Bleu de bromothymol</p>
								<p id="volume-info">Volume dans l'erlenmeyer: 20.0 mL</p>
								<p id="concentration-info">Concentration du titrant: 0.1 mol/L</p>
								<p id="equivalence-info" style="display: none;">Volume équivalent: ? mL</p>
							</div>
						</div>
					</div>
					
					<div class="titration-setup">
						<!-- Burette -->
						<div class="burette">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 137 1187.4" width="50" height="300">
								<defs>
									<linearGradient id="buretteFill" x1="0%" y1="0%" x2="0%" y2="100%">
										<stop offset="0%" style="stop-color: #d2e1eb; stop-opacity: 1" />
										<stop offset="100%" style="stop-color: #c5d5e0; stop-opacity: 1" />
									</linearGradient>
								</defs>
								
								<!-- Burette body -->
								<path
									style="fill: none; stroke: #216778; stroke-width: 1"
									d="m11.32 11.698h63.98c2.95 0 5.33 5.96 5.33 13.36v915.97c-0.21 19.51-13.94 27.84-24.05 31.61l-1.25 193.56c-0.25 11.19-5.12 20.02-12.78 20.19-8.04 0.18-12.76-8.05-13.54-19.52l0.96-194.61c-2.93-0.43-21.43-8.58-24.91-29.98l0.92-917.23c0-7.4 2.38-13.36 5.33-13.36z"
								/>
								
								<!-- Markings -->
								<path style="fill: #216778" d="M22.48 33.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 53.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 73.9v1h28.7v-1z" />
								<path style="fill: #216778" d="M22.48 93.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 113.9v1h28.7v-1z" />
								<path style="fill: #216778" d="M22.48 133.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 153.9v1h28.7v-1z" />
								<path style="fill: #216778" d="M22.48 173.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 193.9v1h28.7v-1z" />
								<path style="fill: #216778" d="M22.48 213.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 233.9v1h28.7v-1z" />
								<path style="fill: #216778" d="M22.48 253.9v1h19.8v-1z" />
								<path style="fill: #216778" d="M22.48 273.9v1h28.7v-1z" />
								
								<!-- Numbers for graduations -->
								<text x="55" y="76.9" style="fill: #216778; font-size: 8px;">0</text>
								<text x="55" y="156.9" style="fill: #216778; font-size: 8px;">10</text>
								<text x="55" y="236.9" style="fill: #216778; font-size: 8px;">20</text>
								<text x="55" y="276.9" style="fill: #216778; font-size: 8px;">25</text>
								
								<!-- Solution inside burette -->
								<rect
									id="burette-fill"
									x="11.32"
									y="11.698"
									width="63.98"
									height="0"
									style="fill: url(#buretteFill); opacity: 0.8"
								/>
								
								<!-- Valve -->
								<path
									style="fill: #216778"
									d="M102.01 1061.2h-99.04v-25.67h99.04c-1.78 8.7-1.65 17.24 0 25.67z"
								/>
								<rect
									style="fill: #216778"
									x="17.23"
									y="1021.3"
									width="50.64"
									height="54.07"
								/>
								<path
									style="fill: #2c89a0"
									d="m117.84 1014.9 1.19 1.16 1.15-1.16-1.15 0.44-1.19-0.44z"
								/>
							</svg>
						</div>
						
						<!-- Animated drop (caché) -->
						<div id="drop" class="drop"></div>
						
						<!-- Erlenmeyer flask -->
						<div class="erlenmeyer">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 276" width="60" height="120">
								<defs>
									<linearGradient id="erlenFill" x1="0%" y1="0%" x2="0%" y2="100%">
										<stop offset="0%" style="stop-color: #d2e1eb; stop-opacity: 0.9" />
										<stop offset="100%" style="stop-color: #c5d5e0; stop-opacity: 0.6" />
									</linearGradient>
								</defs>
								
								<!-- Flask outline -->
								<path
									style="fill: none; stroke: #9fabb9; stroke-width: 1"
									d="m67.236 1.7446l10.625 10.625v67.312c-7.086 10.63-48.434 89.778-70.875 134.66-7.0863 14.17-7.0671 31.89 3.563 46.06 7.086 10.63 19.461 14.19 31.875 14.19h127.57c12.41 0 24.78-3.56 31.87-14.19 10.63-14.17 10.65-31.89 3.56-46.06-20.07-44.88-43.7-89.78-63.78-134.66v-67.31l10.28-10.282 0.35-0.3434h-85.034z"
								/>
								
								<!-- Glass effect -->
								<path
									style="fill: #d7e9fc; opacity: 0.5"
									d="m67.236 1.7446l10.625 10.625v67.312c-7.086 10.63-48.434 89.778-70.875 134.66-7.0863 14.17-7.0671 31.89 3.563 46.06 7.086 10.63 19.461 14.19 31.875 14.19h127.57c12.41 0 24.78-3.56 31.87-14.19 10.63-14.17 10.65-31.89 3.56-46.06-20.07-44.88-43.7-89.78-63.78-134.66v-67.31l10.28-10.282 0.35-0.3434h-85.034z"
								/>
								
								<!-- Solution in flask -->
								<path
									id="erlen-fill"
									class="solution-layer"
									style="fill: url(#erlenFill)"
									d="m68.309 110c-14.788 26.37-39.847 73.05-55.375 103.07-6.6406 12.83-6.617 28.85 3.343 41.68 6.64 9.63 18.244 12.85 29.875 12.85h119.5c11.63 0 23.24-3.22 29.88-12.85 9.96-12.83 9.98-28.85 3.34-41.68-15.9-34.35-34.05-68.72-50.69-103.07h-79.871z"
								/>
							</svg>
						</div>
						
						<!-- Stir bar -->
						<div id="stir-bar" class="stir-bar"></div>
						
						<!-- Magnetic stirrer plate -->
						<div class="magnetic-stirrer">
							<div class="stirrer-button">
								<div id="stirrer-indicator" class="stirrer-indicator"></div>
							</div>
						</div>
					</div>
					
					<button id="start-titration" class="start-titration-btn">Démarrer le Titrage</button>
					
					<!-- Notification de validation -->
					<div id="validation-message" class="validation-message" style="display: none;">
						Préparation validée ! La burette et l'erlenmeyer sont maintenant remplis. Vous pouvez démarrer le titrage.
					</div>
					
					<!-- Equivalence Point Notice -->
					<div id="equivalence-notice" class="equivalence-notice">
						<h3>Point d'équivalence atteint !</h3>
						<p id="equivalence-message">La solution a changé de couleur, indiquant le point d'équivalence.</p>
					</div>
				</div>
				
				<div class="formula">
					Formule: Ca × Va = Cb × Vb
					<br>
					<small style="font-weight: normal; color: #666;">
						Où Ca et Cb sont les concentrations molaires, Va et Vb sont les volumes en mL
					</small>
				</div>
				
				<div class="exercises">
					<!-- Exercice 1 -->
					<div class="exercise-card" data-exercise="1">
						<div class="material-header">
							<span>Exercice 1</span>
							<span class="exercise-badge" id="badge1"></span>
						</div>
						
						<div class="question-text">
							Calculez la concentration inconnue en utilisant la formule Ca × Va = Cb × Vb
							<button class="prepare-titration-btn" onclick="prepareExerciseTitration(1)">Préparer le titrage</button>
						</div>
						
						<div class="data-table">
							<div class="data-row">
								<span class="data-label" id="label1-1">Produit titré:</span>
								<span class="data-value" id="value1-1">Acide</span>
							</div>
							<div class="data-row">
								<span class="data-label" id="label1-2">Volume titré (Va):</span>
								<span class="data-value" id="value1-2">20 mL</span>
							</div>
							<div class="data-row">
								<span class="data-label" id="label1-3">Titrant:</span>
								<span class="data-value" id="value1-3">Base</span>
							</div>
							<div class="data-row">
								<span class="data-label" id="label1-4">Concentration du titrant (Cb):</span>
								<span class="data-value" id="value1-4">0.1 mol/L</span>
							</div>
							<div class="data-row">
								<span class="data-label" id="label1-5">Volume équivalent (Vb):</span>
								<span class="data-value" id="value1-5">? mL</span>
							</div>
						</div>
						
						<div class="input-group">
							<label id="answer-label1">Concentration inconnue (Ca) en mol/L (3 décimales):</label>
							<input type="number" id="answer1" placeholder="Entrez votre réponse" step="0.001">
							<button class="check-btn" onclick="checkAnswer(1)">Vérifier</button>
							<div class="result" id="result1"></div>
							<div class="hint" id="hint1">💡 Utilisez la formule Ca × Va = Cb × Vb et isolez Ca</div>
						</div>
					</div>
					
					<!-- Les exercices 2-6 ont une structure similaire, ils seront générés dynamiquement -->
				</div>
				
				<button id="finishBtn" class="finish-btn" disabled>Terminer l'activité</button>
				
				<!-- Modal de fin d'activité -->
				<div id="completion-modal" class="modal-overlay">
					<div class="modal-content">
						<div id="modal-badge" class="modal-badge">70%</div>
						<div class="modal-header">
							<h2>Activité terminée !</h2>
							<p>Vous avez complété les exercices de titrage acido-basique.</p>
						</div>
						<div class="modal-body">
							<div class="score-result">
								<span id="modal-score">0</span>/<span id="modal-total">6</span>
							</div>
							<p class="score-text" id="modal-score-text">Vous avez réussi l'activité.</p>
							
							<div class="exercise-summary" id="exercise-summary">
								<!-- Les éléments seront générés dynamiquement -->
							</div>
						</div>
						<div class="modal-footer">
							<button id="close-modal-btn" class="close-modal-btn">Fermer</button>
						</div>
					</div>
				</div>
			</div>
			
			<style>
				/* Variables et styles de base */
				:root {
					/* Palette de couleurs */
					--primary-color: #4361ee;
					--primary-dark: #3a56d4;
					--primary-light: #7895ff;
					--success-color: #2ec4b6;
					--success-dark: #20a799;
					--warning-color: #ff9f1c;
					--danger-color: #e71d36;
					--text-color: #2b2d42;
					--text-light: #6c757d;
					--background-color: #f8f9fa;
					--card-color: #ffffff;
					--light-gray: #e9ecef;
					--border-color: #dee2e6;
					--border-radius: 12px;
					--shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
					--transition: all 0.3s ease;
					
					/* Couleurs des solutions */
					--acid-color: rgb(247, 164, 176);
					--base-color: rgb(142, 202, 230);
					--solution-color: rgb(221, 236, 246);
					
					/* Couleurs des indicateurs */
					--phenolphthalein-acid: rgba(240, 240, 240, 0);
					--phenolphthalein-base: rgb(255, 82, 168);
					--bromothymol-acid: rgb(255, 215, 0);
					--bromothymol-neutral: rgb(63, 191, 104);
					--bromothymol-base: rgb(26, 132, 233);
				}
				
				body {
					font-family: 'Arial', sans-serif;
					background: linear-gradient(135deg, #ea6687 0%, #8c4152 100%);
					min-height: 100vh;
					padding: 20px;
					color: var(--text-color);
					line-height: 1.6;
				}
				
				.container {
					max-width: 1200px;
					margin: 0 auto;
					background: white;
					border-radius: 20px;
					padding: 30px;
					box-shadow: 0 20px 40px rgba(0,0,0,0.1);
				}
				
				h1 {
					text-align: center;
					color: #333;
					margin-bottom: 20px;
					font-size: 2.5em;
				}
				
				.formula {
					text-align: center;
					background: #f0f0f0;
					padding: 20px;
					border-radius: 10px;
					margin: 20px 0;
					font-size: 1.3em;
					font-weight: bold;
					color: #444;
				}
				
				/* Titration Panel */
				.titration-panel {
					background: linear-gradient(145deg, #ffffff, #f5f7fa);
					border-radius: var(--border-radius);
					box-shadow: var(--shadow);
					padding: 25px;
					position: relative;
					margin-bottom: 30px;
					display: flex;
					flex-direction: column;
					align-items: center;
				}
				
				.titration-controls {
					display: flex;
					justify-content: space-around;
					align-items: center;
					width: 100%;
					margin-bottom: 20px;
					flex-wrap: wrap;
					gap: 20px;
				}
				
				.control-group {
					margin-right: -30px;
					background-color: var(--card-color);
					border-radius: var(--border-radius);
					box-shadow: var(--shadow);
					padding: 15px;
					border: 1px solid var(--border-color);
					min-width: 220px;
				}
				
				.control-group h3 {
					font-size: 1.1rem;
					margin-bottom: 10px;
					color: var(--primary-color);
				}
				
				.titration-setup {
					position: relative;
					height: 400px;
					width: 300px;
				}
				
				.burette {
					position: absolute;
					top: -240px; /* Déplacé vers le haut */
					left: 50%;
					transform: translateX(-40%);
					z-index: 10;
					filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
				}
				
				.erlenmeyer {
					position: absolute;
					bottom: 230px;
					left: 50%;
					transform: translateX(-50%);
					z-index: 5;
					filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
				}
				
				.magnetic-stirrer {
					position: absolute;
					top: 145px;
					left: 50%;
					transform: translateX(-50%);
					width: 180px;
					height: 45px;
					background: linear-gradient(to bottom, #3a3a3a, #222222);
					border-radius: 10px;
					display: flex;
					align-items: center;
					justify-content: center;
					box-shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
				}
				
				.stirrer-button {
					width: 42px;
					height: 42px;
					border-radius: 50%;
					background: linear-gradient(145deg, #333, #222);
					display: flex;
					align-items: center;
					justify-content: center;
					border: 2px solid #444;
					box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.3);
				}
				
				.stirrer-indicator {
					width: 32px;
					height: 32px;
					border-radius: 50%;
					background: radial-gradient(circle, #666, #444);
					transition: all 0.3s ease;
					box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
				}
				
				.stirrer-indicator.active {
					background: radial-gradient(circle, #ff3a3a, #cc1414);
					box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), inset 0 1px 3px rgba(0, 0, 0, 0.3);
				}
				
				.stir-bar {
					position: absolute;
					width: 24px;
					height: 6px;
					background-color: #333;
					border-radius: 4px;
					left: 50%;
					top: 125px;
					transform: translateX(-50%);
					z-index: 6;
					display: none;
					box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
				}
				
				.stir-bar.active {
					display: block;
					animation: rotating 1.5s linear infinite;
				}
				
				.drop {
					display: none; /* Gouttes cachées */
				}
				
				.solution-layer {
					display: none;
				}
				
				.equivalence-notice {
					display: none;
					margin-top: -180px;
					background: linear-gradient(145deg, rgba(46, 196, 182, 0.1), rgba(46, 196, 182, 0.05));
					border: 1px solid rgba(46, 196, 182, 0.3);
					border-radius: var(--border-radius);
					padding: 15px;
					text-align: center;
					box-shadow: 0 3px 10px rgba(46, 196, 182, 0.1);
					max-width: 800px;
					margin-left: auto;
					margin-right: auto;
				}
				
				.equivalence-notice h3 {
					color: var(--success-dark);
					font-weight: 600;
					margin-bottom: 10px;
					font-size: 1.2rem;
				}
				
				.equivalence-notice p {
					color: #3c6a56;
					font-size: 1rem;
					line-height: 1.5;
				}
				
				.start-titration-btn {
					position: relative;
					top: -210px;
					padding: 10px 20px;
					background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
					color: white;
					border: none;
					border-radius: 8px;
					font-size: 1rem;
					font-weight: 500;
					cursor: pointer;
					margin-top: 20px;
					transition: var(--transition);
					box-shadow: 0 3px 8px rgba(67, 97, 238, 0.25);
				}
				
				.start-titration-btn:hover {
					transform: translateY(-2px);
					box-shadow: 0 5px 15px rgba(67, 97, 238, 0.35);
				}
				
				.start-titration-btn:disabled {
					background: #a0aef8;
					opacity: 0.7;
					cursor: default;
					transform: none;
				}
				
				.validate-setup-btn {
					width: 100%;
					padding: 10px;
					margin-top: 10px;
					background: linear-gradient(145deg, var(--warning-color), #e88c19);
					color: white;
					border: none;
					border-radius: 8px;
					font-size: 0.9rem;
					font-weight: 500;
					cursor: pointer;
					transition: var(--transition);
					box-shadow: 0 3px 8px rgba(255, 159, 28, 0.25);
				}
				
				.validate-setup-btn:hover {
					transform: translateY(-2px);
					box-shadow: 0 5px 15px rgba(255, 159, 28, 0.35);
				}
				
				/* Animation et transitions */
				.color-transition {
					transition: all 3s ease-in-out;
				}
				
				.level-transition {
					transition: height 3s ease-in-out, y 3s ease-in-out;
				}
				
				.validate-setup-btn:disabled {
					background: #ffc580;
					opacity: 0.7;
					cursor: default;
					transform: none;
				}
				
				/* Animation et transitions */
				.color-transition {
					transition: all 3s ease-in-out;
				}
				
				.level-transition {
					transition: height 3s ease-in-out, y 3s ease-in-out;
				}
				.exercises {
					display: grid;
					grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
					gap: 20px;
					margin-top: 30px;
				}
				
				.exercise-card {
					background: #f8f9fa;
					border: 2px solid #e9ecef;
					border-radius: 15px;
					padding: 20px;
					transition: all 0.3s ease;
					position: relative;
				}
				
				.exercise-card:hover {
					transform: translateY(-5px);
					box-shadow: 0 10px 20px rgba(0,0,0,0.1);
				}
				
				.exercise-card.selected {
					border: 2px solid var(--primary-color);
					box-shadow: 0 0 15px rgba(67, 97, 238, 0.25);
					background-color: #f0f4ff;
				}
				
				.material-header {
					display: flex;
					align-items: center;
					margin-bottom: 15px;
					font-size: 1.2em;
					font-weight: bold;
					color: #333;
					justify-content: space-between;
				}
				
				.exercise-badge {
					display: inline-block;
					padding: 3px 8px;
					border-radius: 12px;
					font-size: 0.75rem;
					background-color: var(--primary-light);
					color: white;
				}
				
				.question-text {
					background: #f7f7f7;
					border-radius: 8px;
					padding: 15px;
					margin-bottom: 15px;
					font-size: 1.1em;
					color: #333;
				}
				
				.data-table {
					background: white;
					border-radius: 8px;
					padding: 15px;
					margin-bottom: 15px;
				}
				
				.data-row {
					display: flex;
					justify-content: space-between;
					padding: 5px 0;
					border-bottom: 1px solid #eee;
				}
				
				.data-row:last-child {
					border-bottom: none;
				}
				
				.data-label {
					color: #666;
				}
				
				.data-value {
					font-weight: bold;
					color: #333;
				}
				
				.input-group {
					margin-top: 15px;
				}
				
				.input-group label {
					display: block;
					margin-bottom: 5px;
					color: #555;
					font-weight: bold;
				}
				
				input[type="number"], select {
					width: 100%;
					padding: 10px;
					border: 2px solid #ddd;
					border-radius: 8px;
					font-size: 1.1em;
					transition: border-color 0.3s;
				}
				
				input[type="number"]:focus, select:focus {
					outline: none;
					border-color: #ea6687;
				}
				
				.check-btn {
					width: 100%;
					padding: 12px;
					margin-top: 10px;
					background: #ea6687;
					color: white;
					border: none;
					border-radius: 8px;
					font-size: 1.1em;
					font-weight: bold;
					cursor: pointer;
					transition: all 0.3s;
				}
				
				.check-btn:hover {
					background: #a24b5f;
					transform: translateY(-2px);
				}
				
				.check-btn:disabled {
					background: #a0aef8;
					opacity: 0.7;
					cursor: default;
					transform: none;
				}
				
				.prepare-titration-btn {
					width: 100%;
					padding: 10px;
					margin-top: 10px;
					margin-bottom: 15px;
					background: linear-gradient(145deg, var(--warning-color), #e88c19);
					color: white;
					border: none;
					border-radius: 8px;
					font-size: 0.9rem;
					font-weight: 500;
					cursor: pointer;
					transition: var(--transition);
					box-shadow: 0 3px 8px rgba(255, 159, 28, 0.25);
				}
				
				.prepare-titration-btn:hover {
					transform: translateY(-2px);
					box-shadow: 0 5px 15px rgba(255, 159, 28, 0.35);
				}
				
				.prepare-titration-btn:disabled {
					background: #ffc580;
					opacity: 0.7;
					cursor: default;
					transform: none;
				}
				
				.result {
					margin-top: 10px;
					padding: 10px;
					border-radius: 8px;
					font-weight: bold;
					text-align: center;
					opacity: 0;
					transition: opacity 0.3s;
				}
				
				.result.show {
					opacity: 1;
				}
				
				.result.correct {
					background: #d4edda;
					color: #155724;
					border: 1px solid #c3e6cb;
				}
				
				.result.incorrect {
					background: #f8d7da;
					color: #721c24;
					border: 1px solid #f5c6cb;
				}
				
				.hint {
					background: #fff3cd;
					border: 1px solid #ffeeba;
					color: #856404;
					padding: 10px;
					border-radius: 8px;
					margin-top: 10px;
					font-size: 0.9em;
					display: none;
				}
				
				.score-board {
					position: fixed;
					top: 20px;
					right: 20px;
					background: white;
					padding: 15px 20px;
					border-radius: 10px;
					box-shadow: 0 5px 15px rgba(0,0,0,0.1);
					font-weight: bold;
					color: #333;
					display: flex;
					align-items: center;
					justify-content: space-between;
					z-index: 100;
				}
				
				.score {
					color: #ea6687;
					font-size: 1.2em;
					margin-right: 15px;
				}
			</style>`
			},
			
			
			
		
            derivees: {
                title: "Fonctions Dérivées",
                description: "Un template pour créer des exercices sur les fonctions dérivées. L'apprenant doit calculer des dérivées de polynômes du second degré, déterminer des nombres dérivés ou résoudre des équations du type f'(x)=0.",
                features: [
                    "Génération aléatoire de fonctions polynomiales",
                    "Trois types d'exercices configurables",
                    "Système de tentatives multiples paramétrable",
                    "Interface avec menus déroulants pour la saisie",
                    "Vérification automatique des réponses",
                    "Feedback détaillé et explications"
                ],
                icon: "fas fa-chart-line",
                previewHtml: `
                <div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px; color: #5a67d8;">Exercice 1: Expression de la dérivée</h3>
                        <div style="background: rgba(102, 126, 234, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center;">
                            <div style="font-size: 1.3em; font-weight: bold;">f(x) = 3x² - 5x + 2</div>
                        </div>
                        <div style="background: #f7f7f7; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                            <span style="font-size: 1.2em; font-weight: 500;">f'(x) = </span>
                            <select style="padding: 8px; border: 2px solid #667eea; border-radius: 5px; background: white;">
                                <option>6</option>
                            </select>
                            <span style="font-size: 1.2em;">x</span>
                            <span style="font-size: 1.2em;">+</span>
                            <select style="padding: 8px; border: 2px solid #667eea; border-radius: 5px; background: white;">
                                <option>-5</option>
                            </select>
                        </div>
                        <div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; display: flex; align-items: center;">
                            <span style="margin-right: 10px; background: #28a745; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</span>
                            ✅ Correct ! La dérivée est f'(x) = 6x - 5
                        </div>
                    </div>
                </div>
                `,
                
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE DERIVEES : PRIORITE OBLIGATOIRE SI CHOISIE
		
				// ==================== CONFIGURATION SPECIFIQUE DERIVEES ====================
				
				/* TYPES DE QUESTIONS CONFIGURABLES :
				 * Type 1: "derivative_expression" - Donner l'expression de la dérivée  
				 * Type 2: "derivative_value" - Calculer le nombre dérivé pour une valeur x donnée
				 * Type 3: "solve_derivative_zero" - Déterminer la solution de f'(x)=0
				 */
				
				// Configuration par défaut des exercices de dérivées
				const DERIVEES_CONFIG = {
					questionType: "derivative_expression", // Type de question par défaut
					maxAttempts: 2, // Nombre maximum de tentatives
					allowMultipleAttempts: true, // Autoriser plusieurs tentatives
					
					// Limites pour la génération des coefficients
					coeffLimits: {
						a: {min: -5, max: 5, nonZero: true},  // Coefficient de x²
						b: {min: -10, max: 10, nonZero: false}, // Coefficient de x  
						c: {min: -10, max: 10, nonZero: false}  // Terme constant
					},
					
					// Plages pour les valeurs de x (pour les calculs de nombres dérivés)
					xValueRange: {min: -5, max: 5},
					
					// Options des menus déroulants pour la saisie
					selectRanges: {
						coefX: {min: -20, max: 20},  // Coefficient devant x dans la dérivée
						constTerm: {min: -20, max: 20} // Terme constant dans la dérivée  
					}
				};
				
				// ==================== VARIABLES GLOBALES DERIVEES ====================
				
				// Données des exercices générées aléatoirement
				let deriveesExerciseData = [];
				
				// Suivi des tentatives par exercice
				let deriveesAttempts = Array(6).fill(0);
				
				// Réponses utilisateur
				let deriveesUserAnswers = Array(6).fill(null);
				
				// ==================== FONCTIONS UTILITAIRES DERIVEES ====================
				
				// Génère un entier aléatoire dans [min, max]
				function randomIntDerivees(min, max) {
					return Math.floor(Math.random() * (max - min + 1)) + min;
				}
				
				// Génère un entier aléatoire non nul dans [min, max]  
				function randomNonZeroDerivees(min, max) {
					let val = 0;
					while (val === 0) {
						val = randomIntDerivees(min, max);
					}
					return val;
				}
				
				// Formate un polynôme de degré 2 pour l'affichage
				function formatPolynomialDerivees(a, b, c) {
					let str = "f(x) = ";
					
					// Terme en x²
					if (a === 1) str += "x²";
					else if (a === -1) str += "-x²";
					else str += a + "x²";
					
					// Terme en x
					if (b > 0) str += " + " + (b === 1 ? "x" : b + "x");
					else if (b < 0) str += " - " + (Math.abs(b) === 1 ? "x" : Math.abs(b) + "x");
					
					// Terme constant
					if (c > 0) str += " + " + c;
					else if (c < 0) str += " - " + Math.abs(c);
					
					return str;
				}
				
				// ==================== GENERATION DE DONNEES D'EXERCICES ====================
				
				// Génère les données pour un exercice selon le type
				function generateDeriveesExerciseData(exerciseNum, questionType) {
					const { coeffLimits, xValueRange } = DERIVEES_CONFIG;
					
					// Génération des coefficients du polynôme
					const a = coeffLimits.a.nonZero 
						? randomNonZeroDerivees(coeffLimits.a.min, coeffLimits.a.max)
						: randomIntDerivees(coeffLimits.a.min, coeffLimits.a.max);
						
					const b = coeffLimits.b.nonZero 
						? randomNonZeroDerivees(coeffLimits.b.min, coeffLimits.b.max)
						: randomIntDerivees(coeffLimits.b.min, coeffLimits.b.max);
						
					const c = coeffLimits.c.nonZero 
						? randomNonZeroDerivees(coeffLimits.c.min, coeffLimits.c.max)
						: randomIntDerivees(coeffLimits.c.min, coeffLimits.c.max);
					
					// Calcul de la dérivée f'(x) = 2ax + b
					const derivativeCoef = 2 * a;
					const derivativeConst = b;
					
					let exerciseData = {
						exerciseNum,
						questionType,
						a, b, c,
						derivativeCoef,
						derivativeConst,
						functionDisplay: formatPolynomialDerivees(a, b, c)
					};
					
					// Données spécifiques selon le type de question
					switch(questionType) {
						case "derivative_expression":
							// Pas de données supplémentaires nécessaires
							exerciseData.expectedAnswer = {
								coef: derivativeCoef,
								const: derivativeConst
							};
							break;
							
						case "derivative_value":
							// Génération d'une valeur x pour le calcul du nombre dérivé
							const xValue = randomIntDerivees(xValueRange.min, xValueRange.max);
							const derivativeValue = derivativeCoef * xValue + derivativeConst;
							exerciseData.xValue = xValue;
							exerciseData.expectedAnswer = derivativeValue;
							break;
							
						case "solve_derivative_zero":
							// Calcul de la solution de f'(x) = 0
							// 2ax + b = 0 => x = -b/(2a)
							if (derivativeCoef !== 0) {
								exerciseData.expectedAnswer = -derivativeConst / derivativeCoef;
							} else {
								// Cas particulier où a = 0 (fonction linéaire)
								exerciseData.expectedAnswer = "aucune solution";
							}
							break;
					}
					
					return exerciseData;
				}
				
				// ==================== CREATION DE L'INTERFACE ====================
				
				// Construit le HTML pour la question selon le type
				function buildDeriveesQuestionHTML(exercise) {
					const { exerciseNum, questionType, functionDisplay, xValue } = exercise;
					
					let questionHTML = "";
					
					switch(questionType) {
						case "derivative_expression":
							questionHTML = \`
								<div class="derivees-question-text">
									Donnez l'expression de la dérivée de la fonction :
								</div>
								<div class="derivees-derivative-container">
									<div class="derivees-derivative-expression">f'(x) = </div>
									<select id="derivees-coef-x-\${exerciseNum}" class="derivees-select"></select>
									<div class="derivees-derivative-expression"> x </div>
									<span id="derivees-operator-\${exerciseNum}" class="derivees-derivative-expression"> + </span>
									<select id="derivees-const-term-\${exerciseNum}" class="derivees-select"></select>
								</div>
							\`;
							break;
							
						case "derivative_value":
							questionHTML = \`
								<div class="derivees-question-text">
									Calculez le nombre dérivé f'(\${xValue}) :
								</div>
								<div class="derivees-input-group">
									<label class="derivees-input-label">f'(\${xValue}) = </label>
									<input type="number" id="derivees-answer-\${exerciseNum}" class="derivees-input" placeholder="Votre réponse">
								</div>
							\`;
							break;
							
						case "solve_derivative_zero":
							questionHTML = \`
								<div class="derivees-question-text">
									Résolvez l'équation f'(x) = 0 :
								</div>
								<div class="derivees-input-group">
									<label class="derivees-input-label">x = </label>
									<input type="number" id="derivees-answer-\${exerciseNum}" class="derivees-input" placeholder="Votre réponse" step="0.01">
								</div>
							\`;
							break;
					}
					
					return questionHTML;
				}
				
				// Crée une carte d'exercice de dérivées
				function createDeriveesExerciseCard(exercise) {
					const { exerciseNum, functionDisplay } = exercise;
					
					const card = document.createElement('div');
					card.className = 'exercise-card';
					card.dataset.exercise = exerciseNum;
					
					card.innerHTML = \`
						<div class="material-header">
							<div class="exercise-title">
								<span>Exercice \${exerciseNum}</span>
								<div class="attempts-badge high" id="derivees-attempts\${exerciseNum}" title="Tentatives restantes">\${DERIVEES_CONFIG.maxAttempts}</div>
							</div>
						</div>
						
						<div class="function-display">
							\${functionDisplay}
						</div>
						
						<div class="derivees-question-container">
							\${buildDeriveesQuestionHTML(exercise)}
						</div>
						
						<button class="check-btn" id="derivees-check-btn-\${exerciseNum}">Vérifier</button>
						<div class="result" id="derivees-result\${exerciseNum}"></div>
						<div class="hint" id="derivees-hint\${exerciseNum}">💡 Pour f(x) = ax² + bx + c, la dérivée est f'(x) = 2ax + b</div>
					\`;
					
					return card;
				}
				
				// ==================== GESTION DES REPONSES ====================
				
				// Vérifie la réponse selon le type de question
				function checkDeriveesAnswer(exerciseNum) {
					const exercise = deriveesExerciseData.find(ex => ex.exerciseNum === exerciseNum);
					if (!exercise) return;
					
					const { questionType, expectedAnswer } = exercise;
					
					// Récupération des éléments DOM
					const resultDiv = document.getElementById(\`derivees-result\${exerciseNum}\`);
					const hintDiv = document.getElementById(\`derivees-hint\${exerciseNum}\`);
					const checkBtn = document.getElementById(\`derivees-check-btn-\${exerciseNum}\`);
					const exerciseCard = document.querySelector(\`[data-exercise="\${exerciseNum}"]\`);
					
					// Vérifier si déjà résolu ou tentatives épuisées
					if (answered.has(exerciseNum) || deriveesAttempts[exerciseNum - 1] >= DERIVEES_CONFIG.maxAttempts) {
						return;
					}
					
					// Incrémenter les tentatives
					deriveesAttempts[exerciseNum - 1]++;
					updateDeriveesAttemptsBadge(exerciseNum);
					
					let isCorrect = false;
					let userAnswer = null;
					
					// Vérification selon le type de question
					switch(questionType) {
						case "derivative_expression":
							isCorrect = checkDerivativeExpression(exerciseNum, expectedAnswer);
							break;
						case "derivative_value":
						case "solve_derivative_zero":
							isCorrect = checkNumericalAnswer(exerciseNum, expectedAnswer);
							break;
					}
					
					// Traitement du résultat
					processDeriveesResult(exerciseNum, isCorrect, expectedAnswer);
				}
				
				// Vérifie une expression de dérivée (menus déroulants)
				function checkDerivativeExpression(exerciseNum, expectedAnswer) {
					const coefSelect = document.getElementById(\`derivees-coef-x-\${exerciseNum}\`);
					const constSelect = document.getElementById(\`derivees-const-term-\${exerciseNum}\`);
					const resultDiv = document.getElementById(\`derivees-result\${exerciseNum}\`);
					
					if (coefSelect.value === "" || constSelect.value === "") {
						resultDiv.textContent = "⚠️ Veuillez sélectionner tous les coefficients.";
						resultDiv.className = "result incorrect show animate";
						return false;
					}
					
					const userCoef = parseInt(coefSelect.value, 10);
					const userConst = parseInt(constSelect.value, 10);
					
					deriveesUserAnswers[exerciseNum - 1] = { coef: userCoef, const: userConst };
					
					return userCoef === expectedAnswer.coef && userConst === expectedAnswer.const;
				}
				
				// Vérifie une réponse numérique
				function checkNumericalAnswer(exerciseNum, expectedAnswer) {
					const answerInput = document.getElementById(\`derivees-answer-\${exerciseNum}\`);
					const resultDiv = document.getElementById(\`derivees-result\${exerciseNum}\`);
					
					if (answerInput.value === "") {
						resultDiv.textContent = "⚠️ Veuillez entrer une réponse.";
						resultDiv.className = "result incorrect show animate";
						return false;
					}
					
					const userAnswer = parseFloat(answerInput.value);
					
					if (isNaN(userAnswer)) {
						resultDiv.textContent = "⚠️ Veuillez entrer un nombre valide.";
						resultDiv.className = "result incorrect show animate";
						return false;
					}
					
					deriveesUserAnswers[exerciseNum - 1] = userAnswer;
					
					// Tolérance pour les calculs décimaux (1%)
					const tolerance = Math.abs(expectedAnswer) * 0.01;
					return Math.abs(userAnswer - expectedAnswer) <= tolerance;
				}
				
				// Traite le résultat de la vérification
				function processDeriveesResult(exerciseNum, isCorrect, expectedAnswer) {
					const resultDiv = document.getElementById(\`derivees-result\${exerciseNum}\`);
					const hintDiv = document.getElementById(\`derivees-hint\${exerciseNum}\`);
					const checkBtn = document.getElementById(\`derivees-check-btn-\${exerciseNum}\`);
					const exerciseCard = document.querySelector(\`[data-exercise="\${exerciseNum}"]\`);
					const exercise = deriveesExerciseData.find(ex => ex.exerciseNum === exerciseNum);
					
					if (isCorrect) {
						// Réponse correcte
						let pointsAwarded = deriveesAttempts[exerciseNum - 1] === 1 ? 1 : 0.5;
						
						resultDiv.textContent = \`✅ Correct ! (+\${pointsAwarded} point)\`;
						resultDiv.className = "result correct show animate";
						hintDiv.style.display = "none";
						
						if (!answered.has(exerciseNum)) {
							answered.add(exerciseNum);
							score += pointsAwarded;
							document.getElementById('score').textContent = score;
							
							// SCORM: Enregistrer l'interaction
							recordInteraction(exerciseNum - 1, true, pointsAwarded);
							saveScore(score);
							saveState();
							updateFinishButton();
						}
						
						// Désactiver les contrôles
						disableDeriveesControls(exerciseNum);
						
						// Badge de réussite
						const badge = document.getElementById(\`derivees-attempts\${exerciseNum}\`);
						badge.textContent = "✓";
						badge.className = "attempts-badge high";
						
					} else {
						// Réponse incorrecte
						const attemptsLeft = DERIVEES_CONFIG.maxAttempts - deriveesAttempts[exerciseNum - 1];
						
						if (attemptsLeft > 0) {
							resultDiv.textContent = \`❌ Incorrect. Il vous reste \${attemptsLeft} tentative(s).\`;
							resultDiv.className = "result incorrect show animate";
							hintDiv.style.display = "block";
						} else {
							// Plus de tentatives
							const correctAnswerText = formatCorrectAnswer(exercise);
							resultDiv.textContent = \`❌ Tentatives épuisées. \${correctAnswerText}\`;
							resultDiv.className = "result blocked show animate";
							
							disableDeriveesControls(exerciseNum);
							exerciseCard.classList.add('blocked');
							
							recordInteraction(exerciseNum - 1, false, 0);
							saveState();
						}
					}
				}
				
				// ==================== GESTION DU BILAN FINAL ====================
				
				// Fonction pour terminer le test et afficher le bilan
				function finishDeriveesTest() {
					// Vérifier si au moins une question est répondue
					if (answered.size === 0) {
						alert("Vous devez répondre à au moins une question avant de terminer l'activité.");
						return;
					}
					
					// Marquer le test comme terminé
					testCompleted = true;
					
					// Calculer les statistiques du bilan
					const totalQuestions = 6;
					const questionsRepondues = answered.size;
					const questionsNonRepondues = totalQuestions - questionsRepondues;
					const pourcentageReussite = Math.round((score / totalQuestions) * 100);
					
					// Calculer la répartition des tentatives
					let premieresTentatives = 0;
					let deuxiemesTentatives = 0;
					let echecs = 0;
					
					for (let i = 0; i < totalQuestions; i++) {
						if (answered.has(i + 1)) {
							if (deriveesAttempts[i] === 1) {
								premieresTentatives++;
							} else {
								deuxiemesTentatives++;
							}
						} else if (deriveesAttempts[i] >= DERIVEES_CONFIG.maxAttempts) {
							echecs++;
						}
					}
					
					// Déterminer le niveau de réussite
					let niveauReussite = "";
					let couleurNiveau = "";
					if (pourcentageReussite >= 90) {
						niveauReussite = "Excellent";
						couleurNiveau = "#28a745";
					} else if (pourcentageReussite >= 70) {
						niveauReussite = "Bien";
						couleurNiveau = "#ffc107";
					} else if (pourcentageReussite >= 50) {
						niveauReussite = "Passable";
						couleurNiveau = "#fd7e14";
					} else {
						niveauReussite = "Insuffisant";
						couleurNiveau = "#dc3545";
					}
					
					// Créer le message de bilan détaillé
					const bilanMessage = \`
		🎯 BILAN FINAL - FONCTIONS DÉRIVÉES 🎯
		
		📊 RÉSULTATS :
		- Score final : \${score}/\${totalQuestions} (\${pourcentageReussite}%)
		- Niveau : \${niveauReussite}
		
		📈 DÉTAIL DES RÉPONSES :
		- Réussies du 1er coup : \${premieresTentatives}
		- Réussies au 2ème essai : \${deuxiemesTentatives}
		- Questions échouées : \${echecs}
		- Questions non tentées : \${questionsNonRepondues}
		
		⏱️ PERFORMANCE :
		- Type d'exercices : \${getQuestionTypeLabel(DERIVEES_CONFIG.questionType)}
		- Tentatives autorisées : \${DERIVEES_CONFIG.maxAttempts}
		- Efficacité : \${questionsRepondues > 0 ? Math.round((premieresTentatives / questionsRepondues) * 100) : 0}% de réussite immédiate
		
		\${pourcentageReussite >= 70 ? '🎉 Félicitations ! Vous maîtrisez les fonctions dérivées !' : '📚 Continuez à vous entraîner pour améliorer vos résultats.'}
					\`.trim();
					
					// Afficher le bilan
					alert(bilanMessage);
					
					// SCORM: Finaliser la session
					finalizeDeriveesSession(pourcentageReussite);
					
					// Désactiver tous les contrôles
					disableAllDeriveesControls();
					
					console.log("Activité Fonctions Dérivées terminée - Bilan affiché");
				}
				
				// Fonction pour finaliser la session SCORM
				function finalizeDeriveesSession(pourcentageReussite) {
					// SCORM: Marquer comme terminé
					setValue("cmi.completion_status", "completed");
					setValue("cmi.success_status", (pourcentageReussite >= 70) ? "passed" : "failed");
					setValue("cmi.exit", "normal");
					
					// SCORM: Enregistrer un commentaire de bilan
					const commentaire = \`Bilan final: \${score}/6 exercices réussis (\${pourcentageReussite}%). Type: \${getQuestionTypeLabel(DERIVEES_CONFIG.questionType)}.\`;
					setValue("cmi.learner_comment", commentaire);
					
					// SCORM: Mettre à jour le temps de session final
					updateSessionTime();
					
					// SCORM: Sauvegarder l'état final
					saveState();
					
					// SCORM: Effectuer un commit final
					commitSCORM();
					
					// SCORM: Terminer la session
					terminateSCORM();
				}
				
				// Fonction utilitaire pour obtenir le label du type de question
				function getQuestionTypeLabel(questionType) {
					switch(questionType) {
						case "derivative_expression":
							return "Expression de la dérivée";
						case "derivative_value":
							return "Calcul du nombre dérivé";
						case "solve_derivative_zero":
							return "Résolution de f'(x) = 0";
						default:
							return "Type non défini";
					}
				}
				
				// Fonction pour désactiver tous les contrôles à la fin
				function disableAllDeriveesControls() {
					// Désactiver tous les boutons de vérification
					document.querySelectorAll('[id^="derivees-check-btn-"]').forEach(btn => {
						btn.disabled = true;
					});
					
					// Désactiver tous les menus déroulants
					document.querySelectorAll('[id^="derivees-coef-x-"], [id^="derivees-const-term-"]').forEach(select => {
						select.disabled = true;
					});
					
					// Désactiver tous les inputs numériques
					document.querySelectorAll('[id^="derivees-answer-"]').forEach(input => {
						input.disabled = true;
					});
					
					// Désactiver le bouton "Terminer l'activité"
					const finishBtn = document.getElementById('finishBtn');
					if (finishBtn) {
						finishBtn.disabled = true;
						finishBtn.textContent = "Activité terminée";
					}
				}
				
				// Fonction pour mettre à jour le bouton "Terminer" selon la progression
				function updateFinishButton() {
					const finishBtn = document.getElementById('finishBtn');
					if (!finishBtn) return;
					
					if (answered.size >= 1) {
						finishBtn.disabled = false;
						finishBtn.textContent = \`Terminer l'activité (\${answered.size}/6 répondu\${answered.size > 1 ? 's' : ''})\`;
					} else {
						finishBtn.disabled = true;
						finishBtn.textContent = "Terminer l'activité";
					}
				}
				
				// Fonction pour afficher un aperçu du bilan en cours d'activité
				function showCurrentProgress() {
					const totalQuestions = 6;
					const questionsRepondues = answered.size;
					const pourcentageActuel = Math.round((score / totalQuestions) * 100);
					
					const progressMessage = \`
		📊 PROGRESSION ACTUELLE
		
		✅ Questions répondues : \${questionsRepondues}/\${totalQuestions}
		🎯 Score actuel : \${score}/\${totalQuestions} (\${pourcentageActuel}%)
		📈 Type d'exercices : \${getQuestionTypeLabel(DERIVEES_CONFIG.questionType)}
		
		\${questionsRepondues < totalQuestions ? 
			\`Il vous reste \${totalQuestions - questionsRepondues} question(s) à traiter.\` : 
			'Toutes les questions ont été traitées ! Vous pouvez terminer l\\'activité.'}
					\`.trim();
					
					alert(progressMessage);
				}
				
				// ==================== FONCTIONS UTILITAIRES COMPLEMENTAIRES ====================
				
				// Formate la réponse correcte pour l'affichage
				function formatCorrectAnswer(exercise) {
					const { questionType, expectedAnswer, derivativeCoef, derivativeConst, xValue } = exercise;
					
					switch(questionType) {
						case "derivative_expression":
							return \`La dérivée correcte est f'(x) = \${derivativeCoef}x \${derivativeConst >= 0 ? '+ ' + derivativeConst : '- ' + Math.abs(derivativeConst)}\`;
						case "derivative_value":
							return \`La réponse correcte est f'(\${xValue}) = \${expectedAnswer}\`;
						case "solve_derivative_zero":
							return \`La solution correcte est x = \${expectedAnswer}\`;
						default:
							return "Réponse incorrecte.";
					}
				}
				
				// Désactive les contrôles d'un exercice
				function disableDeriveesControls(exerciseNum) {
					const coefSelect = document.getElementById(\`derivees-coef-x-\${exerciseNum}\`);
					const constSelect = document.getElementById(\`derivees-const-term-\${exerciseNum}\`);
					const answerInput = document.getElementById(\`derivees-answer-\${exerciseNum}\`);
					const checkBtn = document.getElementById(\`derivees-check-btn-\${exerciseNum}\`);
					
					if (coefSelect) coefSelect.disabled = true;
					if (constSelect) constSelect.disabled = true;
					if (answerInput) answerInput.disabled = true;
					if (checkBtn) checkBtn.disabled = true;
				}
				
				// Met à jour le badge de tentatives
				function updateDeriveesAttemptsBadge(exerciseNum) {
					const badge = document.getElementById(\`derivees-attempts\${exerciseNum}\`);
					const attemptsLeft = DERIVEES_CONFIG.maxAttempts - deriveesAttempts[exerciseNum - 1];
					
					badge.textContent = attemptsLeft;
					badge.className = 'attempts-badge';
					
					if (attemptsLeft === 0) badge.classList.add('zero');
					else if (attemptsLeft === 1) badge.classList.add('low');
					else if (attemptsLeft === 2) badge.classList.add('medium');
					else badge.classList.add('high');
				}
				
				// ==================== GESTIONNAIRES D'ÉVÉNEMENTS GLOBAUX ====================
				
				// Gestionnaire pour le bouton "Terminer l'activité"
				function setupDeriveesFinishButton() {
					const finishBtn = document.getElementById('finishBtn');
					if (finishBtn) {
						// Remplacer l'ancien gestionnaire par le nouveau
						const newFinishBtn = finishBtn.cloneNode(true);
						finishBtn.parentNode.replaceChild(newFinishBtn, finishBtn);
						newFinishBtn.addEventListener('click', finishDeriveesTest);
					}
				}
				
				// Gestionnaire pour afficher la progression (raccourci clavier)
				function setupProgressShortcut() {
					document.addEventListener('keydown', (e) => {
						// Ctrl + P pour afficher la progression
						if (e.ctrlKey && e.key === 'p' && !testCompleted) {
							e.preventDefault();
							showCurrentProgress();
						}
					});
				}
				
				// ==================== INITIALISATION DERIVEES ====================
				
				// Initialise tous les exercices de dérivées
				function initDeriveesExercises() {
					// Générer les données d'exercice
					deriveesExerciseData = [];
					for (let i = 1; i <= 6; i++) {
						deriveesExerciseData.push(generateDeriveesExerciseData(i, DERIVEES_CONFIG.questionType));
					}
					
					// Créer les cartes d'exercice
					createAllDeriveesCards();
					
					// Initialiser les contrôles
					initializeDeriveesControls();
					
					// Configurer le bouton de fin d'activité pour les dérivées
					setupDeriveesFinishButton();
					
					// Configurer les raccourcis clavier
					setupProgressShortcut();
					
					// Mettre à jour le bouton de fin
					updateFinishButton();
				}
				
				// Crée toutes les cartes d'exercice
				function createAllDeriveesCards() {
					const container = document.getElementById('exercises-container');
					container.innerHTML = '';
					
					deriveesExerciseData.forEach(exercise => {
						const card = createDeriveesExerciseCard(exercise);
						container.appendChild(card);
					});
				}
				
				// Initialise les contrôles (menus déroulants, boutons)
				function initializeDeriveesControls() {
					deriveesExerciseData.forEach(exercise => {
						const { exerciseNum, questionType } = exercise;
						
						if (questionType === "derivative_expression") {
							// Initialiser les menus déroulants
							populateDeriveesSelect(\`derivees-coef-x-\${exerciseNum}\`, DERIVEES_CONFIG.selectRanges.coefX);
							populateDeriveesSelect(\`derivees-const-term-\${exerciseNum}\`, DERIVEES_CONFIG.selectRanges.constTerm);
							
							// Gestionnaire pour l'opérateur
							document.getElementById(\`derivees-const-term-\${exerciseNum}\`).addEventListener('change', () => {
								updateDeriveesOperator(exerciseNum);
							});
						}
						
						// Bouton de vérification
						document.getElementById(\`derivees-check-btn-\${exerciseNum}\`).addEventListener('click', () => {
							checkDeriveesAnswer(exerciseNum);
						});
						
						// Entrée clavier pour les inputs numériques
						const answerInput = document.getElementById(\`derivees-answer-\${exerciseNum}\`);
						if (answerInput) {
							answerInput.addEventListener('keypress', (e) => {
								if (e.key === 'Enter') checkDeriveesAnswer(exerciseNum);
							});
						}
					});
				}
				
				// Remplit un menu déroulant avec une plage de valeurs
				function populateDeriveesSelect(selectId, range) {
					const select = document.getElementById(selectId);
					if (!select) return;
					
					select.innerHTML = "";
					
					// Option vide
					const placeholder = document.createElement("option");
					placeholder.value = "";
					placeholder.textContent = "--";
					placeholder.disabled = true;
					placeholder.selected = true;
					select.appendChild(placeholder);
					
					// Options numériques
					for (let val = range.max; val >= range.min; val--) {
						const option = document.createElement("option");
						option.value = val;
						option.textContent = val;
						select.appendChild(option);
					}
				}
				
				// Met à jour l'opérateur d'affichage
				function updateDeriveesOperator(exerciseNum) {
					const constTermSelect = document.getElementById(\`derivees-const-term-\${exerciseNum}\`);
					const operatorSpan = document.getElementById(\`derivees-operator-\${exerciseNum}\`);
					
					if (!constTermSelect || !operatorSpan) return;
					
					if (constTermSelect.value === "") {
						operatorSpan.textContent = " + ";
						return;
					}
					
					const value = parseInt(constTermSelect.value, 10);
					operatorSpan.textContent = value < 0 ? " - " : " + ";
					
					// Ajuster l'affichage pour les valeurs négatives
					if (value < 0) {
						const options = constTermSelect.options;
						for (let i = 0; i < options.length; i++) {
							if (options[i].value === value.toString()) {
								options[i].textContent = Math.abs(value).toString();
								break;
							}
						}
					}

                }`,
                
                code: `<!-- Structure HTML spécifique aux exercices de dérivées -->
<div class="exercise-card" data-exercise="1">
    <div class="material-header">
        <div class="exercise-title">
            <span>Exercice 1</span>
            <div class="attempts-badge high" id="derivees-attempts1" title="Tentatives restantes">2</div>
        </div>
    </div>
    
    <div class="function-display">
        f(x) = 3x² - 5x + 2
    </div>
    
    <div class="derivees-question-container">
        <div class="derivees-question-text">
            Donnez l'expression de la dérivée de la fonction :
        </div>
        <div class="derivees-derivative-container">
            <div class="derivees-derivative-expression">f'(x) = </div>
            <select id="derivees-coef-x-1" class="derivees-select">
                <option value="">--</option>
                <option value="6">6</option>
                <option value="5">5</option>
                <!-- ... autres options ... -->
            </select>
            <div class="derivees-derivative-expression"> x </div>
            <span id="derivees-operator-1" class="derivees-derivative-expression"> + </span>
            <select id="derivees-const-term-1" class="derivees-select">
                <option value="">--</option>
                <option value="-5">-5</option>
                <option value="-4">-4</option>
                <!-- ... autres options ... -->
            </select>
        </div>
    </div>
    
    <button class="check-btn" id="derivees-check-btn-1">Vérifier</button>
    <div class="result" id="derivees-result1"></div>
    <div class="hint" id="derivees-hint1">💡 Pour f(x) = ax² + bx + c, la dérivée est f'(x) = 2ax + b</div>
</div>

<!-- CSS spécifique aux exercices de dérivées -->
<style>
    /* Styles pour les exercices de dérivées */
    .derivees-question-container {
        margin: 15px 0;
    }
    
    .derivees-question-text {
        font-size: 1.1em;
        margin-bottom: 15px;
        color: #333;
        font-weight: 500;
    }
    
    .derivees-derivative-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
        padding: 15px;
        background: #f7f7f7;
        border-radius: 8px;
    }
    
    .derivees-derivative-expression {
        font-size: 1.2em;
        font-weight: 500;
        color: #333;
    }
    
    .derivees-select {
        padding: 8px 12px;
        font-size: 1.1rem;
        border: 2px solid #667eea;
        border-radius: 8px;
        background-color: white;
        color: #333;
        cursor: pointer;
        transition: all 0.2s ease;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233498db%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 12px top 50%;
        background-size: 12px auto;
        padding-right: 30px;
        min-width: 80px;
    }
    
    .derivees-select:hover, 
    .derivees-select:focus {
        border-color: #5a67d8;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    .derivees-select:disabled {
        background-color: #f8f9fa;
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .derivees-input-group {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
        padding: 15px;
        background: #f7f7f7;
        border-radius: 8px;
        flex-wrap: wrap;
    }
    
    .derivees-input-label {
        font-size: 1.2em;
        font-weight: 500;
        color: #333;
        white-space: nowrap;
    }
    
    .derivees-input {
        padding: 8px 12px;
        font-size: 1.1rem;
        border: 2px solid #667eea;
        border-radius: 8px;
        background-color: white;
        color: #333;
        transition: all 0.2s ease;
        min-width: 120px;
        text-align: center;
    }
    
    .derivees-input:hover, 
    .derivees-input:focus {
        border-color: #5a67d8;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    .derivees-input:disabled {
        background-color: #f8f9fa;
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    /* Responsive pour les exercices de dérivées */
    @media (max-width: 768px) {
        .derivees-derivative-container,
        .derivees-input-group {
            flex-direction: column;
            align-items: center;
        }
        
        .derivees-select,
        .derivees-input {
            min-width: 150px;
        }
    }
</style>`
            },			
			
			
			
			
			arbre_proba: {
				title: "Arbres de Probabilité Interactifs",
				description: "Un template pour créer des simulations interactives d'arbres de probabilité. L'apprenant peut explorer les concepts de probabilité à travers des simulations visuelles et résoudre des exercices associés.",
				features: [
					"Simulation interactive d'arbre de naissance (garçon/fille)",
					"Simulation interactive d'arbre pondéré (événements A et B)",
					"Visualisation dynamique des probabilités et des résultats",
					"Exercices pratiques avec validation automatique",
					"Personnalisation des contextes et des scénarios",
					"Fonctions de lancement multiple (1, 10, 100, 1000 essais)",
					"Statistiques en temps réel et pourcentages",
					"Personnalisation des probabilités de base"
				],
				icon: "fas fa-network-wired",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Simulation d'arbre de probabilité</h3>
					</div>
					
					<div style="background: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
						<svg width="300" height="200" style="margin: 0 auto;">
							<!-- Lignes de l'arbre -->
							<line x1="150" y1="30" x2="75" y2="80" stroke="#4cc9f0" stroke-width="3"></line>
							<line x1="150" y1="30" x2="225" y2="80" stroke="#ff70a6" stroke-width="3"></line>
							<line x1="75" y1="80" x2="40" y2="150" stroke="#4cc9f0" stroke-width="3"></line>
							<line x1="75" y1="80" x2="110" y2="150" stroke="#ff70a6" stroke-width="3"></line>
							<line x1="225" y1="80" x2="190" y2="150" stroke="#4cc9f0" stroke-width="3"></line>
							<line x1="225" y1="80" x2="260" y2="150" stroke="#ff70a6" stroke-width="3"></line>
							
							<!-- Nœuds -->
							<circle cx="150" cy="30" r="15" fill="white" stroke="#ea6687" stroke-width="2"></circle>
							<circle cx="75" cy="80" r="15" fill="#4cc9f0" stroke="#4cc9f0" stroke-width="2"></circle>
							<circle cx="225" cy="80" r="15" fill="#ff70a6" stroke="#ff70a6" stroke-width="2"></circle>
							<circle cx="40" cy="150" r="15" fill="#4cc9f0" stroke="#4cc9f0" stroke-width="2"></circle>
							<circle cx="110" cy="150" r="15" fill="#ff70a6" stroke="#ff70a6" stroke-width="2"></circle>
							<circle cx="190" cy="150" r="15" fill="#4cc9f0" stroke="#4cc9f0" stroke-width="2"></circle>
							<circle cx="260" cy="150" r="15" fill="#ff70a6" stroke="#ff70a6" stroke-width="2"></circle>
							
							<!-- Textes -->
							<text x="150" y="35" text-anchor="middle" fill="#333" font-weight="bold">D</text>
							<text x="75" y="85" text-anchor="middle" fill="white" font-weight="bold">G</text>
							<text x="225" y="85" text-anchor="middle" fill="white" font-weight="bold">F</text>
							<text x="40" y="155" text-anchor="middle" fill="white" font-weight="bold">G</text>
							<text x="110" y="155" text-anchor="middle" fill="white" font-weight="bold">F</text>
							<text x="190" y="155" text-anchor="middle" fill="white" font-weight="bold">G</text>
							<text x="260" y="155" text-anchor="middle" fill="white" font-weight="bold">F</text>
						</svg>
					</div>
					
					<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
						<div style="background: white; padding: 10px; border-radius: 8px; text-align: center; border-top: 4px solid #4cc9f0;">
							<div style="font-weight: bold; margin-bottom: 5px;">Garçon-Garçon</div>
							<div style="font-size: 1.5em; font-weight: bold;">25%</div>
						</div>
						<div style="background: white; padding: 10px; border-radius: 8px; text-align: center; border-top: 4px solid #a78bfa;">
							<div style="font-weight: bold; margin-bottom: 5px;">Garçon-Fille</div>
							<div style="font-size: 1.5em; font-weight: bold;">25%</div>
						</div>
					</div>
					
					<div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
						<button style="padding: 8px 15px; background: #ea6687; color: white; border: none; border-radius: 5px; cursor: pointer;">1 Lancer</button>
						<button style="padding: 8px 15px; background: #ea6687; color: white; border: none; border-radius: 5px; cursor: pointer;">10 Lancers</button>
						<button style="padding: 8px 15px; background: #ea6687; color: white; border: none; border-radius: 5px; cursor: pointer;">100 Lancers</button>
					</div>
				</div>
				`,
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE ARBRE DE PROBABILITE : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation des variables globales
				let ppCount = 0, pfCount = 0, fpCount = 0, ffCount = 0; // Compteurs pour arbre naissance
				let abCount = 0, anbCount = 0, nabCount = 0, nanbCount = 0; // Compteurs pour arbre pondéré
				let sampleCount = 0; // Nombre total de simulations naissance
				let pondereCount = 0; // Nombre total de simulations pondérées
				let probA = 0.6; // Probabilité par défaut pour l'événement A
				let probBGivenA = 0.7; // Probabilité conditionnelle par défaut B sachant A
				let probBGivenNotA = 0.2; // Probabilité conditionnelle par défaut B sachant non-A
				let score = 0; // Score pour les exercices
				let answered = new Set(); // Ensemble des exercices répondus
				
				// Initialiser les simulations
				initNaissanceSimulation();
				initPondereSimulation();
				initExercises();
				
				// Fonction pour changer d'onglet
				window.changeTab = function(tabName) {
					// Cacher tous les contenus d'onglets
					document.querySelectorAll('.tab-content').forEach(tab => {
						tab.classList.remove('active');
					});
					
					// Désactiver tous les onglets
					document.querySelectorAll('.tab').forEach(tab => {
						tab.classList.remove('active');
					});
					
					// Activer l'onglet sélectionné
					if (tabName === 'birth') {
						document.getElementById('birth-tab').classList.add('active');
						document.querySelectorAll('.tab')[0].classList.add('active');
					} else if (tabName === 'weighted') {
						document.getElementById('weighted-tab').classList.add('active');
						document.querySelectorAll('.tab')[1].classList.add('active');
					}
					
					// Mettre à jour les statistiques des exercices
					updateExerciseStats();
				}
				
				// =====================================================================
				## ⚠️ PRIORITÉS HAUTE POUR LE CHOIX DES SIMULATIONS : UTILISER UNIQUEMENT LA SIMULATION CHOISIE
				// =====================================================================
				
				
				// Fonctions pour l'arbre de naissance
				function initNaissanceSimulation() {
					// Initialiser les boutons
					document.getElementById('btnLancer').addEventListener('click', lancer);
					document.getElementById('btn10').addEventListener('click', function() {
						startNewExperience();
						simulateMultipleTosses(10, 300);
					});
					document.getElementById('btn100').addEventListener('click', function() {
						startNewExperience();
						simulateMultipleTosses(100, 30);
					});
					document.getElementById('btn1000').addEventListener('click', function() {
						startNewExperience();
						simulateMultipleTosses(1000, 5);
					});
					document.getElementById('btnReset').addEventListener('click', resetSimulation);
				}
				
				// Réinitialise l'épaisseur des lignes pour l'arbre de naissance
				function resetLines() {
					// Récupération des éléments SVG (lignes) pour l'arbre de naissance
					const lineStartPile = document.getElementById("lineStartPile");
					const lineStartFace = document.getElementById("lineStartFace");
					const linePilePile = document.getElementById("linePilePile");
					const linePileFace = document.getElementById("linePileFace");
					const lineFacePile = document.getElementById("lineFacePile");
					const lineFaceFace = document.getElementById("lineFaceFace");
					
					if (lineStartPile) lineStartPile.setAttribute("stroke-width", "2");
					if (lineStartFace) lineStartFace.setAttribute("stroke-width", "2");
					if (linePilePile) linePilePile.setAttribute("stroke-width", "2");
					if (linePileFace) linePileFace.setAttribute("stroke-width", "2");
					if (lineFacePile) lineFacePile.setAttribute("stroke-width", "2");
					if (lineFaceFace) lineFaceFace.setAttribute("stroke-width", "2");
				}
				
				// =====================================================================
				## ⚠️ PRIORITÉS HAUTE POUR LE CHOIX DES SIMULATIONS : UTILISER UNIQUEMENT LA SIMULATION CHOISIE
				// =====================================================================

				
				// Fonction d'un lancer (deux tirages successifs) pour l'arbre de naissance
				window.lancer = function() {
					resetLines();
			
					// Premier tirage
					let premierTirage = Math.random() < 0.5 ? "Pile" : "Face";
					// Deuxième tirage
					let secondTirage = Math.random() < 0.5 ? "Pile" : "Face";
			
					// Mise en évidence du premier tirage
					const lineStartPile = document.getElementById("lineStartPile");
					const lineStartFace = document.getElementById("lineStartFace");
					
					if (premierTirage === "Pile" && lineStartPile) {
						lineStartPile.setAttribute("stroke-width", "4");
					} else if (lineStartFace) {
						lineStartFace.setAttribute("stroke-width", "4");
					}
			
					// Mise à jour des compteurs et détermination de la branche activée
					let branchCode = "";
					const linePilePile = document.getElementById("linePilePile");
					const linePileFace = document.getElementById("linePileFace");
					const lineFacePile = document.getElementById("lineFacePile");
					const lineFaceFace = document.getElementById("lineFaceFace");
					
					if (premierTirage === "Pile" && secondTirage === "Pile") {
						ppCount++;
						updateElementText("ppText", ppCount.toString());
						updateElementText("ppValue", ppCount.toString());
						if (linePilePile) linePilePile.setAttribute("stroke-width", "4");
						branchCode = "PP";
					} else if (premierTirage === "Pile" && secondTirage === "Face") {
						pfCount++;
						updateElementText("pfText", pfCount.toString());
						updateElementText("pfValue", pfCount.toString());
						if (linePileFace) linePileFace.setAttribute("stroke-width", "4");
						branchCode = "PF";
					} else if (premierTirage === "Face" && secondTirage === "Pile") {
						fpCount++;
						updateElementText("fpText", fpCount.toString());
						updateElementText("fpValue", fpCount.toString());
						if (lineFacePile) lineFacePile.setAttribute("stroke-width", "4");
						branchCode = "FP";
					} else {
						ffCount++;
						updateElementText("ffText", ffCount.toString());
						updateElementText("ffValue", ffCount.toString());
						if (lineFaceFace) lineFaceFace.setAttribute("stroke-width", "4");
						branchCode = "FF";
					}
					
					
				// =====================================================================
				## ⚠️ PRIORITÉS HAUTE POUR AFFICHAGE DES RESULTATS : CALCULER MAIS NE PAS AFFICHER LES FREQUENCES DANS LES RESULTATS DE LA SIMULATION 
				// =====================================================================
					
					
					sampleCount++;
			
					// Mise à jour des pourcentages
					updatePercentages();
					
					// Affichage des emojis correspondant sur la branche activée
					updateCoinIllustration(branchCode, premierTirage, secondTirage);
					
					// Mise à jour des statistiques des exercices
					updateExerciseStats();
				}
			
				// Fonction utilitaire qui retourne l'emoji correspondant
				function getEmoji(result) {
					return result === "Pile" ? "🧑🏼‍🦱" : "👩🏼‍🦰";
				}
			
				// Met à jour l'illustration des emojis sur la branche activée
				function updateCoinIllustration(branch, firstResult, secondResult) {
					// Vider toutes les illustrations existantes
					["coinsPP", "coinsPF", "coinsFP", "coinsFF"].forEach(id => {
						const element = document.getElementById(id);
						if (element) element.innerHTML = "";
					});
					
					const pos = {
						"PP": { x1: 65, x2: 85, y: 225 },
						"PF": { x1: 165, x2: 185, y: 225 },
						"FP": { x1: 265, x2: 285, y: 225 },
						"FF": { x1: 365, x2: 385, y: 225 }
					}[branch];
					
					// Affichage des deux emojis
					const html = \`
						<text x="\${pos.x1}" y="\${pos.y}" text-anchor="middle" font-size="20">\${getEmoji(firstResult)}</text>
						<text x="\${pos.x2}" y="\${pos.y}" text-anchor="middle" font-size="20">\${getEmoji(secondResult)}</text>
					\`;
					
					const element = document.getElementById("coins" + branch);
					if (element) element.innerHTML = html;
				}
				
				// Démarre une nouvelle expérience pour l'arbre de naissance
				window.startNewExperience = function() {
					// Réinitialise les compteurs
					ppCount = pfCount = fpCount = ffCount = sampleCount = 0;
					
					// Mettre à jour l'affichage des compteurs
					const elements = [
						"ppText", "pfText", "fpText", "ffText",
						"ppValue", "pfValue", "fpValue", "ffValue",
						"ppPercentage", "pfPercentage", "fpPercentage", "ffPercentage"
					];
					
					elements.forEach(id => {
						const element = document.getElementById(id);
						if (element) element.textContent = id.includes("Percentage") ? "0%" : "0";
					});
					
					const totalElement = document.getElementById("totalFamilies");
					if (totalElement) totalElement.textContent = "0";
					
					resetLines();
					
					// Efface les illustrations d'emojis
					["coinsPP", "coinsPF", "coinsFP", "coinsFF"].forEach(id => {
						const element = document.getElementById(id);
						if (element) element.innerHTML = "";
					});
				}
				
				// Mise à jour des pourcentages pour l'arbre de naissance
				function updatePercentages() {
					if (sampleCount === 0) return;
					
					const ppPct = (ppCount / sampleCount * 100).toFixed(1);
					const pfPct = (pfCount / sampleCount * 100).toFixed(1);
					const fpPct = (fpCount / sampleCount * 100).toFixed(1);
					const ffPct = (ffCount / sampleCount * 100).toFixed(1);
					
					updateElementText("ppPercentage", ppPct + "%");
					updateElementText("pfPercentage", pfPct + "%");
					updateElementText("fpPercentage", fpPct + "%");
					updateElementText("ffPercentage", ffPct + "%");
					updateElementText("totalFamilies", sampleCount.toString());
				}
				
				// Fonction utilitaire pour mettre à jour le texte d'un élément s'il existe
				function updateElementText(id, text) {
					const element = document.getElementById(id);
					if (element) element.textContent = text;
				}
			
				// Réinitialise l'interface pour l'arbre de naissance
				window.resetSimulation = function() {
					ppCount = pfCount = fpCount = ffCount = sampleCount = 0;
					
					// Mettre à jour l'affichage des compteurs
					const elements = [
						"ppText", "pfText", "fpText", "ffText",
						"ppValue", "pfValue", "fpValue", "ffValue",
						"ppPercentage", "pfPercentage", "fpPercentage", "ffPercentage"
					];
					
					elements.forEach(id => {
						const element = document.getElementById(id);
						if (element) element.textContent = id.includes("Percentage") ? "0%" : "0";
					});
					
					const totalElement = document.getElementById("totalFamilies");
					if (totalElement) totalElement.textContent = "0";
					
					resetLines();
					
					// Efface les illustrations d'emojis
					["coinsPP", "coinsPF", "coinsFP", "coinsFF"].forEach(id => {
						const element = document.getElementById(id);
						if (element) element.innerHTML = "";
					});
					
					// Mettre à jour les statistiques des exercices
					updateExerciseStats();
				}
			
				// =====================================================================
				## ⚠️⚠️ PRIORITÉS OBLIGATOIRE POUR LES BOUTONS DE LANCEMENT FONCTIONNELS
				// =====================================================================

			
				// Désactive ou réactive les boutons pendant une simulation multiple pour l'arbre de naissance
				function disableButtons(state) {
					const buttonIds = ["btnLancer", "btn10", "btn100", "btn1000", "btnReset"];
					
					buttonIds.forEach(id => {
						const button = document.getElementById(id);
						if (button) button.disabled = state;
					});
				}
			
				// Simulation multiple avec intervalle pour l'arbre de naissance
				window.simulateMultipleTosses = function(n, delay) {
					disableButtons(true);
					let count = 0;
					
					let interval = setInterval(() => {
						lancer();
						count++;
						
						if (count >= n) {
							clearInterval(interval);
							disableButtons(false);
						}
					}, delay);
				}
				
				// =====================================================================
				## FONCTIONNALITES IMPORTANTES POUR LES ARBRES DE PROBABILITES
				// =====================================================================

				
				// Fonctions pour l'arbre pondéré
				function initPondereSimulation() {
					// Initialiser les boutons
					document.getElementById('btnLancerPondere').addEventListener('click', lancerPondere);
					document.getElementById('btn10Pondere').addEventListener('click', function() {
						startNewExperiencePondere();
						simulateMultipleTossesPondere(10, 300);
					});
					document.getElementById('btn100Pondere').addEventListener('click', function() {
						startNewExperiencePondere();
						simulateMultipleTossesPondere(100, 30);
					});
					document.getElementById('btn1000Pondere').addEventListener('click', function() {
						startNewExperiencePondere();
						simulateMultipleTossesPondere(1000, 5);
					});
					document.getElementById('btnResetPondere').addEventListener('click', resetSimulationPondere);
				}
				
				// Réinitialise l'épaisseur des lignes de l'arbre pondéré
				function resetLinesPondere() {
					// Récupération des éléments SVG (lignes) pour l'arbre pondéré
					const lineStartA = document.getElementById("lineStartA");
					const lineStartNonA = document.getElementById("lineStartNonA");
					const lineAB = document.getElementById("lineAB");
					const lineANonB = document.getElementById("lineANonB");
					const lineNonAB = document.getElementById("lineNonAB");
					const lineNonANonB = document.getElementById("lineNonANonB");
					
					if (lineStartA) lineStartA.setAttribute("stroke-width", "2");
					if (lineStartNonA) lineStartNonA.setAttribute("stroke-width", "2");
					if (lineAB) lineAB.setAttribute("stroke-width", "2");
					if (lineANonB) lineANonB.setAttribute("stroke-width", "2");
					if (lineNonAB) lineNonAB.setAttribute("stroke-width", "2");
					if (lineNonANonB) lineNonANonB.setAttribute("stroke-width", "2");
				}
				
				// Mettre à jour les probabilités affichées
				window.updateProbabilities = function() {
					// Mettre à jour les valeurs des probabilités
					const probAInput = document.getElementById("probA_input");
					const probBGivenAInput = document.getElementById("probBGivenA");
					const probBGivenNotAInput = document.getElementById("probBGivenNotA");
					
					if (probAInput && probBGivenAInput && probBGivenNotAInput) {
						probA = parseFloat(probAInput.value) || 0.6;
						probBGivenA = parseFloat(probBGivenAInput.value) || 0.7;
						probBGivenNotA = parseFloat(probBGivenNotAInput.value) || 0.2;
						
						// Vérifications des valeurs entre 0 et 1
						probA = Math.max(0, Math.min(1, probA));
						probBGivenA = Math.max(0, Math.min(1, probBGivenA));
						probBGivenNotA = Math.max(0, Math.min(1, probBGivenNotA));
						
						// Mise à jour des champs
						probAInput.value = probA;
						probBGivenAInput.value = probBGivenA;
						probBGivenNotAInput.value = probBGivenNotA;
					}
					
					// Mettre à jour les textes de probabilité
					updateElementText("probA", \`P=\${probA.toFixed(1)}\`);
					updateElementText("probNonA", \`P=\${(1-probA).toFixed(1)}\`);
					updateElementText("probAB", \`P=\${probBGivenA.toFixed(1)}\`);
					updateElementText("probANonB", \`P=\${(1-probBGivenA).toFixed(1)}\`);
					updateElementText("probNonAB", \`P=\${probBGivenNotA.toFixed(1)}\`);
					updateElementText("probNonANonB", \`P=\${(1-probBGivenNotA).toFixed(1)}\`);
					
					// Mettre à jour les valeurs dans les exercices
					updateElementText("ex5-probA", probA.toFixed(1));
					updateElementText("ex5-probBA", probBGivenA.toFixed(1));
					updateElementText("ex5-probBnonA", probBGivenNotA.toFixed(1));
					updateElementText("ex6-probA", probA.toFixed(1));
					updateElementText("ex6-probBA", probBGivenA.toFixed(1));
					updateElementText("ex6-probBnonA", probBGivenNotA.toFixed(1));
					
					// Mettre à jour les statistiques des exercices
					updateExerciseStats();
				}
				
				// Démarre une nouvelle expérience pour l'arbre pondéré
				window.startNewExperiencePondere = function() {
					// Réinitialise les compteurs
					abCount = anbCount = nabCount = nanbCount = pondereCount = 0;
					
					// Mettre à jour l'affichage des compteurs
					const elements = [
						"abText", "anbText", "nabText", "nanbText",
						"abValue", "anbValue", "nabValue", "nanbValue",
					];
					
					elements.forEach(id => {
						const element = document.getElementById(id);
						if (element) element.textContent = id.includes("Percentage") ? "0%" : "0";
					});
					
					const totalElement = document.getElementById("totalExperiences");
					if (totalElement) totalElement.textContent = "0";
					
					resetLinesPondere();
				}
				
				// Fonction d'un lancer pour l'arbre pondéré
				window.lancerPondere = function() {
					resetLinesPondere();
			
					// Premier événement: A ou non-A
					let eventA = Math.random() < probA;
					
					// Deuxième événement: B ou non-B (dépend du premier)
					let eventB;
					if (eventA) {
						eventB = Math.random() < probBGivenA;
					} else {
						eventB = Math.random() < probBGivenNotA;
					}
			
					// Mise en évidence du premier événement
					const lineStartA = document.getElementById("lineStartA");
					const lineStartNonA = document.getElementById("lineStartNonA");
					
					if (eventA && lineStartA) {
						lineStartA.setAttribute("stroke-width", "4");
					} else if (lineStartNonA) {
						lineStartNonA.setAttribute("stroke-width", "4");
					}
			
					// Mise à jour des compteurs et détermination de la branche activée
					const lineAB = document.getElementById("lineAB");
					const lineANonB = document.getElementById("lineANonB");
					const lineNonAB = document.getElementById("lineNonAB");
					const lineNonANonB = document.getElementById("lineNonANonB");
					
					if (eventA && eventB) {
						abCount++;
						updateElementText("abText", abCount.toString());
						updateElementText("abValue", abCount.toString());
						if (lineAB) lineAB.setAttribute("stroke-width", "4");
					} else if (eventA && !eventB) {
						anbCount++;
						updateElementText("anbText", anbCount.toString());
						updateElementText("anbValue", anbCount.toString());
						if (lineANonB) lineANonB.setAttribute("stroke-width", "4");
					} else if (!eventA && eventB) {
						nabCount++;
						updateElementText("nabText", nabCount.toString());
						updateElementText("nabValue", nabCount.toString());
						if (lineNonAB) lineNonAB.setAttribute("stroke-width", "4");
					} else {
						nanbCount++;
						updateElementText("nanbText", nanbCount.toString());
						updateElementText("nanbValue", nanbCount.toString());
						if (lineNonANonB) lineNonANonB.setAttribute("stroke-width", "4");
					}
					
					pondereCount++;
			
					// Mise à jour des pourcentages
					updatePercentagesPondere();
				}
			
				// Mise à jour des pourcentages pour l'arbre pondéré
				function updatePercentagesPondere() {
					if (pondereCount === 0) return;
					
					const abPct = (abCount / pondereCount * 100).toFixed(1);
					const anbPct = (anbCount / pondereCount * 100).toFixed(1);
					const nabPct = (nabCount / pondereCount * 100).toFixed(1);
					const nanbPct = (nanbCount / pondereCount * 100).toFixed(1);
					
					updateElementText("abPercentage", abPct + "%");
					updateElementText("anbPercentage", anbPct + "%");
					updateElementText("nabPercentage", nabPct + "%");
					updateElementText("nanbPercentage", nanbPct + "%");
					updateElementText("totalExperiences", pondereCount.toString());
					
					// Mettre à jour les statistiques des exercices
					updateExerciseStats();
				}
			
				// Réinitialise l'interface de l'arbre pondéré
				window.resetSimulationPondere = function() {
					abCount = anbCount = nabCount = nanbCount = pondereCount = 0;
					
					// Mettre à jour l'affichage des compteurs
					const elements = [
						"abText", "anbText", "nabText", "nanbText",
						"abValue", "anbValue", "nabValue", "nanbValue",
						"abPercentage", "anbPercentage", "nabPercentage", "nanbPercentage"
					];
					
					elements.forEach(id => {
						const element = document.getElementById(id);
						if (element) element.textContent = id.includes("Percentage") ? "0%" : "0";
					});
					
					const totalElement = document.getElementById("totalExperiences");
					if (totalElement) totalElement.textContent = "0";
					
					resetLinesPondere();
				}
			
				// Désactive ou réactive les boutons pendant une simulation multiple pour l'arbre pondéré
				function disableButtonsPondere(state) {
					const buttonIds = ["btnLancerPondere", "btn10Pondere", "btn100Pondere", "btn1000Pondere", "btnResetPondere"];
					
					buttonIds.forEach(id => {
						const button = document.getElementById(id);
						if (button) button.disabled = state;
					});
				}
			
				// Simulation multiple avec intervalle pour l'arbre pondéré
				window.simulateMultipleTossesPondere = function(n, delay) {
					disableButtonsPondere(true);
					let count = 0;
					
					let interval = setInterval(() => {
						lancerPondere();
						count++;
						
						if (count >= n) {
							clearInterval(interval);
							disableButtonsPondere(false);
						}
					}, delay);
				}
				
				// Fonctions pour les exercices
				function initExercises() {
					// Initialiser la gestion des exercices
					document.querySelectorAll('.check-btn').forEach(button => {
						button.addEventListener('click', function() {
							const exerciseId = this.closest('.exercise-card').getAttribute('data-exercise');
							checkAnswer(exerciseId);
						});
					});
				}
				
				// Mise à jour des statistiques pour les exercices
				function updateExerciseStats() {
					// Exercice 1 - Statistiques de l'arbre de naissance
					if (sampleCount > 0) {
						const atLeastOneBoy = ppCount + pfCount + fpCount;
						const atLeastOneBoyFreq = (atLeastOneBoy / sampleCount * 100).toFixed(1);
						const statsEx1 = document.getElementById("stats-ex1");
						if (statsEx1) {
							statsEx1.innerHTML = \`
								<strong>Nombre total de familles:</strong> \${sampleCount}<br>
								<strong>Familles avec au moins un garçon:</strong> \${atLeastOneBoy} (\${atLeastOneBoyFreq}%)
							\`;
						}
					}
					
					// Exercice 2 - Statistiques de l'arbre pondéré
					if (pondereCount > 0) {
						const pB = (abCount + nabCount) / pondereCount;
						const statsEx2 = document.getElementById("stats-ex2");
						if (statsEx2) {
							statsEx2.innerHTML = \`
								<strong>Nombre total d'expériences:</strong> \${pondereCount}<br>
								<strong>Occurrences de B:</strong> \${abCount + nabCount}<br>
								<strong>Fréquence observée de B:</strong> \${(pB * 100).toFixed(1)}%
							\`;
						}
					}
				}
				
				// Fonction pour vérifier une réponse
				window.checkAnswer = function(exerciseId) {
					const userAnswerInput = document.getElementById(\`answer\${exerciseId}\`);
					const resultDiv = document.getElementById(\`result\${exerciseId}\`);
					
					if (!userAnswerInput || !resultDiv) return;
					
					const userAnswer = parseFloat(userAnswerInput.value.replace(',', '.'));
					
					if (isNaN(userAnswer)) {
						resultDiv.textContent = "⚠️ Veuillez entrer un nombre valide";
						resultDiv.className = "result incorrect show";
						return;
					}
					
					// Déterminer la réponse correcte selon l'exercice de calcul de fréquence
					let correctAnswer;

					// <p>Fréquence observée: {{frequenceObservee}}</p>
					
					// Modification de la fonction de vérification pour comparer correctement
					function verifierReponse() {
					  // Récupérer la réponse de l'utilisateur (normaliser avec le point décimal)
					  let reponseUtilisateur = document.getElementById('reponseInput').value.replace(',', '.');
					  
					  // Calculer la fréquence correcte à partir des données brutes
					  const frequenceCorrecte = famillesAvecGarcon / nombreTotalFamilles;
					  
					  // Comparer la réponse (avec une petite marge d'erreur pour les arrondis)
					  const estCorrect = Math.abs(parseFloat(reponseUtilisateur) - frequenceCorrecte) < 0.001;
					  
					  if (estCorrect) {
						afficherMessage("Correct !", "success");
					  } else {
						afficherMessage("Incorrect. Essayez encore.", "error");
						
						// Afficher l'indice si la réponse est incorrecte
						document.getElementById('indice').style.display = 'block';
					  }
					  
					  return estCorrect;
					}
					
					// Fonction pour préparer les données à afficher (sans la fréquence)
					function preparerDonneesSimulation() {
					  const donneesAffichage = {
						nombreTotalFamilles: 100,
						famillesAvecGarcon: 77
						// La fréquence n'est plus incluse ici
					  };
					  
					  return donneesAffichage;
					}
					
					
					// Tolérance pour les arrondis (1%)
					const tolerance = Math.abs(correctAnswer) * 0.01;
					const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
					
					if (isCorrect) {
						resultDiv.textContent = "✓ Correct ! La réponse est bien " + correctAnswer.toFixed(2);
						resultDiv.className = "result correct show";
					} else {
						resultDiv.textContent = "✗ Incorrect. La bonne réponse est " + correctAnswer.toFixed(2);
						resultDiv.className = "result incorrect show";
					}
					
					if (!answered.has(exerciseId) && isCorrect) {
						answered.add(exerciseId);
						score++;
						document.getElementById('score').textContent = score.toString();
						updateFinishButton();
					}
					
					// Désactiver l'input et le bouton une fois répondu si correct
					if (isCorrect) {
						userAnswerInput.disabled = true;
						document.querySelector(\`.exercise-card[data-exercise="\${exerciseId}"] .check-btn\`).disabled = true;
					}
				}
				
				// Activation du bouton "Terminer" dès qu'au moins un exercice est complété
				function updateFinishButton() {
					const finishBtn = document.getElementById('finishBtn');
					if (finishBtn) {
						if (answered.size >= 1) {
							finishBtn.disabled = false;
						} else {
							finishBtn.disabled = true;
						}
					}
				}
				
				// Fonction pour terminer le test
				window.finishTest = function() {
					// Vérifier si au moins une question est répondue
					if (answered.size === 0) {
						alert("Vous devez répondre à au moins une question avant de terminer l'activité.");
						return;
					}
					
					// Afficher le message de fin
					alert(\`Activité terminée! Votre score final est de \${score}/6.\`);
					
					// Désactiver tous les inputs et boutons
					document.querySelectorAll('input, .check-btn, .finish-btn').forEach(el => {
						el.disabled = true;
					});
				}
			});`,
				code: `<!-- Code HTML complet pour le template Arbre de Probabilité -->
			<!-- Styles CSS spécifiques pour l'arbre de probabilité -->
			<style>
				/* Variables de couleurs et de style */
				:root {
					--primary: #4361ee;
					--primary-dark: #3251d4;
					--secondary: #ff6b6b;
					--boy: #4cc9f0;
					--girl: #ff70a6;
					--event-a: #4361ee;
					--event-not-a: #ff6b6b;
					--event-b: #36b37e;
					--event-not-b: #f97583;
					--dark: #212529;
					--light: #f8f9fa;
					--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
					--border-radius: 12px;
				}
			
				/* Styles pour les onglets */
				.tabs {
					display: flex;
					gap: 10px;
					margin-bottom: 20px;
				}
			
				.tab {
					padding: 10px 20px;
					background-color: #f0f0f0;
					border-radius: 10px 10px 0 0;
					cursor: pointer;
					font-weight: bold;
					border: 1px solid #ddd;
					border-bottom: none;
					transition: all 0.3s ease;
				}
			
				.tab.active {
					background-color: white;
					border-bottom: 3px solid var(--primary);
				}
			
				.tab-content {
					display: none;
				}
			
				.tab-content.active {
					display: block;
				}
			
				/* Style pour l'arbre SVG */
				#arbre, #arbrePondere {
					margin: 20px auto;
					display: block;
					border: 1px solid #eee;
					border-radius: var(--border-radius);
					background: white;
				}
			
				.experiment-info {
					display: flex;
					justify-content: space-around;
					flex-wrap: wrap;
					gap: 20px;
					margin: 20px 0;
				}
			
				.stat-card {
					background-color: white;
					border-radius: var(--border-radius);
					padding: 15px;
					min-width: 120px;
					text-align: center;
					box-shadow: var(--shadow);
					flex-grow: 1;
				}
			
				/* Cartes pour l'arbre de naissance */
				.stat-card.boy-boy {
					border-top: 4px solid var(--boy);
				}
			
				.stat-card.boy-girl {
					border-top: 4px solid #a78bfa;
				}
			
				.stat-card.girl-boy {
					border-top: 4px solid #818cf8;
				}
			
				.stat-card.girl-girl {
					border-top: 4px solid var(--girl);
				}
			
				/* Cartes pour l'arbre pondéré */
				.stat-card.a-b {
					border-top: 4px solid var(--event-a);
				}
			
				.stat-card.a-notb {
					border-top: 4px solid var(--event-not-b);
				}
			
				.stat-card.nota-b {
					border-top: 4px solid var(--event-b);
				}
			
				.stat-card.nota-notb {
					border-top: 4px solid var(--event-not-a);
				}
			
				.stat-value {
					font-size: 2.2rem;
					font-weight: 700;
					margin: 10px 0;
					color: var(--dark);
				}
			
				.stat-label {
					font-size: 0.9rem;
					color: #666;
				}
			
				.btn-group {
					display: flex;
					flex-wrap: wrap;
					gap: 10px;
					justify-content: center;
					margin: 20px 0;
				}
			
				button {
					background-color: var(--primary);
					color: white;
					border: none;
					border-radius: 50px;
					padding: 12px 24px;
					font-size: 1rem;
					font-weight: 600;
					cursor: pointer;
					transition: all 0.3s ease;
					box-shadow: var(--shadow);
					min-width: 140px;
				}
			
				button:hover {
					background-color: var(--primary-dark);
					transform: translateY(-2px);
				}
			
				button:disabled {
					background-color: #b4b4b4;
					cursor: not-allowed;
					transform: none;
				}
			
				button.secondary {
					background-color: var(--secondary);
				}
			
				.params-panel {
					margin-top: 20px;
					background-color: #f0f7ff;
					padding: 15px;
					border-radius: 10px;
					border: 1px solid #d1e3ff;
				}
			
				.params-title {
					font-weight: bold;
					margin-bottom: 10px;
					color: #1a56db;
				}
			
				.params-grid {
					display: grid;
					grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
					gap: 15px;
				}
			
				.param-group {
					display: flex;
					align-items: center;
				}
			
				.param-group label {
					margin-right: 10px;
					font-weight: 500;
				}
			
				.param-input {
					width: 80px;
					padding: 8px;
					border: 1px solid #ccc;
					border-radius: 5px;
					font-size: 0.9em;
				}
			
				.update-btn {
					background-color: #4361ee;
					color: white;
					border: none;
					border-radius: 5px;
					padding: 8px 12px;
					cursor: pointer;
					font-weight: 600;
					transition: all 0.2s ease;
				}
			
				.update-btn:hover {
					background-color: #3251d4;
				}
			
				/* Styles pour les exercices */
				.exercises {
					display: grid;
					grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
					gap: 20px;
					margin-top: 30px;
				}
			
				.exercise-card {
					background: #f8f9fa;
					border: 2px solid #e9ecef;
					border-radius: 15px;
					padding: 20px;
					transition: all 0.3s ease;
				}
			
				.exercise-card:hover {
					transform: translateY(-5px);
					box-shadow: 0 10px 20px rgba(0,0,0,0.1);
				}
			
				.exercise-header {
					display: flex;
					align-items: center;
					justify-content: space-between;
					margin-bottom: 15px;
				}
			
				.exercise-title {
					font-size: 1.2em;
					font-weight: bold;
					color: #333;
				}
			
				.exercise-type {
					background-color: #e9ecef;
					padding: 5px 10px;
					border-radius: 20px;
					font-size: 0.8em;
					font-weight: 500;
				}
			
				.exercise-type.simulation {
					background-color: #d8f3dc;
					color: #2d6a4f;
				}
			
				.exercise-type.theoretical {
					background-color: #d7e3fc;
					color: #1a56db;
				}
			
				.question-text {
					background: #f7f7f7;
					border-radius: 8px;
					padding: 15px;
					margin-bottom: 15px;
					font-size: 1.1em;
					color: #333;
					min-height: 80px;
				}
			
				.simulation-stats {
					background: #f0f7ff;
					padding: 15px;
					border-radius: 10px;
					margin-bottom: 15px;
					border: 1px solid #d1e3ff;
				}
			
				.stats-header {
					font-weight: bold;
					margin-bottom: 10px;
					color: #1a56db;
				}
			
				.input-group {
					margin-top: 15px;
				}
			
				.input-group label {
					display: block;
					margin-bottom: 5px;
					color: #555;
					font-weight: bold;
				}
			
				input[type="number"] {
					width: 100%;
					padding: 10px;
					border: 2px solid #ddd;
					border-radius: 8px;
					font-size: 1.1em;
					transition: border-color 0.3s;
				}
			
				input[type="number"]:focus {
					outline: none;
					border-color: #ea6687;
				}
			
				.check-btn {
					width: 100%;
					padding: 12px;
					margin-top: 10px;
					background: #ea6687;
					color: white;
					border: none;
					border-radius: 8px;
					font-size: 1.1em;
					font-weight: bold;
					cursor: pointer;
					transition: all 0.3s;
				}
			
				.check-btn:hover {
					background: #a24b5f;
					transform: translateY(-2px);
				}
			
				.result {
					margin-top: 10px;
					padding: 10px;
					border-radius: 8px;
					font-weight: bold;
					text-align: center;
					opacity: 0;
					transition: opacity 0.3s;
				}
			
				.result.show {
					opacity: 1;
				}
			
				.result.correct {
					background: #d4edda;
					color: #155724;
					border: 1px solid #c3e6cb;
				}
			
				.result.incorrect {
					background: #f8d7da;
					color: #721c24;
					border: 1px solid #f5c6cb;
				}
			
				.hint {
					background: #fff3cd;
					border: 1px solid #ffeeba;
					color: #856404;
					padding: 10px;
					border-radius: 8px;
					margin-top: 10px;
					font-size: 0.9em;
					display: none;
				}
			
				/* Bouton Terminer */
				.finish-btn {
					display: block; 
					width: 100%; 
					max-width: 300px; 
					margin: 30px auto 0; 
					padding: 15px; 
					background: #28a745; 
					color: white; 
					border: none; 
					border-radius: 8px; 
					font-size: 1.2em; 
					font-weight: bold; 
					cursor: pointer;
				}
			
				.finish-btn:hover {
					background: #218838;
					transform: translateY(-2px);
				}
			
				.finish-btn:disabled {
					background-color: #b4b4b4;
					cursor: not-allowed;
					transform: none;
				}
			
				@media (max-width: 768px) {
					.btn-group {
						flex-direction: column;
						width: 100%;
					}
					
					button {
						width: 100%;
					}
					
					.stat-card {
						min-width: 45%;
					}
			
					.exercises {
						grid-template-columns: 1fr;
					}
					
					.score-board {
						position: static;
						margin-bottom: 20px;
						text-align: center;
						display: flex;
						justify-content: center;
						width: 100%;
					}
			
					.params-grid {
						grid-template-columns: 1fr;
					}
				}
			</style>
			
			<div class="card">
				<div class="tabs">
					<div class="tab active" onclick="changeTab('birth')">Naissance de deux enfants</div>
					<div class="tab" onclick="changeTab('weighted')">Arbre pondéré (A et B)</div>
				</div>
			
				<!-- Onglet 1: Simulation Naissance -->
				<div id="birth-tab" class="tab-content active">
					<h2 style="text-align: center; margin-bottom: 20px;">Expérience aléatoire : Naissance de deux enfants</h2>
					
					<!-- Arbre de simulation en SVG -->
					<svg id="arbre" width="450" height="280">
						<!-- Lignes du premier niveau : Départ → (🧑🏼‍🦱 ou 👩🏼‍🦰) -->
						<line id="lineStartPile" x1="225" y1="40" x2="125" y2="100" stroke="#4cc9f0" stroke-width="2" />
						<line id="lineStartFace" x1="225" y1="40" x2="325" y2="100" stroke="#ff70a6" stroke-width="2" />
			
						<!-- Lignes du second niveau : -->
						<line id="linePilePile" x1="125" y1="100" x2="75"  y2="160" stroke="#4cc9f0" stroke-width="2" />
						<line id="linePileFace" x1="125" y1="100" x2="175" y2="160" stroke="#ff70a6" stroke-width="2" />
						<line id="lineFacePile" x1="325" y1="100" x2="275" y2="160" stroke="#4cc9f0" stroke-width="2" />
						<line id="lineFaceFace" x1="325" y1="100" x2="375" y2="160" stroke="#ff70a6" stroke-width="2" />
			
						<!-- Textes pour les nœuds -->
						<text x="225" y="30" text-anchor="middle" font-size="16" font-weight="bold">Départ</text>
						<text x="125" y="95" text-anchor="middle" font-size="20">🧑🏼‍🦱</text>
						<text x="325" y="95" text-anchor="middle" font-size="20">👩🏼‍🦰</text>
						<text x="75"  y="175" text-anchor="middle" font-size="20">🧑🏼‍🦱</text>
						<text x="175" y="175" text-anchor="middle" font-size="20">👩🏼‍🦰</text>
						<text x="275" y="175" text-anchor="middle" font-size="20">🧑🏼‍🦱</text>
						<text x="375" y="175" text-anchor="middle" font-size="20">👩🏼‍🦰</text>
			
						<!-- Compteurs affichés sous chaque branche finale -->
						<text id="ppText" x="75"  y="200" text-anchor="middle" font-size="16">0</text>
						<text id="pfText" x="175" y="200" text-anchor="middle" font-size="16">0</text>
						<text id="fpText" x="275" y="200" text-anchor="middle" font-size="16">0</text>
						<text id="ffText" x="375" y="200" text-anchor="middle" font-size="16">0</text>
			
						<!-- Groupes pour afficher les illustrations (seulement les emojis) -->
						<g id="coinsPP"></g>
						<g id="coinsPF"></g>
						<g id="coinsFP"></g>
						<g id="coinsFF"></g>
					</svg>
			
					<div class="experiment-info">
						<div class="stat-card boy-boy">
							<div class="stat-label">🧑🏼‍🦱-🧑🏼‍🦱</div>
							<div class="stat-value" id="ppValue">0</div>
						</div>
						<div class="stat-card boy-girl">
							<div class="stat-label">🧑🏼‍🦱-👩🏼‍🦰</div>
							<div class="stat-value" id="pfValue">0</div>
						</div>
						<div class="stat-card girl-boy">
							<div class="stat-label">👩🏼‍🦰-🧑🏼‍🦱</div>
							<div class="stat-value" id="fpValue">0</div>
						</div>
						<div class="stat-card girl-girl">
							<div class="stat-label">👩🏼‍🦰-👩🏼‍🦰</div>
							<div class="stat-value" id="ffValue">0</div>
						</div>
					</div>
			
					<div class="btn-group">
						<button id="btnLancer" onclick="lancer()">1 Famille</button>
						<button id="btn10" onclick="startNewExperience(); simulateMultipleTosses(10, 300)">10 Familles</button>
						<button id="btn100" onclick="startNewExperience(); simulateMultipleTosses(100, 30)">100 Familles</button>
						<button id="btn1000" onclick="startNewExperience(); simulateMultipleTosses(1000, 5)">1000 Familles</button>
						<button id="btnReset" class="secondary" onclick="resetSimulation()">Réinitialiser</button>
					</div>
			
					<div class="info-total" style="text-align: center; margin-top: 15px; font-weight: bold;">
						Nombre total de familles: <span id="totalFamilies">0</span>
					</div>
				</div>
			
				<!-- Onglet 2: Simulation Arbre Pondéré -->
				<div id="weighted-tab" class="tab-content">
					<h2 style="text-align: center; margin-bottom: 20px;">Arbre de probabilité pondéré : Événements A et B</h2>
					
					<!-- Arbre de simulation en SVG -->
					<svg id="arbrePondere" width="500" height="300">
						<!-- Lignes du premier niveau : Départ → (A ou non-A) -->
						<line id="lineStartA" x1="250" y1="40" x2="150" y2="120" stroke="#4361ee" stroke-width="2" />
						<line id="lineStartNonA" x1="250" y1="40" x2="350" y2="120" stroke="#ff6b6b" stroke-width="2" />
			
						<!-- Lignes du second niveau : -->
						<line id="lineAB" x1="150" y1="120" x2="100" y2="200" stroke="#36b37e" stroke-width="2" />
						<line id="lineANonB" x1="150" y1="120" x2="200" y2="200" stroke="#f97583" stroke-width="2" />
						<line id="lineNonAB" x1="350" y1="120" x2="300" y2="200" stroke="#36b37e" stroke-width="2" />
						<line id="lineNonANonB" x1="350" y1="120" x2="400" y2="200" stroke="#f97583" stroke-width="2" />
			
						<!-- Textes pour les nœuds -->
						<text x="250" y="30" text-anchor="middle" font-size="16" font-weight="bold">Départ</text>
						<text x="150" y="115" text-anchor="middle" font-size="16" font-weight="bold" fill="#4361ee">A</text>
						<text x="350" y="115" text-anchor="middle" font-size="16" font-weight="bold" fill="#ff6b6b">non-A</text>
						<text x="100" y="215" text-anchor="middle" font-size="16" font-weight="bold" fill="#36b37e">B</text>
						<text x="200" y="215" text-anchor="middle" font-size="16" font-weight="bold" fill="#f97583">non-B</text>
						<text x="300" y="215" text-anchor="middle" font-size="16" font-weight="bold" fill="#36b37e">B</text>
						<text x="400" y="215" text-anchor="middle" font-size="16" font-weight="bold" fill="#f97583">non-B</text>
			
						<!-- Probabilités sur les branches -->
						<text id="probA" x="180" y="70" text-anchor="middle" font-size="14" fill="#4361ee">P=0,6</text>
						<text id="probNonA" x="320" y="70" text-anchor="middle" font-size="14" fill="#ff6b6b">P=0,4</text>
						
						<!-- Probabilités conditionnelles second niveau -->
						<text id="probAB" x="115" y="150" text-anchor="middle" font-size="14" fill="#36b37e">P=0,7</text>
						<text id="probANonB" x="185" y="150" text-anchor="middle" font-size="14" fill="#f97583">P=0,3</text>
						<text id="probNonAB" x="315" y="150" text-anchor="middle" font-size="14" fill="#36b37e">P=0,2</text>
						<text id="probNonANonB" x="385" y="150" text-anchor="middle" font-size="14" fill="#f97583">P=0,8</text>
			
						<!-- Compteurs affichés sous chaque branche finale -->
						<text id="abText" x="100" y="240" text-anchor="middle" font-size="16">0</text>
						<text id="anbText" x="200" y="240" text-anchor="middle" font-size="16">0</text>
						<text id="nabText" x="300" y="240" text-anchor="middle" font-size="16">0</text>
						<text id="nanbText" x="400" y="240" text-anchor="middle" font-size="16">0</text>
					</svg>
			
					<div class="experiment-info">
						<div class="stat-card a-b">
							<div class="stat-label">A ∩ B</div>
							<div class="stat-value" id="abValue">0</div>
							<div class="stat-percentage" id="abPercentage">0%</div>
						</div>
						<div class="stat-card a-notb">
							<div class="stat-label">A ∩ non-B</div>
							<div class="stat-value" id="anbValue">0</div>
							<div class="stat-percentage" id="anbPercentage">0%</div>
						</div>
						<div class="stat-card nota-b">
							<div class="stat-label">non-A ∩ B</div>
							<div class="stat-value" id="nabValue">0</div>
							<div class="stat-percentage" id="nabPercentage">0%</div>
						</div>
						<div class="stat-card nota-notb">
							<div class="stat-label">non-A ∩ non-B</div>
							<div class="stat-value" id="nanbValue">0</div>
							<div class="stat-percentage" id="nanbPercentage">0%</div>
						</div>
					</div>
			
					<div class="params-panel">
						<div class="params-title">Paramètres de l'arbre pondéré</div>
						<div class="params-grid">
							<div class="param-group">
								<label for="probA_input">P(A):</label>
								<input type="number" id="probA_input" class="param-input" min="0" max="1" step="0.1" value="0.6">
							</div>
							<div class="param-group">
								<label for="probBGivenA">P(B|A):</label>
								<input type="number" id="probBGivenA" class="param-input" min="0" max="1" step="0.1" value="0.7">
							</div>
							<div class="param-group">
								<label for="probBGivenNotA">P(B|non-A):</label>
								<input type="number" id="probBGivenNotA" class="param-input" min="0" max="1" step="0.1" value="0.2">
							</div>
							<button onclick="updateProbabilities()" class="update-btn">Mettre à jour</button>
						</div>
					</div>
			
					<div class="btn-group">
						<button id="btnLancerPondere" onclick="lancerPondere()">1 Expérience</button>
						<button id="btn10Pondere" onclick="startNewExperiencePondere(); simulateMultipleTossesPondere(10, 300)">10 Expériences</button>
						<button id="btn100Pondere" onclick="startNewExperiencePondere(); simulateMultipleTossesPondere(100, 30)">100 Expériences</button>
						<button id="btn1000Pondere" onclick="startNewExperiencePondere(); simulateMultipleTossesPondere(1000, 5)">1000 Expériences</button>
						<button id="btnResetPondere" class="secondary" onclick="resetSimulationPondere()">Réinitialiser</button>
					</div>
			
					<div class="info-total" style="text-align: center; margin-top: 15px; font-weight: bold;">
						Nombre total d'expériences: <span id="totalExperiences">0</span>
					</div>
				</div>
			</div>
			
				
			// =====================================================================
			// TYPE 1 DE QUESTIONS 
			// =====================================================================

			<h2 style="margin-top: 40px; margin-bottom: 20px;">Exercices</h2>
			<div class="exercises">
				<!-- Exercice 1: Question basée sur simulation (naissance) -->
				<div class="exercise-card" data-exercise="1">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 1</div>
						<div class="exercise-type simulation">Basé sur simulation</div>
					</div>
					
					<div class="question-text">
						Quelle est la fréquence de l'évènement observé (exprimée en valeur décimale)?
					</div>
					
					<div class="simulation-stats">
						<div class="stats-header">Données actuelles de la simulation:</div>
						<div id="stats-ex1">
							Lancez une simulation pour voir les résultats.
						</div>
					</div>
					
					## NE PAS AFFICHER LA FREQUENCE A UTILISATEUR !!!
					
					<div class="input-group">
						<label>Réponse:</label>
						<input type="number" id="answer1" min="0" max="1" step="0.01" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkAnswer(1)">Vérifier</button>
						<div class="result" id="result1"></div>
					</div>
				</div>
				
				<!-- Exercice 2: Question basée sur simulation (arbre pondéré) -->
				<div class="exercise-card" data-exercise="2">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 2</div>
						<div class="exercise-type simulation">Basé sur simulation</div>
					</div>
					
					<div class="question-text">
						Quelle est la fréquence de l'événement (exprimée en valeur décimale)?
					</div>
					
					<div class="simulation-stats">
						<div class="stats-header">Données actuelles de la simulation:</div>
						<div id="stats-ex2">
							Lancez une simulation pour voir les résultats.
						</div>
					</div>
					
					## NE PAS AFFICHER LA FREQUENCE A UTILISATEUR !!!
					
				
					<div class="input-group">
						<label>Réponse:</label>
						<input type="number" id="answer2" min="0" max="1" step="0.01" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkAnswer(2)">Vérifier</button>
						<div class="result" id="result2"></div>
					</div>
				</div>
				
			// =====================================================================
			// TYPE 2 DE QUESTIONS 
			// =====================================================================
				
				
				<!-- Exercice 3: Calcul théorique (naissance) -->
				<div class="exercise-card" data-exercise="3">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 3</div>
						<div class="exercise-type theoretical">Calcul théorique</div>
					</div>
					
					<div class="question-text">
						Quelle est la probabilité de l'évènement (exprimée en valeur décimale)?
						## alternatives : evenement contraire
					</div>
					
					<div class="simulation-stats">
						<div class="stats-header">Rappel théorique:</div>
						<div>
							Pour chaque naissance, la probabilité d'avoir un garçon ou une fille est de 0,5.<br>
							Les naissances sont indépendantes les unes des autres.
						</div>
					</div>
					
					<div class="input-group">
						<label>Réponse:</label>
						<input type="number" id="answer3" min="0" max="1" step="0.01" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkAnswer(3)">Vérifier</button>
						<div class="result" id="result3"></div>
					</div>
				</div>
				
				<!-- Exercice 4: Calcul théorique (naissance) -->
				<div class="exercise-card" data-exercise="4">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 4</div>
						<div class="exercise-type theoretical">Calcul théorique</div>
					</div>
					
					<div class="question-text">
						Quelle est la probabilité d'avoir deux ........ dans une famille de deux enfants ? Exprimer en valeur décimale.
						## alternatives : deux filles / une fille et un garçon (dans l'ordre) / une fille et un garçon (ordre indifférent)
					</div>
					
					<div class="simulation-stats">
						<div class="stats-header">Rappel théorique:</div>
						<div>
							Pour chaque naissance, la probabilité d'avoir un garçon ou une fille est de 0,5.<br>
							Les naissances sont indépendantes les unes des autres.
						</div>
					</div>
					
					<div class="input-group">
						<label>Réponse:</label>
						<input type="number" id="answer4" min="0" max="1" step="0.01" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkAnswer(4)">Vérifier</button>
						<div class="result" id="result4"></div>
					</div>
				</div>
				
				<!-- Exercice 5: Calcul théorique (arbre pondéré) -->
				<div class="exercise-card" data-exercise="5">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 5</div>
						<div class="exercise-type theoretical">Calcul théorique</div>
					</div>
					
					<div class="question-text">
						Quelle est la probabilité de l'événement A? ## alternatives : B / non-B / non-A
					</div>
					
					<div class="simulation-stats">
						<div class="stats-header">Rappel des probabilités:</div>
						<div id="stats-ex5">
							P(A) = <span id="ex5-probA">0.6</span><br>
							P(B|A) = <span id="ex5-probBA">0.7</span><br>
							P(B|non-A) = <span id="ex5-probBnonA">0.2</span>
						</div>
					</div>
					
					<div class="input-group">
						<label>Réponse:</label>
						<input type="number" id="answer5" min="0" max="1" step="0.01" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkAnswer(5)">Vérifier</button>
						<div class="result" id="result5"></div>
					</div>
				</div>
				
				<!-- Exercice 6: Calcul théorique (arbre pondéré) -->
				<div class="exercise-card" data-exercise="6">
					<div class="exercise-header">
						<div class="exercise-title">Exercice 6</div>
						<div class="exercise-type theoretical">Calcul théorique</div>
					</div>
					
					<div class="question-text">
						Quelle est la probabilité de B sachant A?  ## alternatives : A sachant B / non-B sachant A / B sachant non-A
					</div>
					
					<div class="simulation-stats">
						<div class="stats-header">Rappel des probabilités:</div>
						<div id="stats-ex6">
							P(A) = <span id="ex6-probA">0.6</span><br>
							P(B|A) = <span id="ex6-probBA">0.7</span><br>
							P(B|non-A) = <span id="ex6-probBnonA">0.2</span>
						</div>
					</div>
					
					<div class="input-group">
						<label>Réponse:</label>
						<input type="number" id="answer6" min="0" max="1" step="0.01" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkAnswer(6)">Vérifier</button>
						<div class="result" id="result6"></div>
					</div>
				</div>
			</div>
			
			<button id="finishBtn" class="finish-btn" style="display: block; width: 100%; max-width: 300px; margin: 30px auto 0; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer;" onclick="finishTest()">Terminer l'activité</button>
			`
			},
            
			equation: {
				title: "Équilibrage d'Équations Chimiques",
				description: "Un template pour créer des exercices d'équilibrage d'équations chimiques. L'apprenant doit sélectionner les coefficients appropriés pour équilibrer les équations.",
				features: [
					"Sélection des coefficients par menu déroulant",
					"Vérification automatique de l'équilibrage",
					"Indications et explications personnalisées",
					"Tentatives multiples configurables",
					"Suivi de la progression"
				],
				icon: "fas fa-flask",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Équilibrage d'équation</h3>
						
						<div style="margin-bottom: 15px; text-align: center; background: #f0f0f0; padding: 10px; border-radius: 5px;">
							<div style="font-weight: bold;">Équilibrez l'équation suivante:</div>
							<div style="margin-top: 10px; font-size: 1.2em;">
								<select style="width: 40px; padding: 2px; border-radius: 3px; margin-right: 3px;">
									<option>1</option><option>2</option><option selected>1</option>
								</select>
								CH<sub>4</sub> + 
								<select style="width: 40px; padding: 2px; border-radius: 3px; margin: 0 3px;">
									<option>1</option><option selected>2</option><option>3</option>
								</select>
								O<sub>2</sub> → 
								<select style="width: 40px; padding: 2px; border-radius: 3px; margin: 0 3px;">
									<option selected>1</option><option>2</option><option>3</option>
								</select>
								CO<sub>2</sub> + 
								<select style="width: 40px; padding: 2px; border-radius: 3px; margin-left: 3px;">
									<option>1</option><option selected>2</option><option>3</option>
								</select>
								H<sub>2</sub>O
							</div>
						</div>
						
						<div style="text-align: center; margin-bottom: 15px;">
							<button style="padding: 8px 20px; background: #a24b5f; color: white; border: none; border-radius: 5px; cursor: pointer;">Vérifier</button>
						</div>
						
						<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; text-align: center;">
							✅ Correct! L'équation est parfaitement équilibrée.
						</div>
					</div>
				</div>
				`,
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE EQUILIBRAGE D'EQUATIONS : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation des exercices d'équilibrage
				initEquationExercises();
			});
			
			function initEquationExercises() {
				// Structure des équations
				const equations = [
					{ // 1: CH₄ + O₂ → CO₂ + H₂O
						reactifs: [{formule: "CH₄"}, {formule: "O₂"}],
						produits: [{formule: "CO₂"}, {formule: "H₂O"}],
						solution: [1, 2, 1, 2]
					},
					{ // 2: C₂H₆ + O₂ → CO₂ + H₂O
						reactifs: [{formule: "C₂H₆"}, {formule: "O₂"}],
						produits: [{formule: "CO₂"}, {formule: "H₂O"}],
						solution: [2, 7, 4, 6]
					},
					{ // 3: C₃H₈ + O₂ → CO₂ + H₂O
						reactifs: [{formule: "C₃H₈"}, {formule: "O₂"}],
						produits: [{formule: "CO₂"}, {formule: "H₂O"}],
						solution: [1, 5, 3, 4]
					},
					{ // 4: Fe + O₂ → Fe₂O₃
						reactifs: [{formule: "Fe"}, {formule: "O₂"}],
						produits: [{formule: "Fe₂O₃"}],
						solution: [4, 3, 2]
					},
					{ // 5: Al + H₂O → Al(OH)₃ + H₂
						reactifs: [{formule: "Al"}, {formule: "H₂O"}],
						produits: [{formule: "Al(OH)₃"}, {formule: "H₂"}],
						solution: [2, 6, 2, 3]
					},
					{ // 6: CO + H₂O → C₆H₁₂O₆ + O₂
						reactifs: [{formule: "CO₂"}, {formule: "H₂O"}],
						produits: [{formule: "C₆H₁₂O₆"}, {formule: "O₂"}],
						solution: [6, 6, 1, 6]
					}
				];
			
				// Pour chaque exercice, créer l'interface d'équation
				for (let exNum = 1; exNum <= 6; exNum++) {
					const reactionDiv = document.getElementById(\`reaction\${exNum}\`);
					if (!reactionDiv) continue;
					
					const equation = equations[exNum - 1];
					
					// Réactifs
					for (let i = 0; i < equation.reactifs.length; i++) {
						const reactif = equation.reactifs[i];
						
						// Création du bloc pour chaque réactif
						const reactifDiv = document.createElement("div");
						reactifDiv.classList.add("molecule");
						
						// Ajout du menu déroulant de coefficient
						const coeffSelect = createCoefficientSelect(\`ex\${exNum}_coef_r\${i}\`);
						reactifDiv.appendChild(coeffSelect);
						
						// Ajout de la formule chimique
						const formuleSpan = document.createElement("span");
						formuleSpan.innerHTML = formatFormula(reactif.formule);
						reactifDiv.appendChild(formuleSpan);
						
						// Ajout à la réaction
						reactionDiv.appendChild(reactifDiv);
						
						// Ajouter le signe + si ce n'est pas le dernier réactif
						if (i < equation.reactifs.length - 1) {
							const plusSign = document.createElement("span");
							plusSign.classList.add("plus-sign");
							plusSign.textContent = "+";
							reactionDiv.appendChild(plusSign);
						}
					}
					
					// Ajout de la flèche
					const arrowSign = document.createElement("span");
					arrowSign.classList.add("arrow-sign");
					arrowSign.textContent = "→";
					reactionDiv.appendChild(arrowSign);
					
					// Produits
					for (let i = 0; i < equation.produits.length; i++) {
						const produit = equation.produits[i];
						
						// Création du bloc pour chaque produit
						const produitDiv = document.createElement("div");
						produitDiv.classList.add("molecule");
						
						// Ajout du menu déroulant de coefficient
						const coeffSelect = createCoefficientSelect(\`ex\${exNum}_coef_p\${i}\`);
						produitDiv.appendChild(coeffSelect);
						
						// Ajout de la formule chimique
						const formuleSpan = document.createElement("span");
						formuleSpan.innerHTML = formatFormula(produit.formule);
						produitDiv.appendChild(formuleSpan);
						
						// Ajout à la réaction
						reactionDiv.appendChild(produitDiv);
						
						// Ajouter le signe + si ce n'est pas le dernier produit
						if (i < equation.produits.length - 1) {
							const plusSign = document.createElement("span");
							plusSign.classList.add("plus-sign");
							plusSign.textContent = "+";
							reactionDiv.appendChild(plusSign);
						}
					}
					
					// Ajouter le bouton de vérification
					const checkBtn = document.getElementById(\`check-btn\${exNum}\`);
					if (checkBtn) {
						checkBtn.addEventListener('click', function() {
							checkEquation(exNum);
						});
					}
				}
			}
			
			// Création des menus déroulants pour les coefficients (1 à 10)
			function createCoefficientSelect(id) {
				const select = document.createElement("select");
				select.id = id;
				for (let i = 1; i <= 10; i++) {
					const option = document.createElement("option");
					option.value = i;
					option.textContent = i;
					select.appendChild(option);
				}
				return select;
			}
			
			// Formatage des formules chimiques (mise en indice des nombres)
			function formatFormula(formula) {
				return formula.replace(/([₀-₉])/g, '<sub>$1</sub>').replace(/([0-9]+)/g, '<sub>$1</sub>');
			}
			
			// Vérification des équations
			function checkEquation(exNum) {
				const equation = equations[exNum - 1];
				const resultDiv = document.getElementById(\`result\${exNum}\`);
				const hintDiv = document.getElementById(\`hint\${exNum}\`);
				
				// Récupération des coefficients entrés par l'utilisateur
				const coefficients = [];
				
				// Pour les réactifs
				for (let i = 0; i < equation.reactifs.length; i++) {
					coefficients.push(parseInt(document.getElementById(\`ex\${exNum}_coef_r\${i}\`).value));
				}
				
				// Pour les produits
				for (let i = 0; i < equation.produits.length; i++) {
					coefficients.push(parseInt(document.getElementById(\`ex\${exNum}_coef_p\${i}\`).value));
				}
				
				// Vérification de l'équilibrage
				let estEquilibree = true;
				
				// Comparer avec la solution attendue
				if (coefficients.length === equation.solution.length) {
					// Vérifier si les coefficients sont proportionnels à la solution
					// Par exemple, si solution = [1, 2, 1, 2] et coefficients = [2, 4, 2, 4]
					const rapport = coefficients[0] / equation.solution[0];
					
					for (let i = 0; i < coefficients.length; i++) {
						if (coefficients[i] !== equation.solution[i] * rapport) {
							estEquilibree = false;
							break;
						}
					}
				} else {
					estEquilibree = false;
				}
				
				// Affichage du résultat
				if (estEquilibree) {
					resultDiv.textContent = "✅ Équation parfaitement équilibrée ! Bravo !";
					resultDiv.className = "result correct show";
					hintDiv.style.display = "none";
					
					if (!answered.has(exNum)) {
						answered.add(exNum);
						score++;
						document.getElementById('score').textContent = score;
						
						// Mettre à jour le bouton de fin
						updateFinishButton();
					}
					
					// Désactiver le bouton
					document.getElementById(\`check-btn\${exNum}\`).disabled = true;
					
					// Désactiver les sélecteurs
					const selectors = document.querySelectorAll(\`#reaction\${exNum} select\`);
					selectors.forEach(selector => {
						selector.disabled = true;
					});
				} else {
					resultDiv.textContent = "❌ L'équation n'est pas équilibrée. Essayez encore.";
					resultDiv.className = "result incorrect show";
					hintDiv.style.display = "block";
					
					// Si nombre de tentatives limité
					if (maxAttempts > 0) {
						const currentAttempts = (attempts.get(exNum) || 0) + 1;
						attempts.set(exNum, currentAttempts);
						
						if (currentAttempts >= maxAttempts) {
							resultDiv.textContent = \`❌ Nombre maximum de tentatives atteint. La solution correcte était: \${equation.solution.join(', ')}\`;
							document.getElementById(\`check-btn\${exNum}\`).disabled = true;
							
							// Désactiver les sélecteurs
							const selectors = document.querySelectorAll(\`#reaction\${exNum} select\`);
							selectors.forEach(selector => {
								selector.disabled = true;
							});
						}
					}
				}
			}`,
				code: `<div class="exercise-card" data-exercise="1">
				<div class="material-header">
					<span>Exercice 1</span>
				</div>
				
				<div class="question-text">
					Équilibrez l'équation suivante en sélectionnant les coefficients appropriés.
				</div>
				
				<div class="reaction" id="reaction1"></div>
				
				<div class="input-group">
					<button class="check-btn" id="check-btn1">Vérifier</button>
					<div class="result" id="result1"></div>
					<div class="hint" id="hint1">💡 Assurez-vous que le nombre d'atomes de chaque élément est égal des deux côtés de la flèche.</div>
				</div>
			</div>`
			},
						

			turtle: {
				title: "Console Python Turtle",
				description: "Un template pour créer des défis de programmation Python utilisant la bibliothèque Turtle pour dessiner des formes géométriques. Les apprenants doivent écrire du code Python pour dessiner différentes formes.",
				features: [
					"Éditeur de code Python intégré",
					"Exécution du code en temps réel avec Skulpt",
					"Défis géométriques progressifs",
					"Système de validation automatique",
					"Badges de progression",
					"Vue prévisualisation du résultat attendu"
				],
				icon: "fab fa-python",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="display: flex; gap: 20px; margin-bottom: 15px;">
						<div style="flex: 1; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							<h3 style="margin-bottom: 10px; color: #4e54c8;">Défi: Dessiner un carré</h3>
							<div style="background: #f0f3f9; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin-bottom: 10px;">
							# Dessiner un carré
							import turtle
							t = turtle.Turtle()
							
							for i in range(4):
								t.forward(100)
								t.right(90)
							</div>
							<div style="display: flex; gap: 5px; margin-top: 10px;">
								<button style="padding: 5px 10px; background: #4e54c8; color: white; border: none; border-radius: 5px; cursor: pointer;">Exécuter</button>
								<button style="padding: 5px 10px; background: #f0f3f9; color: #333; border: none; border-radius: 5px; cursor: pointer;">Réinitialiser</button>
							</div>
						</div>
						<div style="width: 150px; height: 150px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							<svg width="100" height="100" viewBox="0 0 100 100">
								<rect x="25" y="25" width="50" height="50" stroke="#333" stroke-width="2" fill="none"/>
							</svg>
						</div>
					</div>
				</div>
				`,
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE TURTLE : PRIORITE OBLIGATOIRE SI CHOISIE
			// Variables globales pour le suivi des défis
			let currentChallengeId = 1;
			let score = 0;
			let completedChallenges = new Set();
			let editor;
			
			// Définition des défis
			const challenges = [
				{
					id: 1,
					title: "Carré",
					description: "Créez un carré de 100 pixels de côté en utilisant la tortue.",
					hint: "Pour dessiner un carré, vous avez besoin d'une boucle qui répète 4 fois : avancer (forward) puis tourner à droite (right) de 90 degrés.",
					initialCode: "# Créer notre tortue: dessiner un carré\\nimport turtle\\nt = turtle.Turtle()\\nt.speed(4)  # Vitesse rapide\\n\\n# Votre code ici\\n",
					expectedImage: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB4PSI1MCIgeT0iNTAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz48L3N2Zz4=",
					validationFunction: function(code) {
						// Vérifier que le code dessine un carré
						const lowerCode = code.toLowerCase();
						const hasForwardOrFd = lowerCode.includes("forward(100)") || lowerCode.includes("fd(100)");
						const hasRightOrRt = lowerCode.includes("right(90)") || lowerCode.includes("rt(90)");
						const hasLeftOrLt = lowerCode.includes("left(90)") || lowerCode.includes("lt(90)");
						const hasLoop = lowerCode.includes("for") && lowerCode.includes("range") && lowerCode.includes("4");
						
						// Alternative sans boucle
						const hasMultipleForward = 
							(lowerCode.match(/forward\\s*\\(\\s*100\\s*\\)/g) || []).length >= 4 || 
							(lowerCode.match(/fd\\s*\\(\\s*100\\s*\\)/g) || []).length >= 4;
						const hasMultipleRight = 
							(lowerCode.match(/right\\s*\\(\\s*90\\s*\\)/g) || []).length >= 3 || 
							(lowerCode.match(/rt\\s*\\(\\s*90\\s*\\)/g) || []).length >= 3;
						const hasMultipleLeft = 
							(lowerCode.match(/left\\s*\\(\\s*90\\s*\\)/g) || []).length >= 3 || 
							(lowerCode.match(/lt\\s*\\(\\s*90\\s*\\)/g) || []).length >= 3;
						
						return (hasForwardOrFd && (hasRightOrRt || hasLeftOrLt) && hasLoop) || 
							   (hasMultipleForward && (hasMultipleRight || hasMultipleLeft));
					}
				},
				{
					id: 2,
					title: "Rectangle",
					description: "Créez un rectangle de 150 pixels de largeur et 80 pixels de hauteur.",
					hint: "Comme pour le carré, mais alternez entre deux longueurs différentes: 150 et 80 pixels. Vous pouvez utiliser une boucle ou pas.",
					initialCode: "# Créer notre tortue: dessiner un rectangle\\nimport turtle\\nt = turtle.Turtle()\\nt.speed(4)  # Vitesse rapide\\n\\n# Votre code ici\\n",
					expectedImage: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB4PSIyNSIgeT0iNjAiIHdpZHRoPSIxNTAiIGhlaWdodD0iODAiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPjwvc3ZnPg==",
					validationFunction: function(code) {
						// Vérifier que le code dessine un rectangle
						const lowerCode = code.toLowerCase();
						
						// Vérifications de base pour les commandes individuelles
						const hasForward150 = lowerCode.includes("forward(150)") || lowerCode.includes("fd(150)");
						const hasForward80 = lowerCode.includes("forward(80)") || lowerCode.includes("fd(80)");
						const hasRight90 = lowerCode.includes("right(90)") || lowerCode.includes("rt(90)");
						const hasLeft90 = lowerCode.includes("left(90)") || lowerCode.includes("lt(90)");
						
						// Vérifier qu'il y a au moins 2 côtés de chaque longueur
						const forward150Count = (lowerCode.match(/forward\\s*\\(\\s*150\\s*\\)/g) || []).length + 
											 (lowerCode.match(/fd\\s*\\(\\s*150\\s*\\)/g) || []).length;
						const forward80Count = (lowerCode.match(/forward\\s*\\(\\s*80\\s*\\)/g) || []).length + 
											(lowerCode.match(/fd\\s*\\(\\s*80\\s*\\)/g) || []).length;
						
						// Compter le nombre de rotations à droite et à gauche
						const rightTurnCount = (lowerCode.match(/right\\s*\\(\\s*90\\s*\\)/g) || []).length + 
											 (lowerCode.match(/rt\\s*\\(\\s*90\\s*\\)/g) || []).length;
						const leftTurnCount = (lowerCode.match(/left\\s*\\(\\s*90\\s*\\)/g) || []).length + 
											(lowerCode.match(/lt\\s*\\(\\s*90\\s*\\)/g) || []).length;
						
						// Patterns spécifiques pour les boucles correctes (avec indentation flexible)
						const rightLoopPattern = /for\\s+\\w+\\s+in\\s+range\\s*\\(\\s*2\\s*\\)[\\s\\S]*?forward\\s*\\(\\s*150\\s*\\)[\\s\\S]*?right\\s*\\(\\s*90\\s*\\)[\\s\\S]*?forward\\s*\\(\\s*80\\s*\\)[\\s\\S]*?right\\s*\\(\\s*90\\s*\\)/i;
						const leftLoopPattern = /for\\s+\\w+\\s+in\\s+range\\s*\\(\\s*2\\s*\\)[\\s\\S]*?forward\\s*\\(\\s*150\\s*\\)[\\s\\S]*?left\\s*\\(\\s*90\\s*\\)[\\s\\S]*?forward\\s*\\(\\s*80\\s*\\)[\\s\\S]*?left\\s*\\(\\s*90\\s*\\)/i;
						
						// Versions alternatives avec fd au lieu de forward
						const rightLoopPatternFd = /for\\s+\\w+\\s+in\\s+range\\s*\\(\\s*2\\s*\\)[\\s\\S]*?fd\\s*\\(\\s*150\\s*\\)[\\s\\S]*?rt\\s*\\(\\s*90\\s*\\)[\\s\\S]*?fd\\s*\\(\\s*80\\s*\\)[\\s\\S]*?rt\\s*\\(\\s*90\\s*\\)/i;
						const leftLoopPatternFd = /for\\s+\\w+\\s+in\\s+range\\s*\\(\\s*2\\s*\\)[\\s\\S]*?fd\\s*\\(\\s*150\\s*\\)[\\s\\S]*?lt\\s*\\(\\s*90\\s*\\)[\\s\\S]*?fd\\s*\\(\\s*80\\s*\\)[\\s\\S]*?lt\\s*\\(\\s*90\\s*\\)/i;
						
						// Vérifier le motif de boucle efficace
						const hasCorrectLoopPattern = rightLoopPattern.test(code) || leftLoopPattern.test(code) || 
												  rightLoopPatternFd.test(code) || leftLoopPatternFd.test(code);
						
						// Approche standard (sans boucle efficace)
						const standardApproach = hasForward150 && hasForward80 && (hasRight90 || hasLeft90) && 
											  forward150Count >= 2 && forward80Count >= 2 && 
											  (rightTurnCount >= 3 || leftTurnCount >= 3);
						
						return standardApproach || hasCorrectLoopPattern;
					}
				},
				{
					id: 3,
					title: "Triangle équilatéral",
					description: "Créez un triangle équilatéral (3 côtés égaux) de 100 pixels de côté.",
					hint: "Pour un triangle équilatéral, vous avez besoin de 3 côtés égaux avec des angles de 120 degrés (ou tourner de 120° à chaque sommet).",
					initialCode: "# Créer notre tortue: dessiner un triangle équilatéral\\nimport turtle\\nt = turtle.Turtle()\\nt.speed(4)  # Vitesse rapide\\n\\n# Votre code ici\\n",
					expectedImage: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cG9seWdvbiBwb2ludHM9IjEwMCw0MCAxNTAsMTQwIDUwLDE0MCIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+PC9zdmc+",
					validationFunction: function(code) {
						// Vérifier que le code dessine un triangle équilatéral
						const lowerCode = code.toLowerCase();
						const hasForward100 = lowerCode.includes("forward(100)") || lowerCode.includes("fd(100)");
						
						// Pour un triangle équilatéral, on tourne de 120 degrés à chaque sommet
						// Ou on peut aussi tourner de 60 degrés externes
						const hasAngle120 = lowerCode.includes("right(120)") || lowerCode.includes("rt(120)") || 
										 lowerCode.includes("left(120)") || lowerCode.includes("lt(120)");
						const hasAngle60 = lowerCode.includes("right(60)") || lowerCode.includes("rt(60)") || 
										lowerCode.includes("left(60)") || lowerCode.includes("lt(60)");
						
						// Une boucle avec 3 itérations est souvent utilisée
						const hasLoop = lowerCode.includes("for") && lowerCode.includes("range") && lowerCode.includes("3");
						
						// Vérifier qu'il y a 3 segments de 100 pixels
						const forward100Count = (lowerCode.match(/forward\\s*\\(\\s*100\\s*\\)/g) || []).length + 
											 (lowerCode.match(/fd\\s*\\(\\s*100\\s*\\)/g) || []).length;
						
						return hasForward100 && (hasAngle120 || hasAngle60) && (hasLoop || forward100Count >= 3);
					}
				},
				{
					id: 4,
					title: "Hexagone",
					description: "Créez un hexagone régulier (6 côtés égaux) de 50 pixels de côté.",
					hint: "Pour un hexagone régulier, vous avez besoin de 6 côtés égaux avec des angles de 60 degrés (ou tourner de 60° à chaque sommet).",
					initialCode: "# Créer notre tortue: dessiner un hexagone\\nimport turtle\\nt = turtle.Turtle()\\nt.speed(4)  # Vitesse rapide\\n\\n# Votre code ici\\n",
					expectedImage: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cG9seWdvbiBwb2ludHM9IjEyNSw1MCAxNzUsMTAwIDEyNSwxNTAgNzUsMTUwIDI1LDEwMCA3NSw1MCIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+PC9zdmc+",
					validationFunction: function(code) {
						// Vérifier que le code dessine un hexagone
						const lowerCode = code.toLowerCase();
						const hasForward50 = lowerCode.includes("forward(50)") || lowerCode.includes("fd(50)");
						
						// Pour un hexagone régulier, on tourne de 60 degrés à chaque sommet
						const hasAngle60 = lowerCode.includes("right(60)") || lowerCode.includes("rt(60)") || 
										lowerCode.includes("left(60)") || lowerCode.includes("lt(60)");
						
						// Une boucle avec 6 itérations est généralement utilisée
						const hasLoop = lowerCode.includes("for") && lowerCode.includes("range") && 
									 (lowerCode.includes("6") || lowerCode.includes("range(0, 6)"));
						
						return hasForward50 && hasAngle60 && hasLoop;
					}
				}

			];
			
			// Badges et leurs seuils
			const badges = [
				{ id: 'badge1', name: 'Débutant', threshold: 1 },
				{ id: 'badge2', name: 'Apprenti', threshold: 2 },
				{ id: 'badge3', name: 'Confirmé', threshold: 3 },
				{ id: 'badge4', name: 'Expert', threshold: 5 },
				{ id: 'badge5', name: 'Maître', threshold: 6 }
			];
			
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation
				initTurtleApp();
			});
			
			function initTurtleApp() {
				// Charger les scripts Skulpt si nécessaire
				loadSkulptScripts().then(() => {
					// Initialiser l'éditeur CodeMirror
					initEditor();
					
					// Initialiser les défis
					setupChallenges();
					
					// Charger le premier défi
					loadChallenge(1);
					
					// Ajouter les écouteurs d'événements pour les boutons
					document.getElementById('run-btn').addEventListener('click', runTurtleCode);
					document.getElementById('clear-btn').addEventListener('click', function() {
						editor.setValue(challenges[currentChallengeId - 1].initialCode);
						editor.focus();
					});
					document.getElementById('clear-canvas-btn').addEventListener('click', clearTurtleCanvas);
					document.getElementById('hint-btn').addEventListener('click', toggleHint);
					document.getElementById('validate-btn').addEventListener('click', validateCode);
					
					// Ajouter les écouteurs pour les boutons de commandes
					document.querySelectorAll('.command-btn').forEach(button => {
						button.addEventListener('click', function() {
							insertCodeSnippet(this.getAttribute('data-code'));
						});
					});
				}).catch(error => {
					console.error("Erreur lors de l'initialisation de Skulpt:", error);
				});
			}
			
			// Charger les scripts Skulpt dynamiquement
			function loadSkulptScripts() {
				return new Promise((resolve, reject) => {
					// Vérifier si Skulpt est déjà chargé
					if (typeof Sk !== 'undefined') {
						resolve();
						return;
					}
					
					// Charger Skulpt
					const skulptCore = document.createElement('script');
					skulptCore.src = 'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js';
					
					const skulptStdLib = document.createElement('script');
					skulptStdLib.src = 'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js';
					
					document.head.appendChild(skulptCore);
					
					// Charger la bibliothèque standard après le core
					skulptCore.onload = function() {
						document.head.appendChild(skulptStdLib);
						
						skulptStdLib.onload = function() {
							// Configurer Skulpt
							Sk.configure({
								output: function(text) { return text; },
								read: function(x) {
									if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
										throw "File not found: '" + x + "'";
									return Sk.builtinFiles["files"][x];
								},
								__future__: Sk.python3
							});
							
							resolve();
						};
						
						skulptStdLib.onerror = function() {
							reject(new Error("Failed to load Skulpt stdlib"));
						};
					};
					
					skulptCore.onerror = function() {
						reject(new Error("Failed to load Skulpt core"));
					};
				});
			}
			
			// Initialiser l'éditeur CodeMirror
			function initEditor() {
				const editorTextarea = document.getElementById('code-editor');
				
				// Vérifier si CodeMirror est déjà chargé
				if (typeof CodeMirror === 'undefined') {
					// Charger dynamiquement CodeMirror
					const codemirrorCSS = document.createElement('link');
					codemirrorCSS.rel = 'stylesheet';
					codemirrorCSS.href = 'https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.css';
					document.head.appendChild(codemirrorCSS);
					
					const codemirrorJS = document.createElement('script');
					codemirrorJS.src = 'https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js';
					document.head.appendChild(codemirrorJS);
					
					codemirrorJS.onload = function() {
						const pythonMode = document.createElement('script');
						pythonMode.src = 'https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/python/python.min.js';
						document.head.appendChild(pythonMode);
						
						pythonMode.onload = function() {
							// Créer l'éditeur après le chargement des scripts
							createEditor(editorTextarea);
						};
					};
				} else {
					// CodeMirror est déjà chargé
					createEditor(editorTextarea);
				}
			}
			
			
			function createEditor(editorTextarea) {
				editor = CodeMirror.fromTextArea(editorTextarea, {
					mode: "python",
					lineNumbers: true,
					theme: "default",
					indentUnit: 4,
					tabSize: 4,
					indentWithTabs: false,
					autofocus: true
				});
				
				// Définir le contenu initial
				editor.setValue(challenges[0].initialCode);
			}
			
			// Configurer les défis
			function setupChallenges() {
				// Créer les éléments de défi dans la liste des défis
				const challengesList = document.querySelector('.challenges-list');
				challengesList.innerHTML = '';
				
				challenges.forEach(challenge => {
					const challengeItem = document.createElement('div');
					challengeItem.className = 'challenge-item';
					challengeItem.setAttribute('data-challenge', challenge.id);
					
					challengeItem.innerHTML = \`
						<div class="challenge-icon">\${getIconForChallenge(challenge)}</div>
						<div class="challenge-info">
							<div class="challenge-title">\${challenge.title}</div>
							<div class="challenge-status">À faire</div>
						</div>
					\`;
					
					challengeItem.addEventListener('click', function() {
						loadChallenge(challenge.id);
					});
					
					challengesList.appendChild(challengeItem);
				});
			}
			
			// Obtenir l'icône pour un défi spécifique
			function getIconForChallenge(challenge) {
				switch(challenge.id) {
					case 1: return '□';
					case 2: return '▭';
					case 3: return '△';
					case 4: return '○';
					case 5: return '⬡';
					case 6: return '★';
					default: return '#';
				}
			}
			
			// Charger un défi spécifique
			function loadChallenge(challengeId) {
				currentChallengeId = challengeId;
				const challenge = challenges[challengeId - 1];
				
				// Mettre à jour le titre et la description
				document.getElementById('current-challenge-title').textContent = challenge.title;
				document.getElementById('current-challenge-text').textContent = challenge.description;
				document.getElementById('hint-text').textContent = '💡 ' + challenge.hint;
				
				// Mettre à jour l'image attendue
				document.getElementById('expected-image').src = challenge.expectedImage;
				
				// Mettre à jour le code initial si nécessaire
				const currentCode = editor ? editor.getValue() : '';
				
				if (!currentCode || currentCode === challenges[currentChallengeId - 2]?.initialCode) {
					if (editor) {
						editor.setValue(challenge.initialCode);
					} else {
						document.getElementById('code-editor').value = challenge.initialCode;
					}
				}
				
				// Cacher l'indice et le message de résultat
				document.getElementById('hint-text').style.display = 'none';
				const resultMessage = document.getElementById('result-message');
				if (resultMessage) {
					resultMessage.className = 'result-message';
				}
				
				// Mettre à jour la classe active dans la liste des défis
				document.querySelectorAll('.challenge-item').forEach(item => {
					item.classList.remove('active');
				});
				
				const currentChallengeItem = document.querySelector(\`.challenge-item[data-challenge="\${challengeId}"]\`);
				if (currentChallengeItem) {
					currentChallengeItem.classList.add('active');
				}
				
				// Désactiver le bouton "valider" initialement
				document.getElementById('validate-btn').disabled = true;
				
				// Vider la zone de dessin
				clearTurtleCanvas();
			}
			
			// Exécuter le code Python Turtle
			function runTurtleCode() {
				const code = editor ? editor.getValue() : document.getElementById('code-editor').value;
				
				// Vider la zone de dessin
				clearTurtleCanvas();
				
				// Configuration de Skulpt pour Turtle
				Sk.configure({
					output: function(text) {
						// Ignorer la sortie texte en mode Turtle
					},
					read: function(x) {
						if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
							throw "File not found: '" + x + "'";
						return Sk.builtinFiles["files"][x];
					},
					__future__: Sk.python3,
					inputfun: function(prompt) {
						return Promise.resolve("");
					}
				});
				
				// Configuration spécifique pour Turtle
				Sk.TurtleGraphics = Sk.TurtleGraphics || {};
				Sk.TurtleGraphics.target = 'turtle-canvas';
				
				// Ajuster la taille du canvas en fonction du conteneur
				const container = document.querySelector('.turtle-canvas-container');
				if (container) {
					Sk.TurtleGraphics.width = container.clientWidth;
					Sk.TurtleGraphics.height = container.clientHeight;
				}
				
				try {
					// Exécuter le code Python
					Sk.misceval.asyncToPromise(function() {
						return Sk.importMainWithBody("<stdin>", false, code, true);
					}).then(function() {
						console.log("Exécution Turtle terminée avec succès");
						
						// Vérifier si un dessin a été créé
						const canvasElement = document.getElementById("turtle-canvas");
						const hasDrawing = canvasElement && canvasElement.childElementCount > 0;
						
						// Activer le bouton "valider" uniquement si un dessin existe
						document.getElementById("validate-btn").disabled = !hasDrawing;
						
					}, function(err) {
						alert("Erreur: " + err.toString());
						console.error("Erreur Skulpt:", err);
						
						// Désactiver le bouton "valider" en cas d'erreur
						document.getElementById("validate-btn").disabled = true;
					});
				} catch (e) {
					alert("Erreur fatale: " + e.toString());
					console.error("Erreur critique:", e);
					
					// Désactiver le bouton "valider" en cas d'erreur
					document.getElementById("validate-btn").disabled = true;
				}
			}
			
			// Effacer uniquement le canvas
			function clearTurtleCanvas() {
				const canvasElement = document.getElementById("turtle-canvas");
				if (canvasElement) {
					while (canvasElement.firstChild) {
						canvasElement.removeChild(canvasElement.firstChild);
					}
				}
				
				// Désactiver le bouton "valider" car il n'y a plus de dessin
				document.getElementById("validate-btn").disabled = true;
				
				// Masquer les messages de résultat précédents
				const resultMessage = document.getElementById("result-message");
				if (resultMessage) {
					resultMessage.className = "result-message";
				}
			}
			
			// Basculer l'affichage de l'indice
			function toggleHint() {
				const hintText = document.getElementById("hint-text");
				if (hintText) {
					hintText.style.display = hintText.style.display === "block" ? "none" : "block";
				}
			}
			
			// Valider le code
			function validateCode() {
				const code = editor ? editor.getValue() : document.getElementById('code-editor').value;
				const challenge = challenges[currentChallengeId - 1];
				
				if (challenge.validationFunction(code)) {
					// Afficher le message de réussite
					showResultMessage(true);
					
					// Mettre à jour le statut du défi s'il n'a pas encore été complété
					if (!completedChallenges.has(currentChallengeId)) {
						completedChallenges.add(currentChallengeId);
						
						// Mettre à jour le score
						score++;
						updateScore();
						
						// Mettre à jour l'interface
						updateChallengeStatus(currentChallengeId, true);
						updateBadges();
						updateFinishButton();
					}
					
					return true;
				} else {
					// Afficher le message d'échec
					showResultMessage(false);
					return false;
				}
			}
			
			// Afficher un message de résultat
			function showResultMessage(success) {
				const resultMessage = document.getElementById("result-message");
				if (resultMessage) {
					if (success) {
						resultMessage.textContent = "✅ Bravo ! Vous avez réussi ce défi !";
						resultMessage.className = "result-message correct show";
					} else {
						resultMessage.textContent = "❌ Ce n'est pas tout à fait ça. Essayez encore !";
						resultMessage.className = "result-message incorrect show";
					}
				}
			}
			
			// Mettre à jour le score affiché
			function updateScore() {
				document.getElementById("score").textContent = score;
			}
			
			// Mettre à jour le statut d'un défi
			function updateChallengeStatus(challengeId, completed) {
				const challengeItem = document.querySelector(\`.challenge-item[data-challenge="\${challengeId}"]\`);
				
				if (challengeItem) {
					if (completed) {
						challengeItem.classList.add("challenge-complete");
						const statusElement = challengeItem.querySelector(".challenge-status");
						if (statusElement) {
							statusElement.textContent = "Terminé ✓";
						}
					} else {
						challengeItem.classList.remove("challenge-complete");
						const statusElement = challengeItem.querySelector(".challenge-status");
						if (statusElement) {
							statusElement.textContent = "À faire";
						}
					}
				}
			}
			
			// Mettre à jour les badges
			function updateBadges() {
				badges.forEach(badge => {
					const badgeElement = document.getElementById(badge.id);
					if (badgeElement) {
						if (score >= badge.threshold) {
							badgeElement.classList.add('unlocked');
						} else {
							badgeElement.classList.remove('unlocked');
						}
					}
				});
			}
			
			// Mettre à jour le bouton de fin
			function updateFinishButton() {
				const finishBtn = document.getElementById("finish-btn");
				if (finishBtn) {
					if (completedChallenges.size >= 1) {
						finishBtn.disabled = false;
					}
					
					if (completedChallenges.size === challenges.length) {
						finishBtn.textContent = "🎉 Bravo ! Vous avez terminé tous les défis !";
						finishBtn.style.background = "#4CAF50";
					}
				}
			}
			
			// Insérer un snippet de code dans l'éditeur
			function insertCodeSnippet(code) {
				if (editor) {
					const cursor = editor.getCursor();
					editor.replaceRange(code + "\\n", cursor);
					editor.focus();
				}
			}
			
			// Fonction pour montrer les résultats finaux
			function showFinalResults() {
				// Mettre à jour les scores
				document.getElementById('final-score').textContent = score;
				document.getElementById('final-total').textContent = challenges.length;
				
				// Définir le message selon le score
				let achievementText = "";
				if (score === challenges.length) {
					achievementText = "Parfait! Vous maîtrisez Python Turtle! 🎉";
				} else if (score >= challenges.length * 0.75) {
					achievementText = "Très bien! Vous avez une bonne compréhension de Python Turtle! 👍";
				} else if (score >= challenges.length * 0.5) {
					achievementText = "Bien! Continuez à pratiquer pour améliorer vos compétences! 💪";
				} else {
					achievementText = "Continuez à apprendre et pratiquer Python Turtle! 📚";
				}
				
				document.getElementById('achievement-text').textContent = achievementText;
				
				// Afficher la fenêtre modale
				document.getElementById('results-modal').style.display = 'block';
			}
			`,
				code: `<div class="turtle-app-container">
			
				<div class="main-content">
					<!-- Colonne gauche - liste des défis -->
					<div class="challenges-list">
						<!-- Les défis seront générés dynamiquement -->
					</div>
					
					<!-- Colonne droite - zone de travail -->
					<div class="working-area">
						<div class="challenge-description">
							<h2 class="challenge-title" id="current-challenge-title">Carré</h2>
							<div class="challenge-text" id="current-challenge-text">
								Créez un carré de 100 pixels de côté en utilisant la tortue.
							</div>
							<div class="hint-text" id="hint-text">
								💡 Pour dessiner un carré, vous avez besoin d'une boucle qui répète 4 fois : avancer (forward) puis tourner à droite (right) de 90 degrés.
							</div>
						</div>
						
						<div class="turtle-content">
							<!-- Partie gauche - éditeur de code -->
							<div class="editor-container">
								<div class="editor-controls">
									<button class="btn run-btn" id="run-btn">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
										</svg>
										Exécuter
									</button>
									<button class="btn clear-btn" id="clear-btn">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
										</svg>
										Effacer code
									</button>
									<button class="btn clear-canvas-btn" id="clear-canvas-btn">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828l6.879-6.879zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293l.16-.16z"/>
										</svg>
										Effacer dessin
									</button>
									<button class="btn hint-btn" id="hint-btn">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
										</svg>
										Indice
									</button>
									<button class="btn validate-btn" id="validate-btn" disabled>
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
										</svg>
										Valider
									</button>
								</div>
								
								<textarea id="code-editor">
			# Créer notre tortue: dessiner un carré
			import turtle 
			t = turtle.Turtle()
			t.speed(4)  # Vitesse rapide
			
			# Votre code ici
			</textarea>
								
								<div class="turtle-commands">
									<button class="command-btn" data-code="t.forward(100)">t.forward(100)</button>
									<button class="command-btn" data-code="t.backward(100)">t.backward(100)</button>
									<button class="command-btn" data-code="t.right(90)">t.right(90)</button>
									<button class="command-btn" data-code="t.left(90)">t.left(90)</button>
									<button class="command-btn" data-code="t.penup()">t.penup()</button>
									<button class="command-btn" data-code="t.pendown()">t.pendown()</button>
									<button class="command-btn" data-code="t.color('blue')">t.color('blue')</button>
									<button class="command-btn" data-code="t.begin_fill()">t.begin_fill()</button>
									<button class="command-btn" data-code="t.end_fill()">t.end_fill()</button>
									<button class="command-btn" data-code="t.fillcolor('red')">t.fillcolor('red')</button>
									<button class="command-btn" data-code="t.circle(50)">t.circle(50)</button>
									<button class="command-btn" data-code="t.goto(0, 0)">t.goto(0, 0)</button>
									<button class="command-btn" data-code="for i in range(4):">for i in range(4):</button>
								</div>
							</div>
							
							<!-- Partie droite - sortie canvas -->
							<div class="turtle-output">
								<div class="turtle-canvas-container">
									<div id="turtle-canvas">
										<!-- La zone de dessin Turtle sera insérée ici -->
									</div>
									<div class="expected-image">
										<img id="expected-image" src="" alt="Résultat attendu">
									</div>
								</div>
								
								<div class="result-message" id="result-message"></div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Bouton flottant pour terminer les défis -->
				<button id="finish-btn" class="finish-btn" disabled>Terminer tous les défis</button>
				
				<!-- Fenêtre modale pour les résultats finaux -->
				<div id="results-modal" class="modal">
					<div class="modal-content">
						<span class="close-modal">&times;</span>
						<h2>🎉 Félicitations! 🎉</h2>
						<p>Vous avez terminé les défis Turtle Python!</p>
						<div class="final-score">
							Score final: <span id="final-score">0</span>/<span id="final-total">6</span>
						</div>
						<p id="achievement-text">Continuez à pratiquer pour améliorer vos compétences en Python!</p>
					</div>
				</div>
			</div>
			
			<style>
			/* Styles pour l'application Turtle */
			.turtle-app-container {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				color: #333;
				max-width: 1400px;
				margin: 0 auto;
			}
			
			/* Badges */
			.badges-container {
				display: flex;
				justify-content: center;
				gap: 15px;
				margin-top: 20px;
				margin-bottom: 20px;
			}
			
			.badge {
				width: 60px;
				height: 60px;
				border-radius: 50%;
				background: #f0f3f9;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1.5em;
				box-shadow: 0 5px 10px rgba(0,0,0,0.1);
				transition: all 0.3s;
				position: relative;
			}
			
			.badge.unlocked {
				background: #4e54c8;
				color: white;
				transform: scale(1.1);
			}
			
			.badge-tooltip {
				position: absolute;
				bottom: -30px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(0,0,0,0.8);
				color: white;
				padding: 5px 10px;
				border-radius: 5px;
				font-size: 0.8em;
				opacity: 0;
				transition: all 0.3s;
				pointer-events: none;
				white-space: nowrap;
			}
			
			.badge:hover .badge-tooltip {
				opacity: 1;
				bottom: -35px;
			}
			
			/* Structure principale */
			.main-content {
				display: flex;
				gap: 20px;
				margin-bottom: 20px;
			}
			
			/* Liste des défis */
			.challenges-list {
				width: 300px;
				background: #f5f7fa;
				border-radius: 15px;
				padding: 20px;
				box-shadow: 0 4px 12px rgba(0,0,0,0.05);
			}
			
			.challenge-item {
				background: white;
				padding: 15px;
				margin-bottom: 15px;
				border-radius: 10px;
				cursor: pointer;
				transition: all 0.3s;
				border: 2px solid #ebeef2;
				display: flex;
				align-items: center;
				gap: 10px;
			}
			
			.challenge-item:hover {
				transform: translateY(-3px);
				box-shadow: 0 6px 12px rgba(0,0,0,0.08);
				border-color: #4e54c8;
			}
			
			.challenge-item.active {
				border-color: #4e54c8;
				background: rgba(78, 84, 200, 0.05);
				box-shadow: 0 6px 12px rgba(0,0,0,0.08);
			}
			
			.challenge-icon {
				font-size: 1.5em;
				width: 40px;
				height: 40px;
				display: flex;
				align-items: center;
				justify-content: center;
				background: #f0f3f9;
				border-radius: 50%;
				color: #4e54c8;
			}
			
			.challenge-complete .challenge-icon {
				background: #4CAF50;
				color: white;
			}
			
			.challenge-info {
				flex-grow: 1;
			}
			
			.challenge-title {
				font-weight: bold;
				margin-bottom: 5px;
				font-size: 1.1em;
			}
			
			.challenge-status {
				font-size: 0.8em;
				color: #777;
			}
			
			.challenge-complete .challenge-status {
				color: #4CAF50;
			}
			
			/* Zone de travail */
			.working-area {
				flex: 1;
				display: flex;
				flex-direction: column;
			}
			
			.challenge-description {
				background: #f5f7fa;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 15px;
				box-shadow: 0 4px 8px rgba(0,0,0,0.05);
			}
			
			.challenge-title {
				font-size: 1.3em;
				font-weight: bold;
				margin-bottom: 10px;
				color: #4e54c8;
			}
			
			.challenge-text {
				line-height: 1.6;
				margin-bottom: 15px;
			}
			
			.hint-text {
				background: #FFF8E1;
				padding: 12px;
				border-left: 4px solid #FFD54F;
				border-radius: 4px;
				margin-top: 10px;
				display: none;
			}
			
			/* Contenu Turtle */
			.turtle-content {
				display: flex;
				gap: 20px;
				flex: 1;
			}
			
			/* Éditeur de code */
			.editor-container {
				flex: 1;
				display: flex;
				flex-direction: column;
			}
			
			.editor-controls {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
				flex-wrap: wrap;
			}
			
			.btn {
				padding: 10px 15px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-weight: bold;
				transition: all 0.3s;
				display: flex;
				align-items: center;
				gap: 5px;
			}
			
			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}
			
			.run-btn {
				background: #4e54c8;
				color: white;
				flex-grow: 1;
			}
			
			.clear-btn, .clear-canvas-btn {
				background: #f0f3f9;
				color: #333;
			}
			
			.hint-btn {
				background: #FFD54F;
				color: #333;
			}
			
			.validate-btn {
				background: #4CAF50;
				color: white;
			}
			
			.validate-btn:hover:not(:disabled) {
				background: #388E3C;
			}
			
			.CodeMirror {
				height: 300px;
				border-radius: 8px;
				font-family: 'Menlo', Monaco, 'Courier New', monospace;
				border: 1px solid #ebeef2;
				box-shadow: 0 4px 8px rgba(0,0,0,0.05);
			}
			
			#code-editor {
				width: 100%;
				height: 300px;
				font-family: 'Menlo', Monaco, 'Courier New', monospace;
				border: 1px solid #ebeef2;
				border-radius: 8px;
				padding: 10px;
				box-shadow: 0 4px 8px rgba(0,0,0,0.05);
				resize: vertical;
			}
			
			.turtle-commands {
				display: flex;
				flex-wrap: wrap;
				gap: 5px;
				margin-top: 15px;
				background: #f5f7fa;
				padding: 15px;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0,0,0,0.05);
			}
			
			.command-btn {
				padding: 8px 12px;
				background: white;
				border: 1px solid #ebeef2;
				border-radius: 6px;
				font-size: 0.9em;
				cursor: pointer;
				transition: all 0.2s;
			}
			
			.command-btn:hover {
				background: #f0f3f9;
				box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			}
			
			/* Zone de sortie Turtle */
			.turtle-output {
				flex: 1;
				display: flex;
				flex-direction: column;
			}
			
			.turtle-canvas-container {
				flex: 1;
				background: white;
				border-radius: 8px;
				border: 1px solid #ebeef2;
				overflow: hidden;
				position: relative;
				box-shadow: 0 4px 8px rgba(0,0,0,0.05);
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 400px;
			}
			
			#turtle-canvas {
				width: 100%;
				height: 100%;
			}
			
			.expected-image {
				position: absolute;
				top: 10px;
				right: 10px;
				width: 150px;
				height: 150px;
				background: rgba(255,255,255,0.9);
				border-radius: 8px;
				border: 1px solid #ebeef2;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 4px 8px rgba(0,0,0,0.1);
				font-size: 0.8em;
				color: #777;
				overflow: hidden;
				opacity: 0.7;
				transition: all 0.3s;
			}
			
			.expected-image:hover {
				opacity: 1;
				width: 200px;
				height: 200px;
			}
			
			.expected-image img {
				max-width: 100%;
				max-height: 100%;
			}
			
			.result-message {
				margin-top: 15px;
				padding: 15px;
				border-radius: 8px;
				font-weight: bold;
				text-align: center;
				opacity: 0;
				transition: opacity 0.3s;
				display: none;
			}
			
			.result-message.show {
				opacity: 1;
				display: block;
			}
			
			.result-message.correct {
				background: #E8F5E9;
				color: #388E3C;
				border: 1px solid #C8E6C9;
			}
			
			.result-message.incorrect {
				background: #FFEBEE;
				color: #D32F2F;
				border: 1px solid #FFCDD2;
			}
			
			/* Bouton flottant pour terminer */
			.finish-btn {
				position: fixed;
				bottom: 30px;
				right: 30px;
				padding: 15px 25px;
				background: #4CAF50;
				color: white;
				border: none;
				border-radius: 50px;
				font-size: 1.1em;
				font-weight: bold;
				cursor: pointer;
				transition: all 0.3s;
				box-shadow: 0 4px 15px rgba(0,0,0,0.3);
				z-index: 1000;
			}
			
			.finish-btn:hover:not(:disabled) {
				background: #388E3C;
				transform: scale(1.05);
				box-shadow: 0 6px 20px rgba(0,0,0,0.4);
			}
			
			.finish-btn:disabled {
				background: #9E9E9E;
				opacity: 0.7;
				cursor: default;
				transform: none;
				box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			}
			
			/* Fenêtre modale */
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0,0,0,0.7);
				overflow: auto;
			}
			
			.modal-content {
				background-color: white;
				margin: 10% auto;
				padding: 30px;
				border-radius: 15px;
				max-width: 600px;
				animation: modalFade 0.3s ease;
			}
			
			@keyframes modalFade {
				from {transform: translateY(-50px); opacity: 0;}
				to {transform: translateY(0); opacity: 1;}
			}
			
			.close-modal {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
			
			.close-modal:hover {
				color: #333;
			}
			
			.final-score {
				font-size: 2em;
				margin: 30px 0;
				text-align: center;
			}
			
			/* Styles responsive */
			@media (max-width: 992px) {
				.main-content {
					flex-direction: column;
				}
				
				.challenges-list {
					width: 100%;
				}
				
				.turtle-content {
					flex-direction: column;
				}
				
				.expected-image {
					top: 5px;
					right: 5px;
					width: 100px;
					height: 100px;
				}
				
				.finish-btn {
					bottom: 20px;
					right: 20px;
					padding: 12px 20px;
					font-size: 1em;
				}
			}
			<style>
			/* Styles CodeMirror pour le template Turtle */
			.CodeMirror {
				height: 300px;
				border-radius: 8px;
				font-family: 'Menlo', Monaco, 'Courier New', monospace;
				border: 1px solid #ebeef2;
				box-shadow: 0 4px 8px rgba(0,0,0,0.05);
			}
			
			.CodeMirror-gutters {
				border-right: 1px solid #ebeef2;
				background-color: #f8f9fa;
				border-top-left-radius: 8px;
				border-bottom-left-radius: 8px;
			}
			
			.CodeMirror-linenumber {
				color: #999;
			}
			
			.cm-s-default .cm-keyword {
				color: #0033b3;
			}
			
			.cm-s-default .cm-comment {
				color: #8c8c8c;
			}
			
			.cm-s-default .cm-string {
				color: #067d17;
			}
			
			.cm-s-default .cm-number {
				color: #1750eb;
			}			
			</style>`

			},            
            
            
            
			periodic: {
				title: "Tableau Périodique Interactif",
				description: "Un template pour créer des exercices basés sur le tableau périodique des éléments. Les apprenants peuvent interagir avec le tableau et répondre à des questions sur les propriétés des éléments.",
				features: [
					"Tableau périodique interactif avec 5 périodes",
					"Questions sur les propriétés atomiques (Z, A, électrons, protons, neutrons)",
					"Calculs de masse molaire moléculaire",
					"Sélection d'éléments par clic",
					"Feedback détaillé et explications"
				],
				icon: "fas fa-atom",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Tableau Périodique Interactif</h3>
						<div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin-bottom: 15px;">
							<div style="background: #a5d8e6; padding: 5px; border-radius: 3px; text-align: center; font-weight: bold; font-size: 0.8rem;">H</div>
							<div style="background: #d3a5e6; padding: 5px; border-radius: 3px; text-align: center; font-weight: bold; font-size: 0.8rem;">He</div>
							<div style="background: #ff5733; padding: 5px; border-radius: 3px; text-align: center; font-weight: bold; font-size: 0.8rem;">Li</div>
							<!-- Quelques éléments de prévisualisation -->
						</div>
						<p style="margin-bottom: 15px;">Calculez la masse molaire de H₂O.</p>
						<div style="display: flex; gap: 10px; margin-bottom: 15px;">
							<input type="number" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Votre réponse g/mol">
							<button style="background: #ea6687; color: white; border: none; border-radius: 5px; padding: 0 15px; cursor: pointer;">Vérifier</button>
						</div>
						<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
							✅ Correct ! La masse molaire de H₂O est 18 g/mol (2×1 + 1×16)
						</div>
					</div>
				</div>
				`,
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE TABLEAU PERIODIQUE : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation du tableau périodique
				initPeriodicTable();
				
				// Initialisation des exercices
				initPeriodicExercises();
			});
			
			// Définition des éléments chimiques (périodes 1-5)
			const periodicElements = [
				// Période 1
				{ symbol: "H", name: "Hydrogène", Z: 1, A: 1, type: "nonmetal", group: 1, period: 1 },
				{ symbol: "He", name: "Hélium", Z: 2, A: 4, type: "noble-gas", group: 18, period: 1 },
				
				// Période 2
				{ symbol: "Li", name: "Lithium", Z: 3, A: 7, type: "alkali", group: 1, period: 2 },
				{ symbol: "Be", name: "Béryllium", Z: 4, A: 9, type: "alkaline-earth", group: 2, period: 2 },
				{ symbol: "B", name: "Bore", Z: 5, A: 11, type: "metalloid", group: 13, period: 2 },
				{ symbol: "C", name: "Carbone", Z: 6, A: 12, type: "nonmetal", group: 14, period: 2 },
				{ symbol: "N", name: "Azote", Z: 7, A: 14, type: "nonmetal", group: 15, period: 2 },
				{ symbol: "O", name: "Oxygène", Z: 8, A: 16, type: "nonmetal", group: 16, period: 2 },
				{ symbol: "F", name: "Fluor", Z: 9, A: 19, type: "nonmetal", group: 17, period: 2 },
				{ symbol: "Ne", name: "Néon", Z: 10, A: 20, type: "noble-gas", group: 18, period: 2 },
				
				// Période 3
				{ symbol: "Na", name: "Sodium", Z: 11, A: 23, type: "alkali", group: 1, period: 3 },
				{ symbol: "Mg", name: "Magnésium", Z: 12, A: 24, type: "alkaline-earth", group: 2, period: 3 },
				{ symbol: "Al", name: "Aluminium", Z: 13, A: 27, type: "post-transition", group: 13, period: 3 },
				{ symbol: "Si", name: "Silicium", Z: 14, A: 28, type: "metalloid", group: 14, period: 3 },
				{ symbol: "P", name: "Phosphore", Z: 15, A: 31, type: "nonmetal", group: 15, period: 3 },
				{ symbol: "S", name: "Soufre", Z: 16, A: 32, type: "nonmetal", group: 16, period: 3 },
				{ symbol: "Cl", name: "Chlore", Z: 17, A: 35, type: "nonmetal", group: 17, period: 3 },
				{ symbol: "Ar", name: "Argon", Z: 18, A: 40, type: "noble-gas", group: 18, period: 3 },
				
				// Période 4
				{ symbol: "K", name: "Potassium", Z: 19, A: 39, type: "alkali", group: 1, period: 4 },
				{ symbol: "Ca", name: "Calcium", Z: 20, A: 40, type: "alkaline-earth", group: 2, period: 4 },
				{ symbol: "Sc", name: "Scandium", Z: 21, A: 45, type: "transition", group: 3, period: 4 },
				{ symbol: "Ti", name: "Titane", Z: 22, A: 48, type: "transition", group: 4, period: 4 },
				{ symbol: "V", name: "Vanadium", Z: 23, A: 51, type: "transition", group: 5, period: 4 },
				{ symbol: "Cr", name: "Chrome", Z: 24, A: 52, type: "transition", group: 6, period: 4 },
				{ symbol: "Mn", name: "Manganèse", Z: 25, A: 55, type: "transition", group: 7, period: 4 },
				{ symbol: "Fe", name: "Fer", Z: 26, A: 56, type: "transition", group: 8, period: 4 },
				{ symbol: "Co", name: "Cobalt", Z: 27, A: 59, type: "transition", group: 9, period: 4 },
				{ symbol: "Ni", name: "Nickel", Z: 28, A: 59, type: "transition", group: 10, period: 4 },
				{ symbol: "Cu", name: "Cuivre", Z: 29, A: 64, type: "transition", group: 11, period: 4 },
				{ symbol: "Zn", name: "Zinc", Z: 30, A: 65, type: "transition", group: 12, period: 4 },
				{ symbol: "Ga", name: "Gallium", Z: 31, A: 70, type: "post-transition", group: 13, period: 4 },
				{ symbol: "Ge", name: "Germanium", Z: 32, A: 73, type: "metalloid", group: 14, period: 4 },
				{ symbol: "As", name: "Arsenic", Z: 33, A: 75, type: "metalloid", group: 15, period: 4 },
				{ symbol: "Se", name: "Sélénium", Z: 34, A: 79, type: "nonmetal", group: 16, period: 4 },
				{ symbol: "Br", name: "Brome", Z: 35, A: 80, type: "nonmetal", group: 17, period: 4 },
				{ symbol: "Kr", name: "Krypton", Z: 36, A: 84, type: "noble-gas", group: 18, period: 4 },
				
				// Période 5
				{ symbol: "Rb", name: "Rubidium", Z: 37, A: 85, type: "alkali", group: 1, period: 5 },
				{ symbol: "Sr", name: "Strontium", Z: 38, A: 88, type: "alkaline-earth", group: 2, period: 5 },
				{ symbol: "Y", name: "Yttrium", Z: 39, A: 89, type: "transition", group: 3, period: 5 },
				{ symbol: "Zr", name: "Zirconium", Z: 40, A: 91, type: "transition", group: 4, period: 5 },
				{ symbol: "Nb", name: "Niobium", Z: 41, A: 93, type: "transition", group: 5, period: 5 },
				{ symbol: "Mo", name: "Molybdène", Z: 42, A: 96, type: "transition", group: 6, period: 5 },
				{ symbol: "Tc", name: "Technétium", Z: 43, A: 98, type: "transition", group: 7, period: 5 },
				{ symbol: "Ru", name: "Ruthénium", Z: 44, A: 101, type: "transition", group: 8, period: 5 },
				{ symbol: "Rh", name: "Rhodium", Z: 45, A: 103, type: "transition", group: 9, period: 5 },
				{ symbol: "Pd", name: "Palladium", Z: 46, A: 106, type: "transition", group: 10, period: 5 },
				{ symbol: "Ag", name: "Argent", Z: 47, A: 108, type: "transition", group: 11, period: 5 },
				{ symbol: "Cd", name: "Cadmium", Z: 48, A: 112, type: "transition", group: 12, period: 5 },
				{ symbol: "In", name: "Indium", Z: 49, A: 115, type: "post-transition", group: 13, period: 5 },
				{ symbol: "Sn", name: "Étain", Z: 50, A: 119, type: "post-transition", group: 14, period: 5 },
				{ symbol: "Sb", name: "Antimoine", Z: 51, A: 122, type: "metalloid", group: 15, period: 5 },
				{ symbol: "Te", name: "Tellure", Z: 52, A: 128, type: "metalloid", group: 16, period: 5 },
				{ symbol: "I", name: "Iode", Z: 53, A: 127, type: "nonmetal", group: 17, period: 5 },
				{ symbol: "Xe", name: "Xénon", Z: 54, A: 131, type: "noble-gas", group: 18, period: 5 }
			];
			
			// Référence à l'élément sélectionné
			let selectedElementData = null;
			
			function initPeriodicTable() {
				const periodicTable = document.getElementById('periodicTable');
				
				// Vérifier si le tableau existe
				if (!periodicTable) return;
				
				// Effacer le tableau
				periodicTable.innerHTML = '';
				
				// Ajouter les éléments au tableau principal
				for (let period = 1; period <= 5; period++) {
					for (let group = 1; group <= 18; group++) {
						// Trouver l'élément correspondant
						const element = periodicElements.find(e => e.group === group && e.period === period);
						
						if (element) {
							const elementDiv = document.createElement('div');
							elementDiv.className = \`element \${element.type}\`;
							elementDiv.id = \`element-\${element.symbol}\`;
							elementDiv.innerHTML = \`
								<div class="atomic-number">\${element.Z}</div>
								<div class="symbol">\${element.symbol}</div>
								<div class="name">\${element.name}</div>
							\`;
							
							elementDiv.addEventListener('click', () => {
								updateSelectedElement(element);
								
								// Mettre à jour l'apparence active
								document.querySelectorAll('.element.active').forEach(el => {
									el.classList.remove('active');
								});
								elementDiv.classList.add('active');
							});
							
							periodicTable.appendChild(elementDiv);
						} else {
							// Créer un div vide pour maintenir la structure de la grille
							const emptyDiv = document.createElement('div');
							emptyDiv.className = 'empty';
							periodicTable.appendChild(emptyDiv);
						}
					}
				}
				
				// Sélectionner l'hydrogène par défaut
				const hydrogenElement = document.getElementById('element-H');
				if (hydrogenElement) {
					hydrogenElement.classList.add('active');
					selectedElementData = periodicElements[0];
					updateSelectedElement(periodicElements[0]);
				}
			}
			
			function updateSelectedElement(element) {
				// Mettre à jour les informations de l'élément
				const elementName = document.getElementById('elementName');
				const elementDetails = document.getElementById('elementDetails');
				
				if (elementName && elementDetails) {
					elementName.textContent = element.name;
					
					elementDetails.innerHTML = \`
						<div class="element-detail">Symbole: \${element.symbol}</div>
						<div class="element-detail">Numéro atomique (Z): \${element.Z}</div>
						<div class="element-detail">Masse atomique (A): \${element.A}</div>
						<div class="element-detail">Électrons: \${element.Z}</div>
						<div class="element-detail">Protons: \${element.Z}</div>
						<div class="element-detail">Neutrons: \${element.A - element.Z}</div>
						<div class="element-detail">Type: \${getTypeName(element.type)}</div>
					\`;
					
					selectedElementData = element;
				}
			}
			
			// Fonction pour obtenir le nom du type en français
			function getTypeName(type) {
				const typeMap = {
					'alkali': 'Métal alcalin',
					'alkaline-earth': 'Métal alcalino-terreux',
					'transition': 'Métal de transition',
					'post-transition': 'Métal pauvre',
					'metalloid': 'Métalloïde',
					'nonmetal': 'Non-métal',
					'noble-gas': 'Gaz noble'
				};
				
				return typeMap[type] || type;
			}
			
			function initPeriodicExercises() {
				// Initialiser tous les exercices liés au tableau périodique
				document.querySelectorAll('.exercise-card[data-type="periodic"]').forEach(exercise => {
					const exerciseId = exercise.getAttribute('data-exercise');
					const exerciseType = exercise.getAttribute('data-exercise-type');
					
					// Configurer les boutons de vérification
					const checkBtn = exercise.querySelector('.check-btn');
					if (checkBtn) {
						checkBtn.addEventListener('click', () => {
							checkPeriodicAnswer(exerciseId, exerciseType);
						});
					}
					
					// Configurer les champs de réponse pour validation à l'appui sur Entrée
					const answerInput = exercise.querySelector('.answer-input');
					if (answerInput) {
						answerInput.addEventListener('keypress', (e) => {
							if (e.key === 'Enter') {
								checkPeriodicAnswer(exerciseId, exerciseType);
							}
						});
					}
				});
			}
			
			// Fonction pour vérifier les réponses aux exercices du tableau périodique
			function checkPeriodicAnswer(exerciseId, exerciseType) {
				const exercise = document.querySelector(\`.exercise-card[data-exercise="\${exerciseId}"]\`);
				const resultDiv = document.getElementById(\`result\${exerciseId}\`);
				
				if (!exercise || !resultDiv) return;
				
				let isCorrect = false;
				let explanation = '';
				
				switch (exerciseType) {
					case 'property':
						// Vérification des propriétés atomiques
						const propertyType = exercise.getAttribute('data-property');
						const elementSymbol = exercise.getAttribute('data-element');
						const answerInput = exercise.querySelector('.answer-input');
						const userAnswer = parseFloat(answerInput.value.replace(',', '.'));
						
						const element = periodicElements.find(e => e.symbol === elementSymbol);
						if (!element) return;
						
						let correctAnswer;
						
						switch (propertyType) {
							case 'Z':
								correctAnswer = element.Z;
								explanation = \`Le numéro atomique (Z) de \${element.name} est \${element.Z}.\`;
								break;
							case 'A':
								correctAnswer = element.A;
								explanation = \`La masse atomique (A) de \${element.name} est \${element.A}.\`;
								break;
							case 'electrons':
								correctAnswer = element.Z;
								explanation = \`Le nombre d'électrons de \${element.name} est égal à Z, soit \${element.Z}.\`;
								break;
							case 'protons':
								correctAnswer = element.Z;
								explanation = \`Le nombre de protons de \${element.name} est égal à Z, soit \${element.Z}.\`;
								break;
							case 'neutrons':
								correctAnswer = element.A - element.Z;
								explanation = \`Le nombre de neutrons de \${element.name} est A - Z, soit \${element.A} - \${element.Z} = \${element.A - element.Z}.\`;
								break;
						}
						
						isCorrect = Math.abs(userAnswer - correctAnswer) < 0.01;
						break;
						
					case 'molecule':
						// Calcul de masse molaire moléculaire
						const moleculeFormula = exercise.getAttribute('data-formula');
						const molMassInput = exercise.querySelector('.answer-input');
						const userMolMass = parseFloat(molMassInput.value.replace(',', '.'));
						
						// Calculer la masse molaire correcte
						const correctMolMass = calculateMolecularMass(moleculeFormula);
						
						// Tolérance de 1% pour les arrondis
						const tolerance = Math.abs(correctMolMass) * 0.01;
						isCorrect = Math.abs(userMolMass - correctMolMass) <= tolerance;
						
						explanation = \`La masse molaire de \${moleculeFormula} est \${correctMolMass.toFixed(2)} g/mol.\`;
						break;
						
					case 'identification':
						// Identification d'élément par propriétés
						const selectedElement = exercise.querySelector('input[name="element-choice"]:checked');
						if (!selectedElement) {
							resultDiv.innerHTML = 'Veuillez sélectionner un élément.';
							resultDiv.className = 'result incomplete';
							resultDiv.style.display = 'block';
							return;
						}
						
						const userChoice = selectedElement.value;
						const correctElement = exercise.getAttribute('data-correct');
						
						isCorrect = userChoice === correctElement;
						explanation = \`L'élément correct est \${periodicElements.find(e => e.symbol === correctElement).name} (\${correctElement}).\`;
						break;
				}
				
				if (isCorrect) {
					resultDiv.innerHTML = \`<span class="success-icon">✓</span> Correct! \${explanation}\`;
					resultDiv.className = 'result correct';
					
					// Mettre à jour le score
					incrementScore();
					markAsSolved(exerciseId);
				} else {
					resultDiv.innerHTML = \`<span class="error-icon">✗</span> Incorrect. \${explanation}\`;
					resultDiv.className = 'result incorrect';
				}
				
				resultDiv.style.display = 'block';
				
				// Vérifier si tous les exercices sont complétés
				checkAllCompleted();
			}
			
			// Fonction pour calculer la masse molaire d'une molécule
			function calculateMolecularMass(formula) {
				// Analyser la formule chimique
				const elementCounts = parseChemicalFormula(formula);
				
				// Calculer la masse molaire
				let totalMass = 0;
				
				for (const symbol in elementCounts) {
					const element = periodicElements.find(e => e.symbol === symbol);
					if (element) {
						totalMass += element.A * elementCounts[symbol];
					}
				}
				
				return totalMass;
			}
			
			// Fonction pour analyser une formule chimique et retourner un objet avec les comptes d'éléments
			function parseChemicalFormula(formula) {
				const elementCounts = {};
				
				// Regex pour identifier les éléments et leurs nombres
				const regex = /([A-Z][a-z]*)([0-9]*)/g;
				let match;
				
				while ((match = regex.exec(formula)) !== null) {
					const symbol = match[1];
					const count = match[2] ? parseInt(match[2]) : 1;
					
					if (elementCounts[symbol]) {
						elementCounts[symbol] += count;
					} else {
						elementCounts[symbol] = count;
					}
				}
				
				return elementCounts;
			}
			`,
				
				code: `<div class="exercise-card" data-exercise="1" data-type="periodic" data-exercise-type="property" data-property="Z" data-element="O">
					<div class="question-header">
						<span class="question-icon">⚛️</span>
						<span>Question 1: Quel est le numéro atomique (Z) de l'Oxygène?</span>
					</div>
					
					<div class="input-group">
						<label>Votre réponse:</label>
						<input type="number" class="answer-input" id="answer1" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkPeriodicAnswer('1', 'property')">Vérifier</button>
					</div>
					
					<div class="result" id="result1"></div>
					<div class="hint" id="hint1">💡 Consultez le tableau périodique et trouvez l'oxygène (O). Le numéro atomique est indiqué en haut à gauche de la case.</div>
				</div>
				
				<div class="exercise-card" data-exercise="2" data-type="periodic" data-exercise-type="molecule" data-formula="H2O">
					<div class="question-header">
						<span class="question-icon">⚛️</span>
						<span>Question 2: Calculez la masse molaire de l'eau (H₂O) en g/mol.</span>
					</div>
					
					<div class="question-text">
						Utilisez les masses atomiques du tableau périodique: H (1 g/mol) et O (16 g/mol).
					</div>
					
					<div class="input-group">
						<label>Votre réponse (g/mol):</label>
						<input type="number" class="answer-input" id="answer2" placeholder="Entrez votre réponse">
						<button class="check-btn" onclick="checkPeriodicAnswer('2', 'molecule')">Vérifier</button>
					</div>
					
					<div class="result" id="result2"></div>
					<div class="hint" id="hint2">💡 Pour H₂O, calculez 2 × masse(H) + 1 × masse(O).</div>
				</div>`			
			},            
            

            
            
            sequence: {
                title: "Séquençage par Glisser-Déposer",
                description: "Un template pour créer des exercices de mise en ordre. L'apprenant doit ordonner des éléments dans la séquence correcte par glisser-déposer.",
                features: [
                    "Interface glisser-déposer intuitive",
                    "Vérification automatique de l'ordre correct",
                    "Réinitialisation des exercices",
                    "Feedback visuel",
                    "Indices disponibles"
                ],
                icon: "fas fa-arrow-down-1-9",
                previewHtml: `
                <div class="preview-card">
                    <div class="preview-header">
                        <span>Séquençage par Glisser-Déposer</span>
                        <div class="preview-icon">🔄</div>
                    </div>
                    <div class="preview-body">
                        <div class="preview-description">
                            Organisez les étapes dans le bon ordre en utilisant le glisser-déposer.
                        </div>
                        
                        <div class="sequence-container">
                            <div class="sequence-items">
                                <div class="sequence-item">Étape 4</div>
                                <div class="sequence-item">Étape 1</div>
                                <div class="sequence-item">Étape 2</div>
                                <div class="sequence-item">Étape 3</div>
                            </div>
                            
                            <div class="sequence-dropzones">
                                <div class="dropzone">
                                    <div class="dropzone-number">1</div>
                                    <div class="dropzone-placeholder">Déposez l'étape 1 ici</div>
                                </div>
                                <div class="dropzone">
                                    <div class="dropzone-number">2</div>
                                    <div class="dropzone-placeholder">Déposez l'étape 2 ici</div>
                                </div>
                                <div class="dropzone">
                                    <div class="dropzone-number">3</div>
                                    <div class="dropzone-content">Étape 3</div>
                                </div>
                                <div class="dropzone">
                                    <div class="dropzone-number">4</div>
                                    <div class="dropzone-placeholder">Déposez l'étape 4 ici</div>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="preview-btn preview-btn-primary">Vérifier ma solution</button>
                                <button class="preview-btn preview-btn-secondary">Réinitialiser</button>
                            </div>
                            
                            <div class="hint-box">
                                <span class="hint-icon">💡</span>
                                <span>Indice : L'étape 1 est toujours le début du processus.</span>
                            </div>
                        </div>
                    </div>
                </div>
                `,
                
                jsCode: `// // ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE SEQUENCAGE : PRIORITE OBLIGATOIRE SI CHOISIE
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation globale
    initSequence();
    startTimeTracking();
    
    // Surveiller les changements de visibilité de la page
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Sauvegarde avant déchargement
    window.addEventListener('beforeunload', () => {
        if (!allExercisesCompleted) {
            // Sauvegarder l'état actuel
            saveState();
            setValue("cmi.exit", "suspend");
        }
        
        terminateSCORM();
    });
});

/* -------- VARIABLES GLOBALES -------- */
let score = 0;
let solved = new Set();
let allExercisesCompleted = false;
    
    // Initialiser le drag & drop
    const blocks = document.querySelectorAll('.block');
    blocks.forEach(block => {
        block.addEventListener('dragstart', dragStart);
        block.addEventListener('dragend', dragEnd);
        
        // Ajouter un bouton de suppression à chaque bloc dans les blocs-container
        if (block.parentElement.classList.contains('blocks-container')) {
            addDeleteButton(block);
        }
    });
    
    // Obtenir toutes les zones de dépôt
    const dropZones = document.querySelectorAll('.drop-zone');
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', dragOver);
        zone.addEventListener('dragenter', dragEnter);
        zone.addEventListener('dragleave', dragLeave);
        zone.addEventListener('drop', drop);
    });
    
    // Initialiser le bouton terminer
    document.getElementById('finishActivityBtn').addEventListener('click', finishActivity);
    
    // Initialiser le bouton plein écran
    document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
}

/* -------- FONCTIONS DRAG & DROP -------- */
function dragStart(e) {
    // Ne pas démarrer le drag si on a cliqué sur la croix de suppression
    if (e.target.classList.contains('delete-btn')) {
        return;
    }
    
    e.dataTransfer.setData('text/plain', e.target.id);
    e.dataTransfer.setData('application/json', JSON.stringify({
        parentId: e.target.parentElement.id,
        html: e.target.outerHTML,
        order: e.target.dataset.order
    }));
    
    setTimeout(() => {
        e.target.classList.add('dragging');
    }, 0);
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function dragOver(e) {
    e.preventDefault();
}

function dragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

function dragLeave(e) {
    e.target.classList.remove('drag-over');
}

function drop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    
    // Si la zone de dépôt contient déjà un bloc, ne rien faire
    if (e.target.classList.contains('filled') || e.target.tagName !== 'DIV') {
        return;
    }
    
    const data = JSON.parse(e.dataTransfer.getData('application/json'));
    const blockElement = document.createElement('div');
    blockElement.innerHTML = data.html;
    const block = blockElement.firstChild;
    
    // Supprimer le bloc de son conteneur d'origine s'il existe
    const sourceContainer = document.getElementById(data.parentId);
    const sourceBlocks = sourceContainer.querySelectorAll('.block');
    sourceBlocks.forEach(b => {
        if (b.dataset.order === block.dataset.order) {
            b.remove();
        }
    });
    
    // Ajouter le bloc à la zone de dépôt
    e.target.innerHTML = '';
    e.target.appendChild(block);
    e.target.classList.add('filled');
    
    // Ajouter la croix de suppression au bloc
    addDeleteButton(block);
    
    // Réinitialiser les événements sur le bloc
    block.addEventListener('dragstart', dragStart);
    block.addEventListener('dragend', dragEnd);
}

function addDeleteButton(block) {
    // Vérifier si le bloc a déjà un bouton de suppression
    if (block.querySelector('.delete-btn')) {
        return;
    }
    
    const deleteBtn = document.createElement('div');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '×';
    deleteBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const parentZone = block.parentElement;
        
        // Récupérer l'ID de l'exercice
        const exerciseNum = parentZone.id.replace('solution', '');
        const blocksContainer = document.getElementById(\`blocks\${exerciseNum}\`);
        
        // Remettre le bloc dans son conteneur d'origine
        blocksContainer.appendChild(block);
        
        // Réinitialiser la zone de dépôt
        parentZone.classList.remove('filled');
        parentZone.textContent = \`Déposez l'étape \${parseInt(parentZone.dataset.position) + 1} ici\`;
        
        // Supprimer le bouton de suppression avant de remettre le bloc dans son conteneur
        block.querySelector('.delete-btn').remove();
    });
    
    block.appendChild(deleteBtn);
}

/* -------- FONCTIONS DE VÉRIFICATION ET RESET -------- */
function checkSolution(exerciseNum) {
    const solutionArea = document.getElementById(\`solution\${exerciseNum}\`);
    const dropZones = solutionArea.querySelectorAll('.drop-zone');
    const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
    const hintDiv = document.getElementById(\`hint\${exerciseNum}\`);
    
    let isCorrect = true;
    let allFilled = true;
    
    dropZones.forEach(zone => {
        if (!zone.classList.contains('filled')) {
            allFilled = false;
            return;
        }
        
        const block = zone.querySelector('.block');
        if (!block || parseInt(block.dataset.order) !== parseInt(zone.dataset.position)) {
            isCorrect = false;
        }
    });
    
    if (!allFilled) {
        resultDiv.textContent = "⚠️ Placez tous les blocs avant de vérifier";
        resultDiv.className = "result incorrect show";
        return;
    }
    
    if (isCorrect) {
        resultDiv.textContent = "✅ Correct ! L'ordre des étapes est bon !";
        resultDiv.className = "result correct show";
        hintDiv.style.display = "none";
        
        if (!solved.has(exerciseNum)) {
            solved.add(exerciseNum);
            score++;
            document.getElementById('score').textContent = score;
            
            // SCORM: Enregistrer l'interaction pour cet exercice
            recordInteraction(exerciseNum, true);
            
            // SCORM: Sauvegarder l'état et le score
            saveState();
            
            // Vérifier si tous les exercices sont complétés
            checkAllCompleted();
        }
        
        // Désactiver les blocs et les boutons
        const blocks = document.querySelectorAll(\`#solution\${exerciseNum} .block\`);
        blocks.forEach(block => {
            block.draggable = false;
            block.style.cursor = "default";
            block.style.borderColor = "#28a745";
        });
        
        document.querySelector(\`[data-exercise="\${exerciseNum}"] .check-btn\`).disabled = true;
    } else {
        resultDiv.textContent = "❌ Incorrect. L'ordre des étapes n'est pas bon.";
        resultDiv.className = "result incorrect show";
        hintDiv.style.display = "block";
        
        // SCORM: Enregistrer l'interaction incorrecte
        recordInteraction(exerciseNum, false);
    }
}

function resetExercise(exerciseNum) {
    // Récupérer tous les blocs dans la zone de solution
    const solutionArea = document.getElementById(\`solution\${exerciseNum}\`);
    const dropZones = solutionArea.querySelectorAll('.drop-zone');
    const blocksContainer = document.getElementById(\`blocks\${exerciseNum}\`);
    const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
    
    // Réinitialiser le résultat
    resultDiv.className = "result";
    
    // Remettre les blocs dans leur conteneur d'origine
    dropZones.forEach(zone => {
        const block = zone.querySelector('.block');
        if (block) {
            blocksContainer.appendChild(block);
            zone.classList.remove('filled');
            zone.textContent = \`Déposez l'étape \${parseInt(zone.dataset.position) + 1} ici\`;
        }
    });
}

function checkAllCompleted() {
    const totalExercises = document.querySelectorAll('.exercise-card').length;
    if (solved.size === totalExercises) {
        allExercisesCompleted = true;
        
        // Afficher un message de complétion
        alert("Félicitations ! Vous avez complété tous les exercices.");
        
        // SCORM: Marquer comme complété
        setValue("cmi.completion_status", "completed");
        setValue("cmi.success_status", score >= (totalExercises * 0.7) ? "passed" : "failed");
        commitSCORM();
    }
}

/* -------- FONCTIONS UTILITAIRES -------- */
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            alert(\`Erreur lors du passage en plein écran : \${err.message}\`);
        });
        document.querySelector('.fullscreen-icon').textContent = '⛝';
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
            document.querySelector('.fullscreen-icon').textContent = '⛶';
        }
    }
}

function finishActivity() {
    const totalExercises = document.querySelectorAll('.exercise-card').length;
    const completedCount = solved.size;
    
    if (completedCount < totalExercises) {
        const confirmation = confirm(\`Vous n'avez complété que \${completedCount} exercices sur \${totalExercises}. Êtes-vous sûr de vouloir terminer l'activité ?\`);
        if (!confirmation) return;
    }
    
    // Marquer comme terminé
    allExercisesCompleted = true;
    
    // SCORM: Définir l'état final
    setValue("cmi.completion_status", "completed");
    setValue("cmi.success_status", score >= (totalExercises * 0.7) ? "passed" : "failed");
    setValue("cmi.exit", "normal");
    
    // SCORM: Enregistrer le score final
    saveScore();
    
    // SCORM: Sauvegarder l'état final
    saveState();
    
    // SCORM: Terminer la session
    commitSCORM();
    
    // Afficher un résumé
    alert(\`Activité terminée!\\nScore final: \${score}/\${totalExercises}\\n\${score >= (totalExercises * 0.7) ? "Réussite" : "Échec"}\`);
    
    // Désactiver tous les contrôles
    document.querySelectorAll('.check-btn, .reset-btn').forEach(btn => {
        btn.disabled = true;
    });
    
    document.querySelectorAll('.block').forEach(block => {
        block.draggable = false;
        block.style.cursor = "default";
    });
    
    document.getElementById('finishActivityBtn').disabled = true;
}

function handleVisibilityChange() {
    if (document.visibilityState === 'hidden') {
        // L'utilisateur quitte la page ou la met en arrière-plan
        saveState();
        setValue("cmi.exit", "suspend");
        commitSCORM();
    }
}


// Sauvegarder l'état
function saveState() {
    if (!initialized) return;
    
    // Créer un objet avec toutes les données à sauvegarder
    const stateData = {
        score: score,
        solved: Array.from(solved),
        allExercisesCompleted: allExercisesCompleted
    };
    
    // Convertir en JSON
    suspendData = JSON.stringify(stateData);
    
    // Sauvegarder dans SCORM
    setValue("cmi.suspend_data", suspendData);
    
    // Sauvegarder le score actuel
    saveScore();
    
    // Sauvegarder l'état de progression
    saveProgress();
    
    // Commit immédiat pour assurer la persistance des données
    commitSCORM();
    
    console.log("État sauvegardé avec succès");
}

// Restaurer l'état précédent
function restoreState(jsonString) {
    if (!jsonString) return;
    
    try {
        const data = JSON.parse(jsonString);
        
        // Restaurer le score
        score = data.score || 0;
        document.getElementById('score').textContent = score;
        
        // Restaurer les exercices résolus
        solved = new Set(data.solved || []);
        
        // Restaurer l'état de complétion
        allExercisesCompleted = data.allExercisesCompleted || false;
        
        // Mettre à jour l'interface
        updateUIFromState();
        
        console.log("État restauré avec succès");
    } catch (e) {
        console.error("Erreur lors de la restauration de l'état:", e);
    }
}

// Mettre à jour l'interface à partir de l'état restauré
function updateUIFromState() {
    // Mettre à jour l'affichage des exercices résolus
    solved.forEach(exerciseNum => {
        const solutionArea = document.getElementById(\`solution\${exerciseNum}\`);
        if (!solutionArea) return;
        
        // Désactiver les contrôles pour cet exercice
        const exerciseCard = document.querySelector(\`[data-exercise="\${exerciseNum}"]\`);
        if (exerciseCard) {
            const checkBtn = exerciseCard.querySelector('.check-btn');
            if (checkBtn) checkBtn.disabled = true;
            
            // Afficher le résultat correct
            const resultDiv = document.getElementById(\`result\${exerciseNum}\`);
            if (resultDiv) {
                resultDiv.textContent = "✅ Correct ! L'ordre des étapes est bon !";
                resultDiv.className = "result correct show";
            }
            
            // Cacher l'indice
            const hintDiv = document.getElementById(\`hint\${exerciseNum}\`);
            if (hintDiv) hintDiv.style.display = "none";
        }
    });
    
    // Si tous les exercices sont complétés, désactiver les contrôles
    if (allExercisesCompleted) {
        document.querySelectorAll('.check-btn, .reset-btn').forEach(btn => {
            btn.disabled = true;
        });
        
        document.querySelectorAll('.block').forEach(block => {
            block.draggable = false;
            block.style.cursor = "default";
        });
        
        document.getElementById('finishActivityBtn').disabled = true;
    }
}
            }`,
                
                code: `<div class="exercise-card" data-exercise="1">
    <div class="question-header">
        <span class="question-icon">📝</span>
        <span>Question 1: Ordonnez les planètes depuis le soleil</span>
    </div>
    
    <div class="blocks-container" id="blocks1">
        <div class="block" draggable="true" data-order="3">Mars</div>
        <div class="block" draggable="true" data-order="0">Mercure</div>
        <div class="block" draggable="true" data-order="1">Vénus</div>
        <div class="block" draggable="true" data-order="2">Terre</div>
    </div>
    
    <div class="solution-area" id="solution1">
        <div class="drop-zone" data-position="0">Déposez la 1ère planète ici</div>
        <div class="drop-zone" data-position="1">Déposez la 2ème planète ici</div>
        <div class="drop-zone" data-position="2">Déposez la 3ème planète ici</div>
        <div class="drop-zone" data-position="3">Déposez la 4ème planète ici</div>
    </div>
    
    <button class="check-btn" onclick="checkSolution(1)">Vérifier ma solution</button>
    <button class="reset-btn" onclick="resetExercise(1)">Réinitialiser</button>
    <div class="result" id="result1"></div>
    <div class="hint" id="hint1">💡 Mercure est la planète la plus proche du soleil.</div>
</div>`
            },
            
            
            
            
            
            
            
            
            category: {
                title: "Catégorisation par Glisser-Déposer",
                description: "Un template pour créer des exercices de catégorisation. L'apprenant doit classer des éléments dans les catégories appropriées par glisser-déposer.",
                features: [
                    "Plusieurs catégories configurables",
                    "Interface glisser-déposer intuitive",
                    "Vérification automatique des catégories",
                    "Réinitialisation des exercices",
                    "Feedback visuel"
                ],
                icon: "fas fa-sitemap",
                previewHtml: `
                <div class="preview-card">
                    <div class="preview-header">
                        <span>Catégorisation par Glisser-Déposer</span>
                        <div class="preview-icon">📋</div>
                    </div>
                    <div class="preview-body">
                        <div class="preview-description">
                            Classez les éléments dans leurs catégories respectives en utilisant le glisser-déposer.
                        </div>
                        
                        <div class="category-container">
                            <div class="category-items">
                                <div class="category-item">Lion</div>
                                <div class="category-item">Aigle</div>
                                <div class="category-item">Truite</div>
                                <div class="category-item">Dauphin</div>
                                <div class="category-item">Tigre</div>
                                <div class="category-item">Perroquet</div>
                            </div>
                            
                            <div class="categories">
                                <div class="category">
                                    <div class="category-title">Mammifères</div>
                                    <div class="category-content">
                                        <div class="category-item">Lion</div>
                                        <div class="category-item">Tigre</div>
                                    </div>
                                </div>
                                <div class="category">
                                    <div class="category-title">Oiseaux</div>
                                    <div class="category-content">
                                        <div class="category-item">Aigle</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="preview-btn preview-btn-primary">Vérifier ma solution</button>
                                <button class="preview-btn preview-btn-secondary">Réinitialiser</button>
                            </div>
                            
                            <div class="result-box success">
                                <span class="result-icon">✓</span>
                                <span>Correct ! Les éléments sont bien classés dans leurs catégories.</span>
                            </div>
                        </div>
                    </div>
                </div>
                `,
                
                jsCode: `// // ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE CATEGORISATION : PRIORITE OBLIGATOIRE SI CHOISIE
            document.addEventListener('DOMContentLoaded', function() {
                // Initialisation de la catégorisation
                initCategories();
            });
            
            function initCategories() {
                // Initialiser le drag and drop pour tous les exercices
                document.querySelectorAll('.exercise-card').forEach(exercise => {
                    const exerciseId = exercise.getAttribute('data-exercise');
                    const items = exercise.querySelectorAll('.item');
                    const categories = exercise.querySelectorAll('.category-items');
                    
                    // Mélanger les items au début
                    shuffleItems(exerciseId);
                    
                    // Configurer les événements de drag and drop
                    items.forEach(item => {
                        item.addEventListener('dragstart', handleDragStart);
                        item.addEventListener('dragend', handleDragEnd);
                    });
                    
                    categories.forEach(category => {
                        category.addEventListener('dragover', handleDragOver);
                        category.addEventListener('dragenter', handleDragEnter);
                        category.addEventListener('dragleave', handleDragLeave);
                        category.addEventListener('drop', handleDrop);
                    });
                });
            }
            
            function shuffleItems(exerciseId) {
                const itemsContainer = document.getElementById('items' + exerciseId);
                const items = Array.from(itemsContainer.children);
                
                // Mélanger les items
                for (let i = items.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    itemsContainer.appendChild(items[j]);
                }
            }

            
             // Ajouter un bouton de suppression à chaque item
                if (item.parentElement.classList.contains('items-container')) {
                    addDeleteButton(item);
                }

            
            // Ajouter l'item à la zone de catégorie
            targetElement.appendChild(item);
            
            // Ajouter la croix de suppression à l'item
            addDeleteButton(item);
            
            // Réinitialiser les événements sur l'item
            item.addEventListener('dragstart', dragStart);
            item.addEventListener('dragend', dragEnd);
        }
        
        function addDeleteButton(item) {
            // Vérifier si l'item a déjà un bouton de suppression
            if (item.querySelector('.delete-btn')) {
                return;
            }
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Récupérer l'ID de l'exercice
                const exerciseElement = item.closest('.exercise-card');
                const exerciseNum = exerciseElement.dataset.exercise;
                
                // Remettre l'item dans son conteneur d'origine
                itemsContainer.appendChild(item);
                
                // Supprimer le bouton de suppression avant de remettre l'item dans son conteneur
                item.querySelector('.delete-btn').remove();
            });
            
            item.appendChild(deleteBtn);
        }
            
            // Gestionnaires d'événements pour le drag and drop
            function handleDragStart(e) {
                this.classList.add('dragging');
                e.dataTransfer.setData('text/plain', this.outerHTML);
                e.dataTransfer.setData('application/json', JSON.stringify({
                    category: this.getAttribute('data-category'),
                    id: this.getAttribute('id')
                }));
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleDragEnd(e) {
                this.classList.remove('dragging');
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
            
            function handleDragEnter(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                // Récupérer l'item déplacé
                const itemHTML = e.dataTransfer.getData('text/plain');
                const itemData = JSON.parse(e.dataTransfer.getData('application/json'));
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = itemHTML;
                const item = tempDiv.firstChild;
                
                // Ajouter l'item à la catégorie
                this.appendChild(item);
                
                // Supprimer l'item original
                const draggingElement = document.querySelector('.dragging');
                if (draggingElement) {
                    draggingElement.remove();
                }
                
                // Reconfigurer les événements de drag and drop pour l'item déplacé
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            }
                        
            
            function checkCategories(exerciseId) {
                const categoriesArea = document.getElementById('categories' + exerciseId);
                const categories = categoriesArea.querySelectorAll('.category');
                let allCorrect = true;
                let allCategorized = true;
                
                // Vérifier que tous les items ont été placés dans des catégories
                const itemsContainer = document.getElementById('items' + exerciseId);
                if (itemsContainer.children.length > 0) {
                    allCategorized = false;
                }
                
                if (!allCategorized) {
                    const resultDiv = document.getElementById('result' + exerciseId);
                    resultDiv.innerHTML = 'Veuillez placer tous les éléments dans leurs catégories.';
                    resultDiv.className = 'result incomplete';
                    resultDiv.style.display = 'block';
                    return;
                }
                
                // Vérifier que tous les items sont dans la bonne catégorie
                categories.forEach(category => {
                    const categoryName = category.getAttribute('data-category');
                    const items = category.querySelectorAll('.item');
                    
                    items.forEach(item => {
                        const itemCategory = item.getAttribute('data-category');
                        if (itemCategory !== categoryName) {
                            allCorrect = false;
                        }
                    });
                });
                
                // Afficher le résultat
                const resultDiv = document.getElementById('result' + exerciseId);
                if (allCorrect) {
                    resultDiv.innerHTML = '<span class="success-icon">✓</span> Correct! Tous les éléments sont bien classés.';
                    resultDiv.className = 'result correct';
                    incrementScore();
                    markAsSolved(exerciseId);
                } else {
                    resultDiv.innerHTML = '<span class="error-icon">✗</span> Incorrect. Vérifiez le classement et réessayez.';
                    resultDiv.className = 'result incorrect';
                }
                resultDiv.style.display = 'block';
                
                // Vérifier si tous les exercices sont complétés
                checkAllCompleted();
            }
            
            function resetCategories(exerciseId) {
                // Récupérer tous les items dans les catégories
                const categoriesArea = document.getElementById('categories' + exerciseId);
                const items = categoriesArea.querySelectorAll('.item');
                const itemsContainer = document.getElementById('items' + exerciseId);
                
                // Remettre tous les items dans le conteneur d'origine
                items.forEach(item => {
                    itemsContainer.appendChild(item);
                });
                
                // Mélanger les items
                shuffleItems(exerciseId);
                
                // Cacher le message de résultat
                const resultDiv = document.getElementById('result' + exerciseId);
                resultDiv.style.display = 'none';
            }`,

                code: `<div class="exercise-card" data-exercise="1">
    <div class="question-header">
        <span class="question-icon">📝</span>
        <span>Question 1: Classez les animaux</span>
    </div>
    
    <div class="items-container" id="items1">
        <div class="item" draggable="true" data-category="mammiferes">Lion</div>
        <div class="item" draggable="true" data-category="mammiferes">Chat</div>
        <div class="item" draggable="true" data-category="oiseaux">Aigle</div>
        <div class="item" draggable="true" data-category="oiseaux">Perroquet</div>
    </div>
    
    <div class="categories-area" id="categories1">
        <div class="category" data-category="mammiferes">
            <div class="category-title">Mammifères</div>
            <div class="category-items"></div>
        </div>
        <div class="category" data-category="oiseaux">
            <div class="category-title">Oiseaux</div>
            <div class="category-items"></div>
        </div>
    </div>
    
    <button class="check-btn" onclick="checkSolution(1)">Vérifier ma solution</button>
    <button class="reset-btn" onclick="resetExercise(1)">Réinitialiser</button>
    <div class="result" id="result1"></div>
    <div class="hint" id="hint1">💡 Les mammifères allaitent leurs petits.</div>
</div>`
            },
            
			// Ajouter cette définition de template dans l'objet templatesDetails
			"statistics": {
				title: "Visualisations Statistiques",
				description: "Un template pour créer des applications avec des visualisations graphiques statistiques. Les apprenants peuvent explorer différents types de graphiques et comprendre l'analyse de données.",
				features: [
					"Six types de graphiques différents: histogramme, radar, boîte à moustaches, etc.",
					"Visualisation interactive des données",
					"Personnalisation des couleurs et étiquettes",
					"Analyse comparative de données",
					"Interface responsive adaptée à tous les écrans"
				],
				icon: "fas fa-chart-bar",
				previewHtml: `
				<div class="preview-card">
					<div class="preview-header">
						<span>Visualisations Statistiques</span>
						<div class="preview-icon">📊</div>
					</div>
					<div class="preview-body">
						<div class="preview-description">
							Explorez et interprétez les données à travers des visualisations graphiques interactives.
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<!-- Aperçu d'histogramme -->
							<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
								<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Histogramme</div>
								<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: flex-end; justify-content: space-around; padding: 5px; position: relative;">
									<div style="width: 12%; height: 60%; background: #3498db; border-radius: 3px 3px 0 0;"></div>
									<div style="width: 12%; height: 95%; background: #3498db; border-radius: 3px 3px 0 0;"></div>
									<div style="width: 12%; height: 15%; background: #3498db; border-radius: 3px 3px 0 0;"></div>
									<div style="width: 12%; height: 25%; background: #3498db; border-radius: 3px 3px 0 0;"></div>
									<div style="width: 12%; height: 10%; background: #3498db; border-radius: 3px 3px 0 0;"></div>
									<div style="width: 12%; height: 40%; background: #3498db; border-radius: 3px 3px 0 0;"></div>
								</div>
							</div>
							
							<!-- Aperçu de diagramme circulaire -->
							<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
								<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Diagramme Circulaire</div>
								<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
									<div style="width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(#e74c3c 0% 35%, #f1c40f 35% 60%, #e67e22 60% 75%, #2ecc71 75% 100%);"></div>
								</div>
							</div>
						</div>
						
						<div class="button-group">
							<button class="preview-btn preview-btn-primary">Explorer les graphiques</button>
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// CODE JAVASCRIPT SPÉCIFIQUE AU TEMPLATE STATISTIQUES : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation des graphiques statistiques
				initializeGraphs();
			});
			
			// Variable globale pour l'espacement autour des graphiques
			const padding = 40;
			
			/**
			 * Fonction pour dessiner un histogramme
			 * 
			 * @param {HTMLCanvasElement} canvas - L'élément canvas HTML
			 * @param {Array} data - Tableau de données à représenter
			 * @param {Array} labels - Tableau d'étiquettes pour chaque barre
			 * @param {string} title - Titre de l'histogramme
			 * @param {Array} colors - Tableau de couleurs pour les barres
			 */
			function drawHistogram(canvas, data, labels, title = "Histogramme", colors = null) {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				
				// Effacer le canvas
				ctx.clearRect(0, 0, width, height);
				
				// Zone de dessin effective
				const chartWidth = width - 2 * padding;
				const chartHeight = height - 2 * padding;
				
				// Trouver la valeur maximale pour l'échelle
				const maxValue = Math.max(...data) * 1.1; // 10% de marge
				
				// Calculer la largeur des barres
				const barWidth = chartWidth / data.length * 0.8;
				const barSpacing = chartWidth / data.length * 0.2;
				
				// Dessiner le titre
				ctx.fillStyle = '#2c3e50';
				ctx.font = 'bold 14px Arial';
				ctx.textAlign = 'center';
				ctx.fillText(title, width / 2, padding / 2);
				
				// Dessiner l'axe Y
				ctx.strokeStyle = '#333';
				ctx.lineWidth = 2;
				ctx.beginPath();
				ctx.moveTo(padding, padding);
				ctx.lineTo(padding, height - padding);
				ctx.stroke();
				
				// Dessiner l'axe X
				ctx.beginPath();
				ctx.moveTo(padding, height - padding);
				ctx.lineTo(width - padding, height - padding);
				ctx.stroke();
				
				// Dessiner les graduations de l'axe Y
				ctx.fillStyle = '#333';
				ctx.font = '10px Arial';
				ctx.textAlign = 'right';
				
				// Nombre de graduations sur l'axe Y
				const numYTicks = 5;
				for (let i = 0; i <= numYTicks; i++) {
					const value = (maxValue / numYTicks) * i;
					const y = height - padding - (chartHeight / numYTicks) * i;
					
					// Ligne de graduation
					ctx.strokeStyle = '#e0e0e0';
					ctx.beginPath();
					ctx.moveTo(padding, y);
					ctx.lineTo(width - padding, y);
					ctx.stroke();
					
					// Texte de graduation
					ctx.fillStyle = '#333';
					ctx.fillText(Math.round(value), padding - 5, y);
				}
				
				// Dessiner les barres de l'histogramme
				for (let i = 0; i < data.length; i++) {
					// Position de la barre
					const x = padding + i * (barWidth + barSpacing) + barSpacing / 2;
					const barHeight = (data[i] / maxValue) * chartHeight;
					const y = height - padding - barHeight;
					
					// Couleur de la barre
					if (colors && colors[i]) {
						ctx.fillStyle = colors[i];
					} else {
						// Dégradé de couleurs si pas de couleurs spécifiées
						ctx.fillStyle = \`hsl(\${210 + (i * 30) % 360}, 70%, 60%)\`;
					}
					
					// Dessiner la barre
					ctx.fillRect(x, y, barWidth, barHeight);
					ctx.strokeStyle = '#333';
					ctx.strokeRect(x, y, barWidth, barHeight);
					
					// Ajouter l'étiquette sous la barre
					ctx.fillStyle = '#333';
					ctx.textAlign = 'center';
					ctx.fillText(labels[i], x + barWidth / 2, height - padding + 15);
					
					// Ajouter la valeur au-dessus de la barre
					ctx.fillText(data[i].toString(), x + barWidth / 2, y - 5);
				}
			}
			
			/**
			 * Fonction pour dessiner un diagramme en radar (polygone statistique)
			 * 
			 * @param {HTMLCanvasElement} canvas - L'élément canvas HTML
			 * @param {Array} data - Tableau de données à représenter
			 * @param {Array} labels - Tableau d'étiquettes pour chaque axe
			 * @param {number} maxValue - Valeur maximale pour l'échelle
			 * @param {string} color - Couleur du polygone
			 */
			function drawRadarChart(canvas, data, labels, maxValue = 10, color = 'rgba(52, 152, 219, 0.6)') {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				const centerX = width / 2;
				const centerY = height / 2;
				const radius = Math.min(width, height) / 2 - 40;
				
				// Effacer le canvas
				ctx.clearRect(0, 0, width, height);
				
				// Nombre d'axes (nombre de données)
				const numAxes = data.length;
				const angleStep = (Math.PI * 2) / numAxes;
				
				// Dessiner les cercles concentriques (niveaux)
				const numLevels = 5;
				ctx.strokeStyle = '#e0e0e0';
				ctx.fillStyle = '#f8f9fa';
				
				for (let level = 1; level <= numLevels; level++) {
					const levelRadius = (radius / numLevels) * level;
					
					ctx.beginPath();
					for (let i = 0; i < numAxes; i++) {
						const angle = i * angleStep - Math.PI / 2; // Commencer à midi
						const x = centerX + levelRadius * Math.cos(angle);
						const y = centerY + levelRadius * Math.sin(angle);
						
						if (i === 0) {
							ctx.moveTo(x, y);
						} else {
							ctx.lineTo(x, y);
						}
					}
					ctx.closePath();
					ctx.stroke();
					
					// Ajouter l'indication de niveau
					ctx.fillStyle = '#333';
					ctx.font = '10px Arial';
					ctx.textAlign = 'right';
					ctx.fillText(
						Math.round((maxValue / numLevels) * level), 
						centerX - 5, 
						centerY - levelRadius
					);
				}
				
				// Dessiner les axes
				ctx.strokeStyle = '#333';
				for (let i = 0; i < numAxes; i++) {
					const angle = i * angleStep - Math.PI / 2; // Commencer à midi
					const x = centerX + radius * Math.cos(angle);
					const y = centerY + radius * Math.sin(angle);
					
					ctx.beginPath();
					ctx.moveTo(centerX, centerY);
					ctx.lineTo(x, y);
					ctx.stroke();
					
					// Ajouter les étiquettes des axes
					ctx.fillStyle = '#2c3e50';
					ctx.font = 'bold 12px Arial';
					ctx.textAlign = 'center';
					
					// Ajuster la position du texte pour qu'il soit à l'extérieur du graphique
					const labelRadius = radius + 20;
					const labelX = centerX + labelRadius * Math.cos(angle);
					const labelY = centerY + labelRadius * Math.sin(angle);
					
					ctx.fillText(labels[i], labelX, labelY);
				}
				
				// Dessiner le polygone des données
				ctx.beginPath();
				ctx.fillStyle = color;
				ctx.strokeStyle = color.replace('0.6', '1');
				ctx.lineWidth = 2;
				
				for (let i = 0; i < numAxes; i++) {
					const angle = i * angleStep - Math.PI / 2;
					const value = data[i] / maxValue; // Normaliser entre 0 et 1
					const x = centerX + radius * value * Math.cos(angle);
					const y = centerY + radius * value * Math.sin(angle);
					
					if (i === 0) {
						ctx.moveTo(x, y);
					} else {
						ctx.lineTo(x, y);
					}
					
					// Dessiner les points de données
					ctx.fillStyle = '#e74c3c';
					ctx.beginPath();
					ctx.arc(x, y, 4, 0, Math.PI * 2);
					ctx.fill();
				}
				
				// Fermer et dessiner le polygone
				ctx.fillStyle = color;
				ctx.closePath();
				ctx.fill();
				ctx.stroke();
			}
			
			/**
			 * Fonction pour dessiner une boîte à moustaches
			 * 
			 * @param {HTMLCanvasElement} canvas - L'élément canvas HTML
			 * @param {number} min - Valeur minimale
			 * @param {number} q1 - Premier quartile
			 * @param {number} median - Médiane
			 * @param {number} q3 - Troisième quartile
			 * @param {number} max - Valeur maximale
			 * @param {string} label - Étiquette pour la boîte
			 * @param {string} color - Couleur de la boîte
			 */
			function drawBoxPlot(canvas, min, q1, median, q3, max, label = "Données", color = 'rgba(52, 152, 219, 0.6)') {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				
				// Effacer le canvas
				ctx.clearRect(0, 0, width, height);
				
				// Zone de dessin effective
				const chartHeight = height - 2 * padding;
				
				// Définir l'échelle verticale
				const dataMin = min * 0.9; // Ajouter une marge
				const dataMax = max * 1.1; // Ajouter une marge
				const dataRange = dataMax - dataMin;
				
				// Fonction pour convertir une valeur en position Y
				const valueToY = value => height - padding - (value - dataMin) / dataRange * chartHeight;
				
				// Dessiner l'axe Y
				ctx.strokeStyle = '#333';
				ctx.lineWidth = 2;
				ctx.beginPath();
				ctx.moveTo(padding, padding);
				ctx.lineTo(padding, height - padding);
				ctx.stroke();
				
				// Graduations de l'axe Y
				ctx.fillStyle = '#333';
				ctx.font = '10px Arial';
				ctx.textAlign = 'right';
				
				const numYTicks = 5;
				for (let i = 0; i <= numYTicks; i++) {
					const value = dataMin + (dataRange / numYTicks) * i;
					const y = valueToY(value);
					
					// Ligne de graduation
					ctx.strokeStyle = '#e0e0e0';
					ctx.beginPath();
					ctx.moveTo(padding, y);
					ctx.lineTo(width - padding, y);
					ctx.stroke();
					
					// Texte de graduation
					ctx.fillStyle = '#333';
					ctx.fillText(Math.round(value * 10) / 10, padding - 5, y);
				}
				
				// Position horizontale de la boîte
				const boxLeft = width / 3;
				const boxRight = width * 2 / 3;
				const boxWidth = boxRight - boxLeft;
				
				// Convertir les statistiques en positions Y
				const minY = valueToY(min);
				const q1Y = valueToY(q1);
				const medianY = valueToY(median);
				const q3Y = valueToY(q3);
				const maxY = valueToY(max);
				
				// Dessiner la moustache inférieure
				ctx.strokeStyle = '#333';
				ctx.beginPath();
				ctx.moveTo(width / 2, minY);
				ctx.lineTo(width / 2, q1Y);
				ctx.stroke();
				
				// Dessiner la moustache supérieure
				ctx.beginPath();
				ctx.moveTo(width / 2, q3Y);
				ctx.lineTo(width / 2, maxY);
				ctx.stroke();
				
				// Dessiner les extrémités des moustaches
				const whiskerWidth = boxWidth / 2;
				
				// Extrémité inférieure
				ctx.beginPath();
				ctx.moveTo(width / 2 - whiskerWidth / 2, minY);
				ctx.lineTo(width / 2 + whiskerWidth / 2, minY);
				ctx.stroke();
				
				// Extrémité supérieure
				ctx.beginPath();
				ctx.moveTo(width / 2 - whiskerWidth / 2, maxY);
				ctx.lineTo(width / 2 + whiskerWidth / 2, maxY);
				ctx.stroke();
				
				// Dessiner la boîte
				ctx.fillStyle = color;
				ctx.fillRect(boxLeft, q3Y, boxWidth, q1Y - q3Y);
				ctx.strokeStyle = '#333';
				ctx.strokeRect(boxLeft, q3Y, boxWidth, q1Y - q3Y);
				
				// Dessiner la médiane
				ctx.strokeStyle = '#e74c3c';
				ctx.lineWidth = 2;
				ctx.beginPath();
				ctx.moveTo(boxLeft, medianY);
				ctx.lineTo(boxRight, medianY);
				ctx.stroke();
				
				// Remettre la largeur de ligne par défaut
				ctx.lineWidth = 1;
				
				// Ajouter l'étiquette
				ctx.fillStyle = '#2c3e50';
				ctx.font = 'bold 12px Arial';
				ctx.textAlign = 'center';
				ctx.fillText(label, width / 2, height - padding / 2);
				
				// Ajouter une légende des valeurs statistiques
				ctx.font = '10px Arial';
				ctx.textAlign = 'left';
				ctx.fillStyle = '#333';
				
				const legendX = padding;
				let legendY = padding;
				const lineHeight = 15;
				
				ctx.fillText(\`Min: \${min}\`, legendX, legendY);
				legendY += lineHeight;
				ctx.fillText(\`Q1: \${q1}\`, legendX, legendY);
				legendY += lineHeight;
				ctx.fillText(\`Médiane: \${median}\`, legendX, legendY);
				legendY += lineHeight;
				ctx.fillText(\`Q3: \${q3}\`, legendX, legendY);
				legendY += lineHeight;
				ctx.fillText(\`Max: \${max}\`, legendX, legendY);
			}
			
			/**
			 * Fonction pour dessiner un diagramme circulaire
			 * 
			 * @param {HTMLCanvasElement} canvas - L'élément canvas HTML
			 * @param {Array} data - Tableau de données à représenter
			 * @param {Array} labels - Tableau d'étiquettes pour chaque secteur
			 * @param {Array} colors - Tableau de couleurs pour les secteurs
			 */
			function drawPieChart(canvas, data, labels, colors = null) {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				const centerX = width / 2;
				const centerY = height / 2;
				const radius = Math.min(width, height) / 2 - 40;
				
				// Effacer le canvas
				ctx.clearRect(0, 0, width, height);
				
				// Calculer le total pour les pourcentages
				const total = data.reduce((sum, value) => sum + value, 0);
				
				// Angle de départ
				let startAngle = -Math.PI / 2; // Commencer à midi
				
				// Dessiner chaque secteur
				for (let i = 0; i < data.length; i++) {
					// Calculer l'angle de fin
					const sliceAngle = (data[i] / total) * (Math.PI * 2);
					const endAngle = startAngle + sliceAngle;
					
					// Définir la couleur du secteur
					if (colors && colors[i]) {
						ctx.fillStyle = colors[i];
					} else {
						// Dégradé de couleurs si pas de couleurs spécifiées
						ctx.fillStyle = \`hsl(\${(i * 30) % 360}, 70%, 60%)\`;
					}
					
					// Dessiner le secteur
					ctx.beginPath();
					ctx.moveTo(centerX, centerY);
					ctx.arc(centerX, centerY, radius, startAngle, endAngle);
					ctx.closePath();
					ctx.fill();
					
					// Ajouter une bordure
					ctx.strokeStyle = '#fff';
					ctx.lineWidth = 2;
					ctx.stroke();
					
					// Calculer la position du texte (au milieu du secteur)
					const middleAngle = startAngle + sliceAngle / 2;
					const textRadius = radius * 0.7;
					const textX = centerX + textRadius * Math.cos(middleAngle);
					const textY = centerY + textRadius * Math.sin(middleAngle);
					
					// Calculer le pourcentage
					const percentage = Math.round((data[i] / total) * 100);
					
					// Ajouter le texte du pourcentage
					ctx.fillStyle = '#fff';
					ctx.font = 'bold 12px Arial';
					ctx.textAlign = 'center';
					ctx.textBaseline = 'middle';
					ctx.fillText(\`\${percentage}%\`, textX, textY);
					
					// Préparer pour le prochain secteur
					startAngle = endAngle;
				}
				
				// Ajouter une légende
				const legendX = width - padding;
				let legendY = padding;
				const lineHeight = 20;
				const colorBoxSize = 10;
				
				ctx.textAlign = 'right';
				ctx.textBaseline = 'middle';
				
				for (let i = 0; i < labels.length; i++) {
					// Définir la couleur
					if (colors && colors[i]) {
						ctx.fillStyle = colors[i];
					} else {
						ctx.fillStyle = \`hsl(\${(i * 30) % 360}, 70%, 60%)\`;
					}
					
					// Dessiner la boîte de couleur
					ctx.fillRect(legendX - 100, legendY - colorBoxSize / 2, colorBoxSize, colorBoxSize);
					ctx.strokeStyle = '#333';
					ctx.strokeRect(legendX - 100, legendY - colorBoxSize / 2, colorBoxSize, colorBoxSize);
					
					// Ajouter le texte de la légende
					ctx.fillStyle = '#333';
					ctx.font = '10px Arial';
					ctx.fillText(labels[i], legendX - 15, legendY);
					
					legendY += lineHeight;
				}
			}
			
			/**
			 * Fonction pour dessiner un histogramme à barres multiples (comparatif)
			 * 
			 * @param {HTMLCanvasElement} canvas - L'élément canvas HTML
			 * @param {Array} datasets - Tableau de tableaux de données
			 * @param {Array} dataLabels - Tableau d'étiquettes pour chaque jeu de données
			 * @param {Array} categoryLabels - Tableau d'étiquettes pour chaque catégorie
			 * @param {Array} colors - Tableau de couleurs pour chaque jeu de données
			 */
			function drawMultiHistogram(canvas, datasets, dataLabels, categoryLabels, colors = null) {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				
				// Effacer le canvas
				ctx.clearRect(0, 0, width, height);
				
				// Zone de dessin effective
				const chartWidth = width - 2 * padding;
				const chartHeight = height - 2 * padding;
				
				// Nombre de catégories et de jeux de données
				const numCategories = categoryLabels.length;
				const numDatasets = datasets.length;
				
				// Trouver la valeur maximale pour l'échelle
				const maxValue = Math.max(...datasets.map(data => Math.max(...data))) * 1.1; // 10% de marge
				
				// Calculer la largeur des groupes de barres et des barres individuelles
				const groupWidth = chartWidth / numCategories * 0.8;
				const groupSpacing = chartWidth / numCategories * 0.2;
				const barWidth = groupWidth / numDatasets;
				
				// Dessiner l'axe Y
				ctx.strokeStyle = '#333';
				ctx.lineWidth = 2;
				ctx.beginPath();
				ctx.moveTo(padding, padding);
				ctx.lineTo(padding, height - padding);
				ctx.stroke();
				
				// Dessiner l'axe X
				ctx.beginPath();
				ctx.moveTo(padding, height - padding);
				ctx.lineTo(width - padding, height - padding);
				ctx.stroke();
				
				// Dessiner les graduations de l'axe Y
				ctx.fillStyle = '#333';
				ctx.font = '10px Arial';
				ctx.textAlign = 'right';
				
				// Nombre de graduations sur l'axe Y
				const numYTicks = 5;
				for (let i = 0; i <= numYTicks; i++) {
					const value = (maxValue / numYTicks) * i;
					const y = height - padding - (chartHeight / numYTicks) * i;
					
					// Ligne de graduation
					ctx.strokeStyle = '#e0e0e0';
					ctx.beginPath();
					ctx.moveTo(padding, y);
					ctx.lineTo(width - padding, y);
					ctx.stroke();
					
					// Texte de graduation
					ctx.fillStyle = '#333';
					ctx.fillText(Math.round(value), padding - 5, y);
				}
				
				// Dessiner les barres de l'histogramme
				for (let i = 0; i < numCategories; i++) {
					// Position du groupe de barres
					const groupX = padding + i * (groupWidth + groupSpacing) + groupSpacing / 2;
					
					// Dessiner chaque barre du groupe
					for (let j = 0; j < numDatasets; j++) {
						const value = datasets[j][i];
						const barHeight = (value / maxValue) * chartHeight;
						const x = groupX + j * barWidth;
						const y = height - padding - barHeight;
						
						// Couleur de la barre
						if (colors && colors[j]) {
							ctx.fillStyle = colors[j];
						} else {
							ctx.fillStyle = \`hsl(\${210 + (j * 60) % 360}, 70%, 60%)\`;
						}
						
						// Dessiner la barre
						ctx.fillRect(x, y, barWidth, barHeight);
						ctx.strokeStyle = '#333';
						ctx.strokeRect(x, y, barWidth, barHeight);
						
						// Ajouter la valeur au-dessus de la barre
						ctx.fillStyle = '#333';
						ctx.textAlign = 'center';
						ctx.font = '8px Arial';
						ctx.fillText(value.toString(), x + barWidth / 2, y - 5);
					}
					
					// Ajouter l'étiquette de catégorie sous le groupe
					ctx.fillStyle = '#333';
					ctx.textAlign = 'center';
					ctx.font = '10px Arial';
					ctx.fillText(categoryLabels[i], groupX + groupWidth / 2, height - padding + 15);
				}
				
				// Ajouter une légende
				const legendX = width - padding;
				let legendY = padding;
				const lineHeight = 20;
				const colorBoxSize = 10;
				
				ctx.textAlign = 'right';
				ctx.textBaseline = 'middle';
				
				for (let i = 0; i < dataLabels.length; i++) {
					// Définir la couleur
					if (colors && colors[i]) {
						ctx.fillStyle = colors[i];
					} else {
						ctx.fillStyle = \`hsl(\${210 + (i * 60) % 360}, 70%, 60%)\`;
					}
					
					// Dessiner la boîte de couleur
					ctx.fillRect(legendX - 100, legendY - colorBoxSize / 2, colorBoxSize, colorBoxSize);
					ctx.strokeStyle = '#333';
					ctx.strokeRect(legendX - 100, legendY - colorBoxSize / 2, colorBoxSize, colorBoxSize);
					
					// Ajouter le texte de la légende
					ctx.fillStyle = '#333';
					ctx.font = '10px Arial';
					ctx.fillText(dataLabels[i], legendX - 15, legendY);
					
					legendY += lineHeight;
				}
			}
			
			/**
			 * Fonction pour dessiner un diagramme en anneau (donut chart)
			 * 
			 * @param {HTMLCanvasElement} canvas - L'élément canvas HTML
			 * @param {Array} data - Tableau de données à représenter
			 * @param {Array} labels - Tableau d'étiquettes pour chaque secteur
			 * @param {Array} colors - Tableau de couleurs pour les secteurs
			 * @param {number} innerRadiusRatio - Ratio du rayon intérieur par rapport au rayon extérieur
			 */
			function drawDonutChart(canvas, data, labels, colors = null, innerRadiusRatio = 0.5) {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				const centerX = width / 2;
				const centerY = height / 2;
				const outerRadius = Math.min(width, height) / 2 - 40;
				const innerRadius = outerRadius * innerRadiusRatio;
				
				// Effacer le canvas
				ctx.clearRect(0, 0, width, height);
				
				// Calculer le total pour les pourcentages
				const total = data.reduce((sum, value) => sum + value, 0);
				
				// Angle de départ
				let startAngle = -Math.PI / 2; // Commencer à midi
				
				// Dessiner chaque secteur
				for (let i = 0; i < data.length; i++) {
					// Calculer l'angle de fin
					const sliceAngle = (data[i] / total) * (Math.PI * 2);
					const endAngle = startAngle + sliceAngle;
					
					// Définir la couleur du secteur
					if (colors && colors[i]) {
						ctx.fillStyle = colors[i];
					} else {
						// Dégradé de couleurs si pas de couleurs spécifiées
						ctx.fillStyle = \`hsl(\${(i * 30) % 360}, 70%, 60%)\`;
					}
					
					// Dessiner le secteur d'anneau
					ctx.beginPath();
					ctx.arc(centerX, centerY, outerRadius, startAngle, endAngle);
					ctx.arc(centerX, centerY, innerRadius, endAngle, startAngle, true);
					ctx.closePath();
					ctx.fill();
					
					// Ajouter une bordure
					ctx.strokeStyle = '#fff';
					ctx.lineWidth = 2;
					ctx.stroke();
					
					// Calculer la position du texte (au milieu du secteur)
					const middleAngle = startAngle + sliceAngle / 2;
					const textRadius = (outerRadius + innerRadius) / 2;
					const textX = centerX + textRadius * Math.cos(middleAngle);
					const textY = centerY + textRadius * Math.sin(middleAngle);
					
					// Calculer le pourcentage
					const percentage = Math.round((data[i] / total) * 100);
					
					// Ajouter le texte du pourcentage
					ctx.fillStyle = '#fff';
					ctx.font = 'bold 12px Arial';
					ctx.textAlign = 'center';
					ctx.textBaseline = 'middle';
					ctx.fillText(\`\${percentage}%\`, textX, textY);
					
					// Préparer pour le prochain secteur
					startAngle = endAngle;
				}
				
				// Ajouter le texte au centre de l'anneau
				ctx.fillStyle = '#2c3e50';
				ctx.font = 'bold 14px Arial';
				ctx.textAlign = 'center';
				ctx.textBaseline = 'middle';
				ctx.fillText("Total", centerX, centerY - 10);
				ctx.fillText(total.toString(), centerX, centerY + 10);
				
				// Ajouter une légende
				const legendX = width - padding;
				let legendY = padding;
				const lineHeight = 20;
				const colorBoxSize = 10;
				
				ctx.textAlign = 'right';
				ctx.textBaseline = 'middle';
				
				for (let i = 0; i < labels.length; i++) {
					// Définir la couleur
					if (colors && colors[i]) {
						ctx.fillStyle = colors[i];
					} else {
						ctx.fillStyle = \`hsl(\${(i * 30) % 360}, 70%, 60%)\`;
					}
					
					// Dessiner la boîte de couleur
					ctx.fillRect(legendX - 100, legendY - colorBoxSize / 2, colorBoxSize, colorBoxSize);
					ctx.strokeStyle = '#333';
					ctx.strokeRect(legendX - 100, legendY - colorBoxSize / 2, colorBoxSize, colorBoxSize);
					
					// Ajouter le texte de la légende
					ctx.fillStyle = '#333';
					ctx.font = '10px Arial';
					ctx.fillText(\`\${labels[i]} (\${data[i]})\`, legendX - 15, legendY);
					
					legendY += lineHeight;
				}
			}
			
			/**
			 * Fonction pour initialiser tous les graphiques
			 * Cette fonction est appelée au chargement de la page
			 */
			function initializeGraphs() {
				// Données de démonstration pour chaque graphique
				const graphData = {
					histogram: {
						data: [12, 19, 3, 5, 2, 8],
						labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin'],
						title: "Ventes Mensuelles"
					},
					radar: {
						data: [8, 9, 7, 5, 8, 5],
						labels: ['Maths', 'Physique', 'Chimie', 'Biologie', 'Info', 'Langues'],
						maxValue: 10
					},
					boxplot: {
						min: 5, 
						q1: 8, 
						median: 12, 
						q3: 15, 
						max: 20,
						label: "Notes d'Examen"
					},
					piechart: {
						data: [35, 25, 15, 25],
						labels: ['Pommes', 'Bananes', 'Oranges', 'Kiwis'],
						colors: ['#e74c3c', '#f1c40f', '#e67e22', '#2ecc71']
					},
					multiHistogram: {
						datasets: [
							[12, 19, 3, 5],  // Série 1
							[9, 15, 5, 7]     // Série 2
						],
						dataLabels: ['2023', '2024'],
						categoryLabels: ['T1', 'T2', 'T3', 'T4'],
						colors: ['#3498db', '#2ecc71']
					},
					donut: {
						data: [42, 28, 15, 15],
						labels: ['Transport', 'Alimentation', 'Loisirs', 'Logement'],
						colors: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12']
					}
				};
			
				// Vérifier et dessiner chaque graphique s'il existe dans le DOM
				const histogramCanvas = document.getElementById('histogram');
				if (histogramCanvas) {
					const data = graphData.histogram;
					drawHistogram(histogramCanvas, data.data, data.labels, data.title);
				}
				
				const radarCanvas = document.getElementById('radar');
				if (radarCanvas) {
					const data = graphData.radar;
					drawRadarChart(radarCanvas, data.data, data.labels, data.maxValue);
				}
				
				const boxplotCanvas = document.getElementById('boxplot');
				if (boxplotCanvas) {
					const data = graphData.boxplot;
					drawBoxPlot(boxplotCanvas, data.min, data.q1, data.median, data.q3, data.max, data.label);
				}
				
				const pieCanvas = document.getElementById('piechart');
				if (pieCanvas) {
					const data = graphData.piechart;
					drawPieChart(pieCanvas, data.data, data.labels, data.colors);
				}
				
				const multiHistogramCanvas = document.getElementById('multiHistogram');
				if (multiHistogramCanvas) {
					const data = graphData.multiHistogram;
					drawMultiHistogram(multiHistogramCanvas, data.datasets, data.dataLabels, data.categoryLabels, data.colors);
				}
				
				const donutCanvas = document.getElementById('donutChart');
				if (donutCanvas) {
					const data = graphData.donut;
					drawDonutChart(donutCanvas, data.data, data.labels, data.colors);
				}
			}`,
				
				code: `<div class="container">
				<h1>Visualisations Statistiques</h1>
				<p class="intro">Cette application vous permet d'explorer différents types de visualisations graphiques statistiques.</p>
				
				<div class="graphs-container">
					<!-- Graphique 1 - Histogramme -->
					<div class="graph-card">
						<div class="graph-title">Histogramme</div>
						<p>Distribution des valeurs par classe.</p>
						<canvas id="histogram" width="300" height="300"></canvas>
					</div>
					
					<!-- Graphique 2 - Polygone statistique (Diagramme en radar) -->
					<div class="graph-card">
						<div class="graph-title">Polygone Statistique (Radar)</div>
						<p>Comparaison multicritère sur une échelle radiale.</p>
						<canvas id="radar" width="300" height="300"></canvas>
					</div>
					
					<!-- Graphique 3 - Boîte à moustaches -->
					<div class="graph-card">
						<div class="graph-title">Boîte à Moustaches</div>
						<p>Résumé des statistiques de distribution (min, Q1, médiane, Q3, max).</p>
						<canvas id="boxplot" width="300" height="300"></canvas>
					</div>
					
					<!-- Graphique 4 - Diagramme circulaire (Camembert) -->
					<div class="graph-card">
						<div class="graph-title">Diagramme Circulaire</div>
						<p>Répartition proportionnelle des valeurs.</p>
						<canvas id="piechart" width="300" height="300"></canvas>
					</div>
					
					<!-- Graphique 5 - Histogramme multiclasse -->
					<div class="graph-card">
						<div class="graph-title">Histogramme Comparatif</div>
						<p>Comparaison de plusieurs distributions.</p>
						<canvas id="multiHistogram" width="300" height="300"></canvas>
					</div>
					
					<!-- Graphique 6 - Diagramme en anneau -->
					<div class="graph-card">
						<div class="graph-title">Diagramme en Anneau</div>
						<p>Variante du diagramme circulaire avec un centre vide.</p>
						<canvas id="donutChart" width="300" height="300"></canvas>
					</div>
				</div>
			</div>`
			},            
            
            
            
			probability: {
				title: "Simulation Probabiliste et QCM",
				description: "Un template pour créer des simulations d'expériences aléatoires (lancers de pièces, dés) et des questions sur les probabilités et fréquences. Les apprenants peuvent comprendre les concepts des probabilités à travers des expériences interactives.",
				features: [
					"Simulation interactive de lancers de pièces et de dés avec animation",
					"Calcul automatique des fréquences observées et affichage en temps réel",
					"Visualisation dynamique des résultats d'expériences aléatoires",
					"QCM sur les concepts de probabilité avec feedback immédiat",
					"Exercices de calcul de fréquence basés sur les simulations réalisées",
					"Mode pile ou face et mode dé à 6 faces",
				],
				icon: "fas fa-dice",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Simulation Probabiliste</h3>
						<div style="display: flex; gap: 10px; margin-bottom: 15px;">
							<button style="flex: 1; padding: 8px 12px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Pile ou Face</button>
							<button style="flex: 1; padding: 8px 12px; background: #e9ecef; color: #333; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Dé à 6 faces</button>
						</div>
					</div>
					
					<div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
						<button style="padding: 8px 12px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">1 lancer</button>
						<button style="padding: 8px 12px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">10 lancers</button>
						<button style="padding: 8px 12px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">100 lancers</button>
						<button style="padding: 8px 12px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">1000 lancers</button>
					</div>
					
					<div style="background: #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
						<div style="width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #FFD700, #DAA520); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">P</div>
						<div style="width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #FF8C00, #D2691E); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">F</div>
						<div style="width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #FFD700, #DAA520); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">P</div>
						<div style="width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #FFD700, #DAA520); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">P</div>
						<div style="width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #FF8C00, #D2691E); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">F</div>
					</div>
					
					<div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
						<div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; min-width: 80px; border: 1px solid #e9ecef;">
							<div style="font-weight: bold; margin-bottom: 5px; color: #333;">Pile</div>
							<div style="font-size: 1.2rem; font-weight: bold; color: #4361ee;">3</div>
						</div>
						<div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; min-width: 80px; border: 1px solid #e9ecef;">
							<div style="font-weight: bold; margin-bottom: 5px; color: #333;">Face</div>
							<div style="font-size: 1.2rem; font-weight: bold; color: #4361ee;">2</div>
						</div>
						<div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; min-width: 80px; border: 1px solid #e9ecef;">
							<div style="font-weight: bold; margin-bottom: 5px; color: #333;">Total</div>
							<div style="font-size: 1.2rem; font-weight: bold; color: #4361ee;">5</div>
						</div>
					</div>
					
					<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
						<div style="font-weight: bold; margin-bottom: 10px; color: #333; border-left: 4px solid #4361ee; padding-left: 10px;">Question: Fréquence et Probabilité</div>
						<p style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">Si on lance une pièce équilibrée un très grand nombre de fois, quelle devrait être la fréquence d'apparition de "Pile" ?</p>
						<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
							<button style="padding: 10px; background: #a24b5f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Exactement 50%</button>
							<button style="padding: 10px; background: #6a88ca; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Proche de 50%</button>
							<button style="padding: 10px; background: #8ba4da; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Entre 25% et 75%</button>
						</div>
						<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px; text-align: center; font-weight: bold;">
							✅ Correct ! Bravo !
						</div>
						<div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border: 1px solid #b8daff; color: #004085; border-radius: 5px; font-size: 0.9em;">
							La probabilité théorique d'obtenir "Pile" avec une pièce équilibrée est de 50%. Pour un très grand nombre de lancers, la fréquence observée se rapproche de cette probabilité, mais il existe toujours des fluctuations.
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE PROBABILITES : PRIORITE OBLIGATOIRE SI CHOISIE
			// =====================================================================
			// VARIABLES GLOBALES
			// =====================================================================
			
			// Variables pour les simulations
			let currentMode = 'coin';
			let currentCount = {
				coin: { pile: 0, face: 0, total: 0 },
				dice: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, total: 0 }
			};
			
			// Définit les positions des pips pour chaque face du dé
			const pipPositions = {
				1: [ { left: "50%", top: "50%" } ],
				2: [ { left: "25%", top: "25%" }, { left: "75%", top: "75%" } ],
				3: [ { left: "25%", top: "25%" }, { left: "50%", top: "50%" }, { left: "75%", top: "75%" } ],
				4: [ { left: "25%", top: "25%" }, { left: "75%", top: "25%" }, { left: "25%", top: "75%" }, { left: "75%", top: "75%" } ],
				5: [ { left: "25%", top: "25%" }, { left: "75%", top: "25%" }, { left: "50%", top: "50%" }, { left: "25%", top: "75%" }, { left: "75%", top: "75%" } ],
				6: [ { left: "25%", top: "25%" }, { left: "25%", top: "50%" }, { left: "25%", top: "75%" },
					{ left: "75%", top: "25%" }, { left: "75%", top: "50%" }, { left: "75%", top: "75%" } ]
			};
			
			// Variables pour le QCM
			let score = 0;
			let answered = new Set();
			let testCompleted = false;
			

			// =====================================================================
			// FONCTIONS DE SIMULATION 
			// =====================================================================
			
			// Fonction pour basculer entre les modes
			function switchMode(mode) {
				if (mode === 'coin') {
					document.querySelector('.coin-mode').classList.add('active');
					document.querySelector('.dice-mode').classList.remove('active');
					document.getElementById('coinModeBtn').classList.add('active');
					document.getElementById('diceModeBtn').classList.remove('active');
					currentMode = 'coin';
				} else {
					document.querySelector('.coin-mode').classList.remove('active');
					document.querySelector('.dice-mode').classList.add('active');
					document.getElementById('coinModeBtn').classList.remove('active');
					document.getElementById('diceModeBtn').classList.add('active');
					currentMode = 'dice';
				}
			}
			
			// Fonction pour créer les éléments de simulation
			function createElements(type, num) {
				const container = document.getElementById(type + '-container');
				container.innerHTML = '';
				
				// Limiter le nombre d'éléments visuels à afficher
				const maxVisualElements = 100;
				const displayCount = Math.min(num, maxVisualElements);
				
				if (type === 'coin') {
					for (let i = 0; i < displayCount; i++) {
						const coin = document.createElement('div');
						coin.className = 'coin';
						coin.textContent = '?';
						container.appendChild(coin);
					}
				} else {
					for (let i = 0; i < displayCount; i++) {
						const die = document.createElement('div');
						die.className = 'die';
						container.appendChild(die);
					}
				}
			}
			
			// Animation de lancer des pièces
			function animateCoinToss(coins, results) {
				return new Promise(resolve => {
					// Ajoute la classe tossing pour l'animation
					for (let coin of coins) {
						coin.classList.add('tossing');
						coin.textContent = '?';
						coin.classList.remove('pile', 'face');
					}
					
					// Après l'animation, affiche les résultats
					setTimeout(() => {
						for (let i = 0; i < coins.length; i++) {
							const coin = coins[i];
							coin.classList.remove('tossing');
							const result = results[i];
							coin.textContent = result === 'PILE' ? 'P' : 'F';
							coin.classList.add(result.toLowerCase());
						}
						resolve();
					}, 500);
				});
			}
			
			// =====================================================================
			// LANCER DE DES : utiliser si demandé
			// =====================================================================

			// Animation de lancer des dés
			function animateDiceRoll(dice, results) {
				return new Promise(resolve => {
					// Ajoute la classe rolling pour l'animation
					for (let die of dice) {
						die.classList.add('rolling');
						die.innerHTML = '';
					}
					
					// Après l'animation, affiche les résultats
					setTimeout(() => {
						for (let i = 0; i < dice.length; i++) {
							const die = dice[i];
							die.classList.remove('rolling');
							const result = results[i];
							
							// Pour chaque position définie, crée un pip
							pipPositions[result].forEach(pos => {
								const pip = document.createElement('div');
								pip.className = 'pip';
								pip.style.left = pos.left;
								pip.style.top = pos.top;
								die.appendChild(pip);
							});
						}
						resolve();
					}, 500);
				});
			}
			
			// =====================================================================
			// LANCER DE PIECES : utiliser si demandé
			// =====================================================================

			// Fonction de lancement des simulations
			async function launch(type, num) {
				// Réinitialiser les compteurs
				if (type === 'coin') {
					currentCount.coin = { pile: 0, face: 0, total: 0 };
				} else {
					currentCount.dice = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, total: 0 };
				}
				
				// Crée les éléments pour la simulation
				createElements(type, num);
				
				if (type === 'coin') {
					const container = document.getElementById('coin-container');
					const coins = container.getElementsByClassName('coin');
					let results = [];
					
					// Génère les résultats aléatoires pour tous les lancers
					for (let i = 0; i < num; i++) {
						const result = Math.random() < 0.5 ? 'PILE' : 'FACE';
						results.push(result);
						if (result === 'PILE') {
							currentCount.coin.pile++;
						} else {
							currentCount.coin.face++;
						}
					}
					currentCount.coin.total = num;
					
					// Mise à jour des compteurs affichés
					document.getElementById('pileCount').textContent = currentCount.coin.pile;
					document.getElementById('faceCount').textContent = currentCount.coin.face;
					document.getElementById('coinTotal').textContent = currentCount.coin.total;
					
					
					// Animation des éléments visibles
					if (coins.length > 0) {
						const visibleResults = results.slice(0, coins.length);
						await animateCoinToss(coins, visibleResults);
					}
					
				} else {
					const container = document.getElementById('dice-container');
					const dice = container.getElementsByClassName('die');
					let results = [];
					let counts = [0, 0, 0, 0, 0, 0];
					
					// Génère les résultats aléatoires
					for (let i = 0; i < num; i++) {
						const result = Math.floor(Math.random() * 6) + 1;
						results.push(result);
						counts[result - 1]++;
					}
					
					// Mise à jour des compteurs pour chaque face
					for (let i = 0; i < 6; i++) {
						currentCount.dice[i + 1] = counts[i];
						document.getElementById('result' + (i + 1) + 'Count').textContent = counts[i];
					}
					currentCount.dice.total = num;
					document.getElementById('diceTotal').textContent = num;
					
					// Calcul des fréquences (sans affichage)
					const frequencies = [];
					for (let i = 0; i < 6; i++) {
						const freq = (counts[i] / num * 100).toFixed(2);
						frequencies.push(freq); // Stocke les fréquences au cas où elles seraient nécessaires ailleurs
					}
					
					// Animation des éléments visibles
					if (dice.length > 0) {
						const visibleResults = results.slice(0, dice.length);
						await animateDiceRoll(dice, visibleResults);
					}
				}
			}
							
				// Enregistrer dans SCORM si disponible
				if (typeof saveState === 'function') {
					saveState();
				}
			}
			
			// Fonction pour relancer pour une question spécifique
			function relaunchForQuestion(questionId) {
				// Relancer en fonction du type de question
				if (questionId === 1 || questionId === 2 || questionId === 4 || questionId === 5) {
					// Questions sur les pièces
					switchMode('coin');
					
					// Choisir différentes quantités selon la question
					let quantity = 10;
					if (questionId === 2 || questionId === 5) {
						// Pour les questions sur les fluctuations ou la loi des grands nombres
						const options = [10, 100, 1000];
						quantity = options[Math.floor(Math.random() * options.length)];
					}
					
					launch('coin', quantity);
				} else if (questionId === 3 || questionId === 6) {
					// Questions sur les dés
					switchMode('dice');
					launch('dice', 100);
				}
				
				// Faire défiler jusqu'à la question
				document.querySelector(\`.question-card[data-id="\${questionId}"]\`).scrollIntoView({ behavior: 'smooth', block: 'center' });
			}

				// =====================================================================
				// GESTION DES QUESTIONS À CHOIX MULTIPLES
				// =====================================================================
				function checkAnswer(questionId, selectedOption) {
					const questionCard = document.querySelector(\`.question-card[data-id="\${questionId}"]\`);
					const correctAnswer = questionCard.getAttribute('data-answer');
					const resultDiv = document.getElementById(\`result\${questionId}\`);
					const explanationDiv = document.getElementById(\`explanation\${questionId}\`);
					const options = questionCard.querySelectorAll('.option-btn');
					
					// Désactiver les boutons de réponse
					options.forEach(btn => {
						if (btn.classList.contains(\`option-\${selectedOption}\`)) {
							btn.style.fontWeight = 'bold';
						}
						btn.disabled = true;
					});
					
					// Vérifier si la réponse est correcte
					if (selectedOption === correctAnswer) {
						resultDiv.textContent = "✅ Correct ! Bravo !";
						resultDiv.className = "result-message correct";
						
						if (!answered.has(questionId)) {
							answered.add(questionId);
							score++;
							document.getElementById('score').textContent = score;
						}
					} else {
						resultDiv.textContent = \`❌ Incorrect. La bonne réponse était l'option \${correctAnswer.toUpperCase()}.\`;
						resultDiv.className = "result-message incorrect";
						
						// Marquer quand même comme répondu
						if (!answered.has(questionId)) {
							answered.add(questionId);
						}
					}
					
					// Afficher le résultat et l'explication
					resultDiv.style.display = "block";
					explanationDiv.style.display = "block";
					
					// Activer le bouton "Terminer" si au moins une question est répondue
					if (answered.size > 0) {
						document.getElementById('finishBtn').disabled = false;
					}
					
					// Vérifier si toutes les questions sont complétées
					checkAllCompleted();
				}
				
				// =====================================================================
				// GESTION DES QUESTIONS AVEC SAISIE NUMÉRIQUE
				// =====================================================================
				function checkInputAnswer(questionId) {
					const answerInput = document.getElementById(\`answer\${questionId}\`);
					const userAnswer = parseFloat(answerInput.value);
					const resultDiv = document.getElementById(\`result\${questionId}\`);
					const explanationDiv = document.getElementById(\`explanation\${questionId}\`);
					
					// Vérifier si la réponse est un nombre valide
					if (isNaN(userAnswer)) {
						resultDiv.textContent = "⚠️ Veuillez entrer un nombre valide (exemple: 0.5 pour 50%)";
						resultDiv.className = "result-message incorrect";
						resultDiv.style.display = "block";
						return;
					}
					
					// Obtenir la réponse correcte selon le type de question
					let correctAnswer, tolerance;
					const questionType = getQuestionType(questionId);
					
					switch (questionType) {
						case 'pile':
							if (currentCount.coin.total === 0) {
								resultDiv.textContent = "⚠️ Vous devez d'abord lancer la simulation!";
								resultDiv.className = "result-message incorrect";
								resultDiv.style.display = "block";
								return;
							}
							correctAnswer = currentCount.coin.pile / currentCount.coin.total;
							break;
						case 'face':
							if (currentCount.coin.total === 0) {
								resultDiv.textContent = "⚠️ Vous devez d'abord lancer la simulation!";
								resultDiv.className = "result-message incorrect";
								resultDiv.style.display = "block";
								return;
							}
							correctAnswer = currentCount.coin.face / currentCount.coin.total;
							break;
						case 'even_dice':
							if (currentCount.dice.total === 0) {
								resultDiv.textContent = "⚠️ Vous devez d'abord lancer la simulation!";
								resultDiv.className = "result-message incorrect";
								resultDiv.style.display = "block";
								return;
							}
							const evenCount = currentCount.dice[2] + currentCount.dice[4] + currentCount.dice[6];
							correctAnswer = evenCount / currentCount.dice.total;
							break;
						case 'odd_dice':
							if (currentCount.dice.total === 0) {
								resultDiv.textContent = "⚠️ Vous devez d'abord lancer la simulation!";
								resultDiv.className = "result-message incorrect";
								resultDiv.style.display = "block";
								return;
							}
							const oddCount = currentCount.dice[1] + currentCount.dice[3] + currentCount.dice[5];
							correctAnswer = oddCount / currentCount.dice.total;
							break;
						default:
							// Par défaut pour les exemples, on utilise pile
							if (currentCount.coin.total === 0) {
								resultDiv.textContent = "⚠️ Vous devez d'abord lancer la simulation!";
								resultDiv.className = "result-message incorrect";
								resultDiv.style.display = "block";
								return;
							}
							correctAnswer = currentCount.coin.pile / currentCount.coin.total;
							break;
					}
					
					tolerance = 0.01; // 1% de tolérance par défaut
					
					// Vérifier si la réponse est correcte
					const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
					
					if (isCorrect) {
						resultDiv.textContent = \`✅ Correct ! La fréquence exacte est \${correctAnswer.toFixed(4)} (\${(correctAnswer * 100).toFixed(2)}%)\`;
						resultDiv.className = "result-message correct";
						
						if (!answered.has(questionId)) {
							answered.add(questionId);
							score++;
							document.getElementById('score').textContent = score;
						}
					} else {
						resultDiv.textContent = \`❌ Incorrect. La fréquence exacte est \${correctAnswer.toFixed(4)} (\${(correctAnswer * 100).toFixed(2)}%)\`;
						resultDiv.className = "result-message incorrect";
						
						// Marquer quand même comme répondu
						if (!answered.has(questionId)) {
							answered.add(questionId);
						}
					}
					
					// Afficher le résultat et l'explication
					resultDiv.style.display = "block";
					explanationDiv.style.display = "block";
					
					// Désactiver le champ de saisie
					answerInput.disabled = true;
					
					// Activer le bouton "Terminer" si au moins une question est répondue
					if (answered.size > 0) {
						document.getElementById('finishBtn').disabled = false;
					}
					
					// Vérifier si toutes les questions sont complétées
					checkAllCompleted();
				}
				
				// =====================================================================
				// FONCTIONS POUR LES SIMULATIONS SPÉCIFIQUES AUX QUESTIONS
				// =====================================================================
				
				// Fonction pour relancer pour une question spécifique
				function relaunchForQuestion(questionId) {
					// Déterminer le type de simulation à lancer
					const mode = getSimulationMode(questionId);
					const quantity = getSimulationQuantity(questionId);
					
					// Lancer la simulation appropriée
					switchMode(mode);
					launch(mode, quantity);
					
					// Faire défiler jusqu'à la question
					document.querySelector(\`.question-card[data-id="\${questionId}"]\`).scrollIntoView({ behavior: 'smooth', block: 'center' });
				}
				
				// Fonction pour lancer une simulation pour une question spécifique
				function runSimulationFor(questionId) {
					// Déterminer le type de simulation à lancer
					const mode = getSimulationMode(questionId);
					const quantity = getSimulationQuantity(questionId);
					
					// Lancer la simulation appropriée
					switchMode(mode);
					launch(mode, quantity);
					
					// Réinitialiser le champ de saisie et le message de résultat
					const answerInput = document.getElementById(\`answer\${questionId}\`);
					if (answerInput) {
						answerInput.value = '';
						answerInput.disabled = false;
					}
					
					const resultDiv = document.getElementById(\`result\${questionId}\`);
					if (resultDiv) {
						resultDiv.style.display = 'none';
					}
					
					const explanationDiv = document.getElementById(\`explanation\${questionId}\`);
					if (explanationDiv) {
						explanationDiv.style.display = 'none';
					}
					
					// Faire défiler jusqu'à la question
					document.querySelector(\`.question-card[data-id="\${questionId}"]\`).scrollIntoView({ behavior: 'smooth', block: 'center' });
				}
				
				// =====================================================================
				// FONCTIONS UTILITAIRES
				// =====================================================================
				
				// Fonction auxiliaire pour déterminer le mode de simulation
				function getSimulationMode(questionId) {
					// Pour les exemples, nous utilisons une logique simple basée sur l'ID
					if (questionId.includes('fluct') || questionId.includes('comp') || questionId.includes('freq')) {
						return 'coin';
					} else {
						return 'dice';
					}
				}
				
				// Fonction auxiliaire pour déterminer la quantité de lancers
				function getSimulationQuantity(questionId) {
					// Pour les questions sur les fluctuations, utiliser différentes quantités
					if (questionId.includes('fluct')) {
						const options = [10, 100, 1000];
						return options[Math.floor(Math.random() * options.length)];
					} else if (questionId.includes('comp')) {
						return 1000; // Grand nombre pour la loi des grands nombres
					} else {
						// Valeur par défaut
						return 100;
					}
				}
				
				// Fonction auxiliaire pour déterminer le type de question
				function getQuestionType(questionId) {
					// Pour les exemples, nous utilisons une logique simple basée sur l'ID
					if (questionId.includes('freq')) {
						return 'pile';
					} else if (questionId.includes('face')) {
						return 'face';
					} else if (questionId.includes('pair')) {
						return 'even_dice';
					} else if (questionId.includes('impair')) {
						return 'odd_dice';
					} else {
						// Valeur par défaut
						return 'pile';
					}
				}
				
				// Vérifier si toutes les questions sont complétées
				function checkAllCompleted() {
					const totalQuestions = document.querySelectorAll('.question-card').length;
					
					if (answered.size === totalQuestions) {
						// On pourrait faire quelque chose de spécial quand toutes les questions sont répondues
						console.log("Toutes les questions ont été répondues!");
					}
				}

			});`,
				
				code: `<style>
				
			// =====================================================================
			// STYLES
			// =====================================================================

				
			:root {
				--primary: #4361ee;
				--secondary: #3f37c9;
				--accent: #4895ef;
				--light: #f8f9fa;
				--dark: #212529;
				--success: #4cc9f0;
				--warning: #f72585;
				--coin-size: 40px;
				--dice-size: 40px;
				--pile-color: #FFD700;
				--face-color: #FF8C00;
			}
			
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			
			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #a24b5f 0%, #182848 100%);
				color: var(--dark);
				line-height: 1.6;
				padding: 20px;
				min-height: 100vh;
			}
			
			.container {
				max-width: 1200px;
				margin: 0 auto;
				background-color: white;
				border-radius: 20px;
				padding: 30px;
				box-shadow: 0 20px 40px rgba(0,0,0,0.1);
			}
			
			h1 {
				text-align: center;
				color: #333;
				margin-bottom: 15px;
				font-size: 2.5em;
			}
			
			.subtitle {
				text-align: center;
				color: #666;
				margin-bottom: 20px;
				font-size: 1.1em;
			}
			
			.menu {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
			}
			
			button {
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				background-color: var(--primary);
				color: white;
				font-weight: 600;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.2s ease;
			}
			
			button:hover {
				background-color: var(--secondary);
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			}
			
			button:active {
				transform: translateY(0);
			}
			
			button.active {
				background-color: var(--accent);
			}
			
			.launch-buttons {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin: 20px 0;
			}
			
			.simulation-container {
				display: flex;
				flex-wrap: wrap;
				gap: 15px;
				justify-content: center;
				padding: 20px;
				min-height: 120px;
				border-radius: 12px;
				background-color: #e9ecef;
				margin-bottom: 20px;
			}
			
			/* Styles pour les pièces */
			.coin {
				width: var(--coin-size);
				height: var(--coin-size);
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
				font-size: 0.9rem;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
				transition: transform 0.5s ease, background-color 0.5s ease;
				background: radial-gradient(circle at 30% 30%, var(--pile-color), #DAA520);
				color: white;
				text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
			}
			
			.coin.tossing {
				animation: toss 0.5s ease;
			}
			
			.coin.pile {
				background: radial-gradient(circle at 30% 30%, var(--pile-color), #DAA520);
			}
			
			.coin.face {
				background: radial-gradient(circle at 30% 30%, var(--face-color), #D2691E);
			}
			
			@keyframes toss {
				0% { transform: rotateY(0) scale(1); }
				50% { transform: rotateY(180deg) scale(1.1); }
				100% { transform: rotateY(360deg) scale(1); }
			}
			
			/* Styles pour les dés */
			.die {
				width: var(--dice-size);
				height: var(--dice-size);
				background-color: white;
				border-radius: 10px;
				position: relative;
				display: flex;
				justify-content: center;
				align-items: center;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
				transition: transform 0.5s ease;
			}
			
			.die.rolling {
				animation: roll 0.5s ease;
			}
			
			@keyframes roll {
				0% { transform: rotate(0deg); }
				50% { transform: rotate(180deg) scale(1.1); }
				100% { transform: rotate(360deg); }
			}
			
			.pip {
				width: calc(var(--dice-size) * 0.15);
				height: calc(var(--dice-size) * 0.15);
				background-color: var(--primary);
				border-radius: 50%;
				position: absolute;
				transform: translate(-50%, -50%);
				box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
			}
			
			/* Styles pour les compteurs */
			.results {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				justify-content: center;
			}
			
			.counter-item {
				text-align: center;
				padding: 10px 15px;
				border-radius: 8px;
				background-color: #f8f9fa;
				border: 1px solid #e9ecef;
				min-width: 80px;
			}
			
			.counter-label {
				font-weight: 600;
				color: var(--dark);
				margin-bottom: 5px;
			}
			
			.counter-value {
				font-size: 1.2rem;
				font-weight: bold;
				color: var(--primary);
			}
			
			/* Styles pour le mode */
			.coin-mode, .dice-mode {
				display: none;
			}
			
			.coin-mode.active, .dice-mode.active {
				display: block;
			}
			
			/* Styles pour les questions */
			.questions-container {
				margin-top: 30px;
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
				gap: 20px;
			}
			
			.question-card {
				background: #f8fbff;
				border: 2px solid #e8f4ff;
				border-radius: 15px;
				padding: 20px;
				transition: all 0.3s ease;
				position: relative;
				overflow: hidden;
			}
			
			.question-card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 4px;
				background: linear-gradient(90deg, #a24b5f 0%, #182848 100%);
			}
			
			.question-header {
				font-size: 1.2em;
				font-weight: bold;
				color: #333;
				margin-bottom: 15px;
			}
			
			.question-text {
				background: #fff;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 15px;
				box-shadow: 0 2px 5px rgba(0,0,0,0.05);
				font-weight: bold;
				color: #555;
			}
			
			.options-container {
				display: grid;
				grid-template-columns: repeat(3, 1fr);
				gap: 10px;
				margin-bottom: 15px;
			}
			
			.option-btn {
				padding: 10px;
				border: none;
				border-radius: 5px;
				font-weight: bold;
				cursor: pointer;
				transition: all 0.3s;
				color: white;
			}
			
			.option-a {
				background: #a24b5f;
			}
			
			.option-a:hover {
				background: #3a5ba3;
			}
			
			.option-b {
				background: #6a88ca;
			}
			
			.option-b:hover {
				background: #5a76b5;
			}
			
			.option-c {
				background: #8ba4da;
			}
			
			.option-c:hover {
				background: #7a91c5;
			}
			
			.result-message {
				margin-top: 10px;
				padding: 10px;
				border-radius: 8px;
				font-weight: bold;
				text-align: center;
				display: none;
			}
			
			.correct {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			
			.incorrect {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			
			.explanation {
				margin-top: 10px;
				padding: 10px;
				background: #e7f3ff;
				border: 1px solid #b8daff;
				color: #004085;
				border-radius: 8px;
				font-size: 0.9em;
				display: none;
			}
			</style>
			
			// =====================================================================
			// CODE HTML
			// =====================================================================

			
			<div class="score-board">
				Score: <span class="score" id="score">0</span> / <span id="total">6</span>
				<button id="fullscreenBtn" title="Mode plein écran">
			</div>
			
			<div class="container">
				<h1>Simulation Probabiliste et QCM</h1>
				<div class="subtitle">Expérimentez avec des lancers aléatoires et répondez aux questions sur les probabilités</div>
				
				<div class="menu">
					<button id="coinModeBtn" class="active" onclick="switchMode('coin')">Pile ou Face</button>
					<button id="diceModeBtn" onclick="switchMode('dice')">Dé à 6 faces</button>
				</div>
				
				<div class="coin-mode active">
					<div class="launch-buttons">
						<button onclick="launch('coin', 1)">1 lancer</button>
						<button onclick="launch('coin', 10)">10 lancers</button>
						<button onclick="launch('coin', 50)">50 lancers</button>
						<button onclick="launch('coin', 100)">100 lancers</button>
						<button onclick="launch('coin', 1000)">1000 lancers</button>
					</div>
					
					<div id="coin-container" class="simulation-container">
						<!-- Les pièces seront créées ici -->
					</div>
					
					<div class="results" id="coin-results">
						<div class="counter-item">
							<div class="counter-label">Pile</div>
							<div class="counter-value" id="pileCount">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">Face</div>
							<div class="counter-value" id="faceCount">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">Total</div>
							<div class="counter-value" id="coinTotal">0</div>
						</div>
					</div>
				</div>
				
				<div class="dice-mode">
					<div class="launch-buttons">
						<button onclick="launch('dice', 1)">1 lancer</button>
						<button onclick="launch('dice', 10)">10 lancers</button>
						<button onclick="launch('dice', 50)">50 lancers</button>
						<button onclick="launch('dice', 100)">100 lancers</button>
						<button onclick="launch('dice', 1000)">1000 lancers</button>
					</div>
					
					<div id="dice-container" class="simulation-container">
						<!-- Les dés seront créés ici -->
					</div>
					
					<div class="results" id="dice-results">
						<div class="counter-item">
							<div class="counter-label">1</div>
							<div class="counter-value" id="result1Count">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">2</div>
							<div class="counter-value" id="result2Count">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">3</div>
							<div class="counter-value" id="result3Count">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">4</div>
							<div class="counter-value" id="result4Count">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">5</div>
							<div class="counter-value" id="result5Count">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">6</div>
							<div class="counter-value" id="result6Count">0</div>
						</div>
						<div class="counter-item">
							<div class="counter-label">Total</div>
							<div class="counter-value" id="diceTotal">0</div>
						</div>
					</div>
				</div>
				
			// =====================================================================
			// TYPES DE QUESTIONS
			// =====================================================================
					        
					<!-- Conteneur de questions -->
					<div class="questions-container">
						<!-- EXEMPLE 1: Question à choix multiples (Probabilités) -->
						<div class="question-card" data-id="proba1" data-answer="b">
							<div class="question-header">Exemple 1: Probabilité avec un dé</div>
							<div class="question-text">
								Avec un dé à 6 faces équilibré, quelle est la probabilité d'obtenir un nombre pair (2, 4 ou 6) ?
								## ALTERNATIVES : obtenir un nombre impair / obtenir un nombre ≥ 4 / obtenir un nombre < 2 / etc...
							</div>
							<div class="options-container">
								<button class="option-btn option-a" onclick="checkAnswer('proba1', 'a')">1/3</button>
								<button class="option-btn option-b" onclick="checkAnswer('proba1', 'b')">1/2</button>
								<button class="option-btn option-c" onclick="checkAnswer('proba1', 'c')">2/3</button>
							</div>
							<div class="result-message" id="resultproba1"></div>
							<div class="explanation" id="explanationproba1">
								Avec un dé à 6 faces, il y a 3 résultats pairs (2, 4, 6) sur 6 résultats possibles. La probabilité est donc de 3/6 = 1/2 = 50%. Avec un grand nombre de lancers, la fréquence d'apparition des nombres pairs devrait se rapprocher de 50%.
							</div>
							<button class="option-btn" onclick="relaunchForQuestion('proba1')" style="margin-top: 10px; width: 100%;">Relancer pour vérifier</button>
						</div>
						
						<!-- EXEMPLE 2: Calcul de fréquence avec saisie -->
						<div class="question-card" data-id="freq1" data-answer="0.5">
							<div class="question-header">Exemple 2: Calcul de fréquence - Pile</div>
							<div class="question-text">
								En utilisant la simulation "Pile ou Face" en haut de la page, calculez la fréquence d'apparition de "Pile".
								## ALTERNATIVES : frequence de face
								<br><br>
								1. Cliquez sur le bouton "Lancer pour cette question"
								2. Observez les résultats dans la zone de simulation
								3. Calculez la fréquence de Pile (nombre de Pile divisé par le total)
								4. Entrez votre réponse sous forme décimale (ex: 0.25 pour 25%)
							</div>
							<div class="simulation-btn-container" style="margin-bottom: 15px;">
								<button class="option-btn" onclick="runSimulationFor('freq1')" style="width: 100%;">Lancer pour cette question</button>
							</div>
							<div style="margin-bottom: 15px;">
								<label for="answerfreq1" style="display: block; margin-bottom: 5px; font-weight: bold;">Votre réponse (fréquence de Pile):</label>
								<input type="number" id="answerfreq1" step="0.01" min="0" max="1" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
							</div>
							<button class="option-btn" onclick="checkInputAnswer('freq1')" style="width: 100%;">Vérifier ma réponse</button>
							<div class="result-message" id="resultfreq1"></div>
							<div class="explanation" id="explanationfreq1">
								La fréquence observée se calcule en divisant le nombre d'occurrences (nombre de "Pile") par le nombre total d'essais. Si vous avez obtenu X "Pile" sur Y lancers, la fréquence est X/Y. Pour une pièce équilibrée, avec un grand nombre de lancers, cette fréquence devrait s'approcher de 0.5 (50%).
							</div>
						</div>
						
						<!-- EXEMPLE 3: Question sur la comparaison fréquence/probabilité -->
						<div class="question-card" data-id="comp1" data-answer="b">
							<div class="question-header">Exemple 3: Fréquence et Probabilité</div>
							<div class="question-text">
								Si on lance une pièce équilibrée un très grand nombre de fois, quelle devrait être la fréquence d'apparition de "Pile" ?
								## ALTERNATIVES : quelle devrait être la fréquence d'apparition de "Face" ?
							</div>
							<div class="options-container">
								<button class="option-btn option-a" onclick="checkAnswer('comp1', 'a')">Exactement 50%</button>
								<button class="option-btn option-b" onclick="checkAnswer('comp1', 'b')">Proche de 50%</button>
								<button class="option-btn option-c" onclick="checkAnswer('comp1', 'c')">Entre 25% et 75%</button>
							</div>
							<div class="result-message" id="resultcomp1"></div>
							<div class="explanation" id="explanationcomp1">
								La probabilité théorique d'obtenir "Pile" avec une pièce équilibrée est de 50%. Pour un très grand nombre de lancers, la fréquence observée se rapproche de cette probabilité, mais il existe toujours des fluctuations. Elle sera donc proche de 50%, mais rarement exactement 50%.
							</div>
							<button class="option-btn" onclick="relaunchForQuestion('comp1')" style="margin-top: 10px; width: 100%;">Relancer pour vérifier</button>
						</div>
						
						<!-- EXEMPLE 4: Question sur les fluctuations d'échantillonnage -->
						<div class="question-card" data-id="fluct1" data-answer="c">
							<div class="question-header">Exemple 4: Fluctuations d'échantillonnage</div>
							<div class="question-text">
								Quand observe-t-on généralement les plus grandes fluctuations entre la fréquence observée et la probabilité ?
								## ALTERNATIVES : les plus petites fluctuations ?
							</div>
							<div class="options-container">
								<button class="option-btn option-a" onclick="checkAnswer('fluct1', 'a')">Avec un très grand nombre de lancers</button>
								<button class="option-btn option-b" onclick="checkAnswer('fluct1', 'b')">Le nombre de lancers n'a pas d'influence</button>
								<button class="option-btn option-c" onclick="checkAnswer('fluct1', 'c')">Avec un petit nombre de lancers</button>
							</div>
							<div class="result-message" id="resultfluct1"></div>
							<div class="explanation" id="explanationfluct1">
								Les fluctuations d'échantillonnage sont plus importantes avec un petit nombre d'essais. Plus le nombre d'essais augmente, plus la fréquence observée se rapproche de la probabilité. Essayez de comparer les résultats entre 10 et 1000 lancers pour observer cette différence.
							</div>
							<button class="option-btn" onclick="relaunchForQuestion('fluct1')" style="margin-top: 10px; width: 100%;">Relancer pour vérifier</button>
						</div>
					</div>
					
					<!-- Bouton Terminer -->
					<button id="finishBtn" class="finish-btn" disabled>Terminer l'activité</button>
					
					<!-- Modal de résultats -->
					<div id="modalOverlay" class="modal-overlay">
						<div id="resultsContainer" class="results-container">
							<span class="close-modal" id="closeModal">&times;</span>
							<h2>Résultats du test</h2>
							<div class="final-score">
								<span id="finalScore">0</span>/<span id="finalTotalQuestions">4</span>
							</div>
							<div id="resultMessage" class="result-message">
								<!-- Message de réussite ou d'échec affiché ici -->
							</div>
						</div>
					</div>
				</div>

			</div>`
			},				
							

            
            
            match: {
                title: "Appariement par Glisser-Déposer",
                description: "Un template pour créer des exercices d'appariement. L'apprenant doit associer des termes à leurs définitions par glisser-déposer.",
                features: [
                    "Association terme-définition",
                    "Interface glisser-déposer intuitive",
                    "Vérification automatique des associations",
                    "Réinitialisation des exercices",
                    "Feedback visuel"
                ],
                icon: "fas fa-link",
                previewHtml: `
                <div class="preview-card">
                    <div class="preview-header">
                        <span>Appariement par Glisser-Déposer</span>
                        <div class="preview-icon">🔗</div>
                    </div>
                    <div class="preview-body">
                        <div class="preview-description">
                            Associez chaque terme à sa définition correspondante par glisser-déposer.
                        </div>
                        
                        <div class="match-container">
                            <div class="match-column">
                                <div class="match-column-title">Termes</div>
                                <div class="match-terms">
                                    <div class="match-term">HTML</div>
                                    <div class="match-term">CSS</div>
                                    <div class="match-term">JavaScript</div>
                                </div>
                            </div>
                            <div class="match-column">
                                <div class="match-column-title">Définitions</div>
                                <div class="match-definitions">
                                    <div class="match-definition">
                                        <div class="match-definition-term">HTML</div>
                                        <div class="match-definition-content">Langage de balisage pour créer des pages web</div>
                                    </div>
                                    <div class="match-definition">
                                        <div class="match-definition-content">Langage de style pour mettre en forme les pages web</div>
                                    </div>
                                    <div class="match-definition">
                                        <div class="match-definition-content">Langage de programmation pour rendre les pages web interactives</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="preview-btn preview-btn-primary">Vérifier mes associations</button>
                            <button class="preview-btn preview-btn-secondary">Réinitialiser</button>
                        </div>
                        
                        <div class="hint-box">
                            <span class="hint-icon">💡</span>
                            <span>Indice : HTML est l'acronyme de HyperText Markup Language.</span>
                        </div>
                    </div>
                </div>
                `,
                
                jsCode: `// // ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE APPARIEMENT MATCH : PRIORITE OBLIGATOIRE SI CHOISIE
            document.addEventListener('DOMContentLoaded', function() {
                // Initialisation de l'appariement
                initMatching();
            });
            
            function initMatching() {
                // Initialiser le drag and drop pour tous les exercices
                document.querySelectorAll('.exercise-card').forEach(exercise => {
                    const exerciseId = exercise.getAttribute('data-exercise');
                    const terms = exercise.querySelectorAll('.term-block');
                    const definitions = exercise.querySelectorAll('.definition-zone');
                    
                    // Mélanger les termes au début
                    shuffleTerms(exerciseId);
                    
                    // Configurer les événements de drag and drop
                    terms.forEach(term => {
                        term.addEventListener('dragstart', handleDragStart);
                        term.addEventListener('dragend', handleDragEnd);
                    });
                    
                    definitions.forEach(definition => {
                        definition.addEventListener('dragover', handleDragOver);
                        definition.addEventListener('dragenter', handleDragEnter);
                        definition.addEventListener('dragleave', handleDragLeave);
                        definition.addEventListener('drop', handleDrop);
                    });
                });
            }
            
            function shuffleTerms(exerciseId) {
                const termsContainer = document.getElementById('terms' + exerciseId);
                const terms = Array.from(termsContainer.children);
                
                // Mélanger les termes
                for (let i = terms.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    termsContainer.appendChild(terms[j]);
                }
            }
            
            // Gestionnaires d'événements pour le drag and drop
            function handleDragStart(e) {
                this.classList.add('dragging');
                e.dataTransfer.setData('text/plain', this.outerHTML);
                e.dataTransfer.setData('application/json', JSON.stringify({
                    pair: this.getAttribute('data-pair')
                }));
                e.dataTransfer.effectAllowed = 'move';
            }
            
            function handleDragEnd(e) {
                this.classList.remove('dragging');
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
            
            function handleDragEnter(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            }
            
            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                // Récupérer le terme déplacé
                const termHTML = e.dataTransfer.getData('text/plain');
                const termData = JSON.parse(e.dataTransfer.getData('application/json'));
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = termHTML;
                const term = tempDiv.firstChild;
                
                // Vérifier si la zone de définition a déjà un terme
                const existingTerm = this.querySelector('.term-block');
                if (existingTerm) {
                    // Échanger avec le terme existant
                    const draggingElement = document.querySelector('.dragging');
                    if (draggingElement) {
                        // Récupérer le parent du terme en cours de déplacement
                        const dragParent = draggingElement.parentNode;
                        // Déplacer le terme existant vers l'emplacement d'origine
                        dragParent.appendChild(existingTerm);
                        // Supprimer le terme en cours de déplacement
                        draggingElement.remove();
                    }
                } else {
                    // Supprimer le terme original
                    const draggingElement = document.querySelector('.dragging');
                    if (draggingElement) {
                        draggingElement.remove();
                    }
                }
                
                // Ajouter le terme à la zone de définition
                this.insertBefore(term, this.querySelector('.definition-text'));
                
                // Reconfigurer les événements de drag and drop pour le terme déplacé
                term.addEventListener('dragstart', handleDragStart);
                term.addEventListener('dragend', handleDragEnd);
            }
            
            function checkMatching(exerciseId) {
                const definitionsContainer = document.getElementById('definitions' + exerciseId);
                const definitionZones = definitionsContainer.querySelectorAll('.definition-zone');
                let allCorrect = true;
                let allMatched = true;
                
                // Vérifier que toutes les définitions ont un terme
                definitionZones.forEach(zone => {
                    const term = zone.querySelector('.term-block');
                    if (!term) {
                        allMatched = false;
                    } else {
                        // Vérifier que le terme correspond à la définition
                        const termPair = term.getAttribute('data-pair');
                        const zonePair = zone.getAttribute('data-pair');
                        if (termPair !== zonePair) {
                            allCorrect = false;
                        }
                    }
                });
                
                // Afficher le résultat
                const resultDiv = document.getElementById('result' + exerciseId);
                
                if (!allMatched) {
                    resultDiv.innerHTML = 'Veuillez associer tous les termes à leurs définitions.';
                    resultDiv.className = 'result incomplete';
                    resultDiv.style.display = 'block';
                    return;
                }
                
                if (allCorrect) {
                    resultDiv.innerHTML = '<span class="success-icon">✓</span> Correct! Toutes les associations sont bonnes.';
                    resultDiv.className = 'result correct';
                    incrementScore();
                    markAsSolved(exerciseId);
                } else {
                    resultDiv.innerHTML = '<span class="error-icon">✗</span> Incorrect. Vérifiez vos associations et réessayez.';
                    resultDiv.className = 'result incorrect';
                }
                resultDiv.style.display = 'block';
                
                // Vérifier si tous les exercices sont complétés
                checkAllCompleted();
            }
            
            function resetExercise(exerciseId) {
                // Récupérer tous les termes dans les définitions
                const definitionsContainer = document.getElementById('definitions' + exerciseId);
                const terms = definitionsContainer.querySelectorAll('.term-block');
                const termsContainer = document.getElementById('terms' + exerciseId);
                
                // Remettre tous les termes dans le conteneur d'origine
                terms.forEach(term => {
                    termsContainer.appendChild(term);
                });
                
                // Mélanger les termes
                shuffleTerms(exerciseId);
                
                // Cacher le message de résultat
                const resultDiv = document.getElementById('result' + exerciseId);
                resultDiv.style.display = 'none';
            }`,
                
                code: `<div class="exercise-card" data-exercise="1">
    <div class="question-header">
        <span class="question-icon">🔗</span>
        <span>Exercice 1: Associez les termes</span>
    </div>
    
    <div class="matching-area">
        <div class="left-column">
            <h3>Termes</h3>
            <div id="terms1">
                <div class="term-block" draggable="true" data-pair="1">HTML</div>
                <div class="term-block" draggable="true" data-pair="2">CSS</div>
                <div class="term-block" draggable="true" data-pair="3">JavaScript</div>
            </div>
        </div>
        
        <div class="right-column">
            <h3>Définitions</h3>
            <div id="definitions1">
                <div class="definition-zone" data-pair="1">
                    <div class="definition-text">Langage de balisage pour créer des pages web</div>
                </div>
                <div class="definition-zone" data-pair="2">
                    <div class="definition-text">Langage de style pour mettre en forme les pages web</div>
                </div>
                <div class="definition-zone" data-pair="3">
                    <div class="definition-text">Langage de programmation pour rendre les pages web interactives</div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="check-btn" onclick="checkMatching(1)">Vérifier mes associations</button>
    <button class="reset-btn" onclick="resetExercise(1)">Réinitialiser</button>
    <div class="result" id="result1"></div>
    <div class="hint" id="hint1">💡 HTML est le langage de base pour structurer une page web.</div>
</div>`
            },
            
            
            calcul: {
                title: "Exercices de Calcul",
                description: "Un template pour créer des exercices de calcul mathématique. L'apprenant doit résoudre des problèmes mathématiques et entrer ses réponses.",
                features: [
                    "Vérification automatique des réponses numériques",
                    "Tolérance pour les arrondis",
                    "Affichage des formules",
                    "Feedback détaillé",
                    "Plusieurs tentatives possibles"
                ],
                icon: "fas fa-calculator",
                previewHtml: `
                <div class="preview-card">
                    <div class="preview-header">
                        <span>Exercice de Calcul</span>
                        <div class="preview-icon">🔢</div>
                    </div>
                    <div class="preview-body">
                        <div class="preview-description">
                            Résolvez cet exercice de calcul en utilisant la formule indiquée.
                        </div>
                        
                        <div class="calcul-container">
                            <div class="calcul-question">
                                Calculez l'aire d'un cercle de rayon 5 cm.
                            </div>
                            
                            <div class="calcul-data">
                                <div class="calcul-row">
                                    <span class="calcul-label">Formule:</span>
                                    <span class="calcul-value">A = π × r²</span>
                                </div>
                                <div class="calcul-row">
                                    <span class="calcul-label">Où:</span>
                                    <span class="calcul-value">r est le rayon du cercle</span>
                                </div>
                                <div class="calcul-row">
                                    <span class="calcul-label">Rayon:</span>
                                    <span class="calcul-value">5 cm</span>
                                </div>
                            </div>
                            
                            <div class="calcul-input-group">
                                <label class="calcul-input-label">Votre réponse (cm²):</label>
                                <input type="number" class="calcul-input" placeholder="Entrez votre réponse" value="78.54">
                                
                                <div class="button-group">
                                    <button class="preview-btn preview-btn-primary">Vérifier</button>
                                </div>
                                
                                <div class="result-box success">
                                    <span class="result-icon">✓</span>
                                    <span>Correct ! L'aire du cercle est bien 78.54 cm²</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `,
                
                jsCode: `// // ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE CALCUL : PRIORITE OBLIGATOIRE SI CHOISIE
            document.addEventListener('DOMContentLoaded', function() {
                // Initialisation des exercices de calcul
                initCalculExercises();
            });
            
            function initCalculExercises() {
                // Configurer tous les exercices de calcul
                document.querySelectorAll('.exercise-card').forEach(exercise => {
                    const exerciseId = exercise.getAttribute('data-exercise');
                    const answerInput = exercise.querySelector('#answer' + exerciseId);
                    const checkBtn = exercise.querySelector('.check-btn');
                    const hintBtn = exercise.querySelector('.hint-btn');
                    
                    // Ajouter les écouteurs d'événements
                    if (answerInput) {
                        answerInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                const answer = parseFloat(answerInput.getAttribute('data-answer'));
                                checkCalculAnswer(exerciseId, answer);
                            }
                        });
                    }
                    
                    if (checkBtn) {
                        checkBtn.addEventListener('click', function() {
                            const answer = parseFloat(this.getAttribute('data-answer'));
                            checkCalculAnswer(exerciseId, answer);
                        });
                    }
                    
                    if (hintBtn) {
                        hintBtn.addEventListener('click', function() {
                            const hintDiv = document.getElementById('hint' + exerciseId);
                            if (hintDiv) {
                                hintDiv.style.display = hintDiv.style.display === 'block' ? 'none' : 'block';
                            }
                        });
                    }
                });
            }
            
            function checkCalculAnswer(exerciseId, correctAnswer) {
                const answerInput = document.getElementById('answer' + exerciseId);
                const resultDiv = document.getElementById('result' + exerciseId);
                const hintDiv = document.getElementById('hint' + exerciseId);
                
                if (!answerInput || !resultDiv) return;
                
                const userAnswer = parseFloat(answerInput.value.replace(',', '.'));
                
                if (isNaN(userAnswer)) {
                    resultDiv.innerHTML = '<span class="error-icon">⚠️</span> Veuillez entrer un nombre valide.';
                    resultDiv.className = 'result error';
                    resultDiv.style.display = 'block';
                    return;
                }
                
                // Tolérance pour les arrondis (par défaut 1%)
                const tolerance = Math.abs(correctAnswer) * 0.01;
                const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
                
                if (isCorrect) {
                    resultDiv.innerHTML = '<span class="success-icon">✓</span> Correct! La réponse est bien ' + correctAnswer + '.';
                    resultDiv.className = 'result correct';
                    resultDiv.style.display = 'block';
                    
                    // Masquer l'indice
                    if (hintDiv) {
                        hintDiv.style.display = 'none';
                    }
                    
                    // Désactiver l'input et le bouton
                    answerInput.disabled = true;
                    const checkBtn = document.querySelector('.exercise-card[data-exercise="' + exerciseId + '"] .check-btn');
                    if (checkBtn) {
                        checkBtn.disabled = true;
                    }
                    
                    // Mettre à jour le score
                    incrementScore();
                    markAsSolved(exerciseId);
                    
                    // Vérifier si tous les exercices sont complétés
                    checkAllCompleted();
                } else {
                    resultDiv.innerHTML = '<span class="error-icon">✗</span> Incorrect. Vérifiez votre calcul.';
                    resultDiv.className = 'result incorrect';
                    resultDiv.style.display = 'block';
                    
                    // Afficher l'indice
                    if (hintDiv) {
                        hintDiv.style.display = 'block';
                    }
                }
            }
            
            // Fonction pour générer des calculs aléatoires
            function generateRandomCalcul(type, min, max) {
                const a = Math.floor(Math.random() * (max - min + 1)) + min;
                const b = Math.floor(Math.random() * (max - min + 1)) + min;
                
                let result, expression;
                
                switch (type) {
                    case 'add':
                        result = a + b;
                        expression = a + ' + ' + b;
                        break;
                    case 'subtract':
                        result = a - b;
                        expression = a + ' - ' + b;
                        break;
                    case 'multiply':
                        result = a * b;
                        expression = a + ' × ' + b;
                        break;
                    case 'divide':
                        // Pour éviter les divisions par zéro et obtenir des résultats entiers
                        const divisor = b === 0 ? 1 : b;
                        const dividend = a * divisor;
                        result = a;
                        expression = dividend + ' ÷ ' + divisor;
                        break;
                    default:
                        result = a + b;
                        expression = a + ' + ' + b;
                }
                
                return {
                    expression: expression,
                    result: result
                };
            }`,
                
                code: `<div class="exercise-card" data-exercise="1">
    <div class="question-header">
        <span class="question-icon">🔢</span>
        <span>Exercice 1: Calcul d'aire</span>
    </div>
    
    <div class="question-text">
        Calculez l'aire d'un cercle de rayon 5 cm.
    </div>
    
    <div class="formula-box">
        <div class="formula">A = π × r²</div>
        <div class="formula-explanation">Où r est le rayon du cercle</div>
    </div>
    
    <div class="input-group">
        <label>Votre réponse (cm²):</label>
        <input type="number" id="answer1" placeholder="Entrez votre réponse">
        <button class="check-btn" onclick="checkAnswer(1, 78.54)">Vérifier</button>
    </div>
    
    <div class="result" id="result1"></div>
    <div class="hint" id="hint1">💡 Remplacez r par 5 dans la formule et calculez. Utilisez 3.14159 pour π.</div>
</div>`
            },
            
            
            
            
            
			python: {
				title: "Exercices de Programmation Python",
				description: "Un template pour créer des exercices de programmation Python interactifs. L'apprenant peut écrire et exécuter du code Python directement dans le navigateur.",
				features: [
					"Éditeur de code intégré",
					"Exécution de code Python en temps réel",
					"Vérification automatique des résultats",
					"Affichage de la sortie attendue",
					"Feedback détaillé sur les erreurs"
				],
				icon: "fab fa-python",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #a24b5f;">Défi Python: Affichage simple</h3>
						<p style="margin-bottom: 15px;">Écrivez un programme qui affiche "Hello, Python!" à l'écran.</p>
						
						<div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
							<div style="font-weight: bold; margin-bottom: 5px;">Sortie attendue:</div>
							<pre style="background: #282c34; color: #abb2bf; padding: 10px; border-radius: 5px; margin: 0;">Hello, Python!</pre>
						</div>
						
						<div style="margin-bottom: 15px;">
							<div style="background: #282c34; color: #abb2bf; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-family: monospace; position: relative;">
								<div style="position: absolute; top: 5px; right: 5px; background: #ea6687; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Python</div>
								<pre style="margin: 0; font-family: monospace; line-height: 1.5;">print("Hello, Python!")</pre>
							</div>
						</div>
						
						<div style="background: #282c34; color: #abb2bf; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-family: monospace;">
							<div style="font-weight: bold; margin-bottom: 5px; color: white;">Sortie:</div>
							<pre style="margin: 0; font-family: monospace;">Hello, Python!</pre>
						</div>
						
						<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 5px;">
							✅ Correct ! Votre code produit la sortie attendue.
						</div>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE PYTHON : PRIORITE OBLIGATOIRE SI CHOISIE
				document.addEventListener('DOMContentLoaded', function() {
					// Initialisation des exercices Python
					initPythonExercises();
					
					// Charger Skulpt
					configureSkulpt();
				});

				// Initialiser les éditeurs CodeMirror pour le template Python
				function initCodeMirrorEditors() {
					// Variable globale pour stocker les instances CodeMirror
					window.codeMirrorEditors = {};
					
					document.querySelectorAll('.code-editor').forEach(textArea => {
						const id = textArea.id;
						const editor = CodeMirror.fromTextArea(textArea, {
							lineNumbers: true,
							mode: 'python',
							theme: 'default',
							indentUnit: 4,
							indentWithTabs: false,
							lineWrapping: true,
							autoCloseBrackets: true,
							matchBrackets: true
						});
						
						// Définir une hauteur minimale pour l'éditeur (200px)
						editor.setSize(null, 200);
						
						// Option: Ajuster automatiquement la hauteur en fonction du contenu
						editor.on("change", function() {
							const lineCount = editor.lineCount();
							const minHeight = 200; // Hauteur minimale en pixels
							const lineHeight = 20; // Hauteur approximative d'une ligne en pixels
							const newHeight = Math.max(minHeight, lineCount * lineHeight);
							editor.setSize(null, newHeight);
						});
						
						window.codeMirrorEditors[id] = editor;
					});
					
					// Ajuster également les hauteurs minimales des zones de sortie
					document.querySelectorAll('.output').forEach(output => {
						output.style.minHeight = '100px';
					});
				}
				
				
				// =====================================================================
				## ⚠️ PRIORITE HAUTE : RESPECTER LES TYPES DE CODE CHOISIS python.codeTypes
				// =====================================================================	
				
				// Initialiser les exercices Python
				function initPythonExercises() {
					document.querySelectorAll('.exercise-card').forEach(exercise => {
						const exerciseId = exercise.getAttribute('data-exercise');
						const runBtn = exercise.querySelector('.run-btn');
						const clearBtn = exercise.querySelector('.clear-btn');
						const hintBtn = exercise.querySelector('.hint-btn');
						
						if (runBtn) {
							runBtn.addEventListener('click', function() {
								const editor = codeMirrorEditors['editor' + exerciseId];
								const outputDiv = document.getElementById('output' + exerciseId);
								
								if (editor && outputDiv) {
									// Exécuter le code Python
									runPythonCode(editor.getValue(), outputDiv, exerciseId);
								}
							});
						}
						
						if (clearBtn) {
							clearBtn.addEventListener('click', function() {
								const editor = codeMirrorEditors['editor' + exerciseId];
								const outputDiv = document.getElementById('output' + exerciseId);
								
								if (editor) {
									editor.setValue('# Écrivez votre code ici\\n');
								}
								
								if (outputDiv) {
									outputDiv.innerHTML = '';
								}
								
								// Masquer le résultat et l'indice
								const resultDiv = document.getElementById('result' + exerciseId);
								const hintDiv = document.getElementById('hint' + exerciseId);
								
								if (resultDiv) {
									resultDiv.style.display = 'none';
								}
								
								if (hintDiv) {
									hintDiv.style.display = 'none';
								}
							});
						}
						
						if (hintBtn) {
							hintBtn.addEventListener('click', function() {
								const hintDiv = document.getElementById('hint' + exerciseId);
								if (hintDiv) {
									hintDiv.style.display = hintDiv.style.display === 'block' ? 'none' : 'block';
								}
							});
						}
					});
				}
				
				// Configuration de Skulpt pour l'exécution Python
				function configureSkulpt() {
					Sk.configure({
						output: function(text) {
							// La sortie de print() sera retournée par cette fonction
							return text;
						},
						read: function(filename) {
							// Chargement de modules Python
							if (Sk.builtinFiles && Sk.builtinFiles["files"][filename]) {
								return Sk.builtinFiles["files"][filename];
							}
							throw "Fichier non trouvé: " + filename;
						},
						execLimit: 5000, // Limite de temps d'exécution en millisecondes
						inputfun: function(prompt) {
							// Gérer la fonction input()
							return window.prompt(prompt);
						}
					});
				}
				
				// ===========================================================
				// MODIFICATION 1: Affichage correct des lignes de code Python
				// ===========================================================
				
				// Exécuter le code Python
				function runPythonCode(code, outputDiv, exerciseId) {
					// Vider la sortie précédente
					outputDiv.innerHTML = '';
					
					// Fonction de sortie pour capturer print()
					function outf(text) {
						// Remplacer les retours à la ligne par des balises <br>
						text = text.replace(/\n/g, "<br>");
						outputDiv.innerHTML += text;
					}
					
					// Configurer Skulpt pour cet exercice
					Sk.configure({
						output: outf,
						inputfun: function(prompt) {
							const result = window.prompt(prompt);
							// Ajouter un retour à la ligne après chaque input
							outputDiv.innerHTML += "<br>";
							return result;
						}
					});
					
					// Exécuter le code Python
					try {
						Sk.importMainWithBody("<stdin>", false, code, true);
						
						// Vérifier le résultat par rapport à la sortie attendue
						checkPythonResult(exerciseId);
						
						// Marquer l'exercice comme répondu
						answered.add(parseInt(exerciseId));
						
						// Mettre à jour le bouton de fin
						updateFinishButton();
						
						// Sauvegarder l'état
						saveState();
						
					} catch (e) {
						outputDiv.innerHTML += '<div class="error">Erreur: ' + e.toString() + '</div>';
					}
				}
				
				// ===========================================================
				// MODIFICATION 2: Amélioration de l'indentation dans l'éditeur
				// ===========================================================
				
				// Initialiser les éditeurs CodeMirror
				function initCodeMirrorEditors() {
					// Variable globale pour stocker les instances CodeMirror
					window.codeMirrorEditors = {};
					
					document.querySelectorAll('.code-editor').forEach(textArea => {
						const id = textArea.id;
						const editor = CodeMirror.fromTextArea(textArea, {
							lineNumbers: true,
							mode: 'python',
							theme: 'default',
							indentUnit: 4,
							indentWithTabs: false,
							lineWrapping: true,
							autoCloseBrackets: true,
							matchBrackets: true,
							smartIndent: true,
							extraKeys: {
								"Tab": function(cm) {
									// Indenter avec des espaces plutôt que des tabulations
									if (cm.somethingSelected()) {
										cm.indentSelection("add");
									} else {
										cm.replaceSelection("    ", "end");
									}
								},
								"Enter": function(cm) {
									// Préserver l'indentation à la nouvelle ligne
									var cursor = cm.getCursor();
									var line = cm.getLine(cursor.line);
									var indentation = line.match(/^\s*/)[0];
									
									// Ajouter une indentation supplémentaire si la ligne se termine par ":"
									if (line.trim().endsWith(":")) {
										indentation += "    ";
									}
									
									cm.replaceSelection("\n" + indentation);
									return true;
								}
							}
						});
						
						// Définir une hauteur minimale pour l'éditeur (200px)
						editor.setSize(null, 200);
						
						// Option: Ajuster automatiquement la hauteur en fonction du contenu
						editor.on("change", function() {
							const lineCount = editor.lineCount();
							const minHeight = 200; // Hauteur minimale en pixels
							const lineHeight = 20; // Hauteur approximative d'une ligne en pixels
							const newHeight = Math.max(minHeight, lineCount * lineHeight);
							editor.setSize(null, newHeight);
						});
						
						window.codeMirrorEditors[id] = editor;
					});
					
					// Ajuster également les hauteurs minimales des zones de sortie
					document.querySelectorAll('.output').forEach(output => {
						output.style.minHeight = '100px';
					});
				}				
				
				
				// Vérifier le résultat de l'exercice Python
				function checkPythonResult(exerciseId) {
					const outputDiv = document.getElementById('output' + exerciseId);
					const resultDiv = document.getElementById('result' + exerciseId);
					const expectedOutputElement = document.querySelector('.exercise-card[data-exercise="' + exerciseId + '"] .expected-output pre');
					const exerciseCard = document.querySelector('.exercise-card[data-exercise="' + exerciseId + '"]');
					
					if (!outputDiv || !resultDiv || !expectedOutputElement || !exerciseCard) return;
					
					// Récupérer la sortie attendue et la sortie actuelle
					const expectedOutput = expectedOutputElement.textContent.trim();
					const actualOutput = outputDiv.textContent.trim();
					
					// Comparer les sorties
					if (actualOutput === expectedOutput) {
						resultDiv.innerHTML = '<span class="success-icon">✓</span> Correct! Votre code produit la sortie attendue.';
						resultDiv.className = 'result correct';
						resultDiv.style.display = 'block';
						
						// Vérifier si l'exercice était déjà résolu
						if (!solved.has(parseInt(exerciseId))) {
							// Mettre à jour le score
							incrementScore();
							// Marquer comme résolu
							markAsSolved(exerciseId);
						}
						
						// Ajouter une classe pour le style
						exerciseCard.classList.add('solved');
						exerciseCard.classList.remove('incorrect');
						
						// Enregistrer l'interaction SCORM
						recordInteraction(exerciseId, true);
						
						// Sauvegarder le score
						saveScore();
						
						// Vérifier si tous les exercices sont complétés
						checkAllCompleted();
					} else {
						resultDiv.innerHTML = '<span class="error-icon">✗</span> Incorrect. La sortie de votre code ne correspond pas à la sortie attendue.';
						resultDiv.className = 'result incorrect';
						resultDiv.style.display = 'block';
						
						// Ajouter une classe pour le style
						exerciseCard.classList.add('incorrect');
						exerciseCard.classList.remove('solved');
						
						// Enregistrer l'interaction SCORM
						recordInteraction(exerciseId, false);
					}

			}`,
				
				code: `<div class="exercise-card" data-exercise="1">
				<div class="question-header">
					<span class="question-icon">🐍</span>
					<span>Défi Python: Affichage simple</span>
				</div>
				
				<div class="challenge-text">
					Écrivez un programme qui affiche "Hello, Python!" à l'écran.
				</div>
				
				<div class="expected-output">
					<p><strong>Sortie attendue:</strong></p>
					<pre>Hello, Python!</pre>
				</div>
				
				<div class="editor-container">
					<textarea class="code-editor" id="editor1">
			# Écrivez votre code ici
			</textarea>
				</div>
				
				<div class="output" id="output1">
					<!-- La sortie du code apparaîtra ici -->
				</div>
				
				<div class="buttons">
					<button class="btn run-btn" data-challenge="1">Exécuter</button>
					<button class="btn clear-btn" data-challenge="1">Effacer</button>
					<button class="btn hint-btn" data-challenge="1">Indice</button>
				</div>
				
				<div class="hint" id="hint1">
					💡 Utilisez la fonction <code>print()</code> pour afficher du texte à l'écran.
				</div>
				
				<div class="result" id="result1"></div>
				
				/* Styles pour l'éditeur de code Python */
				.code-editor {
					width: 100%;
					min-height: 200px;
					font-family: monospace;
					font-size: 14px;
					line-height: 1.5;
				}
				
				.CodeMirror {
					height: auto;
					border: 1px solid #ddd;
					border-radius: 5px;
					font-family: monospace;
					font-size: 14px;
					line-height: 1.5;
				}
				
				.editor-container {
					margin-bottom: 15px;
				}
				
				.output {
					background: #272822;
					color: #f8f8f2;
					padding: 15px;
					border-radius: 5px;
					font-family: monospace;
					min-height: 100px;
					max-height: 200px;
					overflow-y: auto;
					margin-bottom: 15px;
				}
				
				.expected-output {
					background: #f8f9fa;
					padding: 15px;
					border-radius: 5px;
					margin-bottom: 15px;
				}
				
				.expected-output pre {
					background: #272822;
					color: #f8f8f2;
					padding: 10px;
					border-radius: 5px;
					margin: 10px 0 0;
					overflow-x: auto;
				}
				
				.expected-output {
					background: #f0f0f0;
					border-radius: 8px;
					padding: 15px;
					margin-bottom: 15px;
					font-family: monospace;
				}
			
				.expected-output pre {
					background: #272822;
					color: #f8f8f2;
					padding: 10px;
					border-radius: 5px;
					margin: 10px 0 0;
					overflow-x: auto;
				}
			
				.editor-container {
					margin-top: 15px;
					border-radius: 8px;
					overflow: hidden;
				}
			
			
				.output {
					background: #1e1e1e;
					color: white;
					padding: 15px;
					border-radius: 8px;
					min-height: 100px;
					max-height: 200px;
					overflow-y: auto;
					font-family: monospace;
					margin-top: 15px;
					line-height: 1.5;
					white-space: pre-wrap;
					font-size: 0.9em;
				}
			
				
				.challenge-text {
					margin-bottom: 15px;
					padding: 15px;
					background: #f0f4f8;
					border-left: 4px solid #a24b5f;
					border-radius: 5px;
				}
				
				.error {
					color: #dc3545;
					font-weight: bold;
				}
				
				.hint {
					background: #fff3cd;
					border: 1px solid #ffeeba;
					color: #856404;
					padding: 10px;
					border-radius: 5px;
					margin-top: 10px;
					font-size: 0.9em;
					display: none;
				}
				
				.buttons {
					display: flex;
					gap: 10px;
					margin-bottom: 15px;
				}
				
				.run-btn {
					background: #a24b5f;
					color: white;
					flex-grow: 1;
				}
				
				.clear-btn {
					background: #e9ecef;
					color: #495057;
				}


				/* Styles pour les cartes d'exercices */
				.exercise-card {
					background: #f8f9fa;
					border: 2px solid #e9ecef;
					border-radius: 15px;
					padding: 20px;
					transition: all 0.3s ease;
					margin-bottom: 20px;
				}
			
				.exercise-card:hover {
					transform: translateY(-5px);
					box-shadow: 0 10px 20px rgba(0,0,0,0.1);
				}
			
				.question-header {
					display: flex;
					align-items: center;
					margin-bottom: 15px;
					font-size: 1.2em;
					font-weight: bold;
					color: #333;
					border-bottom: 1px solid #eee;
					padding-bottom: 10px;
				}
			
				.question-icon {
					margin-right: 10px;
					font-size: 1.5em;
				}
			
				.challenge-text {
					background: #f7f7f7;
					border-radius: 8px;
					padding: 15px;
					margin-bottom: 15px;
					font-size: 1.1em;
					color: #333;
					border-left: 4px solid #a24b5f;
				}
			
				.buttons {
					display: flex;
					gap: 10px;
					margin-top: 15px;
				}
			
				.btn {
					padding: 10px 20px;
					border: none;
					border-radius: 8px;
					cursor: pointer;
					font-weight: bold;
					transition: all 0.3s;
				}
			
				.run-btn {
					background: #ea6687;
					color: white;
					flex: 2;
				}
			
				.run-btn:hover {
					background: #a24b5f;
				}
			
				.clear-btn {
					background: #e9ecef;
					color: #333;
					flex: 1;
				}
			
				.clear-btn:hover {
					background: #dde2e6;
				}
			
				.hint-btn {
					background: #ffc107;
					color: #333;
					flex: 1;
				}
			
				.hint-btn:hover {
					background: #e0a800;
				}
			
				.hint {
					background: #fff3cd;
					border: 1px solid #ffeeba;
					color: #856404;
					padding: 10px;
					border-radius: 8px;
					margin-top: 10px;
					font-size: 0.9em;
					display: none;
				}
			
				.result {
					margin-top: 10px;
					padding: 10px;
					border-radius: 8px;
					font-weight: bold;
					text-align: center;
				}
			
				.result.correct {
					background: #d4edda;
					color: #155724;
					border: 1px solid #c3e6cb;
				}
			
				.result.incorrect {
					background: #f8d7da;
					color: #721c24;
					border: 1px solid #f5c6cb;
				}
			
				.error {
					color: #dc3545;
					font-weight: bold;
				}
			</style>
				
				/* FIN Styles pour l'éditeur de code Python */
				
			</div>`
			},
            

            
            
            "3d": {
                title: "Modèles scientifiques 3D",
                description: "Un template pour créer des applications avec des modèles scientifiques 3D interactifs. Les apprenants peuvent manipuler, faire pivoter et zoomer sur des objets 3D pour explorer leurs caractéristiques en détail.",
                features: [
                    "Visualisation 3D complète avec WebGL",
                    "Contrôles de rotation, zoom et déplacement",
                    "Descriptions détaillées des modèles",
                    "Personnalisation des couleurs et textures",
                    "Interface utilisateur intuitive"
                ],
                icon: "fas fa-cube",
                previewHtml: `
                <div class="preview-card">
                    <div class="preview-header">
                        <span>Modèles 3D Interactifs</span>
                        <div class="preview-icon">🔬</div>
                    </div>
                    <div class="preview-body">
                        <div class="preview-description">
                            Explorez des modèles scientifiques 3D avec des contrôles interactifs (planètes, molécules, anatomie, etc.)
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <!-- Aperçu de planète -->
                            <div class="model3d-container" style="padding: 10px; background: #0c0e1a; border-radius: 8px; color: #e1e1e1;">
                                <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Saturne</div>
                                <div style="width: 100%; height: 120px; background: #0c0e1a; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 8px; overflow: hidden;">
                                    <div style="width: 60px; height: 60px; background: radial-gradient(circle, #f0d587 20%, #c2a152 100%); border-radius: 50%; box-shadow: 0 0 15px rgba(240, 213, 135, 0.6);"></div>
                                    <div style="position: absolute; width: 100px; height: 20px; border: 2px solid rgba(214, 196, 142, 0.8); border-radius: 50%; transform: rotate(20deg); opacity: 0.8;"></div>
                                </div>
                            </div>
                            
                            <!-- Aperçu de molécule -->
                            <div class="model3d-container" style="padding: 10px; background: #1a273a; border-radius: 8px; color: #e1e1e1;">
                                <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Molécule H₂O</div>
                                <div style="width: 100%; height: 120px; background: #1a273a; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 8px; overflow: hidden;">
                                    <!-- Oxygène -->
                                    <div style="width: 30px; height: 30px; background: #ff0000; border-radius: 50%; position: relative; z-index: 2;"></div>
                                    <!-- Hydrogènes -->
                                    <div style="width: 20px; height: 20px; background: #ffffff; border-radius: 50%; position: absolute; top: 50px; left: 70px; z-index: 1;"></div>
                                    <div style="width: 20px; height: 20px; background: #ffffff; border-radius: 50%; position: absolute; top: 50px; right: 70px; z-index: 1;"></div>
                                    <!-- Liaisons -->
                                    <div style="width: 30px; height: 2px; background: #aaaaaa; position: absolute; top: 60px; left: 85px; transform: rotate(-45deg);"></div>
                                    <div style="width: 30px; height: 2px; background: #aaaaaa; position: absolute; top: 60px; right: 85px; transform: rotate(45deg);"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="preview-btn preview-btn-primary">Détails</button>
                            <button class="preview-btn preview-btn-secondary">Modèle suivant</button>
                        </div>
                    </div>
                </div>
                `,
                
                jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE 3D : PRIORITE OBLIGATOIRE SI CHOISIE
            document.addEventListener('DOMContentLoaded', function() {
                // Initialisation des modèles 3D
                loadThreeJS();
            });
            
            // Variables globales pour THREE.js
            let scenes = {};       // Stocke les scènes pour chaque modèle
            let cameras = {};      // Stocke les caméras
            let renderers = {};    // Stocke les renderers
            let models = {};       // Stocke les objets 3D
            let animations = {};   // Stocke les animations
            let animationStatus = {}; // État des animations (pause/play)
            let zoomLevels = {};   // Niveaux de zoom actuels

            // Fonction pour charger Three.js si nécessaire
            function loadThreeJS() {
                if (typeof THREE === 'undefined') {
                    // Créer l'élément de script pour Three.js
                    const threeScript = document.createElement('script');
                    threeScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
                    
                    // Ajouter le script au document
                    document.head.appendChild(threeScript);
                    
                    // Vérifier périodiquement si Three.js est chargé
                    const checkThreeLoaded = setInterval(function() {
                        if (typeof THREE !== 'undefined') {
                            clearInterval(checkThreeLoaded);
                            console.log('Three.js chargé avec succès');
                            initModels3D();
                        }
                    }, 200);
                } else {
                    // Three.js est déjà chargé
                    initModels3D();
                }
            }
            
            // Initialiser tous les modèles 3D
            function initModels3D() {
                // Déterminer le thème sélectionné
                const theme = appState.templateSettings['3d'].modelTheme || 'planets';
                
                // Initialiser les modèles en fonction du thème
                if (theme === 'planets') {
                    initPlanetModels();
                } else if (theme === 'molecules') {
                    initMoleculeModels();
                } else {
                    // Par défaut, charger les planètes
                    initPlanetModels();
                }
                
                // Générer les étoiles pour l'arrière-plan (uniquement pour les planètes)
                if (theme === 'planets') {
                    generateStars();
                }
                
                // Démarrer les animations
                animateAllModels();
                
                // Gestion du redimensionnement de la fenêtre
                window.addEventListener('resize', resizeModelViewers);
            }

            // Initialiser les modèles de planètes
            function initPlanetModels() {
                initMercuryModel();
                initSaturnModel();
                initJupiterModel();
                initMarsModel();
                initUranusModel();
                initEarthModel();
            }
            

            
            
            // Initialisation des modèles de molécules
            function initMoleculeModels() {
                initWaterMolecule();
                initMethaneMolecule();
                initAmmoniacMolecule();
                initCarbonDioxideMolecule();
            }

            ✅ MODE PRIORITAIRE: les molécules présente dans les questions suivantes ne sont que des exemples il faut varier avec d'autres molécules

            // Modèle de l'eau (H₂O)
            function initWaterMolecule() {
                const id = 'water';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la molécule
                const molecule = new THREE.Group();
                
                // Créer les atomes
                const oxygen = createAtom(0xff0000, 0.5); // Oxygène en rouge
                molecule.add(oxygen);
                
                const hydrogen1 = createAtom(0xffffff, 0.3); // Hydrogène en blanc
                hydrogen1.position.set(-0.8, 0.6, 0);
                molecule.add(hydrogen1);
                
                const hydrogen2 = createAtom(0xffffff, 0.3); // Hydrogène en blanc
                hydrogen2.position.set(0.8, 0.6, 0);
                molecule.add(hydrogen2);
                
                // Créer les liaisons
                const bond1 = createBond(oxygen.position, hydrogen1.position, 0xaaaaaa);
                molecule.add(bond1);
                
                const bond2 = createBond(oxygen.position, hydrogen2.position, 0xaaaaaa);
                molecule.add(bond2);
                
                // Ajuster la position de la caméra
                camera.position.z = 3;
                
                // Ajouter la molécule à la scène
                scene.add(molecule);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = molecule;
                animationStatus[id] = 'playing';
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Modèle du méthane (CH₄)
            function initMethaneMolecule() {
                const id = 'methane';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la molécule
                const molecule = new THREE.Group();
                
                // Créer les atomes
                const carbon = createAtom(0x444444, 0.5); // Carbone en gris
                molecule.add(carbon);
                
                // Positions tétraédriques pour les atomes d'hydrogène
                const positions = [
                    new THREE.Vector3(0.8, 0.8, 0.8),
                    new THREE.Vector3(-0.8, 0.8, -0.8),
                    new THREE.Vector3(0.8, -0.8, -0.8),
                    new THREE.Vector3(-0.8, -0.8, 0.8)
                ];
                
                // Créer les hydrogènes et les liaisons
                positions.forEach(position => {
                    const hydrogen = createAtom(0xffffff, 0.3); // Hydrogène en blanc
                    hydrogen.position.copy(position);
                    molecule.add(hydrogen);
                    
                    const bond = createBond(carbon.position, hydrogen.position, 0xaaaaaa);
                    molecule.add(bond);
                });
                
                // Ajuster la position de la caméra
                camera.position.z = 4;
                
                // Ajouter la molécule à la scène
                scene.add(molecule);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = molecule;
                animationStatus[id] = 'playing';
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Modèle de l'ammoniac (NH₃)
            function initAmmoniacMolecule() {
                const id = 'ammonia';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la molécule
                const molecule = new THREE.Group();
                
                // Créer les atomes
                const nitrogen = createAtom(0x0000ff, 0.5); // Azote en bleu
                nitrogen.position.set(0, 0.4, 0);
                molecule.add(nitrogen);
                
                // Positions pour les atomes d'hydrogène (base de la pyramide)
                const positions = [
                    new THREE.Vector3(0, -0.4, 0.8),
                    new THREE.Vector3(0.7, -0.4, -0.4),
                    new THREE.Vector3(-0.7, -0.4, -0.4)
                ];
                
                // Créer les hydrogènes et les liaisons
                positions.forEach(position => {
                    const hydrogen = createAtom(0xffffff, 0.3); // Hydrogène en blanc
                    hydrogen.position.copy(position);
                    molecule.add(hydrogen);
                    
                    const bond = createBond(nitrogen.position, hydrogen.position, 0xaaaaaa);
                    molecule.add(bond);
                });
                
                // Ajuster la position de la caméra
                camera.position.z = 4;
                
                // Ajouter la molécule à la scène
                scene.add(molecule);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = molecule;
                animationStatus[id] = 'playing';
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Modèle du dioxyde de carbone (CO₂)
            function initCarbonDioxideMolecule() {
                const id = 'carbon-dioxide';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la molécule
                const molecule = new THREE.Group();
                
                // Créer les atomes
                const carbon = createAtom(0x444444, 0.5); // Carbone en gris
                molecule.add(carbon);
                
                const oxygen1 = createAtom(0xff0000, 0.5); // Oxygène en rouge
                oxygen1.position.set(-1.4, 0, 0);
                molecule.add(oxygen1);
                
                const oxygen2 = createAtom(0xff0000, 0.5); // Oxygène en rouge
                oxygen2.position.set(1.4, 0, 0);
                molecule.add(oxygen2);
                
                // Créer les liaisons (liaisons doubles)
                const bond1a = createBond(carbon.position, oxygen1.position, 0xaaaaaa, 0.12);
                molecule.add(bond1a);
                
                const bond1b = createBond(
                    new THREE.Vector3(carbon.position.x, carbon.position.y + 0.15, carbon.position.z),
                    new THREE.Vector3(oxygen1.position.x, oxygen1.position.y + 0.15, oxygen1.position.z),
                    0xaaaaaa, 0.08
                );
                molecule.add(bond1b);
                
                const bond2a = createBond(carbon.position, oxygen2.position, 0xaaaaaa, 0.12);
                molecule.add(bond2a);
                
                const bond2b = createBond(
                    new THREE.Vector3(carbon.position.x, carbon.position.y + 0.15, carbon.position.z),
                    new THREE.Vector3(oxygen2.position.x, oxygen2.position.y + 0.15, oxygen2.position.z),
                    0xaaaaaa, 0.08
                );
                molecule.add(bond2b);
                
                // Ajuster la position de la caméra
                camera.position.z = 4;
                
                // Ajouter la molécule à la scène
                scene.add(molecule);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = molecule;
                animationStatus[id] = 'playing';
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Fonction pour créer un atome (sphère)
            function createAtom(color, radius, detail = 16) {
                const geometry = new THREE.SphereGeometry(radius, detail, detail);
                const material = new THREE.MeshPhongMaterial({ 
                    color: color, 
                    shininess: 80,
                    specular: 0x222222
                });
                return new THREE.Mesh(geometry, material);
            }
            
            // Fonction pour créer une liaison (cylindre)
            function createBond(startPosition, endPosition, color, radius = 0.1) {
                const direction = new THREE.Vector3().subVectors(endPosition, startPosition);
                const midpoint = new THREE.Vector3().addVectors(startPosition, endPosition).multiplyScalar(0.5);
                const length = direction.length();
                
                const geometry = new THREE.CylinderGeometry(radius, radius, length, 12, 1);
                const material = new THREE.MeshPhongMaterial({ color: color });
                
                const cylinder = new THREE.Mesh(geometry, material);
                
                // Positionner et orienter le cylindre
                cylinder.position.copy(midpoint);
                cylinder.lookAt(endPosition);
                cylinder.rotateX(Math.PI / 2);
                
                return cylinder;
            }
            
            // Initialiser une scène 3D de base
            function initBaseScene(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return null;
                
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                // Créer la scène
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0c0e1a);
                
                // Créer la caméra
                const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
                camera.position.z = 5;
                
                // Créer le renderer
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(width, height);
                renderer.setPixelRatio(window.devicePixelRatio);
                
                // Vider le container et ajouter le renderer
                // Ne pas supprimer les étoiles ou les contrôles
                const stars = container.querySelector('.stars');
                const controls = container.querySelector('.model-controls');
                const zoomControls = container.querySelector('.zoom-controls');
                
                container.innerHTML = '';
                container.appendChild(renderer.domElement);
                
                // Remettre les éléments existants
                if (stars) container.appendChild(stars);
                if (controls) container.appendChild(controls);
                if (zoomControls) container.appendChild(zoomControls);
                
                // Ajouter l'éclairage
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                scene.add(ambientLight);
                
                const light1 = new THREE.DirectionalLight(0xffffff, 1);
                light1.position.set(5, 3, 5);
                scene.add(light1);
                
                const light2 = new THREE.DirectionalLight(0xccccff, 0.2);
                light2.position.set(-5, -3, -5);
                scene.add(light2);
                
                return { scene, camera, renderer };
            }
            
            // Animer tous les modèles
            function animateAllModels() {
                requestAnimationFrame(animateAllModels);
                
                Object.keys(models).forEach(key => {
                    if (animationStatus[key] !== 'paused' && models[key] && scenes[key] && cameras[key] && renderers[key]) {
                        models[key].rotation.y += 0.005;
                        
                        // Animation spécifique pour certaines planètes
                        if (key === 'saturn') {
                            // Faire tourner les anneaux différemment
                            const rings = models[key].getObjectByName('rings');
                            if (rings) {
                                rings.rotation.z += 0.001;
                            }
                        } else if (key === 'jupiter') {
                            // Animer la Grande Tache Rouge
                            const redSpot = models[key].getObjectByName('redSpot');
                            if (redSpot) {
                                redSpot.rotation.z += 0.01;
                            }
                        } else if (key === 'uranus') {
                            // Animer l'inclinaison
                            models[key].rotation.x += 0.001;
                        } else if (key === 'earth') {
                            // Animer les nuages
                            const clouds = models[key].getObjectByName('clouds');
                            if (clouds) {
                                clouds.rotation.y += 0.001;
                            }
                        }
                        
                        renderers[key].render(scenes[key], cameras[key]);
                    }
                });
            }
            
            // Contrôler la rotation d'un modèle spécifique
            function rotateModel(modelId, action) {
                if (!models[modelId]) return;
                
                if (action === 'reset') {
                    // Réinitialiser la position
                    models[modelId].rotation.x = 0;
                    models[modelId].rotation.y = 0;
                    models[modelId].rotation.z = 0;
                    
                    // Réinitialiser l'inclinaison spécifique d'Uranus
                    if (modelId === 'uranus') {
                        models[modelId].rotation.z = Math.PI / 2;
                    }
                    
                    renderers[modelId].render(scenes[modelId], cameras[modelId]);
                } else if (action === 'pause') {
                    // Mettre en pause l'animation
                    animationStatus[modelId] = 'paused';
                } else if (action === 'play') {
                    // Reprendre l'animation
                    animationStatus[modelId] = 'playing';
                }
            }
            
            // Zoomer sur un modèle spécifique
            function zoomModel(modelId, action) {
                if (!cameras[modelId]) return;
                
                // Initialiser le niveau de zoom si non défini
                if (zoomLevels[modelId] === undefined) {
                    zoomLevels[modelId] = 1;
                }
                
                if (action === 'in') {
                    // Zoom in (se rapprocher)
                    zoomLevels[modelId] = Math.min(zoomLevels[modelId] + 0.2, 2);
                    cameras[modelId].position.z = 5 / zoomLevels[modelId];
                } else if (action === 'out') {
                    // Zoom out (s'éloigner)
                    zoomLevels[modelId] = Math.max(zoomLevels[modelId] - 0.2, 0.5);
                    cameras[modelId].position.z = 5 / zoomLevels[modelId];
                }
                
                cameras[modelId].updateProjectionMatrix();
                renderers[modelId].render(scenes[modelId], cameras[modelId]);
            }
            
            // Redimensionner tous les renderers lors du redimensionnement de la fenêtre
            function resizeModelViewers() {
                Object.keys(renderers).forEach(key => {
                    const container = document.getElementById(key + '-model');
                    if (container && renderers[key]) {
                        const width = container.clientWidth;
                        const height = container.clientHeight;
                        
                        renderers[key].setSize(width, height);
                        cameras[key].aspect = width / height;
                        cameras[key].updateProjectionMatrix();
                        
                        renderers[key].render(scenes[key], cameras[key]);
                    }
                });
            }
            
            // Générer des étoiles aléatoires pour l'arrière-plan
            function generateStars() {
                const starContainers = document.querySelectorAll('.stars');
                
                starContainers.forEach(container => {
                    // Générer entre 50 et 100 étoiles
                    const starCount = Math.floor(Math.random() * 50) + 50;
                    
                    for (let i = 0; i < starCount; i++) {
                        const star = document.createElement('div');
                        star.classList.add('star');
                        
                        // Taille aléatoire entre 1 et 3 pixels
                        const size = Math.random() * 2 + 1;
                        star.style.width = size + 'px';
                        star.style.height = size + 'px';
                        
                        // Position aléatoire
                        const posX = Math.random() * 100;
                        const posY = Math.random() * 100;
                        star.style.left = posX + '%';
                        star.style.top = posY + '%';
                        
                        // Animation aléatoire
                        star.style.animationDelay = Math.random() * 3 + 's';
                        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                        
                        container.appendChild(star);
                    }
                });
            }
            
            // Fonctions de création de textures
            function createPlanetTexture(mainColor, secondaryColor) {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 256;
                const context = canvas.getContext('2d');
                
                // Remplir avec la couleur principale
                context.fillStyle = '#' + mainColor.toString(16).padStart(6, '0');
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Ajouter des variations aléatoires
                for (let i = 0; i < 1000; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const radius = Math.random() * 10 + 2;
                    const alpha = Math.random() * 0.3 + 0.1;
                    
                    context.beginPath();
                    context.arc(x, y, radius, 0, Math.PI * 2);
                    context.fillStyle = '#' + secondaryColor.toString(16).padStart(6, '0');
                    context.globalAlpha = alpha;
                    context.fill();
                    context.globalAlpha = 1.0;
                }
                
                return new THREE.CanvasTexture(canvas);
            }
            
            // Initialiser le modèle de Mercure
            function initMercuryModel() {
                const id = 'mercury';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la planète
                const planet = new THREE.Group();
                
                // Créer la sphère de la planète
                const geometry = new THREE.SphereGeometry(1.2, 32, 32);
                const mercuryTexture = createPlanetTexture(0x8a7b6d, 0x635a51);
                const material = new THREE.MeshPhongMaterial({ 
                    map: mercuryTexture,
                    shininess: 5
                });
                
                const mercurySphere = new THREE.Mesh(geometry, material);
                planet.add(mercurySphere);
                
                // Ajouter la planète à la scène
                scene.add(planet);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = planet;
                animationStatus[id] = 'playing';
                zoomLevels[id] = 1;
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Initialiser le modèle de Saturne
            function initSaturnModel() {
                const id = 'saturn';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la planète
                const planet = new THREE.Group();
                
                // Créer la sphère de la planète
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const saturnTexture = createPlanetTexture(0xf0d587, 0xc2a152);
                const material = new THREE.MeshPhongMaterial({ 
                    map: saturnTexture,
                    shininess: 15
                });
                
                const saturnSphere = new THREE.Mesh(geometry, material);
                planet.add(saturnSphere);
                
                // Créer les anneaux
                const ringsGroup = new THREE.Group();
                ringsGroup.name = 'rings';
                ringsGroup.rotation.x = Math.PI / 6; // Incliner les anneaux
                
                // Anneau extérieur
                const ringGeometry = new THREE.RingGeometry(1.4, 2.2, 64);
                const ringMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xd6c48e,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.8
                });
                
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ringsGroup.add(ring);
                
                // Anneau intérieur
                const innerRingGeometry = new THREE.RingGeometry(1.2, 1.35, 64);
                const innerRingMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xd6c48e,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.6
                });
                
                const innerRing = new THREE.Mesh(innerRingGeometry, innerRingMaterial);
                ringsGroup.add(innerRing);
                
                planet.add(ringsGroup);
                
                // Ajuster la position de la caméra
                camera.position.z = 6;
                
                // Ajouter la planète à la scène
                scene.add(planet);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = planet;
                animationStatus[id] = 'playing';
                zoomLevels[id] = 1;
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Initialiser le modèle de Jupiter
            function initJupiterModel() {
                const id = 'jupiter';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la planète
                const planet = new THREE.Group();
                
                // Créer la sphère de la planète
                const geometry = new THREE.SphereGeometry(1.5, 64, 64);
                const jupiterTexture = createPlanetTexture(0xe5c988, 0xc28d58);
                const material = new THREE.MeshPhongMaterial({ 
                    map: jupiterTexture,
                    shininess: 10
                });
                
                const jupiterSphere = new THREE.Mesh(geometry, material);
                planet.add(jupiterSphere);
                
                // Ajouter la Grande Tache Rouge
                const redSpotGeometry = new THREE.CircleGeometry(0.3, 32);
                const redSpotMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xbb3311,
                    shininess: 10,
                    transparent: true,
                    opacity: 0.9
                });
                
                const redSpot = new THREE.Mesh(redSpotGeometry, redSpotMaterial);
                redSpot.name = 'redSpot';
                redSpot.position.set(0, 0.5, 1.51);
                redSpot.lookAt(0, 0, 0);
                planet.add(redSpot);
                
                // Ajuster la position de la caméra
                camera.position.z = 6;
                
                // Ajouter la planète à la scène
                scene.add(planet);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = planet;
                animationStatus[id] = 'playing';
                zoomLevels[id] = 1;
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Initialiser le modèle de Mars
            function initMarsModel() {
                const id = 'mars';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la planète
                const planet = new THREE.Group();
                
                // Créer la sphère de la planète
                const geometry = new THREE.SphereGeometry(1.2, 32, 32);
                const marsTexture = createPlanetTexture(0xc1440e, 0x9c4a2e);
                const material = new THREE.MeshPhongMaterial({ 
                    map: marsTexture,
                    shininess: 5
                });
                
                const marsSphere = new THREE.Mesh(geometry, material);
                planet.add(marsSphere);
                
                // Ajouter le Olympus Mons (plus grand volcan)
                const olympusMonsGeometry = new THREE.ConeGeometry(0.15, 0.1, 16);
                const olympusMonsMaterial = new THREE.MeshPhongMaterial({ color: 0x9c4a2e });
                const olympusMons = new THREE.Mesh(olympusMonsGeometry, olympusMonsMaterial);
                olympusMons.position.set(0, 0.8, 0.9);
                olympusMons.lookAt(0, 0, 0);
                planet.add(olympusMons);
                
                // Ajuster la position de la caméra
                camera.position.z = 5;
                
                // Ajouter la planète à la scène
                scene.add(planet);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = planet;
                animationStatus[id] = 'playing';
                zoomLevels[id] = 1;
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Initialiser le modèle d'Uranus
            function initUranusModel() {
                const id = 'uranus';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la planète
                const planet = new THREE.Group();
                
                // Créer la sphère de la planète
                const geometry = new THREE.SphereGeometry(1.2, 32, 32);
                const uranusTexture = createPlanetTexture(0xb1ede8, 0x7fc9bf);
                const material = new THREE.MeshPhongMaterial({ 
                    map: uranusTexture,
                    shininess: 30
                });
                
                const uranusSphere = new THREE.Mesh(geometry, material);
                planet.add(uranusSphere);
                
                // Créer les anneaux (beaucoup plus subtils que ceux de Saturne)
                const ringsGroup = new THREE.Group();
                ringsGroup.name = 'rings';
                
                // Anneau principal
                const ringGeometry = new THREE.RingGeometry(1.5, 1.7, 64);
                const ringMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0x81a8b8,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.3
                });
                
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ringsGroup.add(ring);
                
                planet.add(ringsGroup);
                
                // Incliner toute la planète (inclinaison axiale extrême)
                planet.rotation.z = Math.PI / 2;
                
                // Ajuster la position de la caméra
                camera.position.z = 5;
                
                // Ajouter la planète à la scène
                scene.add(planet);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = planet;
                animationStatus[id] = 'playing';
                zoomLevels[id] = 1;
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Initialiser le modèle de la Terre
            function initEarthModel() {
                const id = 'earth';
                const container = document.getElementById(id + '-model');
                if (!container) return;
                
                const { scene, camera, renderer } = initBaseScene(id + '-model');
                
                // Créer un groupe pour la planète
                const planet = new THREE.Group();
                
                // Créer la sphère de la planète
                const geometry = new THREE.SphereGeometry(1.2, 32, 32);
                const earthTexture = createPlanetTexture(0x2233aa, 0x11aa33);
                const material = new THREE.MeshPhongMaterial({ 
                    map: earthTexture,
                    shininess: 25
                });
                
                const earthSphere = new THREE.Mesh(geometry, material);
                planet.add(earthSphere);
                
                // Ajouter des nuages
                const cloudGeometry = new THREE.SphereGeometry(1.22, 32, 32);
                const cloudMaterial = new THREE.MeshPhongMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.4
                });
                
                const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
                clouds.name = 'clouds';
                planet.add(clouds);
                
                // Ajuster la position de la caméra
                camera.position.z = 5;
                
                // Ajouter la planète à la scène
                scene.add(planet);
                
                // Stocker les références
                scenes[id] = scene;
                cameras[id] = camera;
                renderers[id] = renderer;
                models[id] = planet;
                animationStatus[id] = 'playing';
                zoomLevels[id] = 1;
                
                // Rendu initial
                renderer.render(scene, camera);
            }
            
            // Fonctions squelettes pour les autres thèmes
            function initAnatomyModels() {
                // À implémenter avec des modèles anatomiques
                console.log('Modèles anatomiques à implémenter');
                
                // Exemple de base: initHeartModel(), initBrainModel(), etc.
            }
            
            function initGeometryModels() {
                // À implémenter avec des formes géométriques
                console.log('Modèles géométriques à implémenter');
                
                // Exemple de base: initCubeModel(), initSphereModel(), initPyramidModel(), etc.
            }
            
            `,
                
                code: `<div class="planet-card">
    <div class="planet-header">
        <span>Saturne</span>
    </div>
    <div class="planet-display" id="saturn-model">
        <div class="stars" id="saturn-stars"></div>
        <div class="planet-controls">
            <button class="control-btn" onclick="rotateModel('saturn', 'reset')">R</button>
            <button class="control-btn" onclick="rotateModel('saturn', 'pause')">⏸️</button>
            <button class="control-btn" onclick="rotateModel('saturn', 'play')">▶️</button>
        </div>
        <div class="zoom-controls">
            <button class="control-btn" onclick="zoomModel('saturn', 'in')">+</button>
            <button class="control-btn" onclick="zoomModel('saturn', 'out')">-</button>
        </div>
    </div>
    <p>Célèbre pour ses anneaux spectaculaires composés de particules de glace et de poussière.</p>
</div>`
            },
            
            
			graphique: {
				title: "Système de Tracés Graphiques",
				description: "Un template pour créer des applications graphiques interactives. L'apprenant peut visualiser, lire et interpréter des graphiques dans des repères cartésiens avec des droites et des points.",
				features: [
					"Représentation graphique de fonctions dans un repère cartésien",
					"Visualisation de droites et de points avec coordonnées",
					"Exercices de lecture et d'interprétation graphique",
					"Calcul des paramètres d'équations de droites",
					"Vérification automatique des réponses"
				],
				icon: "fas fa-chart-line",
				previewHtml: `
				<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
					<div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h3 style="margin-bottom: 10px; color: #3498db;">Système de Tracés Graphiques</h3>
						<div style="width: 100%; height: 200px; background: #f5f5f5; border-radius: 8px; position: relative; overflow: hidden; margin-bottom: 15px;">
							<!-- Grille -->
							<div style="position: absolute; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr);">
								<!-- Lignes verticales de la grille -->
								<div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #333;"></div>
								<!-- Lignes horizontales de la grille -->
								<div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: #333;"></div>
								
								<!-- Points -->
								<div style="position: absolute; left: 65%; top: 30%; width: 8px; height: 8px; background: #3498db; border-radius: 50%; transform: translate(-50%, -50%);"></div>
								<div style="position: absolute; left: 75%; top: 20%; width: 8px; height: 8px; background: #3498db; border-radius: 50%; transform: translate(-50%, -50%);"></div>
								
								<!-- Droite -->
								<div style="position: absolute; left: 0; top: 70%; right: 0; height: 2px; background: #e74c3c; transform: rotate(-20deg); transform-origin: left center;"></div>
							</div>
						</div>
						<div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
							<div style="display: flex; gap: 10px; align-items: center;">
								<label style="min-width: 200px; font-weight: bold;">Coefficient directeur :</label>
								<input type="number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1;" value="2">
							</div>
							<div style="display: flex; gap: 10px; align-items: center;">
								<label style="min-width: 200px; font-weight: bold;">Ordonnée à l'origine :</label>
								<input type="number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1;" value="-1">
							</div>
						</div>
						<button style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Vérifier ma réponse</button>
					</div>
				</div>
				`,
				
				jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE GRAPHIQUE : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// Initialisation des exercices graphiques
				initGraphExercises();
			});
			
// =====================================================================
## ⚠️ IMPORTANT  : Fonction pour dessiner un repère cartésien
// =====================================================================	

			// Fonction pour dessiner un repère cartésien
			function drawCoordinateSystem(canvas, minX = -10, maxX = 10, minY = -10, maxY = 10) {
				const ctx = canvas.getContext('2d');
				const width = canvas.width;
				const height = canvas.height;
				const padding = 20;
				
				const scaleX = (width - 2 * padding) / (maxX - minX);
				const scaleY = (height - 2 * padding) / (maxY - minY);
				
				const centerX = padding + (-minX) * scaleX;
				const centerY = height - padding - (-minY) * scaleY;
				
				ctx.clearRect(0, 0, width, height);
				
				// Dessiner la grille
				ctx.strokeStyle = '#e0e0e0';
				ctx.lineWidth = 1;
				
				for (let x = minX; x <= maxX; x++) {
					const px = padding + (x - minX) * scaleX;
					ctx.beginPath();
					ctx.moveTo(px, padding);
					ctx.lineTo(px, height - padding);
					ctx.stroke();
				}
				
				for (let y = minY; y <= maxY; y++) {
					const py = height - padding - (y - minY) * scaleY;
					ctx.beginPath();
					ctx.moveTo(padding, py);
					ctx.lineTo(width - padding, py);
					ctx.stroke();
				}
				
				// Dessiner les axes
				ctx.strokeStyle = '#333';
				ctx.lineWidth = 2;
				
				ctx.beginPath();
				ctx.moveTo(padding, centerY);
				ctx.lineTo(width - padding, centerY);
				ctx.stroke();
				
				ctx.beginPath();
				ctx.moveTo(centerX, padding);
				ctx.lineTo(centerX, height - padding);
				ctx.stroke();
				
				// Ajouter les graduations et labels
				ctx.fillStyle = '#333';
				ctx.font = '10px Arial';
				ctx.textAlign = 'center';
				ctx.textBaseline = 'middle';
				
				for (let x = minX; x <= maxX; x++) {
					if (x !== 0) {
						const px = padding + (x - minX) * scaleX;
						ctx.fillText(x.toString(), px, centerY + 15);
					}
				}
				
				ctx.textAlign = 'right';
				for (let y = minY; y <= maxY; y++) {
					if (y !== 0) {
						const py = height - padding - (y - minY) * scaleY;
						ctx.fillText(y.toString(), centerX - 5, py);
					}
				}
				
				ctx.textAlign = 'right';
				ctx.fillText('0', centerX - 5, centerY + 15);
				
				return { 
					ctx, 
					centerX, 
					centerY, 
					scaleX, 
					scaleY, 
					minX, 
					maxX, 
					minY, 
					maxY, 
					padding 
				};
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : Fonction pour dessiner un point
// =====================================================================	
			
			// Fonction pour dessiner un point
			function drawPoint(coords, x, y, color = '#3498db', label = '') {
				const { ctx, centerX, centerY, scaleX, scaleY } = coords;
				
				const px = centerX + x * scaleX;
				const py = centerY - y * scaleY;
				
				ctx.fillStyle = color;
				ctx.beginPath();
				ctx.arc(px, py, 5, 0, 2 * Math.PI);
				ctx.fill();
				
				if (label) {
					ctx.fillStyle = '#333';
					ctx.font = 'bold 12px Arial';
					ctx.textAlign = 'left';
					ctx.textBaseline = 'bottom';
					ctx.fillText(label, px + 8, py - 8);
				}
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : Fonction pour dessiner une droite
// =====================================================================			
			
			// Fonction pour dessiner une droite
			function drawLine(coords, a, b, color = '#e74c3c') {
				const { ctx, centerX, centerY, scaleX, scaleY, minX, maxX, minY, maxY } = coords;
				
				ctx.strokeStyle = color;
				ctx.lineWidth = 2;
				ctx.beginPath();
				
				let x1 = minX;
				let y1 = a * x1 + b;
				let x2 = maxX;
				let y2 = a * x2 + b;
				
				if (y1 < minY) {
					y1 = minY;
					x1 = (y1 - b) / a;
				} else if (y1 > maxY) {
					y1 = maxY;
					x1 = (y1 - b) / a;
				}
				
				if (y2 < minY) {
					y2 = minY;
					x2 = (y2 - b) / a;
				} else if (y2 > maxY) {
					y2 = maxY;
					x2 = (y2 - b) / a;
				}
				
				const px1 = centerX + x1 * scaleX;
				const py1 = centerY - y1 * scaleY;
				const px2 = centerX + x2 * scaleX;
				const py2 = centerY - y2 * scaleY;
				
				ctx.moveTo(px1, py1);
				ctx.lineTo(px2, py2);
				ctx.stroke();
			}
			
			// Initialiser les graphiques et les exercices
			function initGraphExercises() {
				const canvases = document.querySelectorAll('canvas[id^="canvas"]');
				
				canvases.forEach(canvas => {
					const id = canvas.id.replace('canvas', '');
					initializeExercise(id, canvas);
				});
				
				// Configurer les écouteurs d'événements pour les boutons de vérification
				document.querySelectorAll('button[id^="checkBtn"]').forEach(button => {
					const id = button.id.replace('checkBtn', '');
					button.addEventListener('click', function() {
						checkAnswer(id);
					});
				});
			}
			
// =====================================================================
## ⚠️ IMPORTANT  : Fonction pour dessiner une parabole, une courbe
// =====================================================================	
			
			// Fonction pour dessiner une parabole
			function drawParabola(coords, a, b, c, color = '#e74c3c') {
				const { ctx, centerX, centerY, scaleX, scaleY, minX, maxX } = coords;
				
				ctx.strokeStyle = color;
				ctx.lineWidth = 2;
				ctx.beginPath();
				
				const step = (maxX - minX) / 100;
				let first = true;
				
				for (let x = minX; x <= maxX; x += step) {
					const y = a * x * x + b * x + c;
					const px = centerX + x * scaleX;
					const py = centerY - y * scaleY;
					
					if (first) {
						ctx.moveTo(px, py);
						first = false;
					} else {
						ctx.lineTo(px, py);
					}
				}
				
				ctx.stroke();
			}
			
			
// =====================================================================
## ⚠️ IMPORTANT  : EXEMPLES D EXERCICES
// =====================================================================
		
		    ## ⚠️ PRIORITE HAUTE  : LISTE NON EXHAUSTIVE D EXERCICES
		
			// Initialiser un exercice spécifique sur les droites
			function initializeExercise(id, canvas) {
				switch(id) {
					case '1':
						// Lecture de points sur une droite
						const coords1 = drawCoordinateSystem(canvas, 0, 8, 0, 12);
						drawPoint(coords1, 2, 3, '#3498db', 'A(2,3)');
						drawPoint(coords1, 5, 9, '#3498db', 'B(5,9)');
						drawLine(coords1, 2, -1);
						break;
						
					case '2':
						// Point sur une droite
						const coords2 = drawCoordinateSystem(canvas, -2, 8, -5, 10);
						drawLine(coords2, 2, -3);
						drawPoint(coords2, 4, 5, '#f39c12', 'C(4,5)');
						break;
												
					case '3':
						// Intersection avec les axes
						const coords3 = drawCoordinateSystem(canvas, -2, 6, -5, 10);
						drawLine(coords4, -2, 8);
						break;

						
					case '4':
						// Lecture graphique
						const coords4 = drawCoordinateSystem(canvas, -4, 6, -3, 7);
						drawLine(coords6, 0.5, 2, '#e74c3c');
						break;

				}
			}
			
			
			// Initialiser un exercice spécifique sur les représentations graphiques
			function initializeExercise(id, canvas) {
				switch(id) {
					case '1':
						// Fonction à Minimum: f(x) = x² - 4x + 5
						const coords1 = drawCoordinateSystem(canvas, -2, 6, -1, 10);
						drawParabola(coords1, 1, -4, 5);
						drawPoint(coords1, 2, 1, '#3498db', '(2,1)');
						break;
						
					case '2':
						// Fonction à Maximum: f(x) = -2x² + 8x - 3
						const coords2 = drawCoordinateSystem(canvas, 0, 4, -5, 10);
						drawParabola(coords2, -2, 8, -3);
						drawPoint(coords2, 2, 5, '#3498db', '(2,5)');
						break;
						
					case '3':
						// expression de fonctions : f(x) = x² + 6x + 10
						const coords3 = drawCoordinateSystem(canvas, -5, 1, 0, 15);
						drawParabola(coords3, 1, 6, 10);
						drawPoint(coords3, -3, 1, '#3498db', '(-3,1)');
						break;
						
					case '4':
						// Lecture Graphique
						const coords4 = drawCoordinateSystem(canvas, -2, 6, -2, 10);
						drawParabola(coords4, 1, -4, 6);
						drawPoint(coords4, 2, 2, '#3498db', '(2,2)');
						break;
						
				}
			}
			
			
			// Vérifier la réponse pour un exercice donné pour des exercices spécifiques sur les droites
			function checkAnswer(id) {
				const resultDiv = document.getElementById('result' + id);
				const hintDiv = document.getElementById('hint' + id);
				
				switch(id) {
					case '1':
						// Lecture de points sur une droite
						const a1 = parseFloat(document.getElementById('coefficient' + id).value);
						const b1 = parseFloat(document.getElementById('intercept' + id).value);
						
						const isA1Correct = Math.abs(a1 - 2) <= 0.1;
						const isB1Correct = Math.abs(b1 - (-1)) <= 0.1;
						
						if (isA1Correct && isB1Correct) {
							resultDiv.textContent = "✓ Correct ! L'équation est bien y = 2x - 1";
							resultDiv.className = "result correct";
							resultDiv.style.display = "block";
							hintDiv.style.display = "none";
							markAsSolved(id);
						} else {
							resultDiv.textContent = "✗ Incorrect. Réessayez ou utilisez l'indice.";
							resultDiv.className = "result incorrect";
							resultDiv.style.display = "block";
							hintDiv.style.display = "block";
						}
						break;
						
					// Ajoutez des cas similaires pour les autres exercices...
				}
			}
			
			// Vérifier la réponse pour un exercice donné spécifique sur les représentations graphiques
			function checkAnswer(id) {
				const resultDiv = document.getElementById('result' + id);
				const hintDiv = document.getElementById('hint' + id);
				
				if (solved.has(id)) {
					return; // Exercice déjà résolu
				}
				
				switch(id) {
					case '1':
						// Fonction à Minimum: f(x) = x² - 4x + 5
						const x1 = parseFloat(document.getElementById('x1').value);
						const y1 = parseFloat(document.getElementById('y1').value);
						
						const isX1Correct = Math.abs(x1 - 2) <= 0.1;
						const isY1Correct = Math.abs(y1 - 1) <= 0.1;
						
						if (isX1Correct && isY1Correct) {
							resultDiv.textContent = "✓ Correct ! Le minimum est bien au point (2,1)";
							resultDiv.className = "result correct";
							resultDiv.style.display = "block";
							hintDiv.style.display = "none";
							markAsSolved(id);
							recordInteraction(id, x1,y1, true, "x:2,y:1");
						} else {
							resultDiv.textContent = "✗ Incorrect. Réessayez ou utilisez l'indice.";
							resultDiv.className = "result incorrect";
							resultDiv.style.display = "block";
							hintDiv.style.display = "block";
							recordInteraction(id, x1,y1, false, "x:2,y:1");
						}
						break;
					
					case '2':
						// Fonction à Maximum: f(x) = -2x² + 8x - 3
						const x2 = parseFloat(document.getElementById('x2').value);
						const y2 = parseFloat(document.getElementById('y2').value);
						
						const isX2Correct = Math.abs(x2 - 2) <= 0.1;
						const isY2Correct = Math.abs(y2 - 5) <= 0.1;
						
						if (isX2Correct && isY2Correct) {
							resultDiv.textContent = "✓ Correct ! Le maximum est bien au point (2,5)";
							resultDiv.className = "result correct";
							resultDiv.style.display = "block";
							hintDiv.style.display = "none";
							markAsSolved(id);
							recordInteraction(id, x2,y2, true, "x:2,y:5");
						} else {
							resultDiv.textContent = "✗ Incorrect. Réessayez ou utilisez l'indice.";
							resultDiv.className = "result incorrect";
							resultDiv.style.display = "block";
							hintDiv.style.display = "block";
							recordInteraction(id, x2,y2, false, "x:2,y:5");
						}
						break;
					
					case '3':
						// Forme Canonique: f(x) = x² + 6x + 10
						const x3 = parseFloat(document.getElementById('x3').value);
						const y3 = parseFloat(document.getElementById('y3').value);
						
						const isX3Correct = Math.abs(x3 - (-3)) <= 0.1;
						const isY3Correct = Math.abs(y3 - 1) <= 0.1;
						
						if (isX3Correct && isY3Correct) {
							resultDiv.textContent = "✓ Correct ! Le minimum est bien au point (-3,1)";
							resultDiv.className = "result correct";
							resultDiv.style.display = "block";
							hintDiv.style.display = "none";
							markAsSolved(id);
							recordInteraction(id, x3,y3, true, "x:-3,y:1");
						} else {
							resultDiv.textContent = "✗ Incorrect. Réessayez ou utilisez l'indice.";
							resultDiv.className = "result incorrect";
							resultDiv.style.display = "block";
							hintDiv.style.display = "block";
							recordInteraction(id, x3,y3, false, "x:-3,y:1");
						}
						break;
					
					case '4':
						// Lecture Graphique
						const x4 = parseFloat(document.getElementById('x4').value);
						const y4 = parseFloat(document.getElementById('y4').value);
						
						const isX4Correct = Math.abs(x4 - 2) <= 0.1;
						const isY4Correct = Math.abs(y4 - 2) <= 0.1;
						
						if (isX4Correct && isY4Correct) {
							resultDiv.textContent = "✓ Correct ! Le minimum est bien au point (2,2)";
							resultDiv.className = "result correct";
							resultDiv.style.display = "block";
							hintDiv.style.display = "none";
							markAsSolved(id);
							recordInteraction(id, x4,y4, true, "x:2,y:2");
						} else {
							resultDiv.textContent = "✗ Incorrect. Réessayez ou utilisez l'indice.";
							resultDiv.className = "result incorrect";
							resultDiv.style.display = "block";
							hintDiv.style.display = "block";
							recordInteraction(id, x4,y4, false, "x:2,y:2");
						}
						break;
				}
			}
			
			`,
				
				code: `<div class="exercise-card" data-exercise="1">
				<h2>Lecture de points sur une droite</h2>
				<p>Identifiez l'équation de la droite passant par les points A(2,3) et B(5,9).</p>
				
				<canvas id="canvas1" width="300" height="300"></canvas>
				
				<div class="input-group">
					<label>Coefficient directeur (a) :</label>
					<input type="number" id="coefficient1" step="0.1">
				</div>
				
				<div class="input-group">
					<label>Ordonnée à l'origine (b) :</label>
					<input type="number" id="intercept1" step="0.1">
				</div>
				
				<button class="check-btn" id="checkBtn1">Vérifier ma réponse</button>
				<div class="result" id="result1"></div>
				<div class="hint" id="hint1">💡 Utilisez la formule a = (y₂-y₁)/(x₂-x₁) pour trouver le coefficient directeur, puis b = y₁ - a×x₁</div>
			</div>`
            },
            
            
            
			// INSÉRER ICI: Nouveau template Geometry Explorer
			"geometry3d": {
				title: "Explorateur 3D de Géométrie",
				description: "Un template pour créer une application interactive d'exploration de formes géométriques 3D. Les apprenants peuvent visualiser et manipuler différentes formes en 3D tout en découvrant leurs propriétés mathématiques.",
				features: [
					"Visualisation 3D de six formes géométriques fondamentales",
					"Rotation et manipulation interactive des modèles",
					"Calculs automatiques des propriétés (volume, surface, etc.)",
					"Contrôles pour modifier les dimensions des formes",
					"Affichage des formules mathématiques"
				],
				icon: "fas fa-cube",
				previewHtml: `
					<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #0f172a; border-radius: 10px; color: #f8fafc;">
						<h3 style="margin-bottom: 10px; color: #f72585;">Explorateur 3D de Géométrie</h3>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<!-- Aperçu du cube -->
							<div style="padding: 10px; background: #1e293b; border-radius: 8px; color: #f8fafc;">
								<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Cube</div>
								<div style="width: 100%; height: 120px; background: #1e293b; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 8px; overflow: hidden;">
									<div style="width: 60px; height: 60px; background: #4361ee; border: 2px solid #f72585; border-radius: 5px; transform: rotate(30deg) rotateX(30deg);"></div>
								</div>
							</div>
							
							<!-- Aperçu de la sphère -->
							<div style="padding: 10px; background: #1e293b; border-radius: 8px; color: #f8fafc;">
								<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Sphère</div>
								<div style="width: 100%; height: 120px; background: #1e293b; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 8px; overflow: hidden;">
									<div style="width: 60px; height: 60px; background: #4361ee; border: 1px solid #f72585; border-radius: 50%;"></div>
								</div>
							</div>
						</div>
						<div style="margin-top: 15px; display: flex; gap: 10px;">
							<button style="padding: 8px 15px; background: #4361ee; color: white; border: none; border-radius: 20px; cursor: pointer;">Forme suivante</button>
							<button style="padding: 8px 15px; background: #3a0ca3; color: white; border: none; border-radius: 20px; cursor: pointer;">Réinitialiser</button>
						</div>
					</div>
				`,
				
				
                jsCode: `// ATTENTION CODE JAVASCRIPT SPECIFIQUE AU TEMPLATE PYTHON : PRIORITE OBLIGATOIRE SI CHOISIE
			document.addEventListener('DOMContentLoaded', function() {
				// S'assurer que Three.js est chargé
				loadThreeJS();
			});
			
			// Variables globales
			let scene, camera, renderer;
			let currentShape = 'cube';
			let currentMesh = null;
			let wireframe = null;
			let axesHelper = null;
			let isRotating = true;
			let currentDimensions = {}; // Stocke les dimensions actuelles de la forme
			
			// Charger Three.js
			function loadThreeJS() {
				const script = document.createElement('script');
				script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
				script.onload = initGeometryExplorer;
				document.head.appendChild(script);
			}      

      
			// Initialiser l'explorateur de géométrie
			function initGeometryExplorer() {
				if (typeof THREE === 'undefined') {
					console.error("Three.js n'a pas pu être chargé");
					return;
				}
				
				// Ajouter les styles CSS
				addStyles();
				
				// Initialiser la scène Three.js
				initScene();
				
				// Initialiser l'interface utilisateur
				initUI();
			}
            
            
			// Définition des formes et leurs propriétés
			const shapes = {
				cube: {
					name: "Cube",
					create: function(size = 1) {
						return new THREE.BoxGeometry(size, size, size);
					},
					dimensions: [
						{ name: "Côté", id: "size", min: 0.5, max: 2, step: 0.1, default: 1 }
					],
					properties: function(dimensions) {
						const size = dimensions.size;
						return [
							{
								title: "Caractéristiques",
								items: [
									{ name: "Nom mathématique", value: "Hexaèdre régulier" },
									{ name: "Nombre de faces", value: "6" },
									{ name: "Nombre d'arêtes", value: "12" },
									{ name: "Nombre de sommets", value: "8" },
									{ name: "Solide de Platon", value: "Oui" }
								]
							},
							{
								title: "Mesures",
								items: [
									{ name: "Longueur du côté", value: size.toFixed(2) + " unités" },
									{ name: "Volume", value: Math.pow(size, 3).toFixed(2) + " unités³", 
									  formula: "V = a³ = " + Math.pow(size, 3).toFixed(2) },
									{ name: "Surface totale", value: (6 * Math.pow(size, 2)).toFixed(2) + " unités²", 
									  formula: "S = 6a² = " + (6 * Math.pow(size, 2)).toFixed(2) },
									{ name: "Diagonale", value: (Math.sqrt(3) * size).toFixed(2) + " unités", 
									  formula: "d = a√3 = " + (Math.sqrt(3) * size).toFixed(2) }
								]
							}
						];
					}
				},
				sphere: {
					name: "Sphère",
					create: function(radius = 1, widthSegments = 32, heightSegments = 16) {
						return new THREE.SphereGeometry(radius, widthSegments, heightSegments);
					},
					dimensions: [
						{ name: "Rayon", id: "radius", min: 0.5, max: 2, step: 0.1, default: 1 },
						{ name: "Segments", id: "segments", min: 8, max: 64, step: 4, default: 32 }
					],
					properties: function(dimensions) {
						const radius = dimensions.radius;
						return [
							{
								title: "Caractéristiques",
								items: [
									{ name: "Nom mathématique", value: "Sphère" },
									{ name: "Type", value: "Surface de révolution" },
									{ name: "Symétrie", value: "Sphérique (infinie)" }
								]
							},
							{
								title: "Mesures",
								items: [
									{ name: "Rayon", value: radius.toFixed(2) + " unités" },
									{ name: "Diamètre", value: (2 * radius).toFixed(2) + " unités" },
									{ name: "Volume", value: ((4/3) * Math.PI * Math.pow(radius, 3)).toFixed(2) + " unités³",
									  formula: "V = (4/3)πr³ = " + ((4/3) * Math.PI * Math.pow(radius, 3)).toFixed(2) },
									{ name: "Surface", value: (4 * Math.PI * Math.pow(radius, 2)).toFixed(2) + " unités²",
									  formula: "S = 4πr² = " + (4 * Math.PI * Math.pow(radius, 2)).toFixed(2) },
									{ name: "Circonférence", value: (2 * Math.PI * radius).toFixed(2) + " unités",
									  formula: "C = 2πr = " + (2 * Math.PI * radius).toFixed(2) }
								]
							}
						];
					}
				},
				cylinder: {
					name: "Cylindre",
					create: function(radius = 0.5, height = 2, radialSegments = 32) {
						return new THREE.CylinderGeometry(radius, radius, height, radialSegments);
					},
					dimensions: [
						{ name: "Rayon", id: "radius", min: 0.2, max: 1, step: 0.1, default: 0.5 },
						{ name: "Hauteur", id: "height", min: 1, max: 3, step: 0.1, default: 2 }
					],
					properties: function(dimensions) {
						const radius = dimensions.radius;
						const height = dimensions.height;
						return [
							{
								title: "Caractéristiques",
								items: [
									{ name: "Nom mathématique", value: "Cylindre de révolution" },
									{ name: "Type", value: "Surface de révolution" },
									{ name: "Sections planes", value: "Cercle ou rectangle" }
								]
							},
							{
								title: "Mesures",
								items: [
									{ name: "Rayon", value: radius.toFixed(2) + " unités" },
									{ name: "Hauteur", value: height.toFixed(2) + " unités" },
									{ name: "Volume", value: (Math.PI * Math.pow(radius, 2) * height).toFixed(2) + " unités³",
									  formula: "V = πr²h = " + (Math.PI * Math.pow(radius, 2) * height).toFixed(2) },
									{ name: "Surface latérale", value: (2 * Math.PI * radius * height).toFixed(2) + " unités²",
									  formula: "SL = 2πrh = " + (2 * Math.PI * radius * height).toFixed(2) },
									{ name: "Surface totale", value: (2 * Math.PI * radius * (radius + height)).toFixed(2) + " unités²",
									  formula: "S = 2πr(r + h) = " + (2 * Math.PI * radius * (radius + height)).toFixed(2) }
								]
							}
						];
					}
				},
				cone: {
					name: "Cône",
					create: function(radius = 1, height = 2, radialSegments = 32) {
						return new THREE.ConeGeometry(radius, height, radialSegments);
					},
					dimensions: [
						{ name: "Rayon", id: "radius", min: 0.5, max: 2, step: 0.1, default: 1 },
						{ name: "Hauteur", id: "height", min: 1, max: 3, step: 0.1, default: 2 }
					],
					properties: function(dimensions) {
						const radius = dimensions.radius;
						const height = dimensions.height;
						const slantHeight = Math.sqrt(Math.pow(radius, 2) + Math.pow(height, 2));
						return [
							{
								title: "Caractéristiques",
								items: [
									{ name: "Nom mathématique", value: "Cône de révolution" },
									{ name: "Type", value: "Surface de révolution" },
									{ name: "Base", value: "Cercle" }
								]
							},
							{
								title: "Mesures",
								items: [
									{ name: "Rayon de la base", value: radius.toFixed(2) + " unités" },
									{ name: "Hauteur", value: height.toFixed(2) + " unités" },
									{ name: "Apothème (hauteur latérale)", value: slantHeight.toFixed(2) + " unités",
									  formula: "l = √(r² + h²) = " + slantHeight.toFixed(2) },
									{ name: "Volume", value: ((1/3) * Math.PI * Math.pow(radius, 2) * height).toFixed(2) + " unités³",
									  formula: "V = (1/3)πr²h = " + ((1/3) * Math.PI * Math.pow(radius, 2) * height).toFixed(2) },
									{ name: "Surface latérale", value: (Math.PI * radius * slantHeight).toFixed(2) + " unités²",
									  formula: "SL = πrl = " + (Math.PI * radius * slantHeight).toFixed(2) },
									{ name: "Surface totale", value: (Math.PI * radius * (radius + slantHeight)).toFixed(2) + " unités²",
									  formula: "S = πr(r + l) = " + (Math.PI * radius * (radius + slantHeight)).toFixed(2) }
								]
							}
						];
					}
				},
				tetrahedron: {
					name: "Tétraèdre",
					create: function(radius = 1) {
						return new THREE.TetrahedronGeometry(radius);
					},
					dimensions: [
						{ name: "Rayon", id: "radius", min: 0.5, max: 2, step: 0.1, default: 1 }
					],
					properties: function(dimensions) {
						const radius = dimensions.radius;
						// Pour un tétraèdre régulier, la longueur d'arête est liée au rayon inscrit
						const edgeLength = (2 * radius * Math.sqrt(6)).toFixed(2);
						return [
							{
								title: "Caractéristiques",
								items: [
									{ name: "Nom mathématique", value: "Tétraèdre régulier" },
									{ name: "Nombre de faces", value: "4 (triangles équilatéraux)" },
									{ name: "Nombre d'arêtes", value: "6" },
									{ name: "Nombre de sommets", value: "4" },
									{ name: "Solide de Platon", value: "Oui" }
								]
							},
							{
								title: "Mesures",
								items: [
									{ name: "Rayon", value: radius.toFixed(2) + " unités" },
									{ name: "Longueur d'arête approx.", value: edgeLength + " unités" },
									{ name: "Volume", value: (Math.sqrt(2) / 12 * Math.pow(parseFloat(edgeLength), 3)).toFixed(2) + " unités³",
									  formula: "V = (√2/12)a³" },
									{ name: "Surface totale", value: (Math.sqrt(3) * Math.pow(parseFloat(edgeLength), 2)).toFixed(2) + " unités²",
									  formula: "S = √3 × a²" },
									{ name: "Angle dièdre", value: "70.53° (arccos(1/3))" }
								]
							}
						];
					}
				},
				torus: {
					name: "Tore",
					create: function(radius = 0.7, tube = 0.3, radialSegments = 16, tubularSegments = 100) {
						return new THREE.TorusGeometry(radius, tube, radialSegments, tubularSegments);
					},
					dimensions: [
						{ name: "Rayon principal", id: "radius", min: 0.5, max: 1.5, step: 0.1, default: 0.7 },
						{ name: "Rayon du tube", id: "tube", min: 0.1, max: 0.5, step: 0.05, default: 0.3 }
					],
					properties: function(dimensions) {
						const R = dimensions.radius; // Rayon principal (du centre du tore au centre du tube)
						const r = dimensions.tube;  // Rayon du tube
						return [
							{
								title: "Caractéristiques",
								items: [
									{ name: "Nom mathématique", value: "Tore" },
									{ name: "Type", value: "Surface de révolution" },
									{ name: "Genus", value: "1 (avec un 'trou')" },
									{ name: "Sections", value: "Cercles" }
								]
							},
							{
								title: "Mesures",
								items: [
									{ name: "Rayon principal (R)", value: R.toFixed(2) + " unités" },
									{ name: "Rayon du tube (r)", value: r.toFixed(2) + " unités" },
									{ name: "Volume", value: (2 * Math.pow(Math.PI, 2) * R * Math.pow(r, 2)).toFixed(2) + " unités³",
									  formula: "V = 2π²Rr² = " + (2 * Math.pow(Math.PI, 2) * R * Math.pow(r, 2)).toFixed(2) },
									{ name: "Surface", value: (4 * Math.pow(Math.PI, 2) * R * r).toFixed(2) + " unités²",
									  formula: "S = 4π²Rr = " + (4 * Math.pow(Math.PI, 2) * R * r).toFixed(2) }
								]
							}
						];
					}
				}
			};
            
			// Initialiser la scène Three.js
			function initScene() {
				// Récupérer le conteneur
				const container = document.getElementById('model-container');
				const width = container.clientWidth;
				const height = container.clientHeight;
				
				// Créer la scène
				scene = new THREE.Scene();
				scene.background = new THREE.Color(0x1e293b);
				
				// Créer la caméra
				camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
				camera.position.z = 5;
				
				// Créer le renderer
				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setSize(width, height);
				renderer.setPixelRatio(window.devicePixelRatio);
				
				// Vider le conteneur et ajouter le renderer
				container.innerHTML = '';
				container.appendChild(renderer.domElement);
				
				// Ajouter l'éclairage
				const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
				scene.add(ambientLight);
				
				const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
				directionalLight.position.set(1, 1, 1);
				scene.add(directionalLight);
				
				const backLight = new THREE.DirectionalLight(0x4361ee, 0.5);
				backLight.position.set(-1, -1, -1);
				scene.add(backLight);
				
				// Ajouter un helper pour les axes
				axesHelper = new THREE.AxesHelper(2);
				scene.add(axesHelper);
				
				// Créer la forme initiale
				createShape('cube');
				
				// Démarrer l'animation
				animate();
				
				// Gérer le redimensionnement de la fenêtre
				window.addEventListener('resize', handleResize);
			}
			
			// Créer une forme
			function createShape(shapeId) {
				// Supprimer la forme précédente si elle existe
				if (currentMesh) {
					scene.remove(currentMesh);
				}
				
				if (wireframe) {
					scene.remove(wireframe);
				}
				
				// Mettre à jour la forme actuelle
				currentShape = shapeId;
				
				// Récupérer les dimensions par défaut de la forme
				const shapeDef = shapes[shapeId];
				currentDimensions = {};
				shapeDef.dimensions.forEach(dim => {
					currentDimensions[dim.id] = dim.default;
				});
				
				// Créer la géométrie en fonction des dimensions
				const geometry = createGeometryWithDimensions(shapeId, currentDimensions);
				
				// Créer le matériau
				const material = new THREE.MeshPhongMaterial({
					color: 0x4361ee,
					shininess: 60,
					specular: 0xffffff
				});
				
				// Créer le mesh
				currentMesh = new THREE.Mesh(geometry, material);
				scene.add(currentMesh);
				
				// Créer le wireframe
				const wireframeGeometry = new THREE.WireframeGeometry(geometry);
				const wireframeMaterial = new THREE.LineBasicMaterial({
					color: 0xf72585,
					linewidth: 1
				});
				wireframe = new THREE.LineSegments(wireframeGeometry, wireframeMaterial);
				scene.add(wireframe);
				
				// Mettre à jour les contrôles de dimension
				updateDimensionControls();
				
				// Mettre à jour les propriétés
				updateProperties();
				
				// Mettre à jour les boutons
				updateShapeButtons();
			}
			
			// Créer une géométrie avec les dimensions spécifiées
			function createGeometryWithDimensions(shapeId, dimensions) {
				const shapeDef = shapes[shapeId];
				switch(shapeId) {
					case 'cube':
						return shapeDef.create(dimensions.size);
					case 'sphere':
						return shapeDef.create(dimensions.radius, dimensions.segments, dimensions.segments / 2);
					case 'cylinder':
						return shapeDef.create(dimensions.radius, dimensions.height);
					case 'cone':
						return shapeDef.create(dimensions.radius, dimensions.height);
					case 'tetrahedron':
						return shapeDef.create(dimensions.radius);
					case 'torus':
						return shapeDef.create(dimensions.radius, dimensions.tube);
					default:
						return shapeDef.create();
				}
			}

			// Mettre à jour les contrôles de dimension
			function updateDimensionControls() {
				const dimensionControls = document.getElementById('dimension-controls');
				dimensionControls.innerHTML = '';
				
				const shapeDef = shapes[currentShape];
				shapeDef.dimensions.forEach(dim => {
					const control = document.createElement('div');
					control.className = 'dimension-control';
					
					const label = document.createElement('label');
					label.textContent = dim.name + ':';
					
					const input = document.createElement('input');
					input.type = 'range';
					input.min = dim.min;
					input.max = dim.max;
					input.step = dim.step;
					input.value = currentDimensions[dim.id];
					input.id = 'dim-' + dim.id;
					
					const value = document.createElement('span');
					value.className = 'dimension-value';
					value.textContent = currentDimensions[dim.id];
					
					input.addEventListener('input', function() {
						currentDimensions[dim.id] = parseFloat(this.value);
						value.textContent = this.value;
						updateShape();
					});
					
					control.appendChild(label);
					control.appendChild(input);
					control.appendChild(value);
					dimensionControls.appendChild(control);
				});
			}


			// Mettre à jour la forme avec les nouvelles dimensions
			function updateShape() {
				// Supprimer la forme précédente
				if (currentMesh) {
					scene.remove(currentMesh);
				}
				
				if (wireframe) {
					scene.remove(wireframe);
				}
				
				// Créer la nouvelle géométrie
				const geometry = createGeometryWithDimensions(currentShape, currentDimensions);
				
				// Créer le matériau
				const material = new THREE.MeshPhongMaterial({
					color: 0x4361ee,
					shininess: 60,
					specular: 0xffffff
				});
				
				// Créer le mesh
				currentMesh = new THREE.Mesh(geometry, material);
				scene.add(currentMesh);
				
				// Créer le wireframe
				const wireframeGeometry = new THREE.WireframeGeometry(geometry);
				const wireframeMaterial = new THREE.LineBasicMaterial({
					color: 0xf72585,
					linewidth: 1
				});
				wireframe = new THREE.LineSegments(wireframeGeometry, wireframeMaterial);
				scene.add(wireframe);
				
				// Mettre à jour la visibilité du wireframe
				wireframe.visible = document.getElementById('toggle-wireframe').checked;
				
				// Mettre à jour les propriétés
				updateProperties();
			}
            
			// Mettre à jour les boutons de forme
			function updateShapeButtons() {
				document.querySelectorAll('.shape-btn').forEach(btn => {
					if (btn.getAttribute('data-shape') === currentShape) {
						btn.classList.add('active');
					} else {
						btn.classList.remove('active');
					}
				});
			}
			
			// Animation
			function animate() {
				requestAnimationFrame(animate);
				
				// Rotation de la forme si activée
				if (isRotating && currentMesh) {
					currentMesh.rotation.x += 0.005;
					currentMesh.rotation.y += 0.01;
					
					if (wireframe) {
						wireframe.rotation.copy(currentMesh.rotation);
					}
				}
				
				renderer.render(scene, camera);
			}
			
			// Initialiser l'interface utilisateur
			function initUI() {
				// Boutons de forme
				document.querySelectorAll('.shape-btn').forEach(btn => {
					btn.addEventListener('click', function() {
						createShape(this.getAttribute('data-shape'));
					});
				});
				
				// Toggle wireframe
				document.getElementById('toggle-wireframe').addEventListener('change', function() {
					if (wireframe) {
						wireframe.visible = this.checked;
					}
				});
				
				// Toggle rotation
				document.getElementById('toggle-rotation').addEventListener('change', function() {
					isRotating = this.checked;
				});
				
				// Toggle axes
				document.getElementById('toggle-axes').addEventListener('change', function() {
					if (axesHelper) {
						axesHelper.visible = this.checked;
					}
				});
				
				// Bouton réinitialiser la vue
				document.getElementById('reset-view-btn').addEventListener('click', function() {
					if (currentMesh) {
						currentMesh.rotation.set(0, 0, 0);
						if (wireframe) {
							wireframe.rotation.set(0, 0, 0);
						}
						
						// Réinitialiser les dimensions
						const shapeDef = shapes[currentShape];
						shapeDef.dimensions.forEach(dim => {
							currentDimensions[dim.id] = dim.default;
							const input = document.getElementById('dim-' + dim.id);
							if (input) {
								input.value = dim.default;
								const valueSpan = input.nextElementSibling;
								if (valueSpan) {
									valueSpan.textContent = dim.default;
								}
							}
						});
						
						updateShape();
					}
				});
				
				// Bouton forme suivante
				document.getElementById('next-shape-btn').addEventListener('click', function() {
					const shapeKeys = Object.keys(shapes);
					const currentIndex = shapeKeys.indexOf(currentShape);
					const nextIndex = (currentIndex + 1) % shapeKeys.length;
					createShape(shapeKeys[nextIndex]);
				});
			}
			
			// Redimensionnement de la fenêtre
			function handleResize() {
				const container = document.getElementById('model-container');
				const width = container.clientWidth;
				const height = container.clientHeight;
				
				camera.aspect = width / height;
				camera.updateProjectionMatrix();
				
				renderer.setSize(width, height);
			}
			
			// Initialiser la scène et l'interface pour démarrer l'application
			function initializeGeometryExplorer() {
				initScene();
				initUI();
			}

            }`,

				// Code HTML du template
				code: `<!-- CODE HTML geometry 3D -->
				
					<div class="container">
						<div class="header">
							<h1>Explorateur de formes géométriques 3D</h1>
							<p>Découvrez les propriétés mathématiques des formes 3D fondamentales</p>
						</div>
						
						<div class="model-viewer">
							<div class="model-container" id="model-container"></div>
						</div>
						
						<div class="info-panel">
							<div class="shape-selector">
								<button class="shape-btn active" data-shape="cube">Cube</button>
								<button class="shape-btn" data-shape="sphere">Sphère</button>
								<button class="shape-btn" data-shape="cylinder">Cylindre</button>
								<button class="shape-btn" data-shape="cone">Cône</button>
								<button class="shape-btn" data-shape="tetrahedron">Tétraèdre</button>
								<button class="shape-btn" data-shape="torus">Tore</button>
							</div>
							
							<div class="toggle-controls">
								<label class="toggle-btn">
									<span>Afficher les arêtes</span>
									<label class="toggle-switch">
										<input type="checkbox" id="toggle-wireframe" checked>
										<span class="toggle-slider"></span>
									</label>
								</label>
								
								<label class="toggle-btn">
									<span>Rotation automatique</span>
									<label class="toggle-switch">
										<input type="checkbox" id="toggle-rotation" checked>
										<span class="toggle-slider"></span>
									</label>
								</label>
								
								<label class="toggle-btn">
									<span>Afficher les axes</span>
									<label class="toggle-switch">
										<input type="checkbox" id="toggle-axes" checked>
										<span class="toggle-slider"></span>
									</label>
								</label>
							</div>
							
							<div class="dimension-controls" id="dimension-controls">
								<!-- Les contrôles de dimension seront générés dynamiquement par JavaScript -->
							</div>
							
							<div class="property-section" id="property-section">
								<!-- Les propriétés seront générées dynamiquement par JavaScript -->
							</div>
							
							<div class="control-panel">
								<button class="control-btn" id="reset-view-btn">Réinitialiser la vue</button>
								<button class="control-btn" id="next-shape-btn">Forme suivante</button>
							</div>
						</div>
					</div>				
				`,
								
			}      
            
            
        };

        // Fonction pour changer d'onglet
        function changeTab(tabNumber) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`tab-content-${tabNumber}`).classList.add('active');
            document.querySelector(`.tab-${tabNumber}`).classList.add('active');
        }

        // LIGNE DE REPÉRAGE COMMUNE - NE PAS SUPPRIMER

        // Fonction pour afficher une notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Fonction pour ouvrir le modal de détails du template
        function openTemplateDetails(templateId) {
            const template = templatesDetails[templateId];
            if (!template) return;
            
            // Remplir le modal avec les détails du template
            document.getElementById('modal-template-title').textContent = template.title;
            
            // Description
            let descriptionHtml = `
                <p>${template.description}</p>
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Fonctionnalités principales:</h3>
                <ul>
            `;
            
            template.features.forEach(feature => {
                descriptionHtml += `<li>${feature}</li>`;
            });
            
            descriptionHtml += `</ul>`;
            document.getElementById('modal-description').innerHTML = descriptionHtml;
            
            // Aperçu
            document.getElementById('modal-preview').innerHTML = template.previewHtml;
            
            // Code
            document.getElementById('modal-code').innerHTML = `
                <div class="code-preview">${template.code}</div>
            `;
            
            // Définir le template à sélectionner
            document.getElementById('select-template-btn').setAttribute('data-template', templateId);
            
            // Afficher le modal
            document.getElementById('template-details-modal').style.display = 'block';
            
            // Activer l'onglet de description
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.content-body').forEach(body => {
                body.classList.remove('active');
            });
            document.querySelector('[data-content="description"]').classList.add('active');
            document.getElementById('modal-description').classList.add('active');
        }

        // Fonction pour fermer le modal
        function closeTemplateModal() {
            document.getElementById('template-details-modal').style.display = 'none';
        }

        // Fonction pour sélectionner un template
        function selectTemplate(templateId) {
            // Mettre à jour l'état
            appState.selectedTemplate = templateId;
            
            // Mettre à jour l'UI
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`.template-card[data-template="${templateId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Activer le bouton suivant
            document.getElementById('next-tab-2').disabled = false;
            
            // Afficher les détails du template sélectionné
            const template = templatesDetails[templateId];
            if (template) {
                const detailsContainer = document.getElementById('template-details');
                detailsContainer.innerHTML = `
                    <div class="section-title">Template sélectionné: ${template.title}</div>
                    <p>${template.description}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-special" id="view-details-btn">
                            <i class="fas fa-eye"></i> Voir les détails complets
                        </button>
                    </div>
                `;
                
                document.getElementById('view-details-btn').addEventListener('click', () => {
                    openTemplateDetails(templateId);
                });
                
                // Mettre à jour les paramètres spécifiques au template dans l'onglet 3
                updateTemplateSpecificSettings(templateId);
                
                // Mettre à jour la prévisualisation du template
                updateTemplatePreview(templateId);
            }
            
            // Fermer le modal si ouvert
            closeTemplateModal();
            
            showNotification(`Template "${template.title}" sélectionné!`);
        }



		// REPERE POUR LES CATEGORIES

		// DOUBLON ???? Fonction pour initialiser les catégories des templates DOUBLON ???? DOUBLON ????
		function initializeTemplateCategories() {
			// Définir les catégories pour chaque template
			const templateCategories = {
				'qcm': 'general',
				'sequence': 'general',
				'category': 'general',
				'match': 'general'
				
				
			};
			
			// DOUBLON ???? Appliquer les catégories aux cartes de templates DOUBLON ???? DOUBLON ???? DOUBLON ????
			document.querySelectorAll('.template-card').forEach(card => {
				const templateId = card.getAttribute('data-template');
				if (templateId && templateCategories[templateId]) {
					// Ajouter l'attribut de catégorie
					card.setAttribute('data-category', templateCategories[templateId]);
					
					// Mettre à jour la couleur de l'icône pour correspondre
					const iconElement = card.querySelector('.card-icon');
					if (iconElement) {
						const colors = {
							'general': '#b85570',

						};
						iconElement.style.color = colors[templateCategories[templateId]];
					}
				}
			});
		}
		


        // Fonction pour mettre à jour la prévisualisation du template dans l'onglet 3
        function updateTemplatePreview(templateId) {
            const previewContainer = document.getElementById('template-preview');
            
            if (!templateId || !templatesDetails[templateId]) {
                previewContainer.innerHTML = `<p>Veuillez d'abord sélectionner un template dans l'étape précédente.</p>`;
                return;
            }
            
            // Si c'est le template 3D, vérifier le thème
            if (templateId === '3d') {
                const theme = document.getElementById('model-theme').value;
                
                if (theme === 'molecules') {
                    // Afficher un aperçu spécifique aux molécules
                    previewContainer.innerHTML = `
                    <div class="preview-card">
                        <div class="preview-header">
                            <span>Modèles 3D - Molécules</span>
                            <div class="preview-icon">🧪</div>
                        </div>
                        <div class="preview-body">
                            <div class="preview-description">
                                Explorez les structures moléculaires en 3D avec rotation, zoom et détails interactifs.
                            </div>
                            
                            <div class="model3d-container" style="padding: 15px; background: #1a273a; border-radius: 10px; color: #e1e1e1; margin: 15px 0;">
                                <div style="text-align: center; font-weight: bold; margin-bottom: 10px;">Molécule H₂O</div>
                                <div style="width: 100%; height: 200px; background: #1a273a; display: flex; align-items: center; justify-content: center; position: relative; border-radius: 8px; overflow: hidden;">
                                    <!-- Oxygène -->
                                    <div style="width: 50px; height: 50px; background: #ff0000; border-radius: 50%; position: relative; z-index: 2;"></div>
                                    <!-- Hydrogènes -->
                                    <div style="width: 30px; height: 30px; background: #ffffff; border-radius: 50%; position: absolute; top: 80px; left: 120px; z-index: 1;"></div>
                                    <div style="width: 30px; height: 30px; background: #ffffff; border-radius: 50%; position: absolute; top: 80px; right: 120px; z-index: 1;"></div>
                                    <!-- Liaisons -->
                                    <div style="width: 50px; height: 3px; background: #aaaaaa; position: absolute; top: 105px; left: 145px; transform: rotate(-45deg);"></div>
                                    <div style="width: 50px; height: 3px; background: #aaaaaa; position: absolute; top: 105px; right: 145px; transform: rotate(45deg);"></div>
                                    
                                    <div class="model3d-controls" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(26, 39, 58, 0.7); padding: 5px; display: flex; justify-content: center;">
                                        <button style="background: white; border: none; border-radius: 4px; width: 30px; height: 30px; margin: 0 5px; color: #1a273a; font-weight: bold;">R</button>
                                        <button style="background: white; border: none; border-radius: 4px; width: 30px; height: 30px; margin: 0 5px; color: #1a273a; font-weight: bold;">⏸️</button>
                                        <button style="background: white; border: none; border-radius: 4px; width: 30px; height: 30px; margin: 0 5px; color: #1a273a; font-weight: bold;">▶️</button>
                                        <button style="background: white; border: none; border-radius: 4px; width: 30px; height: 30px; margin: 0 5px; color: #1a273a; font-weight: bold;">+</button>
                                        <button style="background: white; border: none; border-radius: 4px; width: 30px; height: 30px; margin: 0 5px; color: #1a273a; font-weight: bold;">-</button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <div style="font-size: 1.1em; margin-bottom: 10px;">Structure de l'eau (H₂O)</div>
                                    <div style="color: #b5b5b5; font-size: 0.95em; line-height: 1.5;">
                                        Molécule composée d'un atome d'oxygène et de deux atomes d'hydrogène. Sa géométrie moléculaire est coudée avec un angle de liaison d'environ 104,5°.
                                    </div>
                                    
                                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                                        <button style="padding: 8px 15px; background: #1a5276; color: white; border: none; border-radius: 5px; font-weight: bold;">Détails</button>
                                        <button style="padding: 8px 15px; background: #34495e; color: white; border: none; border-radius: 5px;">Molécule suivante</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    return;
				}
            }
            
			if (templateId === 'statistics') {
				// Créer une prévisualisation personnalisée en fonction des options choisies
				const selectedGraphs = appState.templateSettings.statistics.selectedGraphs;
				const colorScheme = appState.templateSettings.statistics.colorScheme;
				
				// Générer une prévisualisation appropriée
				let previewHtml = `
				<div class="preview-card">
					<div class="preview-header">
						<span>Visualisations Statistiques</span>
						<div class="preview-icon">📊</div>
					</div>
					<div class="preview-body">
						<div class="preview-description">
							Explorez et interprétez les données à travers ${selectedGraphs.length} types de visualisations graphiques interactives.
						</div>`;
				
				// Ajouter une prévisualisation de graphiques en fonction des sélections
				if (selectedGraphs.length > 0) {
					previewHtml += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">`;
					
					// Ajouter jusqu'à 2 aperçus de graphiques
					for (let i = 0; i < Math.min(2, selectedGraphs.length); i++) {
						const graphType = selectedGraphs[i];
						let graphPreview = '';
						
						// Générer un aperçu en fonction du type de graphique
						switch (graphType) {
							case 'histogram':
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Histogramme</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: flex-end; justify-content: space-around; padding: 5px;">
										<div style="width: 12%; height: 60%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0;"></div>
										<div style="width: 12%; height: 95%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0;"></div>
										<div style="width: 12%; height: 15%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0;"></div>
										<div style="width: 12%; height: 25%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0;"></div>
										<div style="width: 12%; height: 10%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0;"></div>
										<div style="width: 12%; height: 40%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0;"></div>
									</div>
								</div>`;
								break;
							case 'piechart':
								let pieColors = '';
								switch (colorScheme) {
									case 'blue':
										pieColors = 'conic-gradient(#3498db 0% 35%, #2980b9 35% 60%, #1f618d 60% 75%, #154360 75% 100%)';
										break;
									case 'green':
										pieColors = 'conic-gradient(#2ecc71 0% 35%, #27ae60 35% 60%, #229954 60% 75%, #1e8449 75% 100%)';
										break;
									case 'red':
										pieColors = 'conic-gradient(#e74c3c 0% 35%, #c0392b 35% 60%, #a93226 60% 75%, #922b21 75% 100%)';
										break;
									default:
										pieColors = 'conic-gradient(#e74c3c 0% 35%, #f1c40f 35% 60%, #e67e22 60% 75%, #2ecc71 75% 100%)';
								}
								
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Diagramme Circulaire</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
										<div style="width: 100px; height: 100px; border-radius: 50%; background: ${pieColors};"></div>
									</div>
								</div>`;
								break;
							case 'radar':
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Diagramme Radar</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
										<div style="position: relative; width: 100px; height: 100px;">
											<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid #ddd; border-radius: 50%;"></div>
											<div style="position: absolute; top: 25%; left: 25%; width: 50%; height: 50%; border: 1px solid #ddd; border-radius: 50%;"></div>
											<div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #ddd;"></div>
											<div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: #ddd;"></div>
											<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); width: 100%; height: 1px; background: #ddd;"></div>
											<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); width: 100%; height: 1px; background: #ddd;"></div>
											<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 60%; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); background: ${colorScheme === 'blue' ? 'rgba(52, 152, 219, 0.6)' : colorScheme === 'green' ? 'rgba(46, 204, 113, 0.6)' : colorScheme === 'red' ? 'rgba(231, 76, 60, 0.6)' : 'rgba(52, 152, 219, 0.6)'};"></div>
										</div>
									</div>
								</div>`;
								break;
							case 'boxplot':
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Boîte à Moustaches</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
										<div style="position: relative; width: 120px; height: 80px;">
											<div style="position: absolute; top: 40%; left: 10%; width: 80%; height: 20%; background: ${colorScheme === 'blue' ? 'rgba(52, 152, 219, 0.6)' : colorScheme === 'green' ? 'rgba(46, 204, 113, 0.6)' : colorScheme === 'red' ? 'rgba(231, 76, 60, 0.6)' : 'rgba(52, 152, 219, 0.6)'}; border: 1px solid #333;"></div>
											<div style="position: absolute; top: 40%; left: 50%; width: 1px; height: 20%; background: #e74c3c;"></div>
											<div style="position: absolute; top: 0%; left: 50%; width: 1px; height: 40%; background: #333;"></div>
											<div style="position: absolute; top: 60%; left: 50%; width: 1px; height: 40%; background: #333;"></div>
											<div style="position: absolute; top: 0%; left: 35%; width: 30%; height: 1px; background: #333;"></div>
											<div style="position: absolute; top: 100%; left: 35%; width: 30%; height: 1px; background: #333;"></div>
										</div>
									</div>
								</div>`;
								break;
							case 'multiHistogram':
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Histogramme Comparatif</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: flex-end; justify-content: space-around; padding: 5px;">
										<div style="display: flex; width: 20%; height: 100px; align-items: flex-end;">
											<div style="width: 45%; height: 60%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0; margin-right: 2px;"></div>
											<div style="width: 45%; height: 45%; background: ${colorScheme === 'blue' ? '#2980b9' : colorScheme === 'green' ? '#27ae60' : colorScheme === 'red' ? '#c0392b' : '#2ecc71'}; border-radius: 3px 3px 0 0;"></div>
										</div>
										<div style="display: flex; width: 20%; height: 100px; align-items: flex-end;">
											<div style="width: 45%; height: 95%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0; margin-right: 2px;"></div>
											<div style="width: 45%; height: 75%; background: ${colorScheme === 'blue' ? '#2980b9' : colorScheme === 'green' ? '#27ae60' : colorScheme === 'red' ? '#c0392b' : '#2ecc71'}; border-radius: 3px 3px 0 0;"></div>
										</div>
										<div style="display: flex; width: 20%; height: 100px; align-items: flex-end;">
											<div style="width: 45%; height: 15%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0; margin-right: 2px;"></div>
											<div style="width: 45%; height: 25%; background: ${colorScheme === 'blue' ? '#2980b9' : colorScheme === 'green' ? '#27ae60' : colorScheme === 'red' ? '#c0392b' : '#2ecc71'}; border-radius: 3px 3px 0 0;"></div>
										</div>
										<div style="display: flex; width: 20%; height: 100px; align-items: flex-end;">
											<div style="width: 45%; height: 25%; background: ${colorScheme === 'blue' ? '#3498db' : colorScheme === 'green' ? '#2ecc71' : colorScheme === 'red' ? '#e74c3c' : '#3498db'}; border-radius: 3px 3px 0 0; margin-right: 2px;"></div>
											<div style="width: 45%; height: 35%; background: ${colorScheme === 'blue' ? '#2980b9' : colorScheme === 'green' ? '#27ae60' : colorScheme === 'red' ? '#c0392b' : '#2ecc71'}; border-radius: 3px 3px 0 0;"></div>
										</div>
									</div>
								</div>`;
								break;
							case 'donut':
								let donutColors = '';
								switch (colorScheme) {
									case 'blue':
										donutColors = 'conic-gradient(#3498db 0% 35%, #2980b9 35% 60%, #1f618d 60% 75%, #154360 75% 100%)';
										break;
									case 'green':
										donutColors = 'conic-gradient(#2ecc71 0% 35%, #27ae60 35% 60%, #229954 60% 75%, #1e8449 75% 100%)';
										break;
									case 'red':
										donutColors = 'conic-gradient(#e74c3c 0% 35%, #c0392b 35% 60%, #a93226 60% 75%, #922b21 75% 100%)';
										break;
									default:
										donutColors = 'conic-gradient(#3498db 0% 35%, #2ecc71 35% 60%, #e74c3c 60% 75%, #f39c12 75% 100%)';
								}
								
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Diagramme en Anneau</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
										<div style="width: 100px; height: 100px; border-radius: 50%; background: ${donutColors}; position: relative;">
											<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border-radius: 50%; background: white;"></div>
										</div>
									</div>
								</div>`;
								break;
							default:
								graphPreview = `
								<div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
									<div style="text-align: center; font-weight: bold; margin-bottom: 5px;">${graphType}</div>
									<div style="width: 100%; height: 120px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
										<p>Aperçu non disponible</p>
									</div>
								</div>`;
						}
						
						previewHtml += graphPreview;
					}
					
					previewHtml += `</div>`;
				}
				
				// Ajouter des informations sur les options sélectionnées
				previewHtml += `
						<div class="preview-description">
							<strong>Options configurées:</strong><br>
							• Schéma de couleurs: ${colorScheme}<br>
							• Légendes: ${appState.templateSettings.statistics.showLegends ? 'Activées' : 'Désactivées'}<br>
							• Étiquettes: ${appState.templateSettings.statistics.showLabels ? 'Activées' : 'Désactivées'}<br>
							• Animation: ${appState.templateSettings.statistics.animateGraphs ? 'Activée' : 'Désactivée'}
						</div>
						
						<div class="button-group">
							<button class="preview-btn preview-btn-primary">Explorer les graphiques</button>
						</div>
					</div>
				</div>
				`;
				
				previewContainer.innerHTML = previewHtml;
			}            
            
            
			// INSÉRER ICI - Juste après la fin du bloc conditionnel pour le template 3D
			// Si c'est le template graphique
			if (templateId === 'graphique') {
				previewContainer.innerHTML = `
				<div class="preview-card">
					<div class="preview-header">
						<span>Système de Tracés Graphiques</span>
						<div class="preview-icon">📊</div>
					</div>
					<div class="preview-body">
						<div class="preview-description">
							Explorez les concepts mathématiques à travers des graphiques interactifs. Identifiez des équations de droites, vérifiez l'appartenance de points, et plus encore.
						</div>
						
						<div style="width: 100%; height: 250px; background: #f5f5f5; border-radius: 8px; position: relative; overflow: hidden; margin: 15px 0;">
							<!-- Grille simplifiée -->
							<div style="position: absolute; width: 100%; height: 100%;">
								<!-- Lignes verticales -->
								<div style="position: absolute; left: 10%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 20%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 30%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 40%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #333;"></div>
								<div style="position: absolute; left: 60%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 70%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 80%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								<div style="position: absolute; left: 90%; top: 0; bottom: 0; width: 1px; background: #ddd;"></div>
								
								<!-- Lignes horizontales -->
								<div style="position: absolute; top: 10%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 20%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 30%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 40%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: #333;"></div>
								<div style="position: absolute; top: 60%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 70%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 80%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								<div style="position: absolute; top: 90%; left: 0; right: 0; height: 1px; background: #ddd;"></div>
								
								<!-- Points -->
								<div style="position: absolute; left: 65%; top: 30%; width: 10px; height: 10px; background: #3498db; border-radius: 50%; transform: translate(-50%, -50%);"></div>
								<div style="position: absolute; left: 75%; top: 20%; width: 10px; height: 10px; background: #3498db; border-radius: 50%; transform: translate(-50%, -50%);"></div>
								
								<!-- Étiquettes des points -->
								<div style="position: absolute; left: calc(65% + 8px); top: calc(30% - 8px); font-size: 12px; font-weight: bold;">A(2,3)</div>
								<div style="position: absolute; left: calc(75% + 8px); top: calc(20% - 8px); font-size: 12px; font-weight: bold;">B(5,9)</div>
								
								<!-- Droite -->
								<div style="position: absolute; left: 0; top: 70%; right: 0; height: 2px; background: #e74c3c; transform: rotate(-20deg); transform-origin: left center;"></div>
							</div>
						</div>
						
						<div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
							<div style="display: flex; gap: 10px; align-items: center;">
								<label style="min-width: 200px; font-weight: bold;">Coefficient directeur (a):</label>
								<input type="number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1;" placeholder="Entrez votre réponse">
							</div>
							<div style="display: flex; gap: 10px; align-items: center;">
								<label style="min-width: 200px; font-weight: bold;">Ordonnée à l'origine (b):</label>
								<input type="number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1;" placeholder="Entrez votre réponse">
							</div>
						</div>
						
						<div class="button-group">
							<button class="preview-btn preview-btn-primary">Vérifier ma réponse</button>
						</div>
					</div>
				</div>
				`;
				return;
			}           
			
            
            // Si on arrive ici, afficher la prévisualisation par défaut
            previewContainer.innerHTML = templatesDetails[templateId].previewHtml;
        }

        // Fonction pour mettre à jour les paramètres spécifiques au template
        function updateTemplateSpecificSettings(templateId) {
            const container = document.getElementById('template-specific-settings');
            let html = `<div class="section-title">Paramètres spécifiques au template: ${templatesDetails[templateId].title}</div>`;
            
            switch(templateId) {
				case 'qcm':
					html += `
						<div class="form-group">
							<label class="form-label" for="qcm-options">Nombre d'options par question:</label>
							<select id="qcm-options" class="form-select">
								<option value="2">2 options</option>
								<option value="3">3 options</option>
								<option value="4" selected>4 options</option>
								<option value="5">5 options</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="qcm-attempts">Nombre de tentatives par question:</label>
							<select id="qcm-attempts" class="form-select">
								<option value="1" selected>1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3">3 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs réponses correctes:</span>
							<label class="switch">
								<input type="checkbox" id="qcm-multiple">
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Désactiver les autres réponses après une réponse</span>
							<label class="switch">
								<input type="checkbox" id="qcm-disable-after" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les explications après réponse:</span>
							<label class="switch">
								<input type="checkbox" id="qcm-explanations" checked>
								<span class="slider"></span>
							</label>
						</div>
					`;
					break;
                        
				case 'tableaux':
					html += `
						<div class="form-group">
							<label class="form-label" for="tableaux-function-type">Type de fonction:</label>
							<select id="tableaux-function-type" class="form-select">
								<option value="lineaire">Linéaire f(x) = ax</option>
								<option value="affine" selected>Affine f(x) = ax + b</option>
								<option value="polynome">Polynôme f(x) = ax² + bx + c</option>
								<option value="trigonometrique">Trigonométrique f(x) = a*sin(x) + b</option>
								<option value="custom">Personnalisé</option>
							</select>
						</div>
						
						<div class="form-group" id="tableaux-custom-container" style="display: none;">
							<label class="form-label" for="tableaux-custom-function">Fonction personnalisée:</label>
							<input 
								type="text" 
								id="tableaux-custom-function" 
								class="form-input" 
								placeholder="Ex: f(x) = x³ - 2x + 1"
							>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="tableaux-columns">Nombre de colonnes:</label>
							<select id="tableaux-columns" class="form-select">
								<option value="5">5 colonnes</option>
								<option value="7" selected>7 colonnes</option>
								<option value="9">9 colonnes</option>
								<option value="11">11 colonnes</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="tableaux-values">Nombre de valeurs à calculer:</label>
							<select id="tableaux-values" class="form-select">
								<option value="2">2 valeurs</option>
								<option value="3">3 valeurs</option>
								<option value="4" selected>4 valeurs</option>
								<option value="5">5 valeurs</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="tableaux-calculation">Type de calcul:</label>
							<select id="tableaux-calculation" class="form-select">
								<option value="images" selected>Images (calculer f(x))</option>
								<option value="antecedents">Antécédents (calculer x)</option>
								<option value="mixed">Les deux (images et antécédents)</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="tableaux-multiple-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group" id="tableaux-attempts-container">
							<label class="form-label" for="tableaux-max-attempts">Nombre maximum de tentatives:</label>
							<select id="tableaux-max-attempts" class="form-select">
								<option value="1">1 tentative</option>
								<option value="2" selected>2 tentatives</option>
								<option value="3">3 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Aperçu du template Tableaux de valeurs</div>
						
						<div style="background: #f5f7fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
							<div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 20px;">
								<div style="border-left: 4px solid #4b6cb7; padding-left: 15px; margin-bottom: 20px;">
									<h3 style="color: #4b6cb7; margin-bottom: 10px;">Fonction f(x) = 2x + 1</h3>
									<p style="color: #333;">Complétez le tableau de valeurs</p>
								</div>
								
								<div style="overflow-x: auto; margin-bottom: 15px;">
									<table style="width: 100%; border-collapse: collapse;">
										<tr style="background: #f0f8ff;">
											<th style="border: 1px solid #ddd; padding: 8px;">x</th>
											<th style="border: 1px solid #ddd; padding: 8px;">-2</th>
											<th style="border: 1px solid #ddd; padding: 8px;">-1</th>
											<th style="border: 1px solid #ddd; padding: 8px;">0</th>
											<th style="border: 1px solid #ddd; padding: 8px;">1</th>
											<th style="border: 1px solid #ddd; padding: 8px;">2</th>
										</tr>
										<tr>
											<td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">f(x)</td>
											<td style="border: 1px solid #ddd; padding: 8px; background: #f9f9f9;">-3</td>
											<td style="border: 1px solid #ddd; padding: 8px;"><input type="text" style="width: 50px; text-align: center; border: 1px solid #4b6cb7;" placeholder="?"></td>
											<td style="border: 1px solid #ddd; padding: 8px; background: #f9f9f9;">1</td>
											<td style="border: 1px solid #ddd; padding: 8px;"><input type="text" style="width: 50px; text-align: center; border: 1px solid #4b6cb7;" placeholder="?"></td>
											<td style="border: 1px solid #ddd; padding: 8px; background: #f9f9f9;">5</td>
										</tr>
									</table>
								</div>
								
								<div style="background: #e9ecef; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
									<div style="width: 300px; height: 150px; background: white; border-radius: 5px; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: #666;">
										[Graphique de la fonction]
									</div>
								</div>
								
								<button style="width: 100%; padding: 12px; background: #4b6cb7; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
									Vérifier ma réponse
								</button>
							</div>
						</div>
					`;
					break;
                        
                        

                        
				case 'stats':
					html += `
						<div class="form-group">
							<label class="form-label" for="stats-correlation-strength">Force de corrélation par défaut:</label>
							<select id="stats-correlation-strength" class="form-select">
								<option value="random" selected>Aléatoire</option>
								<option value="strong">Forte (R² > 0.7)</option>
								<option value="moderate">Modérée (0.3 < R² ≤ 0.7)</option>
								<option value="weak">Faible (R² ≤ 0.3)</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="stats-correlation-type">Type de corrélation par défaut:</label>
							<select id="stats-correlation-type" class="form-select">
								<option value="random" selected>Aléatoire</option>
								<option value="positive">Positive</option>
								<option value="negative">Négative</option>
								<option value="neutral">Sans influence</option>
							</select>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Types de questions</div>
						
						<div class="checkbox-container">
							<div class="checkbox-item">
								<input type="checkbox" id="stats-question-extrapolation" checked>
								<label for="stats-question-extrapolation">Extrapolation</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="stats-question-interpolation" checked>
								<label for="stats-question-interpolation">Interpolation</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="stats-question-correlation-type" checked>
								<label for="stats-question-correlation-type">Type de corrélation</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="stats-question-r2-interpretation" checked>
								<label for="stats-question-r2-interpretation">Interprétation du R²</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="stats-question-fit-quality" checked>
								<label for="stats-question-fit-quality">Qualité d'ajustement</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="stats-question-correlation-strength" checked>
								<label for="stats-question-correlation-strength">Force de corrélation</label>
							</div>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="stats-multiple-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="stats-max-attempts">Nombre maximum de tentatives:</label>
							<select id="stats-max-attempts" class="form-select">
								<option value="1">1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3" selected>3 tentatives</option>
								<option value="5">5 tentatives</option>
							</select>
						</div>
						
					`;
					
					// Ajouter les écouteurs d'événements pour les paramètres spécifiques
					setTimeout(() => {
						const statsCorrelationStrength = document.getElementById('stats-correlation-strength');
						const statsCorrelationType = document.getElementById('stats-correlation-type');
						const statsMultipleAttempts = document.getElementById('stats-multiple-attempts');
						const statsMaxAttempts = document.getElementById('stats-max-attempts');
						
						// Initialiser les paramètres par défaut
						if (!appState.templateSettings.stats) {
							appState.templateSettings.stats = {
								correlationStrength: 'random',
								correlationType: 'random',
								multipleAttempts: true,
								maxAttempts: 3,
								questions: {
									extrapolation: true,
									interpolation: true,
									correlationType: true,
									r2Interpretation: true,
									fitQuality: true,
									correlationStrength: true
								}
							};
						}
						
						// Ajouter les écouteurs d'événements
						if (statsCorrelationStrength) {
							statsCorrelationStrength.addEventListener('change', function() {
								appState.templateSettings.stats.correlationStrength = this.value;
							});
							statsCorrelationStrength.value = appState.templateSettings.stats.correlationStrength;
						}
						
						if (statsCorrelationType) {
							statsCorrelationType.addEventListener('change', function() {
								appState.templateSettings.stats.correlationType = this.value;
							});
							statsCorrelationType.value = appState.templateSettings.stats.correlationType;
						}
						
						if (statsMultipleAttempts) {
							statsMultipleAttempts.addEventListener('change', function() {
								appState.templateSettings.stats.multipleAttempts = this.checked;
							});
							statsMultipleAttempts.checked = appState.templateSettings.stats.multipleAttempts;
						}
						
						if (statsMaxAttempts) {
							statsMaxAttempts.addEventListener('change', function() {
								appState.templateSettings.stats.maxAttempts = parseInt(this.value);
							});
							statsMaxAttempts.value = appState.templateSettings.stats.maxAttempts.toString();
						}
						
						// Ajouter les écouteurs pour les cases à cocher des types de questions
						const questionTypes = ['extrapolation', 'interpolation', 'correlationType', 'r2Interpretation', 'fitQuality', 'correlationStrength'];
						questionTypes.forEach(type => {
							const checkbox = document.getElementById(`stats-question-${type}`);
							if (checkbox) {
								checkbox.addEventListener('change', function() {
									appState.templateSettings.stats.questions[type] = this.checked;
								});
								checkbox.checked = appState.templateSettings.stats.questions[type];
							}
						});
					}, 100);
					break;
                        
                        
                        
                        
				case 'derivees':
                    html += `
                        <div class="form-group">
                            <label class="form-label" for="derivees-polynomial-degree">Degré du polynôme:</label>
                            <select id="derivees-polynomial-degree" class="form-select">
                                <option value="2" selected>Degré 2 (ax² + bx + c)</option>
                                <option value="3">Degré 3 (ax³ + bx² + cx + d)</option>
                                <option value="4">Degré 4 (ax⁴ + bx³ + cx² + dx + e)</option>
                                <option value="5">Degré 5 (ax⁵ + bx⁴ + cx³ + dx² + ex + f)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="derivees-question-type">Type de questions:</label>
                            <select id="derivees-question-type" class="form-select">
                                <option value="derivative_expression" selected>Expression de la dérivée</option>
                                <option value="derivative_value">Nombre dérivé pour une valeur donnée</option>
                                <option value="solve_derivative_zero">Solution de f'(x) = 0</option>
                            </select>
                        </div>
                        
                        <div class="switch-container">
                            <span class="switch-label">Autoriser plusieurs tentatives:</span>
                            <label class="switch">
                                <input type="checkbox" id="derivees-multiple-attempts" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="form-group" id="derivees-attempts-settings">
                            <label class="form-label" for="derivees-max-attempts">Nombre maximum de tentatives:</label>
                            <select id="derivees-max-attempts" class="form-select">
                                <option value="1">1 tentative</option>
                                <option value="2" selected>2 tentatives</option>
                                <option value="3">3 tentatives</option>
                                <option value="4">4 tentatives</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="derivees-difficulty">Difficulté des coefficients:</label>
                            <select id="derivees-difficulty" class="form-select">
                                <option value="easy">Facile (coefficients entiers positifs 1 à 10)</option>
                                <option value="medium" selected>Moyen (coefficients entiers -10 à 10 )</option>
                                <option value="hard">Difficile (coefficients décimaux -10 à 10 / pas de 0,1)</option>
                            </select>
                        </div>
                        
                        <div class="section-block">
                            <div class="section-title">Exemples selon le degré</div>
                            <div id="derivees-degree-examples">
                                <div class="degree-example">
                                    <strong>Degré 2:</strong> f(x) = 3x² + 5x + 2 → f'(x) = 6x + 5
                                </div>
                                <div class="degree-example">
                                    <strong>Degré 3:</strong> f(x) = 2x³ - x² + 4x - 1 → f'(x) = 6x² - 2x + 4
                                </div>
                                <div class="degree-example">
                                    <strong>Degré 4:</strong> f(x) = x⁴ - 3x³ + x² - 2x + 5 → f'(x) = 4x³ - 9x² + 2x - 2
                                </div>
                                <div class="degree-example">
                                    <strong>Degré 5:</strong> f(x) = x⁵ + 2x⁴ - x³ + 3x² - x + 1 → f'(x) = 5x⁴ + 8x³ - 3x² + 6x - 1
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                        
                        
				case 'probability':
					html += `
						<div class="form-group">
							<label class="form-label" for="simulation-type">Type de simulation:</label>
							<select id="simulation-type" class="form-select">
								<option value="both" selected>Pièces et dés</option>
								<option value="coin">Uniquement les pièces</option>
								<option value="dice">Uniquement les dés</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="question-type">Types de questions:</label>
							<select id="question-type" class="form-select">
								<option value="all" selected>Toutes les questions</option>
								<option value="frequency">Questions de fréquence</option>
								<option value="probability">Questions de probabilité</option>
								<option value="interactive">Questions interactives</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Inclure des calculs de fréquence:</span>
							<label class="switch">
								<input type="checkbox" id="include-frequency-calc" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Montrer les explications détaillées:</span>
							<label class="switch">
								<input type="checkbox" id="show-explanations" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="max-simulations">Nombre maximum de lancers:</label>
							<select id="max-simulations" class="form-select">
								<option value="100">100 lancers</option>
								<option value="500">500 lancers</option>
								<option value="1000" selected>1000 lancers</option>
								<option value="5000">5000 lancers</option>
							</select>
						</div>
					`;
					
					break;
                        
                        
                        
				case 'proba':
					html += `
						<div class="form-group">
							<label class="form-label" for="proba-event-a">Nom de l'événement A:</label>
							<input type="text" id="proba-event-a" class="form-input" value="Fleur" placeholder="Ex: Fleur, Pair, Homme...">
						</div>
						
						<div class="form-group">
							<label class="form-label" for="proba-event-b">Nom de l'événement B:</label>
							<input type="text" id="proba-event-b" class="form-input" value="Rouge" placeholder="Ex: Rouge, Impair, Femme...">
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Types de questions</div>
						
						<div class="checkbox-container">
							<div class="checkbox-item">
								<input type="checkbox" id="proba-type-basic" checked>
								<label for="proba-type-basic">Type 1: Probabilités simples (P(A), P(B), P(non A))</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="proba-type-compound" checked>
								<label for="proba-type-compound">Type 2: Probabilités composées (P(A∪B), P(A∩B))</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="proba-type-conditional" checked>
								<label for="proba-type-conditional">Type 3: Probabilités conditionnelles (P(A|B), P(B|A))</label>
							</div>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Options de réponse</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="proba-multiple-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group" id="proba-max-attempts-container">
							<label class="form-label" for="proba-max-attempts">Nombre maximum de tentatives:</label>
							<select id="proba-max-attempts" class="form-select">
								<option value="2">2 tentatives</option>
								<option value="3" selected>3 tentatives</option>
								<option value="5">5 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les indices:</span>
							<label class="switch">
								<input type="checkbox" id="proba-show-hints" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Aperçu du tableau</div>
						
						<div style="max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; border-radius: 10px;">
							<table style="width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1.1rem;">
								<tr>
									<th style="border: 2px solid #ddd; padding: 8px; background-color: #f0f0f0;"></th>
									<th style="border: 2px solid #ddd; padding: 8px; background-color: #e6e6ff;">Fleur</th>
									<th style="border: 2px solid #ddd; padding: 8px; background-color: rgba(255, 123, 84, 0.1);">Pomme</th>
									<th style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5;">Total</th>
								</tr>
								<tr>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: rgba(255, 92, 92, 0.1); font-weight: bold;">Rouge</td>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: yellow;">1</td>
									<td style="border: 2px solid #ddd; padding: 8px;">3</td>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">4</td>
								</tr>
								<tr>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: rgba(255, 195, 86, 0.1); font-weight: bold;">Jaune</td>
									<td style="border: 2px solid #ddd; padding: 8px;">4</td>
									<td style="border: 2px solid #ddd; padding: 8px;">2</td>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">6</td>
								</tr>
								<tr>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">Total</td>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">5</td>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">5</td>
									<td style="border: 2px solid #ddd; padding: 8px; background-color: #f5f5f5; font-weight: bold;">10</td>
								</tr>
							</table>
						</div>
					`;
					
					// Ajouter les écouteurs d'événements pour les options spécifiques au template
					setTimeout(() => {
						const eventAInput = document.getElementById('proba-event-a');
						const eventBInput = document.getElementById('proba-event-b');
						const typeBasicCheck = document.getElementById('proba-type-basic');
						const typeCompoundCheck = document.getElementById('proba-type-compound');
						const typeConditionalCheck = document.getElementById('proba-type-conditional');
						const multipleAttemptsCheck = document.getElementById('proba-multiple-attempts');
						const maxAttemptsSelect = document.getElementById('proba-max-attempts');
						const showHintsCheck = document.getElementById('proba-show-hints');
						
						if (eventAInput) {
							eventAInput.addEventListener('input', (e) => {
								appState.templateSettings.proba.eventAName = e.target.value;
							});
						}
						
						if (eventBInput) {
							eventBInput.addEventListener('input', (e) => {
								appState.templateSettings.proba.eventBName = e.target.value;
							});
						}
						
						// Gestion des types de questions
						const updateQuestionTypes = () => {
							const types = [];
							if (typeBasicCheck.checked) types.push('basic');
							if (typeCompoundCheck.checked) types.push('compound');
							if (typeConditionalCheck.checked) types.push('conditional');
							appState.templateSettings.proba.questionTypes = types;
						};
						
						if (typeBasicCheck) typeBasicCheck.addEventListener('change', updateQuestionTypes);
						if (typeCompoundCheck) typeCompoundCheck.addEventListener('change', updateQuestionTypes);
						if (typeConditionalCheck) typeConditionalCheck.addEventListener('change', updateQuestionTypes);
						
						// Gestion des tentatives
						if (multipleAttemptsCheck) {
							multipleAttemptsCheck.addEventListener('change', (e) => {
								appState.templateSettings.proba.allowMultipleAttempts = e.target.checked;
								const container = document.getElementById('proba-max-attempts-container');
								if (container) {
									container.style.display = e.target.checked ? 'block' : 'none';
								}
							});
						}
						
						if (maxAttemptsSelect) {
							maxAttemptsSelect.addEventListener('change', (e) => {
								appState.templateSettings.proba.maxAttempts = e.target.value;
							});
						}
						
						if (showHintsCheck) {
							showHintsCheck.addEventListener('change', (e) => {
								appState.templateSettings.proba.showHints = e.target.checked;
							});
						}
						
						// Initialiser avec les valeurs de l'état
						if (eventAInput) eventAInput.value = appState.templateSettings.proba.eventAName;
						if (eventBInput) eventBInput.value = appState.templateSettings.proba.eventBName;
						
						if (typeBasicCheck && typeCompoundCheck && typeConditionalCheck) {
							const types = appState.templateSettings.proba.questionTypes;
							typeBasicCheck.checked = types.includes('basic');
							typeCompoundCheck.checked = types.includes('compound');
							typeConditionalCheck.checked = types.includes('conditional');
						}
						
						if (multipleAttemptsCheck) {
							multipleAttemptsCheck.checked = appState.templateSettings.proba.allowMultipleAttempts;
							const container = document.getElementById('proba-max-attempts-container');
							if (container) {
								container.style.display = appState.templateSettings.proba.allowMultipleAttempts ? 'block' : 'none';
							}
						}
						
						if (maxAttemptsSelect && appState.templateSettings.proba.maxAttempts) {
							maxAttemptsSelect.value = appState.templateSettings.proba.maxAttempts;
						}
						
						if (showHintsCheck) {
							showHintsCheck.checked = appState.templateSettings.proba.showHints;
						}
					}, 100);
					break;
                        
                        
                        

				case 'arbre_proba':
					html += `
						<div class="section-title">Options de l'arbre de probabilité</div>
						
						<div class="form-group">
							<label class="form-label" for="arbre-proba-type">Type d'arbre de probabilité:</label>
							<select id="arbre-proba-type" class="form-select">
								<option value="both" selected>Les deux types (naissances et pondéré)</option>
								<option value="birth">Uniquement naissance de deux enfants</option>
								<option value="weighted">Uniquement arbre pondéré (A et B)</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="arbre-proba-exercises-type">Type de questions:</label>
							<select id="arbre-proba-exercises-type" class="form-select">
								<option value="both" selected>Les deux types d'arbres</option>
								<option value="birth">Uniquement sur les naissances</option>
								<option value="weighted">Uniquement sur les arbres pondérés</option>
							</select>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Contextualisation des événements</div>
						
						<div class="switch-container">
							<span class="switch-label">Contextualiser les événements A et B:</span>
							<label class="switch">
								<input type="checkbox" id="arbre-proba-contextualize" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div id="contextualize-container">
							<div class="form-group">
								<label class="form-label" for="event-a-description">Description de l'événement A:</label>
								<input type="text" id="event-a-description" class="form-input" placeholder="Ex: Il pleut" value="Il pleut">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="event-b-description">Description de l'événement B:</label>
								<input type="text" id="event-b-description" class="form-input" placeholder="Ex: J ai un parapluie" value="parapluie">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="event-a-emoji">Emoji pour l'événement A (optionnel):</label>
								<input type="text" id="event-a-emoji" class="form-input" placeholder="Ex: 🌧️" value="🌧️">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="event-b-emoji">Emoji pour l'événement B (optionnel):</label>
								<input type="text" id="event-b-emoji" class="form-input" placeholder="Ex: ☂️" value="☂️">
							</div>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Probabilités par défaut</div>
						
						<div class="form-group">
							<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
								<div>
									<label class="form-label" for="prob-a-default">P(A):</label>
									<input type="number" id="prob-a-default" class="form-input" min="0" max="1" step="0.1" value="0.6">
								</div>
								<div>
									<label class="form-label" for="prob-b-given-a-default">P(B|A):</label>
									<input type="number" id="prob-b-given-a-default" class="form-input" min="0" max="1" step="0.1" value="0.7">
								</div>
								<div>
									<label class="form-label" for="prob-b-given-not-a-default">P(B|non-A):</label>
									<input type="number" id="prob-b-given-not-a-default" class="form-input" min="0" max="1" step="0.1" value="0.2">
								</div>
							</div>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Aperçu de l'arbre</div>
						
						<div style="max-width: 100%; margin: 0 auto; padding: 20px; background: #f5f7fa; border-radius: 10px; text-align: center;">
							<div style="margin-bottom: 10px; font-weight: bold;" id="arbre-preview-title">Arbre de probabilité</div>
							
							<svg width="300" height="200" style="margin: 0 auto;" id="arbre-preview-svg">
								<!-- Lignes de l'arbre -->
								<line x1="150" y1="30" x2="75" y2="80" stroke="#4cc9f0" stroke-width="3"></line>
								<line x1="150" y1="30" x2="225" y2="80" stroke="#ff70a6" stroke-width="3"></line>
								<line x1="75" y1="80" x2="40" y2="150" stroke="#4cc9f0" stroke-width="3"></line>
								<line x1="75" y1="80" x2="110" y2="150" stroke="#ff70a6" stroke-width="3"></line>
								<line x1="225" y1="80" x2="190" y2="150" stroke="#4cc9f0" stroke-width="3"></line>
								<line x1="225" y1="80" x2="260" y2="150" stroke="#ff70a6" stroke-width="3"></line>
								
								<!-- Nœuds -->
								<circle cx="150" cy="30" r="15" fill="white" stroke="#ea6687" stroke-width="2"></circle>
								<circle cx="75" cy="80" r="15" fill="#4cc9f0" stroke="#4cc9f0" stroke-width="2"></circle>
								<circle cx="225" cy="80" r="15" fill="#ff70a6" stroke="#ff70a6" stroke-width="2"></circle>
								<circle cx="40" cy="150" r="15" fill="#4cc9f0" stroke="#4cc9f0" stroke-width="2"></circle>
								<circle cx="110" cy="150" r="15" fill="#ff70a6" stroke="#ff70a6" stroke-width="2"></circle>
								<circle cx="190" cy="150" r="15" fill="#4cc9f0" stroke="#4cc9f0" stroke-width="2"></circle>
								<circle cx="260" cy="150" r="15" fill="#ff70a6" stroke="#ff70a6" stroke-width="2"></circle>
								
								<!-- Textes -->
								<text x="150" y="35" text-anchor="middle" fill="#333" font-weight="bold">D</text>
								<text x="75" y="85" text-anchor="middle" fill="white" font-weight="bold" class="arbre-node-label">A</text>
								<text x="225" y="85" text-anchor="middle" fill="white" font-weight="bold" class="arbre-node-label">Ā</text>
								<text x="40" y="155" text-anchor="middle" fill="white" font-weight="bold" class="arbre-node-label">B</text>
								<text x="110" y="155" text-anchor="middle" fill="white" font-weight="bold" class="arbre-node-label">B̄</text>
								<text x="190" y="155" text-anchor="middle" fill="white" font-weight="bold" class="arbre-node-label">B</text>
								<text x="260" y="155" text-anchor="middle" fill="white" font-weight="bold" class="arbre-node-label">B̄</text>
							</svg>
						</div>
					`;
					
					// Ajouter les écouteurs d'événements après insertion du HTML
					setTimeout(() => {
						// Gestionnaire pour la contextualisation
						const contextualizeCheck = document.getElementById('arbre-proba-contextualize');
						const contextualizeContainer = document.getElementById('contextualize-container');
						
						if (contextualizeCheck && contextualizeContainer) {
							contextualizeCheck.addEventListener('change', function() {
								contextualizeContainer.style.display = this.checked ? 'block' : 'none';
								appState.templateSettings.arbre_proba.contextualizeEvents = this.checked;
								updateArbreProbaPreview();
							});
							
							// État initial
							appState.templateSettings.arbre_proba.contextualizeEvents = contextualizeCheck.checked;
							contextualizeContainer.style.display = contextualizeCheck.checked ? 'block' : 'none';
						}
						
						// Autres écouteurs
						const typeSelect = document.getElementById('arbre-proba-type');
						if (typeSelect) {
							typeSelect.addEventListener('change', function() {
								appState.templateSettings.arbre_proba.arbreType = this.value;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.arbreType = typeSelect.value;
						}
						
						const exercisesTypeSelect = document.getElementById('arbre-proba-exercises-type');
						if (exercisesTypeSelect) {
							exercisesTypeSelect.addEventListener('change', function() {
								appState.templateSettings.arbre_proba.questionsType = this.value;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.questionsType = exercisesTypeSelect.value;
						}
						
						// Descriptions des événements
						const eventADescription = document.getElementById('event-a-description');
						if (eventADescription) {
							eventADescription.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.eventADescription = this.value;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.eventADescription = eventADescription.value;
						}
						
						const eventBDescription = document.getElementById('event-b-description');
						if (eventBDescription) {
							eventBDescription.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.eventBDescription = this.value;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.eventBDescription = eventBDescription.value;
						}
						
						// Emojis
						const eventAEmoji = document.getElementById('event-a-emoji');
						if (eventAEmoji) {
							eventAEmoji.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.eventAEmoji = this.value;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.eventAEmoji = eventAEmoji.value;
						}
						
						const eventBEmoji = document.getElementById('event-b-emoji');
						if (eventBEmoji) {
							eventBEmoji.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.eventBEmoji = this.value;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.eventBEmoji = eventBEmoji.value;
						}
						
						// Probabilités
						const probADefault = document.getElementById('prob-a-default');
						if (probADefault) {
							probADefault.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.probA = parseFloat(this.value) || 0.6;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.probA = parseFloat(probADefault.value) || 0.6;
						}
						
						const probBGivenADefault = document.getElementById('prob-b-given-a-default');
						if (probBGivenADefault) {
							probBGivenADefault.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.probBGivenA = parseFloat(this.value) || 0.7;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.probBGivenA = parseFloat(probBGivenADefault.value) || 0.7;
						}
						
						const probBGivenNotADefault = document.getElementById('prob-b-given-not-a-default');
						if (probBGivenNotADefault) {
							probBGivenNotADefault.addEventListener('input', function() {
								appState.templateSettings.arbre_proba.probBGivenNotA = parseFloat(this.value) || 0.2;
								updateArbreProbaPreview();
							});
							appState.templateSettings.arbre_proba.probBGivenNotA = parseFloat(probBGivenNotADefault.value) || 0.2;
						}
						
						// Initialiser la prévisualisation
						updateArbreProbaPreview();
					}, 100);
					break;
                        
				case 'sequence':
					html += `
						<div class="form-group">
							<label class="form-label" for="sequence-items">Nombre d'éléments:</label>
							<select id="sequence-items" class="form-select">
								<option value="3">3 éléments</option>
								<option value="4" selected>4 éléments</option>
								<option value="5">5 éléments</option>
								<option value="6">6 éléments</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les indices:</span>
							<label class="switch">
								<input type="checkbox" id="sequence-hints" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Permettre la réorganisation:</span>
							<label class="switch">
								<input type="checkbox" id="sequence-reordering" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="sequence-multiple-attempts">
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="sequence-attempts">Nombre de tentatives par exercice:</label>
							<select id="sequence-attempts" class="form-select">
								<option value="1" selected>1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3">3 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
					
					`;
					break;
                        
                        
                        
				case 'periodic':
					html += `
						<div class="form-group">
							<label class="form-label">Types de questions:</label>
							<div class="checkbox-container">
								<div class="checkbox-item">
									<input type="checkbox" id="question-property" checked>
									<label for="question-property">Propriétés atomiques (Z, A, e-, p+, n)</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="question-molecule" checked>
									<label for="question-molecule">Calcul de masse molaire</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="question-identification" checked>
									<label for="question-identification">Identification d'éléments</label>
								</div>
							</div>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="periodic-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group" id="max-attempts-container">
							<label class="form-label" for="max-attempts">Nombre maximum de tentatives:</label>
							<select id="max-attempts" class="form-select">
								<option value="2">2 tentatives</option>
								<option value="3" selected>3 tentatives</option>
								<option value="5">5 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les indices:</span>
							<label class="switch">
								<input type="checkbox" id="periodic-hints" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group">
							<div class="section-title" style="margin-top: 20px;">Aperçu du Tableau Périodique</div>
							<div style="max-width: 100%; overflow-x: auto; padding: 15px; background: #f8f9fa; border-radius: 10px;">
								<div style="display: grid; grid-template-columns: repeat(18, 35px); grid-template-rows: repeat(2, 35px); gap: 2px; margin-bottom: 10px;">
									<!-- Première ligne (H et He) -->
									<div style="width: 35px; height: 35px; background: #a5d8e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">1</div>
										<div style="font-weight: bold;">H</div>
										<div style="font-size: 0.4rem;">Hydrogène</div>
									</div>
									<!-- Cases vides entre H et He -->
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; background: #d3a5e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">2</div>
										<div style="font-weight: bold;">He</div>
										<div style="font-size: 0.4rem;">Hélium</div>
									</div>
									
									<!-- Deuxième ligne (Li à Ne) -->
									<div style="width: 35px; height: 35px; background: #ff5733; color: white; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">3</div>
										<div style="font-weight: bold;">Li</div>
										<div style="font-size: 0.4rem;">Lithium</div>
									</div>
									<div style="width: 35px; height: 35px; background: #ffbd33; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">4</div>
										<div style="font-weight: bold;">Be</div>
										<div style="font-size: 0.4rem;">Béryllium</div>
									</div>
									<!-- Cases vides entre Be et B -->
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; visibility: hidden;"></div>
									<div style="width: 35px; height: 35px; background: #b5e6a5; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">5</div>
										<div style="font-weight: bold;">B</div>
										<div style="font-size: 0.4rem;">Bore</div>
									</div>
									<div style="width: 35px; height: 35px; background: #a5d8e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">6</div>
										<div style="font-weight: bold;">C</div>
										<div style="font-size: 0.4rem;">Carbone</div>
									</div>
									<div style="width: 35px; height: 35px; background: #a5d8e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">7</div>
										<div style="font-weight: bold;">N</div>
										<div style="font-size: 0.4rem;">Azote</div>
									</div>
									<div style="width: 35px; height: 35px; background: #a5d8e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">8</div>
										<div style="font-weight: bold;">O</div>
										<div style="font-size: 0.4rem;">Oxygène</div>
									</div>
									<div style="width: 35px; height: 35px; background: #a5d8e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">9</div>
										<div style="font-weight: bold;">F</div>
										<div style="font-size: 0.4rem;">Fluor</div>
									</div>
									<div style="width: 35px; height: 35px; background: #d3a5e6; border-radius: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;">
										<div style="position: absolute; top: 2px; left: 4px; font-size: 0.5rem;">10</div>
										<div style="font-weight: bold;">Ne</div>
										<div style="font-size: 0.4rem;">Néon</div>
									</div>
								</div>
							</div>
							<p style="margin-top: 10px; font-style: italic; text-align: center;">Le tableau périodique complet des 5 périodes sera intégré dans l'application finale.</p>
						</div>
					`;
                            
                    break;
                        
                        
                        
                case 'turtle':
					html += `
						<div class="form-group">
							<label class="form-label" for="turtle-challenge-count">Nombre de défis:</label>
							<select id="turtle-challenge-count" class="form-select">
								<option value="3">3 défis</option>
								<option value="6" selected>6 défis</option>
								<option value="8">8 défis</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les images attendues:</span>
							<label class="switch">
								<input type="checkbox" id="turtle-expected-images" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Permettre les indices:</span>
							<label class="switch">
								<input type="checkbox" id="turtle-hints" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Défis personnalisés:</span>
							<label class="switch">
								<input type="checkbox" id="turtle-custom-challenges">
								<span class="slider"></span>
							</label>
						</div>
						
						<div id="turtle-custom-challenges-container" style="display: none;">
							<div class="section-title" style="margin-top: 20px;">Défis personnalisés</div>
							
							<div class="form-group">
								<label class="form-label" for="turtle-challenge1">Défi 1:</label>
								<input type="text" id="turtle-challenge1" class="form-input" placeholder="Description du défi 1" value="Carré de 100 pixels de côté">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="turtle-challenge2">Défi 2:</label>
								<input type="text" id="turtle-challenge2" class="form-input" placeholder="Description du défi 2" value="Rectangle de 150×80 pixels">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="turtle-challenge3">Défi 3:</label>
								<input type="text" id="turtle-challenge3" class="form-input" placeholder="Description du défi 3" value="Triangle équilatéral de 100 pixels de côté">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="turtle-challenge4">Défi 4:</label>
								<input type="text" id="turtle-challenge4" class="form-input" placeholder="Description du défi 4" value="Penatgone régulier de 80 pixels de côté">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="turtle-challenge5">Défi 5:</label>
								<input type="text" id="turtle-challenge5" class="form-input" placeholder="Description du défi 5" value="Hexagone régulier de 50 pixels de côté">
							</div>
							
							<div class="form-group">
								<label class="form-label" for="turtle-challenge6">Défi 6:</label>
								<input type="text" id="turtle-challenge6" class="form-input" placeholder="Description du défi 6" value="Octogone régulier de 40 pixels de côté">
							</div>
						</div>
					`;
                            
                    break;
                        
                        
				case 'geometrique':
					html += `
						<div class="section-title">Options des Suites Géométriques</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="geometrique-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group" id="attempts-container-geo">
							<label class="form-label" for="max-attempts-geo">Nombre maximum de tentatives:</label>
							<select id="max-attempts-geo" class="form-select">
								<option value="1">1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3" selected>3 tentatives</option>
								<option value="5">5 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les formules:</span>
							<label class="switch">
								<input type="checkbox" id="geometrique-formulas" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Mettre en évidence les patterns:</span>
							<label class="switch">
								<input type="checkbox" id="geometrique-patterns" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser les termes négatifs:</span>
							<label class="switch">
								<input type="checkbox" id="geometrique-negative">
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="decimal-precision">Précision décimale:</label>
							<select id="decimal-precision" class="form-select">
								<option value="0">Nombres entiers uniquement</option>
								<option value="1" selected>Une décimale</option>
								<option value="2">Deux décimales</option>
							</select>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Types d'exercices</div>
						
						<div class="checkbox-container">
							<div class="checkbox-item">
								<input type="checkbox" id="geo-nextTerm" checked>
								<label for="geo-nextTerm">Calculer le terme suivant</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="geo-missingTerm" checked>
								<label for="geo-missingTerm">Trouver le terme manquant</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="geo-reason" checked>
								<label for="geo-reason">Calculer la raison</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="geo-rank" checked>
								<label for="geo-rank">Calculer le rang d'un terme</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="geo-nthTerm" checked>
								<label for="geo-nthTerm">Calculer le terme de rang N</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="geo-sum" checked>
								<label for="geo-sum">Calculer la somme des n premiers termes</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="geo-application" checked>
								<label for="geo-application">Problème appliqué</label>
							</div>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="difficulty-level-geo">Niveau de difficulté:</label>
							<select id="difficulty-level-geo" class="form-select">
								<option value="beginner">Débutant</option>
								<option value="intermediate" selected>Intermédiaire</option>
								<option value="advanced">Avancé</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="term-count-geo">Nombre de termes affichés:</label>
							<select id="term-count-geo" class="form-select">
								<option value="4">4 termes</option>
								<option value="5">5 termes</option>
								<option value="6" selected>6 termes</option>
							</select>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Aperçu du template</div>
						
						<div style="background: #f5f7fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
							<div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 20px; overflow: hidden;">
								<div style="text-align: center; margin-bottom: 20px; color: #6157ff; font-weight: bold; font-size: 1.2rem;">
									Suites Géométriques
								</div>
								
								<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-family: monospace;">
									u<sub>n</sub> = u<sub>1</sub> × q<sup>n-1</sup> = 2 × 3<sup>n-1</sup>
								</div>
								
								<div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
									<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 5px; font-weight: bold;">2</div>
									<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 5px; font-weight: bold;">6</div>
									<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 5px; font-weight: bold;">18</div>
									<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #6157ff; border-radius: 5px; font-weight: bold;">54</div>
								</div>
								
								<div style="background: #f7f7f7; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
									<div style="font-weight: bold; margin-bottom: 10px;">Calculer le terme suivant:</div>
									<div style="display: flex; gap: 10px; margin-bottom: 10px;">
										<input type="number" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
										<button style="background: #6157ff; color: white; border: none; border-radius: 5px; padding: 0 15px; cursor: pointer;">Vérifier</button>
									</div>
								</div>
								
								<div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
									<div style="flex: 1; min-width: 120px; background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center;">
										<div style="color: #666; font-size: 0.9em;">Premier terme</div>
										<div style="font-weight: bold; font-size: 1.5em;">2</div>
									</div>
									<div style="flex: 1; min-width: 120px; background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center;">
										<div style="color: #666; font-size: 0.9em;">Raison</div>
										<div style="font-weight: bold; font-size: 1.5em;">3</div>
									</div>
								</div>
							</div>
						</div>
					`;
					
					// Ajouter les écouteurs d'événements pour les options
					if (html) {
						setTimeout(() => {
							// Tentatives multiples
							const attemptsCheck = document.getElementById('geometrique-attempts');
							const attemptsContainer = document.getElementById('attempts-container-geo');
							const maxAttemptsSelect = document.getElementById('max-attempts-geo');
							
							if (attemptsCheck) {
								attemptsCheck.addEventListener('change', (e) => {
									if (attemptsContainer) {
										attemptsContainer.style.display = e.target.checked ? 'block' : 'none';
									}
									appState.templateSettings.geometrique.allowMultipleAttempts = e.target.checked;
								});
								
								// État initial
								if (attemptsContainer) {
									attemptsContainer.style.display = attemptsCheck.checked ? 'block' : 'none';
								}
							}
							
							if (maxAttemptsSelect) {
								maxAttemptsSelect.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.maxAttempts = e.target.value === 'unlimited' ? -1 : parseInt(e.target.value);
								});
							}
							
							// Formules
							const formulasCheck = document.getElementById('geometrique-formulas');
							if (formulasCheck) {
								formulasCheck.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.showFormulas = e.target.checked;
								});
							}
							
							// Patterns
							const patternsCheck = document.getElementById('geometrique-patterns');
							if (patternsCheck) {
								patternsCheck.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.highlightPatterns = e.target.checked;
								});
							}
							
							// Termes négatifs
							const negativeCheck = document.getElementById('geometrique-negative');
							if (negativeCheck) {
								negativeCheck.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.allowNegativeTerms = e.target.checked;
								});
							}
							
							// Précision décimale
							const precisionSelect = document.getElementById('decimal-precision');
							if (precisionSelect) {
								precisionSelect.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.decimalPrecision = parseInt(e.target.value);
								});
							}
							
							// Types d'exercices
							const exerciseTypes = ['nextTerm', 'missingTerm', 'reason', 'rank', 'nthTerm', 'sum', 'application'];
							exerciseTypes.forEach(type => {
								const checkbox = document.getElementById('geo-' + type);
								if (checkbox) {
									checkbox.addEventListener('change', (e) => {
										appState.templateSettings.geometrique.exerciseTypes[type] = e.target.checked;
									});
								}
							});
							
							// Niveau de difficulté
							const difficultySelect = document.getElementById('difficulty-level-geo');
							if (difficultySelect) {
								difficultySelect.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.difficultyLevel = e.target.value;
								});
							}
							
							// Nombre de termes
							const termCountSelect = document.getElementById('term-count-geo');
							if (termCountSelect) {
								termCountSelect.addEventListener('change', (e) => {
									appState.templateSettings.geometrique.termCount = parseInt(e.target.value);
								});
							}
						}, 100);
					}
					break;
                        
                        
                        
				case 'arithmetique':
					html += `
						<div class="section-title">Options des Suites Arithmétiques</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="arithmetique-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group" id="attempts-container">
							<label class="form-label" for="max-attempts">Nombre maximum de tentatives:</label>
							<select id="max-attempts" class="form-select">
								<option value="1">1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3" selected>3 tentatives</option>
								<option value="5">5 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les formules:</span>
							<label class="switch">
								<input type="checkbox" id="arithmetique-formulas" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Mettre en évidence les patterns:</span>
							<label class="switch">
								<input type="checkbox" id="arithmetique-patterns" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Types d'exercices</div>
						
						<div class="checkbox-container">
							<div class="checkbox-item">
								<input type="checkbox" id="ex-nextTerm" checked>
								<label for="ex-nextTerm">Calculer le terme suivant</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="ex-missingTerm" checked>
								<label for="ex-missingTerm">Trouver le terme manquant</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="ex-reason" checked>
								<label for="ex-reason">Calculer la raison</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="ex-nthTerm" checked>
								<label for="ex-nthTerm">Calculer le terme de rang n</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="ex-rank" checked>
								<label for="ex-rank">Calculer le rang d'un terme</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="ex-sum" checked>
								<label for="ex-sum">Calculer la somme des n premiers termes</label>
							</div>
							<div class="checkbox-item">
								<input type="checkbox" id="ex-application" checked>
								<label for="ex-application">Problème appliqué</label>
							</div>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="difficulty-level">Niveau de difficulté:</label>
							<select id="difficulty-level" class="form-select">
								<option value="beginner">Débutant</option>
								<option value="intermediate" selected>Intermédiaire</option>
								<option value="advanced">Avancé</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="term-count">Nombre de termes affichés:</label>
							<select id="term-count" class="form-select">
								<option value="5">5 termes</option>
								<option value="7" selected>7 termes</option>
								<option value="10">10 termes</option>
							</select>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Aperçu du template</div>
						
						<div style="background: #f5f7fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
							<div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 20px; overflow: hidden;">
								<div style="text-align: center; margin-bottom: 20px; color: #4361ee; font-weight: bold; font-size: 1.2rem;">
									Suites Arithmétiques
								</div>
								
								<div style="background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-family: monospace;">
									u<sub>n</sub> = u<sub>1</sub> + (n-1)×r = 3 + (n-1)×2
								</div>
								
								<div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
									<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #4361ee; border-radius: 5px; font-weight: bold;">3</div>
									<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #4361ee; border-radius: 5px; font-weight: bold;">5</div>
									<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #4361ee; border-radius: 5px; font-weight: bold;">7</div>
									<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #4361ee; border-radius: 5px; font-weight: bold;">9</div>
									<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: 2px solid #4361ee; border-radius: 5px; font-weight: bold;">11</div>
								</div>
								
								<div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
									<div style="flex: 1; min-width: 120px; background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center;">
										<div style="color: #666; font-size: 0.9em;">Premier terme</div>
										<div style="font-weight: bold; font-size: 1.5em;">3</div>
									</div>
									<div style="flex: 1; min-width: 120px; background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center;">
										<div style="color: #666; font-size: 0.9em;">Raison</div>
										<div style="font-weight: bold; font-size: 1.5em;">2</div>
									</div>
								</div>
								
								<div style="background: #f7f7f7; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
									<div style="font-weight: bold; margin-bottom: 10px;">Calculer le terme suivant:</div>
									<div style="display: flex; gap: 10px; margin-bottom: 10px;">
										<input type="number" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
										<button style="background: #4361ee; color: white; border: none; border-radius: 5px; padding: 0 15px; cursor: pointer;">Vérifier</button>
									</div>
								</div>
							</div>
						</div>
					`;
					
					// Ajouter les écouteurs d'événements pour les options
					if (html) {
						setTimeout(() => {
							// Tentatives multiples
							const attemptsCheck = document.getElementById('arithmetique-attempts');
							const attemptsContainer = document.getElementById('attempts-container');
							const maxAttemptsSelect = document.getElementById('max-attempts');
							
							if (attemptsCheck) {
								attemptsCheck.addEventListener('change', (e) => {
									if (attemptsContainer) {
										attemptsContainer.style.display = e.target.checked ? 'block' : 'none';
									}
									appState.templateSettings.arithmetique.allowMultipleAttempts = e.target.checked;
								});
								
								// État initial
								if (attemptsContainer) {
									attemptsContainer.style.display = attemptsCheck.checked ? 'block' : 'none';
								}
							}
							
							if (maxAttemptsSelect) {
								maxAttemptsSelect.addEventListener('change', (e) => {
									appState.templateSettings.arithmetique.maxAttempts = e.target.value === 'unlimited' ? -1 : parseInt(e.target.value);
								});
							}
							
							// Formules
							const formulasCheck = document.getElementById('arithmetique-formulas');
							if (formulasCheck) {
								formulasCheck.addEventListener('change', (e) => {
									appState.templateSettings.arithmetique.showFormulas = e.target.checked;
								});
							}
							
							// Patterns
							const patternsCheck = document.getElementById('arithmetique-patterns');
							if (patternsCheck) {
								patternsCheck.addEventListener('change', (e) => {
									appState.templateSettings.arithmetique.highlightPatterns = e.target.checked;
								});
							}
							
							// Types d'exercices
							const exerciseTypes = ['nextTerm', 'missingTerm', 'reason', 'nthTerm', 'rank', 'sum', 'application'];
							exerciseTypes.forEach(type => {
								const checkbox = document.getElementById('ex-' + type);
								if (checkbox) {
									checkbox.addEventListener('change', (e) => {
										appState.templateSettings.arithmetique.exerciseTypes[type] = e.target.checked;
									});
								}
							});
							
							// Niveau de difficulté
							const difficultySelect = document.getElementById('difficulty-level');
							if (difficultySelect) {
								difficultySelect.addEventListener('change', (e) => {
									appState.templateSettings.arithmetique.difficultyLevel = e.target.value;
								});
							}
							
							// Nombre de termes
							const termCountSelect = document.getElementById('term-count');
							if (termCountSelect) {
								termCountSelect.addEventListener('change', (e) => {
									appState.templateSettings.arithmetique.termCount = parseInt(e.target.value);
								});
							}
						}, 100);
					}
					break;
                        
                        
                        
                        
                case 'category':
                    html += `
                        <div class="form-group">
                            <label class="form-label" for="category-count">Nombre de catégories:</label>
                            <select id="category-count" class="form-select">
                                <option value="2" selected>2 catégories</option>
                                <option value="3">3 catégories</option>
                                <option value="4">4 catégories</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="items-per-category">Éléments par catégorie:</label>
                            <select id="items-per-category" class="form-select">
                                <option value="2">2 éléments</option>
                                <option value="3" selected>3 éléments</option>
                                <option value="4">4 éléments</option>
                                <option value="5">5 éléments</option>
                            </select>
                        </div>
                        
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="category-multiple-attempts">
								<span class="slider"></span>
							</label>
						</div>
                        
						<div class="form-group">
							<label class="form-label" for="category-attempts">Nombre de tentatives par exercice:</label>
							<select id="category-attempts" class="form-select">
								<option value="1" selected>1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3">3 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						

                    `;
                    break;
                    
                case 'match':
                    html += `
                        <div class="form-group">
                            <label class="form-label" for="pair-count">Nombre de paires:</label>
                            <select id="pair-count" class="form-select">
                                <option value="3">3 paires</option>
                                <option value="4">4 paires</option>
                                <option value="5" selected>5 paires</option>
                                <option value="6">6 paires</option>
                                <option value="8">8 paires</option>
                            </select>
                        </div>
                        
                        <div class="switch-container">
                            <span class="switch-label">Afficher les indices:</span>
                            <label class="switch">
                                <input type="checkbox" id="match-hints" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="match-multiple-attempts">
								<span class="slider"></span>
							</label>
						</div>

						<div class="form-group">
							<label class="form-label" for="match-attempts">Nombre de tentatives par exercice:</label>
							<select id="match-attempts" class="form-select">
								<option value="1" selected>1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3">3 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
                        
                    `;
                    break;
                    
                case 'calcul':
                    html += `
                        <div class="switch-container">
                            <span class="switch-label">Autoriser plusieurs tentatives:</span>
                            <label class="switch">
                                <input type="checkbox" id="calcul-attempts" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="switch-container">
                            <span class="switch-label">Afficher les formules:</span>
                            <label class="switch">
                                <input type="checkbox" id="calcul-formulas" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="calcul-tolerance">Tolérance pour les réponses (%):</label>
                            <select id="calcul-tolerance" class="form-select">
                                <option value="0">0% (Exacte)</option>
                                <option value="1" selected>1%</option>
                                <option value="2">2%</option>
                                <option value="5">5%</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                    
                    
				case 'python':
					html += `
						<div class="switch-container">
							<span class="switch-label">Autoriser l'édition du code:</span>
							<label class="switch">
								<input type="checkbox" id="python-editing" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher la sortie attendue:</span>
							<label class="switch">
								<input type="checkbox" id="python-output" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="python-level">Niveau de difficulté des exercices:</label>
							<select id="python-level" class="form-select">
								<option value="beginner">Débutant</option>
								<option value="intermediate" selected>Intermédiaire</option>
								<option value="advanced">Avancé</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label">Type de code et d'instructions:</label>
							<div class="checkbox-container">
								<div class="checkbox-item">
									<input type="checkbox" id="python-print-input" checked>
									<label for="python-print-input">Affichage print() et entrée input()</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="python-variables" checked>
									<label for="python-variables">Variables et opérateurs mathématiques</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="python-conditions" checked>
									<label for="python-conditions">Conditions if, else, elif</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="python-for-loops" checked>
									<label for="python-for-loops">Boucles for</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="python-while-loops">
									<label for="python-while-loops">Boucles while</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="python-functions">
									<label for="python-functions">Fonctions</label>
								</div>
								<div class="checkbox-item">
									<input type="checkbox" id="python-lists" checked>
									<label for="python-lists">Listes</label>
								</div>
							</div>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="python-attempts">Nombre de tentatives autorisées:</label>
							<select id="python-attempts" class="form-select">
								<option value="unlimited" selected>Illimité</option>
								<option value="1">1 tentative</option>
								<option value="3">3 tentatives</option>
								<option value="5">5 tentatives</option>
							</select>
						</div>
					`;
					break;
                    
                    
                    
                    
				case 'equation':
					html += `
						<div class="form-group">
							<label class="form-label" for="reactif-count">Nombre de réactifs (max) :</label>
							<select id="reactif-count" class="form-select">
								<option value="1">1 réactif</option>
								<option value="2" selected>2 réactifs</option>
								<option value="3">3 réactifs</option>
								<option value="4">4 réactifs</option>
							</select>
						</div>
						
						<div class="form-group">
							<label class="form-label" for="produit-count">Nombre de produits (max) :</label>
							<select id="produit-count" class="form-select">
								<option value="1">1 produit</option>
								<option value="2" selected>2 produits</option>
								<option value="3">3 produits</option>
								<option value="4">4 produits</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives :</span>
							<label class="switch">
								<input type="checkbox" id="equation-attempts" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div id="attempts-container">
							<div class="form-group">
								<label class="form-label" for="max-attempts">Nombre maximum de tentatives :</label>
								<select id="max-attempts" class="form-select">
									<option value="1">1 tentative</option>
									<option value="2">2 tentatives</option>
									<option value="3" selected>3 tentatives</option>
									<option value="5">5 tentatives</option>
									<option value="0">Illimité</option>
								</select>
							</div>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Afficher les indices :</span>
							<label class="switch">
								<input type="checkbox" id="equation-hints" checked>
								<span class="slider"></span>
							</label>
						</div>
						
						<div class="section-title" style="margin-top: 20px;">Aperçu du template d'équilibrage</div>
						
						<div style="background: #f5f7fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
							<div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 20px;">
								<div style="margin-bottom: 15px;">
									<h3 style="color: #a24b5f; margin-bottom: 10px;">Équilibrage d'équation</h3>
									<p style="font-weight: bold;">Équilibrez l'équation suivante :</p>
								</div>
								
								<div style="background: #f0f5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 1.2em;">
									<span style="display: inline-flex; align-items: center; margin: 0 3px;">
										<select style="width: 40px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; margin-right: 3px;">
											<option>1</option>
											<option selected>1</option>
											<option>2</option>
											<option>3</option>
										</select>
										CH<sub>4</sub>
									</span>
									<span style="margin: 0 3px;">+</span>
									<span style="display: inline-flex; align-items: center; margin: 0 3px;">
										<select style="width: 40px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; margin-right: 3px;">
											<option>1</option>
											<option selected>2</option>
											<option>3</option>
											<option>4</option>
										</select>
										O<sub>2</sub>
									</span>
									<span style="margin: 0 5px;">→</span>
									<span style="display: inline-flex; align-items: center; margin: 0 3px;">
										<select style="width: 40px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; margin-right: 3px;">
											<option selected>1</option>
											<option>2</option>
											<option>3</option>
										</select>
										CO<sub>2</sub>
									</span>
									<span style="margin: 0 3px;">+</span>
									<span style="display: inline-flex; align-items: center; margin: 0 3px;">
										<select style="width: 40px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; margin-right: 3px;">
											<option>1</option>
											<option selected>2</option>
											<option>3</option>
										</select>
										H<sub>2</sub>O
									</span>
								</div>
								
								<div style="text-align: center; margin-bottom: 15px;">
									<button style="padding: 10px 20px; background: #a24b5f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
										Vérifier
									</button>
								</div>
								
								<div style="padding: 12px; background: #d4edda; color: #155724; border-radius: 8px; margin-bottom: 15px; text-align: center;">
									<span style="font-weight: bold;">✓ Correct!</span> L'équation est parfaitement équilibrée.
								</div>
								
								<div style="padding: 12px; background: #fff3cd; color: #856404; border-radius: 8px; margin-bottom: 15px; display: none;">
									<span style="font-weight: bold;">💡 Indice:</span> Assurez-vous que le nombre d'atomes de chaque élément est identique des deux côtés de la flèche.
								</div>
							</div>
						</div>
					`;
					break;
                    
                    
					case 'chimie-orga':
						html += `
							<div class="form-group">
								<label class="form-label" for="molecule-families">Familles de molécules à inclure:</label>
								<div class="checkbox-container" style="display: flex; flex-wrap: wrap; gap: 10px;">
									<div class="checkbox-item">
										<input type="checkbox" id="family-alcane" checked>
										<label for="family-alcane">Alcanes</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="family-alcene" checked>
										<label for="family-alcene">Alcènes</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="family-alcyne" checked>
										<label for="family-alcyne">Alcynes</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="family-alcool" checked>
										<label for="family-alcool">Alcools</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="family-aldehyde" checked>
										<label for="family-aldehyde">Aldéhydes/Cétones</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="family-acide" checked>
										<label for="family-acide">Acides carboxyliques</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="family-ester" checked>
										<label for="family-ester">Esters</label>
									</div>
								</div>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="question-types">Types de questions:</label>
								<div class="checkbox-container" style="display: flex; flex-wrap: wrap; gap: 10px;">
									<div class="checkbox-item">
										<input type="checkbox" id="question-type-1" checked>
										<label for="question-type-1">Type 1: Construction de molécules</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="question-type-2" checked>
										<label for="question-type-2">Type 2: Identification de molécules</label>
									</div>
								</div>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="allow-multiple-attempts">Autoriser plusieurs tentatives:</label>
								<select id="allow-multiple-attempts" class="form-select">
									<option value="single">Une seule tentative</option>
									<option value="multiple" selected>Plusieurs tentatives</option>
									<option value="unlimited">Tentatives illimitées</option>
								</select>
							</div>
							
							<div class="form-group" id="attempts-count-container">
								<label class="form-label" for="max-attempts">Nombre maximum de tentatives:</label>
								<select id="max-attempts" class="form-select">
									<option value="2">2 tentatives</option>
									<option value="3" selected>3 tentatives</option>
									<option value="5">5 tentatives</option>
								</select>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="show-hints">Afficher les indices:</label>
								<select id="show-hints" class="form-select">
									<option value="always">Toujours</option>
									<option value="after-attempt" selected>Après une tentative incorrecte</option>
									<option value="never">Jamais</option>
								</select>
							</div>
							
							<div class="section-title" style="margin-top: 20px;">Aperçu du template</div>
							
							<div style="background: #f5f7fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
								<div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 20px; overflow: hidden;">
									<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px;">
										<div style="background: #a24b5f; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcanes</div>
										<div style="background: #6a88ca; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcènes</div>
										<div style="background: #8ba4da; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em;">Alcynes</div>
									</div>
									
									<div style="background: #f8f9fa; border-radius: 8px; height: 150px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; border: 1px dashed #a24b5f;">
										<div style="text-align: center; color: #a24b5f;">
											<i class="fas fa-atom" style="font-size: 3em; margin-bottom: 10px;"></i>
											<div>Visualisation de molécules interactives</div>
										</div>
									</div>
									
									<div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e9ecef;">
										<div style="font-weight: bold; margin-bottom: 5px;">Question:</div>
										<div>Construisez un propan-2-ol dans le simulateur puis validez votre réponse.</div>
									</div>
									
									<button style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">Valider la molécule</button>
								</div>
							</div>
						`;
						
						// Ajouter les écouteurs d'événements spécifiques
						setTimeout(() => {
							// Afficher/masquer le conteneur du nombre de tentatives
							document.getElementById('allow-multiple-attempts')?.addEventListener('change', function() {
								const attemptsContainer = document.getElementById('attempts-count-container');
								if (this.value === 'multiple') {
									attemptsContainer.style.display = 'block';
								} else {
									attemptsContainer.style.display = 'none';
								}
							});
							
							// Initialiser l'état des cases à cocher dans appState
							if (!appState.templateSettings['chimie-orga']) {
								appState.templateSettings['chimie-orga'] = {
									families: {
										alcane: true,
										alcene: true,
										alcyne: true,
										alcool: true,
										aldehyde: true,
										acide: true,
										ester: true
									},
									questionTypes: {
										type1: true,
										type2: true
									},
									allowMultipleAttempts: 'multiple',
									maxAttempts: 3,
									showHints: 'after-attempt'
								};
							}
							
							// Sauvegarder les changements dans l'état
							document.querySelectorAll('#family-alcane, #family-alcene, #family-alcyne, #family-alcool, #family-aldehyde, #family-acide, #family-ester').forEach(checkbox => {
								checkbox.checked = appState.templateSettings['chimie-orga'].families[checkbox.id.replace('family-', '')];
								checkbox.addEventListener('change', function() {
									appState.templateSettings['chimie-orga'].families[this.id.replace('family-', '')] = this.checked;
								});
							});
							
							document.querySelectorAll('#question-type-1, #question-type-2').forEach(checkbox => {
								const typeId = checkbox.id.replace('question-type-', 'type');
								checkbox.checked = appState.templateSettings['chimie-orga'].questionTypes[typeId];
								checkbox.addEventListener('change', function() {
									appState.templateSettings['chimie-orga'].questionTypes[this.id.replace('question-type-', 'type')] = this.checked;
								});
							});
							
							const attemptsSelect = document.getElementById('allow-multiple-attempts');
							if (attemptsSelect) {
								attemptsSelect.value = appState.templateSettings['chimie-orga'].allowMultipleAttempts;
								attemptsSelect.addEventListener('change', function() {
									appState.templateSettings['chimie-orga'].allowMultipleAttempts = this.value;
								});
							}
							
							const maxAttemptsSelect = document.getElementById('max-attempts');
							if (maxAttemptsSelect) {
								maxAttemptsSelect.value = appState.templateSettings['chimie-orga'].maxAttempts;
								maxAttemptsSelect.addEventListener('change', function() {
									appState.templateSettings['chimie-orga'].maxAttempts = parseInt(this.value);
								});
							}
							
							const hintsSelect = document.getElementById('show-hints');
							if (hintsSelect) {
								hintsSelect.value = appState.templateSettings['chimie-orga'].showHints;
								hintsSelect.addEventListener('change', function() {
									appState.templateSettings['chimie-orga'].showHints = this.value;
								});
							}
						}, 100);
						break;
	
	
	
	
					case 'titrage':
						html += `
							<div class="form-group">
								<label class="form-label" for="titrage-type">Type de titrage:</label>
								<select id="titrage-type" class="form-select">
									<option value="acid-base" selected>Acide-Base (acide titré par base)</option>
									<option value="base-acid">Base-Acide (base titrée par acide)</option>
									<option value="mixed">Mixte (alternance)</option>
								</select>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="titrage-indicators">Indicateurs colorés disponibles:</label>
								<select id="titrage-indicators" class="form-select">
									<option value="both" selected>Les deux (Bromothymol et Phénolphtaléine)</option>
									<option value="bromothymol">Bleu de bromothymol seulement</option>
									<option value="phenolphthalein">Phénolphtaléine seulement</option>
								</select>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="titrage-difficulty">Difficulté des calculs:</label>
								<select id="titrage-difficulty" class="form-select">
									<option value="easy">Facile (une décimale)</option>
									<option value="medium" selected>Moyen (faibles concentrations)</option>
									<option value="hard">Difficile (expression avec des puissances de 10)</option>
								</select>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les indices:</span>
								<label class="switch">
									<input type="checkbox" id="titrage-hints" checked>
									<span class="slider"></span>
								</label>
							</div>
						`;
						break;
                    

                    
					case '3d':
						html += `
							<div class="form-group">
								<label class="form-label" for="model-count">Nombre de modèles 3D:</label>
								<select id="model-count" class="form-select">
									<option value="3">3 modèles</option>
									<option value="6" selected>6 modèles</option>
									<option value="8">8 modèles</option>
								</select>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="model-theme">Thème des modèles:</label>
								<select id="model-theme" class="form-select">
									<option value="planets" selected>Planètes</option>
									<option value="molecules">Molécules</option>
									<option value="custom">Personnalisé</option>
								</select>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Activer la rotation:</span>
								<label class="switch">
									<input type="checkbox" id="enable-rotation" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Activer le zoom:</span>
								<label class="switch">
									<input type="checkbox" id="enable-zoom" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher des informations détaillées:</span>
								<label class="switch">
									<input type="checkbox" id="show-details" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Thème sombre pour l'affichage 3D:</span>
								<label class="switch">
									<input type="checkbox" id="dark-theme" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Autoriser plusieurs tentatives:</span>
								<label class="switch">
									<input type="checkbox" id="3d-multiple-attempts">
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="3d-attempts">Nombre de tentatives par exercice:</label>
								<select id="3d-attempts" class="form-select">
									<option value="1" selected>1 tentative</option>
									<option value="2">2 tentatives</option>
									<option value="3">3 tentatives</option>
									<option value="unlimited">Illimité</option>
								</select>
							</div>
	
						`;
						break;
                    
                    
					case 'graphique':
						html += `
							<div class="form-group">
								<label class="form-label" for="graph-exercise-count">Nombre d'exercices:</label>
								<select id="graph-exercise-count" class="form-select">
									<option value="3">4 exercices</option>
									<option value="6" selected>6 exercices</option>
								</select>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher la grille:</span>
								<label class="switch">
									<input type="checkbox" id="show-grid" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les indices:</span>
								<label class="switch">
									<input type="checkbox" id="allow-hints" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les points:</span>
								<label class="switch">
									<input type="checkbox" id="show-points" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les étiquettes:</span>
								<label class="switch">
									<input type="checkbox" id="show-labels" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							
							<div class="switch-container">
								<span class="switch-label">Autoriser plusieurs tentatives:</span>
								<label class="switch">
									<input type="checkbox" id="graph-multiple-attempts">
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="graph-attempts">Nombre de tentatives par exercice:</label>
								<select id="graph-attempts" class="form-select">
									<option value="1" selected>1 tentative</option>
									<option value="2">2 tentatives</option>
									<option value="3">3 tentatives</option>
									<option value="unlimited">Illimité</option>
								</select>
							</div>

						`;
						break;

                    
					// AJOUTER CE CAS
					case 'geometry3d':
						html += `
							<div class="switch-container">
								<span class="switch-label">Afficher le modèle filaire:</span>
								<label class="switch">
									<input type="checkbox" id="show-wireframe" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Rotation automatique:</span>
								<label class="switch">
									<input type="checkbox" id="auto-rotation" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les axes:</span>
								<label class="switch">
									<input type="checkbox" id="show-axes" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Thème sombre:</span>
								<label class="switch">
									<input type="checkbox" id="dark-theme" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="shape-count">Nombre de formes:</label>
								<select id="shape-count" class="form-select">
									<option value="3">3 formes</option>
									<option value="6" selected>6 formes</option>
									<option value="8">8 formes</option>
								</select>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les formules:</span>
								<label class="switch">
									<input type="checkbox" id="show-formulas" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Contrôles des dimensions:</span>
								<label class="switch">
									<input type="checkbox" id="dimension-controls" checked>
									<span class="slider"></span>
								</label>
							</div>
						`;
						break;


					case 'statistics':
						html += `
							<div class="form-group">
								<label class="form-label">Types de graphiques à inclure:</label>
								<div class="checkbox-container">
									<div class="checkbox-item">
										<input type="checkbox" id="graph-histogram" checked>
										<label for="graph-histogram">Histogramme</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="graph-radar" checked>
										<label for="graph-radar">Radar</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="graph-boxplot">
										<label for="graph-boxplot">Boîte à moustaches</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="graph-piechart" checked>
										<label for="graph-piechart">Diagramme circulaire</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="graph-multiHistogram">
										<label for="graph-multiHistogram">Histogramme comparatif</label>
									</div>
									<div class="checkbox-item">
										<input type="checkbox" id="graph-donut">
										<label for="graph-donut">Diagramme en anneau</label>
									</div>
								</div>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="color-scheme">Schéma de couleurs:</label>
								<select id="color-scheme" class="form-select">
									<option value="default" selected>Par défaut</option>
									<option value="blue">Tons bleus</option>
									<option value="green">Tons verts</option>
									<option value="red">Tons rouges</option>
									<option value="pastel">Couleurs pastel</option>
									<option value="monochrome">Monochrome</option>
								</select>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les légendes:</span>
								<label class="switch">
									<input type="checkbox" id="show-legends" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Afficher les étiquettes:</span>
								<label class="switch">
									<input type="checkbox" id="show-labels" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Animer les graphiques:</span>
								<label class="switch">
									<input type="checkbox" id="animate-graphs" checked>
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="data-mode">Mode de données:</label>
								<select id="data-mode" class="form-select">
									<option value="demo" selected>Données de démonstration</option>
									<option value="custom">Données personnalisées</option>
								</select>
							</div>
							
							<div class="switch-container">
								<span class="switch-label">Autoriser plusieurs tentatives:</span>
								<label class="switch">
									<input type="checkbox" id="stats-multiple-attempts">
									<span class="slider"></span>
								</label>
							</div>
							
							<div class="form-group">
								<label class="form-label" for="stats-attempts">Nombre de tentatives par exercice:</label>
								<select id="stats-attempts" class="form-select">
									<option value="1" selected>1 tentative</option>
									<option value="2">2 tentatives</option>
									<option value="3">3 tentatives</option>
									<option value="unlimited">Illimité</option>
								</select>
							</div>
							
						`;
						break;
                    
                    
                default:
                    html += `<p>Veuillez d'abord sélectionner un template dans l'étape précédente.</p>`;
            }
            
            container.innerHTML = html;
            
            // Ajouter les écouteurs d'événements pour les contrôles spécifiques au template
            if (templateId) {
                // Pour chaque contrôle, ajouter un écouteur pour mettre à jour l'état
                // QCM
                if (templateId === 'qcm') {
                    const optionsSelect = document.getElementById('qcm-options');
                    const multipleCheck = document.getElementById('qcm-multiple');
                    const explanationsCheck = document.getElementById('qcm-explanations');
                    
                    if (optionsSelect) {
                        optionsSelect.addEventListener('change', (e) => {
                            appState.templateSettings.qcm.optionsPerQuestion = parseInt(e.target.value);
                        });
                        optionsSelect.value = appState.templateSettings.qcm.optionsPerQuestion;
                    }
                    
                    if (multipleCheck) {
                        multipleCheck.addEventListener('change', (e) => {
                            appState.templateSettings.qcm.allowMultipleCorrect = e.target.checked;
                        });
                        multipleCheck.checked = appState.templateSettings.qcm.allowMultipleCorrect;
                    }
                    
                    if (explanationsCheck) {
                        explanationsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.qcm.showExplanations = e.target.checked;
                        });
                        explanationsCheck.checked = appState.templateSettings.qcm.showExplanations;
                    }
                    
					// Nouvel écouteur pour désactiver les options après réponse
					const disableAfterCheck = document.getElementById('qcm-disable-after');
					if (disableAfterCheck) {
						disableAfterCheck.addEventListener('change', (e) => {
							appState.templateSettings.qcm.disableAfterAnswer = e.target.checked;
						});
						disableAfterCheck.checked = appState.templateSettings.qcm.disableAfterAnswer;
					}
					
					// Nouvel écouteur pour le nombre de tentatives
					const attemptsSelect = document.getElementById('qcm-attempts');
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.qcm.attemptsPerQuestion = e.target.value;
						});
						attemptsSelect.value = appState.templateSettings.qcm.attemptsPerQuestion;
					}
                }
                
                
				// Ajouter les écouteurs d'événements pour le template Turtle
				if (templateId === 'turtle') {
					const challengeCountSelect = document.getElementById('turtle-challenge-count');
					const expectedImagesCheck = document.getElementById('turtle-expected-images');
					const hintsCheck = document.getElementById('turtle-hints');
					const customChallengesCheck = document.getElementById('turtle-custom-challenges');
					const customChallengesContainer = document.getElementById('turtle-custom-challenges-container');
					
					if (challengeCountSelect) {
						challengeCountSelect.addEventListener('change', (e) => {
							appState.templateSettings.turtle.challengeCount = parseInt(e.target.value);
						});
						challengeCountSelect.value = appState.templateSettings.turtle.challengeCount;
					}
					
					if (expectedImagesCheck) {
						expectedImagesCheck.addEventListener('change', (e) => {
							appState.templateSettings.turtle.showExpectedImages = e.target.checked;
						});
						expectedImagesCheck.checked = appState.templateSettings.turtle.showExpectedImages;
					}
					
					if (hintsCheck) {
						hintsCheck.addEventListener('change', (e) => {
							appState.templateSettings.turtle.allowHints = e.target.checked;
						});
						hintsCheck.checked = appState.templateSettings.turtle.allowHints;
					}
					
					if (customChallengesCheck) {
						customChallengesCheck.addEventListener('change', (e) => {
							appState.templateSettings.turtle.customChallenges = e.target.checked;
							customChallengesContainer.style.display = e.target.checked ? 'block' : 'none';
						});
						customChallengesCheck.checked = appState.templateSettings.turtle.customChallenges;
						customChallengesContainer.style.display = appState.templateSettings.turtle.customChallenges ? 'block' : 'none';
					}
					
					// Ajouter des écouteurs pour les champs de défis personnalisés
					for (let i = 1; i <= 6; i++) {
						const challengeInput = document.getElementById(`turtle-challenge${i}`);
						if (challengeInput) {
							challengeInput.addEventListener('input', (e) => {
								if (!appState.templateSettings.turtle.challenges) {
									appState.templateSettings.turtle.challenges = {};
								}
								appState.templateSettings.turtle.challenges[`challenge${i}`] = e.target.value;
							});
							
							// Initialiser la valeur si elle existe déjà
							if (appState.templateSettings.turtle.challenges && appState.templateSettings.turtle.challenges[`challenge${i}`]) {
								challengeInput.value = appState.templateSettings.turtle.challenges[`challenge${i}`];
							}
						}
					}
				}
                
                
                
				// Tableaux Template
				if (templateId === 'tableaux') {
					const functionTypeSelect = document.getElementById('tableaux-function-type');
					const customContainer = document.getElementById('tableaux-custom-container');
					const customFunctionInput = document.getElementById('tableaux-custom-function');
					const columnsSelect = document.getElementById('tableaux-columns');
					const valuesSelect = document.getElementById('tableaux-values');
					const calculationSelect = document.getElementById('tableaux-calculation');
					const multipleAttemptsCheck = document.getElementById('tableaux-multiple-attempts');
					const attemptsContainer = document.getElementById('tableaux-attempts-container');
					const maxAttemptsSelect = document.getElementById('tableaux-max-attempts');
					
					if (functionTypeSelect) {
						functionTypeSelect.addEventListener('change', (e) => {
							appState.templateSettings.tableaux.functionType = e.target.value;
							if (e.target.value === 'custom') {
								customContainer.style.display = 'block';
							} else {
								customContainer.style.display = 'none';
							}
						});
						functionTypeSelect.value = appState.templateSettings.tableaux.functionType;
					}
					
					if (customFunctionInput) {
						customFunctionInput.addEventListener('input', (e) => {
							appState.templateSettings.tableaux.customFunction = e.target.value;
						});
						customFunctionInput.value = appState.templateSettings.tableaux.customFunction;
					}
					
					if (columnsSelect) {
						columnsSelect.addEventListener('change', (e) => {
							appState.templateSettings.tableaux.columnCount = parseInt(e.target.value);
						});
						columnsSelect.value = appState.templateSettings.tableaux.columnCount;
					}
					
					if (valuesSelect) {
						valuesSelect.addEventListener('change', (e) => {
							appState.templateSettings.tableaux.valuesCount = parseInt(e.target.value);
						});
						valuesSelect.value = appState.templateSettings.tableaux.valuesCount;
					}
					
					if (calculationSelect) {
						calculationSelect.addEventListener('change', (e) => {
							appState.templateSettings.tableaux.calculationType = e.target.value;
						});
						calculationSelect.value = appState.templateSettings.tableaux.calculationType;
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.tableaux.allowMultipleAttempts = e.target.checked;
							if (e.target.checked) {
								attemptsContainer.style.display = 'block';
							} else {
								attemptsContainer.style.display = 'none';
							}
						});
						multipleAttemptsCheck.checked = appState.templateSettings.tableaux.allowMultipleAttempts;
					}
					
					if (maxAttemptsSelect) {
						maxAttemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.tableaux.maxAttempts = e.target.value === 'unlimited' ? 999 : parseInt(e.target.value);
						});
						maxAttemptsSelect.value = appState.templateSettings.tableaux.maxAttempts === 999 ? 'unlimited' : appState.templateSettings.tableaux.maxAttempts.toString();
					}
					
					// Initialiser l'affichage des champs conditionnels
					if (appState.templateSettings.tableaux.functionType === 'custom') {
						customContainer.style.display = 'block';
					}
					
					if (!appState.templateSettings.tableaux.allowMultipleAttempts) {
						attemptsContainer.style.display = 'none';
					}
				}
                
                
				// Dérivées Template - MISE À JOUR COMPLÈTE
                if (templateId === 'derivees') {
                    const polynomialDegreeSelect = document.getElementById('derivees-polynomial-degree');
                    const questionTypeSelect = document.getElementById('derivees-question-type');
                    const multipleAttemptsCheck = document.getElementById('derivees-multiple-attempts');
                    const maxAttemptsSelect = document.getElementById('derivees-max-attempts');
                    const difficultySelect = document.getElementById('derivees-difficulty');
                    
                    if (polynomialDegreeSelect) {
                        polynomialDegreeSelect.addEventListener('change', (e) => {
                            appState.templateSettings.derivees.polynomialDegree = parseInt(e.target.value);
                            updateDegreeExamples(parseInt(e.target.value));
                        });
                        polynomialDegreeSelect.value = appState.templateSettings.derivees.polynomialDegree || 2;
                    }
                    
                    if (questionTypeSelect) {
                        questionTypeSelect.addEventListener('change', (e) => {
                            appState.templateSettings.derivees.questionType = e.target.value;
                        });
                        questionTypeSelect.value = appState.templateSettings.derivees.questionType || 'derivative_expression';
                    }
                    
                    if (multipleAttemptsCheck) {
                        multipleAttemptsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.derivees.allowMultipleAttempts = e.target.checked;
                            const attemptsSettings = document.getElementById('derivees-attempts-settings');
                            if (attemptsSettings) {
                                attemptsSettings.style.display = e.target.checked ? 'block' : 'none';
                            }
                        });
                        multipleAttemptsCheck.checked = appState.templateSettings.derivees.allowMultipleAttempts !== false;
                    }
                    
                    if (maxAttemptsSelect) {
                        maxAttemptsSelect.addEventListener('change', (e) => {
                            appState.templateSettings.derivees.maxAttempts = parseInt(e.target.value);
                        });
                        maxAttemptsSelect.value = appState.templateSettings.derivees.maxAttempts || 2;
                    }
                    
                    if (difficultySelect) {
                        difficultySelect.addEventListener('change', (e) => {
                            appState.templateSettings.derivees.difficulty = e.target.value;
                        });
                        difficultySelect.value = appState.templateSettings.derivees.difficulty || 'medium';
                    }
                }
                
                // Fonction pour mettre à jour les exemples selon le degré
                function updateDegreeExamples(degree) {
                    const container = document.getElementById('derivees-degree-examples');
                    if (!container) return;
                    
                    const examples = {
                        2: "f(x) = 3x² - 5x + 2 → f'(x) = 6x - 5",
                        3: "f(x) = 2x³ - x² + 4x - 1 → f'(x) = 6x² - 2x + 4", 
                        4: "f(x) = x⁴ - 3x³ + x² - 2x + 5 → f'(x) = 4x³ - 9x² + 2x - 2",
                        5: "f(x) = x⁵ + 2x⁴ - x³ + 3x² - x + 1 → f'(x) = 5x⁴ + 8x³ - 3x² + 6x - 1"
                    };
                    
                    container.innerHTML = `
                        <div class="degree-example" style="background: #e7f3ff; padding: 10px; border-radius: 8px; font-weight: bold;">
                            <strong>Degré ${degree} sélectionné:</strong> ${examples[degree]}
                        </div>
                    `;
                }
                
                
                
                if (templateId === 'periodic') {
									// Ajouter les écouteurs d'événements pour les contrôles spécifiques
					const questionProperty = document.getElementById('question-property');
					const questionMolecule = document.getElementById('question-molecule');
					const questionIdentification = document.getElementById('question-identification');
					const periodicAttemptsCheck = document.getElementById('periodic-attempts');
					const maxAttemptsSelect = document.getElementById('max-attempts');
					const periodicHintsCheck = document.getElementById('periodic-hints');
					
					if (questionProperty && questionMolecule && questionIdentification) {
						// Mettre à jour les types de questions sélectionnés
						const updateQuestionTypes = () => {
							const types = [];
							if (questionProperty.checked) types.push('property');
							if (questionMolecule.checked) types.push('molecule');
							if (questionIdentification.checked) types.push('identification');
							appState.templateSettings.periodic.questionTypes = types;
						};
						
						questionProperty.addEventListener('change', updateQuestionTypes);
						questionMolecule.addEventListener('change', updateQuestionTypes);
						questionIdentification.addEventListener('change', updateQuestionTypes);
						
						// Initialiser avec les valeurs de l'état
						questionProperty.checked = appState.templateSettings.periodic.questionTypes.includes('property');
						questionMolecule.checked = appState.templateSettings.periodic.questionTypes.includes('molecule');
						questionIdentification.checked = appState.templateSettings.periodic.questionTypes.includes('identification');
					}
					
					if (periodicAttemptsCheck) {
						periodicAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.periodic.allowMultipleAttempts = e.target.checked;
							document.getElementById('max-attempts-container').style.display = e.target.checked ? 'block' : 'none';
						});
						
						periodicAttemptsCheck.checked = appState.templateSettings.periodic.allowMultipleAttempts;
						document.getElementById('max-attempts-container').style.display = appState.templateSettings.periodic.allowMultipleAttempts ? 'block' : 'none';
					}
					
					if (maxAttemptsSelect) {
						maxAttemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.periodic.maxAttempts = e.target.value;
						});
						
						maxAttemptsSelect.value = appState.templateSettings.periodic.maxAttempts;
					}
					
					if (periodicHintsCheck) {
						periodicHintsCheck.addEventListener('change', (e) => {
							appState.templateSettings.periodic.showHints = e.target.checked;
						});
						
						periodicHintsCheck.checked = appState.templateSettings.periodic.showHints;
					}
                }


				// Titrage Template
				if (templateId === 'titrage') {
					const titrageTypeSelect = document.getElementById('titrage-type');
					const titrageIndicatorsSelect = document.getElementById('titrage-indicators');
					const titrageDifficultySelect = document.getElementById('titrage-difficulty');
					const titrageHintsCheck = document.getElementById('titrage-hints');
					
					if (titrageTypeSelect) {
						titrageTypeSelect.addEventListener('change', (e) => {
							appState.templateSettings.titrage.titrageType = e.target.value;
						});
						titrageTypeSelect.value = appState.templateSettings.titrage.titrageType;
					}
					
					if (titrageIndicatorsSelect) {
						titrageIndicatorsSelect.addEventListener('change', (e) => {
							appState.templateSettings.titrage.indicators = e.target.value;
						});
						titrageIndicatorsSelect.value = appState.templateSettings.titrage.indicators;
					}
					
					if (titrageDifficultySelect) {
						titrageDifficultySelect.addEventListener('change', (e) => {
							appState.templateSettings.titrage.difficulty = e.target.value;
						});
						titrageDifficultySelect.value = appState.templateSettings.titrage.difficulty;
					}
					
					if (titrageHintsCheck) {
						titrageHintsCheck.addEventListener('change', (e) => {
							appState.templateSettings.titrage.showHints = e.target.checked;
						});
						titrageHintsCheck.checked = appState.templateSettings.titrage.showHints;
					}
				}



				if (templateId === 'equation') {
					const reactifCountSelect = document.getElementById('reactif-count');
					const produitCountSelect = document.getElementById('produit-count');
					const attemptsCheck = document.getElementById('equation-attempts');
					const maxAttemptsSelect = document.getElementById('max-attempts');
					const hintsCheck = document.getElementById('equation-hints');
					
					if (reactifCountSelect) {
						reactifCountSelect.addEventListener('change', (e) => {
							appState.templateSettings.equation.reactifCount = parseInt(e.target.value);
						});
						reactifCountSelect.value = appState.templateSettings.equation.reactifCount;
					}
					
					if (produitCountSelect) {
						produitCountSelect.addEventListener('change', (e) => {
							appState.templateSettings.equation.produitCount = parseInt(e.target.value);
						});
						produitCountSelect.value = appState.templateSettings.equation.produitCount;
					}
					
					if (attemptsCheck) {
						attemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.equation.allowMultipleAttempts = e.target.checked;
							document.getElementById('attempts-container').style.display = 
								e.target.checked ? 'block' : 'none';
						});
						attemptsCheck.checked = appState.templateSettings.equation.allowMultipleAttempts;
						document.getElementById('attempts-container').style.display = 
							appState.templateSettings.equation.allowMultipleAttempts ? 'block' : 'none';
					}
					
					if (maxAttemptsSelect) {
						maxAttemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.equation.maxAttempts = parseInt(e.target.value);
						});
						maxAttemptsSelect.value = appState.templateSettings.equation.maxAttempts;
					}
					
					if (hintsCheck) {
						hintsCheck.addEventListener('change', (e) => {
							appState.templateSettings.equation.showHints = e.target.checked;
						});
						hintsCheck.checked = appState.templateSettings.equation.showHints;
					}
				}
                
                
                // Sequence
                if (templateId === 'sequence') {
                    const sequenceItemsSelect = document.getElementById('sequence-items');
                    const hintsCheck = document.getElementById('sequence-hints');
					const attemptsSelect = document.getElementById('sequence-attempts');
					const multipleAttemptsCheck = document.getElementById('sequence-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.sequence.attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings.sequence.attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings.sequence.attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.sequence.allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings.sequence.allowMultipleAttempts;
					}
                    
                    if (sequenceItemsSelect) {
                        sequenceItemsSelect.addEventListener('change', (e) => {
                            appState.templateSettings.sequence.itemsCount = parseInt(e.target.value);
                        });
                        if (appState.templateSettings.sequence.itemsCount) {
                            sequenceItemsSelect.value = appState.templateSettings.sequence.itemsCount;
                        }
                    }
                    
                    if (hintsCheck) {
                        hintsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.sequence.showHints = e.target.checked;
                        });
                        hintsCheck.checked = appState.templateSettings.sequence.showHints;
                    }
                }
                
                
                
                
                // Category Template
                if (templateId === 'category') {
                    const categoryCountSelect = document.getElementById('category-count');
                    const itemsPerCategorySelect = document.getElementById('items-per-category');				
					const attemptsSelect = document.getElementById('category-attempts');
					const multipleAttemptsCheck = document.getElementById('category-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.category.attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings.category.attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings.category.attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.category.allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings.category.allowMultipleAttempts;
					}
                    
                    
                    if (categoryCountSelect) {
                        categoryCountSelect.addEventListener('change', (e) => {
                            appState.templateSettings.category.categoryCount = parseInt(e.target.value);
                        });
                        categoryCountSelect.value = appState.templateSettings.category.categoryCount;
                    }
                    
                    if (itemsPerCategorySelect) {
                        itemsPerCategorySelect.addEventListener('change', (e) => {
                            appState.templateSettings.category.itemsPerCategory = parseInt(e.target.value);
                        });
                        itemsPerCategorySelect.value = appState.templateSettings.category.itemsPerCategory;
                    }
                }
                
                // Match Template
                if (templateId === 'match') {
                    const pairCountSelect = document.getElementById('pair-count');
                    const matchHintsCheck = document.getElementById('match-hints');
					const attemptsSelect = document.getElementById('match-attempts');
					const multipleAttemptsCheck = document.getElementById('match-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.match.attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings.match.attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings.match.attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.match.allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings.match.allowMultipleAttempts;
					}                    
                    
                    if (pairCountSelect) {
                        pairCountSelect.addEventListener('change', (e) => {
                            appState.templateSettings.match.pairCount = parseInt(e.target.value);
                        });
                        pairCountSelect.value = appState.templateSettings.match.pairCount;
                    }
                    
                    if (matchHintsCheck) {
                        matchHintsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.match.showHints = e.target.checked;
                        });
                        matchHintsCheck.checked = appState.templateSettings.match.showHints;
                    }
                }
                
                // Calcul Template
                if (templateId === 'calcul') {
                    const calculAttemptsCheck = document.getElementById('calcul-attempts');
                    const calculFormulasCheck = document.getElementById('calcul-formulas');
                    const calculToleranceSelect = document.getElementById('calcul-tolerance');
                    
                    if (calculAttemptsCheck) {
                        calculAttemptsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.calcul.allowMultipleAttempts = e.target.checked;
                        });
                        calculAttemptsCheck.checked = appState.templateSettings.calcul.allowMultipleAttempts;
                    }
                    
                    if (calculFormulasCheck) {
                        calculFormulasCheck.addEventListener('change', (e) => {
                            appState.templateSettings.calcul.showFormulas = e.target.checked;
                        });
                        calculFormulasCheck.checked = appState.templateSettings.calcul.showFormulas;
                    }
                    
                    if (calculToleranceSelect) {
                        calculToleranceSelect.addEventListener('change', (e) => {
                            appState.templateSettings.calcul.tolerance = e.target.value;
                        });
                        // Set initial value if tolerance property exists in appState
                        if (appState.templateSettings.calcul.tolerance) {
                            calculToleranceSelect.value = appState.templateSettings.calcul.tolerance;
                        }
                    }
                }
                

				// Python Template
				if (templateId === 'python') {
					const pythonEditingCheck = document.getElementById('python-editing');
					const pythonOutputCheck = document.getElementById('python-output');
					const pythonLevelSelect = document.getElementById('python-level');
					const pythonAttemptsSelect = document.getElementById('python-attempts');
					
					if (pythonEditingCheck) {
						pythonEditingCheck.addEventListener('change', (e) => {
							appState.templateSettings.python.allowCodeEditing = e.target.checked;
						});
						pythonEditingCheck.checked = appState.templateSettings.python.allowCodeEditing;
					}
					
					if (pythonOutputCheck) {
						pythonOutputCheck.addEventListener('change', (e) => {
							appState.templateSettings.python.showExpectedOutput = e.target.checked;
						});
						pythonOutputCheck.checked = appState.templateSettings.python.showExpectedOutput;
					}
					
					if (pythonLevelSelect) {
						pythonLevelSelect.addEventListener('change', (e) => {
							appState.templateSettings.python.level = e.target.value;
						});
						// Set initial value if level property exists in appState
						if (appState.templateSettings.python.level) {
							pythonLevelSelect.value = appState.templateSettings.python.level;
						} else {
							// Default to intermediate if not set
							appState.templateSettings.python.level = 'intermediate';
						}
					}
					
					if (pythonAttemptsSelect) {
						pythonAttemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.python.attempts = e.target.value;
						});
						// Set initial value if attempts property exists in appState
						if (appState.templateSettings.python.attempts) {
							pythonAttemptsSelect.value = appState.templateSettings.python.attempts;
						} else {
							// Default to unlimited if not set
							appState.templateSettings.python.attempts = 'unlimited';
						}
					}
					
					// Type de code et d'instructions
					const codeTypeOptions = [
						'python-print-input',
						'python-variables',
						'python-conditions',
						'python-for-loops',
						'python-while-loops',
						'python-functions',
						 'python-lists'  // Nouvelle option ajoutée
					];
					
					codeTypeOptions.forEach(option => {
						const checkbox = document.getElementById(option);
						if (checkbox) {
							checkbox.addEventListener('change', (e) => {
								// Initialize codeTypes array if it doesn't exist
								if (!appState.templateSettings.python.codeTypes) {
									appState.templateSettings.python.codeTypes = {};
								}
								appState.templateSettings.python.codeTypes[option.replace('python-', '')] = e.target.checked;
							});
							
							// Set initial value if property exists in appState
							if (appState.templateSettings.python.codeTypes && 
								appState.templateSettings.python.codeTypes[option.replace('python-', '')] !== undefined) {
								checkbox.checked = appState.templateSettings.python.codeTypes[option.replace('python-', '')];
							} else {
								// Initialize default values
								if (!appState.templateSettings.python.codeTypes) {
									appState.templateSettings.python.codeTypes = {};
								}
								
								// Default values: check which options should be checked by default
								const defaultCheckedOptions = ['python-print-input', 'python-variables', 'python-conditions', 
															   'python-for-loops', 'python-lists'];
								
								appState.templateSettings.python.codeTypes[option.replace('python-', '')] = 
									defaultCheckedOptions.includes(option);
								checkbox.checked = defaultCheckedOptions.includes(option);
							}
						}
					});

				}
                
                
                
                
                // 3D Model Template
                if (templateId === '3d') {
                    const modelCountSelect = document.getElementById('model-count');
                    const modelThemeSelect = document.getElementById('model-theme');
                    const enableRotationCheck = document.getElementById('enable-rotation');
                    const enableZoomCheck = document.getElementById('enable-zoom');
                    const showDetailsCheck = document.getElementById('show-details');
                    const darkThemeCheck = document.getElementById('dark-theme');
					const attemptsSelect = document.getElementById('3d-attempts');
					const multipleAttemptsCheck = document.getElementById('3d-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings['3d'].attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings['3d'].attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings['3d'].attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings['3d'].allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings['3d'].allowMultipleAttempts;
					}
                    
                    
                    
                    if (modelCountSelect) {
                        modelCountSelect.addEventListener('change', (e) => {
                            appState.templateSettings['3d'].modelCount = parseInt(e.target.value);
                        });
                        if (appState.templateSettings['3d'].modelCount) {
                            modelCountSelect.value = appState.templateSettings['3d'].modelCount;
                        }
                    }
                    
                    if (modelThemeSelect) {
                        modelThemeSelect.addEventListener('change', (e) => {
                            appState.templateSettings['3d'].modelTheme = e.target.value;
                            // Mettre à jour la prévisualisation en fonction du thème
                            if (appState.selectedTemplate === '3d') {
                                updateTemplatePreview('3d');
                            }
                        });
                        // Set initial value if property exists
                        if (appState.templateSettings['3d'].modelTheme) {
                            modelThemeSelect.value = appState.templateSettings['3d'].modelTheme;
                        } else {
                            // Default if not set
                            appState.templateSettings['3d'].modelTheme = 'planets';
                        }
                    }
                    
                    if (enableRotationCheck) {
                        enableRotationCheck.addEventListener('change', (e) => {
                            appState.templateSettings['3d'].enableRotation = e.target.checked;
                        });
                        enableRotationCheck.checked = appState.templateSettings['3d'].enableRotation;
                    }
                    
                    if (enableZoomCheck) {
                        enableZoomCheck.addEventListener('change', (e) => {
                            appState.templateSettings['3d'].enableZoom = e.target.checked;
                        });
                        enableZoomCheck.checked = appState.templateSettings['3d'].enableZoom;
                    }
                    
                    if (showDetailsCheck) {
                        showDetailsCheck.addEventListener('change', (e) => {
                            appState.templateSettings['3d'].showDetails = e.target.checked;
                        });
                        showDetailsCheck.checked = appState.templateSettings['3d'].showDetails;
                    }
                    
                    if (darkThemeCheck) {
                        darkThemeCheck.addEventListener('change', (e) => {
                            appState.templateSettings['3d'].darkTheme = e.target.checked;
                        });
                        darkThemeCheck.checked = appState.templateSettings['3d'].darkTheme;
                    }
                }
				
				// Graphique Template - INSÉRER ICI
                if (templateId === 'graphique') {
                    const exerciseCountSelect = document.getElementById('graph-exercise-count');
                    const showGridCheck = document.getElementById('show-grid');
                    const allowHintsCheck = document.getElementById('allow-hints');
                    const showPointsCheck = document.getElementById('show-points');
                    const showLabelsCheck = document.getElementById('show-labels');
					const attemptsSelect = document.getElementById('graph-attempts');
					const multipleAttemptsCheck = document.getElementById('graph-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.graphique.attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings.graphique.attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings.graphique.attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.graphique.allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings.graphique.allowMultipleAttempts;
					}
                    
                    
                    if (exerciseCountSelect) {
                        exerciseCountSelect.addEventListener('change', (e) => {
                            appState.templateSettings.graphique.exerciseCount = parseInt(e.target.value);
                        });
                        exerciseCountSelect.value = appState.templateSettings.graphique.exerciseCount;
                    }
                    
                    if (showGridCheck) {
                        showGridCheck.addEventListener('change', (e) => {
                            appState.templateSettings.graphique.showGrid = e.target.checked;
                        });
                        showGridCheck.checked = appState.templateSettings.graphique.showGrid;
                    }
                    
                    if (allowHintsCheck) {
                        allowHintsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.graphique.allowHints = e.target.checked;
                        });
                        allowHintsCheck.checked = appState.templateSettings.graphique.allowHints;
                    }
                    
                    if (showPointsCheck) {
                        showPointsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.graphique.showPoints = e.target.checked;
                        });
                        showPointsCheck.checked = appState.templateSettings.graphique.showPoints;
                    }
                    
                    if (showLabelsCheck) {
                        showLabelsCheck.addEventListener('change', (e) => {
                            appState.templateSettings.graphique.showLabels = e.target.checked;
                        });
                        showLabelsCheck.checked = appState.templateSettings.graphique.showLabels;
                    }
                } // <-- Cette accolade ferme le bloc if (templateId === 'graphique')
                
                
                
				// Toujours dans la fonction updateTemplateSpecificSettings, après le switch
				if (templateId === 'statistics') {
					// Gestionnaires pour les cases à cocher de types de graphiques
					document.querySelectorAll('[id^="graph-"]').forEach(checkbox => {
						const graphType = checkbox.id.replace('graph-', '');
						checkbox.addEventListener('change', (e) => {
							// Mettre à jour la liste des graphiques sélectionnés
							if (e.target.checked) {
								// Ajouter à la liste s'il n'y est pas déjà
								if (!appState.templateSettings.statistics.selectedGraphs.includes(graphType)) {
									appState.templateSettings.statistics.selectedGraphs.push(graphType);
								}
							} else {
								// Retirer de la liste
								appState.templateSettings.statistics.selectedGraphs = 
									appState.templateSettings.statistics.selectedGraphs.filter(g => g !== graphType);
							}
							
							// Mettre à jour la prévisualisation
							updateTemplatePreview('statistics');
						});
						
						// Initialiser avec les valeurs de l'état
						checkbox.checked = appState.templateSettings.statistics.selectedGraphs.includes(graphType);
					});
					
				
					const attemptsSelect = document.getElementById('stats-attempts');
					const multipleAttemptsCheck = document.getElementById('stats-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.statistics.attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings.statistics.attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings.statistics.attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.statistics.allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings.statistics.allowMultipleAttempts;
					}
					
					
					// Gestionnaire pour le schéma de couleurs
					const colorSchemeSelect = document.getElementById('color-scheme');
					if (colorSchemeSelect) {
						colorSchemeSelect.addEventListener('change', (e) => {
							appState.templateSettings.statistics.colorScheme = e.target.value;
						});
						colorSchemeSelect.value = appState.templateSettings.statistics.colorScheme;
					}
					
					// Gestionnaire pour l'affichage des légendes
					const showLegendsCheck = document.getElementById('show-legends');
					if (showLegendsCheck) {
						showLegendsCheck.addEventListener('change', (e) => {
							appState.templateSettings.statistics.showLegends = e.target.checked;
						});
						showLegendsCheck.checked = appState.templateSettings.statistics.showLegends;
					}
					
					// Gestionnaire pour l'affichage des étiquettes
					const showLabelsCheck = document.getElementById('show-labels');
					if (showLabelsCheck) {
						showLabelsCheck.addEventListener('change', (e) => {
							appState.templateSettings.statistics.showLabels = e.target.checked;
						});
						showLabelsCheck.checked = appState.templateSettings.statistics.showLabels;
					}
					
					// Gestionnaire pour l'animation des graphiques
					const animateGraphsCheck = document.getElementById('animate-graphs');
					if (animateGraphsCheck) {
						animateGraphsCheck.addEventListener('change', (e) => {
							appState.templateSettings.statistics.animateGraphs = e.target.checked;
						});
						animateGraphsCheck.checked = appState.templateSettings.statistics.animateGraphs;
					}
					
					// Gestionnaire pour le mode de données
					const dataModeSelect = document.getElementById('data-mode');
					if (dataModeSelect) {
						dataModeSelect.addEventListener('change', (e) => {
							appState.templateSettings.statistics.dataMode = e.target.value;
						});
						dataModeSelect.value = appState.templateSettings.statistics.dataMode;
					}
				}
                
                
                
				// Toujours dans la fonction updateTemplateSpecificSettings, après le switch
				if (templateId === 'geometry3d') {
					const wireframeCheck = document.getElementById('show-wireframe');
					const rotationCheck = document.getElementById('auto-rotation');
					const axesCheck = document.getElementById('show-axes');
					const themeCheck = document.getElementById('dark-theme');
					const shapeCountSelect = document.getElementById('shape-count');
					const formulasCheck = document.getElementById('show-formulas');
					const dimensionCheck = document.getElementById('dimension-controls');
					
					html += `
						<div class="form-group">
							<label class="form-label" for="geo3d-attempts">Nombre de tentatives par exercice:</label>
							<select id="geo3d-attempts" class="form-select">
								<option value="1" selected>1 tentative</option>
								<option value="2">2 tentatives</option>
								<option value="3">3 tentatives</option>
								<option value="unlimited">Illimité</option>
							</select>
						</div>
						
						<div class="switch-container">
							<span class="switch-label">Autoriser plusieurs tentatives:</span>
							<label class="switch">
								<input type="checkbox" id="geo3d-multiple-attempts">
								<span class="slider"></span>
							</label>
						</div>
					`;
				
					// Plus bas, dans la même section
					// Ajoutez ces écouteurs:
				
					const attemptsSelect = document.getElementById('geo3d-attempts');
					const multipleAttemptsCheck = document.getElementById('geo3d-multiple-attempts');
					
					if (attemptsSelect) {
						attemptsSelect.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.attemptsPerExercise = e.target.value;
						});
						if (appState.templateSettings.geometry3d.attemptsPerExercise) {
							attemptsSelect.value = appState.templateSettings.geometry3d.attemptsPerExercise;
						}
					}
					
					if (multipleAttemptsCheck) {
						multipleAttemptsCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.allowMultipleAttempts = e.target.checked;
						});
						multipleAttemptsCheck.checked = appState.templateSettings.geometry3d.allowMultipleAttempts;
					}
									
					
					
					if (wireframeCheck) {
						wireframeCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.showWireframe = e.target.checked;
						});
						wireframeCheck.checked = appState.templateSettings.geometry3d.showWireframe;
					}
					
					if (rotationCheck) {
						rotationCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.autoRotation = e.target.checked;
						});
						rotationCheck.checked = appState.templateSettings.geometry3d.autoRotation;
					}
					
					if (axesCheck) {
						axesCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.showAxes = e.target.checked;
						});
						axesCheck.checked = appState.templateSettings.geometry3d.showAxes;
					}
					
					if (themeCheck) {
						themeCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.darkTheme = e.target.checked;
						});
						themeCheck.checked = appState.templateSettings.geometry3d.darkTheme;
					}
					
					if (shapeCountSelect) {
						shapeCountSelect.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.shapeCount = parseInt(e.target.value);
						});
						shapeCountSelect.value = appState.templateSettings.geometry3d.shapeCount;
					}
					
					if (formulasCheck) {
						formulasCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.showFormulas = e.target.checked;
						});
						formulasCheck.checked = appState.templateSettings.geometry3d.showFormulas;
					}
					
					if (dimensionCheck) {
						dimensionCheck.addEventListener('change', (e) => {
							appState.templateSettings.geometry3d.allowDimensionControls = e.target.checked;
						});
						dimensionCheck.checked = appState.templateSettings.geometry3d.allowDimensionControls;
					}
				}                
								
            }
            
        }


		// Fonction pour générer le prompt
		function generatePrompt() {
			// Vérifier si un template a été sélectionné
			if (!appState.selectedTemplate) {
				showNotification("Veuillez d'abord sélectionner un template!");
				return;
			}
			
			// Afficher l'indicateur de chargement
			document.getElementById('loading-indicator').style.display = 'block';
			
			// Désactiver le bouton de génération
			document.getElementById('generate-prompt-btn').disabled = true;
			
			// Simuler un délai de génération (à remplacer par une vraie logique de génération)
			setTimeout(() => {
				// Créer le prompt
				const prompt = createPrompt();
				
				// Calculer les statistiques du prompt
				const stats = calculatePromptStats(prompt);
				
				// Afficher le prompt
				document.getElementById('prompt-preview').textContent = prompt;
				
				// Afficher les statistiques
				document.getElementById('line-count').textContent = stats.lines;
				document.getElementById('word-count').textContent = stats.words;
				document.getElementById('token-count').textContent = stats.tokens.toLocaleString();
				
				// Activer les boutons
				document.getElementById('copy-prompt-btn').disabled = false;
				document.getElementById('download-prompt-btn').disabled = false;
				document.getElementById('toggle-technical-btn').disabled = false;
				
				// Masquer l'indicateur de chargement
				document.getElementById('loading-indicator').style.display = 'none';
				
				// Réactiver le bouton de génération
				document.getElementById('generate-prompt-btn').disabled = false;
				
				// Sauvegarder le prompt généré
				appState.generatedPrompt = prompt;
				
				showNotification("Prompt généré avec succès!");
			}, 1500);
		}
        
        
        

        // Fonction pour créer le prompt
        function createPrompt() {
            const template = templatesDetails[appState.selectedTemplate];
            
            // Construire le prompt principal
            let prompt = `#A GÉNÉRATION D'APPLICATION SCORM INTERACTIVE

Veuillez créer une application SCORM interactive complète et fonctionnelle selon les spécifications suivantes:

## INFORMATIONS GÉNÉRALES
- Titre: "${appState.title}"
- Description: "${appState.description}"
- Auteur: "${appState.author}"
- Matière/Sujet: "${appState.subject === 'custom' ? appState.customSubject : appState.subject}"
- Niveau de difficulté: ${appState.difficulty}
- Public cible: ${appState.audience}

## TYPE D'APPLICATION
Type: ${template.title}
${template.description}

## FORMAT DES REPONSES MATHEMATIQUES : UTILISER LA VIRGULE "," AU LIEU DU POINT "." POUR LES NOMBRES DECIMAUX

## CONTENU : TRES IMPORTANT
- Nombre d'exercices: ${appState.exerciseCount}${appState.contentTheme ? '\n- Thème du contenu: ' + appState.contentTheme : ''}
- Instructions générales: "${appState.contentInstructions}"

## ⚠️ IMPORTANT ! APPARENCE / THEME DE COULEUR DE L APPLICATION /

- Thème de couleur: ${appState.colorTheme}${appState.useCustomColor ? '\n- Couleur personnalisée: ' + appState.customPrimaryColor : ''}

### ⚠️ IMPORTANT UTILISER LA MEME COULEUR POUR LE FOND DE PAGE DE L APPLICATION : ${appState.colorTheme}
### ⚠️ COULEUR POUR ACCENTUATION DES ELEMENTS : ${appState.colorTheme} SAUF  SI COULEUR ACTIVEE  ${appState.customPrimaryColor} DEVIENT PRIORITAIRE
### NOTES POUR LA CREATIVITE : PERSONNALISATION UTILISER UN STYLE D INTERFACE : ${appState.uiStyle}
### RESPECTER LA POLICE DE CARACTERES : ${appState.fontFamily}

## FONCTIONNALITÉS
${Object.entries(appState.features).map(([key, value]) => `- ${key}: ${value ? 'Oui' : 'Non'}`).join('\n')}

## REPONSES ET TENTATIVES PAR BLOC DE QUESTION
// =====================================================================
## ⚠️ NOTES IMPORTANTES POUR LE NOMBRE DE TENTATIVES POUR CHAQUE QUESTION OU DEFI
// =====================================================================
- PAR DEFAUT LE NOMBRE DE TENTATIVES DE REPONSE A UNE QUESTION EST 1 SAUF SI ${appState.templateSettings.qcm.attemptsPerQuestion} EST DIFFERENT DE 1
- COMPORTEMENT OBLIGATOIRE SI ${appState.templateSettings.qcm.attemptsPerQuestion} EST EGAL A 1 : DESACTIVER LES AUTRES OPTIONS/REPONSES DU BLOC DE QUESTIONS 
- COMPORTEMENT OBLIGATOIRE SI ${appState.templateSettings.qcm.attemptsPerQuestion} EST DIFFRENT DE 1 : LAISSER ACTIVES LES AUTRES OPTIONS/REPONSES DU BLOC DE QUESTIONS 

## AFFICHAGE DES TENTATIVES PAR BLOC DE QUESTION :
- UNE PASTILLE AFFICHE LE NOMBRE DE TENTATIVES RESTANTES PAR QUESTION (VOIR ##⚠️ PRIORITE HAUTE : FORMAT POUR PASTILLES "NOMBRE DE TENTATIVES")
- ATTENTION ⚠️ SI NOMBRE ILLIMITE maxAttempts = Infinity AFFICHER TOUJOURS : "∞"

## GAMIFICATION
- Badges: ${appState.enableBadges ? 'Oui' : 'Non'}${appState.enableBadges ? '\n- Nombre de badges: ' + appState.badgeCount : ''}${appState.enableBadges ? '\n- Seuil de déblocage: ' + appState.badgeThreshold : ''}

// =====================================================================
## ⚠️ NOTES IMPORTANTES SUR LA GAMIFICATION
// =====================================================================
- LES BADGES DE GAMIFICATION SONT TOUJOURS PLACÉS EN DESSOUS DU HEADER
- LES BADGES SONT DÉBLOQUÉS AU FUR ET À MESURE DE LA PROGRESSION SEULEMENT SI LES RÉPONSES SONT CORRECTES
#B PARAMÈTRES SPÉCIFIQUES AU TEMPLATE

// =====================================================================
## ⚠️⚠️ PRIORITE HAUTE : COMPORTEMENT PAR DEFAUT QUAND BOUTON "FIN D ACTIVITE" EST ACTIVE
// =====================================================================
- LES BLOCS DE QUESTIONS SONT TOUS DESACTIVES PAR DEFAUT
- ACTIVATION DU MODAL
- PRESENTATION DU BILAN DES REUSSITES / ECHECS / ACHEVEMENTS

// =====================================================================
## ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
// =====================================================================
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points 

`;
            // Ajouter les paramètres spécifiques au template
			switch(appState.selectedTemplate) {
				
			
			
			
				case 'qcm':
					prompt += `# CONFIGURATION DU SYSTÈME QCM

##1 PARAMÈTRES DE CONTENU

// =====================================================================
### ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
PRIVILEGIER LE CONTEXTE DECRIT DANS CES INSTRUCTIONS

// =====================================================================
##2 ⚠️ NOTES IMPORTANTES POUR LE FORMAT DES REPONSES MATHEMATIQUES
// =====================================================================
### POUR LES FRACTIONS : des fractions équivalentes ne doivents pas figurer dans des réponses différentes (exemple 6/6 est équivalent à 1/1  ou 2/3 equivalent à 6/9 et à 10/15) sauf si explicitement demandé dans la question
### POUR LES FRACTIONS : DONNER PLUSIEURS FRACTIONS EQUIVALENTES SI ${appState.templateSettings.qcm.allowMultipleCorrect ? 'Oui' : 'Non'}
### POUR TOUT CALCULS : donner des valeurs arrondies à 0,1% près
### NE PAS DONNER DE REPONSES DANS L ENONCE
### PRIVILIGIER LA RIGUEUR MATHEMATIQUE
### SI UNITES : UTILISER UNITES DU SYSTEME INTERNATIONAL

##3 PARAMÈTRES D'AFFICHAGE
- Afficher les explications: ${appState.templateSettings.qcm.showExplanations ? 'Oui' : 'Non'}


##4 PARAMÈTRES D'ÉVALUATION
// =====================================================================
### ⚠️ PRIORITE HAUTE : COMPORTEMENT DES QUESTIONS ET GESTION DES REPONSES
// =====================================================================
### OPTIONS PAR QUESTIONS : ${appState.templateSettings.qcm.optionsPerQuestion}
### CREER PLUSIEURS REPONSES CORRECTES  ${appState.templateSettings.qcm.allowMultipleCorrect ? 'Oui' : 'Non'}
### ⚠️ PRECISER QUE PLUSIEURS REPONSES SONT CORRECTES DANS ENONCE SI  ${appState.templateSettings.qcm.allowMultipleCorrect ? 'Oui' : 'Non'}


##5 PARAMÈTRES D'INTERACTION
### DESACTIVER LES AUTRES OPTIONS DE REPONSES SI ${appState.templateSettings.qcm.disableAfterAnswer ? 'Oui' : 'Non'} MAIS PAS SI PLUSIEURS REPONSES SONT CORRECTES  ${appState.templateSettings.qcm.allowMultipleCorrect ? 'Oui' : 'Non'}
- ⚠️ PRIORITÉ HAUTE : Désactiver les autres options après réponse: ${appState.templateSettings.qcm.disableAfterAnswer ? 'Oui' : 'Non'}
- ⚠️ PRIORITÉ SI COCHÉ : Tentatives par question: ${appState.templateSettings.qcm.attemptsPerQuestion === 'unlimited' ? 'Illimitées' : appState.templateSettings.qcm.attemptsPerQuestion}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points 

##7 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points 

`;
					break;                    
                    
                    
                    
                    
                case 'sequence':
					prompt += `# CONFIGURATION DU SYSTÈME DE SÉQUENCE

##1 PARAMÈTRES DE CONTENU
// =====================================================================
### ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================

##2 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.sequence.showHints ? 'Oui' : 'Non'}

##3 ✅ PARAMÈTRES D'ÉVALUATION
// =====================================================================
### ⚠️ PRIORITE HAUTE : COMPORTEMENT DES QUESTIONS ET GESTION DES REPONSES
// =====================================================================
- Autoriser plusieurs tentatives: ${appState.templateSettings.sequence.allowMultipleAttempts ? 'Oui' : 'Non'}
- Tentatives par exercice: ${appState.templateSettings.sequence.attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings.sequence.attemptsPerExercise}

##4 PARAMÈTRES D'INTERACTION
- Permettre la réorganisation: ${appState.templateSettings.sequence.allowReordering ? 'Oui' : 'Non'}
// =====================================================================
## PRIORITÉS IMPORTANTES POUR LE SYSTÈME DE DRAG & DROP
// =====================================================================
- ⚠️ OBLIGATOIRE !!! LES ÉLÉMENTS qui sont déplacés ne doivent plus apparaître dans la zone d'origine : pas de doublons
- ⚠️ PRIORITÉ HAUTE : LE FONCTIONNEMENT DU SYSTÈME DE DRAG & DROP DOIT S'APPLIQUER À TOUS LES EXERCICES !

##5 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points 

`;
					break;           
					         
					         
					         
					         
				case 'category':	
					prompt += `# CONFIGURATION DU SYSTÈME DE CATÉGORISATION

##1 PARAMÈTRES DE CONTENU
// =====================================================================
### ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
- Nombre de catégories: ${appState.templateSettings.category.categoryCount}
- Éléments par catégorie: ${appState.templateSettings.category.itemsPerCategory}

##2 ✅ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.category.allowMultipleAttempts ? 'Oui' : 'Non'}
- Tentatives par exercice: ${appState.templateSettings.category.attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings.category.attemptsPerExercise}

##3 PARAMÈTRES D'INTERACTION
// =====================================================================
### PRIORITÉS IMPORTANTES POUR LE SYSTÈME DE DRAG & DROP
// =====================================================================
### ⚠️ OBLIGATOIRE !!! LES ÉLÉMENTS qui sont déplacés ne doivent plus apparaître dans la zone d'origine : pas de doublons
### ⚠️ PRIORITÉ HAUTE : LE FONCTIONNEMENT DU SYSTÈME DE DRAG & DROP DOIT S'APPLIQUER À TOUS LES EXERCICES !
### ⚠️⚠️ FONCTIONNALITÉS OBLIGATOIRES : 
   • Détection automatique des zones de catégories
   • Animation fluide pendant le déplacement
   • Retour visuel lors du survol des zones cibles
   • Gestion des collisions et du positionnement
   • Bouton de suppression pour chaque élément placé
   • Restauration automatique dans le conteneur d'origine
   • Gestion des tentatives : réinitialiser déplace les blocs dans la zone container d'origine
   
##4 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points   
   
   `;
					break;



				case 'derivees':
                    prompt += `# CONFIGURATION DU SYSTÈME DE DERIVEES

##1 PARAMÈTRES DE CONTENU
// =====================================================================
### ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================

##3 ⚠️ PARAMÈTRES DES POLYNOMES
- Degré du polynôme: ${appState.templateSettings.derivees.polynomialDegree}

### EXEMPLES SELON LE DEGRÉ: ${appState.templateSettings.derivees.polynomialDegree}
- Degré 2: f(x) = ax² + bx + c → f'(x) = 2ax + b
- Degré 3: f(x) = ax³ + bx² + cx + d → f'(x) = 3ax² + 2bx + c  
- Degré 4: f(x) = ax⁴ + bx³ + cx² + dx + e → f'(x) = 4ax³ + 3bx² + 2cx + d
- Degré 5: f(x) = ax⁵ + bx⁴ + cx³ + dx² + ex + f → f'(x) = 5ax⁴ + 4bx³ + 3cx² + 2dx + e

##4 ⚠️ PARAMÈTRES DE DIFFICULTE
- Difficulté des coefficients: ${appState.templateSettings.derivees.difficulty}
- Type de questions: ${appState.templateSettings.derivees.questionType}

### EXEMPLES SELON LA DIFFICULTE: ${appState.templateSettings.derivees.difficulty}
- easy : coefficients entiers positifs 1 à 10 : easy Degré 3: f(x) = 2x³ + 1x² + 4x + 5 → f'(x) = 6x² + 2x + 4  
- medium : coefficients entiers  -10 à 10 : medium Degré 3: f(x) = -2x³ - x² + 4x - 5 → f'(x) = -6x² - 2x + 4  
- hard : coefficients décimaux -10 à 10 / pas de 0,1 : hard Degré 3: f(x) = 0,1x³ - 0,4 x² + x - 5 → f'(x) = 0,3 x² - 0,8 x + 1 
- ATTENTION !!! easy Degré 3, medium Degré 3, hard Degré 3 sont des exemples à décliner selon le degré ${appState.templateSettings.derivees.polynomialDegree}

##5 ✅ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.derivees.allowMultipleAttempts ? 'Oui' : 'Non'}
- Nombre maximum de tentatives: ${appState.templateSettings.derivees.maxAttempts}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
                    break;




				case 'periodic':
					prompt += `# CONFIGURATION DU SYSTÈME DE TABLEAU PÉRIODIQUE

##1 PARAMÈTRES DE CONTENU
- Types de questions: ${appState.templateSettings.periodic.questionTypes.join(', ')}

// =====================================================================
##2 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
Type de question : les questions actuellement présentes dans le JavaScript ne sont que deux exemples, il faut en inventer d'autres.
// =====================================================================

##3 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.periodic.showHints ? 'Oui' : 'Non'}

##4 ✅ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.periodic.allowMultipleAttempts ? 'Oui' : 'Non'}
- Nombre maximum de tentatives: ${appState.templateSettings.periodic.maxAttempts}

##5 PARAMÈTRES D'AFFICHAGE
// =====================================================================
## PRIORITÉS HAUTES POUR LE TABLEAU PÉRIODIQUE
// =====================================================================
⚠️ PRIORITÉ HAUTE : NE PAS AFFICHER DANS LA ZONE DE TABLEAU LES DONNÉES DEMANDÉES DANS LES EXERCICES
   → Exemple: si une question demande "combien de neutrons dans le noyau de carbone", ne pas afficher le nombre de neutrons

##6 FONCTIONNALITÉS REQUISES:
   • Le tableau périodique doit être placé juste après le header et avant les questions
   • Les questions doivent porter sur les propriétés des éléments (Z, A, électrons, protons, neutrons)
   • Inclure des calculs de masse molaire pour des molécules simples (ex: H₂O, CO₂, etc.)
   • Permettre aux utilisateurs de sélectionner des éléments en cliquant sur le tableau
   
##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points
   `;
					break;
                    



				case 'probability':
					prompt += `# CONFIGURATION DU SYSTÈME DE PROBABILITÉ

#1 PARAMÈTRES DE CONTENU
// =====================================================================
### ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
- Types de questions: ${appState.templateSettings.probability.questionType} ⚠️⚠️ PRIORITÉ PLUS HAUTE QUE L'UTILISATION DES QUESTIONS DU CODE JAVASCRIPT
- Inclure des calculs de fréquence: ${appState.templateSettings.probability.includeFrequencyCalc ? 'Oui' : 'Non'}

#2 PARAMÈTRES PRINCIPAUX
// =====================================================================
## ⚠️ PRIORITÉS CRITIQUES POUR L'ACTIVITÉ PROBABILITÉ
// =====================================================================
- Type de simulation: ${appState.templateSettings.probability.simulationType}
- Nombre maximum de lancers: ${appState.templateSettings.probability.maxSimulations}

#3 PARAMÈTRES D'AFFICHAGE
- Montrer les explications détaillées: ${appState.templateSettings.probability.showExplanations ? 'Oui' : 'Non'}
1️⃣ ⚠️⚠️ OBLIGATOIRE : TENIR COMPTE DU TYPE DE SIMULATION DEMANDÉE (${appState.templateSettings.probability.simulationType})
2️⃣ ⚠️ PRIORITÉ HAUTE : NE PAS DONNER LES RÉPONSES DANS L'ÉNONCÉ AUX QUESTIONS POSÉES 
3️⃣ IMPORTANT : LES RÉPONSES AUX QUESTIONS DE TYPE NUMÉRIQUES:
   - Pour les FRÉQUENCES: présenter en DÉCIMAL ET aussi en POURCENTAGE
   - Pour les PROBABILITÉS: présenter en DÉCIMAL uniquement
4️⃣ ⚠️⚠️ OBLIGATOIRE : GÉNÉRER ET UTILISER DES ALTERNATIVES AUX QUESTIONS DU CODE JAVASCRIPT DE L'APPLICATION

##4 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points


`;
					break;




				case 'arithmetique':
					prompt += `### CONFIGURATION DU SYSTÈME DE SUITES ARITHMÉTIQUES

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
SINON N UTILISER QUE LES THEMES D EXERCICES SUIVANTS :
// =====================================================================

// =====================================================================
##2 ⚠️ PRIORITÉS HAUTE : TYPES D'EXERCICES ACTIVÉS 
// =====================================================================
- Calculer le terme suivant: ${appState.templateSettings.arithmetique.exerciseTypes.nextTerm ? 'Oui' : 'Non'}
- Trouver le terme manquant: ${appState.templateSettings.arithmetique.exerciseTypes.missingTerm ? 'Oui' : 'Non'}
- Calculer la raison: ${appState.templateSettings.arithmetique.exerciseTypes.reason ? 'Oui' : 'Non'}
- Calculer le terme de rang N: ${appState.templateSettings.arithmetique.exerciseTypes.nthTerm ? 'Oui' : 'Non'}
- Calculer le rang d'un terme: ${appState.templateSettings.arithmetique.exerciseTypes.rank ? 'Oui' : 'Non'}
- Calculer la somme des n premiers termes: ${appState.templateSettings.arithmetique.exerciseTypes.sum ? 'Oui' : 'Non'}
- Problème appliqué: ${appState.templateSettings.arithmetique.exerciseTypes.application ? 'Oui' : 'Non'}

##3 PARAMÈTRES DE DIFFICULTE
- Niveau de difficulté: ${appState.templateSettings.arithmetique.difficultyLevel}
- Nombre de termes affichés: ${appState.templateSettings.arithmetique.termCount}

##4 IMPORTANT : PARAMÈTRES D'AFFICHAGE
- Afficher les formules: ${appState.templateSettings.arithmetique.showFormulas ? 'Oui' : 'Non'}
- Mettre en évidence les patterns: ${appState.templateSettings.arithmetique.highlightPatterns ? 'Oui' : 'Non'}
⚠️ PRIORITÉ HAUTE: PRESENTATION DES QUESTIONS EN DEUX COLONNES POUR UNE MEILLEURE VISUALISATION

##5 ✅ IMPORTANT : PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.arithmetique.allowMultipleAttempts ? 'Oui' : 'Non'}
- Nombre maximum de tentatives: ${appState.templateSettings.arithmetique.maxAttempts === -1 ? 'Illimité' : appState.templateSettings.arithmetique.maxAttempts}

##5 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;

					break;



				case 'geometrique':
					prompt += `### CONFIGURATION DU SYSTÈME GÉOMÉTRIQUE

## PARAMÈTRES DE CONTENU

- Niveau de difficulté: ${appState.templateSettings.geometrique.difficultyLevel}
- Nombre de termes affichés: ${appState.templateSettings.geometrique.termCount}
- Précision décimale: ${appState.templateSettings.geometrique.decimalPrecision}

// =====================================================================
## ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
## ⚠️ PRIORITÉS HAUTE : TYPES D'EXERCICES ACTIVÉS : N UTILISER QUE LES THEMES D EXERCICES SUIVANTS :
// =====================================================================

- Calculer le terme suivant: ${appState.templateSettings.geometrique.exerciseTypes.nextTerm ? 'Oui' : 'Non'}
- Trouver le terme manquant: ${appState.templateSettings.geometrique.exerciseTypes.missingTerm ? 'Oui' : 'Non'}
- Calculer la raison: ${appState.templateSettings.geometrique.exerciseTypes.reason ? 'Oui' : 'Non'}
- Calculer le rang d'un terme: ${appState.templateSettings.geometrique.exerciseTypes.rank ? 'Oui' : 'Non'}
- Calculer le terme de rang N: ${appState.templateSettings.geometrique.exerciseTypes.nthTerm ? 'Oui' : 'Non'}
- Calculer la somme des n premiers termes: ${appState.templateSettings.geometrique.exerciseTypes.sum ? 'Oui' : 'Non'}
- Problème appliqué: ${appState.templateSettings.geometrique.exerciseTypes.application ? 'Oui' : 'Non'}

## IMPORTANT : PARAMÈTRES D'AFFICHAGE
- Afficher les formules: ${appState.templateSettings.geometrique.showFormulas ? 'Oui' : 'Non'}
- Mettre en évidence les patterns: ${appState.templateSettings.geometrique.highlightPatterns ? 'Oui' : 'Non'}
⚠️ PRIORITÉ HAUTE: PRESENTATION DES QUESTIONS EN DEUX COLONNES POUR UNE MEILLEURE VISUALISATION

## ✅ PARAMÈTRES MATHÉMATIQUES
- Autoriser les termes négatifs: ${appState.templateSettings.geometrique.allowNegativeTerms ? 'Oui' : 'Non'}

## ✅ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.geometrique.allowMultipleAttempts ? 'Oui' : 'Non'}
- Nombre maximum de tentatives: ${appState.templateSettings.geometrique.maxAttempts === -1 ? 'Illimité' : appState.templateSettings.geometrique.maxAttempts}

##4 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;
					
					

				case 'proba':
					prompt += `### CONFIGURATION DU SYSTÈME DE PROBABILITÉS

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
##2 PARAMÈTRES DE CONTENU
- Nom de l'événement A: ${appState.templateSettings.proba.eventAName}
- Nom de l'événement B: ${appState.templateSettings.proba.eventBName}
- Types de questions: ${appState.templateSettings.proba.questionTypes.map(type => {
    if (type === 'basic') return 'Probabilités simples';
    if (type === 'compound') return 'Probabilités composées';
    if (type === 'conditional') return 'Probabilités conditionnelles';
    return type;
}).join(', ')}

##3 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.proba.showHints ? 'Oui' : 'Non'}

##3 ✅ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.proba.allowMultipleAttempts ? 'Oui' : 'Non'}${appState.templateSettings.proba.allowMultipleAttempts ? '\n- Nombre maximum de tentatives: ' + appState.templateSettings.proba.maxAttempts : ''}

1️⃣ ⚠️⚠️ OBLIGATOIRE : NE PAS AFFICHER LES PROBABILITES DES EVENEMENTS EN DESSOUS DU TABLEAU
2️⃣ ⚠️ PRIORITÉ HAUTE : NE PAS DONNER LES RÉPONSES DANS L'ÉNONCÉ AUX QUESTIONS POSÉES 
3️⃣ IMPORTANT : LES RÉPONSES AUX QUESTIONS DE TYPE NUMÉRIQUES:
   - Pour les PROBABILITÉS: présenter en DÉCIMAL uniquement
   - Dans les questions demander une précision avec deux décimales
   
##5 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points
   
    `;
					break;



				case 'titrage':
					prompt += `# CONFIGURATION DU SYSTÈME DE TITRAGE
					
// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================

##2 TYPE DE TITRAGE (PRIORITÉ HAUTE)
⚠️ PRIORITÉ HAUTE : RESPECTER LE CHOIX de titrage: ${appState.templateSettings.titrage.titrageType === 'acid-base' ? 'Acide-Base (acide titré par base)' : appState.templateSettings.titrage.titrageType === 'base-acid' ? 'Base-Acide (base titrée par acide)' : 'Mixte (alternance)'}

##3 ✅ PARAMÈTRES EXPÉRIMENTAUX
- Indicateurs colorés: ${appState.templateSettings.titrage.indicators === 'both' ? 'Bromothymol et Phénolphtaléine' : appState.templateSettings.titrage.indicators === 'bromothymol' ? 'Bleu de bromothymol seulement' : 'Phénolphtaléine seulement'}

##4 PARAMÈTRES DE DIFFICULTÉ
- Difficulté des calculs: ${appState.templateSettings.titrage.difficulty === 'easy' ? 'Facile' : appState.templateSettings.titrage.difficulty === 'medium' ? 'Moyen' : 'Difficile'}

##5 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.titrage.showHints ? 'Oui' : 'Non'}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;
                    
                    
                    
				case 'chimie-orga':
					prompt += `# CONFIGURATION DU SYSTEME POUR CHIMIE ORGANIQUE
// =====================================================================
# PRIORITES IMPORTANTES  : POUR ACTIVITE CHIMIE ORGANIQUE
// =====================================================================		
// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
##2 ⚠️⚠️⚠️ PRIORITÉ ABSOLUE:
- UTILISER EXCLUSIVEMENT POUR LES QUESTIONS LES FAMILLES DE MOLÉCULES SÉLECTIONNÉES SUIVANTES :${Object.entries(appState.templateSettings['chimie-orga'].families)
        .filter(([_, enabled]) => enabled)
        .map(([family]) => `\n  - ${family.charAt(0).toUpperCase() + family.slice(1)}s`)
        .join('')}
##3 ⚠️ REMARQUE AVEC PRIORITÉ HAUTE : si la famille Aldehydes est sélectionnée alors inclure également les cétones

- UTILISER EXCLUSIVEMENT POUR LES SIMULATIONS INTERACTIVES LES FAMILLES DE MOLÉCULES SÉLECTIONNÉES SUIVANTES :${Object.entries(appState.templateSettings['chimie-orga'].families)
        .filter(([_, enabled]) => enabled)
        .map(([family]) => `\n  - ${family.charAt(0).toUpperCase() + family.slice(1)}s`)
        .join('')}

##4 ⚠️ PRIORITÉS HAUTES:
- TYPES DE QUESTIONS À INCLURE:${appState.templateSettings['chimie-orga'].questionTypes.type1 ? '\n  - Type 1: Construction de molécules' : ''}${appState.templateSettings['chimie-orga'].questionTypes.type2 ? '\n  - Type 2: Identification de molécules' : ''}
- ATTENTION !!! POUR LES QUESTIONS DE TYPE 1 LA MOLECULE QUI DOIT ETRE AFFICHEE DANS LA SIMULATION NE DOIT PAS ETRE CELLE DE LA QUESTION 
- PAR DEFAUT POUR LES QUESTIONS DE TYPE 1 : AFFICHER LE METHANE OU LA MOLECULE LA PLUS SIMPLE DE LA FAMILLE SLECTIONNEE (SAUF SI ELLE EST DEMANDEE DANS QUESTION SELECTIONNEE)
- POUR LES QUESTIONS DE TYPE 2 : LA MOLECULE AFFICHEE EST CELLE APPELEE PAR LA QUESTION

##5 ✅ PARAMÈTRES D EVALUATION:
- ⚠️ Gestion des tentatives: ${appState.templateSettings['chimie-orga'].allowMultipleAttempts === 'single' ? 'Une seule tentative autorisée' : appState.templateSettings['chimie-orga'].allowMultipleAttempts === 'multiple' ? `Multiples tentatives (maximum: ${appState.templateSettings['chimie-orga'].maxAttempts})` : 'Tentatives illimitées'}
- Affichage des indices: ${appState.templateSettings['chimie-orga'].showHints === 'always' ? 'Toujours visibles' : appState.templateSettings['chimie-orga'].showHints === 'after-attempt' ? 'Affichés après une tentative incorrecte' : 'Jamais affichés'}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;
                    

                    
				case 'equation':
					prompt += `# CONFIGURATION DU SYSTÈME D'ÉQUATIONS

// =====================================================================
## ⚠️⚠️ PRIORITÉS CRITIQUES POUR L'AFFICHAGE DES ÉQUATIONS
// =====================================================================
// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================

##2 PARAMÈTRES DE CONTENU
- Nombre de réactifs (max): ${appState.templateSettings.equation.reactifCount}
- Nombre de produits (max): ${appState.templateSettings.equation.produitCount}

##3 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.equation.showHints ? 'Oui' : 'Non'}

##4 ✅ PARAMÈTRES D'ÉVALUATION
- Tentatives multiples: ${appState.templateSettings.equation.allowMultipleAttempts ? 'Oui' : 'Non'}${appState.templateSettings.equation.allowMultipleAttempts ? '\n- Nombre maximum de tentatives: ' + appState.templateSettings.equation.maxAttempts : ''}

##5 PARAMÈTRES DE PRESENTATION
⚠️ PRIORITÉ HAUTE: POUR LES ÉQUATIONS LONGUES, DIMINUER LA POLICE DE CARACTÈRES POUR UNE MEILLEURE VISUALISATION
⚠️ PRIORITÉ HAUTE: PRESENTATION DES QUESTIONS EN DEUX COLONNES POUR UNE MEILLEURE VISUALISATION

##4 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;


					break;



				case 'tableaux':
					prompt += `# CONFIGURATION DU SYSTÈME DE TABLEAU DE VALEURS

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================

##2 PARAMÈTRES DE CONTENU
### ⚠️ PRIORITÉ HAUTE : RESPECTER LES TYPES DE FONCTIONS CHOISIES ${appState.templateSettings.tableaux.functionType}${appState.templateSettings.tableaux.functionType === 'custom' ? '\n- Fonction personnalisée: ' + appState.templateSettings.tableaux.customFunction : ''}

### IMPORTANT : PRESENTATION DES TABLEAUX A RESPECTER 
- Nombre de colonnes: ${appState.templateSettings.tableaux.columnCount}

##3 IMPORTANT : PARAMETRES DE CALCUL
- ⚠️ TYPES DE CALCULS  ${appState.templateSettings.tableaux.calculationType}
- ⚠️⚠️ NOMBRE DE VALEURS A CALCULER : ${appState.templateSettings.tableaux.valuesCount}
- ⚠️ GENERATION ALEATOIRE DES CELLULES DU TABLEAU : à chaque initialisation de l'application choisir aléatoirement ${appState.templateSettings.tableaux.valuesCount} valeurs

##4 ✅  PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.tableaux.allowMultipleAttempts ? 'Oui' : 'Non'}${appState.templateSettings.tableaux.allowMultipleAttempts ? '\n- Nombre maximum de tentatives: ' + (appState.templateSettings.tableaux.maxAttempts === 999 ? 'Illimité' : appState.templateSettings.tableaux.maxAttempts) : ''}

##5 PARAMÈTRES DE PRESENTATION
⚠️ PRIORITÉ HAUTE: PRESENTATION DES QUESTIONS EN DEUX COLONNES POUR UNE MEILLEURE VISUALISATION

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;



				case 'match':
					prompt += `# CONFIGURATION DU SYSTÈME DE CORRESPONDANCE (DRAG & DROP)

// =====================================================================
##1 PRIORITÉS CRITIQUES POUR LE SYSTÈME DE DRAG & DROP
// =====================================================================
⚠️ OBLIGATOIRE !!! LES ÉLÉMENTS qui sont déplacés ne doivent plus apparaître dans la zone d'origine : pas de doublons
⚠️ PRIORITÉ HAUTE : LE FONCTIONNEMENT DU SYSTÈME DE DRAG & DROP DOIT S'APPLIQUER À TOUS LES EXERCICES !

// =====================================================================
##2 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================

##3 PARAMÈTRES DE CONTENU
- Nombre de paires: ${appState.templateSettings.match.pairCount}

##4 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.match.showHints ? 'Oui' : 'Non'}

##5 ✅  PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.match.allowMultipleAttempts ? 'Oui' : 'Non'}
- Tentatives par exercice: ${appState.templateSettings.match.attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings.match.attemptsPerExercise}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;
                    
                    
                    
                    
                case 'calcul':
					prompt += `# CONFIGURATION DU SYSTÈME DE CALCUL

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
##2 PARAMÈTRES D'AFFICHAGE
- Afficher les formules: ${appState.templateSettings.calcul.showFormulas ? 'Oui' : 'Non'}

##3 ✅  PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.calcul.allowMultipleAttempts ? 'Oui' : 'Non'}

##4 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
                    break;
                    
                    
                    
                    
				case '3d':
					prompt += `# CONFIGURATION DE L'ENVIRONNEMENT 3D

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
##2 PARAMÈTRES DE CONTENU
- Nombre de modèles 3D: ${appState.templateSettings['3d'].modelCount}
- Thème des modèles: ${appState.templateSettings['3d'].modelTheme || 'Planètes'}

✅ MODE PRIORITAIRE: les molécules présente dans les questions existantes ne sont que des exemples il faut varier avec d'autres molécules

##3 PARAMÈTRES D'INTERACTION
- Activation de la rotation: ${appState.templateSettings['3d'].enableRotation ? 'Oui' : 'Non'}
- Activation du zoom: ${appState.templateSettings['3d'].enableZoom ? 'Oui' : 'Non'}

##4 PARAMÈTRES D'AFFICHAGE
- Affichage des informations détaillées: ${appState.templateSettings['3d'].showDetails ? 'Oui' : 'Non'}
- Thème sombre pour l'affichage 3D: ${appState.templateSettings['3d'].darkTheme ? 'Oui' : 'Non'}

##4 ⚠️ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings['3d'].allowMultipleAttempts ? 'Oui' : 'Non'}
- Tentatives par exercice: ${appState.templateSettings['3d'].attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings['3d'].attemptsPerExercise}

##5 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;
                    


				case 'statistics':
		// Vérifier que les propriétés existent avant de les utiliser
		const statsSettings = appState.templateSettings.statistics || {};
		const selectedGraphs = statsSettings.selectedGraphs || [];				
				
					prompt += `# CONFIGURATION DES VISUALISATIONS STATISTIQUES

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
##2 PARAMÈTRES DE CONTENU
- Types de graphiques inclus: ${appState.templateSettings.statistics.selectedGraphs.join(', ')}
- Mode de données: ${appState.templateSettings.statistics.dataMode}

##3 PARAMÈTRES D'AFFICHAGE
- Schéma de couleurs: ${appState.templateSettings.statistics.colorScheme}
- Afficher les légendes: ${appState.templateSettings.statistics.showLegends ? 'Oui' : 'Non'}
- Afficher les étiquettes: ${appState.templateSettings.statistics.showLabels ? 'Oui' : 'Non'}
- Animer les graphiques: ${appState.templateSettings.statistics.animateGraphs ? 'Oui' : 'Non'}

##4 ⚠️ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.statistics.allowMultipleAttempts ? 'Oui' : 'Non'}
- Tentatives par exercice: ${appState.templateSettings.statistics.attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings.statistics.attemptsPerExercise}

##5 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;    
                    


                    

                    
                    
                    
                    
                    
				case 'graphique':
					prompt += `# CONFIGURATION DU SYSTÈME DE TRACÉS GRAPHIQUES

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
##2 PARAMÈTRES DE CONTENU
- Nombre d'exercices: ${appState.templateSettings.graphique.exerciseCount}

##3 PARAMÈTRES D'AFFICHAGE VISUEL
- Afficher la grille: ${appState.templateSettings.graphique.showGrid ? 'Oui' : 'Non'}
- Afficher les points: ${appState.templateSettings.graphique.showPoints ? 'Oui' : 'Non'}
- Afficher les étiquettes: ${appState.templateSettings.graphique.showLabels ? 'Oui' : 'Non'}

##4 PARAMÈTRES D'AIDE
- Afficher les indices: ${appState.templateSettings.graphique.allowHints ? 'Oui' : 'Non'}

##5 ⚠️ PARAMÈTRES D'ÉVALUATION
- Autoriser plusieurs tentatives: ${appState.templateSettings.graphique.allowMultipleAttempts ? 'Oui' : 'Non'}
- Tentatives par exercice: ${appState.templateSettings.graphique.attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings.graphique.attemptsPerExercise}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;                
                    
                    
                    
                    
				case 'geometry3d':
					prompt += `# CONFIGURATION DE L'EXPLORATEUR 3D DE GÉOMÉTRIE

// =====================================================================
##1 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================					
##2 PARAMÈTRES D'AFFICHAGE VISUEL 
- Afficher le modèle filaire: ${appState.templateSettings.geometry3d.showWireframe ? 'Oui' : 'Non'}
- Afficher les axes: ${appState.templateSettings.geometry3d.showAxes ? 'Oui' : 'Non'} 
- Thème sombre: ${appState.templateSettings.geometry3d.darkTheme ? 'Oui' : 'Non'}
- Afficher les formules: ${appState.templateSettings.geometry3d.showFormulas ? 'Oui' : 'Non'}

##3 PARAMÈTRES D'INTERACTION
- Rotation automatique: ${appState.templateSettings.geometry3d.autoRotation ? 'Oui' : 'Non'}
- Contrôles des dimensions: ${appState.templateSettings.geometry3d.allowDimensionControls ? 'Oui' : 'Non'}

##4 PARAMÈTRES Du NOMBRE DE FORMES A AFFICHER
- Nombre de formes: ${appState.templateSettings.geometry3d.shapeCount}

##5 ⚠️ PARAMÈTRES D'EXERCICES
- Tentatives par exercice: ${appState.templateSettings.geometry3d.attemptsPerExercise === 'unlimited' ? 'Illimitées' : appState.templateSettings.geometry3d.attemptsPerExercise}
- Autoriser plusieurs tentatives: ${appState.templateSettings.geometry3d.allowMultipleAttempts ? 'Oui' : 'Non'}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;  
					
					
					
					
				case 'turtle':
					prompt += `# PARAMÈTRES DE CONFIGURATION DES DÉFIS TURTLE

// =====================================================================
## ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
## PRIORITÉ DE SÉLECTION DES DÉFIS
${appState.templateSettings.turtle.customChallenges ? 
'✅ MODE PRIORITAIRE: DÉFIS PERSONNALISÉS (les défis personnalisés ci-dessous remplacent tout code JS/HTML transmis)' : 
'✅ MODE PRIORITAIRE: DÉFIS PRÉDÉFINIS (les défis prédéfinis remplacent tout code JS/HTML transmis)'}

## CONFIGURATION GÉNÉRALE
- Nombre de défis: ${appState.templateSettings.turtle.challengeCount}
- Afficher les images attendues: ${appState.templateSettings.turtle.showExpectedImages ? 'Oui' : 'Non'}
- Permettre les indices: ${appState.templateSettings.turtle.allowHints ? 'Oui' : 'Non'}
- Défis personnalisés: ${appState.templateSettings.turtle.customChallenges ? 'Oui' : 'Non'}

${appState.templateSettings.turtle.customChallenges ? '## LISTE DES DÉFIS PERSONNALISÉS (PRIORITAIRES)' : '## LISTE DES DÉFIS PERSONNALISÉS (NON PRIORITAIRES)'};
				`;
					break;  
					
					
					
				case 'python':
					prompt += `# CONFIGURATION DE L'ENVIRONNEMENT PYTHON

// =====================================================================
## ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
## PARAMÈTRES D'INTERACTION UTILISATEUR 
- Autoriser l'édition du code: ${appState.templateSettings.python.allowCodeEditing ? 'Oui' : 'Non'}
- Afficher la sortie attendue: ${appState.templateSettings.python.showExpectedOutput ? 'Oui' : 'Non'}

## PARAMÈTRES D'ÉVALUATION
- Niveau de difficulté: ${appState.templateSettings.python.level || 'intermediate'}

### dans le niveau facile : 
		- respecter une syntaxe simple pour les questions exemple : print("hello","world) / print("hello",nombre)
		- pour les boucles : utiliser des mots ou par exemple range(n)
### dans le niveau intermediaire :
		- pour les boucles : utiliser des liste ou par exemple range(début, fin)

### dans le niveau avancé :
		- pour les boucles : utiliser des liste ou par exemple range(début, fin, pas)

## ⚠️ PRIORITÉ HAUTE : RESPECTER LE NOMBRE DE TENTATIVES POSSIBLES
- Nombre de tentatives: ${appState.templateSettings.python.attempts || 'unlimited'}

## ⚠️ PRIORITÉ HAUTE : RESPECTER LES TYPES D'EXERCICES PYTHON À INCLURE
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['print-input'] ? '- Affichage print() et entrée input()' : ''}
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['variables'] ? '- Variables et opérateurs mathématiques' : ''}
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['conditions'] ? '- Conditions if, else, elif' : ''}
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['for-loops'] ? '- Boucles for' : ''}
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['while-loops'] ? '- Boucles while' : ''}
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['functions'] ? '- Fonctions' : ''}
${appState.templateSettings.python.codeTypes && appState.templateSettings.python.codeTypes['lists'] ? '- Listes' : ''}

// =====================================================================
## ⚠️⚠️⚠️ PRIORITE ABSOLUE : DÉPENDANCES TECHNIQUES CRITIQUES
// =====================================================================
- Skulpt (pour l'exécution Python): 
  * https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js
  * https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js
- CodeMirror (pour l'éditeur de code): 
  * https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js
  * https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/python/python.min.js `;
					break;
					
					
					
				case 'stats':
					prompt += `# CONFIGURATION DU TEMPLATE STATISTIQUES À DEUX VARIABLES

// =====================================================================
##1 ⚠️⚠️⚠️ PRIORITE ABSOLUE : DÉPENDANCES TECHNIQUES ET SIMULATION
// =====================================================================
### ⚠️ PRIORITÉ 1: BIBLIOTHÈQUES REQUISES
- Chart.js: Pour afficher les graphiques de nuages de points et les droites de régression
- Math.js: Pour les calculs statistiques avancés

### ⚠️ PRIORITÉ 2: CDN REQUIS
 src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"
 src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"

### SIMULATION INTERACTIVE
- La simulation doit être placée en haut de l'interface sous le header et les badges
- La simulation doit être capable de générer dynamiquement des données selon différentes forces et types de corrélation
- La simulation doit calculer et afficher le coefficient de corrélation R, le coefficient de détermination R², et l'équation de régression linéaire
- Le graphique doit afficher à la fois le nuage de points et la droite de régression

### INTERACTIONS AVEC LA SIMULATION
- La simulation doit être mise à jour lorsqu'un exercice génère de nouvelles données
- Les statistiques calculées (R, R², équation) doivent être utilisées pour vérifier les réponses
- La vérification des réponses doit tenir compte d'une marge d'erreur pour les valeurs numériques (5% de tolérance)

### STYLES SPÉCIFIQUES
- Les graphiques doivent avoir un fond clair avec des points bleus pour les données et une ligne rouge pour la régression
- Les statistiques doivent être affichées dans des cartes en haut de la simulation
- Le tableau de données doit être affiché sous le graphique avec colonnes pour: numéro du point, X, Y, et coordonnées (X,Y)
- Les exercices doivent avoir un style cohérent avec des zones distinctes pour l'énoncé, les données, la saisie, et le résultat

// =====================================================================
##2 ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
### ⚠️⚠️ SECTION OBLIGATOIRE : CONFIGURATION DES TYPES D'EXERCICES

📋 ÉTAPE 1 : TYPES D'EXERCICES DISPONIBLES
Voici la liste complète des 6 types d'exercices possibles pour le template "Statistiques à Deux Variables" :
IDType d'exerciceDescriptionTYPE_1ExtrapolationPrédire Y pour une valeur X située en dehors des données observéesTYPE_2Type de corrélationDéterminer si la corrélation est positive, négative ou neutreTYPE_3Interprétation du R²Convertir R² en pourcentage de variance expliquéeTYPE_4Qualité d'ajustementÉvaluer la qualité du modèle basé sur R²TYPE_5InterpolationEstimer Y pour une valeur X située entre les données observéesTYPE_6Force de corrélationAnalyser la force de la relation entre X et Y

${appState.templateSettings.stats.questions.extrapolation ? '- Extrapolation: Prédire Y pour une valeur X située en dehors des données observées' : ''}
${appState.templateSettings.stats.questions.interpolation ? '- Interpolation: Estimer Y pour une valeur X située entre les données observées' : ''}
${appState.templateSettings.stats.questions.correlationType ? '- Type de corrélation: Déterminer si la corrélation est positive, négative ou neutre' : ''}
${appState.templateSettings.stats.questions.r2Interpretation ? '- Interprétation du R²: Convertir R² en pourcentage de variance expliquée' : ''}
${appState.templateSettings.stats.questions.fitQuality ? '- Qualité d\'ajustement: Évaluer la qualité du modèle basé sur R²' : ''}
${appState.templateSettings.stats.questions.correlationStrength ? '- Force de corrélation: Analyser la force de la relation entre X et Y' : ''}
###⚠️ EXCLURE TOTALEMENT LES TYPES DE QUESTIONS NON SELECTIONNES :


##3 ⚠️ CONFIGURATION SPÉCIFIQUE DES EXERCICES
- Force de corrélation: ${appState.templateSettings.stats.correlationStrength}
- Type de corrélation: ${appState.templateSettings.stats.correlationType}

### PARAMETRAGE DES EXERCICES
- Chaque exercice doit avoir un bouton "Générer un nuage de points" qui génère des données spécifiques à cet exercice
- Les données générées doivent être communiquées à la question et affichées dans la zone appropriée
- Les exercices doivent être disposés en grille de 2 colonnes avec 3 exercices par colonne
- Chaque exercice doit permettre un nombre limité de tentatives (${appState.templateSettings.stats.maxAttempts})
- Les exercices doivent inclure des indices contextuels

###  FONCTIONS MATHÉMATIQUES SPÉCIFIQUES
- Génération de données corrélées avec contrôle de la force et du type de corrélation
- Calcul de régression linéaire (méthode des moindres carrés)
- Calcul du coefficient de corrélation de Pearson (R)
- Calcul du coefficient de détermination (R²)
- Fonctions d'extrapolation et d'interpolation basées sur l'équation de régression

### FORMULES STATISTIQUES À IMPLÉMENTER
- Coefficient de corrélation R = Σ((xi-x̄)(yi-ȳ)) / √(Σ(xi-x̄)² × Σ(yi-ȳ)²)
- Coefficient de détermination R² = R × R
- Coefficient directeur a = (n×Σ(xi×yi) - Σxi×Σyi) / (n×Σ(xi²) - (Σxi)²)
- Ordonnée à l'origine b = (Σyi - a×Σxi) / n
- Équation de régression: y = ax + b

##4 ⚠️ PARAMÈTRES D'ÉVALUATION
- Tentatives multiples: ${appState.templateSettings.stats.multipleAttempts ? 'Oui' : 'Non'}
- Nombre maximum de tentatives: ${appState.templateSettings.stats.maxAttempts}

##6 ⚠️⚠️ OBLIGATOIRE : PARAMÈTRES DE BILAN:
- Faire le bilan dans le modal de fin d'activité des exercices réussis, échoués ou non tentés
- Indiquer le score pour chaque exercice en fonction d: réussite / echec / non tenté
- Tenir éventuellement compte du nombre de tentatives pour barême : 1 points / 0,5 points / 0,25 points / 0 points

`;
					break;
					
					
				
				case 'arbre_proba':
				
					prompt += `# CONFIGURATION DU SYSTÈME D'ARBRE DE PROBABILITÉS

## PARAMÈTRES PRINCIPAUX :
// =====================================================================
## ⚠️ NOTES POUR LE CONTEXTE ET LE CONTENU : Donner la priorité aux Instructions générales: "${appState.contentInstructions}"
// =====================================================================
- ⚠️⚠️ OBLIGATOIRE  - TYPE D'ARBRE: ${appState.templateSettings.arbre_proba.arbreType === 'both' ? 'Les deux types (naissances et pondéré)' : appState.templateSettings.arbre_proba.arbreType === 'birth' ? 'Uniquement naissance de deux enfants' : 'Uniquement arbre pondéré (A et B)'}
- ⚠️ PRIORITE HAUTE : LE TYPE DE QUESTIONS N A PAS DE PRIORITE SUR LE TYPE D ARBRE CHOISI

- Type de questions: ${appState.templateSettings.arbre_proba.questionsType === 'both' ? 'Les deux types d\'arbres' : appState.templateSettings.arbre_proba.questionsType === 'birth' ? 'Uniquement sur les naissances' : 'Uniquement sur les arbres pondérés'}
- Contextualisation des événements: ${appState.templateSettings.arbre_proba.contextualizeEvents ? 'Oui' : 'Non'}

// =====================================================================
## ⚠️ PRIORITÉS CRITIQUES POUR LES EXERCICES
// =====================================================================

1️⃣ NE PAS DONNER LES VALEURS DES PROBABILITÉS ET DES FRÉQUENCES CALCULÉES OU SIMULÉES
2️⃣ EXIGENCES POUR LES TYPES D'EXERCICES:
   • LES EXERCICES DE TYPE 1 DOIVENT ÊTRE DES CALCULS DE FRÉQUENCE
   • LES EXERCICES DE TYPE 2 DOIVENT ÊTRE DES PROBABILITÉS
   • INDIQUER SI LE RÉSULTAT DOIT ÊTRE EXPRIMÉ EN DÉCIMAL OU EN POURCENTAGE 
   • DEMANDER UNE PRECISION A 3 DECIMALES EN POUR UNE EXPRESSION DÉCIMALE
   • DEMANDER UNE PRECISION A & DECIMALES EN POUR UNE EXPRESSION EN POURCENTAGE `;
    
					if (appState.templateSettings.arbre_proba.contextualizeEvents) {
						prompt += `
- Description événement A: "${appState.templateSettings.arbre_proba.eventADescription}" ${appState.templateSettings.arbre_proba.eventAEmoji ? '(' + appState.templateSettings.arbre_proba.eventAEmoji + ')' : ''}
- Description événement B: "${appState.templateSettings.arbre_proba.eventBDescription}" ${appState.templateSettings.arbre_proba.eventBEmoji ? '(' + appState.templateSettings.arbre_proba.eventBEmoji + ')' : ''}`;
					}
    
					prompt += `
- Probabilité de A: ${appState.templateSettings.arbre_proba.probA}
- Probabilité de B sachant A: ${appState.templateSettings.arbre_proba.probBGivenA}
- Probabilité de B sachant non-A: ${appState.templateSettings.arbre_proba.probBGivenNotA}`;
					break;
					
					
					if (appState.templateSettings.turtle.customChallenges && appState.templateSettings.turtle.challenges) {
						prompt += `\n\n## DÉFIS PERSONNALISÉS`;
						for (let i = 1; i <= 6; i++) {
							const challenge = appState.templateSettings.turtle.challenges[`challenge${i}`];
							if (challenge) {
								prompt += `\n- Défi ${i}: ${challenge}`;
							}
						}
					} else {
						prompt += `\n\n## DÉFIS PRÉDÉFINIS
				- Défi 1: Carré de 100 pixels de côté
				- Défi 2: Rectangle de 150×80 pixels
				- Défi 3: Triangle équilatéral de 100 pixels de côté
				- Défi 4: Penatgone régulier de 60 pixels de côté
				- Défi 5: Hexagone régulier de 50 pixels de côté
				- Défi 6: Octogone régulier de 30 pixels de côté
				`;
					}
					
            }

            // Ajouter les instructions supplémentaires
            if (appState.additionalInstructions) {
                prompt += `\n\n## INSTRUCTIONS SUPPLÉMENTAIRES
${appState.additionalInstructions}`;
            }

            // Ajouter les instructions pour le code
            prompt += `\n\n#C INSTRUCTIONS POUR LE CODE

// =====================================================================
#0 ⚠️⚠️ PRIORITE OBLIGATOIRE : 	ELEMENTS COMMUNS POUR TOUTES LES APPLICATIONS
// =====================================================================

###1 Veuillez inclure dans votre réponse une application HTML complète et fonctionnelle qui implémente toutes les spécifications ci-dessus. 
###2 L'application doit être autonome (un seul fichier HTML) et inclure tout le CSS et JavaScript nécessaire.
###3 PAR DEFAUT IL FAUT TOUJOURS 6 QUESTIONS OU BLOCS DE QUESTIONS SAUF SI PRECISE DANS ##CONTENU 5précisé dans la variable ppState.exerciseCount°
###4 LE SCORE EST NOTE SUR 1 POINT PAR QUESTION
###6 LE SCORE TOTAL EST LE NOMBRE DE QUESTIONS MULTIPLIE PAR 1 POINT
###6 EN DEHORS DES ACTIVITE PYTHON CHAQUE TENTATIVE DE REPONSE EST UNIQUE : LES AUTRES QUESTIONS DEVIENNENT INACTIVES
###7 UN BOUTON FLOTTANT "TERMINER L ACTIVITE" EST EN BAS DE PAGE / ACTIVABLE UNE FOIS MEME SI TOUTES REPONSES NON DONNEES (message d'avertissement)
###8 UN NOMBRE DE TENTATIVES RESTANTES EST AFFICHE DANS CHAQUE BLOC DE QUESTION : IL EST INDEPENDANT POUR CHAQUE QUESTION

// =====================================================================
##1 ⚠️ PRIORITE HAUTE : FORMAT POUR EN TETE HEADER##
// =====================================================================

- Voici le code pour les éléments du header de toutes les applications :
- A ADAPTER SELON LE THEME CHOISI

</disabled_code>
##<head>##
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éléments Header - Application d'appariement</title>
    <style>
        /* Styles généraux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ea6687 0%, #8c4152 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        /* Styles du header */
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        
        .typescorm {
            position: fixed;
            top: 60px;
            left: 60px;
            background-color: #1976d2;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            transform: translateY(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }        
        
        .score-board {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #333;
            z-index: 100;
        }
        
        .score {
            color: #ea6687;
            font-size: 1.2em;
        }
        
        .formula-box {
            text-align: center;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            color: #444;
        }
        
        .formula {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .formula-explanation {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Media queries pour la responsivité */
        @media (max-width: 768px) {
            .score-board {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Exemple d'utilisation des éléments du header -->
    <div class="score-board">
        Score: <span class="score" id="score">0</span> / <span id="total">6</span>
    </div>
    
    <div class="container">
        <h1>🔗 Application 🎯</h1>
        
            <div class="typescorm">SCORM App</div>
            
        <div class="formula-box">
            <div class="formula">
                Appariement de termes et définitions
            </div>
            <div class="formula-explanation">
                Glissez chaque terme vers sa définition correspondante pour créer les bonnes paires.
            </div>
        </div>
        
        <!-- Contenu restant de l'application irait ici -->
    </div>

    <script>
        // Exemple minimal de script pour mettre à jour le score
        document.addEventListener('DOMContentLoaded', function() {
            // Cette fonction pourrait être utilisée pour mettre à jour le score
            function updateScore(newScore, total) {
                document.getElementById('score').textContent = newScore;
                document.getElementById('total').textContent = total;
            }
            
            // Exemple: mettre à jour le score après 2 secondes
            setTimeout(() => {
                updateScore(2, 6);
            }, 2000);
        });
</disabled_code>

Ce code contient les éléments nécessaires pour créer l'interface de l'application d'appariement, avec un tableau de score, un titre et une boîte d'explication.

Vous pouvez aussi fournir des explications sur le fonctionnement de l'application et sur la façon dont vous avez implémenté les fonctionnalités demandées.
</format_instructions>

// =====================================================================
##2 ⚠️⚠️ PRIORITE ! OBLIGATOIRE ! : FORMAT POUR BLOCS DE QUESTIONS##
// =====================================================================

###1. REPARTITION EN DEUX COLONNES DE TROIS BLOCS 
###2. CHAQUE BLOC A UN FORMAT PORTRAIT AVEC DES REPONSES SOUPERPOSEES
###3. CHAQUE REPONSE CORRECTE DE BLOCS INCREMENTE LE SCORE DE 1 POINT 
###4. LA VALIDATION D UN EXERCICE NE DOIT PAS BLOQUER LA VALIDATION DES AUTRES EXERCICES
###5. UN EXERCICE VALIDE COMME INCORRECT DOIT ËTRE CONSIDERE COMME TERMINE SAUF SI IL Y A PLUSIEURS TENTATIVES AUTORISEES
###6. LES BADGES SONT DEBLOQUES AU FUR ET A MESURE DE LA PROGRESSION SEULEMENT SI LES REPONSES SONT CORRECTES 

<!-- Début du bloc exercice autonome -->
<div id="ex_calc_container_12345" style="font-family: 'Arial', sans-serif; max-width: 600px; margin: 20px auto; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
  <style>
    #ex_calc_container_12345 .ex_calc_header {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ddd;
    }
    #ex_calc_container_12345 .ex_calc_question {
      background: #f7f7f7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      font-size: 1.1em;
      color: #333;
    }
    #ex_calc_container_12345 .ex_calc_data_table {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    #ex_calc_container_12345 .ex_calc_data_row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    #ex_calc_container_12345 .ex_calc_data_row:last-child {
      border-bottom: none;
    }
    #ex_calc_container_12345 .ex_calc_data_label {
      color: #666;
    }
    #ex_calc_container_12345 .ex_calc_data_value {
      font-weight: bold;
      color: #333;
    }
    #ex_calc_container_12345 .ex_calc_input_group {
      margin-top: 15px;
    }
    #ex_calc_container_12345 .ex_calc_input_label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: bold;
    }
    #ex_calc_container_12345 .ex_calc_input {
      width: calc(100% - 22px);
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.1em;
      transition: border-color 0.3s;
    }
    #ex_calc_container_12345 .ex_calc_input:focus {
      outline: none;
      border-color: #ea6687;
    }
    #ex_calc_container_12345 .ex_calc_btn {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #ea6687;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    #ex_calc_container_12345 .ex_calc_btn:hover {
      background: #a24b5f;
      transform: translateY(-2px);
    }
    #ex_calc_container_12345 .ex_calc_result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      display: none;
    }
    #ex_calc_container_12345 .ex_calc_result.correct {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #ex_calc_container_12345 .ex_calc_result.incorrect {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #ex_calc_container_12345 .ex_calc_hint {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9em;
      display: none;
    }
  </style>

  <div class="ex_calc_header">Exercice 1</div>
  
  <div class="ex_calc_question">
    Calculez A en utilisant la formule A = B × C × D
  </div>
  
  <div class="ex_calc_data_table">
    <div class="ex_calc_data_row">
      <span class="ex_calc_data_label">Valeur B :</span>
      <span class="ex_calc_data_value" id="ex_calc_val_b">2,5</span>
    </div>
    <div class="ex_calc_data_row">
      <span class="ex_calc_data_label">Valeur C :</span>
      <span class="ex_calc_data_value" id="ex_calc_val_c">4</span>
    </div>
    <div class="ex_calc_data_row">
      <span class="ex_calc_data_label">Valeur D :</span>
      <span class="ex_calc_data_value" id="ex_calc_val_d">20</span>
    </div>
  </div>
  
  <div class="ex_calc_input_group">
    <label class="ex_calc_input_label">Valeur A :</label>
    <input type="number" id="ex_calc_answer" class="ex_calc_input" placeholder="Entrez votre réponse">
    <button class="ex_calc_btn" id="ex_calc_check_btn">Vérifier</button>
    <div class="ex_calc_result" id="ex_calc_result"></div>
    <div class="ex_calc_hint" id="ex_calc_hint">💡 Appliquez simplement la formule A = B × C × D</div>
  </div>

  <script>
    (function() {
      // Fonction auto-exécutante pour isoler le code
      
      // Récupération des éléments
      const container = document.getElementById('ex_calc_container_12345');
      const valB = parseFloat(document.getElementById('ex_calc_val_b').textContent.replace(',', '.'));
      const valC = parseFloat(document.getElementById('ex_calc_val_c').textContent);
      const valD = parseFloat(document.getElementById('ex_calc_val_d').textContent);
      const answerInput = document.getElementById('ex_calc_answer');
      const checkBtn = document.getElementById('ex_calc_check_btn');
      const resultDiv = document.getElementById('ex_calc_result');
      const hintDiv = document.getElementById('ex_calc_hint');
      
      // Calcul de la réponse correcte
      const correctAnswer = valB * valC * valD; // 2.5 * 4 * 20 = 200
      
      // Fonction pour vérifier la réponse
      function checkAnswer() {
        const userAnswer = parseFloat(answerInput.value);
        
        if (isNaN(userAnswer)) {
          resultDiv.textContent = "⚠️ Veuillez entrer un nombre";
          resultDiv.className = "ex_calc_result incorrect";
          resultDiv.style.display = "block";
          return;
        }
        
        // Tolérance pour les nombres à virgule (1%)
        const tolerance = Math.abs(correctAnswer) * 0.01;
        const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
        
        if (isCorrect) {
          resultDiv.textContent = "✅ Correct ! Bien joué !";
          resultDiv.className = "ex_calc_result correct";
          resultDiv.style.display = "block";
          hintDiv.style.display = "none";
          
          // Désactiver l'input et le bouton
          answerInput.disabled = true;
          checkBtn.disabled = true;
        } else {
          resultDiv.textContent = "❌ Incorrect. Réessayez ou vérifiez votre calcul.";
          resultDiv.className = "ex_calc_result incorrect";
          resultDiv.style.display = "block";
          hintDiv.style.display = "block";
        }
      }
      
      // Ajout des écouteurs d'événements
      checkBtn.addEventListener('click', checkAnswer);
      
      answerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          checkAnswer();
        }
      });
    })();

<!-- Fin du bloc exercice autonome -->


// =====================================================================
##⚠️ PRIORITE HAUTE : FORMAT POUR PASTILLES "NOMBRE DE TENTATIVES"
// =====================================================================

<!-- ========== PARTIE HTML ========== -->

<!-- Structure HTML de l'en-tête avec la pastille -->
<div class="material-header">
    <div class="exercise-title">
        <span>Exercice 1</span>
        <div class="attempts-badge high" id="attempts1" title="Tentatives restantes">3</div>
    </div>
</div>

<!-- Exemple pour tous les exercices -->
<div class="attempts-badge high" id="attempts1" title="Tentatives restantes">3</div>
<div class="attempts-badge high" id="attempts2" title="Tentatives restantes">3</div>
<div class="attempts-badge high" id="attempts3" title="Tentatives restantes">3</div>
<div class="attempts-badge high" id="attempts4" title="Tentatives restantes">3</div>
<div class="attempts-badge high" id="attempts5" title="Tentatives restantes">3</div>
<div class="attempts-badge high" id="attempts6" title="Tentatives restantes">3</div>

<!-- ========== PARTIE CSS ========== -->

<style>
/* Restructuration de l'en-tête pour accommoder la pastille */
.material-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
}

.exercise-title {
    display: flex;
    align-items: center;
}

/* Styles principaux de la pastille de tentatives */
.attempts-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    color: white;
    font-weight: bold;
    font-size: 0.9em;
    margin-left: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

/* Classes de couleurs selon le nombre de tentatives */
.attempts-badge.high {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.attempts-badge.medium {
    background: linear-gradient(135deg, #fd7e14, #ffc107);
}

.attempts-badge.low {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
}

.attempts-badge.zero {
    background: linear-gradient(135deg, #6c757d, #495057);
}

/* Style pour les exercices bloqués */
.exercise-card.blocked {
    opacity: 0.7;
    background: #f5f5f5;
}

/* Style pour les résultats d'exercices bloqués */
.result.blocked {
    background: #e2e3e5;
    color: #495057;
    border: 1px solid #ced4da;
}

/* Responsive design pour mobile */
@media (max-width: 768px) {
    .material-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .exercise-title {
        width: 100%;
        justify-content: space-between;
    }
}
</style>


<!-- ========== PARTIE JAVASCRIPT ========== -->

// ========== VARIABLES GLOBALES POUR LES TENTATIVES ==========

// Configuration des tentatives
const maxAttempts = 3; // Nombre maximum de tentatives par exercice
let exerciseAttempts = Array(totalExercises).fill(0); // Tentatives utilisées par exercice

// ========== FONCTIONS DE GESTION DES TENTATIVES ==========

/**
 * Met à jour l'apparence de la pastille de tentatives
 * @param {number} exerciseNum - Numéro de l'exercice (1-6)
 */
function updateAttemptsBadge(exerciseNum) {
    const badge = document.getElementById(attemptsexerciseNum);
    const attemptsLeft = maxAttempts - exerciseAttempts[exerciseNum - 1];
    
    badge.textContent = attemptsLeft;
    
    // Mettre à jour la classe CSS selon le nombre de tentatives restantes
    badge.className = 'attempts-badge';
    if (attemptsLeft === 0) {
        badge.classList.add('zero');
        badge.title = 'Aucune tentative restante';
    } else if (attemptsLeft === 1) {
        badge.classList.add('low');
        badge.title = '1 tentative restante';
    } else if (attemptsLeft === 2) {
        badge.classList.add('medium');
        badge.title = '2 tentatives restantes';
    } else {
        badge.classList.add('high');
        badge.title = attemptsLeft tentatives restantes;
    }
}


// ========== MODIFICATION DE saveState POUR INCLURE LES TENTATIVES ==========

function saveState() {
    // Créer un objet avec toutes les données à sauvegarder
    const stateData = {
        userAnswers: userAnswers,
        score: score,
        answered: Array.from(answered),
        testCompleted: testCompleted,
        exerciseAttempts: exerciseAttempts // Sauvegarder aussi les tentatives
    };
    
    // Convertir en JSON
    suspendData = JSON.stringify(stateData);
    
    // Sauvegarder dans SCORM
    setValue("cmi.suspend_data", suspendData);
    
    // Sauvegarder le score actuel
    saveScore(score);
    
    // Sauvegarder l'état de progression
    saveProgress();
    
    // Commit immédiat pour assurer la persistance des données
    commitSCORM();
    
    console.log("État sauvegardé avec succès après modification");
}

// ========== PARAMÈTRES DE CONFIGURATION ==========

// Pour modifier le nombre de tentatives, changez cette constante :
// const maxAttempts = 5; // Exemple pour 5 tentatives


// Pour personnaliser les couleurs, modifiez ces classes CSS :
/*
.attempts-badge.high { background: linear-gradient(135deg, #28a745, #20c997); } // Vert
.attempts-badge.medium { background: linear-gradient(135deg, #fd7e14, #ffc107); } // Orange  
.attempts-badge.low { background: linear-gradient(135deg, #dc3545, #e74c3c); } // Rouge
.attempts-badge.zero { background: linear-gradient(135deg, #6c757d, #495057); } // Gris
*/

⚠️ SI NOMBRE ILLIMITE maxAttempts = Infinity AFFICHER TOUJOURS : "∞"


<!-- ========== PARTIE JAVASCRIPT ========== -->


// =====================================================================
##⚠️ PRIORITE HAUTE : FORMAT POUR BOUTON TERMINER L ACTIVITE
// =====================================================================

<!-- Bouton de fin d'activité -->
<button id="finishBtn" class="finish-btn" disabled>Terminer l'activité</button>

<!-- Modal de fin d'activité -->
<div id="completion-modal" class="modal-overlay">
    <div class="modal-content">
        <div id="modal-badge" class="modal-badge">70%</div>
        <div class="modal-header">
            <h2>Activité terminée !</h2>
            <p>Vous avez complété les exercices de titrage acido-basique.</p>
        </div>
        <div class="modal-body">
            <div class="score-result">
                <span id="modal-score">0</span>/<span id="modal-total">6</span>
            </div>
            <p class="score-text" id="modal-score-text">Vous avez réussi l'activité.</p>
            
            <div class="exercise-summary" id="exercise-summary">
                <!-- Les éléments seront générés dynamiquement -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="close-modal-btn" class="close-modal-btn">Fermer</button>
        </div>
    </div>
</div>
<!-- FIN HTML pour le modal -->


<!-- CSS pour le bouton FIN -->
.finish-btn {
    display: block;
    width: 100%;
    max-width: 300px;
    margin: 30px auto 0;
    padding: 15px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.finish-btn:hover {
    background: #218838;
    transform: translateY(-2px);
}

.finish-btn:disabled {
    background: #8fcb99;
    opacity: 0.7;
    cursor: default;
    transform: none;
}

/* Styles pour le modal de fin d'activité */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    position: relative;
    animation: slideIn 0.4s ease-out;
}

.modal-header {
    margin-bottom: 20px;
}

.modal-header h2 {
    color: var(--primary-color);
    font-size: 2em;
    margin-bottom: 10px;
}

.modal-body {
    margin-bottom: 25px;
}

.score-result {
    font-size: 3em;
    font-weight: bold;
    color: var(--primary-color);
    margin: 15px 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.score-text {
    font-size: 1.2em;
    margin-bottom: 15px;
}

.exercise-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    text-align: left;
}

.exercise-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.exercise-item:last-child {
    border-bottom: none;
}

.exercise-status {
    font-weight: bold;
}

.status-completed {
    color: #28a745;
}

.status-incomplete {
    color: #dc3545;
}

.modal-footer {
    margin-top: 20px;
}

.close-modal-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 30px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.close-modal-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.modal-badge {
    position: absolute;
    top: -15px;
    right: -15px;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--success-color);
    color: white;
    font-weight: bold;
    font-size: 1.2em;
    border-radius: 50%;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    border: 4px solid white;
}

.modal-badge.failed {
    background: var(--danger-color);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        padding: 20px;
    }
    
    .modal-header h2 {
        font-size: 1.5em;
    }
    
    .score-result {
        font-size: 2.5em;
    }
    
    .modal-badge {
        width: 60px;
        height: 60px;
        font-size: 1em;
    }
}
<!-- FIN CSS pour le bouton FIN -->

<!-- JavaScript pour le bouton FIN" -->

// Mettre à jour l'état du bouton de fin
function updateFinishButton() {
    const finishBtn = document.getElementById('finishBtn');
    if (answered.size >= 1) {
        finishBtn.disabled = false;
    } else {
        finishBtn.disabled = true;
    }
}

// Terminer l'activité
function finishActivity() {
    // Vérifier si au moins une question est répondue
    if (answered.size === 0) {
        // Afficher un message d'erreur intégré à l'interface
        const validationMessage = document.getElementById('validation-message');
        validationMessage.style.display = 'block';
        validationMessage.style.backgroundColor = '#f8d7da';
        validationMessage.style.border = '1px solid #f5c6cb';
        validationMessage.style.color = '#721c24';
        validationMessage.textContent = "Vous devez répondre à au moins une question avant de terminer l'activité.";
        
        // Masquer le message après 5 secondes
        setTimeout(() => {
            validationMessage.style.display = 'none';
        }, 5000);
        return;
    }
    
    // Marquer le test comme terminé
    testCompleted = true;
    
    // SCORM: Marquer comme terminé
    setValue("cmi.completion_status", "completed");
    setValue("cmi.success_status", (score / totalExercises >= 0.7) ? "passed" : "failed");
    setValue("cmi.exit", "normal");
    
    // SCORM: Mettre à jour le temps de session
    updateSessionTime();
    
    // SCORM: Sauvegarder l'état final
    saveState();
    
    // SCORM: Effectuer un commit final
    commitSCORM();
    
    // Désactiver tous les inputs et boutons
    document.querySelectorAll('input, .check-btn, .finish-btn, .start-titration-btn, .prepare-titration-btn, select').forEach(el => {
        el.disabled = true;
    });
    
    // Afficher le modal de fin d'activité
    showCompletionModal();
}

// Afficher le modal de fin d'activité
function showCompletionModal() {
    // Mettre à jour les données du modal
    document.getElementById('modal-score').textContent = score;
    document.getElementById('modal-total').textContent = totalExercises;
    
    // Calculer le pourcentage
    const percentage = Math.round((score / totalExercises) * 100);
    document.getElementById('modal-badge').textContent = percentage + '%';
    
    // Définir si l'étudiant a réussi ou échoué (seuil à 70%)
    const isPassed = percentage >= 70;
    if (!isPassed) {
        document.getElementById('modal-badge').classList.add('failed');
    }
    
    // Mettre à jour le texte du score
    const scoreText = document.getElementById('modal-score-text');
    if (isPassed) {
        scoreText.textContent = "Félicitations ! Vous avez réussi l'activité.";
    } else {
        scoreText.textContent = "Vous n'avez pas atteint le score minimum requis de 70%.";
    }
    
// =====================================================================
##3 ⚠️⚠️⚠️ PRIORITE ABSOLUE : BILAN DES QUESTIONS VALIDEES / NON VALIDEES / NON TENTEES ##
// =====================================================================

    // ⚠️ GENERER LE RESUME DES EXERCICES
    const summaryContainer = document.getElementById('exercise-summary');
    summaryContainer.innerHTML = '';
    
    for (let i = 0; i < totalExercises; i++) {
        const exerciseNum = i + 1;
        const isCompleted = answered.has(exerciseNum);
        
        const exerciseItem = document.createElement('div');
        exerciseItem.className = 'exercise-item';
       
        
        summaryContainer.appendChild(exerciseItem);
    }
    
    // Afficher le modal
    const modal = document.getElementById('completion-modal');
    modal.style.display = 'flex';
    
    // Ajouter l'événement de fermeture au bouton
    document.getElementById('close-modal-btn').addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    // Fermer le modal en cliquant en dehors
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}

<!-- fin JavaScript pour le bouton FIN -->


<!-- DEBUT CSS pour les blocs de questions validées/non validées -->

/* Animation pour les exercices résolus */
.exercise-card.solved {
    border-color: #28a745;
    background-color: #f0fff4;
}

/* Style pour les résultats corrects */
.result.correct {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

/* Style pour les exercices incorrects */
.exercise-card.incorrect {
    background-color: #ffebee; /* Rouge très pâle */
    border: 2px solid #ffcdd2; /* Bordure légèrement plus foncée */
    box-shadow: 0 4px 10px rgba(244, 67, 54, 0.1);
    transition: all 0.3s ease;
}

.result {
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.result.show {
    opacity: 1;
}

<!-- FIN CSS pour les blocs de questions validées/non validées -->

// =====================================================================
##4 ⚠️ PRIORITE HAUTE : FORMAT POUR BOUTON PLEIN ECRAN
// =====================================================================

<!-- HTML pour le bouton "Plein écran" -->
<div class="fullscreen-btn" id="fullscreenBtn">
    <span class="fullscreen-icon">⛶</span>
</div>

<!-- fin HTML pour le bouton "Plein écran" -->

<!-- css pour le bouton "Plein écran" -->
<style>
/* CSS pour le bouton "Plein écran" */
.fullscreen-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    z-index: 1000;
}

.fullscreen-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
}

.fullscreen-icon {
    font-size: 1.5em;
    color: #ea6687; /* Couleur bleue, ajustez selon votre design */
}

/* Style supplémentaire pour le mode plein écran */
.fullscreen-container {
    width: 100%;
    height: 100vh;
    overflow-y: auto;
    background: linear-gradient(135deg, #ea6687 0%, #8c4152 100%);
    padding: 20px;
}
</style>

<!-- FIN css pour le bouton "Plein écran" -->

<!-- javascript pour le bouton "Plein écran" -->

document.addEventListener('DOMContentLoaded', function() {
    // Initialisation du bouton plein écran
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    function toggleFullscreen() {
        if (!document.fullscreenElement && 
            !document.mozFullScreenElement && 
            !document.webkitFullscreenElement && 
            !document.msFullscreenElement) {
            // Passer en mode plein écran
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
            }
            updateFullscreenButton(true);
            document.body.classList.add('fullscreen-container');
        } else {
            // Quitter le mode plein écran
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
            updateFullscreenButton(false);
            document.body.classList.remove('fullscreen-container');
        }
    }
    
    function updateFullscreenButton(isFullscreen) {
        const iconElement = document.querySelector('.fullscreen-icon');
        if (isFullscreen) {
            iconElement.textContent = '⛝'; // Icône pour quitter le plein écran
        } else {
            iconElement.textContent = '⛶'; // Icône pour entrer en plein écran
        }
    }
    
    // Détection des changements de plein écran
    document.addEventListener('fullscreenchange', () => {
        updateFullscreenButton(!!document.fullscreenElement);
    });
    document.addEventListener('webkitfullscreenchange', () => {
        updateFullscreenButton(!!document.webkitFullscreenElement);
    });
    document.addEventListener('mozfullscreenchange', () => {
        updateFullscreenButton(!!document.mozFullScreenElement);
    });
    document.addEventListener('MSFullscreenChange', () => {
        updateFullscreenButton(!!document.msFullscreenElement);
    });

<!-- fin javascript pour le bouton "Plein écran" -->

// =====================================================================
##5 ⚠️⚠️⚠️ PRIORITE ABOLUE : COMPATIBILITÉ SCORM
// =====================================================================

L'application doit être compatible avec le standard SCORM 2004, en implémentant:
###1. Initialisation et détection automatique de l'API SCORM
###2. Suivi du temps de session
###3. Sauvegarde et restauration de l'état
###4. Enregistrement des interactions
###5. Gestion du score et de la progression
###6. Achèvement de l'activité`;

            // Ajouter le code si nécessaire
            if (appState.includeCode !== 'no') {
                prompt += `\n\n## CODE REQUIS
Voici les éléments de code qui doivent être inclus dans l'application:

<code_commun>
// Fonctions communes pour toutes les applications SCORM
// Gestion du SCORM, de l'interface utilisateur, etc.

// Variables globales SCORM
let API = null;
let API_1484_11 = null;
const scormVersion = "2004";
let initialized = false;
let terminated = false;
let lastError = "";
let suspendData = "";
let entryStatus = "ab-initio";
let sessionStartTime = Date.now();
let totalTime = 0;
let lastTimeUpdate = sessionStartTime;
let timeInterval = null;

// Variables globales de l'application
let score = 0;
let solved = new Set();
let allExercisesCompleted = false;

// Initialisation SCORM
function initSCORM() {
    if (initialized) return true;
    
    // Trouver l'API SCORM 2004
    API_1484_11 = findAPI(window);
    
    if (!API_1484_11) {
        console.error("SCORM API non trouvée");
        return false;
    }
    
    // Initialiser la communication
    let result = API_1484_11.Initialize("");
    
    if (result === "true" || result === true) {
        console.log("SCORM API initialisée avec succès");
        initialized = true;
        
        // Récupérer l'état précédent si disponible
        entryStatus = getValue("cmi.entry");
        suspendData = getValue("cmi.suspend_data");
        
        // Récupérer les données sauvegardées si elles existent
        if (suspendData) {
            try {
                restoreState(suspendData);
            } catch (e) {
                console.error("Erreur lors de la restauration des données:", e);
            }
        }
        
        return true;
    } else {
        console.error("Échec de l'initialisation SCORM");
        getLastError();
        return false;
    }
}

// Trouver l'API SCORM
function findAPI(win) {
    if (win.API_1484_11) return win.API_1484_11;
    
    let findAPITries = 0;
    while (win.parent && win.parent != win && findAPITries < 10) {
        findAPITries++;
        win = win.parent;
        if (win.API_1484_11) return win.API_1484_11;
    }
    
    let frames = win.frames;
    for (let i = 0; i < frames.length; i++) {
        let api = findAPI(frames[i]);
        if (api) return api;
    }
    
    return null;
}

// Sauvegarder l'état de l'application
function saveState() {
    if (!initialized) return;
    
    // Créer un objet avec toutes les données à sauvegarder
    const stateData = {
        score: score,
        solved: Array.from(solved),
        allExercisesCompleted: allExercisesCompleted
    };
    
    // Convertir en JSON
    suspendData = JSON.stringify(stateData);
    
    // Sauvegarder dans SCORM
    setValue("cmi.suspend_data", suspendData);
    
    // Sauvegarder le score actuel
    saveScore();
    
    // Sauvegarder l'état de progression
    saveProgress();
    
    // Commit immédiat pour assurer la persistance des données
    commitSCORM();
    
    console.log("État sauvegardé avec succès");
}
</code_commun>

<code_template>
// Code spécifique au template ${appState.selectedTemplate}
${template.code}
</code_template>`;

                if (template.jsCode) {
                    prompt += `\n\n<js_code_template>
// Code JavaScript spécifique au template ${appState.selectedTemplate}
${template.jsCode}
</js_code_template>`;
                }
            }

            return prompt;
        }

			// Fonction pour calculer les statistiques du prompt
			function calculatePromptStats(promptText) {
				// Calcul du nombre de lignes
				const lines = promptText.split('\n').length;
				
				// Calcul du nombre de mots
				const words = promptText.trim().split(/\s+/).length;
				
				// Estimation du nombre de tokens (approximation)
				// En moyenne, 1 token ≈ 4 caractères dans les modèles comme GPT
				const tokens = Math.ceil(promptText.length / 4);
				
				return {
					lines,
					words,
					tokens
				};
			}



        // Fonction pour copier le prompt
        function copyPrompt() {
            if (!appState.generatedPrompt) {
                showNotification("Veuillez d'abord générer un prompt!");
                return;
            }
            
            navigator.clipboard.writeText(appState.generatedPrompt)
                .then(() => {
                    showNotification("Prompt copié dans le presse-papiers!");
                })
                .catch(err => {
                    console.error("Erreur lors de la copie:", err);
                    showNotification("Erreur lors de la copie du prompt!");
                });
        }

        // Fonction pour télécharger le prompt
        function downloadPrompt() {
            if (!appState.generatedPrompt) {
                showNotification("Veuillez d'abord générer un prompt!");
                return;
            }
            
            // Créer un élément a temporaire
            const element = document.createElement('a');
            const file = new Blob([appState.generatedPrompt], {type: 'text/plain'});
            element.href = URL.createObjectURL(file);
            element.download = "scorm-prompt.txt";
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            
            showNotification("Prompt téléchargé!");
        }

        // Fonction pour afficher/masquer les sections techniques
        function toggleTechnicalSections() {
            appState.showCode = !appState.showCode;
            
            const toggleBtn = document.getElementById('toggle-technical-btn');
            toggleBtn.innerHTML = appState.showCode
                ? '<i class="fas fa-code"></i> Masquer code'
                : '<i class="fas fa-code"></i> Afficher code';
            
            // Régénérer le prompt
            generatePrompt();
        }

        // Fonction pour ouvrir le site d'une IA
        function openAI(url) {
            if (!appState.generatedPrompt) {
                showNotification("Veuillez d'abord générer un prompt!");
                return;
            }
            
            // Copier le prompt dans le presse-papiers
            navigator.clipboard.writeText(appState.generatedPrompt)
                .then(() => {
                    // Ouvrir l'URL dans un nouvel onglet
                    window.open(url, '_blank');
                    showNotification("Prompt copié dans le presse-papiers! Ouverture de " + url);
                })
                .catch(err => {
                    console.error("Erreur lors de la copie:", err);
                    showNotification("Erreur lors de la copie du prompt!");
                });
        }

		// Fonction pour afficher une notification
		function showNotification(message) {
			const notification = document.getElementById('notification');
			notification.textContent = message;
			notification.classList.add('show');
			
			setTimeout(() => {
				notification.classList.remove('show');
			}, 3000);
		}
		
		// [Autres fonctions utilitaires déjà présentes...]
		
		// Ajouter la fonction updateArbreProbaPreview ICI - juste avant l'initialisation de l'application
		function updateArbreProbaPreview() {
			const arbreType = document.getElementById('arbre-proba-type')?.value || 'both';
			const contextualizeEvents = document.getElementById('arbre-proba-contextualize')?.checked || false;
			const eventADesc = document.getElementById('event-a-description')?.value || 'Il pleut';
			const eventBDesc = document.getElementById('event-b-description')?.value || 'J ai un parapluie';
			const eventAEmoji = document.getElementById('event-a-emoji')?.value || '🌧️';
			const eventBEmoji = document.getElementById('event-b-emoji')?.value || '☂️';
			
			// Mettre à jour le titre de l'aperçu
			const previewTitle = document.getElementById('arbre-preview-title');
			if (previewTitle) {
				if (arbreType === 'birth') {
					previewTitle.textContent = 'Arbre de naissance de deux enfants';
				} else if (arbreType === 'weighted') {
					previewTitle.textContent = 'Arbre pondéré (A et B)';
				} else {
					previewTitle.textContent = 'Arbres de probabilité';
				}
			}
			
			// Mettre à jour les étiquettes des nœuds dans l'aperçu
			const nodeLabels = document.querySelectorAll('.arbre-node-label');
			if (nodeLabels.length > 0 && contextualizeEvents) {
				nodeLabels.forEach(label => {
					const currentText = label.textContent;
					if (currentText === 'A') {
						label.textContent = eventAEmoji || eventADesc.substring(0, 1).toUpperCase();
					} else if (currentText === 'Ā') {
						label.textContent = eventAEmoji ? '❌' : 'non-' + eventADesc.substring(0, 1).toUpperCase();
					} else if (currentText === 'B') {
						label.textContent = eventBEmoji || eventBDesc.substring(0, 1).toUpperCase();
					} else if (currentText === 'B̄') {
						label.textContent = eventBEmoji ? '❌' : 'non-' + eventBDesc.substring(0, 1).toUpperCase();
					}
				});
			} else if (nodeLabels.length > 0 && !contextualizeEvents) {
				// Remettre les valeurs par défaut
				nodeLabels.forEach(label => {
					const currentText = label.textContent;
					if (currentText !== 'A' && currentText !== 'Ā' && currentText !== 'B' && currentText !== 'B̄') {
						if (currentText.includes('non-') || currentText === '❌') {
							if (currentText.includes(eventADesc.substring(0, 1).toUpperCase())) {
								label.textContent = 'Ā';
							} else {
								label.textContent = 'B̄';
							}
						} else {
							if (currentText === eventAEmoji || currentText === eventADesc.substring(0, 1).toUpperCase()) {
								label.textContent = 'A';
							} else {
								label.textContent = 'B';
							}
						}
					}
				});
			}
		}


        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabNumber = this.getAttribute('data-tab');
                    changeTab(parseInt(tabNumber));
                });
            });
            
            // Initialiser les catégories des templates
			initializeTemplateCategories();            
            
            
            // Initialiser les boutons de navigation
            document.getElementById('next-tab-1').addEventListener('click', () => changeTab(2));
            document.getElementById('next-tab-2').addEventListener('click', () => changeTab(3));
            document.getElementById('next-tab-3').addEventListener('click', () => changeTab(4));
            document.getElementById('next-tab-4').addEventListener('click', () => changeTab(5));
            document.getElementById('prev-tab-2').addEventListener('click', () => changeTab(1));
            document.getElementById('prev-tab-3').addEventListener('click', () => changeTab(2));
            document.getElementById('prev-tab-4').addEventListener('click', () => changeTab(3));
            document.getElementById('prev-tab-5').addEventListener('click', () => changeTab(4));
            
            
			// REPERE POUR LES CATEGORIES

			// Initialiser les catégories des templates
			const templateCategories = {
				'qcm': 'general',
				'sequence': 'general',
				'category': 'general',
				'match': 'general',
				'statistics' : 'math',
				'stats' : 'math',
				'derivees' : 'math',
				'graphique' : 'math',
				'tableaux' : 'math',
				'calcul': 'math',
				'arithmetique': 'math',
				'geometrique': 'math',
				'probability': 'math',
				'proba': 'math',
				'arbre_proba': 'math',
				'geometry3d' : 'math',
				'python': 'programming',
				'turtle': 'programming',
				'3d': 'science',
				'chimie-orga': 'science',
				'titrage': 'science',
				'periodic' : 'science',
				'equation' : 'science',
				
			};
			
			// Appliquer les catégories aux cartes de templates
			document.querySelectorAll('.template-card').forEach(card => {
				const templateId = card.getAttribute('data-template');
				if (templateId && templateCategories[templateId]) {
					// Ajouter l'attribut de catégorie
					card.setAttribute('data-category', templateCategories[templateId]);
					
					// Appliquer directement la couleur à l'en-tête
					const headerElement = card.querySelector('.card-header');
					if (headerElement) {
						const colors = {
							'general': '#b85570',
							'math': '#db8686',
							'science': '#c9a73e',
							'programming': '#8465a3'
						};
						headerElement.style.backgroundColor = colors[templateCategories[templateId]];
					}
					
					// Mettre à jour la couleur de l'icône pour correspondre
					const iconElement = card.querySelector('.card-icon');
					if (iconElement) {
						const colors = {
							'general': '#b85570',
							'math': '#db8686',
							'science': '#c9a73e',
							'programming': '#8465a3'
						};
						iconElement.style.color = colors[templateCategories[templateId]];
					}
				}
			});

            
            // Initialiser les templates
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    const templateId = this.getAttribute('data-template');
                    selectTemplate(templateId);
                });
            });
            
            // Initialiser le modal
            document.getElementById('close-template-modal').addEventListener('click', closeTemplateModal);
            document.getElementById('close-modal-btn').addEventListener('click', closeTemplateModal);
            
            // Fermer le modal en cliquant en dehors
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('template-details-modal')) {
                    closeTemplateModal();
                }
            });
            
            // Initialiser les onglets du modal
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-content');
                    
                    document.querySelectorAll('.content-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    document.querySelectorAll('.content-body').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    document.getElementById(`modal-${contentId}`).classList.add('active');
                });
            });
            
            // Initialiser le bouton de sélection de template
            document.getElementById('select-template-btn').addEventListener('click', function() {
                const templateId = this.getAttribute('data-template');
                selectTemplate(templateId);
            });
            
            // Initialiser le bouton de génération de prompt
            document.getElementById('generate-prompt-btn').addEventListener('click', generatePrompt);
            
            // Initialiser le bouton de copie de prompt
            document.getElementById('copy-prompt-btn').addEventListener('click', copyPrompt);
            
            // Initialiser le bouton de téléchargement de prompt
            document.getElementById('download-prompt-btn').addEventListener('click', downloadPrompt);
            
            // Initialiser le bouton de toggle des sections techniques
            document.getElementById('toggle-technical-btn').addEventListener('click', toggleTechnicalSections);
            
            // Initialiser les boutons d'ouverture d'IA
            document.getElementById('open-claude-btn').addEventListener('click', () => openAI('https://claude.ai'));
            document.getElementById('open-chatgpt-btn').addEventListener('click', () => openAI('https://chat.openai.com'));
            
            // Initialiser le champ de sujet personnalisé
            document.getElementById('subject-select').addEventListener('change', function() {
                const customContainer = document.getElementById('custom-subject-container');
                if (this.value === 'custom') {
                    customContainer.style.display = 'block';
                } else {
                    customContainer.style.display = 'none';
                }
            });
            
            // Initialiser le champ de nombre d'exercices personnalisé
            document.getElementById('exercise-count').addEventListener('change', function() {
                const customContainer = document.getElementById('custom-count-container');
                if (this.value === 'custom') {
                    customContainer.style.display = 'block';
                } else {
                    customContainer.style.display = 'none';
                }
            });
            
            // Initialiser le switch des badges
            document.getElementById('enable-badges').addEventListener('change', function() {
                const badgesSettings = document.getElementById('badges-settings');
                if (this.checked) {
                    badgesSettings.style.display = 'block';
                } else {
                    badgesSettings.style.display = 'none';
                }
                
                appState.enableBadges = this.checked;
            });
            
            // Initialiser le switch de couleur personnalisée
			document.getElementById('use-custom-color').addEventListener('change', function() {
				const statusIndicator = document.getElementById('custom-color-status');
				
				if (this.checked) {
					statusIndicator.textContent = "Activé";
					statusIndicator.classList.add('status-active');
					statusIndicator.classList.remove('status-inactive');
				} else {
					statusIndicator.textContent = "Non activé";
					statusIndicator.classList.add('status-inactive');
					statusIndicator.classList.remove('status-active');
				}
				
				// Mettre à jour l'état de l'application
				appState.useCustomColor = this.checked;
			});

            
			// C'est ICI que vous devez ajouter votre nouveau code JavaScript
			document.getElementById('custom-primary-color').addEventListener('input', function() {
				// Mettre à jour l'aperçu de la couleur
				const colorPreview = document.getElementById('color-preview');
				const colorValue = document.getElementById('color-value');
				
				colorPreview.style.backgroundColor = this.value;
				colorValue.textContent = this.value;
				
				// Mettre à jour l'état de l'application
				appState.customPrimaryColor = this.value;
			});
		
			document.getElementById('use-custom-color').addEventListener('change', function() {
				const statusIndicator = document.getElementById('custom-color-status');
				
				if (this.checked) {
					statusIndicator.textContent = "Activé";
					statusIndicator.classList.add('status-active');
					statusIndicator.classList.remove('status-inactive');
				} else {
					statusIndicator.textContent = "Non activé";
					statusIndicator.classList.add('status-inactive');
					statusIndicator.classList.remove('status-active');
				}
				
				// Mettre à jour l'état de l'application
				appState.useCustomColor = this.checked;
			});
			
			// Initialisation de l'état
			const colorInput = document.getElementById('custom-primary-color');
			const colorPreview = document.getElementById('color-preview');
			const colorValue = document.getElementById('color-value');
			const useCustomColor = document.getElementById('use-custom-color');
			const statusIndicator = document.getElementById('custom-color-status');
			
			// Définir les valeurs initiales
			colorPreview.style.backgroundColor = colorInput.value;
			colorValue.textContent = colorInput.value;
			
			if (appState.useCustomColor) {
				useCustomColor.checked = true;
				statusIndicator.textContent = "Activé";
				statusIndicator.classList.add('status-active');
			} else {
				useCustomColor.checked = false;
				statusIndicator.textContent = "Non activé";
				statusIndicator.classList.add('status-inactive');
			}
                
            
            
            // Initialiser les boutons de réinitialisation
            document.getElementById('reset-button-1').addEventListener('click', function() {
                if (confirm("Êtes-vous sûr de vouloir réinitialiser les paramètres de cette section ?")) {
                    // Réinitialiser les champs
                    document.getElementById('app-title').value = "Activité SCORM Interactive";
                    document.getElementById('app-description').value = "Une application interactive pour l'apprentissage et l'évaluation des connaissances.";
                    document.getElementById('app-author').value = "Formateur SCORM";
                    document.getElementById('subject-select').value = "general";
                    document.getElementById('custom-subject-container').style.display = 'none';
                    document.getElementById('difficulty-select').value = "intermediate";
                    document.getElementById('audience-select').value = "professional";
                    
                    // Mettre à jour l'état
                    appState.title = "Activité SCORM Interactive";
                    appState.description = "Une application interactive pour l'apprentissage et l'évaluation des connaissances.";
                    appState.author = "Formateur SCORM";
                    appState.subject = "general";
                    appState.difficulty = "intermediate";
                    appState.audience = "professional";
                    
                    showNotification("Paramètres réinitialisés!");
                }
            });
            
            // Initialiser les écouteurs pour les mises à jour d'état
            document.getElementById('app-title').addEventListener('input', function() {
                appState.title = this.value;
            });
            
            document.getElementById('app-description').addEventListener('input', function() {
                appState.description = this.value;
            });
            
            document.getElementById('app-author').addEventListener('input', function() {
                appState.author = this.value;
            });
            
            document.getElementById('subject-select').addEventListener('change', function() {
                appState.subject = this.value;
            });
            
            document.getElementById('custom-subject').addEventListener('input', function() {
                appState.customSubject = this.value;
            });
            
            document.getElementById('difficulty-select').addEventListener('change', function() {
                appState.difficulty = this.value;
            });
            
            document.getElementById('audience-select').addEventListener('change', function() {
                appState.audience = this.value;
            });
            
            document.getElementById('exercise-count').addEventListener('change', function() {
                if (this.value !== 'custom') {
                    appState.exerciseCount = parseInt(this.value);
                }
            });
            
            document.getElementById('custom-exercise-count').addEventListener('input', function() {
                appState.exerciseCount = parseInt(this.value) || 6;
            });
            
            document.getElementById('content-theme').addEventListener('input', function() {
                appState.contentTheme = this.value;
            });
            
            document.getElementById('content-instructions').addEventListener('input', function() {
                appState.contentInstructions = this.value;
            });
            
            document.getElementById('badge-threshold').addEventListener('change', function() {
                appState.badgeThreshold = this.value;
            });
            
            document.getElementById('badge-count').addEventListener('change', function() {
                appState.badgeCount = parseInt(this.value);
            });
            
			document.getElementById('color-theme').addEventListener('change', function() {
				const selectedTheme = this.value;
				const defaultColor = themeColors[selectedTheme] || '#ea6687';
				
				// Mettre à jour l'état de l'application
				appState.colorTheme = selectedTheme;
				
				// Mettre à jour la couleur personnalisée avec la couleur du thème
				const colorInput = document.getElementById('custom-primary-color');
				const colorPreview = document.getElementById('color-preview');
				const colorValue = document.getElementById('color-value');
				
				// Définir la nouvelle couleur
				colorInput.value = defaultColor;
				colorPreview.style.backgroundColor = defaultColor;
				colorValue.textContent = defaultColor;
				
				// Mettre également à jour l'état de l'application
				appState.customPrimaryColor = defaultColor;
			});                
            
			document.getElementById('custom-primary-color').addEventListener('input', function() {
				// Mettre à jour l'aperçu de la couleur
				const colorPreview = document.getElementById('color-preview');
				const colorValue = document.getElementById('color-value');
				
				colorPreview.style.backgroundColor = this.value;
				colorValue.textContent = this.value;
				
				// Mettre à jour l'état de l'application
				appState.customPrimaryColor = this.value;
			});

            
            document.getElementById('ui-style').addEventListener('change', function() {
                appState.uiStyle = this.value;
            });
            
            document.getElementById('font-family').addEventListener('change', function() {
                appState.fontFamily = this.value;
            });
            
            document.getElementById('custom-css').addEventListener('input', function() {
                appState.customCSS = this.value;
            });
            
            document.getElementById('prompt-format').addEventListener('change', function() {
                appState.promptFormat = this.value;
            });
            
            document.getElementById('ai-target').addEventListener('change', function() {
                appState.aiTarget = this.value;
            });
            
            document.getElementById('include-code').addEventListener('change', function() {
                appState.includeCode = this.value;
            });
            
            document.getElementById('additional-instructions').addEventListener('input', function() {
                appState.additionalInstructions = this.value;
            });
            
            // Initialiser les cases à cocher pour les fonctionnalités
            document.querySelectorAll('[id^="feature-"]').forEach(checkbox => {
                const feature = checkbox.id.replace('feature-', '');
                checkbox.addEventListener('change', function() {
                    appState.features[feature] = this.checked;
                });
                
			// Initialisation de l'état du sélecteur de couleur
			const colorInput = document.getElementById('custom-primary-color');
			const colorPreview = document.getElementById('color-preview');
			const colorValue = document.getElementById('color-value');
			const useCustomColor = document.getElementById('use-custom-color');
			const statusIndicator = document.getElementById('custom-color-status');
			
			// Définir les valeurs initiales
			if (colorPreview && colorValue) {
				colorPreview.style.backgroundColor = colorInput.value;
				colorValue.textContent = colorInput.value;
			}
			
			if (useCustomColor && statusIndicator) {
				if (appState.useCustomColor) {
					useCustomColor.checked = true;
					statusIndicator.textContent = "Activé";
					statusIndicator.classList.add('status-active');
				} else {
					useCustomColor.checked = false;
					statusIndicator.textContent = "Non activé";
					statusIndicator.classList.add('status-inactive');
				}
			}                
                
                // Initialiser avec les valeurs de l'état
                checkbox.checked = appState.features[feature] || false;
            });
            
			// Gestion des interactions pour le template Turtle
			document.addEventListener('DOMContentLoaded', function() {
				// Vérifier si nous sommes sur la page du générateur SCORM
				if (document.querySelector('.template-card[data-template="turtle"]')) {
					// Charger dynamiquement les scripts Skulpt et CodeMirror si nécessaire
					if (typeof Sk === 'undefined') {
						const scriptElements = [
							{ src: 'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js' },
							{ src: 'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js' },
							{ src: 'https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js' },
							{ src: 'https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/python/python.min.js' }
						];
						
						scriptElements.forEach(script => {
							const scriptElement = document.createElement('script');
							scriptElement.src = script.src;
							document.head.appendChild(scriptElement);
						});
						
						const codemirrorCSS = document.createElement('link');
						codemirrorCSS.rel = 'stylesheet';
						codemirrorCSS.href = 'https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.css';
						document.head.appendChild(codemirrorCSS);
					}
				}
			});
            
        });
    </script>
</body>
</html>